(function(_0x48c893,_0x417f74){const _0x4d03f9=_0x8189,_0x342906=_0x48c893();while(!![]){try{const _0x56bad8=parseInt(_0x4d03f9(0x179))/0x1+parseInt(_0x4d03f9(0x177))/0x2*(parseInt(_0x4d03f9(0x17d))/0x3)+-parseInt(_0x4d03f9(0x164))/0x4+-parseInt(_0x4d03f9(0x181))/0x5+parseInt(_0x4d03f9(0x16a))/0x6+parseInt(_0x4d03f9(0x1bc))/0x7+parseInt(_0x4d03f9(0x1cf))/0x8*(-parseInt(_0x4d03f9(0x1af))/0x9);if(_0x56bad8===_0x417f74)break;else _0x342906['push'](_0x342906['shift']());}catch(_0x2aa756){_0x342906['push'](_0x342906['shift']());}}}(_0x222a,0x8a052));function _0x8189(_0xd71df2,_0x33b93c){const _0x222ae4=_0x222a();return _0x8189=function(_0x8189ad,_0x4450b9){_0x8189ad=_0x8189ad-0x164;let _0x28d993=_0x222ae4[_0x8189ad];return _0x28d993;},_0x8189(_0xd71df2,_0x33b93c);}import{extension_settings}from'/scripts/extensions.js';import{characters,this_chid}from'/script.js';import{extensionName,defaultSettings}from'../utils/settings.js';import{pluginAuthStatus}from'../utils/auth.js';let availableModels=[],latestUpdateInfo=null,newVersionAvailable=![];function _0x222a(){const _0x192bca=['#amily2_opt_rate_main','text','3666630mSkVBD','model','#amily2_api_provider','worldbookEnabled','<span\x20style=\x22color:\x20#ff9800;\x22>请检查API配置后点击\x22刷新模型\x22</span>','.plugin-features','length','selected','#amily2_summarization_enabled','已选择:\x20<strong>','character','hide','#amily2_optimization_exclusion_enabled','autoHideThreshold','#amily2_update_indicator','loreDepth','#amily2_mhb_small_auto_enabled','mainPrompt','#amily2_lore_depth_container','#amily2_worldbook_enabled','#amily2_model','input[name=\x22amily2_opt_worldbook_source\x22][value=\x22','#amily2_preset_selector','plotOpt_enabled','plotOpt_rateMain','plotOpt_finalSystemDirective','#amily2_opt_main_prompt','val','#amily2_main_prompt','#amily2_lore_depth_input','historiographySmallAutoEnable','at_depth','iconLocation','<option\x20value=\x22\x22>无可用模型，请刷新</option>','outputFormatPrompt','input[name=\x22amily2_icon_location\x22][value=\x22','optimizationTargetTag','contextMessages','forEach','#amily2_max_tokens_value','#amily2_suppress_toast','checked','apiUrl','suppressToast','apiProvider','#amily2_api_url','306ZguisE','loreActivationMode','#amily2_model_notes','optimizationEnabled','historiographySmallTriggerThreshold','temperature','#amily2_optimization_enabled','plotOpt_rateErotic','#auth_panel','show','--\x20选择模型\x20--','enabled','#amily2_temperature','2359161HqiLUO','optimizationMode','input[name=\x22amily2_optimization_mode\x22][value=\x22','extensions','</strong>','maxTokens','\x20个可用模型','#amily2_opt_worldbook_enabled','#amily2_opt_enabled','#amily2_update_button_new','input[name=\x22amily2_lorebook_target\x22][value=\x22','plotOpt_systemPrompt','#amily2_context_messages_value','#amily2_context_messages','log','#amily2_max_tokens','#amily2_opt_rate_erotic','loreInsertionPosition','#amily2_auto_hide_threshold','1800mKehgV','2923276KenaAP','#amily2_opt_rate_personal','append','prop','optimizationExclusionEnabled','<option></option>','3322146vAQuUw','html','systemPrompt','已加载\x20','#amily2_system_prompt','#amily2_lore_activation_mode','#amily2_temperature_value','plotOpt_worldbook_enabled','#amily2_opt_rate_cuckold','#amily2_api_key','plotOpt_mainPrompt','plotOpt_rateCuckold','authorized','26fSqlqN','undefined','841496PLGIxj','#amily2_enabled','#amily2_optimization_target_tag','_value','70365VCknvh','#amily2_output_format_prompt'];_0x222a=function(){return _0x192bca;};return _0x222a();}export function setUpdateInfo(_0x41c779,_0x19f04b){newVersionAvailable=_0x41c779,latestUpdateInfo=_0x19f04b;}export function applyUpdateIndicator(){const _0xe3adbd=_0x8189;newVersionAvailable?($(_0xe3adbd(0x18f))[_0xe3adbd(0x1b8)](),$(_0xe3adbd(0x1c5))[_0xe3adbd(0x1b8)]()):($(_0xe3adbd(0x18f))[_0xe3adbd(0x18c)](),$('#amily2_update_button_new')[_0xe3adbd(0x18c)]());}export function getLatestUpdateInfo(){return latestUpdateInfo;}export function setAvailableModels(_0x4053a4){availableModels=_0x4053a4;}export function populateModelDropdown(){const _0x8d4efc=_0x8189,_0x2eda96=$(_0x8d4efc(0x195)),_0x5c9ce5=$(_0x8d4efc(0x1b1));_0x2eda96['empty']();const _0x42d44c=extension_settings[extensionName]?.[_0x8d4efc(0x182)]||'';if(availableModels['length']===0x0){_0x2eda96[_0x8d4efc(0x166)](_0x8d4efc(0x1a2)),_0x5c9ce5[_0x8d4efc(0x16b)](_0x8d4efc(0x185));return;}const _0x23d12d=$('<option></option>')['val']('')[_0x8d4efc(0x180)](_0x8d4efc(0x1b9));_0x2eda96[_0x8d4efc(0x166)](_0x23d12d),availableModels[_0x8d4efc(0x1a7)](_0x3025f7=>{const _0x4a534=_0x8d4efc,_0x50084e=$(_0x4a534(0x169))[_0x4a534(0x19c)](_0x3025f7)[_0x4a534(0x180)](_0x3025f7);_0x3025f7===_0x42d44c&&_0x50084e['attr'](_0x4a534(0x188),_0x4a534(0x188)),_0x2eda96[_0x4a534(0x166)](_0x50084e);}),_0x42d44c&&_0x2eda96[_0x8d4efc(0x19c)]()===_0x42d44c?_0x5c9ce5['html'](_0x8d4efc(0x18a)+_0x42d44c+_0x8d4efc(0x1c0)):_0x5c9ce5[_0x8d4efc(0x16b)](_0x8d4efc(0x16d)+availableModels[_0x8d4efc(0x187)]+_0x8d4efc(0x1c2));}export function updateUI(){const _0x1174a0=_0x8189;if(!pluginAuthStatus[_0x1174a0(0x176)])$(_0x1174a0(0x1b7))[_0x1174a0(0x1b8)](),$(_0x1174a0(0x186))[_0x1174a0(0x18c)]();else{$(_0x1174a0(0x1b7))[_0x1174a0(0x18c)](),$(_0x1174a0(0x186))[_0x1174a0(0x1b8)]();const _0x5484d2=extension_settings[extensionName];if(!_0x5484d2)return;$(_0x1174a0(0x17a))[_0x1174a0(0x167)](_0x1174a0(0x1aa),_0x5484d2[_0x1174a0(0x1ba)]),$(_0x1174a0(0x183))[_0x1174a0(0x19c)](_0x5484d2[_0x1174a0(0x1ad)]||'openai'),$(_0x1174a0(0x1ae))['val'](_0x5484d2[_0x1174a0(0x1ab)]),$(_0x1174a0(0x173))[_0x1174a0(0x19c)](_0x5484d2['apiKey']),$('#amily2_model')[_0x1174a0(0x19c)](_0x5484d2['model']),$(_0x1174a0(0x197))[_0x1174a0(0x19c)](_0x5484d2['tavernProfile']),$(_0x1174a0(0x183))['trigger']('change'),$(_0x1174a0(0x1cb))[_0x1174a0(0x19c)](_0x5484d2[_0x1174a0(0x1c1)]),$(_0x1174a0(0x1a8))[_0x1174a0(0x180)](_0x5484d2[_0x1174a0(0x1c1)]),$(_0x1174a0(0x1bb))[_0x1174a0(0x19c)](_0x5484d2[_0x1174a0(0x1b4)]),$(_0x1174a0(0x170))['text'](_0x5484d2[_0x1174a0(0x1b4)]),$(_0x1174a0(0x1c9))[_0x1174a0(0x19c)](_0x5484d2[_0x1174a0(0x1a6)]),$(_0x1174a0(0x1c8))[_0x1174a0(0x180)](_0x5484d2['contextMessages']),$(_0x1174a0(0x17b))['val'](_0x5484d2[_0x1174a0(0x1a5)]),$(_0x1174a0(0x1be)+_0x5484d2[_0x1174a0(0x1bd)]+'\x22]')[_0x1174a0(0x167)](_0x1174a0(0x1aa),!![]),$(_0x1174a0(0x1b5))[_0x1174a0(0x167)](_0x1174a0(0x1aa),_0x5484d2[_0x1174a0(0x1b2)]),$(_0x1174a0(0x18d))['prop'](_0x1174a0(0x1aa),_0x5484d2[_0x1174a0(0x168)]),$('#amily2_show_optimization_toast')[_0x1174a0(0x167)](_0x1174a0(0x1aa),_0x5484d2['showOptimizationToast']),$(_0x1174a0(0x1a9))[_0x1174a0(0x167)](_0x1174a0(0x1aa),_0x5484d2[_0x1174a0(0x1ac)]),$(_0x1174a0(0x16e))[_0x1174a0(0x19c)](_0x5484d2[_0x1174a0(0x16c)]),$(_0x1174a0(0x19d))[_0x1174a0(0x19c)](_0x5484d2[_0x1174a0(0x192)]),$(_0x1174a0(0x17e))[_0x1174a0(0x19c)](_0x5484d2[_0x1174a0(0x1a3)]),$('#amily2_summarization_prompt')[_0x1174a0(0x19c)](_0x5484d2['summarizationPrompt']),$(_0x1174a0(0x194))['prop'](_0x1174a0(0x1aa),_0x5484d2[_0x1174a0(0x184)]),$(_0x1174a0(0x189))[_0x1174a0(0x167)]('checked',_0x5484d2['summarizationEnabled']),$(_0x1174a0(0x1c6)+_0x5484d2['lorebookTarget']+'\x22]')[_0x1174a0(0x167)]('checked',!![]),$(_0x1174a0(0x1a4)+_0x5484d2[_0x1174a0(0x1a1)]+'\x22]')[_0x1174a0(0x167)](_0x1174a0(0x1aa),!![]),$('#amily2_auto_hide_enabled')[_0x1174a0(0x167)](_0x1174a0(0x1aa),_0x5484d2['autoHideEnabled']),$(_0x1174a0(0x1ce))[_0x1174a0(0x19c)](_0x5484d2[_0x1174a0(0x18e)]),$('#amily2_auto_hide_threshold_value')['text'](_0x5484d2[_0x1174a0(0x18e)]),$(_0x1174a0(0x16f))[_0x1174a0(0x19c)](_0x5484d2[_0x1174a0(0x1b0)]),$('#amily2_lore_insertion_position')[_0x1174a0(0x19c)](_0x5484d2['loreInsertionPosition']),$(_0x1174a0(0x19e))[_0x1174a0(0x19c)](_0x5484d2[_0x1174a0(0x190)]),_0x5484d2[_0x1174a0(0x1cd)]===_0x1174a0(0x1a0)?$(_0x1174a0(0x193))[_0x1174a0(0x1b8)]():$(_0x1174a0(0x193))['hide'](),_0x5484d2[_0x1174a0(0x19f)]!==undefined&&$(_0x1174a0(0x191))[_0x1174a0(0x167)](_0x1174a0(0x1aa),_0x5484d2[_0x1174a0(0x19f)]),_0x5484d2[_0x1174a0(0x1b3)]!==undefined&&$('#amily2_mhb_small_trigger_count')[_0x1174a0(0x19c)](_0x5484d2['historiographySmallTriggerThreshold']),populateModelDropdown(),updatePlotOptimizationUI();}}function getMergedPlotOptSettings(){const _0x1d3a77=_0x8189,_0x32b68c=characters&&typeof this_chid!==_0x1d3a77(0x178)&&characters[this_chid]?characters[this_chid]:null,_0x2f4374=extension_settings[extensionName]||defaultSettings,_0x2d0035=_0x32b68c?.['data']?.[_0x1d3a77(0x1bf)]?.[extensionName]||{};return{..._0x2f4374,..._0x2d0035};}export function updatePlotOptimizationUI(){const _0x47083d=_0x8189,_0x3b2327=getMergedPlotOptSettings();if(!_0x3b2327)return;$(_0x47083d(0x1c4))[_0x47083d(0x167)](_0x47083d(0x1aa),_0x3b2327[_0x47083d(0x198)]),$(_0x47083d(0x1c3))['prop']('checked',_0x3b2327[_0x47083d(0x171)]),$(_0x47083d(0x19b))[_0x47083d(0x19c)](_0x3b2327[_0x47083d(0x174)]),$('#amily2_opt_system_prompt')['val'](_0x3b2327[_0x47083d(0x1c7)]),$('#amily2_opt_final_system_directive')[_0x47083d(0x19c)](_0x3b2327[_0x47083d(0x19a)]),$(_0x47083d(0x17f))['val'](_0x3b2327[_0x47083d(0x199)]),$(_0x47083d(0x165))[_0x47083d(0x19c)](_0x3b2327['plotOpt_ratePersonal']),$(_0x47083d(0x1cc))[_0x47083d(0x19c)](_0x3b2327[_0x47083d(0x1b6)]),$(_0x47083d(0x172))[_0x47083d(0x19c)](_0x3b2327[_0x47083d(0x175)]);const _0x358646={'#amily2_opt_context_limit':'plotOpt_contextLimit','#amily2_opt_worldbook_char_limit':'plotOpt_worldbookCharLimit'};for(const _0x14c651 in _0x358646){const _0x287ac2=_0x358646[_0x14c651],_0x2b236a=_0x3b2327[_0x287ac2],_0x487f36=_0x14c651+_0x47083d(0x17c);_0x2b236a!==undefined&&($(_0x14c651)[_0x47083d(0x19c)](_0x2b236a),$(_0x487f36)['text'](_0x2b236a));}const _0x55ebaf=_0x3b2327['plotOpt_worldbookSource']||_0x47083d(0x18b);$(_0x47083d(0x196)+_0x55ebaf+'\x22]')['prop'](_0x47083d(0x1aa),!![]),console[_0x47083d(0x1ca)]('['+extensionName+']\x20(state.js)\x20剧情优化UI已根据合并设置更新。');}
