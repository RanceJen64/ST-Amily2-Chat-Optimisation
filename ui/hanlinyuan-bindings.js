const _0x496fcc=_0x1895;(function(_0x465df7,_0x18a905){const _0x1c0cfd=_0x1895,_0x16ae4c=_0x465df7();while(!![]){try{const _0x1f5021=parseInt(_0x1c0cfd(0x1c8))/0x1*(parseInt(_0x1c0cfd(0x1f1))/0x2)+parseInt(_0x1c0cfd(0xc9))/0x3*(-parseInt(_0x1c0cfd(0x103))/0x4)+parseInt(_0x1c0cfd(0x11a))/0x5+parseInt(_0x1c0cfd(0x184))/0x6*(parseInt(_0x1c0cfd(0x1f7))/0x7)+-parseInt(_0x1c0cfd(0x1c5))/0x8*(parseInt(_0x1c0cfd(0x1cc))/0x9)+parseInt(_0x1c0cfd(0x16b))/0xa+-parseInt(_0x1c0cfd(0x18c))/0xb;if(_0x1f5021===_0x18a905)break;else _0x16ae4c['push'](_0x16ae4c['shift']());}catch(_0x20bde0){_0x16ae4c['push'](_0x16ae4c['shift']());}}}(_0x4acc,0x5955e));import{getContext}from'/scripts/extensions.js';import*as _0x1c6807 from'../core/rag-processor.js';import*as _0xed18ca from'../core/historiographer.js';import*as _0x2f10ec from'../core/utils/context-utils.js';import*as _0x3be14c from'../core/ingestion-manager.js';import{showContentModal,showHtmlModal}from'./page-window.js';import{extractBlocksByTags,applyExclusionRules}from'../core/utils/rag-tag-extractor.js';_0x496fcc(0x1a8);function setupGlobalEventHandlers(){const _0x523a1f=_0x496fcc;window[_0x523a1f(0x70)]=()=>saveSettingsFromUI(![]),window['resetHLYSettings']=resetSettingsToUI,window[_0x523a1f(0x1e4)]=testApi,window['fetchHLYEmbeddingModels']=fetchHLYEmbeddingModels,window[_0x523a1f(0x1ea)]=fetchHLYRerankModels,window[_0x523a1f(0xea)]=updatePanelStatus,window[_0x523a1f(0x7e)]=purgeStorage,window['startHLYCondensation']=startCondensation,window['previewHLYCondensation']=previewCondensation,window['ingestHLYManualText']=ingestManualText,window[_0x523a1f(0x167)]=log,window[_0x523a1f(0xe6)]=showStats,window[_0x523a1f(0x173)]=startHistoriography;}function updateAndSaveSetting(_0x3fe0e0,_0x5c1b6d){const _0x3374f2=_0x496fcc,_0x429d6d=_0x1c6807['getSettings']();if(!_0x429d6d)return;const _0x2db7b5=_0x3fe0e0[_0x3374f2(0x125)]('.');let _0x2155a8=_0x429d6d;for(let _0x4b543a=0x0;_0x4b543a<_0x2db7b5[_0x3374f2(0x123)]-0x1;_0x4b543a++){_0x2155a8=_0x2155a8[_0x2db7b5[_0x4b543a]]=_0x2155a8[_0x2db7b5[_0x4b543a]]||{};}_0x2155a8[_0x2db7b5[_0x2db7b5[_0x3374f2(0x123)]-0x1]]=_0x5c1b6d,_0x1c6807[_0x3374f2(0x19b)](),log(_0x3374f2(0x7f)+_0x3fe0e0+'\x27\x20已更新为:\x20'+JSON['stringify'](_0x5c1b6d),_0x3374f2(0x193));}function bindAutoSaveEvents(){const _0x26809b=_0x496fcc,_0x4bd54e=document['getElementById'](_0x26809b(0x97));if(!_0x4bd54e)return;_0x4bd54e[_0x26809b(0x20c)](_0x26809b(0x1b4),_0x4df5a6=>{const _0x38f60e=_0x26809b,_0x15b3bf=_0x4df5a6[_0x38f60e(0x15b)],_0xf86dd2=_0x15b3bf['dataset'][_0x38f60e(0x10d)];if(!_0xf86dd2)return;let _0x2ded99;const _0x41ddd7=_0x15b3bf[_0x38f60e(0xc2)][_0x38f60e(0x1c1)]||'string';if(_0x15b3bf[_0x38f60e(0x1c1)]==='checkbox')_0x2ded99=_0x15b3bf[_0x38f60e(0x1d0)];else{if(_0x15b3bf['type']==='radio'){if(_0x15b3bf[_0x38f60e(0x1d0)]){const _0x13346d=_0x4bd54e[_0x38f60e(0x1d6)](_0x38f60e(0x1ef)+_0x15b3bf[_0x38f60e(0x16a)]+'\x22]'),_0x5d84f6=Array[_0x38f60e(0xfa)](_0x13346d)[_0x38f60e(0x145)](_0x1ff526=>_0x1ff526[_0x38f60e(0x1d0)]);_0x2ded99=_0x5d84f6['value'];}else return;}else _0x2ded99=_0x15b3bf[_0x38f60e(0x14e)];}switch(_0x41ddd7){case _0x38f60e(0x18e):_0x2ded99=parseInt(_0x2ded99,0xa);break;case'float':_0x2ded99=parseFloat(_0x2ded99);break;case _0x38f60e(0xcd):typeof _0x2ded99!==_0x38f60e(0xcd)&&(_0x2ded99=_0x2ded99===_0x38f60e(0xba));break;}if(_0x15b3bf[_0x38f60e(0x1c1)]===_0x38f60e(0x8a)&&!_0x15b3bf[_0x38f60e(0x1d0)])return;updateAndSaveSetting(_0xf86dd2,_0x2ded99);});}export function bindHanlinyuanEvents(){const _0x2325eb=_0x496fcc,_0x1e1175=getContext();if(!_0x1e1175){console[_0x2325eb(0x1d2)](_0x2325eb(0x12f));return;}setupGlobalEventHandlers(),bindPanelToggleEvents(),bindInternalUIEvents(),bindTutorialEvents(),bindAutoSaveEvents(),bindSessionLockEvent();if(_0x1c6807['initialize'])_0x1c6807[_0x2325eb(0x197)]();else{console['error'](_0x2325eb(0x126));return;}loadSettingsToUI(),loadWorldbookList(),log(_0x2325eb(0xb2),_0x2325eb(0x1dd));const _0x167ce6=document['getElementById'](_0x2325eb(0x161)),_0x151d18=document[_0x2325eb(0xbb)](_0x2325eb(0x1af)),_0x30ece8=document[_0x2325eb(0xbb)](_0x2325eb(0x9b)),_0x231f06=document[_0x2325eb(0xbb)](_0x2325eb(0x207)),_0x1998c2=document[_0x2325eb(0xbb)](_0x2325eb(0x1bd)),_0x43abce=document[_0x2325eb(0xbb)](_0x2325eb(0x1e7)),_0x2cc887=document['getElementById'](_0x2325eb(0x19e)),_0x38e24b=document['getElementById'](_0x2325eb(0x19f));let _0xb68a04=null,_0x1fef77=null;_0x167ce6[_0x2325eb(0x20c)](_0x2325eb(0x1b4),_0x1e6cd2=>{const _0x3cbda1=_0x2325eb;_0xb68a04=_0x1e6cd2['target']['files'][0x0],_0xb68a04?(_0x151d18['textContent']=_0xb68a04[_0x3cbda1(0x16a)],_0x151d18[_0x3cbda1(0x7d)]=_0xb68a04[_0x3cbda1(0x16a)]):_0x151d18[_0x3cbda1(0x10f)]=_0x3cbda1(0xda);}),_0x30ece8[_0x2325eb(0x20c)](_0x2325eb(0xe4),async()=>{const _0xb22eb3=_0x2325eb;if(!_0xb68a04){toastr['warning'](_0xb22eb3(0x10c));return;}let _0x170195=0x0;const _0x54c080=_0x3be14c[_0xb22eb3(0x111)](_0xb68a04),_0x12df49=_0x3be14c[_0xb22eb3(0x128)](_0x54c080);if(_0x12df49){const _0x561aac=(_0x12df49['processedChunks']/_0x12df49[_0xb22eb3(0x15f)]*0x64)[_0xb22eb3(0x210)](0x1),_0xa2e3e3=confirm(_0xb22eb3(0x9f)+_0x561aac+_0xb22eb3(0x20f));_0xa2e3e3?(_0x170195=_0x12df49['processedChunks'],toastr[_0xb22eb3(0x1dd)](_0xb22eb3(0xb3)+(_0x170195+0x1)+_0xb22eb3(0x72),_0xb22eb3(0x80)),log(_0xb22eb3(0x1a4)+_0x54c080+_0xb22eb3(0x107)+_0x170195+_0xb22eb3(0xa8),_0xb22eb3(0x1dd))):(_0x3be14c[_0xb22eb3(0x9e)](_0x54c080),toastr['info'](_0xb22eb3(0x199),_0xb22eb3(0x80)),log(_0xb22eb3(0xc7)+_0x54c080+'，重新开始。',_0xb22eb3(0x93)));}_0x1fef77=new AbortController();const _0xfe327=_0x1fef77['signal'];_0x38e24b[_0xb22eb3(0xd0)][_0xb22eb3(0x1d1)]=_0xb22eb3(0x1f5),_0x1998c2[_0xb22eb3(0xd0)][_0xb22eb3(0x1d1)]='block',_0x2cc887[_0xb22eb3(0x10f)]=_0xb22eb3(0xb9),_0x43abce[_0xb22eb3(0x14e)]=0x0;try{const _0x332033=await _0xb68a04[_0xb22eb3(0x6c)](),_0x2e971f=_0x7eb7a3=>{const _0xc142d7=_0xb22eb3;_0x2cc887[_0xc142d7(0x10f)]=_0xc142d7(0x13a)+_0x7eb7a3[_0xc142d7(0xad)]+'\x20('+_0x7eb7a3[_0xc142d7(0x1d3)]+'/'+_0x7eb7a3[_0xc142d7(0x1e2)]+')',_0x43abce['value']=_0x7eb7a3['processed']/_0x7eb7a3[_0xc142d7(0x1e2)]*0x64;},_0x1eb283=()=>{const _0x2a86fe=_0xb22eb3;updatePanelStatus(),log(_0x2a86fe(0xeb),_0x2a86fe(0x1dd));},_0x3f857f=await _0x1c6807[_0xb22eb3(0x1ba)](_0x332033,_0xb22eb3(0x105),{'sourceName':_0xb68a04[_0xb22eb3(0x16a)]},_0x2e971f,_0xfe327,log,_0x1eb283,_0x54c080,_0x170195);if(_0x3f857f[_0xb22eb3(0x193)])toastr[_0xb22eb3(0x193)](_0xb22eb3(0x16f)+_0x3f857f['count']+_0xb22eb3(0x8e)),_0x2cc887[_0xb22eb3(0x10f)]=_0xb22eb3(0x13b)+_0x3f857f['count']+_0xb22eb3(0x11b),_0x43abce['value']=0x64,updatePanelStatus();else throw new Error(_0x3f857f['error']||_0xb22eb3(0xd6));}catch(_0x11e844){_0x11e844[_0xb22eb3(0x16a)]===_0xb22eb3(0xd2)?(toastr[_0xb22eb3(0x1dd)]('任务已由用户中止。进度已保存，可随时继续。'),_0x2cc887['textContent']=_0xb22eb3(0xcf)):(toastr[_0xb22eb3(0x1d2)](_0xb22eb3(0x1aa)+_0x11e844['message']+'。进度已保存，可稍后重试。'),_0x2cc887[_0xb22eb3(0x10f)]='错误:\x20'+_0x11e844['message']);}finally{setTimeout(()=>{const _0x1585f1=_0xb22eb3;_0x38e24b[_0x1585f1(0xd0)][_0x1585f1(0x1d1)]=_0x1585f1(0x12b),_0x1998c2[_0x1585f1(0xd0)]['display']=_0x1585f1(0x1f5),_0x167ce6[_0x1585f1(0x14e)]='',_0xb68a04=null,_0x151d18[_0x1585f1(0x10f)]=_0x1585f1(0xda);},0xbb8);}}),_0x231f06[_0x2325eb(0x20c)]('click',()=>{const _0x4608e5=_0x2325eb;_0x1fef77&&_0x1fef77[_0x4608e5(0x132)]();});}function bindSessionLockEvent(){const _0x203f04=_0x496fcc,_0x4966b5=document['getElementById'](_0x203f04(0x14b));if(!_0x4966b5)return;_0x4966b5['addEventListener'](_0x203f04(0xe4),async()=>{const _0x47f084=_0x203f04,_0x33f3e1=await _0x1c6807['toggleSessionLock']();updateSessionLockUI(_0x33f3e1);if(_0x33f3e1){const _0x1a8861=_0x1c6807[_0x47f084(0xe9)]();_0x1a8861&&(toastr[_0x47f084(0x193)](_0x47f084(0x140)+_0x1a8861['id'],'圣旨已下'),log(_0x47f084(0x6f)+_0x1a8861['id'],_0x47f084(0x193)));}else toastr['info'](_0x47f084(0xf0),'诏曰'),log(_0x47f084(0x185),_0x47f084(0x1dd));updatePanelStatus();}),updateSessionLockUI(_0x1c6807[_0x203f04(0x74)]());}function updateSessionLockUI(_0x3c0faf){const _0x5e5539=_0x496fcc,_0x227892=document[_0x5e5539(0xbb)](_0x5e5539(0x14b));if(!_0x227892)return;const _0x4d0ccd=_0x227892['querySelector']('i'),_0x262c35=_0x227892[_0x5e5539(0x18b)](_0x5e5539(0x200));_0x3c0faf?(_0x227892[_0x5e5539(0x201)][_0x5e5539(0x1b3)]('active'),_0x4d0ccd[_0x5e5539(0x190)]='fas\x20fa-lock',_0x262c35['textContent']=_0x5e5539(0x178),_0x227892['title']='点击以解锁，让翰林院跟随当前角色'):(_0x227892['classList'][_0x5e5539(0x1be)](_0x5e5539(0x147)),_0x4d0ccd[_0x5e5539(0x190)]='fas\x20fa-lock-open',_0x262c35['textContent']='锁定会话',_0x227892[_0x5e5539(0x7d)]=_0x5e5539(0x155));}function bindPanelToggleEvents(){const _0x36de07=_0x496fcc,_0x30ae9d=document[_0x36de07(0xbb)](_0x36de07(0x152));if(_0x30ae9d){}}function bindTutorialEvents(){const _0x28306d=_0x496fcc,_0x2a05ce=document[_0x28306d(0xbb)]('amily2_open_hanlin_tutorial');_0x2a05ce&&_0x2a05ce[_0x28306d(0x20c)](_0x28306d(0xe4),()=>{const _0x3a7013=_0x28306d;showContentModal(_0x3a7013(0x11d),'scripts/extensions/third-party/ST-Amily2-Chat-Optimisation/HanLin.md');});}function bindInternalUIEvents(){const _0x139501=_0x496fcc,_0x3dfd37=document[_0x139501(0x1d6)]('.hly-nav-item');_0x3dfd37['forEach'](_0x3394ac=>{_0x3394ac['addEventListener']('click',()=>{const _0x1c595d=_0x1895,_0x3cab4c=_0x3394ac[_0x1c595d(0xc2)][_0x1c595d(0xac)],_0x346a23=_0x1c595d(0x13f)+_0x3cab4c+'-tab';document[_0x1c595d(0x1d6)](_0x1c595d(0x1e5))[_0x1c595d(0x17d)](_0x5815b0=>{const _0x2bdef8=_0x1c595d;_0x5815b0['classList']['toggle'](_0x2bdef8(0x147),_0x5815b0['id']===_0x346a23);}),_0x3dfd37[_0x1c595d(0x17d)](_0x21f3c8=>_0x21f3c8['classList'][_0x1c595d(0x1b5)](_0x1c595d(0x147),_0x21f3c8===_0x3394ac));});});const _0x5c0f5d=document['getElementById']('hly-api-endpoint');_0x5c0f5d&&_0x5c0f5d[_0x139501(0x20c)](_0x139501(0x1b4),handleApiModeChange);const _0x3bc278=document[_0x139501(0x1d6)](_0x139501(0x17c));_0x3bc278[_0x139501(0x17d)](_0x27dcc1=>{const _0x2a9399=_0x139501;_0x27dcc1['addEventListener'](_0x2a9399(0x1b4),toggleInjectionDetails);});const _0x20fba2=document[_0x139501(0xbb)](_0x139501(0x15d)),_0x1baf31=document[_0x139501(0xbb)](_0x139501(0x141));_0x20fba2&&_0x1baf31&&_0x20fba2['addEventListener'](_0x139501(0x1b4),()=>{const _0xf01c7=_0x139501;_0x1baf31[_0xf01c7(0xd0)][_0xf01c7(0x1d1)]=_0x20fba2[_0xf01c7(0x1d0)]?_0xf01c7(0xa0):_0xf01c7(0x1f5);});const _0x438209=document[_0x139501(0xbb)](_0x139501(0x1ae));_0x438209&&_0x438209[_0x139501(0x20c)](_0x139501(0x1b4),handleWorldbookSelectionChange);const _0x164965=document[_0x139501(0xbb)](_0x139501(0x149));_0x164965&&_0x164965[_0x139501(0x20c)](_0x139501(0xe4),showExclusionRulesModal);const _0x4cc8ca=document[_0x139501(0xbb)]('hly-hist-entry-multiselect-btn'),_0x132b8f=document[_0x139501(0xbb)](_0x139501(0x205));_0x4cc8ca&&_0x132b8f&&(_0x4cc8ca[_0x139501(0x20c)](_0x139501(0xe4),_0x582190=>{const _0x177318=_0x139501;_0x582190[_0x177318(0x1ed)]();const _0x3a447d=_0x132b8f[_0x177318(0xd0)][_0x177318(0x1d1)]===_0x177318(0xa0);_0x132b8f['style'][_0x177318(0x1d1)]=_0x3a447d?_0x177318(0x1f5):_0x177318(0xa0);}),_0x132b8f[_0x139501(0x20c)](_0x139501(0x1b4),_0x2098a9=>{const _0x56ca5e=_0x139501,_0x3255fa=_0x2098a9[_0x56ca5e(0x15b)];if(_0x3255fa[_0x56ca5e(0x1c1)]!==_0x56ca5e(0x17f))return;const _0xd248e7=_0x132b8f[_0x56ca5e(0x1d6)]('.hly-hist-entry-checkbox'),_0x11f2e1=document[_0x56ca5e(0xbb)](_0x56ca5e(0x18d));if(_0x3255fa['id']==='hly-hist-select-all-entries')_0xd248e7[_0x56ca5e(0x17d)](_0x1173cb=>_0x1173cb['checked']=_0x3255fa[_0x56ca5e(0x1d0)]);else{const _0x461bd5=Array[_0x56ca5e(0xfa)](_0xd248e7)['every'](_0x2acf96=>_0x2acf96['checked']);_0x11f2e1[_0x56ca5e(0x1d0)]=_0x461bd5;}const _0x47e416=_0x132b8f[_0x56ca5e(0x1d6)]('.hly-hist-entry-checkbox:checked')[_0x56ca5e(0x123)],_0x36ba1c=_0xd248e7[_0x56ca5e(0x123)];_0x4cc8ca['querySelector']('span')[_0x56ca5e(0x10f)]='已选择\x20'+_0x47e416+_0x56ca5e(0x179)+_0x36ba1c+_0x56ca5e(0x1eb);}),document['addEventListener'](_0x139501(0xe4),_0x5c575b=>{const _0x35f18b=_0x139501;!_0x4cc8ca['contains'](_0x5c575b[_0x35f18b(0x15b)])&&!_0x132b8f[_0x35f18b(0x204)](_0x5c575b[_0x35f18b(0x15b)])&&(_0x132b8f[_0x35f18b(0xd0)][_0x35f18b(0x1d1)]=_0x35f18b(0x1f5));}));const _0x48de85=document[_0x139501(0xbb)](_0x139501(0x127));_0x48de85&&_0x48de85[_0x139501(0x20c)](_0x139501(0xe4),deleteAllKnowledgeBases);}function toggleInjectionDetails(){const _0x579d77=_0x496fcc,_0x13e1b2=document[_0x579d77(0x18b)](_0x579d77(0x144))[_0x579d77(0x14e)],_0x285370=document[_0x579d77(0xbb)](_0x579d77(0x6b)),_0x415439=document[_0x579d77(0xbb)](_0x579d77(0x1ec)),_0x48887b=_0x13e1b2==='1';_0x285370[_0x579d77(0x113)]=!_0x48887b,_0x415439[_0x579d77(0x113)]=!_0x48887b;}function handleApiModeChange(){const _0x16845e=_0x496fcc,_0x19c91b=document[_0x16845e(0xbb)]('hly-api-endpoint')[_0x16845e(0x14e)],_0x4834be=document['getElementById']('hly-custom-endpoint-docket'),_0x5c7590=document[_0x16845e(0xbb)](_0x16845e(0x189)),_0x11c9ac=document[_0x16845e(0xbb)]('hly-embedding-model'),_0x4503ff=_0x11c9ac[_0x16845e(0x73)];if(!_0x4834be||!_0x5c7590)return;_0x4834be[_0x16845e(0xd0)]['display']=_0x16845e(0xa0),_0x5c7590['style'][_0x16845e(0x1d1)]=_0x16845e(0xa0);switch(_0x19c91b){case _0x16845e(0xe5):_0x4834be[_0x16845e(0xd0)][_0x16845e(0x1d1)]=_0x16845e(0x1f5),_0x5c7590['querySelector'](_0x16845e(0x118))[_0x16845e(0x10f)]='Google\x20API\x20Key:',_0x5c7590[_0x16845e(0x18b)]('input')[_0x16845e(0x11f)]='请输入您的Google\x20API\x20Key';break;case _0x16845e(0x1e1):_0x4834be[_0x16845e(0x18b)](_0x16845e(0x118))[_0x16845e(0x10f)]=_0x16845e(0x1ab),_0x4834be[_0x16845e(0x18b)]('input')['placeholder']=_0x16845e(0x6d),_0x5c7590[_0x16845e(0xd0)]['display']=_0x16845e(0x1f5);break;case _0x16845e(0x1a1):default:_0x4834be[_0x16845e(0x18b)](_0x16845e(0x118))[_0x16845e(0x10f)]=_0x16845e(0x20a),_0x4834be[_0x16845e(0x18b)]('input')[_0x16845e(0x11f)]='输入兼容OpenAI的embeddings端点',_0x5c7590[_0x16845e(0x18b)]('label')[_0x16845e(0x10f)]=_0x16845e(0x192);break;}}function loadSettingsToUI(){const _0xb24d77=_0x496fcc,_0x2b1707=_0x1c6807[_0xb24d77(0x7c)]();if(!_0x2b1707)return;document[_0xb24d77(0xbb)](_0xb24d77(0x78))['checked']=_0x2b1707[_0xb24d77(0x1ad)][_0xb24d77(0x79)],document[_0xb24d77(0xbb)](_0xb24d77(0x171))[_0xb24d77(0x14e)]=_0x2b1707['retrieval'][_0xb24d77(0x13d)],document[_0xb24d77(0xbb)]('hly-custom-api-url')[_0xb24d77(0x14e)]=_0x2b1707[_0xb24d77(0x1ad)][_0xb24d77(0x16e)],document['getElementById']('hly-api-key')[_0xb24d77(0x14e)]=_0x2b1707[_0xb24d77(0x1ad)]['apiKey'];const _0x5c6cb8=document[_0xb24d77(0xbb)](_0xb24d77(0x12a));if(_0x5c6cb8[_0xb24d77(0x1fb)]['length']===0x0){const _0x121247=_0x2b1707[_0xb24d77(0x1ad)][_0xb24d77(0x206)],_0x5e007f=new Option(_0x121247,_0x121247,!![],!![]);_0x5c6cb8[_0xb24d77(0x1b3)](_0x5e007f);}_0x5c6cb8['value']=_0x2b1707[_0xb24d77(0x1ad)][_0xb24d77(0x206)],document[_0xb24d77(0xbb)]('hly-retrieval-notify')[_0xb24d77(0x1d0)]=_0x2b1707[_0xb24d77(0x1ad)][_0xb24d77(0xa6)],document[_0xb24d77(0xbb)](_0xb24d77(0x1c9))[_0xb24d77(0x14e)]=_0x2b1707[_0xb24d77(0xf2)][_0xb24d77(0x1bb)],document[_0xb24d77(0xbb)](_0xb24d77(0x1fc))[_0xb24d77(0x14e)]=_0x2b1707[_0xb24d77(0xf2)][_0xb24d77(0x1f8)],document[_0xb24d77(0xbb)](_0xb24d77(0x12c))['value']=_0x2b1707['advanced'][_0xb24d77(0x82)],document['getElementById'](_0xb24d77(0x116))[_0xb24d77(0x14e)]=_0x2b1707[_0xb24d77(0xf2)][_0xb24d77(0x1a5)],document[_0xb24d77(0xbb)](_0xb24d77(0x203))[_0xb24d77(0x14e)]=_0x2b1707[_0xb24d77(0xf2)][_0xb24d77(0x1cb)],document['getElementById']('hly-batch-size')[_0xb24d77(0x14e)]=_0x2b1707[_0xb24d77(0x1ad)][_0xb24d77(0x1e8)],document[_0xb24d77(0xbb)](_0xb24d77(0x9d))[_0xb24d77(0x14e)]=_0x2b1707[_0xb24d77(0x1f2)][_0xb24d77(0x15e)];const _0x4c93a5=document[_0xb24d77(0x18b)](_0xb24d77(0xd9)+_0x2b1707[_0xb24d77(0x1f2)][_0xb24d77(0xe2)]+'\x22]');_0x4c93a5&&(_0x4c93a5[_0xb24d77(0x1d0)]=!![]);document['getElementById']('hly-injection-depth')[_0xb24d77(0x14e)]=_0x2b1707[_0xb24d77(0x1f2)]['depth'],document['getElementById'](_0xb24d77(0x1ec))[_0xb24d77(0x14e)]=_0x2b1707['injection']['depth_role'],toggleInjectionDetails(),handleApiModeChange(),document['getElementById'](_0xb24d77(0xf6))[_0xb24d77(0x1d0)]=_0x2b1707[_0xb24d77(0xa1)][_0xb24d77(0x79)],document[_0xb24d77(0xbb)](_0xb24d77(0xef))['value']=_0x2b1707[_0xb24d77(0xa1)][_0xb24d77(0x6e)],document[_0xb24d77(0xbb)]('hly-layer-end')[_0xb24d77(0x14e)]=_0x2b1707[_0xb24d77(0xa1)]['layerEnd'],document['getElementById']('hly-include-user')[_0xb24d77(0x1d0)]=_0x2b1707[_0xb24d77(0xa1)][_0xb24d77(0x8c)][_0xb24d77(0xdc)],document[_0xb24d77(0xbb)](_0xb24d77(0x1c3))[_0xb24d77(0x1d0)]=_0x2b1707[_0xb24d77(0xa1)]['messageTypes']['ai'];const _0x4dd526=document[_0xb24d77(0xbb)](_0xb24d77(0x15d)),_0x2a974a=document['getElementById'](_0xb24d77(0xc3)),_0x132ff0=document[_0xb24d77(0xbb)]('hly-tag-input-container');_0x4dd526[_0xb24d77(0x1d0)]=_0x2b1707[_0xb24d77(0xa1)][_0xb24d77(0x7a)],_0x2a974a[_0xb24d77(0x14e)]=_0x2b1707[_0xb24d77(0xa1)][_0xb24d77(0xc0)],_0x132ff0[_0xb24d77(0xd0)][_0xb24d77(0x1d1)]=_0x4dd526[_0xb24d77(0x1d0)]?_0xb24d77(0xa0):_0xb24d77(0x1f5),document['getElementById'](_0xb24d77(0xc5))['checked']=_0x2b1707[_0xb24d77(0x14c)][_0xb24d77(0x79)],document[_0xb24d77(0xbb)](_0xb24d77(0xf3))[_0xb24d77(0x14e)]=_0x2b1707[_0xb24d77(0x14c)][_0xb24d77(0x209)],document[_0xb24d77(0xbb)](_0xb24d77(0xbd))['value']=_0x2b1707[_0xb24d77(0x14c)][_0xb24d77(0x195)];const _0xa64256=document[_0xb24d77(0xbb)](_0xb24d77(0x108));if(_0xa64256[_0xb24d77(0x1fb)][_0xb24d77(0x123)]===0x0){const _0x1fe0b5=_0x2b1707[_0xb24d77(0x14c)]['model'];if(_0x1fe0b5){const _0x42ac90=new Option(_0x1fe0b5,_0x1fe0b5,!![],!![]);_0xa64256[_0xb24d77(0x1b3)](_0x42ac90);}}_0xa64256['value']=_0x2b1707[_0xb24d77(0x14c)][_0xb24d77(0xd5)],document[_0xb24d77(0xbb)](_0xb24d77(0x12d))[_0xb24d77(0x14e)]=_0x2b1707['rerank'][_0xb24d77(0x182)],document[_0xb24d77(0xbb)]('hly-rerank-hybrid-alpha')[_0xb24d77(0x14e)]=_0x2b1707[_0xb24d77(0x14c)]['hybrid_alpha'],document['getElementById'](_0xb24d77(0x122))['checked']=_0x2b1707[_0xb24d77(0x14c)][_0xb24d77(0xa6)];}function saveSettingsFromUI(_0x671b34=!![]){const _0x17be3a=_0x496fcc,_0x76794e=document[_0x17be3a(0xbb)](_0x17be3a(0x97));if(!_0x76794e)return;const _0x1ddff3=_0x76794e[_0x17be3a(0x1d6)]('[data-setting-key]');_0x1ddff3[_0x17be3a(0x17d)](_0x574ea3=>{const _0x154903=_0x17be3a,_0x540871=_0x574ea3[_0x154903(0xc2)]['settingKey'];if(!_0x540871)return;let _0x4a5438;const _0x44891b=_0x574ea3[_0x154903(0xc2)]['type']||_0x154903(0xbc);if(_0x574ea3[_0x154903(0x1c1)]==='checkbox')_0x4a5438=_0x574ea3[_0x154903(0x1d0)];else{if(_0x574ea3[_0x154903(0x1c1)]==='radio'){if(!_0x574ea3[_0x154903(0x1d0)])return;_0x4a5438=_0x574ea3[_0x154903(0x14e)];}else _0x4a5438=_0x574ea3[_0x154903(0x14e)];}switch(_0x44891b){case _0x154903(0x18e):_0x4a5438=parseInt(_0x4a5438,0xa);break;case _0x154903(0xde):_0x4a5438=parseFloat(_0x4a5438);break;case'boolean':if(typeof _0x4a5438!==_0x154903(0xcd))_0x4a5438=_0x4a5438==='true';break;}const _0x4fc412=_0x1c6807[_0x154903(0x7c)](),_0x5e76db=_0x540871['split']('.');let _0x5b6ac5=_0x4fc412;for(let _0x1a10cd=0x0;_0x1a10cd<_0x5e76db[_0x154903(0x123)]-0x1;_0x1a10cd++){_0x5b6ac5=_0x5b6ac5[_0x5e76db[_0x1a10cd]]=_0x5b6ac5[_0x5e76db[_0x1a10cd]]||{};}_0x5b6ac5[_0x5e76db[_0x5e76db['length']-0x1]]=_0x4a5438;}),_0x1c6807[_0x17be3a(0x19b)](),!_0x671b34&&(log(_0x17be3a(0x1d7),_0x17be3a(0x193)),toastr[_0x17be3a(0x193)](_0x17be3a(0x1a9),_0x17be3a(0x80)));}function resetSettingsToUI(){const _0x3b9ce0=_0x496fcc;confirm(_0x3b9ce0(0xf7))&&(_0x1c6807[_0x3b9ce0(0x10a)](),loadSettingsToUI(),toastr[_0x3b9ce0(0x1dd)](_0x3b9ce0(0x196),'诏曰'));}async function updatePanelStatus(){const _0x3883fe=_0x496fcc,_0x22c401=_0x1c6807[_0x3883fe(0x74)](),_0x2e10a6=document[_0x3883fe(0xbb)](_0x3883fe(0x170)),_0x4a5d62=document[_0x3883fe(0xbb)](_0x3883fe(0xd4));if(_0x22c401){const _0x83a119=_0x1c6807[_0x3883fe(0xe9)]();_0x83a119&&(_0x2e10a6['textContent']=_0x3883fe(0xc4),_0x4a5d62[_0x3883fe(0x10f)]=_0x83a119['id'],_0x4a5d62[_0x3883fe(0x7d)]=_0x3883fe(0xc8)+_0x83a119['id'],_0x2e10a6[_0x3883fe(0x201)][_0x3883fe(0x1b3)](_0x3883fe(0x1c0)),_0x4a5d62[_0x3883fe(0x201)][_0x3883fe(0x1b3)](_0x3883fe(0x1c0)));}else _0x2e10a6[_0x3883fe(0x10f)]=_0x2f10ec[_0x3883fe(0x10e)](),_0x4a5d62[_0x3883fe(0x10f)]=_0x2f10ec[_0x3883fe(0xdb)]()||'无',_0x4a5d62[_0x3883fe(0x7d)]='',_0x2e10a6[_0x3883fe(0x201)]['remove'](_0x3883fe(0x1c0)),_0x4a5d62[_0x3883fe(0x201)]['remove'](_0x3883fe(0x1c0));const _0x2f28ec=document[_0x3883fe(0xbb)]('hly-current-vector-count');_0x2f28ec['textContent']='...';try{const _0x319d30=await _0x1c6807[_0x3883fe(0xf5)]();_0x2f28ec[_0x3883fe(0x10f)]=_0x319d30;}catch(_0x5a41ff){console[_0x3883fe(0x1d2)]('[翰林院-枢纽]\x20更新忆识数量失败:',_0x5a41ff),_0x2f28ec[_0x3883fe(0x10f)]=_0x3883fe(0x112),_0x2f28ec[_0x3883fe(0x7d)]=_0x3883fe(0x1f0)+_0x5a41ff[_0x3883fe(0xad)];}const _0x332bbf=document[_0x3883fe(0xbb)]('hly-condensation-results');if(_0x332bbf&&!_0x332bbf[_0x3883fe(0xc2)][_0x3883fe(0x1b1)]){const _0x22d439=_0x1c6807[_0x3883fe(0x7c)](),_0x29d1e7=await _0x1c6807[_0x3883fe(0x160)]();if(_0x22d439[_0x3883fe(0x19d)]&&_0x22d439[_0x3883fe(0x19d)][_0x29d1e7]){const _0x4cd4b9=_0x22d439['condensationHistory'][_0x29d1e7];_0x332bbf[_0x3883fe(0x16c)]=_0x3883fe(0x85)+_0x4cd4b9[_0x3883fe(0x1e0)]+'\x20楼凝识至第\x20'+_0x4cd4b9[_0x3883fe(0x187)]+_0x3883fe(0xa7);}else _0x332bbf[_0x3883fe(0x16c)]=_0x3883fe(0x174);}renderKnowledgeBases();}async function deleteAllKnowledgeBases(){const _0x3ea213=_0x496fcc,_0xc56b55=await _0x1c6807[_0x3ea213(0x1c2)](),_0x4321aa=Object[_0x3ea213(0x86)](_0xc56b55);if(_0x4321aa['length']===0x0){toastr[_0x3ea213(0x1dd)](_0x3ea213(0x20d),'圣谕');return;}if(!confirm(_0x3ea213(0x66)+_0x4321aa['length']+_0x3ea213(0x1b9)))return;toastr[_0x3ea213(0x1dd)]('正在执行焚书坑儒...\x20准备删除\x20'+_0x4321aa[_0x3ea213(0x123)]+_0x3ea213(0x117),'圣旨'),log('开始批量删除\x20'+_0x4321aa[_0x3ea213(0x123)]+'\x20个知识库...','warn');let _0x577f17=0x0,_0x5474cd=0x0;for(const _0x2cbe83 of _0x4321aa){try{await _0x1c6807[_0x3ea213(0x114)](_0x2cbe83),_0x577f17++;}catch(_0x17e494){_0x5474cd++,log(_0x3ea213(0x102)+_0x2cbe83+_0x3ea213(0x99)+_0x17e494[_0x3ea213(0xad)],'error');}}_0x5474cd>0x0?toastr['error'](_0x3ea213(0x104)+_0x5474cd+_0x3ea213(0x1e3),'警报'):toastr[_0x3ea213(0x193)](_0x3ea213(0x1bc)+_0x577f17+'\x20个知识库均已成功删除。',_0x3ea213(0x17b)),log(_0x3ea213(0x14f)+_0x577f17+_0x3ea213(0x156)+_0x5474cd,_0x3ea213(0x1dd)),await updatePanelStatus();}function _0x4acc(){const _0x560cb4=['hly-rerank-model','神力连接通畅！','resetSettings','凝识完成！新增\x20','请先选择一个\x20.txt\x20文件','settingKey','getCharacterName','textContent','开始对《','generateJobId','N/A','disabled','removeKnowledgeBase','hly-log-entry\x20','hly-query-message-count','\x20个知识库。','label','data','1258170czhBTk','\x20个知识块。','input','翰林院使用教程','批量编纂任务已完成，但有部分错误。','placeholder','children','val','hly-rerank-notify','length','\x0a忆识总数:\x20','split','[翰林院-枢纽]\x20核心法典未能提供初始化圣旨！','hly-kb-delete-all-btn','loadProgress','log-info','hly-embedding-model','flex','hly-match-threshold','hly-rerank-top-n','is-user','[翰林院-枢纽]\x20未能获取SillyTavern上下文，绑定失败。','testApiConnection','已选择\x20','abort','preview-item-','查看宝库状态成功：集合ID=','totalSuccess','》的批量编纂任务已完成。成功:\x20','closest','<p\x20class=\x22hly-notes\x20log-error\x22><i>加载知识库列表失败:\x20','[翰林院-枢纽]\x20手动录入过程发生错误:','处理中:\x20','任务完成！成功录入\x20','fetchEmbeddingModels','apiEndpoint','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-preview-item-v2\x22\x20id=\x22','hly-','会话已锁定到:\x20','hly-tag-input-container','.hly-log-placeholder','beforeend','input[name=\x22hly-injection-position\x22]:checked','find','\x20个条目进行编纂...','active','开始获取Rerank模型列表...','hly-exclusion-rules-btn','删除失败:\x20','hly-session-lock-btn','rerank','\x20条消息，开始凝识...','value','批量删除完成。成功:\x20','加载书库列表失败:\x20','用户请求查看宝库状态。','amily2_open_rag_palace','\x22></i>\x20[','appendChild','点击以锁定，让翰林院固定操作当前角色的宝库',',\x20失败:\x20','预览并编辑凝识内容','[翰林院-枢纽]\x20渲染知识库列表失败:','totalVectors','文书已成功录入宝库，新增\x20','target','严重错误','hly-tag-extraction-toggle','template','totalChunks','getCollectionId','hanlinyuan-ingest-novel-file-input','toLocaleTimeString','hly-historiography-results','正在查询宝库状态...','scrollHeight','获取模型失败:\x20','hlyLog','<p\x20class=\x22hly-notes\x22><i>当前角色还没有专属知识库。</i></p>','map','name','6930880JkQmQp','innerHTML','kbId','customApiUrl','成功录入\x20','hly-current-character-name','hly-api-endpoint','stringify','startHLYHistoriography','<p\x20class=\x22hly-record-hint\x22>可在此预览凝识结果。</p>','<option>未找到模型</option>','知识库\x20','</textarea>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</details>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22hly-preview-delete-btn-v2\x22\x20data-target=\x22','解锁会话','\x20/\x20','selectedIndex','大功告成','input[name=\x22hly-injection-position\x22]','forEach','[翰林院-枢纽]\x20预览过程发生错误:','checkbox','\x22\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20data-send-date=\x22','获取Rerank模型失败:\x20','top_n','未找到符合条件的消息。','114bxUMhs','会话已解锁。','hly-log-output','end','[翰林院-枢纽]\x20获取Rerank模型列表失败:','hly-api-key-group','</i></p>','querySelector','4836909ivqAVm','hly-hist-select-all-entries','integer','toggleKnowledgeBase','className','加载失败','通行令牌\x20(API\x20Key):','success','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20class=\x22hly-multiselect-option\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20id=\x22hly-hist-select-all-entries\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>全选/全不选</strong>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</label>','apiKey','翰林院设定已重置为初始状态。','initialize','log-success','遵命，将从头开始录入此书。','录入内容不能为空。','saveSettings','成功获取\x20','condensationHistory','hanlinyuan-ingest-status','hanlinyuan-ingest-novel-controls','hly-delete-rule-btn','custom','.hly-kb-name','hly-layer-end','[断点续传]\x20用户选择继续任务\x20','queryMessageCount','.hly-preview-item-v2','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20class=\x22hly-multiselect-option\x22\x20title=\x22','use\x20strict','翰林院设定已存档封印。','录入失败:\x20','本地代理地址:','[翰林院-枢纽]\x20编纂过程发生严重错误:','retrieval','hly-hist-select-library','hanlinyuan-ingest-novel-file-name','此操作将彻底清空当前角色的所有忆识（向量），且无法恢复。您确定要继续吗？','finalText','hly-hist-entry-multiselect-btn','add','change','toggle','log-error','\x20条忆识。','<option\x20value=\x22\x22>请选择一个书库...</option>','\x20个知识库吗？此操作无法恢复！','ingestTextToHanlinyuan','chunkSize','所有\x20','hanlinyuan-ingest-progress-container','remove','<div\x20class=\x22hly-preview-container-v2\x22>','hly-locked-status','type','getKnowledgeBases','hly-include-ai','preventDefault','952RarVgE','hly-exclusion-rules-container','hly-manual-text','99811YRPfCv','hly-chunk-size','send_date','maxResults','20097SEMlES','聊天记录从第\x20','content','count','checked','display','error','processed','condensation.exclusionRules','fa-times-circle','querySelectorAll','【手动存档】所有设定已存档封印。','key','成功加载\x20','根据标签提取或内容排除条件，未找到任何有效内容。','findIndex','\x22\x20placeholder=\x22开始字符,\x20如\x20<!--\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span>到</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20class=\x22hly-imperial-brush\x22\x20value=\x22','info','.hly-kb-delete-btn','手动录入成功，新增\x20','start','local_proxy','total','\x20个知识库删除失败。','testHLYApi','.hly-tab-pane','》中的\x20','hanlinyuan-ingest-progress-bar','batchSize','includes','fetchHLYRerankModels','\x20个条目','hly-injection-role','stopPropagation','\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22hly-exclusion-rules-container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22hly-notes\x22>在这里定义需要从提取内容中排除的文本片段。例如，排除HTML注释，可以设置开始字符为\x20`<!--`，结束字符为\x20`-->`。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22hly-rules-list\x22>','input[name=\x22','无法获取总数:\x20','2tMYiaj','injection','查询宝库状态失败:\x20','[翰林院-枢纽]\x20查询宝库状态失败:','none','parse','265265yXkGCO','overlap','chat','getAvailableWorldbooks','options','hly-overlap-size','each','push','</div>','span','classList','is_user','hly-max-results','contains','hly-hist-entry-multiselect-options','embeddingModel','hanlinyuan-ingest-abort',',\x20忆识总数=','url','自定义路径:','知识库【','addEventListener','当前角色没有任何知识库可供删除。','#hly-rules-list','%。是否从上次中断之处继续？','toFixed','您确定要永久删除当前角色的全部\x20','mes','.hly-hist-entry-checkbox:checked','\x20个Rerank模型。','正在准备凝识...','hly-injection-depth','text','例如\x20http://127.0.0.1:8000/v1','layerStart','会话已锁定到宝库:\x20','saveHLYSettings','加载条目失败:\x20','\x20块继续录入。','previousElementSibling','isSessionLocked','正在获取可用书库列表...','[翰林院-枢纽]\x20加载《','宝库已清空。','hly-retrieval-enabled','enabled','tagExtractionEnabled','send-date','getSettings','title','purgeHLYStorage','[自动保存]\x20设置项\x20\x27','圣旨已达','getLoresForWorldbook','matchThreshold','trim','未能获取到任何Rerank模型。','<p\x20class=\x22hly-record-hint\x22><i>上次已从第\x20','keys','comment','fetchRerankModels','手动录入失败:\x20','radio','\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-exclusion-rule-row\x22\x20data-index=\x22','messageTypes','》的条目失败:','\x20个知识块','filter','#hly-add-rule-btn','hly-condensation-results','\x22\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20data-is-user=\x22','warn','已采集\x20','请先选择一个书库并至少选择一个要编纂的条目。','\x0a--------------------\x0aAPI端点:\x20','hly-modal-container','join','\x20失败:\x20','正在测试神力连接...','hanlinyuan-ingest-novel-start','log-warn','hly-injection-template','clearJob','启禀大人，发现此书上次录入已完成\x20','block','condensation','此书库为空','编纂失败:\x20','\x20楼到\x20','purgeStorage','notify','\x20楼。</i></p>','\x20块开始。','神力连接失败:\x20','编辑内容排除规则','\x20个条目。','tab','message','请先选择书库','内容排除规则已保存。','正在为《','开始获取模型列表...','[翰林院-枢纽]\x20已成功连接各部，政令畅通。','遵命，将从第\x20','floor','<option>正在获取...</option>','\x20楼:\x20[','翰林院启奏','executeCompilation','正在读取文件...','true','getElementById','string','hly-rerank-api-key','预览失败:\x20','<i\x20class=\x22fa-solid\x20','tags','\x20楼到第\x20','dataset','hly-tag-input','会话已锁定','hly-rerank-enabled','条)</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-kb-actions\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20class=\x22hly-toggle-switch\x22\x20title=\x22启用/禁用此知识库\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20class=\x22hly-kb-toggle\x22\x20','[断点续传]\x20用户选择放弃旧任务\x20','当前所有操作都将指向这个锁定的宝库：','18KppWfD','exclusionRules','\x22\x20placeholder=\x22结束字符,\x20如\x20-->\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22hly-delete-rule-btn\x22\x20title=\x22删除此规则\x22>&times;</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20','保存规则','boolean','文书录入失败:\x20','任务已中止。','style','fa-exclamation-triangle','AbortError','warning','hly-current-chat-id','model','未知错误','未找到符合条件的消息可供凝识。','insertAdjacentHTML','input[name=\x22hly-injection-position\x22][value=\x22','未选择文件','getChatId','user','hly-kb-list-item','float','<option>获取失败</option>','\x20(Key:\x20','\x20个模型。','position','\x20个条目进行批量编纂...','click','google_direct','showHLYStats','准备对《',')\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20class=\x22hly-hist-entry-checkbox\x22\x20value=\x22','getLockedSessionInfo','updateHLYMemoryCount','[实时刷新]\x20批次完成，忆识总数已更新。','getMessagesForCondensation','】已删除。','.hly-exclusion-rule-row','hly-layer-start','会话已解锁，将跟随当前角色。','entries','advanced','hly-rerank-url','.hly-preview-textarea','getVectorCount','hly-condensation-enabled','您确定要将所有设定恢复为出厂默认值吗？','\x20个书库。','hly-kb-list-container','from','\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<details\x20class=\x22hly-preview-details\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<summary\x20class=\x22hly-preview-summary\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20第\x20','createElement','凝识失败:\x20','正在加载条目...','fa-check-circle','未检测到预览文本，按标准流程采集消息...','finalMessages','删除知识库\x20','462116HZFLCK','操作完成，但有\x20','novel','\x20(ID:\x20','，从第\x20'];_0x4acc=function(){return _0x560cb4;};return _0x4acc();}async function renderKnowledgeBases(){const _0x3fb22e=_0x496fcc,_0x3f7c5b=document[_0x3fb22e(0xbb)](_0x3fb22e(0xf9));if(!_0x3f7c5b)return;try{const _0x4b9320=await _0x1c6807[_0x3fb22e(0x1c2)]();_0x3f7c5b[_0x3fb22e(0x16c)]='';if(Object[_0x3fb22e(0x86)](_0x4b9320)[_0x3fb22e(0x123)]===0x0){_0x3f7c5b[_0x3fb22e(0x16c)]=_0x3fb22e(0x168);return;}for(const [_0x39bea2,_0x439560]of Object[_0x3fb22e(0xf1)](_0x4b9320)){const _0x416784=document['createElement']('div');_0x416784[_0x3fb22e(0x190)]=_0x3fb22e(0xdd),_0x416784['dataset'][_0x3fb22e(0x16d)]=_0x39bea2;const _0x5c8872=await _0x1c6807[_0x3fb22e(0xf5)](_0x39bea2);_0x416784[_0x3fb22e(0x16c)]='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22hly-kb-name\x22\x20title=\x22ID:\x20'+_0x39bea2+'\x22>'+_0x439560[_0x3fb22e(0x16a)]+'\x20('+_0x5c8872+_0x3fb22e(0xc6)+(_0x439560[_0x3fb22e(0x79)]?_0x3fb22e(0x1d0):'')+'>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22hly-toggle-slider\x22></span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</label>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22hly-kb-delete-btn\x22\x20title=\x22删除此知识库\x22>&times;</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20',_0x3f7c5b[_0x3fb22e(0x154)](_0x416784);}_0x3f7c5b[_0x3fb22e(0x1d6)]('.hly-kb-toggle')[_0x3fb22e(0x17d)](_0x52d2f3=>{const _0x1332ed=_0x3fb22e;_0x52d2f3[_0x1332ed(0x20c)]('change',async _0x2f892b=>{const _0x634f2b=_0x1332ed,_0x472ba3=_0x2f892b['target'][_0x634f2b(0x137)]('.hly-kb-list-item')[_0x634f2b(0xc2)][_0x634f2b(0x16d)],_0x58b929=_0x2f892b[_0x634f2b(0x15b)][_0x634f2b(0x1d0)];await _0x1c6807[_0x634f2b(0x18f)](_0x472ba3,_0x58b929),log('知识库\x20'+_0x472ba3+'\x20已'+(_0x58b929?'启用':'禁用'),_0x634f2b(0x193)),updatePanelStatus();});}),_0x3f7c5b[_0x3fb22e(0x1d6)](_0x3fb22e(0x1de))[_0x3fb22e(0x17d)](_0xa5492f=>{const _0x331105=_0x3fb22e;_0xa5492f[_0x331105(0x20c)](_0x331105(0xe4),async _0x377f40=>{const _0x38ac20=_0x331105,_0x3bb933=_0x377f40['target'][_0x38ac20(0x137)]('.hly-kb-list-item'),_0xdd2a3=_0x3bb933[_0x38ac20(0xc2)][_0x38ac20(0x16d)],_0x94016f=_0x3bb933[_0x38ac20(0x18b)](_0x38ac20(0x1a2))['textContent'][_0x38ac20(0x125)]('\x20(')[0x0];if(confirm('您确定要永久删除知识库【'+_0x94016f+'】吗？此操作无法恢复！'))try{await _0x1c6807[_0x38ac20(0x114)](_0xdd2a3),log(_0x38ac20(0x176)+_0x94016f+_0x38ac20(0x106)+_0xdd2a3+')\x20已被删除',_0x38ac20(0x193)),toastr[_0x38ac20(0x193)](_0x38ac20(0x20b)+_0x94016f+_0x38ac20(0xed)),updatePanelStatus();}catch(_0x2c6119){log('删除知识库\x20'+_0x94016f+_0x38ac20(0x99)+_0x2c6119[_0x38ac20(0xad)],'error'),toastr[_0x38ac20(0x1d2)](_0x38ac20(0x14a)+_0x2c6119[_0x38ac20(0xad)]);}});});}catch(_0x5b466d){console['error'](_0x3fb22e(0x158),_0x5b466d),_0x3f7c5b[_0x3fb22e(0x16c)]=_0x3fb22e(0x138)+_0x5b466d[_0x3fb22e(0xad)]+_0x3fb22e(0x18a);}}function _0x1895(_0x5e26ad,_0x81b001){const _0x4acc95=_0x4acc();return _0x1895=function(_0x18959e,_0xf92508){_0x18959e=_0x18959e-0x66;let _0x13388d=_0x4acc95[_0x18959e];return _0x13388d;},_0x1895(_0x5e26ad,_0x81b001);}async function testApi(){const _0xc61978=_0x496fcc;toastr['info'](_0xc61978(0x9a),'圣旨');try{await _0x1c6807[_0xc61978(0x130)](),toastr['success'](_0xc61978(0x109),'圣意');}catch(_0x42ea1f){toastr[_0xc61978(0x1d2)](_0xc61978(0xa9)+_0x42ea1f[_0xc61978(0xad)],'警报');}}async function fetchHLYEmbeddingModels(){const _0x1033f2=_0x496fcc,_0x123e31=document[_0x1033f2(0xbb)](_0x1033f2(0x12a)),_0x2925d7=_0x123e31[_0x1033f2(0x14e)];_0x123e31[_0x1033f2(0x16c)]=_0x1033f2(0xb5),_0x123e31[_0x1033f2(0x113)]=!![];try{log(_0x1033f2(0xb1),'info');const _0x36f5b0=await _0x1c6807[_0x1033f2(0x13c)]();_0x123e31[_0x1033f2(0x16c)]='';if(_0x36f5b0[_0x1033f2(0x123)]===0x0){_0x123e31[_0x1033f2(0x16c)]='<option>未找到模型</option>',toastr[_0x1033f2(0x93)]('未能获取到任何模型。','翰林院启奏'),log('未能获取到任何模型。','warn');return;}_0x36f5b0[_0x1033f2(0x17d)](_0x108aa2=>{const _0x4e07f4=_0x1033f2,_0x19fb4d=new Option(_0x108aa2,_0x108aa2);_0x123e31[_0x4e07f4(0x1b3)](_0x19fb4d);}),_0x36f5b0[_0x1033f2(0x1e9)](_0x2925d7)?_0x123e31[_0x1033f2(0x14e)]=_0x2925d7:_0x123e31[_0x1033f2(0x17a)]=0x0,toastr['success'](_0x1033f2(0x19c)+_0x36f5b0['length']+_0x1033f2(0xe1),'圣意'),log(_0x1033f2(0x19c)+_0x36f5b0['length']+_0x1033f2(0xe1),_0x1033f2(0x193));}catch(_0x41a75c){console[_0x1033f2(0x1d2)]('[翰林院-枢纽]\x20获取模型列表失败:',_0x41a75c),toastr[_0x1033f2(0x1d2)]('获取模型失败:\x20'+_0x41a75c[_0x1033f2(0xad)],_0x1033f2(0x15c)),log(_0x1033f2(0x166)+_0x41a75c[_0x1033f2(0xad)],_0x1033f2(0x1d2)),_0x123e31[_0x1033f2(0x16c)]='<option>获取失败</option>';}finally{_0x123e31['disabled']=![];}}async function fetchHLYRerankModels(){const _0x405466=_0x496fcc,_0x266410=document[_0x405466(0xbb)](_0x405466(0x108)),_0x5000e7=_0x266410['value'];_0x266410['innerHTML']=_0x405466(0xb5),_0x266410[_0x405466(0x113)]=!![];try{log(_0x405466(0x148),'info');const _0xefb9ac=await _0x1c6807[_0x405466(0x88)]();_0x266410[_0x405466(0x16c)]='';if(_0xefb9ac[_0x405466(0x123)]===0x0){_0x266410[_0x405466(0x16c)]=_0x405466(0x175),toastr[_0x405466(0x93)](_0x405466(0x84),_0x405466(0xb7)),log(_0x405466(0x84),_0x405466(0x93));return;}_0xefb9ac['forEach'](_0x366ffb=>{const _0x47255d=_0x405466,_0x50f122=new Option(_0x366ffb,_0x366ffb);_0x266410[_0x47255d(0x1b3)](_0x50f122);}),_0xefb9ac[_0x405466(0x1e9)](_0x5000e7)?_0x266410[_0x405466(0x14e)]=_0x5000e7:_0x266410['selectedIndex']=0x0,toastr[_0x405466(0x193)](_0x405466(0x19c)+_0xefb9ac['length']+_0x405466(0x69),'圣意'),log('成功获取\x20'+_0xefb9ac[_0x405466(0x123)]+_0x405466(0x69),_0x405466(0x193));}catch(_0x42cf32){console[_0x405466(0x1d2)](_0x405466(0x188),_0x42cf32),toastr[_0x405466(0x1d2)](_0x405466(0x181)+_0x42cf32[_0x405466(0xad)],_0x405466(0x15c)),log('获取Rerank模型失败:\x20'+_0x42cf32['message'],_0x405466(0x1d2)),_0x266410['innerHTML']=_0x405466(0xdf);}finally{_0x266410[_0x405466(0x113)]=![];}}async function purgeStorage(){const _0x5ea41a=_0x496fcc;if(confirm(_0x5ea41a(0x1b0))){toastr[_0x5ea41a(0x1dd)]('正在清空宝库...','圣旨');const _0x57b75d=await _0x1c6807[_0x5ea41a(0xa5)]();_0x57b75d?toastr[_0x5ea41a(0x193)](_0x5ea41a(0x77),'圣意'):toastr[_0x5ea41a(0x1d2)]('清空宝库失败。','警报'),await updatePanelStatus();}}async function startCondensation(){const _0x272c14=_0x496fcc,_0x343e30=document['getElementById']('hly-condensation-results'),_0xb530d0=_0x343e30['dataset']['finalMessages'],_0x3f29ed=document['getElementById'](_0x272c14(0xef))[_0x272c14(0x14e)],_0x80aae4=document[_0x272c14(0xbb)](_0x272c14(0x1a3))[_0x272c14(0x14e)],_0x28830b={'start':parseInt(_0x3f29ed),'end':parseInt(_0x80aae4)};try{let _0x390e36;_0xb530d0?(log('检测到预览后待处理的消息对象，开始精确凝识...',_0x272c14(0x1dd)),toastr[_0x272c14(0x1dd)]('正在处理您确认后的文书...','圣旨'),_0x390e36=JSON[_0x272c14(0x1f6)](_0xb530d0),delete _0x343e30[_0x272c14(0xc2)][_0x272c14(0x101)]):(log(_0x272c14(0x100),'info'),toastr[_0x272c14(0x1dd)](_0x272c14(0x6a),'圣旨'),_0x390e36=_0x1c6807['getMessagesForCondensation']());if(!_0x390e36||_0x390e36['length']===0x0){toastr[_0x272c14(0xd3)](_0x272c14(0xd7),_0x272c14(0xb7)),_0x343e30[_0x272c14(0x10f)]=_0x272c14(0x183);return;}_0x343e30[_0x272c14(0x10f)]=_0x272c14(0x94)+_0x390e36['length']+'\x20条消息，开始凝识...',toastr[_0x272c14(0x1dd)](_0x272c14(0x94)+_0x390e36['length']+_0x272c14(0x14d),_0x272c14(0xb7));const _0x55fed7=await _0x1c6807['processCondensation'](_0x390e36,log,_0x28830b);if(_0x55fed7[_0x272c14(0x193)]){toastr['success'](_0x272c14(0x10b)+_0x55fed7[_0x272c14(0x1cf)]+_0x272c14(0x1b7),_0x272c14(0x17b));const _0x51c0c5=_0x28830b[_0x272c14(0x187)]===0x0?getContext()[_0x272c14(0x1f9)][_0x272c14(0x123)]:_0x28830b[_0x272c14(0x187)];_0x343e30[_0x272c14(0x10f)]=_0x272c14(0x1cd)+_0x28830b['start']+_0x272c14(0xc1)+_0x51c0c5+'\x20楼已成功凝识，新增\x20'+_0x55fed7[_0x272c14(0x1cf)]+_0x272c14(0x1b7);}else throw new Error(_0x55fed7[_0x272c14(0x1d2)]||_0x272c14(0xd6));}catch(_0x1e0464){console['error']('[翰林院-枢纽]\x20凝识过程发生错误:',_0x1e0464),toastr[_0x272c14(0x1d2)](_0x272c14(0xfd)+_0x1e0464[_0x272c14(0xad)],'严重错误'),_0x343e30[_0x272c14(0x10f)]=_0x272c14(0xfd)+_0x1e0464[_0x272c14(0xad)];}finally{await updatePanelStatus();}}async function loadWorldbookList(){const _0x40ec67=_0x496fcc,_0x53559d=document[_0x40ec67(0xbb)]('hly-hist-select-library');if(!_0x53559d)return;try{log(_0x40ec67(0x75),'info');const _0x42a7da=await _0xed18ca[_0x40ec67(0x1fa)]();_0x53559d[_0x40ec67(0x16c)]=_0x40ec67(0x1b8);if(_0x42a7da['length']===0x0){_0x53559d[_0x40ec67(0x16c)]='<option\x20value=\x22\x22>未找到任何书库</option>';return;}_0x42a7da['forEach'](_0x7df2c0=>{const _0x48739e=_0x40ec67,_0x565fa9=new Option(_0x7df2c0,_0x7df2c0);_0x53559d[_0x48739e(0x1b3)](_0x565fa9);}),log(_0x40ec67(0x1d9)+_0x42a7da[_0x40ec67(0x123)]+_0x40ec67(0xf8),_0x40ec67(0x193));}catch(_0x5927ee){console[_0x40ec67(0x1d2)]('[翰林院-枢纽]\x20加载书库列表失败:',_0x5927ee),log(_0x40ec67(0x150)+_0x5927ee[_0x40ec67(0xad)],_0x40ec67(0x1d2)),_0x53559d[_0x40ec67(0x16c)]='<option\x20value=\x22\x22>加载失败</option>';}}async function handleWorldbookSelectionChange(){const _0x339087=_0x496fcc,_0x1addfa=document[_0x339087(0xbb)](_0x339087(0x1ae)),_0x42ab5a=document[_0x339087(0xbb)](_0x339087(0x1b2)),_0x413ba4=document[_0x339087(0xbb)](_0x339087(0x205)),_0x415fe4=_0x1addfa[_0x339087(0x14e)];_0x42ab5a[_0x339087(0x113)]=!![],_0x42ab5a[_0x339087(0x18b)](_0x339087(0x200))[_0x339087(0x10f)]=_0x339087(0xfe),_0x413ba4[_0x339087(0x16c)]='',_0x413ba4[_0x339087(0xd0)][_0x339087(0x1d1)]='none';if(!_0x415fe4){_0x42ab5a[_0x339087(0x18b)](_0x339087(0x200))['textContent']=_0x339087(0xae);return;}try{log(_0x339087(0xb0)+_0x415fe4+'》获取条目列表...',_0x339087(0x1dd));const _0x138a44=await _0xed18ca[_0x339087(0x81)](_0x415fe4);if(_0x138a44[_0x339087(0x123)]===0x0){_0x42ab5a[_0x339087(0x18b)](_0x339087(0x200))['textContent']=_0x339087(0xa2);return;}const _0x38d7af=_0x339087(0x194);_0x413ba4[_0x339087(0xd8)](_0x339087(0x143),_0x38d7af),_0x138a44[_0x339087(0x17d)](_0x417c97=>{const _0x195fae=_0x339087,_0xc0a73=_0x195fae(0x1a7)+_0x417c97['comment']+_0x195fae(0xe0)+_0x417c97[_0x195fae(0x1d8)]+_0x195fae(0xe8)+_0x417c97[_0x195fae(0x1d8)]+'\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span>'+_0x417c97[_0x195fae(0x87)]+'</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</label>';_0x413ba4[_0x195fae(0xd8)](_0x195fae(0x143),_0xc0a73);}),log('成功加载\x20'+_0x138a44['length']+_0x339087(0xab),_0x339087(0x193)),_0x42ab5a[_0x339087(0x18b)]('span')['textContent']='已选择\x200\x20/\x20'+_0x138a44[_0x339087(0x123)]+_0x339087(0x1eb);}catch(_0x3a8618){console[_0x339087(0x1d2)](_0x339087(0x76)+_0x415fe4+_0x339087(0x8d),_0x3a8618),log(_0x339087(0x71)+_0x3a8618['message'],_0x339087(0x1d2)),_0x42ab5a[_0x339087(0x18b)](_0x339087(0x200))[_0x339087(0x10f)]=_0x339087(0x191);}finally{_0x42ab5a['disabled']=![];}}async function startHistoriography(){const _0x1baf1c=_0x496fcc,_0x1eb222=document['getElementById'](_0x1baf1c(0x1ae))[_0x1baf1c(0x14e)],_0x21936a=document[_0x1baf1c(0xbb)](_0x1baf1c(0x205)),_0x3f6d48=document[_0x1baf1c(0xbb)](_0x1baf1c(0x163)),_0xa9b2c7=Array[_0x1baf1c(0xfa)](_0x21936a[_0x1baf1c(0x1d6)](_0x1baf1c(0x68)))['map'](_0x355364=>_0x355364['value']);if(!_0x1eb222||_0xa9b2c7[_0x1baf1c(0x123)]===0x0){toastr[_0x1baf1c(0xd3)](_0x1baf1c(0x95),'圣谕不明');return;}_0x3f6d48[_0x1baf1c(0x10f)]=_0x1baf1c(0xe7)+_0x1eb222+_0x1baf1c(0x1e6)+_0xa9b2c7[_0x1baf1c(0x123)]+_0x1baf1c(0xe3),toastr[_0x1baf1c(0x1dd)]('批量编纂任务已开始...','圣旨'),log(_0x1baf1c(0x110)+_0x1eb222+'》中的\x20'+_0xa9b2c7['length']+_0x1baf1c(0x146),'info');try{const _0xc4bd45=await _0xed18ca[_0x1baf1c(0xb8)](_0x1eb222,_0xa9b2c7);_0x3f6d48[_0x1baf1c(0x10f)]=_0xc4bd45[_0x1baf1c(0x1ce)],_0xc4bd45['success']?toastr[_0x1baf1c(0x193)]('批量编纂任务已完成。',_0x1baf1c(0x17b)):toastr['warning'](_0x1baf1c(0x11e),'圣谕'),log('对《'+_0x1eb222+_0x1baf1c(0x136)+_0xc4bd45[_0x1baf1c(0x135)]+',\x20向量:\x20'+_0xc4bd45[_0x1baf1c(0x159)],'success');}catch(_0x161e7d){console[_0x1baf1c(0x1d2)](_0x1baf1c(0x1ac),_0x161e7d),toastr[_0x1baf1c(0x1d2)](_0x1baf1c(0xa3)+_0x161e7d[_0x1baf1c(0xad)],_0x1baf1c(0x15c)),_0x3f6d48[_0x1baf1c(0x10f)]=_0x1baf1c(0xa3)+_0x161e7d[_0x1baf1c(0xad)];}finally{await updatePanelStatus();}}async function showStats(){const _0x16d98d=_0x496fcc;try{log(_0x16d98d(0x151),_0x16d98d(0x1dd)),toastr[_0x16d98d(0x1dd)](_0x16d98d(0x164),'圣旨');const _0x435a18=await _0x1c6807[_0x16d98d(0xf5)](),_0x2a8733=await _0x1c6807[_0x16d98d(0x160)](),_0x10cabe=_0x1c6807['getSettings'](),_0x5ef0d9='\x0a<pre>\x0a翰林院宝库状态\x0a--------------------\x0a集合ID:\x20'+_0x2a8733+_0x16d98d(0x124)+_0x435a18+_0x16d98d(0x96)+_0x10cabe[_0x16d98d(0x1ad)]['apiEndpoint']+'\x0a所用模型:\x20'+_0x10cabe[_0x16d98d(0x1ad)][_0x16d98d(0x206)]+'\x0a</pre>\x0a\x20\x20\x20\x20\x20\x20\x20\x20';toastr[_0x16d98d(0x1dd)](_0x5ef0d9,'宝库状态',{'timeOut':0x3a98,'extendedTimeOut':0x1388,'tapToDismiss':!![],'closeButton':!![]}),log(_0x16d98d(0x134)+_0x2a8733+_0x16d98d(0x208)+_0x435a18,'success');}catch(_0x2a8dea){console[_0x16d98d(0x1d2)](_0x16d98d(0x1f4),_0x2a8dea),toastr[_0x16d98d(0x1d2)](_0x16d98d(0x1f3)+_0x2a8dea[_0x16d98d(0xad)],_0x16d98d(0x15c)),log(_0x16d98d(0x1f3)+_0x2a8dea[_0x16d98d(0xad)],_0x16d98d(0x1d2));}}function showExclusionRulesModal(){const _0x23f664=_0x496fcc,_0x40e90b=_0x1c6807[_0x23f664(0x7c)](),_0x413d83=_0x40e90b['condensation'][_0x23f664(0xca)]||[],_0x484ba2=(_0x1219ce={'start':'','end':''},_0x5067ce)=>_0x23f664(0x8b)+_0x5067ce+'\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20class=\x22hly-imperial-brush\x22\x20value=\x22'+_0x1219ce[_0x23f664(0x1e0)]+_0x23f664(0x1dc)+_0x1219ce[_0x23f664(0x187)]+_0x23f664(0xcb),_0xb4798d=_0x413d83['map'](_0x484ba2)[_0x23f664(0x98)](''),_0x30f160=_0x23f664(0x1ee)+_0xb4798d+'</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20id=\x22hly-add-rule-btn\x22\x20class=\x22hly-action-button\x22\x20style=\x22margin-top:\x2010px;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<i\x20class=\x22fas\x20fa-plus\x22></i>\x20添加新规则\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.hly-exclusion-rule-row\x20{\x20display:\x20flex;\x20align-items:\x20center;\x20gap:\x2010px;\x20margin-bottom:\x2010px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.hly-exclusion-rule-row\x20input\x20{\x20flex-grow:\x201;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.hly-delete-rule-btn\x20{\x20background:\x20#c0392b;\x20color:\x20white;\x20border:\x20none;\x20border-radius:\x2050%;\x20width:\x2024px;\x20height:\x2024px;\x20cursor:\x20pointer;\x20font-size:\x2016px;\x20line-height:\x2024px;\x20text-align:\x20center;\x20padding:\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20</style>\x0a\x20\x20\x20\x20';showHtmlModal(_0x23f664(0xaa),_0x30f160,{'okText':_0x23f664(0xcc),'onOk':_0x3fe479=>{const _0x109bd6=_0x23f664,_0x10efd7=[];_0x3fe479[_0x109bd6(0x145)](_0x109bd6(0xee))[_0x109bd6(0x1fd)](function(){const _0x35b4d6=_0x109bd6,_0x5cd7c8=$(this)[_0x35b4d6(0x145)](_0x35b4d6(0x11c))['eq'](0x0)[_0x35b4d6(0x121)]()[_0x35b4d6(0x83)](),_0x1d0347=$(this)[_0x35b4d6(0x145)]('input')['eq'](0x1)[_0x35b4d6(0x121)]()[_0x35b4d6(0x83)]();_0x5cd7c8&&_0x1d0347&&_0x10efd7[_0x35b4d6(0x1fe)]({'start':_0x5cd7c8,'end':_0x1d0347});}),updateAndSaveSetting(_0x109bd6(0x1d4),_0x10efd7),toastr[_0x109bd6(0x193)](_0x109bd6(0xaf),'圣旨已达');}});const _0x43efaa=document['getElementById'](_0x23f664(0x1c6)),_0x211358=_0x43efaa[_0x23f664(0x18b)](_0x23f664(0x20e));_0x43efaa['querySelector'](_0x23f664(0x90))[_0x23f664(0x20c)]('click',()=>{const _0xf648d7=_0x23f664,_0x597753=_0x211358[_0xf648d7(0x120)][_0xf648d7(0x123)],_0x47644f=_0x484ba2({'start':'','end':''},_0x597753);_0x211358[_0xf648d7(0xd8)](_0xf648d7(0x143),_0x47644f);}),_0x211358[_0x23f664(0x20c)](_0x23f664(0xe4),_0x47b31b=>{const _0x1e6f9f=_0x23f664;_0x47b31b['target'][_0x1e6f9f(0x201)][_0x1e6f9f(0x204)](_0x1e6f9f(0x1a0))&&_0x47b31b[_0x1e6f9f(0x15b)][_0x1e6f9f(0x137)](_0x1e6f9f(0xee))['remove']();});}function previewCondensation(){const _0x2497d0=_0x496fcc,_0x4f3f50=document['getElementById'](_0x2497d0(0x91));try{const _0x404b3c=_0x1c6807[_0x2497d0(0x7c)](),_0x4e699b=_0x404b3c[_0x2497d0(0xa1)][_0x2497d0(0xca)]||[],_0x3030aa={'user':document[_0x2497d0(0xbb)]('hly-include-user')[_0x2497d0(0x1d0)],'ai':document[_0x2497d0(0xbb)](_0x2497d0(0x1c3))[_0x2497d0(0x1d0)]},_0x44e970=document[_0x2497d0(0xbb)]('hly-tag-extraction-toggle')[_0x2497d0(0x1d0)],_0x3815ef=_0x44e970?document[_0x2497d0(0xbb)](_0x2497d0(0xc3))[_0x2497d0(0x14e)][_0x2497d0(0x125)](',')[_0x2497d0(0x169)](_0x49eb01=>_0x49eb01[_0x2497d0(0x83)]())[_0x2497d0(0x8f)](Boolean):[],_0x176d71=_0x1c6807[_0x2497d0(0xec)](_0x3030aa);if(!_0x176d71||_0x176d71[_0x2497d0(0x123)]===0x0){_0x4f3f50[_0x2497d0(0x10f)]='根据当前勾选条件，未找到符合的消息可供预览。',toastr[_0x2497d0(0xd3)](_0x2497d0(0x183),'翰林院启奏');return;}const _0x1da7bd=getContext()[_0x2497d0(0x1f9)],_0x9e50e=_0x176d71[_0x2497d0(0x169)]((_0xc7f01c,_0x2e8556)=>{const _0xf328b4=_0x2497d0;let _0x5e2f26;if(_0xc7f01c[_0xf328b4(0x202)])_0x5e2f26=_0xc7f01c[_0xf328b4(0x67)];else{if(_0x44e970&&_0x3815ef[_0xf328b4(0x123)]>0x0){const _0x5e8a03=extractBlocksByTags(_0xc7f01c['mes'],_0x3815ef);_0x5e2f26=_0x5e8a03[_0xf328b4(0x98)]('\x0a\x0a');}else _0x5e2f26=_0xc7f01c['mes'];_0x5e2f26=applyExclusionRules(_0x5e2f26,_0x4e699b);}const _0x21889c=_0x1da7bd[_0xf328b4(0x1db)](_0xf05185=>_0xf05185===_0xc7f01c),_0x11d057=_0x21889c!==-0x1?_0x21889c+0x1:-0x1;return{'id':_0xf328b4(0x133)+_0x2e8556,'name':_0xc7f01c[_0xf328b4(0x16a)],'content':_0x5e2f26[_0xf328b4(0x83)](),'floor':_0x11d057,'is_user':_0xc7f01c[_0xf328b4(0x202)],'send_date':_0xc7f01c[_0xf328b4(0x1ca)]};})[_0x2497d0(0x8f)](_0x317bf1=>_0x317bf1[_0x2497d0(0x1ce)]);if(_0x9e50e[_0x2497d0(0x123)]===0x0){_0x4f3f50[_0x2497d0(0x10f)]=_0x2497d0(0x1da),toastr[_0x2497d0(0xd3)](_0x2497d0(0x1da),_0x2497d0(0xb7));return;}const _0x403b5f=_0x9e50e[_0x2497d0(0x169)]((_0x1d4087,_0x443057)=>_0x2497d0(0x13e)+_0x1d4087['id']+_0x2497d0(0xfb)+_0x1d4087[_0x2497d0(0xb4)]+_0x2497d0(0xb6)+_0x1d4087['name']+']\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</summary>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-preview-content\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<textarea\x20class=\x22hly-preview-textarea\x22\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20data-floor=\x22'+_0x1d4087[_0x2497d0(0xb4)]+_0x2497d0(0x92)+_0x1d4087[_0x2497d0(0x202)]+_0x2497d0(0x180)+_0x1d4087['send_date']+'\x22>'+_0x1d4087[_0x2497d0(0x1ce)]+_0x2497d0(0x177)+_0x1d4087['id']+'\x22\x20title=\x22删除此条\x22>&times;</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20')[_0x2497d0(0x98)]('');showHtmlModal(_0x2497d0(0x157),_0x2497d0(0x1bf)+_0x403b5f+_0x2497d0(0x1ff),{'okText':'确认并更新预览','onOk':_0x55b24a=>{const _0x5562ef=_0x2497d0,_0x2d1885=[];_0x55b24a[_0x5562ef(0x145)](_0x5562ef(0x1a6))['each'](function(){const _0x460fbb=_0x5562ef,_0x203110=$(this)[_0x460fbb(0x145)](_0x460fbb(0xf4)),_0x205e1e=_0x203110[_0x460fbb(0x121)]();_0x205e1e['trim']()&&_0x2d1885['push']({'mes':_0x205e1e,'is_user':_0x203110['data'](_0x460fbb(0x12e)),'send_date':_0x203110[_0x460fbb(0x119)](_0x460fbb(0x7b)),'floor':_0x203110[_0x460fbb(0x119)](_0x460fbb(0xb4))});}),_0x4f3f50[_0x5562ef(0xc2)]['finalMessages']=JSON[_0x5562ef(0x172)](_0x2d1885);const _0x43696f=document[_0x5562ef(0xbb)](_0x5562ef(0xef))[_0x5562ef(0x14e)],_0x3c5de3=document[_0x5562ef(0xbb)]('hly-layer-end')[_0x5562ef(0x14e)];_0x4f3f50[_0x5562ef(0x10f)]=_0x5562ef(0x131)+_0x43696f+_0x5562ef(0xa4)+_0x3c5de3+'\x20楼的内容（共\x20'+_0x2d1885['length']+'\x20条有效条目），请点击“开始凝识”进入自动向量化流程。',toastr[_0x5562ef(0x193)]('预览内容已更新，可随时开始凝识。',_0x5562ef(0x80));}}),$('.hly-preview-delete-btn-v2')['on']('click',function(_0x38daaa){const _0x359506=_0x2497d0;_0x38daaa[_0x359506(0x1c4)]();const _0x403c2c=$(this)['data'](_0x359506(0x15b));$('#'+_0x403c2c)[_0x359506(0x1be)]();});}catch(_0x4c7b72){console['error'](_0x2497d0(0x17e),_0x4c7b72),_0x4f3f50['textContent']=_0x2497d0(0xbe)+_0x4c7b72['message'],toastr['error'](_0x2497d0(0xbe)+_0x4c7b72['message'],_0x2497d0(0x15c));}}function log(_0x4d1c1c,_0x2005ae=_0x496fcc(0x1dd)){const _0x43d4c9=_0x496fcc,_0x5846ac=document['getElementById'](_0x43d4c9(0x186));if(!_0x5846ac)return;const _0x5e21cf=document[_0x43d4c9(0xfc)]('p'),_0x385995=new Date()[_0x43d4c9(0x162)]();let _0x218ee6='fa-circle-info',_0x5cbd25=_0x43d4c9(0x129);switch(_0x2005ae){case _0x43d4c9(0x193):_0x218ee6=_0x43d4c9(0xff),_0x5cbd25=_0x43d4c9(0x198);break;case _0x43d4c9(0x1d2):_0x218ee6=_0x43d4c9(0x1d5),_0x5cbd25=_0x43d4c9(0x1b6);break;case _0x43d4c9(0x93):_0x218ee6=_0x43d4c9(0xd1),_0x5cbd25=_0x43d4c9(0x9c);break;}_0x5e21cf[_0x43d4c9(0x190)]=_0x43d4c9(0x115)+_0x5cbd25,_0x5e21cf[_0x43d4c9(0x16c)]=_0x43d4c9(0xbf)+_0x218ee6+_0x43d4c9(0x153)+_0x385995+']\x20'+_0x4d1c1c;const _0x77e88=_0x5846ac['querySelector'](_0x43d4c9(0x142));_0x77e88&&_0x77e88[_0x43d4c9(0x1be)](),_0x5846ac[_0x43d4c9(0x154)](_0x5e21cf),_0x5846ac['scrollTop']=_0x5846ac[_0x43d4c9(0x165)];}async function ingestManualText(){const _0x22d33b=_0x496fcc,_0x200fba=document[_0x22d33b(0xbb)](_0x22d33b(0x1c7)),_0x3e691e=_0x200fba[_0x22d33b(0x14e)][_0x22d33b(0x83)]();if(!_0x3e691e){toastr[_0x22d33b(0xd3)](_0x22d33b(0x19a),_0x22d33b(0xb7)),log('用户尝试录入空文本。',_0x22d33b(0x93));return;}log('收到手动录入请求，文本长度:\x20'+_0x3e691e['length'],_0x22d33b(0x1dd)),toastr[_0x22d33b(0x1dd)]('正在处理您提交的文书...','圣旨');try{const _0x57ab16=await _0x1c6807['ingestTextToHanlinyuan'](_0x3e691e,'manual',{'sourceName':'手动录入'});if(_0x57ab16[_0x22d33b(0x193)])toastr[_0x22d33b(0x193)](_0x22d33b(0x15a)+_0x57ab16['count']+_0x22d33b(0x1b7),_0x22d33b(0x17b)),log(_0x22d33b(0x1df)+_0x57ab16[_0x22d33b(0x1cf)]+_0x22d33b(0x1b7),_0x22d33b(0x193)),_0x200fba[_0x22d33b(0x14e)]='';else throw new Error(_0x57ab16[_0x22d33b(0x1d2)]||'未知错误');}catch(_0x46442e){console[_0x22d33b(0x1d2)](_0x22d33b(0x139),_0x46442e),toastr[_0x22d33b(0x1d2)](_0x22d33b(0xce)+_0x46442e[_0x22d33b(0xad)],'严重错误'),log(_0x22d33b(0x89)+_0x46442e[_0x22d33b(0xad)],'error');}finally{await updatePanelStatus();}}
