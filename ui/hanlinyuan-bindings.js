const _0x2eed1f=_0x91bf;(function(_0x53e8fb,_0x57de97){const _0x4490c1=_0x91bf,_0x4c5056=_0x53e8fb();while(!![]){try{const _0x57bc76=parseInt(_0x4490c1(0x159))/0x1*(-parseInt(_0x4490c1(0x269))/0x2)+-parseInt(_0x4490c1(0x92))/0x3*(parseInt(_0x4490c1(0x1dd))/0x4)+parseInt(_0x4490c1(0x1c8))/0x5*(parseInt(_0x4490c1(0x247))/0x6)+parseInt(_0x4490c1(0x7e))/0x7+-parseInt(_0x4490c1(0x195))/0x8+-parseInt(_0x4490c1(0x26d))/0x9+-parseInt(_0x4490c1(0x25b))/0xa*(-parseInt(_0x4490c1(0x1a5))/0xb);if(_0x57bc76===_0x57de97)break;else _0x4c5056['push'](_0x4c5056['shift']());}catch(_0x2fc4d8){_0x4c5056['push'](_0x4c5056['shift']());}}}(_0x21f4,0x43cce));import{getContext}from'/scripts/extensions.js';import*as _0x222c37 from'../core/rag-processor.js';import*as _0x9d7bfc from'../core/historiographer.js';import*as _0x27cc29 from'../core/utils/context-utils.js';import*as _0x263e19 from'../core/ingestion-manager.js';import{showContentModal,showHtmlModal}from'./page-window.js';import{extractBlocksByTags,applyExclusionRules}from'../core/utils/rag-tag-extractor.js';import{filterWorldbooks,filterWorldbookEntries,highlightSearchMatch,debounce}from'../core/rag-processor.js';_0x2eed1f(0x17c);function setupGlobalEventHandlers(){const _0xdb1182=_0x2eed1f;window[_0xdb1182(0x104)]=()=>saveSettingsFromUI(![]),window[_0xdb1182(0x134)]=resetSettingsToUI,window[_0xdb1182(0x170)]=testApi,window[_0xdb1182(0x1f0)]=fetchHLYEmbeddingModels,window[_0xdb1182(0x8c)]=fetchHLYRerankModels,window[_0xdb1182(0x265)]=updatePanelStatus,window[_0xdb1182(0x20c)]=purgeStorage,window[_0xdb1182(0x112)]=startCondensation,window[_0xdb1182(0x194)]=previewCondensation,window[_0xdb1182(0x21a)]=ingestManualText,window[_0xdb1182(0x167)]=log,window[_0xdb1182(0x215)]=showStats,window[_0xdb1182(0x73)]=startHistoriography;}function updateAndSaveSetting(_0x1b367c,_0x16e83b){const _0x56f7ba=_0x2eed1f,_0x8e6d43=_0x222c37[_0x56f7ba(0x1f9)]();if(!_0x8e6d43)return;const _0x37d1ec=_0x1b367c[_0x56f7ba(0x7a)]('.');let _0x3f98cb=_0x8e6d43;for(let _0x3d87c3=0x0;_0x3d87c3<_0x37d1ec[_0x56f7ba(0x1a7)]-0x1;_0x3d87c3++){_0x3f98cb=_0x3f98cb[_0x37d1ec[_0x3d87c3]]=_0x3f98cb[_0x37d1ec[_0x3d87c3]]||{};}_0x3f98cb[_0x37d1ec[_0x37d1ec[_0x56f7ba(0x1a7)]-0x1]]=_0x16e83b,_0x222c37[_0x56f7ba(0x70)](),log(_0x56f7ba(0x225)+_0x1b367c+_0x56f7ba(0x126)+JSON[_0x56f7ba(0xbf)](_0x16e83b),_0x56f7ba(0x249));}function bindAutoSaveEvents(){const _0xcd32c3=_0x2eed1f,_0x49958a=document[_0xcd32c3(0x242)](_0xcd32c3(0x6b));if(!_0x49958a)return;_0x49958a['addEventListener'](_0xcd32c3(0x1ee),_0x32ed26=>{const _0x3f063c=_0xcd32c3,_0x8b449e=_0x32ed26[_0x3f063c(0x18a)],_0x3e4857=_0x8b449e[_0x3f063c(0x13c)]['settingKey'];if(!_0x3e4857)return;let _0x539310;const _0x103817=_0x8b449e[_0x3f063c(0x13c)][_0x3f063c(0x87)]||_0x3f063c(0xf1);if(_0x8b449e[_0x3f063c(0x87)]==='checkbox')_0x539310=_0x8b449e[_0x3f063c(0x13e)];else{if(_0x8b449e[_0x3f063c(0x87)]===_0x3f063c(0x11b)){if(_0x8b449e[_0x3f063c(0x13e)]){const _0x35e330=_0x49958a[_0x3f063c(0x25d)](_0x3f063c(0xe8)+_0x8b449e['name']+'\x22]'),_0x4b1902=Array[_0x3f063c(0xc0)](_0x35e330)['find'](_0x24de98=>_0x24de98['checked']);_0x539310=_0x4b1902[_0x3f063c(0x15e)];}else return;}else _0x539310=_0x8b449e['value'];}switch(_0x103817){case _0x3f063c(0x132):_0x539310=parseInt(_0x539310,0xa);break;case _0x3f063c(0x19d):_0x539310=parseFloat(_0x539310);break;case _0x3f063c(0x21f):typeof _0x539310!==_0x3f063c(0x21f)&&(_0x539310=_0x539310===_0x3f063c(0x163));break;}if(_0x8b449e[_0x3f063c(0x87)]===_0x3f063c(0x11b)&&!_0x8b449e[_0x3f063c(0x13e)])return;updateAndSaveSetting(_0x3e4857,_0x539310);});}export function bindHanlinyuanEvents(){const _0x59a90f=_0x2eed1f,_0x32ca7a=getContext();if(!_0x32ca7a){console[_0x59a90f(0xf4)]('[翰林院-枢纽]\x20未能获取SillyTavern上下文，绑定失败。');return;}setupGlobalEventHandlers(),bindPanelToggleEvents(),bindInternalUIEvents(),bindTutorialEvents(),bindAutoSaveEvents(),bindSessionLockEvent(),initializeUnifiedInjectionEditor();if(_0x222c37['initialize'])_0x222c37[_0x59a90f(0x1c9)]();else{console[_0x59a90f(0xf4)](_0x59a90f(0x16a));return;}loadSettingsToUI(),loadWorldbookList(),log(_0x59a90f(0x17a),_0x59a90f(0x1a4));const _0x2a2d9d=document['getElementById'](_0x59a90f(0x1e6)),_0x4bffe6=document[_0x59a90f(0x242)]('hanlinyuan-ingest-novel-file-name'),_0x550855=document[_0x59a90f(0x242)]('hanlinyuan-ingest-novel-start'),_0x1610ac=document[_0x59a90f(0x242)](_0x59a90f(0xa4)),_0xb0e167=document[_0x59a90f(0x242)]('hanlinyuan-ingest-progress-container'),_0x30f0bb=document['getElementById'](_0x59a90f(0x7d)),_0x9136d7=document[_0x59a90f(0x242)]('hanlinyuan-ingest-status'),_0x1adcca=document[_0x59a90f(0x242)](_0x59a90f(0x106));let _0x1340b0=null,_0x16b666=null;_0x2a2d9d[_0x59a90f(0x1cd)](_0x59a90f(0x1ee),_0x488348=>{const _0x2e9fa2=_0x59a90f;_0x1340b0=_0x488348['target'][_0x2e9fa2(0x260)][0x0],_0x1340b0?(_0x4bffe6[_0x2e9fa2(0x153)]=_0x1340b0[_0x2e9fa2(0x113)],_0x4bffe6['title']=_0x1340b0[_0x2e9fa2(0x113)]):_0x4bffe6[_0x2e9fa2(0x153)]=_0x2e9fa2(0x89);}),_0x550855[_0x59a90f(0x1cd)]('click',async()=>{const _0x36f58a=_0x59a90f;if(!_0x1340b0){toastr[_0x36f58a(0x17d)]('请先选择一个\x20.txt\x20文件');return;}let _0x43a77b=0x0;const _0x154e1e=_0x263e19[_0x36f58a(0x173)](_0x1340b0),_0xf8ff23=_0x263e19[_0x36f58a(0x1d0)](_0x154e1e);if(_0xf8ff23){const _0x31fabe=(_0xf8ff23['processedChunks']/_0xf8ff23[_0x36f58a(0x22f)]*0x64)['toFixed'](0x1),_0x40b90f=confirm('启禀大人，发现此书上次录入已完成\x20'+_0x31fabe+_0x36f58a(0x14e));_0x40b90f?(_0x43a77b=_0xf8ff23[_0x36f58a(0x10b)],toastr['info'](_0x36f58a(0x145)+(_0x43a77b+0x1)+'\x20块继续录入。',_0x36f58a(0x23f)),log(_0x36f58a(0xe5)+_0x154e1e+_0x36f58a(0xa8)+_0x43a77b+_0x36f58a(0x230),_0x36f58a(0x1a4))):(_0x263e19[_0x36f58a(0xc1)](_0x154e1e),toastr[_0x36f58a(0x1a4)](_0x36f58a(0x216),_0x36f58a(0x23f)),log('[断点续传]\x20用户选择放弃旧任务\x20'+_0x154e1e+_0x36f58a(0x9e),_0x36f58a(0x205)));}_0x16b666=new AbortController();const _0x5f4fee=_0x16b666['signal'];_0x1adcca[_0x36f58a(0x191)][_0x36f58a(0x1e1)]=_0x36f58a(0xc7),_0xb0e167[_0x36f58a(0x191)]['display']=_0x36f58a(0x1a1),_0x9136d7['textContent']=_0x36f58a(0x12e),_0x30f0bb[_0x36f58a(0x15e)]=0x0;try{const _0x1ba543=await _0x1340b0['text'](),_0x395440=_0x4fd023=>{const _0x8735a4=_0x36f58a;_0x9136d7['textContent']=_0x8735a4(0x136)+_0x4fd023[_0x8735a4(0x13f)]+'\x20('+_0x4fd023[_0x8735a4(0xaf)]+'/'+_0x4fd023[_0x8735a4(0xbe)]+')',_0x30f0bb['value']=_0x4fd023['processed']/_0x4fd023[_0x8735a4(0xbe)]*0x64;},_0x56bae3=()=>{updatePanelStatus(),log('[实时刷新]\x20批次完成，忆识总数已更新。','info');},_0x34fc08=await _0x222c37['ingestTextToHanlinyuan'](_0x1ba543,_0x36f58a(0x1bc),{'sourceName':_0x1340b0['name']},_0x395440,_0x5f4fee,log,_0x56bae3,_0x154e1e,_0x43a77b);if(_0x34fc08[_0x36f58a(0x249)])toastr['success'](_0x36f58a(0xfc)+_0x34fc08[_0x36f58a(0x165)]+_0x36f58a(0x189)),_0x9136d7[_0x36f58a(0x153)]=_0x36f58a(0x97)+_0x34fc08[_0x36f58a(0x165)]+_0x36f58a(0x1e5),_0x30f0bb[_0x36f58a(0x15e)]=0x64,updatePanelStatus();else throw new Error(_0x34fc08['error']||_0x36f58a(0xc6));}catch(_0x52a0d5){_0x52a0d5['name']===_0x36f58a(0x21b)?(toastr[_0x36f58a(0x1a4)](_0x36f58a(0x7c)),_0x9136d7[_0x36f58a(0x153)]='任务已中止。'):(toastr['error'](_0x36f58a(0x141)+_0x52a0d5['message']+_0x36f58a(0x1ce)),_0x9136d7[_0x36f58a(0x153)]=_0x36f58a(0x188)+_0x52a0d5[_0x36f58a(0x13f)]);}finally{setTimeout(()=>{const _0xb1254b=_0x36f58a;_0x1adcca[_0xb1254b(0x191)][_0xb1254b(0x1e1)]=_0xb1254b(0x185),_0xb0e167['style'][_0xb1254b(0x1e1)]=_0xb1254b(0xc7),_0x2a2d9d[_0xb1254b(0x15e)]='',_0x1340b0=null,_0x4bffe6[_0xb1254b(0x153)]=_0xb1254b(0x89);},0xbb8);}}),_0x1610ac['addEventListener'](_0x59a90f(0x217),()=>{const _0x1a3f0a=_0x59a90f;_0x16b666&&_0x16b666[_0x1a3f0a(0x13b)]();});}function bindSessionLockEvent(){const _0xe8aae0=_0x2eed1f,_0x488ccd=document[_0xe8aae0(0x242)](_0xe8aae0(0x84));if(!_0x488ccd)return;_0x488ccd[_0xe8aae0(0x1cd)]('click',async()=>{const _0x37dcc3=_0xe8aae0,_0x12a74e=await _0x222c37[_0x37dcc3(0xc2)]();updateSessionLockUI(_0x12a74e);if(_0x12a74e){const _0xf397f6=_0x222c37[_0x37dcc3(0x152)]();_0xf397f6&&(toastr[_0x37dcc3(0x249)](_0x37dcc3(0x150)+_0xf397f6['id'],_0x37dcc3(0xa7)),log('会话已锁定到宝库:\x20'+_0xf397f6['id'],_0x37dcc3(0x249)));}else toastr['info'](_0x37dcc3(0x8d),'诏曰'),log(_0x37dcc3(0x183),_0x37dcc3(0x1a4));updatePanelStatus();}),updateSessionLockUI(_0x222c37[_0xe8aae0(0x250)]());}function updateSessionLockUI(_0x547abd){const _0x33342f=_0x2eed1f,_0x3b74fd=document[_0x33342f(0x242)](_0x33342f(0x84));if(!_0x3b74fd)return;const _0x294209=_0x3b74fd[_0x33342f(0x1dc)]('i'),_0x351c88=_0x3b74fd['querySelector'](_0x33342f(0x6d));_0x547abd?(_0x3b74fd[_0x33342f(0x22b)][_0x33342f(0xe7)]('active'),_0x294209[_0x33342f(0x229)]=_0x33342f(0x7f),_0x351c88[_0x33342f(0x153)]=_0x33342f(0x18e),_0x3b74fd['title']=_0x33342f(0x12a)):(_0x3b74fd[_0x33342f(0x22b)][_0x33342f(0x24c)](_0x33342f(0x10c)),_0x294209['className']=_0x33342f(0x266),_0x351c88[_0x33342f(0x153)]=_0x33342f(0xb4),_0x3b74fd['title']=_0x33342f(0xa6));}function bindPanelToggleEvents(){const _0x18b8b2=_0x2eed1f,_0x4318f0=document[_0x18b8b2(0x242)](_0x18b8b2(0xfa));if(_0x4318f0){}}function bindTutorialEvents(){const _0x48a130=_0x2eed1f,_0x589c87=document['getElementById'](_0x48a130(0x255));_0x589c87&&_0x589c87['addEventListener'](_0x48a130(0x217),()=>{const _0x1f1757=_0x48a130;showContentModal(_0x1f1757(0x26a),_0x1f1757(0x1be));});}function bindInternalUIEvents(){const _0x18096f=_0x2eed1f,_0x445cc2=document[_0x18096f(0x25d)](_0x18096f(0xa5));_0x445cc2['forEach'](_0x5db251=>{const _0xf1cdde=_0x18096f;_0x5db251[_0xf1cdde(0x1cd)]('click',()=>{const _0x15246a=_0xf1cdde,_0x4a5911=_0x5db251['dataset'][_0x15246a(0x16e)],_0x409543='hly-'+_0x4a5911+_0x15246a(0x227);document[_0x15246a(0x25d)]('.hly-tab-pane')[_0x15246a(0x1d2)](_0x4257ec=>{const _0x36ff74=_0x15246a;_0x4257ec[_0x36ff74(0x22b)][_0x36ff74(0x1a6)](_0x36ff74(0x10c),_0x4257ec['id']===_0x409543);}),_0x445cc2[_0x15246a(0x1d2)](_0x4d6c8f=>_0x4d6c8f[_0x15246a(0x22b)][_0x15246a(0x1a6)]('active',_0x4d6c8f===_0x5db251));});});const _0x1f81d1=document[_0x18096f(0x242)]('hly-api-endpoint');_0x1f81d1&&_0x1f81d1[_0x18096f(0x1cd)]('change',handleApiModeChange);const _0x4908fd=document[_0x18096f(0x242)](_0x18096f(0xeb)),_0x156dd5=document['getElementById']('hly-tag-input-container');_0x4908fd&&_0x156dd5&&_0x4908fd[_0x18096f(0x1cd)](_0x18096f(0x1ee),()=>{const _0x53a294=_0x18096f;_0x156dd5[_0x53a294(0x191)]['display']=_0x4908fd['checked']?'block':_0x53a294(0xc7);});const _0x174d36=document[_0x18096f(0x242)](_0x18096f(0x23b));_0x174d36&&_0x174d36[_0x18096f(0x1cd)](_0x18096f(0x1ee),handleWorldbookSelectionChange);const _0x2169a5=document[_0x18096f(0x242)]('hly-exclusion-rules-btn');_0x2169a5&&_0x2169a5[_0x18096f(0x1cd)]('click',showExclusionRulesModal);const _0x59cf21=document[_0x18096f(0x242)]('hly-hist-entry-multiselect-btn'),_0x73b81a=document[_0x18096f(0x242)](_0x18096f(0x1ef));_0x59cf21&&_0x73b81a&&(_0x59cf21['addEventListener'](_0x18096f(0x217),_0x76ea7b=>{const _0x4df355=_0x18096f;_0x76ea7b[_0x4df355(0x76)]();const _0x4ee04b=_0x73b81a[_0x4df355(0x191)]['display']===_0x4df355(0x1a1);_0x73b81a[_0x4df355(0x191)][_0x4df355(0x1e1)]=_0x4ee04b?'none':_0x4df355(0x1a1);}),_0x73b81a[_0x18096f(0x1cd)]('change',_0x184f6e=>{const _0x4f33c2=_0x18096f,_0x34c041=_0x184f6e[_0x4f33c2(0x18a)];if(_0x34c041[_0x4f33c2(0x87)]!==_0x4f33c2(0x1fc))return;const _0x1ecec7=_0x73b81a[_0x4f33c2(0x25d)](_0x4f33c2(0x231)),_0x2afb8c=document[_0x4f33c2(0x242)](_0x4f33c2(0x100));if(_0x34c041['id']===_0x4f33c2(0x100))_0x1ecec7[_0x4f33c2(0x1d2)](_0x138b3b=>_0x138b3b['checked']=_0x34c041['checked']);else{const _0x3d30f1=Array[_0x4f33c2(0xc0)](_0x1ecec7)['every'](_0x3198f4=>_0x3198f4[_0x4f33c2(0x13e)]);_0x2afb8c[_0x4f33c2(0x13e)]=_0x3d30f1;}const _0x10cecf=_0x73b81a[_0x4f33c2(0x25d)](_0x4f33c2(0x21e))['length'],_0x505e92=_0x1ecec7[_0x4f33c2(0x1a7)];_0x59cf21[_0x4f33c2(0x1dc)](_0x4f33c2(0x6d))['textContent']=_0x4f33c2(0x1ec)+_0x10cecf+'\x20/\x20'+_0x505e92+_0x4f33c2(0x15b);}),document['addEventListener']('click',_0x46231e=>{const _0x428f68=_0x18096f;!_0x59cf21[_0x428f68(0x26c)](_0x46231e['target'])&&!_0x73b81a[_0x428f68(0x26c)](_0x46231e[_0x428f68(0x18a)])&&(_0x73b81a[_0x428f68(0x191)][_0x428f68(0x1e1)]=_0x428f68(0xc7));}));const _0xf710ed=document['getElementById'](_0x18096f(0x124));_0xf710ed&&_0xf710ed['addEventListener']('click',deleteAllLocalKnowledgeBases);const _0x111206=document['getElementById'](_0x18096f(0x1ff));_0x111206&&_0x111206['addEventListener'](_0x18096f(0x217),()=>moveAllKnowledgeBases(_0x18096f(0x1c3)));const _0x3c038f=document['getElementById'](_0x18096f(0x1ad));_0x3c038f&&_0x3c038f['addEventListener'](_0x18096f(0x217),()=>moveAllKnowledgeBases(_0x18096f(0x224)));const _0x153405=[_0x18096f(0x12c),_0x18096f(0x22c)];_0x153405[_0x18096f(0x1d2)](_0x168654=>{const _0x2fe279=_0x18096f,_0x358ca5=document[_0x2fe279(0x242)](_0x168654);_0x358ca5&&(_0x358ca5[_0x2fe279(0x1cd)](_0x2fe279(0x217),handleKbAction),_0x358ca5[_0x2fe279(0x1cd)](_0x2fe279(0x1ee),handleKbAction));}),document['getElementById'](_0x18096f(0x223))[_0x18096f(0x1cd)](_0x18096f(0x1ee),_0x450273=>handleSelectAll(_0x450273,_0x18096f(0x118))),document[_0x18096f(0x242)]('hly-kb-select-all-local')['addEventListener'](_0x18096f(0x1ee),_0xcdaa76=>handleSelectAll(_0xcdaa76,_0x18096f(0x1eb))),document['getElementById'](_0x18096f(0x10a))['addEventListener']('click',_0x4be060=>handleBulkAction(_0x4be060,'global')),document[_0x18096f(0x242)](_0x18096f(0x204))[_0x18096f(0x1cd)]('click',_0x443b7b=>handleBulkAction(_0x443b7b,_0x18096f(0x1eb)));}function initializeUnifiedInjectionEditor(){const _0x10f115=_0x2eed1f,_0x228011=document['getElementById'](_0x10f115(0x1c4)),_0x2a5fc7=document[_0x10f115(0x242)]('hly-unified-template-editor'),_0xb43f10=document['getElementById'](_0x10f115(0x235)),_0x256826=document[_0x10f115(0x25d)](_0x10f115(0x23c)),_0x300e7a=document[_0x10f115(0x242)](_0x10f115(0x129)),_0x509a18=document[_0x10f115(0x242)]('hly-unified-injection-role');if(!_0x228011)return;const _0x16a74b={'novel':'{{novel_text}}','chat':_0x10f115(0xa9),'lorebook':'{{lorebook_text}}','manual':_0x10f115(0xa0)};function _0xc77ce4(){const _0x534afa=_0x10f115,_0x35cdf0=_0x228011[_0x534afa(0x15e)],_0xe88796=_0x222c37['getSettings'](),_0x1fb55d=_0xe88796['injection_'+_0x35cdf0]||{};_0x2a5fc7['value']=_0x1fb55d[_0x534afa(0x268)]||'',_0xb43f10[_0x534afa(0x153)]='以\x20'+(_0x16a74b[_0x35cdf0]||_0x534afa(0xb0))+_0x534afa(0x139);const _0x9b2890=_0x1fb55d[_0x534afa(0x117)]!==undefined?String(_0x1fb55d[_0x534afa(0x117)]):'2';_0x256826[_0x534afa(0x1d2)](_0x13105c=>_0x13105c[_0x534afa(0x13e)]=_0x13105c[_0x534afa(0x15e)]===_0x9b2890),_0x300e7a[_0x534afa(0x15e)]=_0x1fb55d[_0x534afa(0x1aa)]||0x0,_0x509a18['value']=_0x1fb55d[_0x534afa(0xde)]!==undefined?String(_0x1fb55d[_0x534afa(0xde)]):'0';const _0x3dfb3a=_0x9b2890==='1';_0x300e7a[_0x534afa(0xd5)]=!_0x3dfb3a,_0x509a18[_0x534afa(0xd5)]=!_0x3dfb3a;}function _0x5f3b6e(){const _0x1c5035=_0x10f115,_0x4429de=_0x228011[_0x1c5035(0x15e)];updateAndSaveSetting('injection_'+_0x4429de+'.template',_0x2a5fc7[_0x1c5035(0x15e)]);const _0x430985=document[_0x1c5035(0x1dc)]('input[name=\x22hly-unified-injection-position\x22]:checked');_0x430985&&updateAndSaveSetting(_0x1c5035(0xdb)+_0x4429de+_0x1c5035(0x251),parseInt(_0x430985[_0x1c5035(0x15e)],0xa)),updateAndSaveSetting(_0x1c5035(0xdb)+_0x4429de+'.depth',parseInt(_0x300e7a[_0x1c5035(0x15e)],0xa)),updateAndSaveSetting(_0x1c5035(0xdb)+_0x4429de+'.depth_role',parseInt(_0x509a18['value'],0xa));}_0x228011[_0x10f115(0x1cd)](_0x10f115(0x1ee),_0xc77ce4);const _0x1a20be=debounce(_0x5f3b6e,0x12c);_0x2a5fc7[_0x10f115(0x1cd)](_0x10f115(0x82),_0x1a20be),_0x300e7a['addEventListener'](_0x10f115(0x1ee),_0x5f3b6e),_0x509a18['addEventListener']('change',_0x5f3b6e),_0x256826[_0x10f115(0x1d2)](_0x596ce7=>_0x596ce7['addEventListener'](_0x10f115(0x1ee),()=>{const _0x5e5de9=_0x10f115;_0x5f3b6e();const _0x21639b=_0x596ce7[_0x5e5de9(0x15e)]==='1'&&_0x596ce7[_0x5e5de9(0x13e)];_0x300e7a[_0x5e5de9(0xd5)]=!_0x21639b,_0x509a18['disabled']=!_0x21639b;})),_0xc77ce4();}function handleApiModeChange(){const _0x32c35e=_0x2eed1f,_0x34362a=document[_0x32c35e(0x242)]('hly-api-endpoint')['value'],_0x159129=document[_0x32c35e(0x242)](_0x32c35e(0x74)),_0x3e9434=document[_0x32c35e(0x242)](_0x32c35e(0xd2)),_0xe3fb22=document[_0x32c35e(0x242)](_0x32c35e(0x81)),_0x2481c1=_0xe3fb22[_0x32c35e(0x218)];if(!_0x159129||!_0x3e9434)return;_0x159129['style'][_0x32c35e(0x1e1)]='block',_0x3e9434[_0x32c35e(0x191)]['display']=_0x32c35e(0x1a1);switch(_0x34362a){case'google_direct':_0x159129[_0x32c35e(0x191)][_0x32c35e(0x1e1)]='none',_0x3e9434[_0x32c35e(0x1dc)](_0x32c35e(0x1df))[_0x32c35e(0x153)]=_0x32c35e(0xe0),_0x3e9434[_0x32c35e(0x1dc)](_0x32c35e(0x82))[_0x32c35e(0x147)]='请输入您的Google\x20API\x20Key';break;case _0x32c35e(0x1bf):_0x159129['querySelector']('label')[_0x32c35e(0x153)]='本地代理地址:',_0x159129[_0x32c35e(0x1dc)](_0x32c35e(0x82))[_0x32c35e(0x147)]='例如\x20http://127.0.0.1:8000/v1',_0x3e9434['style'][_0x32c35e(0x1e1)]=_0x32c35e(0xc7);break;case'custom':default:_0x159129[_0x32c35e(0x1dc)](_0x32c35e(0x1df))['textContent']='自定义路径:',_0x159129[_0x32c35e(0x1dc)](_0x32c35e(0x82))['placeholder']=_0x32c35e(0xf5),_0x3e9434[_0x32c35e(0x1dc)](_0x32c35e(0x1df))[_0x32c35e(0x153)]='通行令牌\x20(API\x20Key):';break;}}function loadSettingsToUI(){const _0x219a09=_0x2eed1f,_0x419957=_0x222c37['getSettings']();if(!_0x419957)return;document[_0x219a09(0x242)](_0x219a09(0xb1))['checked']=_0x419957[_0x219a09(0x99)][_0x219a09(0x209)],document['getElementById'](_0x219a09(0x18c))[_0x219a09(0x15e)]=_0x419957[_0x219a09(0x99)][_0x219a09(0xec)],document[_0x219a09(0x242)](_0x219a09(0x264))[_0x219a09(0x15e)]=_0x419957[_0x219a09(0x99)][_0x219a09(0x240)],document[_0x219a09(0x242)](_0x219a09(0x149))['value']=_0x419957[_0x219a09(0x99)][_0x219a09(0x1f7)];const _0x347d8a=document[_0x219a09(0x242)](_0x219a09(0x81));if(_0x347d8a['options'][_0x219a09(0x1a7)]===0x0){const _0x46bbd6=_0x419957[_0x219a09(0x99)][_0x219a09(0xed)],_0x16a0ca=new Option(_0x46bbd6,_0x46bbd6,!![],!![]);_0x347d8a[_0x219a09(0xe7)](_0x16a0ca);}_0x347d8a['value']=_0x419957[_0x219a09(0x99)][_0x219a09(0xed)],document[_0x219a09(0x242)](_0x219a09(0xf6))[_0x219a09(0x13e)]=_0x419957[_0x219a09(0x99)][_0x219a09(0x199)],document[_0x219a09(0x242)](_0x219a09(0x19a))[_0x219a09(0x15e)]=_0x419957[_0x219a09(0x181)][_0x219a09(0x1b3)],document[_0x219a09(0x242)](_0x219a09(0x1d5))['value']=_0x419957['advanced'][_0x219a09(0x1cb)],document[_0x219a09(0x242)](_0x219a09(0x17b))[_0x219a09(0x15e)]=_0x419957['advanced'][_0x219a09(0x111)],document['getElementById']('hly-query-message-count')[_0x219a09(0x15e)]=_0x419957['advanced'][_0x219a09(0x78)],document[_0x219a09(0x242)](_0x219a09(0x11f))[_0x219a09(0x15e)]=_0x419957[_0x219a09(0x181)]['maxResults'],document[_0x219a09(0x242)](_0x219a09(0x109))[_0x219a09(0x15e)]=_0x419957[_0x219a09(0x99)]['batchSize'],handleApiModeChange(),document[_0x219a09(0x242)]('hly-condensation-enabled')['checked']=_0x419957['condensation']['enabled'],document[_0x219a09(0x242)](_0x219a09(0x198))[_0x219a09(0x15e)]=_0x419957[_0x219a09(0x221)][_0x219a09(0x25f)],document[_0x219a09(0x242)](_0x219a09(0x10e))[_0x219a09(0x15e)]=_0x419957[_0x219a09(0x221)][_0x219a09(0x14a)],document[_0x219a09(0x242)](_0x219a09(0x237))[_0x219a09(0x13e)]=_0x419957['condensation'][_0x219a09(0xa2)][_0x219a09(0x7b)],document[_0x219a09(0x242)]('hly-include-ai')[_0x219a09(0x13e)]=_0x419957[_0x219a09(0x221)][_0x219a09(0xa2)]['ai'];const _0x504881=document[_0x219a09(0x242)]('hly-tag-extraction-toggle'),_0x17c410=document[_0x219a09(0x242)](_0x219a09(0x12f)),_0x1a212c=document[_0x219a09(0x242)](_0x219a09(0x239));_0x504881[_0x219a09(0x13e)]=_0x419957['condensation'][_0x219a09(0x222)],_0x17c410[_0x219a09(0x15e)]=_0x419957[_0x219a09(0x221)]['tags'],_0x1a212c['style']['display']=_0x504881[_0x219a09(0x13e)]?_0x219a09(0x1a1):_0x219a09(0xc7),document['getElementById'](_0x219a09(0x24e))[_0x219a09(0x13e)]=_0x419957['rerank'][_0x219a09(0x209)],document[_0x219a09(0x242)](_0x219a09(0xfd))[_0x219a09(0x15e)]=_0x419957[_0x219a09(0x18f)]['url'],document[_0x219a09(0x242)](_0x219a09(0x15f))[_0x219a09(0x15e)]=_0x419957[_0x219a09(0x18f)][_0x219a09(0x1f7)];const _0x4bee8b=document[_0x219a09(0x242)]('hly-rerank-model');if(_0x4bee8b[_0x219a09(0x232)]['length']===0x0){const _0x58807f=_0x419957[_0x219a09(0x18f)]['model'];if(_0x58807f){const _0x3e1768=new Option(_0x58807f,_0x58807f,!![],!![]);_0x4bee8b[_0x219a09(0xe7)](_0x3e1768);}}_0x4bee8b[_0x219a09(0x15e)]=_0x419957[_0x219a09(0x18f)]['model'],document[_0x219a09(0x242)]('hly-rerank-top-n')['value']=_0x419957[_0x219a09(0x18f)]['top_n'],document[_0x219a09(0x242)]('hly-rerank-hybrid-alpha')[_0x219a09(0x15e)]=_0x419957[_0x219a09(0x18f)][_0x219a09(0x12b)],document[_0x219a09(0x242)](_0x219a09(0x1a0))[_0x219a09(0x13e)]=_0x419957['rerank'][_0x219a09(0x199)],document['getElementById']('hly-super-sort-enabled')[_0x219a09(0x13e)]=_0x419957[_0x219a09(0x18f)]['superSortEnabled'];}function saveSettingsFromUI(_0x4b8aae=!![]){const _0x1fd7b9=_0x2eed1f,_0x5b0f6b=document[_0x1fd7b9(0x242)](_0x1fd7b9(0x6b));if(!_0x5b0f6b)return;const _0x49ebfc=_0x5b0f6b[_0x1fd7b9(0x25d)](_0x1fd7b9(0x1ba));_0x49ebfc['forEach'](_0x50b97b=>{const _0x36abf6=_0x1fd7b9,_0x427a39=_0x50b97b[_0x36abf6(0x13c)][_0x36abf6(0x193)];if(!_0x427a39)return;let _0x591493;const _0x505520=_0x50b97b[_0x36abf6(0x13c)]['type']||_0x36abf6(0xf1);if(_0x50b97b['type']==='checkbox')_0x591493=_0x50b97b[_0x36abf6(0x13e)];else{if(_0x50b97b[_0x36abf6(0x87)]==='radio'){if(!_0x50b97b['checked'])return;_0x591493=_0x50b97b['value'];}else _0x591493=_0x50b97b[_0x36abf6(0x15e)];}switch(_0x505520){case'integer':_0x591493=parseInt(_0x591493,0xa);break;case _0x36abf6(0x19d):_0x591493=parseFloat(_0x591493);break;case _0x36abf6(0x21f):if(typeof _0x591493!=='boolean')_0x591493=_0x591493===_0x36abf6(0x163);break;}const _0xb6fde7=_0x222c37[_0x36abf6(0x1f9)](),_0x56e00a=_0x427a39['split']('.');let _0x2c2428=_0xb6fde7;for(let _0xf2e9d=0x0;_0xf2e9d<_0x56e00a[_0x36abf6(0x1a7)]-0x1;_0xf2e9d++){_0x2c2428=_0x2c2428[_0x56e00a[_0xf2e9d]]=_0x2c2428[_0x56e00a[_0xf2e9d]]||{};}_0x2c2428[_0x56e00a[_0x56e00a[_0x36abf6(0x1a7)]-0x1]]=_0x591493;}),_0x222c37[_0x1fd7b9(0x70)](),!_0x4b8aae&&(log(_0x1fd7b9(0x1f1),_0x1fd7b9(0x249)),toastr[_0x1fd7b9(0x249)](_0x1fd7b9(0xb2),_0x1fd7b9(0x23f)));}function resetSettingsToUI(){const _0x43d5d1=_0x2eed1f;confirm(_0x43d5d1(0x176))&&(_0x222c37[_0x43d5d1(0x243)](),loadSettingsToUI(),toastr[_0x43d5d1(0x1a4)](_0x43d5d1(0x15c),'诏曰'));}async function updatePanelStatus(){const _0x2e3d7d=_0x2eed1f,_0x163d16=_0x222c37[_0x2e3d7d(0x250)](),_0x1060de=document[_0x2e3d7d(0x242)](_0x2e3d7d(0x1e2)),_0xe2e094=document[_0x2e3d7d(0x242)](_0x2e3d7d(0xcd));if(_0x163d16){const _0x22d101=_0x222c37['getLockedSessionInfo']();_0x22d101&&(_0x1060de[_0x2e3d7d(0x153)]=_0x2e3d7d(0x18b),_0xe2e094['textContent']=_0x22d101['id'],_0xe2e094[_0x2e3d7d(0x122)]='当前所有操作都将指向这个锁定的宝库：'+_0x22d101['id'],_0x1060de[_0x2e3d7d(0x22b)][_0x2e3d7d(0xe7)]('hly-locked-status'),_0xe2e094[_0x2e3d7d(0x22b)][_0x2e3d7d(0xe7)](_0x2e3d7d(0x101)));}else _0x1060de[_0x2e3d7d(0x153)]=_0x27cc29[_0x2e3d7d(0x107)](),_0xe2e094[_0x2e3d7d(0x153)]=_0x27cc29[_0x2e3d7d(0x13d)]()||'无',_0xe2e094[_0x2e3d7d(0x122)]='',_0x1060de['classList'][_0x2e3d7d(0x24c)]('hly-locked-status'),_0xe2e094[_0x2e3d7d(0x22b)]['remove'](_0x2e3d7d(0x101));const _0x285b3e=document[_0x2e3d7d(0x242)](_0x2e3d7d(0x71));_0x285b3e[_0x2e3d7d(0x153)]=_0x2e3d7d(0x1a9);try{const _0x257293=await _0x222c37['getVectorCount']();_0x285b3e[_0x2e3d7d(0x153)]=_0x257293;}catch(_0x59af74){console[_0x2e3d7d(0xf4)](_0x2e3d7d(0x1c5),_0x59af74),_0x285b3e[_0x2e3d7d(0x153)]=_0x2e3d7d(0x6f),_0x285b3e[_0x2e3d7d(0x122)]=_0x2e3d7d(0x102)+_0x59af74[_0x2e3d7d(0x13f)];}const _0x45eaba=document['getElementById'](_0x2e3d7d(0x1b7));if(_0x45eaba&&!_0x45eaba['dataset'][_0x2e3d7d(0xa1)]){const _0x3dbf6f=_0x222c37[_0x2e3d7d(0x1f9)](),_0x2981b4=await _0x222c37[_0x2e3d7d(0x154)]();if(_0x3dbf6f[_0x2e3d7d(0x186)]&&_0x3dbf6f[_0x2e3d7d(0x186)][_0x2981b4]){const _0x4c8035=_0x3dbf6f[_0x2e3d7d(0x186)][_0x2981b4];_0x45eaba[_0x2e3d7d(0x1d7)]='<p\x20class=\x22hly-record-hint\x22><i>上次已从第\x20'+_0x4c8035[_0x2e3d7d(0x207)]+_0x2e3d7d(0x1c0)+_0x4c8035[_0x2e3d7d(0x23d)]+'\x20楼。</i></p>';}else _0x45eaba[_0x2e3d7d(0x1d7)]='<p\x20class=\x22hly-record-hint\x22>可在此预览凝识结果。</p>';}renderKnowledgeBases();}async function moveAllKnowledgeBases(_0x4deef9){const _0x4bf2d8=_0x2eed1f,_0x165969=_0x4deef9===_0x4bf2d8(0x1c3),_0x1df23b=_0x165969?'global':_0x4bf2d8(0x1eb),_0x122e8f=_0x165969?'局部':'全局',_0x2dece0=_0x165969?_0x222c37[_0x4bf2d8(0x143)]():_0x222c37[_0x4bf2d8(0x67)](),_0x316b91=Object['keys'](_0x2dece0);if(_0x316b91[_0x4bf2d8(0x1a7)]===0x0){toastr['info'](_0x4bf2d8(0x1b0)+(_0x165969?'全局':'局部')+_0x4bf2d8(0x75),'圣谕');return;}if(!confirm(_0x4bf2d8(0x1db)+_0x316b91['length']+_0x4bf2d8(0x1d3)+(_0x165969?'全局':'局部')+_0x4bf2d8(0x16d)+_0x122e8f+'】吗？'))return;log(_0x4bf2d8(0x96)+_0x316b91[_0x4bf2d8(0x1a7)]+'\x20个知识库从\x20'+_0x1df23b+'\x20移动到\x20'+(_0x165969?_0x4bf2d8(0x1eb):_0x4bf2d8(0x118))+_0x4bf2d8(0x1a9),_0x4bf2d8(0x1a4));const _0x2e9695=_0x316b91[_0x4bf2d8(0x1d8)](_0x59e46d=>_0x222c37['moveKnowledgeBase'](_0x59e46d,_0x1df23b));try{await Promise[_0x4bf2d8(0x160)](_0x2e9695),toastr[_0x4bf2d8(0x249)]('所有\x20'+_0x316b91[_0x4bf2d8(0x1a7)]+'\x20个知识库均已成功移动。',_0x4bf2d8(0x130)),log(_0x4bf2d8(0xb5),_0x4bf2d8(0x249));}catch(_0x1b8978){toastr[_0x4bf2d8(0xf4)]('批量移动过程中发生错误:\x20'+_0x1b8978[_0x4bf2d8(0x13f)],'警报'),log(_0x4bf2d8(0x220)+_0x1b8978[_0x4bf2d8(0x13f)],_0x4bf2d8(0xf4));}finally{await updatePanelStatus();}}async function deleteAllLocalKnowledgeBases(){const _0x34a7c4=_0x2eed1f,_0x348c07=_0x222c37[_0x34a7c4(0x67)](),_0x105924=Object[_0x34a7c4(0x119)](_0x348c07);if(_0x105924['length']===0x0){toastr[_0x34a7c4(0x1a4)]('当前角色没有任何局部知识库可供删除。','圣谕');return;}if(!confirm(_0x34a7c4(0x22d)+_0x105924[_0x34a7c4(0x1a7)]+_0x34a7c4(0x25a)))return;toastr[_0x34a7c4(0x1a4)](_0x34a7c4(0x123)+_0x105924[_0x34a7c4(0x1a7)]+_0x34a7c4(0x22a),'圣旨'),log(_0x34a7c4(0x19f)+_0x105924[_0x34a7c4(0x1a7)]+_0x34a7c4(0x22a),'warn');let _0x7eb903=0x0,_0x4fdef2=0x0;for(const _0x1d8c0f of _0x105924){try{await _0x222c37['removeKnowledgeBase'](_0x1d8c0f,_0x34a7c4(0x1eb)),_0x7eb903++;}catch(_0xe81d50){_0x4fdef2++,log('删除局部知识库\x20'+_0x1d8c0f+'\x20失败:\x20'+_0xe81d50[_0x34a7c4(0x13f)],_0x34a7c4(0xf4));}}_0x4fdef2>0x0?toastr[_0x34a7c4(0xf4)](_0x34a7c4(0x15d)+_0x4fdef2+_0x34a7c4(0x1b1),'警报'):toastr['success'](_0x34a7c4(0x182)+_0x7eb903+'\x20个局部知识库均已成功删除。',_0x34a7c4(0x130)),log(_0x34a7c4(0x24f)+_0x7eb903+_0x34a7c4(0x8f)+_0x4fdef2,_0x34a7c4(0x1a4)),await updatePanelStatus();}async function renderKnowledgeBases(){const _0x182e3a=_0x2eed1f,_0x4c8fc1=document[_0x182e3a(0x242)](_0x182e3a(0x12c)),_0x41f18e=document[_0x182e3a(0x242)]('hly-kb-list-global'),_0x30da28=document[_0x182e3a(0x242)](_0x182e3a(0x19b));if(!_0x4c8fc1||!_0x41f18e||!_0x30da28)return;_0x30da28['textContent']=_0x27cc29[_0x182e3a(0x107)]()||_0x182e3a(0x151);try{const _0x477031=_0x222c37['getLocalKnowledgeBases'](),_0x26fb83=_0x222c37['getGlobalKnowledgeBases']();await _renderKbList(_0x477031,_0x4c8fc1,'local','hly-kb-list-local-placeholder'),await _renderKbList(_0x26fb83,_0x41f18e,'global',_0x182e3a(0xb7));}catch(_0x725202){console[_0x182e3a(0xf4)](_0x182e3a(0x108),_0x725202),_0x4c8fc1[_0x182e3a(0x1d7)]=_0x182e3a(0x258)+_0x725202[_0x182e3a(0x13f)]+_0x182e3a(0x125),_0x41f18e[_0x182e3a(0x1d7)]='<p\x20class=\x22hly-notes\x20log-error\x22><i>加载失败:\x20'+_0x725202[_0x182e3a(0x13f)]+_0x182e3a(0x125);}}async function _renderKbList(_0x4e03a9,_0x455848,_0xa770f2,_0x330db6){const _0x28cc2b=_0x2eed1f,_0x289a67=document[_0x28cc2b(0x242)](_0x330db6);_0x455848[_0x28cc2b(0x1d7)]='',_0x455848[_0x28cc2b(0x200)](_0x289a67);if(Object['keys'](_0x4e03a9)[_0x28cc2b(0x1a7)]===0x0){_0x289a67[_0x28cc2b(0x191)][_0x28cc2b(0x1e1)]=_0x28cc2b(0x1a1);return;}_0x289a67['style'][_0x28cc2b(0x1e1)]='none';for(const [_0x6fb85d,_0x19a1d7]of Object[_0x28cc2b(0xbd)](_0x4e03a9)){const _0x19bb62=document[_0x28cc2b(0x80)](_0x28cc2b(0xdf));_0x19bb62[_0x28cc2b(0x229)]='hly-kb-list-item',_0x19bb62[_0x28cc2b(0x13c)][_0x28cc2b(0x1b5)]=_0x6fb85d,_0x19bb62[_0x28cc2b(0x13c)][_0x28cc2b(0x1b6)]=_0xa770f2;const _0x229f47=await _0x222c37[_0x28cc2b(0xb8)](_0x6fb85d,_0xa770f2),_0x3f9f04=_0xa770f2===_0x28cc2b(0x1eb)?_0x28cc2b(0x1c1):_0x28cc2b(0xf0);_0x19bb62[_0x28cc2b(0x1d7)]=_0x28cc2b(0x17f)+_0x6fb85d+_0x28cc2b(0x1e9)+_0x6fb85d+'\x22>'+_0x19a1d7[_0x28cc2b(0x113)]+'\x20('+_0x229f47+_0x28cc2b(0x131)+_0x3f9f04+_0x28cc2b(0x69)+(_0x19a1d7['enabled']?_0x28cc2b(0x13e):'')+'>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22hly-toggle-slider\x22></span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</label>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22hly-kb-delete-btn\x22\x20title=\x22删除此知识库\x22>&times;</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20',_0x455848[_0x28cc2b(0x200)](_0x19bb62);}}async function handleKbAction(_0x25e2e9){const _0x41b462=_0x2eed1f,_0x16a086=_0x25e2e9[_0x41b462(0x18a)],_0x2e776d=_0x16a086[_0x41b462(0x10f)](_0x41b462(0xe4));if(!_0x2e776d)return;const _0x385851=_0x2e776d[_0x41b462(0x13c)][_0x41b462(0x1b5)],_0x181dc4=_0x2e776d['dataset']['kbScope'],_0x5d13a4=_0x2e776d['querySelector'](_0x41b462(0x202))['textContent'][_0x41b462(0x7a)]('\x20(')[0x0];if(_0x16a086[_0x41b462(0x22b)]['contains'](_0x41b462(0x253))){if(confirm('您确定要永久删除知识库【'+_0x5d13a4+_0x41b462(0x179)))try{await _0x222c37['removeKnowledgeBase'](_0x385851,_0x181dc4),log(_0x41b462(0x201)+_0x5d13a4+_0x41b462(0x262)+_0x385851+_0x41b462(0x234),_0x41b462(0x249)),toastr[_0x41b462(0x249)](_0x41b462(0xee)+_0x5d13a4+_0x41b462(0x19e)),await updatePanelStatus();}catch(_0x4f1b2d){log('删除知识库\x20'+_0x5d13a4+_0x41b462(0xe6)+_0x4f1b2d[_0x41b462(0x13f)],_0x41b462(0xf4)),toastr['error'](_0x41b462(0x252)+_0x4f1b2d[_0x41b462(0x13f)]);}}if(_0x16a086[_0x41b462(0x10f)](_0x41b462(0xc4))){const _0x1b15ac=_0x181dc4===_0x41b462(0x1eb)?'全局':'局部';if(confirm(_0x41b462(0x133)+_0x5d13a4+_0x41b462(0x16d)+_0x1b15ac+_0x41b462(0x197)))try{await _0x222c37['moveKnowledgeBase'](_0x385851,_0x181dc4),await updatePanelStatus();}catch(_0xe81869){log(_0x41b462(0xe9)+_0x5d13a4+_0x41b462(0xe6)+_0xe81869[_0x41b462(0x13f)],'error'),toastr[_0x41b462(0xf4)](_0x41b462(0x178)+_0xe81869[_0x41b462(0x13f)]);}}if(_0x16a086[_0x41b462(0x22b)][_0x41b462(0x26c)](_0x41b462(0x98))&&_0x25e2e9[_0x41b462(0x87)]===_0x41b462(0x1ee))try{await _0x222c37[_0x41b462(0xf3)](_0x385851,_0x181dc4),log(_0x41b462(0x201)+_0x5d13a4+_0x41b462(0x212),_0x41b462(0x249));}catch(_0x1f1695){log(_0x41b462(0x226)+_0x5d13a4+_0x41b462(0xc3)+_0x1f1695[_0x41b462(0x13f)],_0x41b462(0xf4)),toastr['error'](_0x41b462(0xbb)+_0x1f1695[_0x41b462(0x13f)]),_0x16a086[_0x41b462(0x13e)]=!_0x16a086[_0x41b462(0x13e)];}_0x16a086[_0x41b462(0x22b)]['contains'](_0x41b462(0xa3))&&_0x25e2e9[_0x41b462(0x87)]===_0x41b462(0x1ee)&&updateBulkActionUI(_0x181dc4);}function handleSelectAll(_0x1fe508,_0x4d1c0c){const _0x2ff17f=_0x2eed1f,_0x296d34=_0x1fe508[_0x2ff17f(0x18a)][_0x2ff17f(0x13e)],_0x1a5fc5=document[_0x2ff17f(0x242)](_0x2ff17f(0x95)+_0x4d1c0c),_0x539cca=_0x1a5fc5['querySelectorAll'](_0x2ff17f(0x24a));_0x539cca[_0x2ff17f(0x1d2)](_0x4eefdc=>_0x4eefdc[_0x2ff17f(0x13e)]=_0x296d34),updateBulkActionUI(_0x4d1c0c);}function _0x21f4(){const _0x4bd65b=['会话已解锁，将跟随当前角色。','\x22></i>\x20[',',\x20失败:\x20','condensation.exclusionRules','\x20条忆识。','93DFBTzE','您确定要永久删除选中的\x20','未找到符合条件的消息。','hly-kb-list-','开始将\x20','任务完成！成功录入\x20','hly-kb-toggle','retrieval','hly-historiography-results','成功获取\x20',',\x20向量:\x20','正在处理您提交的文书...','，重新开始。','\x20楼到第\x20','{{manual_text}}','finalText','messageTypes','hly-kb-item-checkbox','hanlinyuan-ingest-abort','.hly-nav-item','点击以锁定，让翰林院固定操作当前角色的宝库','圣旨已下','，从第\x20','{{chat_text}}','批量编纂任务已完成，但有部分错误。','[翰林院-枢纽]\x20预览过程发生错误:','.hly-preview-textarea','delete','send-date','processed','{{text}}','hly-retrieval-enabled','翰林院设定已存档封印。','[翰林院-枢纽]\x20加载书库列表失败:','锁定会话','批量移动完成。','finalMessages','hly-kb-list-global-placeholder','getVectorCount','is_user','此书库为空','切换状态失败:\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-preview-item-v2\x22\x20id=\x22','entries','total','stringify','from','clearJob','toggleSessionLock','\x20状态失败:\x20','.hly-kb-move-btn','编纂失败:\x20','未知错误','none','removeKnowledgeBase','\x20个知识库。','getLoresForWorldbook','each',')\x20执行批量\x20','hly-current-chat-id','comment','find','加载条目失败:\x20','[翰林院-枢纽]\x20获取模型列表失败:','hly-api-key-group','val','您确定要将选中的\x20','disabled','\x22\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20data-is-user=\x22','hly-entry-search','内容排除规则已保存。','getMessagesForCondensation','手动录入','injection_','[翰林院-枢纽]\x20获取Rerank模型列表失败:','批量操作失败:\x20','depth_role','div','Google\x20API\x20Key:','\x0a<pre>\x0a翰林院宝库状态\x0a--------------------\x0a集合ID:\x20','\x20个书库。','神力连接失败:\x20','.hly-kb-list-item','[断点续传]\x20用户选择继续任务\x20','\x20失败:\x20','add','input[name=\x22','移动知识库\x20','凝识失败:\x20','hly-tag-extraction-toggle','apiEndpoint','embeddingModel','知识库【','\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-exclusion-rule-row\x22\x20data-index=\x22','<button\x20class=\x22hly-kb-move-btn\x22\x20title=\x22下移到局部\x22><i\x20class=\x22fas\x20fa-arrow-down\x22></i></button>','string','根据标签提取或内容排除条件，未找到任何有效内容。','toggleKnowledgeBase','error','输入兼容OpenAI的embeddings端点','hly-retrieval-notify','\x22\x20placeholder=\x22结束字符,\x20如\x20-->\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22hly-delete-rule-btn\x22\x20title=\x22删除此规则\x22>&times;</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20','已采集\x20','正在对\x20','amily2_open_rag_palace','hly-log-output','成功录入\x20','hly-rerank-url','收到手动录入请求，文本长度:\x20','开始对《','hly-hist-select-all-entries','hly-locked-status','无法获取总数:\x20','.hly-log-placeholder','saveHLYSettings','.hly-preview-item-v2','hanlinyuan-ingest-novel-controls','getCharacterName','[翰林院-枢纽]\x20渲染知识库列表失败:','hly-batch-size','hly-kb-bulk-actions-global','processedChunks','active','[翰林院-枢纽]\x20凝识过程发生错误:','hly-layer-end','closest','toLocaleTimeString','matchThreshold','startHLYCondensation','name','[翰林院-枢纽]\x20查询宝库状态失败:','<option\x20value=\x22\x22>加载失败</option>','用户尝试录入空文本。','position','global','keys','getAvailableWorldbooks','radio','查询宝库状态失败:\x20','\x20个知识库\x20(范围:\x20','请先选择一个书库并至少选择一个要编纂的条目。','hly-max-results','未能获取到任何Rerank模型。','文书已成功录入宝库，新增\x20','title','正在删除\x20','hly-kb-delete-local-btn','</i></p>','\x27\x20已更新为:\x20','join','严重错误','hly-unified-injection-depth','点击以解锁，让翰林院跟随当前角色','hybrid_alpha','hly-kb-list-local','》的条目失败:','正在读取文件...','hly-tag-input','大功告成','条)</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-kb-actions\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','integer','您确定要将知识库【','resetHLYSettings','\x20个模型。','处理中:\x20','加载失败','insertAdjacentHTML','\x20为占位符。','正在清空宝库...','abort','dataset','getChatId','checked','message','testApiConnection','录入失败:\x20','\x0a</pre>\x0a\x20\x20\x20\x20\x20\x20\x20\x20','getGlobalKnowledgeBases','indeterminate','遵命，将从第\x20','hly-include-ai','placeholder','预览失败:\x20','hly-api-key','layerEnd','<div\x20class=\x22hly-no-results\x22>未找到匹配的条目</div>','_searchHandler',')\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20class=\x22hly-hist-entry-checkbox\x22\x20value=\x22','%。是否从上次中断之处继续？','开始获取模型列表...','会话已锁定到:\x20','当前角色','getLockedSessionInfo','textContent','getCollectionId','trim','已选择\x200\x20/\x20','批量编纂任务已开始...','批量编纂任务已完成。','96697TEfhhI','成功加载\x20','\x20个条目','翰林院设定已重置为初始状态。','操作完成，但有\x20','value','hly-rerank-api-key','all','filter','removeEventListener','true','请先选择书库','count','查看宝库状态成功：集合ID=','hlyLog','开始获取Rerank模型列表...','[翰林院-枢纽]\x20手动录入过程发生错误:','[翰林院-枢纽]\x20核心法典未能提供初始化圣旨！','[翰林院-枢纽]\x20加载《','scrollHeight','】移动到【','tab','hly-log-entry\x20','testHLYApi','\x22\x20placeholder=\x22开始字符,\x20如\x20<!--\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span>到</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20class=\x22hly-imperial-brush\x22\x20value=\x22','编辑内容排除规则','generateJobId','未能获取到任何模型。','\x0a忆识总数:\x20','您确定要将所有设定恢复为出厂默认值吗？','hly-kb-bulk-actions-','移动失败:\x20','】吗？此操作无法恢复！','[翰林院-枢纽]\x20已成功连接各部，政令畅通。','hly-match-threshold','use\x20strict','warning','hly-rerank-model','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20class=\x22hly-kb-item-checkbox\x22\x20data-kb-id=\x22','option','advanced','所有\x20','会话已解锁。','<option>未找到模型</option>','flex','condensationHistory','\x20个知识库执行批量操作...','错误:\x20','\x20个知识块','target','会话已锁定','hly-api-endpoint','聊天记录从第\x20','解锁会话','rerank','成功删除了\x20','style','</textarea>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</details>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22hly-preview-delete-btn-v2\x22\x20data-target=\x22','settingKey','previewHLYCondensation','2163808Vejnrv','purgeStorage','】吗？','hly-layer-start','notify','hly-chunk-size','hly-local-kb-char-name','selectedIndex','float','】已删除。','开始批量删除\x20','hly-rerank-notify','block','hly-kb-select-all-','executeCompilation','info','407URrNYz','toggle','length','清空宝库失败。','...','depth','\x22\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20data-send-date=\x22','fa-times-circle','hly-kb-move-all-to-global','成功移动了\x20','push','源区域（','\x20个知识库删除失败。','exclusionRules','chunkSize','宝库状态','kbId','kbScope','hly-condensation-results','开始对\x20','log-success','[data-setting-key]','floor','novel','获取Rerank模型失败:\x20','scripts/extensions/third-party/ST-Amily2-Chat-Optimisation/HanLin.md','local_proxy','\x20楼凝识至第\x20','<button\x20class=\x22hly-kb-move-btn\x22\x20title=\x22上移到全局\x22><i\x20class=\x22fas\x20fa-arrow-up\x22></i></button>','<option>正在获取...</option>','globalToLocal','hly-injection-source-selector','[翰林院-枢纽]\x20更新忆识数量失败:','文书录入失败:\x20','scrollTop','20rhwboa','initialize','.hly-preview-delete-btn-v2','overlap','正在查询宝库状态...','addEventListener','。进度已保存，可稍后重试。','hly-manual-text','loadProgress','宝库已清空。','forEach','\x20个知识库从【','data','hly-overlap-size','\x20楼到\x20','innerHTML','map','检测到预览后待处理的消息对象，开始精确凝识...','mes','您确定要将\x20','querySelector','51260keGLnO','allWorldbooks','label','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20class=\x22hly-multiselect-option\x22\x20title=\x22','display','hly-current-character-name','此操作将彻底清空当前角色的所有忆识（向量），且无法恢复。您确定要继续吗？','beforeend','\x20个知识块。','hanlinyuan-ingest-novel-file-input',',\x20忆识总数=','totalVectors','\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22hly-kb-name\x22\x20title=\x22ID:\x20','\x20楼:\x20[','local','已选择\x20','fa-check-circle','change','hly-hist-entry-multiselect-options','fetchHLYEmbeddingModels','【手动存档】所有设定已存档封印。','totalSuccess','<option\x20value=\x22\x22>未找到匹配的书库</option>','preview-item-','hly-delete-rule-btn','\x20个知识库移动到【','apiKey','parse','getSettings','正在测试神力连接...','#hly-rules-list','checkbox','fetchEmbeddingModels','正在获取可用书库列表...','hly-kb-move-all-to-local','appendChild','知识库\x20','.hly-kb-name','preventDefault','hly-kb-bulk-actions-local','warn','加载书库列表失败:\x20','start','\x20条消息，开始凝识...','enabled','圣谕不明','\x20个知识库的状态。','purgeHLYStorage','手动录入失败:\x20','send_date','children','未找到符合条件的消息可供凝识。','allEntries','\x20的状态已切换','hly-worldbook-search','processCondensation','showHLYStats','遵命，将从头开始录入此书。','click','previousElementSibling','翰林院启奏','ingestHLYManualText','AbortError','》的批量编纂任务已完成。成功:\x20','\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<details\x20class=\x22hly-preview-details\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<summary\x20class=\x22hly-preview-summary\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20第\x20','.hly-hist-entry-checkbox:checked','boolean','批量移动失败:\x20','condensation','tagExtractionEnabled','hly-kb-select-all-global','localToGlobal','[自动保存]\x20设置项\x20\x27','切换知识库\x20','-tab','chat','className','\x20个局部知识库...','classList','hly-kb-list-global','您确定要永久删除【当前角色】的全部\x20','<option>获取失败</option>','totalChunks','\x20块开始。','.hly-hist-entry-checkbox','options','content',')\x20已被删除','hly-unified-template-notes','\x20个条目。','hly-include-user','</div>','hly-tag-input-container','action','hly-hist-select-library','input[name=\x22hly-unified-injection-position\x22]','end','.hly-kb-item-checkbox:checked','圣旨已达','customApiUrl','获取模型失败:\x20','getElementById','resetSettings','正在为《','\x0a\x20\x20\x20\x20\x20\x20\x20\x20<label\x20class=\x22hly-multiselect-option\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20id=\x22hly-hist-select-all-entries\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>全选/全不选</strong>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</label>','请至少选择一个知识库进行操作。','710916wDCmXY','manual','success','.hly-kb-item-checkbox','您确定要切换选中的\x20','remove','预览并编辑凝识内容','hly-rerank-enabled','局部知识库批量删除完成。成功:\x20','isSessionLocked','.position','删除失败:\x20','hly-kb-delete-btn','录入内容不能为空。','amily2_open_hanlin_tutorial','[翰林院-枢纽]\x20编纂过程发生严重错误:','\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20class=\x22hly-imperial-brush\x22\x20value=\x22','<p\x20class=\x22hly-notes\x20log-error\x22><i>加载失败:\x20','准备对《','\x20个局部知识库吗？此操作无法恢复！','94630JLPCaS','正在准备凝识...','querySelectorAll','根据当前勾选条件，未找到符合的消息可供预览。','layerStart','files','确认并更新预览','\x20(ID:\x20','<option\x20value=\x22\x22>请选择一个书库...</option>','hly-custom-api-url','updateHLYMemoryCount','fas\x20fa-lock-open','\x20个Rerank模型。','template','2PKrxSz','翰林院使用教程','》中的\x20','contains','2211930rMuWdG','批量\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22hly-exclusion-rules-container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22hly-notes\x22>在这里定义需要从提取内容中排除的文本片段。例如，排除HTML注释，可以设置开始字符为\x20`<!--`，结束字符为\x20`-->`。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22hly-rules-list\x22>','getLocalKnowledgeBases','fetchRerankModels','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20class=\x22hly-toggle-switch\x22\x20title=\x22启用/禁用此知识库\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20class=\x22hly-kb-toggle\x22\x20','凝识完成！新增\x20','hly-modal-container','\x20个知识库吗？此操作无法恢复！','span','findIndex','N/A','saveSettings','hly-current-vector-count','\x20个条目进行编纂...','startHLYHistoriography','hly-custom-endpoint-docket','）没有任何知识库可供移动。','stopPropagation','用户请求查看宝库状态。','queryMessageCount','<div\x20class=\x22hly-preview-container-v2\x22>','split','user','任务已由用户中止。进度已保存，可随时继续。','hanlinyuan-ingest-progress-bar','3246901siVvDH','fas\x20fa-lock','createElement','hly-embedding-model','input','ingestTextToHanlinyuan','hly-session-lock-btn','.hly-exclusion-rule-row','is-user','type','hly-hist-entry-multiselect-btn','未选择文件','includes','\x20操作失败:\x20','fetchHLYRerankModels'];_0x21f4=function(){return _0x4bd65b;};return _0x21f4();}function updateBulkActionUI(_0x1436f0){const _0x3167e2=_0x2eed1f,_0x4f763c=document[_0x3167e2(0x242)]('hly-kb-list-'+_0x1436f0),_0x51faf4=document[_0x3167e2(0x242)](_0x3167e2(0x177)+_0x1436f0),_0x28bdef=document[_0x3167e2(0x242)](_0x3167e2(0x1a2)+_0x1436f0),_0x16568e=_0x4f763c[_0x3167e2(0x25d)]('.hly-kb-item-checkbox'),_0x1d4f26=_0x4f763c[_0x3167e2(0x25d)](_0x3167e2(0x23e)),_0x5475f4=_0x1d4f26[_0x3167e2(0x1a7)],_0x4dca1e=_0x16568e['length'];_0x5475f4>0x0?_0x51faf4[_0x3167e2(0x191)][_0x3167e2(0x1e1)]='flex':_0x51faf4[_0x3167e2(0x191)][_0x3167e2(0x1e1)]='none';if(_0x4dca1e===0x0)_0x28bdef[_0x3167e2(0x13e)]=![],_0x28bdef[_0x3167e2(0x144)]=![];else{if(_0x5475f4===_0x4dca1e)_0x28bdef[_0x3167e2(0x13e)]=!![],_0x28bdef[_0x3167e2(0x144)]=![];else _0x5475f4>0x0?(_0x28bdef[_0x3167e2(0x13e)]=![],_0x28bdef[_0x3167e2(0x144)]=!![]):(_0x28bdef['checked']=![],_0x28bdef[_0x3167e2(0x144)]=![]);}}async function handleBulkAction(_0x365282,_0x4e2f4d){const _0x448508=_0x2eed1f,_0x12bb22=_0x365282['target'][_0x448508(0x13c)][_0x448508(0x23a)];if(!_0x12bb22)return;const _0x153e7e=document[_0x448508(0x242)](_0x448508(0x95)+_0x4e2f4d),_0xc58f95=_0x153e7e['querySelectorAll']('.hly-kb-item-checkbox:checked'),_0x7f5c9f=Array['from'](_0xc58f95)[_0x448508(0x1d8)](_0x4d0b01=>_0x4d0b01[_0x448508(0x13c)][_0x448508(0x1b5)]);if(_0x7f5c9f[_0x448508(0x1a7)]===0x0){toastr[_0x448508(0x17d)](_0x448508(0x246),'圣谕');return;}let _0x14ed29='',_0x4f55c4,_0x11f873='';switch(_0x12bb22){case _0x448508(0xad):_0x14ed29=_0x448508(0x93)+_0x7f5c9f[_0x448508(0x1a7)]+_0x448508(0x6c),_0x4f55c4=_0x4560b3=>_0x222c37[_0x448508(0xc8)](_0x4560b3,_0x4e2f4d),_0x11f873=_0x448508(0x190)+_0x7f5c9f[_0x448508(0x1a7)]+_0x448508(0xc9);break;case'move':const _0x5733e3=_0x4e2f4d===_0x448508(0x1eb)?'全局':'局部';_0x14ed29=_0x448508(0xd4)+_0x7f5c9f[_0x448508(0x1a7)]+_0x448508(0x1f6)+_0x5733e3+_0x448508(0x197),_0x4f55c4=_0x2b4301=>_0x222c37['moveKnowledgeBase'](_0x2b4301,_0x4e2f4d),_0x11f873=_0x448508(0x1ae)+_0x7f5c9f[_0x448508(0x1a7)]+_0x448508(0xc9);break;case _0x448508(0x1a6):_0x14ed29=_0x448508(0x24b)+_0x7f5c9f[_0x448508(0x1a7)]+'\x20个知识库的启用状态吗？',_0x4f55c4=_0x3bff37=>_0x222c37[_0x448508(0xf3)](_0x3bff37,_0x4e2f4d),_0x11f873='成功切换了\x20'+_0x7f5c9f[_0x448508(0x1a7)]+_0x448508(0x20b);break;default:return;}if(!confirm(_0x14ed29))return;toastr[_0x448508(0x1a4)](_0x448508(0xf9)+_0x7f5c9f[_0x448508(0x1a7)]+_0x448508(0x187),'圣旨'),log(_0x448508(0x1b8)+_0x7f5c9f[_0x448508(0x1a7)]+_0x448508(0x11d)+_0x4e2f4d+_0x448508(0xcc)+_0x12bb22+'\x20操作...',_0x448508(0x1a4));try{const _0x1c3098=_0x7f5c9f[_0x448508(0x1d8)](_0xfc1433=>_0x4f55c4(_0xfc1433));await Promise[_0x448508(0x160)](_0x1c3098),toastr[_0x448508(0x249)](_0x11f873,'大功告成'),log(_0x448508(0x26e)+_0x12bb22+'\x20操作成功。','success');}catch(_0x1999df){toastr[_0x448508(0xf4)](_0x448508(0xdd)+_0x1999df[_0x448508(0x13f)],'警报'),log(_0x448508(0x26e)+_0x12bb22+_0x448508(0x8b)+_0x1999df[_0x448508(0x13f)],_0x448508(0xf4));}finally{await updatePanelStatus();}}async function testApi(){const _0xbe698d=_0x2eed1f;toastr[_0xbe698d(0x1a4)](_0xbe698d(0x1fa),'圣旨');try{await _0x222c37[_0xbe698d(0x140)](),toastr[_0xbe698d(0x249)]('神力连接通畅！','圣意');}catch(_0x5b1913){toastr[_0xbe698d(0xf4)](_0xbe698d(0xe3)+_0x5b1913['message'],'警报');}}async function fetchHLYEmbeddingModels(){const _0x2df936=_0x2eed1f,_0x4b03dd=document[_0x2df936(0x242)](_0x2df936(0x81)),_0x5ef352=_0x4b03dd[_0x2df936(0x15e)];_0x4b03dd[_0x2df936(0x1d7)]=_0x2df936(0x1c2),_0x4b03dd[_0x2df936(0xd5)]=!![];try{log(_0x2df936(0x14f),_0x2df936(0x1a4));const _0x9d94e7=await _0x222c37[_0x2df936(0x1fd)]();_0x4b03dd[_0x2df936(0x1d7)]='';if(_0x9d94e7[_0x2df936(0x1a7)]===0x0){_0x4b03dd['innerHTML']=_0x2df936(0x184),toastr[_0x2df936(0x205)](_0x2df936(0x174),'翰林院启奏'),log('未能获取到任何模型。',_0x2df936(0x205));return;}_0x9d94e7[_0x2df936(0x1d2)](_0x37cceb=>{const _0x1b3e58=_0x2df936,_0x2979f5=new Option(_0x37cceb,_0x37cceb);_0x4b03dd[_0x1b3e58(0xe7)](_0x2979f5);}),_0x9d94e7[_0x2df936(0x8a)](_0x5ef352)?_0x4b03dd[_0x2df936(0x15e)]=_0x5ef352:_0x4b03dd['selectedIndex']=0x0,toastr[_0x2df936(0x249)](_0x2df936(0x9b)+_0x9d94e7[_0x2df936(0x1a7)]+_0x2df936(0x135),'圣意'),log(_0x2df936(0x9b)+_0x9d94e7[_0x2df936(0x1a7)]+_0x2df936(0x135),'success');}catch(_0x4d5db6){console[_0x2df936(0xf4)](_0x2df936(0xd1),_0x4d5db6),toastr[_0x2df936(0xf4)](_0x2df936(0x241)+_0x4d5db6[_0x2df936(0x13f)],'严重错误'),log(_0x2df936(0x241)+_0x4d5db6[_0x2df936(0x13f)],_0x2df936(0xf4)),_0x4b03dd[_0x2df936(0x1d7)]=_0x2df936(0x22e);}finally{_0x4b03dd[_0x2df936(0xd5)]=![];}}async function fetchHLYRerankModels(){const _0x5f25db=_0x2eed1f,_0xce3686=document[_0x5f25db(0x242)](_0x5f25db(0x17e)),_0x5a5c31=_0xce3686[_0x5f25db(0x15e)];_0xce3686[_0x5f25db(0x1d7)]=_0x5f25db(0x1c2),_0xce3686[_0x5f25db(0xd5)]=!![];try{log(_0x5f25db(0x168),_0x5f25db(0x1a4));const _0x26fbe7=await _0x222c37[_0x5f25db(0x68)]();_0xce3686[_0x5f25db(0x1d7)]='';if(_0x26fbe7[_0x5f25db(0x1a7)]===0x0){_0xce3686[_0x5f25db(0x1d7)]=_0x5f25db(0x184),toastr['warn'](_0x5f25db(0x120),_0x5f25db(0x219)),log(_0x5f25db(0x120),_0x5f25db(0x205));return;}_0x26fbe7['forEach'](_0x1afffd=>{const _0x3efd80=_0x5f25db,_0x5c9421=new Option(_0x1afffd,_0x1afffd);_0xce3686[_0x3efd80(0xe7)](_0x5c9421);}),_0x26fbe7['includes'](_0x5a5c31)?_0xce3686[_0x5f25db(0x15e)]=_0x5a5c31:_0xce3686[_0x5f25db(0x19c)]=0x0,toastr[_0x5f25db(0x249)](_0x5f25db(0x9b)+_0x26fbe7['length']+_0x5f25db(0x267),'圣意'),log('成功获取\x20'+_0x26fbe7['length']+_0x5f25db(0x267),_0x5f25db(0x249));}catch(_0x21817d){console[_0x5f25db(0xf4)](_0x5f25db(0xdc),_0x21817d),toastr[_0x5f25db(0xf4)](_0x5f25db(0x1bd)+_0x21817d['message'],_0x5f25db(0x128)),log('获取Rerank模型失败:\x20'+_0x21817d[_0x5f25db(0x13f)],'error'),_0xce3686[_0x5f25db(0x1d7)]=_0x5f25db(0x22e);}finally{_0xce3686['disabled']=![];}}async function purgeStorage(){const _0x4d5dbb=_0x2eed1f;if(confirm(_0x4d5dbb(0x1e3))){toastr['info'](_0x4d5dbb(0x13a),'圣旨');const _0x479d61=await _0x222c37[_0x4d5dbb(0x196)]();_0x479d61?toastr[_0x4d5dbb(0x249)](_0x4d5dbb(0x1d1),'圣意'):toastr[_0x4d5dbb(0xf4)](_0x4d5dbb(0x1a8),'警报'),await updatePanelStatus();}}async function startCondensation(){const _0x78f6f6=_0x2eed1f,_0x7f5150=document[_0x78f6f6(0x242)](_0x78f6f6(0x1b7)),_0x16aa89=_0x7f5150['dataset']['finalMessages'],_0x2493d9=document[_0x78f6f6(0x242)](_0x78f6f6(0x198))[_0x78f6f6(0x15e)],_0x5a4c9e=document[_0x78f6f6(0x242)](_0x78f6f6(0x10e))[_0x78f6f6(0x15e)],_0x4c7819={'start':parseInt(_0x2493d9),'end':parseInt(_0x5a4c9e)};try{let _0x407304;_0x16aa89?(log(_0x78f6f6(0x1d9),_0x78f6f6(0x1a4)),toastr[_0x78f6f6(0x1a4)]('正在处理您确认后的文书...','圣旨'),_0x407304=JSON[_0x78f6f6(0x1f8)](_0x16aa89),delete _0x7f5150[_0x78f6f6(0x13c)][_0x78f6f6(0xb6)]):(log('未检测到预览文本，按标准流程采集消息...',_0x78f6f6(0x1a4)),toastr[_0x78f6f6(0x1a4)](_0x78f6f6(0x25c),'圣旨'),_0x407304=_0x222c37['getMessagesForCondensation']());if(!_0x407304||_0x407304[_0x78f6f6(0x1a7)]===0x0){toastr['warning'](_0x78f6f6(0x210),'翰林院启奏'),_0x7f5150[_0x78f6f6(0x153)]=_0x78f6f6(0x94);return;}_0x7f5150[_0x78f6f6(0x153)]=_0x78f6f6(0xf8)+_0x407304[_0x78f6f6(0x1a7)]+_0x78f6f6(0x208),toastr[_0x78f6f6(0x1a4)](_0x78f6f6(0xf8)+_0x407304[_0x78f6f6(0x1a7)]+_0x78f6f6(0x208),_0x78f6f6(0x219));const _0x2c5614=await _0x222c37[_0x78f6f6(0x214)](_0x407304,log,_0x4c7819);if(_0x2c5614[_0x78f6f6(0x249)]){toastr['success'](_0x78f6f6(0x6a)+_0x2c5614[_0x78f6f6(0x165)]+'\x20条忆识。',_0x78f6f6(0x130));const _0x3a8224=_0x4c7819[_0x78f6f6(0x23d)]===0x0?getContext()['chat']['length']:_0x4c7819[_0x78f6f6(0x23d)];_0x7f5150[_0x78f6f6(0x153)]=_0x78f6f6(0x18d)+_0x4c7819['start']+_0x78f6f6(0x9f)+_0x3a8224+'\x20楼已成功凝识，新增\x20'+_0x2c5614[_0x78f6f6(0x165)]+'\x20条忆识。';}else throw new Error(_0x2c5614['error']||_0x78f6f6(0xc6));}catch(_0x401d6f){console[_0x78f6f6(0xf4)](_0x78f6f6(0x10d),_0x401d6f),toastr[_0x78f6f6(0xf4)](_0x78f6f6(0xea)+_0x401d6f[_0x78f6f6(0x13f)],'严重错误'),_0x7f5150[_0x78f6f6(0x153)]='凝识失败:\x20'+_0x401d6f[_0x78f6f6(0x13f)];}finally{await updatePanelStatus();}}async function loadWorldbookList(){const _0x4ddfab=_0x2eed1f,_0x3e818e=document[_0x4ddfab(0x242)]('hly-hist-select-library'),_0x341704=document[_0x4ddfab(0x242)](_0x4ddfab(0x213));if(!_0x3e818e)return;try{log(_0x4ddfab(0x1fe),_0x4ddfab(0x1a4));const _0x5ab26a=await _0x9d7bfc[_0x4ddfab(0x11a)]();window[_0x4ddfab(0x1de)]=_0x5ab26a,updateWorldbookOptions(_0x3e818e,'',_0x5ab26a);if(_0x341704){const _0xa075c6=debounce(_0x100bfc=>{updateWorldbookOptions(_0x3e818e,_0x100bfc,_0x5ab26a);},0x12c);_0x341704[_0x4ddfab(0x1cd)](_0x4ddfab(0x82),_0x4d8e13=>{const _0x577cdd=_0x4ddfab;_0xa075c6(_0x4d8e13[_0x577cdd(0x18a)]['value']);});}log(_0x4ddfab(0x15a)+_0x5ab26a['length']+_0x4ddfab(0xe2),'success');}catch(_0x14de0c){console[_0x4ddfab(0xf4)](_0x4ddfab(0xb3),_0x14de0c),log(_0x4ddfab(0x206)+_0x14de0c['message'],_0x4ddfab(0xf4)),_0x3e818e&&(_0x3e818e['innerHTML']=_0x4ddfab(0x115));}}function updateWorldbookOptions(_0x4ec42c,_0x595f76,_0x5b46c4){const _0x3730fd=_0x2eed1f,_0x243395=filterWorldbooks(_0x595f76,_0x5b46c4),_0x4db7f3=_0x4ec42c['value'];_0x4ec42c[_0x3730fd(0x1d7)]=_0x3730fd(0x263);if(_0x243395[_0x3730fd(0x1a7)]===0x0){_0x4ec42c['innerHTML']=_0x595f76[_0x3730fd(0x155)]()?_0x3730fd(0x1f3):'<option\x20value=\x22\x22>未找到任何书库</option>';return;}_0x243395[_0x3730fd(0x1d2)](_0xe4f61c=>{const _0x36060b=_0x3730fd,_0x86818e=document[_0x36060b(0x80)](_0x36060b(0x180));_0x86818e[_0x36060b(0x15e)]=_0xe4f61c,_0x86818e[_0x36060b(0x153)]=_0xe4f61c,_0x4ec42c[_0x36060b(0x200)](_0x86818e);}),_0x4db7f3&&_0x243395[_0x3730fd(0x8a)](_0x4db7f3)&&(_0x4ec42c[_0x3730fd(0x15e)]=_0x4db7f3);}async function handleWorldbookSelectionChange(){const _0x175f79=_0x2eed1f,_0x402c5d=document['getElementById'](_0x175f79(0x23b)),_0x1700cc=document['getElementById'](_0x175f79(0x88)),_0x1063f4=document[_0x175f79(0x242)](_0x175f79(0x1ef)),_0x4c0f43=document[_0x175f79(0x242)](_0x175f79(0xd7)),_0x572184=_0x402c5d[_0x175f79(0x15e)];_0x1700cc[_0x175f79(0xd5)]=!![],_0x1700cc[_0x175f79(0x1dc)](_0x175f79(0x6d))[_0x175f79(0x153)]='正在加载条目...',_0x1063f4['innerHTML']='',_0x1063f4['style']['display']=_0x175f79(0xc7);_0x4c0f43&&(_0x4c0f43[_0x175f79(0x15e)]='');if(!_0x572184){_0x1700cc['querySelector'](_0x175f79(0x6d))[_0x175f79(0x153)]=_0x175f79(0x164);return;}try{log(_0x175f79(0x244)+_0x572184+'》获取条目列表...',_0x175f79(0x1a4));const _0x21495e=await _0x9d7bfc[_0x175f79(0xca)](_0x572184);if(_0x21495e[_0x175f79(0x1a7)]===0x0){_0x1700cc[_0x175f79(0x1dc)](_0x175f79(0x6d))['textContent']=_0x175f79(0xba);return;}window[_0x175f79(0x211)]=_0x21495e,updateEntryOptions('',_0x21495e);if(_0x4c0f43){_0x4c0f43[_0x175f79(0x162)]('input',_0x4c0f43['_searchHandler']);const _0xa292ee=debounce(_0x341066=>{updateEntryOptions(_0x341066,_0x21495e);},0x12c);_0x4c0f43[_0x175f79(0x14c)]=_0x56a5dc=>{const _0x18de74=_0x175f79;_0xa292ee(_0x56a5dc['target'][_0x18de74(0x15e)]);},_0x4c0f43[_0x175f79(0x1cd)](_0x175f79(0x82),_0x4c0f43[_0x175f79(0x14c)]);}log(_0x175f79(0x15a)+_0x21495e[_0x175f79(0x1a7)]+_0x175f79(0x236),_0x175f79(0x249));}catch(_0x573c37){console['error'](_0x175f79(0x16b)+_0x572184+_0x175f79(0x12d),_0x573c37),log(_0x175f79(0xd0)+_0x573c37[_0x175f79(0x13f)],'error'),_0x1700cc[_0x175f79(0x1dc)](_0x175f79(0x6d))['textContent']=_0x175f79(0x137);}finally{_0x1700cc[_0x175f79(0xd5)]=![];}}function updateEntryOptions(_0xfc2738,_0xa1f5a3){const _0x492392=_0x2eed1f,_0x24f846=document[_0x492392(0x242)](_0x492392(0x1ef)),_0x16c3c8=document[_0x492392(0x242)](_0x492392(0x88)),_0x64b7b5=filterWorldbookEntries(_0xfc2738,_0xa1f5a3);_0x24f846['innerHTML']='';const _0x1e06a3=_0x492392(0x245);_0x24f846['insertAdjacentHTML'](_0x492392(0x1e4),_0x1e06a3);if(_0x64b7b5[_0x492392(0x1a7)]===0x0){const _0x38243e=_0x492392(0x14b);_0x24f846[_0x492392(0x138)](_0x492392(0x1e4),_0x38243e),_0x16c3c8[_0x492392(0x1dc)]('span')[_0x492392(0x153)]='未找到匹配的条目';return;}_0x64b7b5[_0x492392(0x1d2)](_0x58892f=>{const _0x39f282=_0x492392,_0x1eee41=_0xfc2738?highlightSearchMatch(_0x58892f[_0x39f282(0xce)],_0xfc2738):_0x58892f[_0x39f282(0xce)],_0x27e4fd=_0x39f282(0x1e0)+_0x58892f[_0x39f282(0xce)]+'\x20(Key:\x20'+_0x58892f['key']+_0x39f282(0x14d)+_0x58892f['key']+'\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span>'+_0x1eee41+'</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</label>';_0x24f846['insertAdjacentHTML'](_0x39f282(0x1e4),_0x27e4fd);}),_0x16c3c8[_0x492392(0x1dc)](_0x492392(0x6d))[_0x492392(0x153)]=_0x492392(0x156)+_0x64b7b5[_0x492392(0x1a7)]+_0x492392(0x15b);}async function startHistoriography(){const _0x3b0ecd=_0x2eed1f,_0x169685=document['getElementById'](_0x3b0ecd(0x23b))[_0x3b0ecd(0x15e)],_0x477509=document[_0x3b0ecd(0x242)](_0x3b0ecd(0x1ef)),_0x4c448d=document[_0x3b0ecd(0x242)](_0x3b0ecd(0x9a)),_0x22ce66=Array[_0x3b0ecd(0xc0)](_0x477509[_0x3b0ecd(0x25d)](_0x3b0ecd(0x21e)))[_0x3b0ecd(0x1d8)](_0x528e31=>_0x528e31[_0x3b0ecd(0x15e)]);if(!_0x169685||_0x22ce66['length']===0x0){toastr[_0x3b0ecd(0x17d)](_0x3b0ecd(0x11e),_0x3b0ecd(0x20a));return;}_0x4c448d[_0x3b0ecd(0x153)]=_0x3b0ecd(0x259)+_0x169685+_0x3b0ecd(0x26b)+_0x22ce66[_0x3b0ecd(0x1a7)]+'\x20个条目进行批量编纂...',toastr[_0x3b0ecd(0x1a4)](_0x3b0ecd(0x157),'圣旨'),log(_0x3b0ecd(0xff)+_0x169685+_0x3b0ecd(0x26b)+_0x22ce66[_0x3b0ecd(0x1a7)]+_0x3b0ecd(0x72),_0x3b0ecd(0x1a4));try{const _0x22261c=await _0x9d7bfc[_0x3b0ecd(0x1a3)](_0x169685,_0x22ce66);_0x4c448d[_0x3b0ecd(0x153)]=_0x22261c[_0x3b0ecd(0x233)],_0x22261c[_0x3b0ecd(0x249)]?toastr[_0x3b0ecd(0x249)](_0x3b0ecd(0x158),_0x3b0ecd(0x130)):toastr[_0x3b0ecd(0x17d)](_0x3b0ecd(0xaa),'圣谕'),log('对《'+_0x169685+_0x3b0ecd(0x21c)+_0x22261c[_0x3b0ecd(0x1f2)]+_0x3b0ecd(0x9c)+_0x22261c[_0x3b0ecd(0x1e8)],_0x3b0ecd(0x249));}catch(_0x4b1a9c){console[_0x3b0ecd(0xf4)](_0x3b0ecd(0x256),_0x4b1a9c),toastr[_0x3b0ecd(0xf4)](_0x3b0ecd(0xc5)+_0x4b1a9c[_0x3b0ecd(0x13f)],_0x3b0ecd(0x128)),_0x4c448d[_0x3b0ecd(0x153)]='编纂失败:\x20'+_0x4b1a9c[_0x3b0ecd(0x13f)];}finally{await updatePanelStatus();}}async function showStats(){const _0x337841=_0x2eed1f;try{log(_0x337841(0x77),_0x337841(0x1a4)),toastr[_0x337841(0x1a4)](_0x337841(0x1cc),'圣旨');const _0x116826=await _0x222c37[_0x337841(0xb8)](),_0x157490=await _0x222c37[_0x337841(0x154)](),_0x1eb939=_0x222c37[_0x337841(0x1f9)](),_0x328420=_0x337841(0xe1)+_0x157490+_0x337841(0x175)+_0x116826+'\x0a--------------------\x0aAPI端点:\x20'+_0x1eb939[_0x337841(0x99)][_0x337841(0xec)]+'\x0a所用模型:\x20'+_0x1eb939['retrieval']['embeddingModel']+_0x337841(0x142);toastr[_0x337841(0x1a4)](_0x328420,_0x337841(0x1b4),{'timeOut':0x3a98,'extendedTimeOut':0x1388,'tapToDismiss':!![],'closeButton':!![]}),log(_0x337841(0x166)+_0x157490+_0x337841(0x1e7)+_0x116826,_0x337841(0x249));}catch(_0x34738c){console['error'](_0x337841(0x114),_0x34738c),toastr[_0x337841(0xf4)](_0x337841(0x11c)+_0x34738c['message'],_0x337841(0x128)),log('查询宝库状态失败:\x20'+_0x34738c['message'],_0x337841(0xf4));}}function showExclusionRulesModal(){const _0x32ab6d=_0x2eed1f,_0x5e723f=_0x222c37[_0x32ab6d(0x1f9)](),_0x14b57c=_0x5e723f['condensation'][_0x32ab6d(0x1b2)]||[],_0x1c6bf7=(_0x1ddd98={'start':'','end':''},_0x296d64)=>_0x32ab6d(0xef)+_0x296d64+_0x32ab6d(0x257)+_0x1ddd98[_0x32ab6d(0x207)]+_0x32ab6d(0x171)+_0x1ddd98['end']+_0x32ab6d(0xf7),_0x44e1db=_0x14b57c['map'](_0x1c6bf7)[_0x32ab6d(0x127)](''),_0x1f94a1=_0x32ab6d(0x26f)+_0x44e1db+'</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20id=\x22hly-add-rule-btn\x22\x20class=\x22hly-action-button\x22\x20style=\x22margin-top:\x2010px;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<i\x20class=\x22fas\x20fa-plus\x22></i>\x20添加新规则\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.hly-exclusion-rule-row\x20{\x20display:\x20flex;\x20align-items:\x20center;\x20gap:\x2010px;\x20margin-bottom:\x2010px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.hly-exclusion-rule-row\x20input\x20{\x20flex-grow:\x201;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.hly-delete-rule-btn\x20{\x20background:\x20#c0392b;\x20color:\x20white;\x20border:\x20none;\x20border-radius:\x2050%;\x20width:\x2024px;\x20height:\x2024px;\x20cursor:\x20pointer;\x20font-size:\x2016px;\x20line-height:\x2024px;\x20text-align:\x20center;\x20padding:\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20</style>\x0a\x20\x20\x20\x20';showHtmlModal(_0x32ab6d(0x172),_0x1f94a1,{'okText':'保存规则','onOk':_0xdb5aa9=>{const _0x493885=_0x32ab6d,_0x26ae04=[];_0xdb5aa9[_0x493885(0xcf)](_0x493885(0x85))[_0x493885(0xcb)](function(){const _0x3f33df=_0x493885,_0x29755d=$(this)[_0x3f33df(0xcf)](_0x3f33df(0x82))['eq'](0x0)[_0x3f33df(0xd3)]()[_0x3f33df(0x155)](),_0x37503d=$(this)[_0x3f33df(0xcf)](_0x3f33df(0x82))['eq'](0x1)[_0x3f33df(0xd3)]()[_0x3f33df(0x155)]();_0x29755d&&_0x37503d&&_0x26ae04[_0x3f33df(0x1af)]({'start':_0x29755d,'end':_0x37503d});}),updateAndSaveSetting(_0x493885(0x90),_0x26ae04),toastr[_0x493885(0x249)](_0x493885(0xd8),'圣旨已达');}});const _0x1e4bad=document[_0x32ab6d(0x242)]('hly-exclusion-rules-container'),_0x9890d4=_0x1e4bad[_0x32ab6d(0x1dc)](_0x32ab6d(0x1fb));_0x1e4bad[_0x32ab6d(0x1dc)]('#hly-add-rule-btn')[_0x32ab6d(0x1cd)](_0x32ab6d(0x217),()=>{const _0x5ca979=_0x32ab6d,_0x480e4c=_0x9890d4[_0x5ca979(0x20f)][_0x5ca979(0x1a7)],_0x52221b=_0x1c6bf7({'start':'','end':''},_0x480e4c);_0x9890d4['insertAdjacentHTML'](_0x5ca979(0x1e4),_0x52221b);}),_0x9890d4['addEventListener'](_0x32ab6d(0x217),_0x51a1b7=>{const _0x28f04f=_0x32ab6d;_0x51a1b7[_0x28f04f(0x18a)][_0x28f04f(0x22b)][_0x28f04f(0x26c)](_0x28f04f(0x1f5))&&_0x51a1b7['target'][_0x28f04f(0x10f)](_0x28f04f(0x85))['remove']();});}function previewCondensation(){const _0x207657=_0x2eed1f,_0x4d4764=document['getElementById']('hly-condensation-results');try{const _0x5b6603=_0x222c37[_0x207657(0x1f9)](),_0x1a9c66=_0x5b6603[_0x207657(0x221)][_0x207657(0x1b2)]||[],_0x25529f={'user':document[_0x207657(0x242)](_0x207657(0x237))[_0x207657(0x13e)],'ai':document['getElementById'](_0x207657(0x146))[_0x207657(0x13e)]},_0x4b335a=document[_0x207657(0x242)](_0x207657(0xeb))[_0x207657(0x13e)],_0x1cb4ab=_0x4b335a?document[_0x207657(0x242)](_0x207657(0x12f))[_0x207657(0x15e)][_0x207657(0x7a)](',')[_0x207657(0x1d8)](_0x47820b=>_0x47820b[_0x207657(0x155)]())[_0x207657(0x161)](Boolean):[],_0x5e613d=_0x222c37[_0x207657(0xd9)](_0x25529f);if(!_0x5e613d||_0x5e613d[_0x207657(0x1a7)]===0x0){_0x4d4764[_0x207657(0x153)]=_0x207657(0x25e),toastr[_0x207657(0x17d)](_0x207657(0x94),'翰林院启奏');return;}const _0x5dca39=getContext()[_0x207657(0x228)],_0x39f938=_0x5e613d[_0x207657(0x1d8)]((_0x16b342,_0x3da0c8)=>{const _0x27c412=_0x207657;let _0x41cf85;if(_0x16b342[_0x27c412(0xb9)])_0x41cf85=_0x16b342[_0x27c412(0x1da)];else{if(_0x4b335a&&_0x1cb4ab[_0x27c412(0x1a7)]>0x0){const _0x36797b=extractBlocksByTags(_0x16b342['mes'],_0x1cb4ab);_0x41cf85=_0x36797b['join']('\x0a\x0a');}else _0x41cf85=_0x16b342[_0x27c412(0x1da)];_0x41cf85=applyExclusionRules(_0x41cf85,_0x1a9c66);}const _0x5b7eb7=_0x5dca39[_0x27c412(0x6e)](_0x5e2b21=>_0x5e2b21===_0x16b342),_0x12b576=_0x5b7eb7!==-0x1?_0x5b7eb7+0x1:-0x1;return{'id':_0x27c412(0x1f4)+_0x3da0c8,'name':_0x16b342[_0x27c412(0x113)],'content':_0x41cf85[_0x27c412(0x155)](),'floor':_0x12b576,'is_user':_0x16b342[_0x27c412(0xb9)],'send_date':_0x16b342[_0x27c412(0x20e)]};})['filter'](_0x50b0d6=>_0x50b0d6[_0x207657(0x233)]);if(_0x39f938[_0x207657(0x1a7)]===0x0){_0x4d4764[_0x207657(0x153)]=_0x207657(0xf2),toastr['warning'](_0x207657(0xf2),_0x207657(0x219));return;}const _0x19a03f=_0x39f938['map']((_0x2bb6c3,_0x5291a7)=>_0x207657(0xbc)+_0x2bb6c3['id']+_0x207657(0x21d)+_0x2bb6c3[_0x207657(0x1bb)]+_0x207657(0x1ea)+_0x2bb6c3['name']+']\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</summary>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-preview-content\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<textarea\x20class=\x22hly-preview-textarea\x22\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20data-floor=\x22'+_0x2bb6c3[_0x207657(0x1bb)]+_0x207657(0xd6)+_0x2bb6c3[_0x207657(0xb9)]+_0x207657(0x1ab)+_0x2bb6c3[_0x207657(0x20e)]+'\x22>'+_0x2bb6c3[_0x207657(0x233)]+_0x207657(0x192)+_0x2bb6c3['id']+'\x22\x20title=\x22删除此条\x22>&times;</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20')['join']('');showHtmlModal(_0x207657(0x24d),_0x207657(0x79)+_0x19a03f+_0x207657(0x238),{'okText':_0x207657(0x261),'onOk':_0x2b44cf=>{const _0x5861eb=_0x207657,_0xc1bbf0=[];_0x2b44cf[_0x5861eb(0xcf)](_0x5861eb(0x105))[_0x5861eb(0xcb)](function(){const _0x10effb=_0x5861eb,_0x9328c8=$(this)[_0x10effb(0xcf)](_0x10effb(0xac)),_0x245ad5=_0x9328c8[_0x10effb(0xd3)]();_0x245ad5[_0x10effb(0x155)]()&&_0xc1bbf0[_0x10effb(0x1af)]({'mes':_0x245ad5,'is_user':_0x9328c8[_0x10effb(0x1d4)](_0x10effb(0x86)),'send_date':_0x9328c8[_0x10effb(0x1d4)](_0x10effb(0xae)),'floor':_0x9328c8[_0x10effb(0x1d4)](_0x10effb(0x1bb))});}),_0x4d4764[_0x5861eb(0x13c)]['finalMessages']=JSON['stringify'](_0xc1bbf0);const _0x426010=document[_0x5861eb(0x242)](_0x5861eb(0x198))[_0x5861eb(0x15e)],_0x26bea6=document['getElementById'](_0x5861eb(0x10e))['value'];_0x4d4764[_0x5861eb(0x153)]=_0x5861eb(0x1ec)+_0x426010+_0x5861eb(0x1d6)+_0x26bea6+'\x20楼的内容（共\x20'+_0xc1bbf0['length']+'\x20条有效条目），请点击“开始凝识”进入自动向量化流程。',toastr[_0x5861eb(0x249)]('预览内容已更新，可随时开始凝识。',_0x5861eb(0x23f));}}),$(_0x207657(0x1ca))['on'](_0x207657(0x217),function(_0x4c15f4){const _0x3e6675=_0x207657;_0x4c15f4[_0x3e6675(0x203)]();const _0x5984b8=$(this)[_0x3e6675(0x1d4)](_0x3e6675(0x18a));$('#'+_0x5984b8)['remove']();});}catch(_0x5f0086){console[_0x207657(0xf4)](_0x207657(0xab),_0x5f0086),_0x4d4764[_0x207657(0x153)]=_0x207657(0x148)+_0x5f0086[_0x207657(0x13f)],toastr['error'](_0x207657(0x148)+_0x5f0086[_0x207657(0x13f)],_0x207657(0x128));}}function _0x91bf(_0x4a7f01,_0x560610){const _0x21f4d0=_0x21f4();return _0x91bf=function(_0x91bfea,_0x3f1dca){_0x91bfea=_0x91bfea-0x67;let _0x4f33ea=_0x21f4d0[_0x91bfea];return _0x4f33ea;},_0x91bf(_0x4a7f01,_0x560610);}function log(_0x1da166,_0x1fed3c=_0x2eed1f(0x1a4)){const _0x6d1cee=_0x2eed1f,_0x246421=document[_0x6d1cee(0x242)](_0x6d1cee(0xfb));if(!_0x246421)return;const _0x2091f7=document[_0x6d1cee(0x80)]('p'),_0x298dc3=new Date()[_0x6d1cee(0x110)]();let _0x44484f='fa-circle-info',_0x26ff05='log-info';switch(_0x1fed3c){case _0x6d1cee(0x249):_0x44484f=_0x6d1cee(0x1ed),_0x26ff05=_0x6d1cee(0x1b9);break;case _0x6d1cee(0xf4):_0x44484f=_0x6d1cee(0x1ac),_0x26ff05='log-error';break;case _0x6d1cee(0x205):_0x44484f='fa-exclamation-triangle',_0x26ff05='log-warn';break;}_0x2091f7[_0x6d1cee(0x229)]=_0x6d1cee(0x16f)+_0x26ff05,_0x2091f7['innerHTML']='<i\x20class=\x22fa-solid\x20'+_0x44484f+_0x6d1cee(0x8e)+_0x298dc3+']\x20'+_0x1da166;const _0x160c84=_0x246421[_0x6d1cee(0x1dc)](_0x6d1cee(0x103));_0x160c84&&_0x160c84[_0x6d1cee(0x24c)](),_0x246421[_0x6d1cee(0x200)](_0x2091f7),_0x246421[_0x6d1cee(0x1c7)]=_0x246421[_0x6d1cee(0x16c)];}async function ingestManualText(){const _0x454510=_0x2eed1f,_0x3306f0=document[_0x454510(0x242)](_0x454510(0x1cf)),_0x26ad5d=_0x3306f0[_0x454510(0x15e)][_0x454510(0x155)]();if(!_0x26ad5d){toastr[_0x454510(0x17d)](_0x454510(0x254),'翰林院启奏'),log(_0x454510(0x116),_0x454510(0x205));return;}log(_0x454510(0xfe)+_0x26ad5d['length'],_0x454510(0x1a4)),toastr[_0x454510(0x1a4)](_0x454510(0x9d),'圣旨');try{const _0x204c99=await _0x222c37[_0x454510(0x83)](_0x26ad5d,_0x454510(0x248),{'sourceName':_0x454510(0xda)});if(_0x204c99[_0x454510(0x249)])toastr[_0x454510(0x249)](_0x454510(0x121)+_0x204c99[_0x454510(0x165)]+_0x454510(0x91),_0x454510(0x130)),log('手动录入成功，新增\x20'+_0x204c99[_0x454510(0x165)]+'\x20条忆识。',_0x454510(0x249)),_0x3306f0[_0x454510(0x15e)]='';else throw new Error(_0x204c99['error']||_0x454510(0xc6));}catch(_0x2e850d){console[_0x454510(0xf4)](_0x454510(0x169),_0x2e850d),toastr[_0x454510(0xf4)](_0x454510(0x1c6)+_0x2e850d[_0x454510(0x13f)],_0x454510(0x128)),log(_0x454510(0x20d)+_0x2e850d[_0x454510(0x13f)],_0x454510(0xf4));}finally{await updatePanelStatus();}}
