const _0x49cd00=_0x17c8;(function(_0x2d82bd,_0x1f66c9){const _0x469219=_0x17c8,_0x52b6d9=_0x2d82bd();while(!![]){try{const _0x2b093b=parseInt(_0x469219(0x343))/0x1*(parseInt(_0x469219(0x227))/0x2)+-parseInt(_0x469219(0x1bc))/0x3+parseInt(_0x469219(0x34f))/0x4+-parseInt(_0x469219(0x35d))/0x5+-parseInt(_0x469219(0x252))/0x6+-parseInt(_0x469219(0x25a))/0x7+-parseInt(_0x469219(0x303))/0x8*(-parseInt(_0x469219(0x318))/0x9);if(_0x2b093b===_0x1f66c9)break;else _0x52b6d9['push'](_0x52b6d9['shift']());}catch(_0x254785){_0x52b6d9['push'](_0x52b6d9['shift']());}}}(_0x33b8,0xd3172));import{getContext}from'/scripts/extensions.js';import*as _0x2b0a92 from'../core/rag-processor.js';import*as _0x5daeb7 from'../core/historiographer.js';function _0x17c8(_0x2e76eb,_0x5a1ac4){const _0x33b862=_0x33b8();return _0x17c8=function(_0x17c87b,_0x5de401){_0x17c87b=_0x17c87b-0x1ad;let _0x4fd4d2=_0x33b862[_0x17c87b];return _0x4fd4d2;},_0x17c8(_0x2e76eb,_0x5a1ac4);}import*as _0x20c628 from'../core/utils/context-utils.js';import*as _0x1eb5f8 from'../core/ingestion-manager.js';import{showContentModal,showHtmlModal}from'./page-window.js';import{extractBlocksByTags,applyExclusionRules}from'../core/utils/rag-tag-extractor.js';_0x49cd00(0x1e6);function setupGlobalEventHandlers(){const _0x328826=_0x49cd00;window[_0x328826(0x2ee)]=()=>saveSettingsFromUI(![]),window[_0x328826(0x27a)]=resetSettingsToUI,window[_0x328826(0x348)]=testApi,window['fetchHLYEmbeddingModels']=fetchHLYEmbeddingModels,window[_0x328826(0x2f8)]=fetchHLYRerankModels,window[_0x328826(0x1d7)]=updatePanelStatus,window['purgeHLYStorage']=purgeStorage,window['startHLYCondensation']=startCondensation,window[_0x328826(0x23d)]=previewCondensation,window[_0x328826(0x350)]=ingestManualText,window[_0x328826(0x2df)]=log,window[_0x328826(0x2a1)]=showStats,window['startHLYHistoriography']=startHistoriography;}function updateAndSaveSetting(_0x14b9ec,_0x31e86d){const _0x35b758=_0x49cd00,_0x2e52db=_0x2b0a92['getSettings']();if(!_0x2e52db)return;const _0x2e7fd7=_0x14b9ec['split']('.');let _0x4fcbcf=_0x2e52db;for(let _0x30a27b=0x0;_0x30a27b<_0x2e7fd7[_0x35b758(0x2d2)]-0x1;_0x30a27b++){_0x4fcbcf=_0x4fcbcf[_0x2e7fd7[_0x30a27b]]=_0x4fcbcf[_0x2e7fd7[_0x30a27b]]||{};}_0x4fcbcf[_0x2e7fd7[_0x2e7fd7[_0x35b758(0x2d2)]-0x1]]=_0x31e86d,_0x2b0a92[_0x35b758(0x375)](),log(_0x35b758(0x21f)+_0x14b9ec+_0x35b758(0x23e)+JSON['stringify'](_0x31e86d),_0x35b758(0x2b3));}function bindAutoSaveEvents(){const _0x56a691=_0x49cd00,_0x1d0b27=document['getElementById'](_0x56a691(0x283));if(!_0x1d0b27)return;_0x1d0b27[_0x56a691(0x266)]('change',_0x401242=>{const _0x42d17d=_0x56a691,_0x1a42de=_0x401242[_0x42d17d(0x1e0)],_0x52abe2=_0x1a42de[_0x42d17d(0x2b6)][_0x42d17d(0x1c1)];if(!_0x52abe2)return;let _0x4e5022;const _0x24bdd3=_0x1a42de[_0x42d17d(0x2b6)][_0x42d17d(0x32f)]||_0x42d17d(0x2e6);if(_0x1a42de[_0x42d17d(0x32f)]===_0x42d17d(0x364))_0x4e5022=_0x1a42de[_0x42d17d(0x214)];else{if(_0x1a42de[_0x42d17d(0x32f)]===_0x42d17d(0x26e)){if(_0x1a42de[_0x42d17d(0x214)]){const _0x4ec102=_0x1d0b27['querySelectorAll'](_0x42d17d(0x236)+_0x1a42de[_0x42d17d(0x326)]+'\x22]'),_0x3b8dff=Array[_0x42d17d(0x33f)](_0x4ec102)['find'](_0xd51044=>_0xd51044[_0x42d17d(0x214)]);_0x4e5022=_0x3b8dff[_0x42d17d(0x2b4)];}else return;}else _0x4e5022=_0x1a42de[_0x42d17d(0x2b4)];}switch(_0x24bdd3){case'integer':_0x4e5022=parseInt(_0x4e5022,0xa);break;case'float':_0x4e5022=parseFloat(_0x4e5022);break;case'boolean':typeof _0x4e5022!==_0x42d17d(0x243)&&(_0x4e5022=_0x4e5022==='true');break;}if(_0x1a42de['type']===_0x42d17d(0x26e)&&!_0x1a42de['checked'])return;updateAndSaveSetting(_0x52abe2,_0x4e5022);});}export function bindHanlinyuanEvents(){const _0x3c9eab=_0x49cd00,_0x19115b=getContext();if(!_0x19115b){console[_0x3c9eab(0x2e1)]('[翰林院-枢纽]\x20未能获取SillyTavern上下文，绑定失败。');return;}setupGlobalEventHandlers(),bindPanelToggleEvents(),bindInternalUIEvents(),bindTutorialEvents(),bindAutoSaveEvents(),bindSessionLockEvent();if(_0x2b0a92['initialize'])_0x2b0a92[_0x3c9eab(0x32d)]();else{console[_0x3c9eab(0x2e1)](_0x3c9eab(0x293));return;}loadSettingsToUI(),loadWorldbookList(),log(_0x3c9eab(0x31a),'info');const _0x2ca525=document[_0x3c9eab(0x232)](_0x3c9eab(0x2cd)),_0x33b365=document['getElementById']('hanlinyuan-ingest-novel-file-name'),_0x18032f=document[_0x3c9eab(0x232)](_0x3c9eab(0x24f)),_0x4abd8d=document[_0x3c9eab(0x232)](_0x3c9eab(0x285)),_0x1cbb50=document[_0x3c9eab(0x232)](_0x3c9eab(0x213)),_0x9a0373=document['getElementById'](_0x3c9eab(0x31b)),_0x244108=document[_0x3c9eab(0x232)]('hanlinyuan-ingest-status'),_0x49e900=document['getElementById'](_0x3c9eab(0x257));let _0x51fb90=null,_0x216b7b=null;_0x2ca525[_0x3c9eab(0x266)](_0x3c9eab(0x20f),_0x568d82=>{const _0x727cf1=_0x3c9eab;_0x51fb90=_0x568d82[_0x727cf1(0x1e0)][_0x727cf1(0x249)][0x0],_0x51fb90?(_0x33b365[_0x727cf1(0x1fb)]=_0x51fb90['name'],_0x33b365[_0x727cf1(0x251)]=_0x51fb90['name']):_0x33b365[_0x727cf1(0x1fb)]=_0x727cf1(0x23c);}),_0x18032f[_0x3c9eab(0x266)](_0x3c9eab(0x2c2),async()=>{const _0x43414e=_0x3c9eab;if(!_0x51fb90){toastr[_0x43414e(0x1c9)](_0x43414e(0x330));return;}let _0xc63a76=0x0;const _0x227adc=_0x1eb5f8['generateJobId'](_0x51fb90),_0x332fca=_0x1eb5f8[_0x43414e(0x289)](_0x227adc);if(_0x332fca){const _0x47cf92=(_0x332fca['processedChunks']/_0x332fca['totalChunks']*0x64)[_0x43414e(0x1b3)](0x1),_0x5e8f45=confirm(_0x43414e(0x28e)+_0x47cf92+_0x43414e(0x1c5));_0x5e8f45?(_0xc63a76=_0x332fca[_0x43414e(0x2fd)],toastr[_0x43414e(0x1be)](_0x43414e(0x2fe)+(_0xc63a76+0x1)+_0x43414e(0x300),'圣旨已达'),log(_0x43414e(0x1f1)+_0x227adc+_0x43414e(0x26a)+_0xc63a76+_0x43414e(0x1b0),_0x43414e(0x1be))):(_0x1eb5f8[_0x43414e(0x215)](_0x227adc),toastr[_0x43414e(0x1be)](_0x43414e(0x1ae),_0x43414e(0x34d)),log(_0x43414e(0x20a)+_0x227adc+_0x43414e(0x1b6),_0x43414e(0x329)));}_0x216b7b=new AbortController();const _0x5730b1=_0x216b7b[_0x43414e(0x245)];_0x49e900['style']['display']=_0x43414e(0x33e),_0x1cbb50[_0x43414e(0x230)][_0x43414e(0x247)]=_0x43414e(0x2a8),_0x244108['textContent']=_0x43414e(0x345),_0x9a0373[_0x43414e(0x2b4)]=0x0;try{const _0x3b1ac1=await _0x51fb90[_0x43414e(0x2d6)](),_0x48fe72=_0x568118=>{const _0x22d9fd=_0x43414e;_0x244108[_0x22d9fd(0x1fb)]=_0x22d9fd(0x323)+_0x568118[_0x22d9fd(0x27d)]+'\x20('+_0x568118['processed']+'/'+_0x568118[_0x22d9fd(0x1ea)]+')',_0x9a0373[_0x22d9fd(0x2b4)]=_0x568118['processed']/_0x568118[_0x22d9fd(0x1ea)]*0x64;},_0x2285d7=()=>{const _0x135f9b=_0x43414e;updatePanelStatus(),log(_0x135f9b(0x2eb),'info');},_0x10c9e7=await _0x2b0a92[_0x43414e(0x309)](_0x3b1ac1,_0x43414e(0x203),{'sourceName':_0x51fb90[_0x43414e(0x326)]},_0x48fe72,_0x5730b1,log,_0x2285d7,_0x227adc,_0xc63a76);if(_0x10c9e7[_0x43414e(0x2b3)])toastr[_0x43414e(0x2b3)](_0x43414e(0x377)+_0x10c9e7[_0x43414e(0x314)]+'\x20个知识块'),_0x244108['textContent']=_0x43414e(0x1f7)+_0x10c9e7[_0x43414e(0x314)]+_0x43414e(0x295),_0x9a0373[_0x43414e(0x2b4)]=0x64,updatePanelStatus();else throw new Error(_0x10c9e7['error']||_0x43414e(0x307));}catch(_0x108dbc){_0x108dbc['name']==='AbortError'?(toastr[_0x43414e(0x1be)](_0x43414e(0x372)),_0x244108[_0x43414e(0x1fb)]='任务已中止。'):(toastr['error'](_0x43414e(0x1f0)+_0x108dbc[_0x43414e(0x27d)]+'。进度已保存，可稍后重试。'),_0x244108[_0x43414e(0x1fb)]=_0x43414e(0x2de)+_0x108dbc['message']);}finally{setTimeout(()=>{const _0xd73a62=_0x43414e;_0x49e900[_0xd73a62(0x230)]['display']=_0xd73a62(0x1c2),_0x1cbb50['style'][_0xd73a62(0x247)]=_0xd73a62(0x33e),_0x2ca525['value']='',_0x51fb90=null,_0x33b365['textContent']='未选择文件';},0xbb8);}}),_0x4abd8d[_0x3c9eab(0x266)](_0x3c9eab(0x2c2),()=>{const _0x150dfd=_0x3c9eab;_0x216b7b&&_0x216b7b[_0x150dfd(0x22b)]();});}function bindSessionLockEvent(){const _0x4e1b3e=_0x49cd00,_0x135bca=document['getElementById'](_0x4e1b3e(0x2d5));if(!_0x135bca)return;_0x135bca['addEventListener'](_0x4e1b3e(0x2c2),async()=>{const _0x499e0f=_0x4e1b3e,_0x2e7ae6=await _0x2b0a92[_0x499e0f(0x21d)]();updateSessionLockUI(_0x2e7ae6);if(_0x2e7ae6){const _0x184f9d=_0x2b0a92[_0x499e0f(0x1f3)]();_0x184f9d&&(toastr[_0x499e0f(0x2b3)](_0x499e0f(0x351)+_0x184f9d['id'],'圣旨已下'),log('会话已锁定到宝库:\x20'+_0x184f9d['id'],_0x499e0f(0x2b3)));}else toastr[_0x499e0f(0x1be)](_0x499e0f(0x320),'诏曰'),log(_0x499e0f(0x355),'info');updatePanelStatus();}),updateSessionLockUI(_0x2b0a92[_0x4e1b3e(0x1dd)]());}function updateSessionLockUI(_0x4d6c18){const _0x36e3a4=_0x49cd00,_0x51eabb=document[_0x36e3a4(0x232)](_0x36e3a4(0x2d5));if(!_0x51eabb)return;const _0x263e16=_0x51eabb[_0x36e3a4(0x1e2)]('i'),_0x4f8867=_0x51eabb[_0x36e3a4(0x1e2)](_0x36e3a4(0x352));_0x4d6c18?(_0x51eabb['classList'][_0x36e3a4(0x311)]('active'),_0x263e16['className']=_0x36e3a4(0x1bb),_0x4f8867[_0x36e3a4(0x1fb)]=_0x36e3a4(0x306),_0x51eabb[_0x36e3a4(0x251)]=_0x36e3a4(0x27c)):(_0x51eabb[_0x36e3a4(0x33c)][_0x36e3a4(0x34b)](_0x36e3a4(0x36b)),_0x263e16[_0x36e3a4(0x2b9)]=_0x36e3a4(0x240),_0x4f8867[_0x36e3a4(0x1fb)]=_0x36e3a4(0x304),_0x51eabb[_0x36e3a4(0x251)]=_0x36e3a4(0x36a));}function bindPanelToggleEvents(){const _0x1c9a89=_0x49cd00,_0x2c910a=document[_0x1c9a89(0x232)]('amily2_open_rag_palace');if(_0x2c910a){}}function bindTutorialEvents(){const _0xb872a4=_0x49cd00,_0x2942a7=document[_0xb872a4(0x232)](_0xb872a4(0x2ef));_0x2942a7&&_0x2942a7['addEventListener']('click',()=>{const _0x4870a6=_0xb872a4;showContentModal(_0x4870a6(0x2e9),_0x4870a6(0x31f));});}function bindInternalUIEvents(){const _0x2c706d=_0x49cd00,_0xad30e0=document[_0x2c706d(0x223)]('.hly-nav-item');_0xad30e0[_0x2c706d(0x23b)](_0x1e3183=>{const _0x10239b=_0x2c706d;_0x1e3183[_0x10239b(0x266)](_0x10239b(0x2c2),()=>{const _0x2b8b46=_0x10239b,_0x50f8fb=_0x1e3183['dataset'][_0x2b8b46(0x371)],_0xa49170=_0x2b8b46(0x202)+_0x50f8fb+_0x2b8b46(0x1d0);document[_0x2b8b46(0x223)](_0x2b8b46(0x1da))[_0x2b8b46(0x23b)](_0x1cc89e=>{const _0x1ac66a=_0x2b8b46;_0x1cc89e[_0x1ac66a(0x33c)]['toggle']('active',_0x1cc89e['id']===_0xa49170);}),_0xad30e0[_0x2b8b46(0x23b)](_0x5a0b68=>_0x5a0b68[_0x2b8b46(0x33c)][_0x2b8b46(0x29d)](_0x2b8b46(0x36b),_0x5a0b68===_0x1e3183));});});const _0x4c733f=document['getElementById'](_0x2c706d(0x284));_0x4c733f&&_0x4c733f[_0x2c706d(0x266)](_0x2c706d(0x20f),handleApiModeChange);const _0x254b35=document['querySelectorAll']('input[name=\x22hly-injection-position\x22]');_0x254b35[_0x2c706d(0x23b)](_0x55b9cf=>{const _0x14eae1=_0x2c706d;_0x55b9cf['addEventListener'](_0x14eae1(0x20f),toggleInjectionDetails);});const _0x429533=document[_0x2c706d(0x232)](_0x2c706d(0x1b4)),_0x301d28=document[_0x2c706d(0x232)](_0x2c706d(0x256));_0x429533&&_0x301d28&&_0x429533[_0x2c706d(0x266)](_0x2c706d(0x20f),()=>{const _0x394315=_0x2c706d;_0x301d28[_0x394315(0x230)][_0x394315(0x247)]=_0x429533['checked']?_0x394315(0x2a8):'none';});const _0x4b0ff7=document[_0x2c706d(0x232)](_0x2c706d(0x2b8));_0x4b0ff7&&_0x4b0ff7[_0x2c706d(0x266)](_0x2c706d(0x20f),handleWorldbookSelectionChange);const _0xbbbc0f=document[_0x2c706d(0x232)]('hly-exclusion-rules-btn');_0xbbbc0f&&_0xbbbc0f['addEventListener']('click',showExclusionRulesModal);const _0x1ab1d6=document[_0x2c706d(0x232)](_0x2c706d(0x2da)),_0x2795a0=document['getElementById'](_0x2c706d(0x204));_0x1ab1d6&&_0x2795a0&&(_0x1ab1d6[_0x2c706d(0x266)](_0x2c706d(0x2c2),_0x5d09b6=>{const _0xf6a880=_0x2c706d;_0x5d09b6[_0xf6a880(0x338)]();const _0x4e6b0a=_0x2795a0[_0xf6a880(0x230)][_0xf6a880(0x247)]===_0xf6a880(0x2a8);_0x2795a0[_0xf6a880(0x230)][_0xf6a880(0x247)]=_0x4e6b0a?_0xf6a880(0x33e):_0xf6a880(0x2a8);}),_0x2795a0[_0x2c706d(0x266)](_0x2c706d(0x20f),_0x150fe4=>{const _0x28be65=_0x2c706d,_0x1ef7f1=_0x150fe4['target'];if(_0x1ef7f1['type']!==_0x28be65(0x364))return;const _0x25a63e=_0x2795a0[_0x28be65(0x223)]('.hly-hist-entry-checkbox'),_0x3f09c4=document['getElementById'](_0x28be65(0x22d));if(_0x1ef7f1['id']==='hly-hist-select-all-entries')_0x25a63e[_0x28be65(0x23b)](_0x59384f=>_0x59384f[_0x28be65(0x214)]=_0x1ef7f1[_0x28be65(0x214)]);else{const _0x2d492a=Array['from'](_0x25a63e)['every'](_0x13a8d2=>_0x13a8d2['checked']);_0x3f09c4[_0x28be65(0x214)]=_0x2d492a;}const _0x2e054a=_0x2795a0[_0x28be65(0x223)](_0x28be65(0x1b5))[_0x28be65(0x2d2)],_0xf465b4=_0x25a63e[_0x28be65(0x2d2)];_0x1ab1d6[_0x28be65(0x1e2)](_0x28be65(0x352))['textContent']=_0x28be65(0x34a)+_0x2e054a+_0x28be65(0x1af)+_0xf465b4+'\x20个条目';}),document['addEventListener'](_0x2c706d(0x2c2),_0x309f34=>{const _0x33a704=_0x2c706d;!_0x1ab1d6[_0x33a704(0x2be)](_0x309f34[_0x33a704(0x1e0)])&&!_0x2795a0[_0x33a704(0x2be)](_0x309f34[_0x33a704(0x1e0)])&&(_0x2795a0['style'][_0x33a704(0x247)]=_0x33a704(0x33e));}));const _0x161150=document['getElementById']('hly-kb-delete-local-btn');_0x161150&&_0x161150['addEventListener']('click',deleteAllLocalKnowledgeBases);const _0x454faa=['hly-kb-list-local',_0x2c706d(0x263)];_0x454faa[_0x2c706d(0x23b)](_0x2db2bc=>{const _0x1ba19b=_0x2c706d,_0x4090b5=document[_0x1ba19b(0x232)](_0x2db2bc);_0x4090b5&&(_0x4090b5['addEventListener'](_0x1ba19b(0x2c2),handleKbAction),_0x4090b5['addEventListener']('change',handleKbAction));});}function toggleInjectionDetails(){const _0x29f420=_0x49cd00,_0x4111b8=document[_0x29f420(0x1e2)](_0x29f420(0x30a))[_0x29f420(0x2b4)],_0x5437da=document[_0x29f420(0x232)](_0x29f420(0x1db)),_0x176f18=document[_0x29f420(0x232)](_0x29f420(0x2e7)),_0x26fc00=_0x4111b8==='1';_0x5437da[_0x29f420(0x29e)]=!_0x26fc00,_0x176f18[_0x29f420(0x29e)]=!_0x26fc00;}function handleApiModeChange(){const _0x47b176=_0x49cd00,_0x4eca38=document[_0x47b176(0x232)](_0x47b176(0x284))[_0x47b176(0x2b4)],_0x4f8e5c=document[_0x47b176(0x232)]('hly-custom-endpoint-docket'),_0x3204ae=document[_0x47b176(0x232)]('hly-api-key-group'),_0x4f84a4=document['getElementById'](_0x47b176(0x2d0)),_0x3ca452=_0x4f84a4[_0x47b176(0x376)];if(!_0x4f8e5c||!_0x3204ae)return;_0x4f8e5c[_0x47b176(0x230)]['display']=_0x47b176(0x2a8),_0x3204ae[_0x47b176(0x230)][_0x47b176(0x247)]=_0x47b176(0x2a8);switch(_0x4eca38){case'google_direct':_0x4f8e5c['style'][_0x47b176(0x247)]=_0x47b176(0x33e),_0x3204ae[_0x47b176(0x1e2)](_0x47b176(0x340))[_0x47b176(0x1fb)]=_0x47b176(0x277),_0x3204ae[_0x47b176(0x1e2)](_0x47b176(0x273))[_0x47b176(0x34c)]=_0x47b176(0x288);break;case _0x47b176(0x2ab):_0x4f8e5c[_0x47b176(0x1e2)]('label')[_0x47b176(0x1fb)]=_0x47b176(0x23f),_0x4f8e5c[_0x47b176(0x1e2)](_0x47b176(0x273))[_0x47b176(0x34c)]=_0x47b176(0x239),_0x3204ae[_0x47b176(0x230)][_0x47b176(0x247)]=_0x47b176(0x33e);break;case _0x47b176(0x2db):default:_0x4f8e5c[_0x47b176(0x1e2)](_0x47b176(0x340))[_0x47b176(0x1fb)]=_0x47b176(0x2f9),_0x4f8e5c[_0x47b176(0x1e2)](_0x47b176(0x273))[_0x47b176(0x34c)]=_0x47b176(0x1ff),_0x3204ae[_0x47b176(0x1e2)](_0x47b176(0x340))[_0x47b176(0x1fb)]=_0x47b176(0x21b);break;}}function loadSettingsToUI(){const _0x1da482=_0x49cd00,_0x13e726=_0x2b0a92[_0x1da482(0x1df)]();if(!_0x13e726)return;document['getElementById']('hly-retrieval-enabled')[_0x1da482(0x214)]=_0x13e726['retrieval'][_0x1da482(0x1b1)],document[_0x1da482(0x232)](_0x1da482(0x284))['value']=_0x13e726['retrieval']['apiEndpoint'],document[_0x1da482(0x232)]('hly-custom-api-url')[_0x1da482(0x2b4)]=_0x13e726[_0x1da482(0x30e)][_0x1da482(0x2ed)],document[_0x1da482(0x232)](_0x1da482(0x1c6))[_0x1da482(0x2b4)]=_0x13e726[_0x1da482(0x30e)][_0x1da482(0x22a)];const _0x40a6a0=document['getElementById'](_0x1da482(0x2d0));if(_0x40a6a0[_0x1da482(0x2c7)]['length']===0x0){const _0x24f82a=_0x13e726[_0x1da482(0x30e)][_0x1da482(0x322)],_0x4f1b20=new Option(_0x24f82a,_0x24f82a,!![],!![]);_0x40a6a0['add'](_0x4f1b20);}_0x40a6a0[_0x1da482(0x2b4)]=_0x13e726[_0x1da482(0x30e)][_0x1da482(0x322)],document[_0x1da482(0x232)](_0x1da482(0x2ca))[_0x1da482(0x214)]=_0x13e726['retrieval']['notify'],document[_0x1da482(0x232)]('hly-chunk-size')[_0x1da482(0x2b4)]=_0x13e726['advanced'][_0x1da482(0x21a)],document[_0x1da482(0x232)]('hly-overlap-size')[_0x1da482(0x2b4)]=_0x13e726[_0x1da482(0x369)][_0x1da482(0x362)],document[_0x1da482(0x232)](_0x1da482(0x331))[_0x1da482(0x2b4)]=_0x13e726[_0x1da482(0x369)][_0x1da482(0x24d)],document[_0x1da482(0x232)](_0x1da482(0x24b))[_0x1da482(0x2b4)]=_0x13e726[_0x1da482(0x369)][_0x1da482(0x2f0)],document[_0x1da482(0x232)](_0x1da482(0x244))[_0x1da482(0x2b4)]=_0x13e726[_0x1da482(0x369)][_0x1da482(0x1f5)],document[_0x1da482(0x232)]('hly-batch-size')[_0x1da482(0x2b4)]=_0x13e726[_0x1da482(0x30e)]['batchSize'],document[_0x1da482(0x232)]('hly-injection-template')['value']=_0x13e726[_0x1da482(0x2b5)][_0x1da482(0x353)];const _0x5b218f=document[_0x1da482(0x1e2)](_0x1da482(0x217)+_0x13e726[_0x1da482(0x2b5)][_0x1da482(0x1f6)]+'\x22]');_0x5b218f&&(_0x5b218f[_0x1da482(0x214)]=!![]);document[_0x1da482(0x232)]('hly-injection-depth')[_0x1da482(0x2b4)]=_0x13e726[_0x1da482(0x2b5)][_0x1da482(0x335)],document[_0x1da482(0x232)](_0x1da482(0x2e7))[_0x1da482(0x2b4)]=_0x13e726[_0x1da482(0x2b5)][_0x1da482(0x1bd)],toggleInjectionDetails(),handleApiModeChange(),document['getElementById'](_0x1da482(0x361))[_0x1da482(0x214)]=_0x13e726[_0x1da482(0x224)][_0x1da482(0x1b1)],document[_0x1da482(0x232)](_0x1da482(0x206))[_0x1da482(0x2b4)]=_0x13e726[_0x1da482(0x224)][_0x1da482(0x2c9)],document[_0x1da482(0x232)](_0x1da482(0x1c7))[_0x1da482(0x2b4)]=_0x13e726[_0x1da482(0x224)]['layerEnd'],document['getElementById'](_0x1da482(0x20c))[_0x1da482(0x214)]=_0x13e726[_0x1da482(0x224)][_0x1da482(0x1e8)][_0x1da482(0x2ec)],document[_0x1da482(0x232)]('hly-include-ai')[_0x1da482(0x214)]=_0x13e726[_0x1da482(0x224)]['messageTypes']['ai'];const _0x5ae5a9=document['getElementById'](_0x1da482(0x1b4)),_0x5354c5=document[_0x1da482(0x232)](_0x1da482(0x365)),_0x385d52=document[_0x1da482(0x232)](_0x1da482(0x256));_0x5ae5a9[_0x1da482(0x214)]=_0x13e726['condensation'][_0x1da482(0x2e4)],_0x5354c5[_0x1da482(0x2b4)]=_0x13e726[_0x1da482(0x224)][_0x1da482(0x2e8)],_0x385d52['style'][_0x1da482(0x247)]=_0x5ae5a9[_0x1da482(0x214)]?'block':_0x1da482(0x33e),document[_0x1da482(0x232)](_0x1da482(0x1d1))[_0x1da482(0x214)]=_0x13e726[_0x1da482(0x30f)][_0x1da482(0x1b1)],document[_0x1da482(0x232)](_0x1da482(0x368))[_0x1da482(0x2b4)]=_0x13e726[_0x1da482(0x30f)][_0x1da482(0x2c8)],document[_0x1da482(0x232)](_0x1da482(0x342))['value']=_0x13e726[_0x1da482(0x30f)][_0x1da482(0x22a)];const _0xe2e9ab=document[_0x1da482(0x232)](_0x1da482(0x354));if(_0xe2e9ab[_0x1da482(0x2c7)]['length']===0x0){const _0x3785d8=_0x13e726[_0x1da482(0x30f)][_0x1da482(0x28b)];if(_0x3785d8){const _0x37b03c=new Option(_0x3785d8,_0x3785d8,!![],!![]);_0xe2e9ab[_0x1da482(0x311)](_0x37b03c);}}_0xe2e9ab[_0x1da482(0x2b4)]=_0x13e726[_0x1da482(0x30f)][_0x1da482(0x28b)],document['getElementById'](_0x1da482(0x25b))['value']=_0x13e726['rerank'][_0x1da482(0x32c)],document['getElementById'](_0x1da482(0x218))[_0x1da482(0x2b4)]=_0x13e726['rerank'][_0x1da482(0x238)],document[_0x1da482(0x232)](_0x1da482(0x2d1))[_0x1da482(0x214)]=_0x13e726[_0x1da482(0x30f)][_0x1da482(0x35b)];}function saveSettingsFromUI(_0x139875=!![]){const _0x391d29=_0x49cd00,_0x3e2e68=document[_0x391d29(0x232)]('hly-modal-container');if(!_0x3e2e68)return;const _0x5022e6=_0x3e2e68[_0x391d29(0x223)](_0x391d29(0x30b));_0x5022e6[_0x391d29(0x23b)](_0xd61ad2=>{const _0x4c38bf=_0x391d29,_0x4bcb3a=_0xd61ad2[_0x4c38bf(0x2b6)]['settingKey'];if(!_0x4bcb3a)return;let _0x378537;const _0x100182=_0xd61ad2[_0x4c38bf(0x2b6)]['type']||_0x4c38bf(0x2e6);if(_0xd61ad2[_0x4c38bf(0x32f)]===_0x4c38bf(0x364))_0x378537=_0xd61ad2[_0x4c38bf(0x214)];else{if(_0xd61ad2[_0x4c38bf(0x32f)]===_0x4c38bf(0x26e)){if(!_0xd61ad2[_0x4c38bf(0x214)])return;_0x378537=_0xd61ad2[_0x4c38bf(0x2b4)];}else _0x378537=_0xd61ad2[_0x4c38bf(0x2b4)];}switch(_0x100182){case _0x4c38bf(0x2c3):_0x378537=parseInt(_0x378537,0xa);break;case _0x4c38bf(0x2b2):_0x378537=parseFloat(_0x378537);break;case'boolean':if(typeof _0x378537!==_0x4c38bf(0x243))_0x378537=_0x378537===_0x4c38bf(0x253);break;}const _0x352915=_0x2b0a92[_0x4c38bf(0x1df)](),_0x57d0ea=_0x4bcb3a[_0x4c38bf(0x24c)]('.');let _0x3f01b8=_0x352915;for(let _0x7e8c92=0x0;_0x7e8c92<_0x57d0ea['length']-0x1;_0x7e8c92++){_0x3f01b8=_0x3f01b8[_0x57d0ea[_0x7e8c92]]=_0x3f01b8[_0x57d0ea[_0x7e8c92]]||{};}_0x3f01b8[_0x57d0ea[_0x57d0ea['length']-0x1]]=_0x378537;}),_0x2b0a92[_0x391d29(0x375)](),!_0x139875&&(log(_0x391d29(0x270),'success'),toastr[_0x391d29(0x2b3)](_0x391d29(0x347),_0x391d29(0x34d)));}function resetSettingsToUI(){const _0x4a921f=_0x49cd00;confirm(_0x4a921f(0x1ba))&&(_0x2b0a92[_0x4a921f(0x2fa)](),loadSettingsToUI(),toastr['info'](_0x4a921f(0x2fb),'诏曰'));}function _0x33b8(){const _0x20e92d=['includes','fetchRerankModels','启禀大人，发现此书上次录入已完成\x20','】移动到【','finalMessages','根据标签提取或内容排除条件，未找到任何有效内容。','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20class=\x22hly-multiselect-option\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20id=\x22hly-hist-select-all-entries\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>全选/全不选</strong>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</label>','[翰林院-枢纽]\x20核心法典未能提供初始化圣旨！','hly-kb-list-local','\x20个知识块。','\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20class=\x22hly-imperial-brush\x22\x20value=\x22','手动录入成功，新增\x20','log-success','当前角色没有任何局部知识库可供删除。','is_user','当前角色','beforeend','toggle','disabled','所有\x20','文书已成功录入宝库，新增\x20','showHLYStats','会话已锁定','hly-kb-list-global-placeholder','切换状态失败:\x20','</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</label>','.hly-exclusion-rule-row','成功获取\x20','block','getLocalKnowledgeBases','keys','local_proxy','删除失败:\x20','hly-locked-status','hly-current-character-name','getCharacterName','selectedIndex','scrollHeight','float','success','value','injection','dataset','filter','hly-hist-select-library','className','<option\x20value=\x22\x22>请选择一个书库...</option>','[翰林院-枢纽]\x20更新忆识数量失败:','获取模型失败:\x20','文书录入失败:\x20','contains','local','移动知识库\x20','totalSuccess','click','integer','<p\x20class=\x22hly-notes\x20log-error\x22><i>加载失败:\x20','createElement','<option>未找到模型</option>','options','url','layerStart','hly-retrieval-notify','each','条)</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-kb-actions\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','hanlinyuan-ingest-novel-file-input','开始获取Rerank模型列表...','.hly-preview-delete-btn-v2','hly-embedding-model','hly-rerank-notify','length','\x20个局部知识库均已成功删除。','fa-times-circle','hly-session-lock-btn','text','executeCompilation','未能获取到任何Rerank模型。','录入内容不能为空。','hly-hist-entry-multiselect-btn','custom','val','根据当前勾选条件，未找到符合的消息可供预览。','错误:\x20','hlyLog','hly-exclusion-rules-container','error','.hly-kb-move-btn','#hly-rules-list','tagExtractionEnabled','\x22\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20data-is-user=\x22','string','hly-injection-role','tags','翰林院使用教程','condensationHistory','[实时刷新]\x20批次完成，忆识总数已更新。','user','customApiUrl','saveHLYSettings','amily2_open_hanlin_tutorial','queryMessageCount','testApiConnection','局部知识库批量删除完成。成功:\x20','批量编纂任务已完成。','<i\x20class=\x22fa-solid\x20','getLoresForWorldbook','获取Rerank模型失败:\x20','》的条目失败:','fetchHLYRerankModels','自定义路径:','resetSettings','翰林院设定已重置为初始状态。','.hly-kb-name','processedChunks','遵命，将从第\x20','未找到符合条件的消息可供凝识。','\x20块继续录入。','fetchEmbeddingModels','stringify','2152TFDBdz','锁定会话','成功加载\x20','解锁会话','未知错误','innerHTML','ingestTextToHanlinyuan','input[name=\x22hly-injection-position\x22]:checked','[data-setting-key]','end','\x20(ID:\x20','retrieval','rerank','\x0a忆识总数:\x20','add','content','编辑内容排除规则','count','】吗？此操作无法恢复！','totalVectors','未找到符合条件的消息。','60309Kgdhxg','</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20id=\x22hly-add-rule-btn\x22\x20class=\x22hly-action-button\x22\x20style=\x22margin-top:\x2010px;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<i\x20class=\x22fas\x20fa-plus\x22></i>\x20添加新规则\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.hly-exclusion-rule-row\x20{\x20display:\x20flex;\x20align-items:\x20center;\x20gap:\x2010px;\x20margin-bottom:\x2010px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.hly-exclusion-rule-row\x20input\x20{\x20flex-grow:\x201;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.hly-delete-rule-btn\x20{\x20background:\x20#c0392b;\x20color:\x20white;\x20border:\x20none;\x20border-radius:\x2050%;\x20width:\x2024px;\x20height:\x2024px;\x20cursor:\x20pointer;\x20font-size:\x2016px;\x20line-height:\x2024px;\x20text-align:\x20center;\x20padding:\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20</style>\x0a\x20\x20\x20\x20','[翰林院-枢纽]\x20已成功连接各部，政令畅通。','hanlinyuan-ingest-progress-bar','fa-circle-info','内容排除规则已保存。','编纂失败:\x20','scripts/extensions/third-party/ST-Amily2-Chat-Optimisation/HanLin.md','会话已解锁，将跟随当前角色。','log-info','embeddingModel','处理中:\x20','请先选择书库','删除局部知识库\x20','name','此操作将彻底清空当前角色的所有忆识（向量），且无法恢复。您确定要继续吗？','floor','warn','您确定要永久删除【当前角色】的全部\x20','\x20个知识库删除失败。','top_n','initialize','key','type','请先选择一个\x20.txt\x20文件','hly-match-threshold','</textarea>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</details>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22hly-preview-delete-btn-v2\x22\x20data-target=\x22','comment','.hly-log-placeholder','depth','hly-kb-toggle','》的批量编纂任务已完成。成功:\x20','stopPropagation','N/A','批量编纂任务已完成，但有部分错误。','<button\x20class=\x22hly-kb-move-btn\x22\x20title=\x22下移到局部\x22><i\x20class=\x22fas\x20fa-arrow-down\x22></i></button>','classList','preview-item-','none','from','label','div','hly-rerank-api-key','2icCznr','未能获取到任何模型。','正在读取文件...','findIndex','翰林院设定已存档封印。','testHLYApi','保存规则','已选择\x20','remove','placeholder','圣旨已达','hly-kb-list-local-placeholder','5668808VqeuRz','ingestHLYManualText','会话已锁定到:\x20','span','template','hly-rerank-model','会话已解锁。','<option\x20value=\x22\x22>加载失败</option>','getAvailableWorldbooks','\x20个Rerank模型。','<p\x20class=\x22hly-record-hint\x22><i>上次已从第\x20','\x0a<pre>\x0a翰林院宝库状态\x0a--------------------\x0a集合ID:\x20','notify','getCollectionId','4162030HOAHij','\x0a--------------------\x0aAPI端点:\x20','\x22\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20data-send-date=\x22','getChatId','hly-condensation-enabled','overlap','知识库\x20','checkbox','hly-tag-input','加载书库列表失败:\x20','hly-include-ai','hly-rerank-url','advanced','点击以锁定，让翰林院固定操作当前角色的宝库','active','log-warn',',\x20向量:\x20','\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span>','手动录入失败:\x20','已选择\x200\x20/\x20','tab','任务已由用户中止。进度已保存，可随时继续。','请先选择一个书库并至少选择一个要编纂的条目。','log-error','saveSettings','previousElementSibling','成功录入\x20','closest','遵命，将从头开始录入此书。','\x20/\x20','\x20块开始。','enabled','开始获取模型列表...','toFixed','hly-tag-extraction-toggle','.hly-hist-entry-checkbox:checked','，重新开始。','.hly-preview-textarea','\x20条忆识。','.hly-preview-item-v2','您确定要将所有设定恢复为出厂默认值吗？','fas\x20fa-lock','2167911IydVig','depth_role','info','fa-exclamation-triangle','查看宝库状态成功：集合ID=','settingKey','flex','正在测试神力连接...','无法获取总数:\x20','%。是否从上次中断之处继续？','hly-api-key','hly-layer-end','检测到预览后待处理的消息对象，开始精确凝识...','warning','[翰林院-枢纽]\x20预览过程发生错误:','removeKnowledgeBase','大功告成','正在清空宝库...',']\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</summary>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-preview-content\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<textarea\x20class=\x22hly-preview-textarea\x22\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20data-floor=\x22','正在加载条目...','-tab','hly-rerank-enabled','join','\x20失败:\x20','\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<details\x20class=\x22hly-preview-details\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<summary\x20class=\x22hly-preview-summary\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20第\x20','</i></p>','appendChild','updateHLYMemoryCount','\x20个条目进行编纂...','加载条目失败:\x20','.hly-tab-pane','hly-injection-depth','正在获取可用书库列表...','isSessionLocked','start','getSettings','target','hly-log-output','querySelector','kbId','global','map','use\x20strict','trim','messageTypes','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20class=\x22hly-multiselect-option\x22\x20title=\x22','total','\x20个条目。','正在查询宝库状态...','mes','宝库状态','已采集\x20','录入失败:\x20','[断点续传]\x20用户选择继续任务\x20','收到手动录入请求，文本长度:\x20','getLockedSessionInfo','\x22></i>\x20[','maxResults','position','任务完成！成功录入\x20','condensation.exclusionRules','#hly-add-rule-btn',',\x20失败:\x20','textContent','fa-check-circle','凝识完成！新增\x20','》获取条目列表...','输入兼容OpenAI的embeddings端点','加载失败','<div\x20class=\x22hly-preview-container-v2\x22>','hly-','novel','hly-hist-entry-multiselect-options','hly-manual-text','hly-layer-start','\x20状态失败:\x20','此书库为空','用户请求查看宝库状态。','[断点续传]\x20用户选择放弃旧任务\x20','正在为《','hly-include-user','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20class=\x22hly-toggle-switch\x22\x20title=\x22启用/禁用此知识库\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20class=\x22hly-kb-toggle\x22\x20','find','change','hly-condensation-results','[翰林院-枢纽]\x20获取模型列表失败:','preventDefault','hanlinyuan-ingest-progress-container','checked','clearJob','\x22\x20title=\x22删除此条\x22>&times;</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20','input[name=\x22hly-injection-position\x22][value=\x22','hly-rerank-hybrid-alpha','神力连接通畅！','chunkSize','通行令牌\x20(API\x20Key):','\x0a所用模型:\x20','toggleSessionLock','\x20的状态已切换','[自动保存]\x20设置项\x20\x27','hly-kb-list-item','chat','getVectorCount','querySelectorAll','condensation','预览失败:\x20','\x20条消息，开始凝识...','1079916WYAbmJ','exclusionRules','<button\x20class=\x22hly-kb-move-btn\x22\x20title=\x22上移到全局\x22><i\x20class=\x22fas\x20fa-arrow-up\x22></i></button>','apiKey','abort','》中的\x20','hly-hist-select-all-entries','】已删除。','is-user','style','\x20楼凝识至第\x20','getElementById','...','神力连接失败:\x20','\x20个局部知识库...','input[name=\x22','kbScope','hybrid_alpha','例如\x20http://127.0.0.1:8000/v1','\x20个条目','forEach','未选择文件','previewHLYCondensation','\x27\x20已更新为:\x20','本地代理地址:','fas\x20fa-lock-open','scrollTop','toLocaleTimeString','boolean','hly-max-results','signal','\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22hly-exclusion-rules-container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22hly-notes\x22>在这里定义需要从提取内容中排除的文本片段。例如，排除HTML注释，可以设置开始字符为\x20`<!--`，结束字符为\x20`-->`。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22hly-rules-list\x22>','display','push','files','聊天记录从第\x20','hly-query-message-count','split','matchThreshold','[翰林院-枢纽]\x20获取Rerank模型列表失败:','hanlinyuan-ingest-novel-start','切换知识库\x20','title','3908706xnYckI','true','正在准备凝识...','[翰林院-枢纽]\x20查询宝库状态失败:','hly-tag-input-container','hanlinyuan-ingest-novel-controls','翰林院启奏','删除知识库\x20','8599969UnwGjh','hly-rerank-top-n','\x20楼。</i></p>','正在处理您确认后的文书...','严重错误',')\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20class=\x22hly-hist-entry-checkbox\x22\x20value=\x22','[翰林院-枢纽]\x20凝识过程发生错误:','hly-historiography-results','预览并编辑凝识内容','hly-kb-list-global','[翰林院-枢纽]\x20加载《','hly-current-vector-count','addEventListener','toggleKnowledgeBase','\x20个模型。','\x20个局部知识库吗？此操作无法恢复！','，从第\x20','知识库【','凝识失败:\x20','\x20楼到\x20','radio','getMessagesForCondensation','【手动存档】所有设定已存档封印。','用户尝试录入空文本。','send_date','input','[翰林院-枢纽]\x20加载书库列表失败:',',\x20忆识总数=','未检测到预览文本，按标准流程采集消息...','Google\x20API\x20Key:','data','手动录入','resetHLYSettings','\x20个条目进行批量编纂...','点击以解锁，让翰林院跟随当前角色','message','\x20(Key:\x20','\x20楼到第\x20','manual','正在处理您提交的文书...','hly-current-chat-id','hly-modal-container','hly-api-endpoint','hanlinyuan-ingest-abort','开始批量删除\x20','insertAdjacentHTML','请输入您的Google\x20API\x20Key','loadProgress',')\x20已被删除','model'];_0x33b8=function(){return _0x20e92d;};return _0x33b8();}async function updatePanelStatus(){const _0x53d962=_0x49cd00,_0x598cda=_0x2b0a92[_0x53d962(0x1dd)](),_0x25340c=document[_0x53d962(0x232)](_0x53d962(0x2ae)),_0x40b224=document[_0x53d962(0x232)](_0x53d962(0x282));if(_0x598cda){const _0x157696=_0x2b0a92[_0x53d962(0x1f3)]();_0x157696&&(_0x25340c[_0x53d962(0x1fb)]=_0x53d962(0x2a2),_0x40b224['textContent']=_0x157696['id'],_0x40b224[_0x53d962(0x251)]='当前所有操作都将指向这个锁定的宝库：'+_0x157696['id'],_0x25340c[_0x53d962(0x33c)][_0x53d962(0x311)](_0x53d962(0x2ad)),_0x40b224['classList']['add'](_0x53d962(0x2ad)));}else _0x25340c['textContent']=_0x20c628[_0x53d962(0x2af)](),_0x40b224[_0x53d962(0x1fb)]=_0x20c628[_0x53d962(0x360)]()||'无',_0x40b224[_0x53d962(0x251)]='',_0x25340c['classList'][_0x53d962(0x34b)]('hly-locked-status'),_0x40b224['classList'][_0x53d962(0x34b)](_0x53d962(0x2ad));const _0x54d5a9=document['getElementById'](_0x53d962(0x265));_0x54d5a9[_0x53d962(0x1fb)]=_0x53d962(0x233);try{const _0x562dd1=await _0x2b0a92[_0x53d962(0x222)]();_0x54d5a9[_0x53d962(0x1fb)]=_0x562dd1;}catch(_0x2ed62e){console[_0x53d962(0x2e1)](_0x53d962(0x2bb),_0x2ed62e),_0x54d5a9[_0x53d962(0x1fb)]=_0x53d962(0x339),_0x54d5a9[_0x53d962(0x251)]=_0x53d962(0x1c4)+_0x2ed62e['message'];}const _0x24ceca=document[_0x53d962(0x232)](_0x53d962(0x210));if(_0x24ceca&&!_0x24ceca[_0x53d962(0x2b6)]['finalText']){const _0x1c52cb=_0x2b0a92[_0x53d962(0x1df)](),_0x540fe0=await _0x2b0a92[_0x53d962(0x35c)]();if(_0x1c52cb[_0x53d962(0x2ea)]&&_0x1c52cb['condensationHistory'][_0x540fe0]){const _0x5ba6f9=_0x1c52cb[_0x53d962(0x2ea)][_0x540fe0];_0x24ceca[_0x53d962(0x308)]=_0x53d962(0x359)+_0x5ba6f9[_0x53d962(0x1de)]+_0x53d962(0x231)+_0x5ba6f9[_0x53d962(0x30c)]+_0x53d962(0x25c);}else _0x24ceca[_0x53d962(0x308)]='<p\x20class=\x22hly-record-hint\x22>可在此预览凝识结果。</p>';}renderKnowledgeBases();}async function deleteAllLocalKnowledgeBases(){const _0x2a7c13=_0x49cd00,_0x273a04=_0x2b0a92[_0x2a7c13(0x2a9)](),_0x3e5a50=Object[_0x2a7c13(0x2aa)](_0x273a04);if(_0x3e5a50['length']===0x0){toastr[_0x2a7c13(0x1be)](_0x2a7c13(0x299),'圣谕');return;}if(!confirm(_0x2a7c13(0x32a)+_0x3e5a50[_0x2a7c13(0x2d2)]+_0x2a7c13(0x269)))return;toastr[_0x2a7c13(0x1be)]('正在删除\x20'+_0x3e5a50['length']+_0x2a7c13(0x235),'圣旨'),log(_0x2a7c13(0x286)+_0x3e5a50[_0x2a7c13(0x2d2)]+_0x2a7c13(0x235),_0x2a7c13(0x329));let _0x127c4f=0x0,_0x5a0eb8=0x0;for(const _0x261703 of _0x3e5a50){try{await _0x2b0a92[_0x2a7c13(0x1cb)](_0x261703,_0x2a7c13(0x2bf)),_0x127c4f++;}catch(_0x36c7bd){_0x5a0eb8++,log(_0x2a7c13(0x325)+_0x261703+_0x2a7c13(0x1d3)+_0x36c7bd[_0x2a7c13(0x27d)],_0x2a7c13(0x2e1));}}_0x5a0eb8>0x0?toastr['error']('操作完成，但有\x20'+_0x5a0eb8+_0x2a7c13(0x32b),'警报'):toastr[_0x2a7c13(0x2b3)](_0x2a7c13(0x29f)+_0x127c4f+_0x2a7c13(0x2d3),_0x2a7c13(0x1cc)),log(_0x2a7c13(0x2f2)+_0x127c4f+_0x2a7c13(0x1fa)+_0x5a0eb8,'info'),await updatePanelStatus();}async function renderKnowledgeBases(){const _0xf62a1f=_0x49cd00,_0x50a49c=document[_0xf62a1f(0x232)](_0xf62a1f(0x294)),_0x36b8f3=document[_0xf62a1f(0x232)](_0xf62a1f(0x263)),_0x2ffa5=document[_0xf62a1f(0x232)]('hly-local-kb-char-name');if(!_0x50a49c||!_0x36b8f3||!_0x2ffa5)return;_0x2ffa5['textContent']=_0x20c628[_0xf62a1f(0x2af)]()||_0xf62a1f(0x29b);try{const _0xc69e=_0x2b0a92[_0xf62a1f(0x2a9)](),_0x581b05=_0x2b0a92['getGlobalKnowledgeBases']();await _renderKbList(_0xc69e,_0x50a49c,_0xf62a1f(0x2bf),_0xf62a1f(0x34e)),await _renderKbList(_0x581b05,_0x36b8f3,_0xf62a1f(0x1e4),_0xf62a1f(0x2a3));}catch(_0x3b567e){console[_0xf62a1f(0x2e1)]('[翰林院-枢纽]\x20渲染知识库列表失败:',_0x3b567e),_0x50a49c[_0xf62a1f(0x308)]=_0xf62a1f(0x2c4)+_0x3b567e[_0xf62a1f(0x27d)]+_0xf62a1f(0x1d5),_0x36b8f3[_0xf62a1f(0x308)]=_0xf62a1f(0x2c4)+_0x3b567e[_0xf62a1f(0x27d)]+'</i></p>';}}async function _renderKbList(_0x547747,_0x352658,_0xa0567c,_0x4c6295){const _0x40afef=_0x49cd00,_0xd17904=document[_0x40afef(0x232)](_0x4c6295);_0x352658['innerHTML']='',_0x352658[_0x40afef(0x1d6)](_0xd17904);if(Object[_0x40afef(0x2aa)](_0x547747)[_0x40afef(0x2d2)]===0x0){_0xd17904[_0x40afef(0x230)][_0x40afef(0x247)]=_0x40afef(0x2a8);return;}_0xd17904[_0x40afef(0x230)][_0x40afef(0x247)]='none';for(const [_0x2aeb9b,_0x3313d1]of Object['entries'](_0x547747)){const _0x15f0de=document[_0x40afef(0x2c5)](_0x40afef(0x341));_0x15f0de[_0x40afef(0x2b9)]=_0x40afef(0x220),_0x15f0de[_0x40afef(0x2b6)][_0x40afef(0x1e3)]=_0x2aeb9b,_0x15f0de[_0x40afef(0x2b6)][_0x40afef(0x237)]=_0xa0567c;const _0x1a79c6=await _0x2b0a92[_0x40afef(0x222)](_0x2aeb9b,_0xa0567c),_0x40f13b=_0xa0567c===_0x40afef(0x2bf)?_0x40afef(0x229):_0x40afef(0x33b);_0x15f0de[_0x40afef(0x308)]='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22hly-kb-name\x22\x20title=\x22ID:\x20'+_0x2aeb9b+'\x22>'+_0x3313d1['name']+'\x20('+_0x1a79c6+_0x40afef(0x2cc)+_0x40f13b+_0x40afef(0x20d)+(_0x3313d1[_0x40afef(0x1b1)]?_0x40afef(0x214):'')+'>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22hly-toggle-slider\x22></span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</label>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22hly-kb-delete-btn\x22\x20title=\x22删除此知识库\x22>&times;</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20',_0x352658[_0x40afef(0x1d6)](_0x15f0de);}}async function handleKbAction(_0x36a2a0){const _0x58ca48=_0x49cd00,_0x3b699e=_0x36a2a0[_0x58ca48(0x1e0)],_0x9df796=_0x3b699e[_0x58ca48(0x1ad)]('.hly-kb-list-item');if(!_0x9df796)return;const _0x30b060=_0x9df796[_0x58ca48(0x2b6)][_0x58ca48(0x1e3)],_0x32792f=_0x9df796[_0x58ca48(0x2b6)]['kbScope'],_0x28191e=_0x9df796[_0x58ca48(0x1e2)](_0x58ca48(0x2fc))[_0x58ca48(0x1fb)][_0x58ca48(0x24c)]('\x20(')[0x0];if(_0x3b699e[_0x58ca48(0x33c)][_0x58ca48(0x2be)]('hly-kb-delete-btn')){if(confirm('您确定要永久删除知识库【'+_0x28191e+_0x58ca48(0x315)))try{await _0x2b0a92['removeKnowledgeBase'](_0x30b060,_0x32792f),log('知识库\x20'+_0x28191e+_0x58ca48(0x30d)+_0x30b060+_0x58ca48(0x28a),_0x58ca48(0x2b3)),toastr[_0x58ca48(0x2b3)](_0x58ca48(0x26b)+_0x28191e+_0x58ca48(0x22e)),updatePanelStatus();}catch(_0x433874){log(_0x58ca48(0x259)+_0x28191e+_0x58ca48(0x1d3)+_0x433874['message'],_0x58ca48(0x2e1)),toastr['error'](_0x58ca48(0x2ac)+_0x433874[_0x58ca48(0x27d)]);}}if(_0x3b699e[_0x58ca48(0x1ad)](_0x58ca48(0x2e2))){const _0x96e29d=_0x32792f==='local'?'全局':'局部';if(confirm('您确定要将知识库【'+_0x28191e+_0x58ca48(0x28f)+_0x96e29d+'】吗？'))try{await _0x2b0a92['moveKnowledgeBase'](_0x30b060,_0x32792f),updatePanelStatus();}catch(_0x862d34){log(_0x58ca48(0x2c0)+_0x28191e+_0x58ca48(0x1d3)+_0x862d34[_0x58ca48(0x27d)],_0x58ca48(0x2e1)),toastr[_0x58ca48(0x2e1)]('移动失败:\x20'+_0x862d34[_0x58ca48(0x27d)]);}}if(_0x3b699e[_0x58ca48(0x33c)][_0x58ca48(0x2be)](_0x58ca48(0x336)))try{await _0x2b0a92[_0x58ca48(0x267)](_0x30b060,_0x32792f),log(_0x58ca48(0x363)+_0x28191e+_0x58ca48(0x21e),_0x58ca48(0x2b3)),updatePanelStatus();}catch(_0x43481d){log(_0x58ca48(0x250)+_0x28191e+_0x58ca48(0x207)+_0x43481d['message'],'error'),toastr[_0x58ca48(0x2e1)](_0x58ca48(0x2a4)+_0x43481d['message']);}}async function testApi(){const _0x461cd4=_0x49cd00;toastr[_0x461cd4(0x1be)](_0x461cd4(0x1c3),'圣旨');try{await _0x2b0a92[_0x461cd4(0x2f1)](),toastr['success'](_0x461cd4(0x219),'圣意');}catch(_0x4aaefd){toastr['error'](_0x461cd4(0x234)+_0x4aaefd[_0x461cd4(0x27d)],'警报');}}async function fetchHLYEmbeddingModels(){const _0x271b2b=_0x49cd00,_0x4acb1b=document[_0x271b2b(0x232)]('hly-embedding-model'),_0x4f9c0f=_0x4acb1b[_0x271b2b(0x2b4)];_0x4acb1b[_0x271b2b(0x308)]='<option>正在获取...</option>',_0x4acb1b[_0x271b2b(0x29e)]=!![];try{log(_0x271b2b(0x1b2),_0x271b2b(0x1be));const _0x382bbb=await _0x2b0a92[_0x271b2b(0x301)]();_0x4acb1b['innerHTML']='';if(_0x382bbb[_0x271b2b(0x2d2)]===0x0){_0x4acb1b['innerHTML']=_0x271b2b(0x2c6),toastr[_0x271b2b(0x329)]('未能获取到任何模型。','翰林院启奏'),log(_0x271b2b(0x344),_0x271b2b(0x329));return;}_0x382bbb[_0x271b2b(0x23b)](_0xcd51d8=>{const _0x31b537=new Option(_0xcd51d8,_0xcd51d8);_0x4acb1b['add'](_0x31b537);}),_0x382bbb[_0x271b2b(0x28c)](_0x4f9c0f)?_0x4acb1b[_0x271b2b(0x2b4)]=_0x4f9c0f:_0x4acb1b[_0x271b2b(0x2b0)]=0x0,toastr[_0x271b2b(0x2b3)]('成功获取\x20'+_0x382bbb['length']+_0x271b2b(0x268),'圣意'),log(_0x271b2b(0x2a7)+_0x382bbb[_0x271b2b(0x2d2)]+_0x271b2b(0x268),_0x271b2b(0x2b3));}catch(_0x1f40cb){console['error'](_0x271b2b(0x211),_0x1f40cb),toastr[_0x271b2b(0x2e1)](_0x271b2b(0x2bc)+_0x1f40cb[_0x271b2b(0x27d)],_0x271b2b(0x25e)),log('获取模型失败:\x20'+_0x1f40cb[_0x271b2b(0x27d)],_0x271b2b(0x2e1)),_0x4acb1b[_0x271b2b(0x308)]='<option>获取失败</option>';}finally{_0x4acb1b['disabled']=![];}}async function fetchHLYRerankModels(){const _0x464309=_0x49cd00,_0x10c449=document[_0x464309(0x232)](_0x464309(0x354)),_0xd3d3ff=_0x10c449[_0x464309(0x2b4)];_0x10c449[_0x464309(0x308)]='<option>正在获取...</option>',_0x10c449[_0x464309(0x29e)]=!![];try{log(_0x464309(0x2ce),_0x464309(0x1be));const _0x2ffbf1=await _0x2b0a92[_0x464309(0x28d)]();_0x10c449['innerHTML']='';if(_0x2ffbf1[_0x464309(0x2d2)]===0x0){_0x10c449[_0x464309(0x308)]='<option>未找到模型</option>',toastr[_0x464309(0x329)]('未能获取到任何Rerank模型。',_0x464309(0x258)),log(_0x464309(0x2d8),'warn');return;}_0x2ffbf1['forEach'](_0xa01db8=>{const _0x3cbde2=_0x464309,_0x6739fb=new Option(_0xa01db8,_0xa01db8);_0x10c449[_0x3cbde2(0x311)](_0x6739fb);}),_0x2ffbf1[_0x464309(0x28c)](_0xd3d3ff)?_0x10c449[_0x464309(0x2b4)]=_0xd3d3ff:_0x10c449[_0x464309(0x2b0)]=0x0,toastr[_0x464309(0x2b3)]('成功获取\x20'+_0x2ffbf1[_0x464309(0x2d2)]+_0x464309(0x358),'圣意'),log(_0x464309(0x2a7)+_0x2ffbf1[_0x464309(0x2d2)]+'\x20个Rerank模型。',_0x464309(0x2b3));}catch(_0x6b0790){console[_0x464309(0x2e1)](_0x464309(0x24e),_0x6b0790),toastr[_0x464309(0x2e1)](_0x464309(0x2f6)+_0x6b0790['message'],_0x464309(0x25e)),log(_0x464309(0x2f6)+_0x6b0790[_0x464309(0x27d)],'error'),_0x10c449[_0x464309(0x308)]='<option>获取失败</option>';}finally{_0x10c449[_0x464309(0x29e)]=![];}}async function purgeStorage(){const _0x53297d=_0x49cd00;if(confirm(_0x53297d(0x327))){toastr[_0x53297d(0x1be)](_0x53297d(0x1cd),'圣旨');const _0xe31304=await _0x2b0a92['purgeStorage']();_0xe31304?toastr[_0x53297d(0x2b3)]('宝库已清空。','圣意'):toastr[_0x53297d(0x2e1)]('清空宝库失败。','警报'),await updatePanelStatus();}}async function startCondensation(){const _0x2a6a14=_0x49cd00,_0x2a2f90=document[_0x2a6a14(0x232)](_0x2a6a14(0x210)),_0x27c290=_0x2a2f90[_0x2a6a14(0x2b6)][_0x2a6a14(0x290)],_0x289f4a=document[_0x2a6a14(0x232)]('hly-layer-start')[_0x2a6a14(0x2b4)],_0x37652b=document[_0x2a6a14(0x232)]('hly-layer-end')[_0x2a6a14(0x2b4)],_0x197ada={'start':parseInt(_0x289f4a),'end':parseInt(_0x37652b)};try{let _0x4b4d97;_0x27c290?(log(_0x2a6a14(0x1c8),_0x2a6a14(0x1be)),toastr[_0x2a6a14(0x1be)](_0x2a6a14(0x25d),'圣旨'),_0x4b4d97=JSON['parse'](_0x27c290),delete _0x2a2f90[_0x2a6a14(0x2b6)][_0x2a6a14(0x290)]):(log(_0x2a6a14(0x276),'info'),toastr[_0x2a6a14(0x1be)](_0x2a6a14(0x254),'圣旨'),_0x4b4d97=_0x2b0a92[_0x2a6a14(0x26f)]());if(!_0x4b4d97||_0x4b4d97[_0x2a6a14(0x2d2)]===0x0){toastr[_0x2a6a14(0x1c9)](_0x2a6a14(0x2ff),_0x2a6a14(0x258)),_0x2a2f90['textContent']=_0x2a6a14(0x317);return;}_0x2a2f90[_0x2a6a14(0x1fb)]=_0x2a6a14(0x1ef)+_0x4b4d97[_0x2a6a14(0x2d2)]+_0x2a6a14(0x226),toastr['info'](_0x2a6a14(0x1ef)+_0x4b4d97[_0x2a6a14(0x2d2)]+_0x2a6a14(0x226),_0x2a6a14(0x258));const _0x550e03=await _0x2b0a92['processCondensation'](_0x4b4d97,log,_0x197ada);if(_0x550e03['success']){toastr[_0x2a6a14(0x2b3)](_0x2a6a14(0x1fd)+_0x550e03['count']+_0x2a6a14(0x1b8),_0x2a6a14(0x1cc));const _0x5bc04d=_0x197ada[_0x2a6a14(0x30c)]===0x0?getContext()[_0x2a6a14(0x221)][_0x2a6a14(0x2d2)]:_0x197ada[_0x2a6a14(0x30c)];_0x2a2f90['textContent']=_0x2a6a14(0x24a)+_0x197ada[_0x2a6a14(0x1de)]+_0x2a6a14(0x27f)+_0x5bc04d+'\x20楼已成功凝识，新增\x20'+_0x550e03[_0x2a6a14(0x314)]+'\x20条忆识。';}else throw new Error(_0x550e03[_0x2a6a14(0x2e1)]||_0x2a6a14(0x307));}catch(_0x5c98a3){console['error'](_0x2a6a14(0x260),_0x5c98a3),toastr[_0x2a6a14(0x2e1)](_0x2a6a14(0x26c)+_0x5c98a3[_0x2a6a14(0x27d)],_0x2a6a14(0x25e)),_0x2a2f90['textContent']=_0x2a6a14(0x26c)+_0x5c98a3['message'];}finally{await updatePanelStatus();}}async function loadWorldbookList(){const _0x2ba138=_0x49cd00,_0x30e5e6=document[_0x2ba138(0x232)](_0x2ba138(0x2b8));if(!_0x30e5e6)return;try{log(_0x2ba138(0x1dc),_0x2ba138(0x1be));const _0x30d183=await _0x5daeb7[_0x2ba138(0x357)]();_0x30e5e6[_0x2ba138(0x308)]=_0x2ba138(0x2ba);if(_0x30d183['length']===0x0){_0x30e5e6['innerHTML']='<option\x20value=\x22\x22>未找到任何书库</option>';return;}_0x30d183[_0x2ba138(0x23b)](_0x391326=>{const _0x2d4075=_0x2ba138,_0x577cad=new Option(_0x391326,_0x391326);_0x30e5e6[_0x2d4075(0x311)](_0x577cad);}),log('成功加载\x20'+_0x30d183[_0x2ba138(0x2d2)]+'\x20个书库。','success');}catch(_0x4c6155){console[_0x2ba138(0x2e1)](_0x2ba138(0x274),_0x4c6155),log(_0x2ba138(0x366)+_0x4c6155[_0x2ba138(0x27d)],_0x2ba138(0x2e1)),_0x30e5e6['innerHTML']=_0x2ba138(0x356);}}async function handleWorldbookSelectionChange(){const _0x1f91d8=_0x49cd00,_0x583231=document[_0x1f91d8(0x232)]('hly-hist-select-library'),_0x351b85=document['getElementById'](_0x1f91d8(0x2da)),_0x587ee2=document[_0x1f91d8(0x232)](_0x1f91d8(0x204)),_0x2d5df4=_0x583231[_0x1f91d8(0x2b4)];_0x351b85['disabled']=!![],_0x351b85[_0x1f91d8(0x1e2)](_0x1f91d8(0x352))[_0x1f91d8(0x1fb)]=_0x1f91d8(0x1cf),_0x587ee2[_0x1f91d8(0x308)]='',_0x587ee2[_0x1f91d8(0x230)][_0x1f91d8(0x247)]='none';if(!_0x2d5df4){_0x351b85[_0x1f91d8(0x1e2)](_0x1f91d8(0x352))['textContent']=_0x1f91d8(0x324);return;}try{log(_0x1f91d8(0x20b)+_0x2d5df4+_0x1f91d8(0x1fe),_0x1f91d8(0x1be));const _0x9f9693=await _0x5daeb7[_0x1f91d8(0x2f5)](_0x2d5df4);if(_0x9f9693['length']===0x0){_0x351b85[_0x1f91d8(0x1e2)](_0x1f91d8(0x352))[_0x1f91d8(0x1fb)]=_0x1f91d8(0x208);return;}const _0x196f86=_0x1f91d8(0x292);_0x587ee2['insertAdjacentHTML'](_0x1f91d8(0x29c),_0x196f86),_0x9f9693[_0x1f91d8(0x23b)](_0x5ad8ed=>{const _0x194995=_0x1f91d8,_0x27c2a8=_0x194995(0x1e9)+_0x5ad8ed[_0x194995(0x333)]+_0x194995(0x27e)+_0x5ad8ed[_0x194995(0x32e)]+_0x194995(0x25f)+_0x5ad8ed[_0x194995(0x32e)]+_0x194995(0x36e)+_0x5ad8ed[_0x194995(0x333)]+_0x194995(0x2a5);_0x587ee2['insertAdjacentHTML'](_0x194995(0x29c),_0x27c2a8);}),log(_0x1f91d8(0x305)+_0x9f9693[_0x1f91d8(0x2d2)]+_0x1f91d8(0x1eb),'success'),_0x351b85[_0x1f91d8(0x1e2)](_0x1f91d8(0x352))[_0x1f91d8(0x1fb)]=_0x1f91d8(0x370)+_0x9f9693[_0x1f91d8(0x2d2)]+_0x1f91d8(0x23a);}catch(_0x50565f){console[_0x1f91d8(0x2e1)](_0x1f91d8(0x264)+_0x2d5df4+_0x1f91d8(0x2f7),_0x50565f),log(_0x1f91d8(0x1d9)+_0x50565f[_0x1f91d8(0x27d)],_0x1f91d8(0x2e1)),_0x351b85[_0x1f91d8(0x1e2)](_0x1f91d8(0x352))[_0x1f91d8(0x1fb)]=_0x1f91d8(0x200);}finally{_0x351b85[_0x1f91d8(0x29e)]=![];}}async function startHistoriography(){const _0x1b8311=_0x49cd00,_0x59be5b=document[_0x1b8311(0x232)](_0x1b8311(0x2b8))[_0x1b8311(0x2b4)],_0x415fc1=document[_0x1b8311(0x232)](_0x1b8311(0x204)),_0x36e43a=document[_0x1b8311(0x232)](_0x1b8311(0x261)),_0x1c537f=Array[_0x1b8311(0x33f)](_0x415fc1[_0x1b8311(0x223)](_0x1b8311(0x1b5)))[_0x1b8311(0x1e5)](_0x32cc22=>_0x32cc22[_0x1b8311(0x2b4)]);if(!_0x59be5b||_0x1c537f[_0x1b8311(0x2d2)]===0x0){toastr[_0x1b8311(0x1c9)](_0x1b8311(0x373),'圣谕不明');return;}_0x36e43a[_0x1b8311(0x1fb)]='准备对《'+_0x59be5b+_0x1b8311(0x22c)+_0x1c537f[_0x1b8311(0x2d2)]+_0x1b8311(0x27b),toastr[_0x1b8311(0x1be)]('批量编纂任务已开始...','圣旨'),log('开始对《'+_0x59be5b+_0x1b8311(0x22c)+_0x1c537f[_0x1b8311(0x2d2)]+_0x1b8311(0x1d8),_0x1b8311(0x1be));try{const _0x59586b=await _0x5daeb7[_0x1b8311(0x2d7)](_0x59be5b,_0x1c537f);_0x36e43a['textContent']=_0x59586b[_0x1b8311(0x312)],_0x59586b[_0x1b8311(0x2b3)]?toastr[_0x1b8311(0x2b3)](_0x1b8311(0x2f3),'大功告成'):toastr[_0x1b8311(0x1c9)](_0x1b8311(0x33a),'圣谕'),log('对《'+_0x59be5b+_0x1b8311(0x337)+_0x59586b[_0x1b8311(0x2c1)]+_0x1b8311(0x36d)+_0x59586b[_0x1b8311(0x316)],_0x1b8311(0x2b3));}catch(_0x277897){console[_0x1b8311(0x2e1)]('[翰林院-枢纽]\x20编纂过程发生严重错误:',_0x277897),toastr['error'](_0x1b8311(0x31e)+_0x277897['message'],_0x1b8311(0x25e)),_0x36e43a[_0x1b8311(0x1fb)]=_0x1b8311(0x31e)+_0x277897[_0x1b8311(0x27d)];}finally{await updatePanelStatus();}}async function showStats(){const _0x2eea16=_0x49cd00;try{log(_0x2eea16(0x209),'info'),toastr[_0x2eea16(0x1be)](_0x2eea16(0x1ec),'圣旨');const _0x1ea3dc=await _0x2b0a92['getVectorCount'](),_0x1fef2d=await _0x2b0a92['getCollectionId'](),_0x45a22b=_0x2b0a92[_0x2eea16(0x1df)](),_0x4e3073=_0x2eea16(0x35a)+_0x1fef2d+_0x2eea16(0x310)+_0x1ea3dc+_0x2eea16(0x35e)+_0x45a22b[_0x2eea16(0x30e)]['apiEndpoint']+_0x2eea16(0x21c)+_0x45a22b[_0x2eea16(0x30e)][_0x2eea16(0x322)]+'\x0a</pre>\x0a\x20\x20\x20\x20\x20\x20\x20\x20';toastr[_0x2eea16(0x1be)](_0x4e3073,_0x2eea16(0x1ee),{'timeOut':0x3a98,'extendedTimeOut':0x1388,'tapToDismiss':!![],'closeButton':!![]}),log(_0x2eea16(0x1c0)+_0x1fef2d+_0x2eea16(0x275)+_0x1ea3dc,'success');}catch(_0x4c3ae3){console[_0x2eea16(0x2e1)](_0x2eea16(0x255),_0x4c3ae3),toastr[_0x2eea16(0x2e1)]('查询宝库状态失败:\x20'+_0x4c3ae3[_0x2eea16(0x27d)],'严重错误'),log('查询宝库状态失败:\x20'+_0x4c3ae3[_0x2eea16(0x27d)],_0x2eea16(0x2e1));}}function showExclusionRulesModal(){const _0x1bd7c2=_0x49cd00,_0x567a47=_0x2b0a92[_0x1bd7c2(0x1df)](),_0x13e779=_0x567a47[_0x1bd7c2(0x224)][_0x1bd7c2(0x228)]||[],_0x39ff5f=(_0x1fd193={'start':'','end':''},_0x6ee011)=>'\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-exclusion-rule-row\x22\x20data-index=\x22'+_0x6ee011+_0x1bd7c2(0x296)+_0x1fd193[_0x1bd7c2(0x1de)]+'\x22\x20placeholder=\x22开始字符,\x20如\x20<!--\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span>到</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20class=\x22hly-imperial-brush\x22\x20value=\x22'+_0x1fd193[_0x1bd7c2(0x30c)]+'\x22\x20placeholder=\x22结束字符,\x20如\x20-->\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22hly-delete-rule-btn\x22\x20title=\x22删除此规则\x22>&times;</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20',_0x5eea2e=_0x13e779[_0x1bd7c2(0x1e5)](_0x39ff5f)[_0x1bd7c2(0x1d2)](''),_0x38b290=_0x1bd7c2(0x246)+_0x5eea2e+_0x1bd7c2(0x319);showHtmlModal(_0x1bd7c2(0x313),_0x38b290,{'okText':_0x1bd7c2(0x349),'onOk':_0x5ade93=>{const _0x1cc71e=_0x1bd7c2,_0x154556=[];_0x5ade93[_0x1cc71e(0x20e)]('.hly-exclusion-rule-row')[_0x1cc71e(0x2cb)](function(){const _0x147844=_0x1cc71e,_0x42a7f1=$(this)[_0x147844(0x20e)](_0x147844(0x273))['eq'](0x0)[_0x147844(0x2dc)]()['trim'](),_0x20a9f6=$(this)[_0x147844(0x20e)](_0x147844(0x273))['eq'](0x1)[_0x147844(0x2dc)]()['trim']();_0x42a7f1&&_0x20a9f6&&_0x154556['push']({'start':_0x42a7f1,'end':_0x20a9f6});}),updateAndSaveSetting(_0x1cc71e(0x1f8),_0x154556),toastr['success'](_0x1cc71e(0x31d),_0x1cc71e(0x34d));}});const _0x3dd52b=document[_0x1bd7c2(0x232)](_0x1bd7c2(0x2e0)),_0x3591e9=_0x3dd52b[_0x1bd7c2(0x1e2)](_0x1bd7c2(0x2e3));_0x3dd52b['querySelector'](_0x1bd7c2(0x1f9))['addEventListener'](_0x1bd7c2(0x2c2),()=>{const _0x28ce55=_0x1bd7c2,_0x4545c4=_0x3591e9['children'][_0x28ce55(0x2d2)],_0xbaf873=_0x39ff5f({'start':'','end':''},_0x4545c4);_0x3591e9[_0x28ce55(0x287)]('beforeend',_0xbaf873);}),_0x3591e9[_0x1bd7c2(0x266)](_0x1bd7c2(0x2c2),_0x3ebf6b=>{const _0x535458=_0x1bd7c2;_0x3ebf6b['target'][_0x535458(0x33c)][_0x535458(0x2be)]('hly-delete-rule-btn')&&_0x3ebf6b[_0x535458(0x1e0)]['closest'](_0x535458(0x2a6))['remove']();});}function previewCondensation(){const _0x53e675=_0x49cd00,_0x4afc6c=document[_0x53e675(0x232)](_0x53e675(0x210));try{const _0x2237b2=_0x2b0a92[_0x53e675(0x1df)](),_0x4fcef1=_0x2237b2[_0x53e675(0x224)][_0x53e675(0x228)]||[],_0x5135fd={'user':document['getElementById']('hly-include-user')[_0x53e675(0x214)],'ai':document[_0x53e675(0x232)](_0x53e675(0x367))[_0x53e675(0x214)]},_0x218e89=document['getElementById']('hly-tag-extraction-toggle')[_0x53e675(0x214)],_0x348b86=_0x218e89?document[_0x53e675(0x232)](_0x53e675(0x365))[_0x53e675(0x2b4)][_0x53e675(0x24c)](',')[_0x53e675(0x1e5)](_0x136985=>_0x136985['trim']())['filter'](Boolean):[],_0x4336e4=_0x2b0a92['getMessagesForCondensation'](_0x5135fd);if(!_0x4336e4||_0x4336e4['length']===0x0){_0x4afc6c[_0x53e675(0x1fb)]=_0x53e675(0x2dd),toastr['warning'](_0x53e675(0x317),_0x53e675(0x258));return;}const _0xf11c13=getContext()[_0x53e675(0x221)],_0x17d071=_0x4336e4[_0x53e675(0x1e5)]((_0xbf1903,_0x154d78)=>{const _0x26dd78=_0x53e675;let _0x2a8d19;if(_0xbf1903[_0x26dd78(0x29a)])_0x2a8d19=_0xbf1903[_0x26dd78(0x1ed)];else{if(_0x218e89&&_0x348b86['length']>0x0){const _0x3b4b2b=extractBlocksByTags(_0xbf1903['mes'],_0x348b86);_0x2a8d19=_0x3b4b2b[_0x26dd78(0x1d2)]('\x0a\x0a');}else _0x2a8d19=_0xbf1903[_0x26dd78(0x1ed)];_0x2a8d19=applyExclusionRules(_0x2a8d19,_0x4fcef1);}const _0x396d10=_0xf11c13[_0x26dd78(0x346)](_0x3bfb67=>_0x3bfb67===_0xbf1903),_0x13abff=_0x396d10!==-0x1?_0x396d10+0x1:-0x1;return{'id':_0x26dd78(0x33d)+_0x154d78,'name':_0xbf1903[_0x26dd78(0x326)],'content':_0x2a8d19[_0x26dd78(0x1e7)](),'floor':_0x13abff,'is_user':_0xbf1903[_0x26dd78(0x29a)],'send_date':_0xbf1903[_0x26dd78(0x272)]};})[_0x53e675(0x2b7)](_0x1150a7=>_0x1150a7[_0x53e675(0x312)]);if(_0x17d071[_0x53e675(0x2d2)]===0x0){_0x4afc6c[_0x53e675(0x1fb)]=_0x53e675(0x291),toastr[_0x53e675(0x1c9)](_0x53e675(0x291),_0x53e675(0x258));return;}const _0x2a2178=_0x17d071[_0x53e675(0x1e5)]((_0x528d5d,_0x954e33)=>'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-preview-item-v2\x22\x20id=\x22'+_0x528d5d['id']+_0x53e675(0x1d4)+_0x528d5d[_0x53e675(0x328)]+'\x20楼:\x20['+_0x528d5d[_0x53e675(0x326)]+_0x53e675(0x1ce)+_0x528d5d['floor']+_0x53e675(0x2e5)+_0x528d5d[_0x53e675(0x29a)]+_0x53e675(0x35f)+_0x528d5d['send_date']+'\x22>'+_0x528d5d[_0x53e675(0x312)]+_0x53e675(0x332)+_0x528d5d['id']+_0x53e675(0x216))[_0x53e675(0x1d2)]('');showHtmlModal(_0x53e675(0x262),_0x53e675(0x201)+_0x2a2178+'</div>',{'okText':'确认并更新预览','onOk':_0x1e4fd1=>{const _0x1d0471=_0x53e675,_0x249756=[];_0x1e4fd1[_0x1d0471(0x20e)](_0x1d0471(0x1b9))[_0x1d0471(0x2cb)](function(){const _0x366662=_0x1d0471,_0x2b294d=$(this)['find'](_0x366662(0x1b7)),_0x15ef99=_0x2b294d[_0x366662(0x2dc)]();_0x15ef99[_0x366662(0x1e7)]()&&_0x249756[_0x366662(0x248)]({'mes':_0x15ef99,'is_user':_0x2b294d['data'](_0x366662(0x22f)),'send_date':_0x2b294d[_0x366662(0x278)]('send-date'),'floor':_0x2b294d[_0x366662(0x278)](_0x366662(0x328))});}),_0x4afc6c['dataset'][_0x1d0471(0x290)]=JSON[_0x1d0471(0x302)](_0x249756);const _0x421fff=document[_0x1d0471(0x232)](_0x1d0471(0x206))[_0x1d0471(0x2b4)],_0x38808b=document[_0x1d0471(0x232)](_0x1d0471(0x1c7))[_0x1d0471(0x2b4)];_0x4afc6c['textContent']=_0x1d0471(0x34a)+_0x421fff+_0x1d0471(0x26d)+_0x38808b+'\x20楼的内容（共\x20'+_0x249756['length']+'\x20条有效条目），请点击“开始凝识”进入自动向量化流程。',toastr['success']('预览内容已更新，可随时开始凝识。',_0x1d0471(0x34d));}}),$(_0x53e675(0x2cf))['on'](_0x53e675(0x2c2),function(_0x41daf2){const _0x21ac35=_0x53e675;_0x41daf2[_0x21ac35(0x212)]();const _0x463aef=$(this)[_0x21ac35(0x278)]('target');$('#'+_0x463aef)[_0x21ac35(0x34b)]();});}catch(_0x1ee4a6){console[_0x53e675(0x2e1)](_0x53e675(0x1ca),_0x1ee4a6),_0x4afc6c[_0x53e675(0x1fb)]=_0x53e675(0x225)+_0x1ee4a6['message'],toastr[_0x53e675(0x2e1)]('预览失败:\x20'+_0x1ee4a6['message'],_0x53e675(0x25e));}}function log(_0x4959ae,_0x299620=_0x49cd00(0x1be)){const _0x2b9f98=_0x49cd00,_0x1012c5=document[_0x2b9f98(0x232)](_0x2b9f98(0x1e1));if(!_0x1012c5)return;const _0x656f9=document[_0x2b9f98(0x2c5)]('p'),_0x5280c9=new Date()[_0x2b9f98(0x242)]();let _0x3d1ae5=_0x2b9f98(0x31c),_0x34e261=_0x2b9f98(0x321);switch(_0x299620){case'success':_0x3d1ae5=_0x2b9f98(0x1fc),_0x34e261=_0x2b9f98(0x298);break;case _0x2b9f98(0x2e1):_0x3d1ae5=_0x2b9f98(0x2d4),_0x34e261=_0x2b9f98(0x374);break;case _0x2b9f98(0x329):_0x3d1ae5=_0x2b9f98(0x1bf),_0x34e261=_0x2b9f98(0x36c);break;}_0x656f9[_0x2b9f98(0x2b9)]='hly-log-entry\x20'+_0x34e261,_0x656f9[_0x2b9f98(0x308)]=_0x2b9f98(0x2f4)+_0x3d1ae5+_0x2b9f98(0x1f4)+_0x5280c9+']\x20'+_0x4959ae;const _0x2ae30c=_0x1012c5[_0x2b9f98(0x1e2)](_0x2b9f98(0x334));_0x2ae30c&&_0x2ae30c[_0x2b9f98(0x34b)](),_0x1012c5['appendChild'](_0x656f9),_0x1012c5[_0x2b9f98(0x241)]=_0x1012c5[_0x2b9f98(0x2b1)];}async function ingestManualText(){const _0x1438b0=_0x49cd00,_0x4b61b5=document[_0x1438b0(0x232)](_0x1438b0(0x205)),_0x3bd04d=_0x4b61b5[_0x1438b0(0x2b4)][_0x1438b0(0x1e7)]();if(!_0x3bd04d){toastr[_0x1438b0(0x1c9)](_0x1438b0(0x2d9),_0x1438b0(0x258)),log(_0x1438b0(0x271),'warn');return;}log(_0x1438b0(0x1f2)+_0x3bd04d[_0x1438b0(0x2d2)],_0x1438b0(0x1be)),toastr['info'](_0x1438b0(0x281),'圣旨');try{const _0xd79d0d=await _0x2b0a92[_0x1438b0(0x309)](_0x3bd04d,_0x1438b0(0x280),{'sourceName':_0x1438b0(0x279)});if(_0xd79d0d['success'])toastr[_0x1438b0(0x2b3)](_0x1438b0(0x2a0)+_0xd79d0d[_0x1438b0(0x314)]+_0x1438b0(0x1b8),'大功告成'),log(_0x1438b0(0x297)+_0xd79d0d[_0x1438b0(0x314)]+_0x1438b0(0x1b8),_0x1438b0(0x2b3)),_0x4b61b5[_0x1438b0(0x2b4)]='';else throw new Error(_0xd79d0d[_0x1438b0(0x2e1)]||_0x1438b0(0x307));}catch(_0x1b7399){console[_0x1438b0(0x2e1)]('[翰林院-枢纽]\x20手动录入过程发生错误:',_0x1b7399),toastr[_0x1438b0(0x2e1)](_0x1438b0(0x2bd)+_0x1b7399[_0x1438b0(0x27d)],'严重错误'),log(_0x1438b0(0x36f)+_0x1b7399['message'],_0x1438b0(0x2e1));}finally{await updatePanelStatus();}}
