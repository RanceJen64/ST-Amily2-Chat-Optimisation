const _0x30c5e9=_0xe9ce;(function(_0x594cd1,_0x246ac1){const _0xd6bcdc=_0xe9ce,_0x105e1d=_0x594cd1();while(!![]){try{const _0x55c5e9=parseInt(_0xd6bcdc(0xbf))/0x1*(parseInt(_0xd6bcdc(0x16e))/0x2)+-parseInt(_0xd6bcdc(0x114))/0x3+parseInt(_0xd6bcdc(0x27b))/0x4*(parseInt(_0xd6bcdc(0xcb))/0x5)+parseInt(_0xd6bcdc(0x1f5))/0x6*(parseInt(_0xd6bcdc(0x243))/0x7)+-parseInt(_0xd6bcdc(0x120))/0x8+parseInt(_0xd6bcdc(0x17a))/0x9+parseInt(_0xd6bcdc(0x1c8))/0xa;if(_0x55c5e9===_0x246ac1)break;else _0x105e1d['push'](_0x105e1d['shift']());}catch(_0x54499a){_0x105e1d['push'](_0x105e1d['shift']());}}}(_0x1d12,0xd4239));import{getContext}from'/scripts/extensions.js';import*as _0x1d6382 from'../core/rag-processor.js';import*as _0x15d4ce from'../core/historiographer.js';import*as _0x7530ec from'../core/utils/context-utils.js';import*as _0x536e9e from'../core/ingestion-manager.js';import{showContentModal,showHtmlModal}from'./page-window.js';import{extractBlocksByTags,applyExclusionRules}from'../core/utils/rag-tag-extractor.js';import{filterWorldbooks,filterWorldbookEntries,highlightSearchMatch,debounce}from'../core/rag-processor.js';_0x30c5e9(0x211);function setupGlobalEventHandlers(){const _0x167668=_0x30c5e9;window[_0x167668(0x200)]=()=>saveSettingsFromUI(![]),window[_0x167668(0x19c)]=resetSettingsToUI,window[_0x167668(0x25b)]=testApi,window[_0x167668(0x1f8)]=fetchHLYEmbeddingModels,window[_0x167668(0x1b4)]=fetchHLYRerankModels,window['updateHLYMemoryCount']=updatePanelStatus,window[_0x167668(0x116)]=purgeStorage,window[_0x167668(0x1bd)]=startCondensation,window['previewHLYCondensation']=previewCondensation,window[_0x167668(0xf9)]=ingestManualText,window[_0x167668(0x207)]=log,window[_0x167668(0x271)]=showStats,window[_0x167668(0x155)]=startHistoriography;}function updateAndSaveSetting(_0x5854a4,_0xc3c4a9){const _0x1bb610=_0x30c5e9,_0x7035ec=_0x1d6382[_0x1bb610(0x108)]();if(!_0x7035ec)return;const _0x12be85=_0x5854a4['split']('.');let _0x241c4a=_0x7035ec;for(let _0x34f38c=0x0;_0x34f38c<_0x12be85['length']-0x1;_0x34f38c++){_0x241c4a=_0x241c4a[_0x12be85[_0x34f38c]]=_0x241c4a[_0x12be85[_0x34f38c]]||{};}_0x241c4a[_0x12be85[_0x12be85[_0x1bb610(0x174)]-0x1]]=_0xc3c4a9,_0x1d6382[_0x1bb610(0x1af)](),log(_0x1bb610(0x125)+_0x5854a4+'\x27\x20已更新为:\x20'+JSON['stringify'](_0xc3c4a9),_0x1bb610(0x140));}function bindAutoSaveEvents(){const _0x2ee5d2=_0x30c5e9,_0x33c679=document[_0x2ee5d2(0x14b)](_0x2ee5d2(0x1fd));if(!_0x33c679)return;_0x33c679[_0x2ee5d2(0xfc)](_0x2ee5d2(0x1ff),_0x46b375=>{const _0x4a1d2a=_0x2ee5d2,_0x15c35f=_0x46b375[_0x4a1d2a(0x17e)],_0x237228=_0x15c35f[_0x4a1d2a(0x111)][_0x4a1d2a(0x188)];if(!_0x237228)return;let _0x39faa3;const _0x192304=_0x15c35f['dataset'][_0x4a1d2a(0xa7)]||'string';if(_0x15c35f['type']===_0x4a1d2a(0x1f7))_0x39faa3=_0x15c35f[_0x4a1d2a(0x28c)];else{if(_0x15c35f[_0x4a1d2a(0xa7)]===_0x4a1d2a(0xf2)){if(_0x15c35f[_0x4a1d2a(0x28c)]){const _0x25b395=_0x33c679[_0x4a1d2a(0x1e1)]('input[name=\x22'+_0x15c35f[_0x4a1d2a(0x206)]+'\x22]'),_0x3ece3b=Array['from'](_0x25b395)[_0x4a1d2a(0x278)](_0x449a7d=>_0x449a7d['checked']);_0x39faa3=_0x3ece3b[_0x4a1d2a(0x1b2)];}else return;}else _0x39faa3=_0x15c35f['value'];}switch(_0x192304){case _0x4a1d2a(0x280):_0x39faa3=parseInt(_0x39faa3,0xa);break;case _0x4a1d2a(0xac):_0x39faa3=parseFloat(_0x39faa3);break;case _0x4a1d2a(0x237):typeof _0x39faa3!=='boolean'&&(_0x39faa3=_0x39faa3===_0x4a1d2a(0xb9));break;}if(_0x15c35f[_0x4a1d2a(0xa7)]==='radio'&&!_0x15c35f[_0x4a1d2a(0x28c)])return;updateAndSaveSetting(_0x237228,_0x39faa3);});}export function bindHanlinyuanEvents(){const _0x1ca1f2=_0x30c5e9,_0x143205=getContext();if(!_0x143205){console[_0x1ca1f2(0x277)]('[翰林院-枢纽]\x20未能获取SillyTavern上下文，绑定失败。');return;}setupGlobalEventHandlers(),bindPanelToggleEvents(),bindInternalUIEvents(),bindTutorialEvents(),bindAutoSaveEvents(),bindSessionLockEvent(),initializeUnifiedInjectionEditor();if(_0x1d6382[_0x1ca1f2(0x1aa)])_0x1d6382[_0x1ca1f2(0x1aa)]();else{console['error'](_0x1ca1f2(0x23d));return;}loadSettingsToUI(),loadWorldbookList(),log('[翰林院-枢纽]\x20已成功连接各部，政令畅通。',_0x1ca1f2(0x185));const _0x298ac1=document[_0x1ca1f2(0x14b)](_0x1ca1f2(0x17c)),_0xb48dbe=document[_0x1ca1f2(0x14b)](_0x1ca1f2(0x18f)),_0x44be8b=document[_0x1ca1f2(0x14b)](_0x1ca1f2(0x168)),_0x204318=document['getElementById']('hanlinyuan-ingest-abort'),_0x16c21d=document['getElementById']('hanlinyuan-ingest-progress-container'),_0x57bb8c=document[_0x1ca1f2(0x14b)]('hanlinyuan-ingest-progress-bar'),_0x455685=document[_0x1ca1f2(0x14b)](_0x1ca1f2(0x28d)),_0x2fd3e2=document[_0x1ca1f2(0x14b)](_0x1ca1f2(0x28b));let _0x2c723d=null,_0x42c91a=null;_0x298ac1[_0x1ca1f2(0xfc)](_0x1ca1f2(0x1ff),_0x3a6e72=>{const _0x200552=_0x1ca1f2;_0x2c723d=_0x3a6e72[_0x200552(0x17e)][_0x200552(0x130)][0x0],_0x2c723d?(_0xb48dbe[_0x200552(0x24d)]=_0x2c723d['name'],_0xb48dbe[_0x200552(0x251)]=_0x2c723d[_0x200552(0x206)]):_0xb48dbe[_0x200552(0x24d)]=_0x200552(0x183);}),_0x44be8b['addEventListener'](_0x1ca1f2(0x10f),async()=>{const _0x3a3ab3=_0x1ca1f2;if(!_0x2c723d){toastr[_0x3a3ab3(0x146)](_0x3a3ab3(0x229));return;}let _0xb1533c=0x0;const _0x18fe2c=_0x536e9e[_0x3a3ab3(0x163)](_0x2c723d),_0x1944fc=_0x536e9e['loadProgress'](_0x18fe2c);if(_0x1944fc){const _0x16e95c=(_0x1944fc[_0x3a3ab3(0x21e)]/_0x1944fc['totalChunks']*0x64)[_0x3a3ab3(0xc4)](0x1),_0x13f0b7=confirm(_0x3a3ab3(0x1a8)+_0x16e95c+_0x3a3ab3(0x16c));_0x13f0b7?(_0xb1533c=_0x1944fc['processedChunks'],toastr[_0x3a3ab3(0x185)]('遵命，将从第\x20'+(_0xb1533c+0x1)+_0x3a3ab3(0x16b),_0x3a3ab3(0x1a9)),log(_0x3a3ab3(0x241)+_0x18fe2c+_0x3a3ab3(0x190)+_0xb1533c+_0x3a3ab3(0xbe),'info')):(_0x536e9e[_0x3a3ab3(0x15f)](_0x18fe2c),toastr[_0x3a3ab3(0x185)](_0x3a3ab3(0x1b5),_0x3a3ab3(0x1a9)),log(_0x3a3ab3(0xc5)+_0x18fe2c+'，重新开始。',_0x3a3ab3(0x1b7)));}_0x42c91a=new AbortController();const _0x137dbe=_0x42c91a[_0x3a3ab3(0xe8)];_0x2fd3e2[_0x3a3ab3(0x109)][_0x3a3ab3(0x1b0)]=_0x3a3ab3(0x1be),_0x16c21d['style'][_0x3a3ab3(0x1b0)]='block',_0x455685['textContent']=_0x3a3ab3(0x147),_0x57bb8c[_0x3a3ab3(0x1b2)]=0x0;try{const _0x360904=await _0x2c723d[_0x3a3ab3(0xcc)](),_0x1ed705=_0x1aa988=>{const _0xf1c65d=_0x3a3ab3;_0x455685[_0xf1c65d(0x24d)]=_0xf1c65d(0x177)+_0x1aa988[_0xf1c65d(0x250)]+'\x20('+_0x1aa988['processed']+'/'+_0x1aa988[_0xf1c65d(0x221)]+')',_0x57bb8c['value']=_0x1aa988[_0xf1c65d(0xc9)]/_0x1aa988[_0xf1c65d(0x221)]*0x64;},_0x16aedc=()=>{const _0x8c33fd=_0x3a3ab3;updatePanelStatus(),log(_0x8c33fd(0x205),_0x8c33fd(0x185));},_0x4022d2=await _0x1d6382[_0x3a3ab3(0xa0)](_0x360904,_0x3a3ab3(0x172),{'sourceName':_0x2c723d[_0x3a3ab3(0x206)]},_0x1ed705,_0x137dbe,log,_0x16aedc,_0x18fe2c,_0xb1533c);if(_0x4022d2[_0x3a3ab3(0x140)])toastr['success']('成功录入\x20'+_0x4022d2[_0x3a3ab3(0x1db)]+'\x20个知识块'),_0x455685[_0x3a3ab3(0x24d)]='任务完成！成功录入\x20'+_0x4022d2[_0x3a3ab3(0x1db)]+_0x3a3ab3(0x121),_0x57bb8c[_0x3a3ab3(0x1b2)]=0x64,updatePanelStatus();else throw new Error(_0x4022d2[_0x3a3ab3(0x277)]||_0x3a3ab3(0x26b));}catch(_0x35bbae){_0x35bbae[_0x3a3ab3(0x206)]===_0x3a3ab3(0xf3)?(toastr[_0x3a3ab3(0x185)](_0x3a3ab3(0x1a7)),_0x455685[_0x3a3ab3(0x24d)]=_0x3a3ab3(0xc1)):(toastr['error'](_0x3a3ab3(0x18c)+_0x35bbae[_0x3a3ab3(0x250)]+'。进度已保存，可稍后重试。'),_0x455685[_0x3a3ab3(0x24d)]=_0x3a3ab3(0x139)+_0x35bbae[_0x3a3ab3(0x250)]);}finally{setTimeout(()=>{const _0x5496a4=_0x3a3ab3;_0x2fd3e2[_0x5496a4(0x109)][_0x5496a4(0x1b0)]=_0x5496a4(0x257),_0x16c21d[_0x5496a4(0x109)][_0x5496a4(0x1b0)]='none',_0x298ac1[_0x5496a4(0x1b2)]='',_0x2c723d=null,_0xb48dbe[_0x5496a4(0x24d)]=_0x5496a4(0x183);},0xbb8);}}),_0x204318[_0x1ca1f2(0xfc)]('click',()=>{const _0x35eaed=_0x1ca1f2;_0x42c91a&&_0x42c91a[_0x35eaed(0x10e)]();});}function bindSessionLockEvent(){const _0x4f578f=_0x30c5e9,_0xc9a714=document[_0x4f578f(0x14b)](_0x4f578f(0x179));if(!_0xc9a714)return;_0xc9a714[_0x4f578f(0xfc)]('click',async()=>{const _0x460227=_0x4f578f,_0x14adad=await _0x1d6382['toggleSessionLock']();updateSessionLockUI(_0x14adad);if(_0x14adad){const _0x52d3af=_0x1d6382['getLockedSessionInfo']();_0x52d3af&&(toastr[_0x460227(0x140)](_0x460227(0x256)+_0x52d3af['id'],_0x460227(0x187)),log('会话已锁定到宝库:\x20'+_0x52d3af['id'],_0x460227(0x140)));}else toastr[_0x460227(0x185)]('会话已解锁，将跟随当前角色。','诏曰'),log(_0x460227(0x19f),_0x460227(0x185));updatePanelStatus();}),updateSessionLockUI(_0x1d6382[_0x4f578f(0x23e)]());}function updateSessionLockUI(_0x41d3e3){const _0x14fdcb=_0x30c5e9,_0x308ddb=document['getElementById']('hly-session-lock-btn');if(!_0x308ddb)return;const _0x4f064c=_0x308ddb[_0x14fdcb(0x242)]('i'),_0x184033=_0x308ddb[_0x14fdcb(0x242)]('span');_0x41d3e3?(_0x308ddb[_0x14fdcb(0x167)][_0x14fdcb(0x152)]('active'),_0x4f064c[_0x14fdcb(0x1ab)]='fas\x20fa-lock',_0x184033['textContent']=_0x14fdcb(0x17f),_0x308ddb['title']=_0x14fdcb(0x261)):(_0x308ddb[_0x14fdcb(0x167)][_0x14fdcb(0x160)](_0x14fdcb(0x230)),_0x4f064c['className']=_0x14fdcb(0x124),_0x184033[_0x14fdcb(0x24d)]='锁定会话',_0x308ddb[_0x14fdcb(0x251)]=_0x14fdcb(0x212));}function bindPanelToggleEvents(){const _0x272b49=_0x30c5e9,_0x52f6fd=document[_0x272b49(0x14b)](_0x272b49(0x173));if(_0x52f6fd){}}function bindTutorialEvents(){const _0x550fad=_0x30c5e9,_0x32bfda=document[_0x550fad(0x14b)]('amily2_open_hanlin_tutorial');_0x32bfda&&_0x32bfda['addEventListener'](_0x550fad(0x10f),()=>{const _0x97d7a5=_0x550fad;showContentModal(_0x97d7a5(0xc7),'scripts/extensions/third-party/ST-Amily2-Chat-Optimisation/HanLin.md');});}function bindInternalUIEvents(){const _0x124c7d=_0x30c5e9,_0x5f0655=document['querySelectorAll']('.hly-nav-item');_0x5f0655['forEach'](_0x1df02b=>{const _0x40de3d=_0xe9ce;_0x1df02b[_0x40de3d(0xfc)](_0x40de3d(0x10f),()=>{const _0x5ea329=_0x40de3d,_0xc6d747=_0x1df02b[_0x5ea329(0x111)][_0x5ea329(0x27d)],_0x4c1af3='hly-'+_0xc6d747+_0x5ea329(0x113);document[_0x5ea329(0x1e1)](_0x5ea329(0x1c4))[_0x5ea329(0x1e5)](_0x13ec8d=>{const _0x13ce9a=_0x5ea329;_0x13ec8d[_0x13ce9a(0x167)][_0x13ce9a(0x1ea)](_0x13ce9a(0x230),_0x13ec8d['id']===_0x4c1af3);}),_0x5f0655[_0x5ea329(0x1e5)](_0x215319=>_0x215319[_0x5ea329(0x167)][_0x5ea329(0x1ea)]('active',_0x215319===_0x1df02b));});});const _0x348b99=document[_0x124c7d(0x14b)](_0x124c7d(0x228));_0x348b99&&_0x348b99['addEventListener']('change',handleApiModeChange);const _0x621561=document['getElementById'](_0x124c7d(0x13d)),_0x1ddf62=document[_0x124c7d(0x14b)](_0x124c7d(0x1f0));_0x621561&&_0x1ddf62&&_0x621561[_0x124c7d(0xfc)](_0x124c7d(0x1ff),()=>{const _0x469633=_0x124c7d;_0x1ddf62[_0x469633(0x109)]['display']=_0x621561['checked']?'block':_0x469633(0x1be);});const _0x30a5f5=document['getElementById'](_0x124c7d(0x1ec));_0x30a5f5&&_0x30a5f5[_0x124c7d(0xfc)](_0x124c7d(0x1ff),handleWorldbookSelectionChange);const _0x4da639=document[_0x124c7d(0x14b)]('hly-exclusion-rules-btn');_0x4da639&&_0x4da639['addEventListener']('click',showExclusionRulesModal);const _0xb57d01=document[_0x124c7d(0x14b)](_0x124c7d(0x269)),_0x52810d=document[_0x124c7d(0x14b)](_0x124c7d(0x253));_0xb57d01&&_0x52810d&&(_0xb57d01[_0x124c7d(0xfc)](_0x124c7d(0x10f),_0x2b49c4=>{const _0x13a3ca=_0x124c7d;_0x2b49c4[_0x13a3ca(0x1c9)]();const _0x2209ec=_0x52810d['style'][_0x13a3ca(0x1b0)]===_0x13a3ca(0xb4);_0x52810d[_0x13a3ca(0x109)][_0x13a3ca(0x1b0)]=_0x2209ec?_0x13a3ca(0x1be):_0x13a3ca(0xb4);}),_0x52810d[_0x124c7d(0xfc)](_0x124c7d(0x1ff),_0xbff031=>{const _0x27da60=_0x124c7d,_0x35e85d=_0xbff031[_0x27da60(0x17e)];if(_0x35e85d[_0x27da60(0xa7)]!=='checkbox')return;const _0x440158=_0x52810d['querySelectorAll'](_0x27da60(0xe3)),_0x502e4f=document[_0x27da60(0x14b)]('hly-hist-select-all-entries');if(_0x35e85d['id']===_0x27da60(0x255))_0x440158['forEach'](_0x5b6b2d=>_0x5b6b2d[_0x27da60(0x28c)]=_0x35e85d[_0x27da60(0x28c)]);else{const _0x1a2f64=Array[_0x27da60(0x25c)](_0x440158)['every'](_0x1009ea=>_0x1009ea[_0x27da60(0x28c)]);_0x502e4f[_0x27da60(0x28c)]=_0x1a2f64;}const _0x3a5280=_0x52810d[_0x27da60(0x1e1)]('.hly-hist-entry-checkbox:checked')['length'],_0x168cce=_0x440158[_0x27da60(0x174)];_0xb57d01['querySelector']('span')[_0x27da60(0x24d)]=_0x27da60(0x1a0)+_0x3a5280+_0x27da60(0x263)+_0x168cce+_0x27da60(0xdf);}),document[_0x124c7d(0xfc)](_0x124c7d(0x10f),_0x514576=>{const _0x58f492=_0x124c7d;!_0xb57d01[_0x58f492(0x1c6)](_0x514576[_0x58f492(0x17e)])&&!_0x52810d['contains'](_0x514576[_0x58f492(0x17e)])&&(_0x52810d[_0x58f492(0x109)]['display']=_0x58f492(0x1be));}));const _0x28f27e=document[_0x124c7d(0x14b)](_0x124c7d(0x182));_0x28f27e&&_0x28f27e[_0x124c7d(0xfc)](_0x124c7d(0x10f),deleteAllLocalKnowledgeBases);const _0x45eebc=document[_0x124c7d(0x14b)](_0x124c7d(0x16d));_0x45eebc&&_0x45eebc[_0x124c7d(0xfc)](_0x124c7d(0x10f),()=>moveAllKnowledgeBases(_0x124c7d(0x1ca)));const _0x2390e8=document[_0x124c7d(0x14b)](_0x124c7d(0x1e9));_0x2390e8&&_0x2390e8[_0x124c7d(0xfc)](_0x124c7d(0x10f),()=>moveAllKnowledgeBases(_0x124c7d(0x20a)));const _0x2ead3a=['hly-kb-list-local',_0x124c7d(0x11d)];_0x2ead3a['forEach'](_0x54c950=>{const _0x30619d=_0x124c7d,_0x516433=document[_0x30619d(0x14b)](_0x54c950);_0x516433&&(_0x516433[_0x30619d(0xfc)](_0x30619d(0x10f),handleKbAction),_0x516433[_0x30619d(0xfc)](_0x30619d(0x1ff),handleKbAction));}),document['getElementById'](_0x124c7d(0x279))[_0x124c7d(0xfc)](_0x124c7d(0x1ff),_0x5120cd=>handleSelectAll(_0x5120cd,'global')),document[_0x124c7d(0x14b)](_0x124c7d(0x184))[_0x124c7d(0xfc)](_0x124c7d(0x1ff),_0x12c0e9=>handleSelectAll(_0x12c0e9,'local')),document[_0x124c7d(0x14b)](_0x124c7d(0x274))[_0x124c7d(0xfc)]('click',_0x13eede=>handleBulkAction(_0x13eede,_0x124c7d(0x220))),document[_0x124c7d(0x14b)](_0x124c7d(0x166))[_0x124c7d(0xfc)]('click',_0x5e9eb9=>handleBulkAction(_0x5e9eb9,'local'));}function initializeUnifiedInjectionEditor(){const _0x3bae20=_0x30c5e9,_0x5d09f9=document[_0x3bae20(0x14b)](_0x3bae20(0x132)),_0x182885=document[_0x3bae20(0x14b)](_0x3bae20(0x218)),_0xac9c55=document[_0x3bae20(0x14b)](_0x3bae20(0x26c)),_0x503cb9=document[_0x3bae20(0x1e1)]('input[name=\x22hly-unified-injection-position\x22]'),_0x549f88=document['getElementById'](_0x3bae20(0xc0)),_0x48110a=document[_0x3bae20(0x14b)](_0x3bae20(0x194));if(!_0x5d09f9)return;const _0x9e0fac={'novel':'{{novel_text}}','chat':_0x3bae20(0x225),'lorebook':_0x3bae20(0x198),'manual':'{{manual_text}}'};function _0x25d0d6(){const _0xa82f80=_0x3bae20,_0x1d4f8d=_0x5d09f9[_0xa82f80(0x1b2)],_0x359b0c=_0x1d6382[_0xa82f80(0x108)](),_0x4a2dc2=_0x359b0c[_0xa82f80(0x12c)+_0x1d4f8d]||{};_0x182885[_0xa82f80(0x1b2)]=_0x4a2dc2['template']||'',_0xac9c55[_0xa82f80(0x24d)]='以\x20'+(_0x9e0fac[_0x1d4f8d]||_0xa82f80(0x178))+'\x20为占位符。';const _0x5c5668=_0x4a2dc2[_0xa82f80(0x10d)]!==undefined?String(_0x4a2dc2['position']):'2';_0x503cb9['forEach'](_0x41782b=>_0x41782b[_0xa82f80(0x28c)]=_0x41782b[_0xa82f80(0x1b2)]===_0x5c5668),_0x549f88['value']=_0x4a2dc2[_0xa82f80(0xe9)]||0x0,_0x48110a['value']=_0x4a2dc2[_0xa82f80(0x1d7)]!==undefined?String(_0x4a2dc2[_0xa82f80(0x1d7)]):'0';const _0x267a59=_0x5c5668==='1';_0x549f88[_0xa82f80(0xab)]=!_0x267a59,_0x48110a['disabled']=!_0x267a59;}function _0x5296bb(){const _0x1c2120=_0x3bae20,_0x69c9e1=_0x5d09f9['value'];updateAndSaveSetting('injection_'+_0x69c9e1+'.template',_0x182885[_0x1c2120(0x1b2)]);const _0x397b9b=document[_0x1c2120(0x242)](_0x1c2120(0x153));_0x397b9b&&updateAndSaveSetting(_0x1c2120(0x12c)+_0x69c9e1+_0x1c2120(0x180),parseInt(_0x397b9b[_0x1c2120(0x1b2)],0xa)),updateAndSaveSetting(_0x1c2120(0x12c)+_0x69c9e1+_0x1c2120(0xf8),parseInt(_0x549f88['value'],0xa)),updateAndSaveSetting(_0x1c2120(0x12c)+_0x69c9e1+_0x1c2120(0x1c7),parseInt(_0x48110a[_0x1c2120(0x1b2)],0xa));}_0x5d09f9[_0x3bae20(0xfc)](_0x3bae20(0x1ff),_0x25d0d6);const _0x318433=debounce(_0x5296bb,0x12c);_0x182885[_0x3bae20(0xfc)](_0x3bae20(0xb5),_0x318433),_0x549f88[_0x3bae20(0xfc)](_0x3bae20(0x1ff),_0x5296bb),_0x48110a[_0x3bae20(0xfc)](_0x3bae20(0x1ff),_0x5296bb),_0x503cb9[_0x3bae20(0x1e5)](_0x1e9dfd=>_0x1e9dfd[_0x3bae20(0xfc)](_0x3bae20(0x1ff),()=>{const _0x2172a4=_0x3bae20;_0x5296bb();const _0xc7dfd0=_0x1e9dfd[_0x2172a4(0x1b2)]==='1'&&_0x1e9dfd[_0x2172a4(0x28c)];_0x549f88['disabled']=!_0xc7dfd0,_0x48110a[_0x2172a4(0xab)]=!_0xc7dfd0;})),_0x25d0d6();}function handleApiModeChange(){const _0x533f64=_0x30c5e9,_0x170099=document[_0x533f64(0x14b)](_0x533f64(0x228))[_0x533f64(0x1b2)],_0x5a8b7e=document[_0x533f64(0x14b)]('hly-custom-endpoint-docket'),_0x2c3cc9=document[_0x533f64(0x14b)](_0x533f64(0x12a)),_0xa09168=document['getElementById']('hly-embedding-model'),_0x35a9ae=_0xa09168['previousElementSibling'];if(!_0x5a8b7e||!_0x2c3cc9)return;_0x5a8b7e['style'][_0x533f64(0x1b0)]=_0x533f64(0xb4),_0x2c3cc9[_0x533f64(0x109)]['display']=_0x533f64(0xb4);switch(_0x170099){case _0x533f64(0xbd):_0x5a8b7e[_0x533f64(0x109)]['display']=_0x533f64(0x1be),_0x2c3cc9['querySelector'](_0x533f64(0x176))[_0x533f64(0x24d)]='Google\x20API\x20Key:',_0x2c3cc9[_0x533f64(0x242)]('input')['placeholder']='请输入您的Google\x20API\x20Key';break;case _0x533f64(0x1cb):_0x5a8b7e[_0x533f64(0x242)]('label')[_0x533f64(0x24d)]=_0x533f64(0xf6),_0x5a8b7e[_0x533f64(0x242)]('input')['placeholder']=_0x533f64(0x21f),_0x2c3cc9[_0x533f64(0x109)]['display']=_0x533f64(0x1be);break;case _0x533f64(0xef):default:_0x5a8b7e[_0x533f64(0x242)]('label')[_0x533f64(0x24d)]=_0x533f64(0x282),_0x5a8b7e[_0x533f64(0x242)](_0x533f64(0xb5))[_0x533f64(0xcd)]=_0x533f64(0x117),_0x2c3cc9[_0x533f64(0x242)](_0x533f64(0x176))[_0x533f64(0x24d)]=_0x533f64(0x28e);break;}}function loadSettingsToUI(){const _0x3f1d5c=_0x30c5e9,_0x50a151=_0x1d6382[_0x3f1d5c(0x108)]();if(!_0x50a151)return;document['getElementById'](_0x3f1d5c(0x22c))[_0x3f1d5c(0x28c)]=_0x50a151['retrieval'][_0x3f1d5c(0xf7)],document[_0x3f1d5c(0x14b)](_0x3f1d5c(0x228))[_0x3f1d5c(0x1b2)]=_0x50a151[_0x3f1d5c(0x24e)][_0x3f1d5c(0x25f)],document['getElementById'](_0x3f1d5c(0x272))['value']=_0x50a151['retrieval']['customApiUrl'],document[_0x3f1d5c(0x14b)](_0x3f1d5c(0x1d9))[_0x3f1d5c(0x1b2)]=_0x50a151['retrieval']['apiKey'];const _0x1e5082=document[_0x3f1d5c(0x14b)](_0x3f1d5c(0x1fe));if(_0x1e5082['options'][_0x3f1d5c(0x174)]===0x0){const _0x139fbd=_0x50a151['retrieval']['embeddingModel'],_0x332ee4=new Option(_0x139fbd,_0x139fbd,!![],!![]);_0x1e5082['add'](_0x332ee4);}_0x1e5082[_0x3f1d5c(0x1b2)]=_0x50a151[_0x3f1d5c(0x24e)][_0x3f1d5c(0x127)],document[_0x3f1d5c(0x14b)]('hly-retrieval-notify')[_0x3f1d5c(0x28c)]=_0x50a151['retrieval']['notify'],document[_0x3f1d5c(0x14b)](_0x3f1d5c(0x24b))[_0x3f1d5c(0x1b2)]=_0x50a151[_0x3f1d5c(0x15b)]['chunkSize'],document['getElementById']('hly-overlap-size')[_0x3f1d5c(0x1b2)]=_0x50a151[_0x3f1d5c(0x15b)]['overlap'],document[_0x3f1d5c(0x14b)](_0x3f1d5c(0x1f2))[_0x3f1d5c(0x1b2)]=_0x50a151['advanced'][_0x3f1d5c(0x287)],document['getElementById'](_0x3f1d5c(0x106))['value']=_0x50a151[_0x3f1d5c(0x15b)][_0x3f1d5c(0x248)],document['getElementById'](_0x3f1d5c(0x27e))['value']=_0x50a151[_0x3f1d5c(0x15b)]['maxResults'],document[_0x3f1d5c(0x14b)](_0x3f1d5c(0x1d1))['value']=_0x50a151[_0x3f1d5c(0x24e)]['batchSize'],handleApiModeChange(),document[_0x3f1d5c(0x14b)]('hly-condensation-enabled')[_0x3f1d5c(0x28c)]=_0x50a151[_0x3f1d5c(0x129)][_0x3f1d5c(0xf7)],document['getElementById'](_0x3f1d5c(0x284))[_0x3f1d5c(0x1b2)]=_0x50a151[_0x3f1d5c(0x129)][_0x3f1d5c(0x137)],document[_0x3f1d5c(0x14b)](_0x3f1d5c(0x103))['value']=_0x50a151['condensation'][_0x3f1d5c(0x240)],document[_0x3f1d5c(0x14b)](_0x3f1d5c(0xd9))['checked']=_0x50a151[_0x3f1d5c(0x129)][_0x3f1d5c(0x289)][_0x3f1d5c(0x13c)],document[_0x3f1d5c(0x14b)]('hly-include-ai')[_0x3f1d5c(0x28c)]=_0x50a151[_0x3f1d5c(0x129)]['messageTypes']['ai'];const _0x3519ff=document['getElementById'](_0x3f1d5c(0x13d)),_0x3dcf57=document[_0x3f1d5c(0x14b)](_0x3f1d5c(0x1ce)),_0xba4534=document[_0x3f1d5c(0x14b)](_0x3f1d5c(0x1f0));_0x3519ff[_0x3f1d5c(0x28c)]=_0x50a151[_0x3f1d5c(0x129)][_0x3f1d5c(0x144)],_0x3dcf57[_0x3f1d5c(0x1b2)]=_0x50a151[_0x3f1d5c(0x129)][_0x3f1d5c(0x19e)],_0xba4534[_0x3f1d5c(0x109)][_0x3f1d5c(0x1b0)]=_0x3519ff[_0x3f1d5c(0x28c)]?_0x3f1d5c(0xb4):'none',document[_0x3f1d5c(0x14b)]('hly-rerank-enabled')['checked']=_0x50a151[_0x3f1d5c(0xda)][_0x3f1d5c(0xf7)],document[_0x3f1d5c(0x14b)](_0x3f1d5c(0xd5))[_0x3f1d5c(0x1b2)]=_0x50a151[_0x3f1d5c(0xda)][_0x3f1d5c(0xaf)],document[_0x3f1d5c(0x14b)]('hly-rerank-api-key')['value']=_0x50a151[_0x3f1d5c(0xda)][_0x3f1d5c(0x110)];const _0x3eb593=document['getElementById'](_0x3f1d5c(0x27f));if(_0x3eb593['options'][_0x3f1d5c(0x174)]===0x0){const _0x36e174=_0x50a151[_0x3f1d5c(0xda)][_0x3f1d5c(0x164)];if(_0x36e174){const _0xf8c80f=new Option(_0x36e174,_0x36e174,!![],!![]);_0x3eb593['add'](_0xf8c80f);}}_0x3eb593[_0x3f1d5c(0x1b2)]=_0x50a151[_0x3f1d5c(0xda)][_0x3f1d5c(0x164)],document[_0x3f1d5c(0x14b)](_0x3f1d5c(0xd7))[_0x3f1d5c(0x1b2)]=_0x50a151['rerank'][_0x3f1d5c(0x11e)],document[_0x3f1d5c(0x14b)]('hly-rerank-hybrid-alpha')[_0x3f1d5c(0x1b2)]=_0x50a151['rerank'][_0x3f1d5c(0x1a5)],document[_0x3f1d5c(0x14b)](_0x3f1d5c(0x1f1))['checked']=_0x50a151[_0x3f1d5c(0xda)][_0x3f1d5c(0x1b9)];}function saveSettingsFromUI(_0x348d2d=!![]){const _0x5621d5=_0x30c5e9,_0x326763=document[_0x5621d5(0x14b)](_0x5621d5(0x1fd));if(!_0x326763)return;const _0x35c442=_0x326763['querySelectorAll'](_0x5621d5(0x1a4));_0x35c442[_0x5621d5(0x1e5)](_0x3d1fd6=>{const _0xb3ded4=_0x5621d5,_0x216ece=_0x3d1fd6['dataset'][_0xb3ded4(0x188)];if(!_0x216ece)return;let _0x1964e6;const _0x27876e=_0x3d1fd6['dataset'][_0xb3ded4(0xa7)]||_0xb3ded4(0x222);if(_0x3d1fd6[_0xb3ded4(0xa7)]===_0xb3ded4(0x1f7))_0x1964e6=_0x3d1fd6[_0xb3ded4(0x28c)];else{if(_0x3d1fd6[_0xb3ded4(0xa7)]==='radio'){if(!_0x3d1fd6['checked'])return;_0x1964e6=_0x3d1fd6[_0xb3ded4(0x1b2)];}else _0x1964e6=_0x3d1fd6[_0xb3ded4(0x1b2)];}switch(_0x27876e){case'integer':_0x1964e6=parseInt(_0x1964e6,0xa);break;case _0xb3ded4(0xac):_0x1964e6=parseFloat(_0x1964e6);break;case _0xb3ded4(0x237):if(typeof _0x1964e6!==_0xb3ded4(0x237))_0x1964e6=_0x1964e6==='true';break;}const _0x389fa3=_0x1d6382[_0xb3ded4(0x108)](),_0x620704=_0x216ece[_0xb3ded4(0x23a)]('.');let _0x492855=_0x389fa3;for(let _0x52173e=0x0;_0x52173e<_0x620704[_0xb3ded4(0x174)]-0x1;_0x52173e++){_0x492855=_0x492855[_0x620704[_0x52173e]]=_0x492855[_0x620704[_0x52173e]]||{};}_0x492855[_0x620704[_0x620704[_0xb3ded4(0x174)]-0x1]]=_0x1964e6;}),_0x1d6382['saveSettings'](),!_0x348d2d&&(log('【手动存档】所有设定已存档封印。',_0x5621d5(0x140)),toastr[_0x5621d5(0x140)](_0x5621d5(0xdd),_0x5621d5(0x1a9)));}function resetSettingsToUI(){const _0x362648=_0x30c5e9;confirm(_0x362648(0xd8))&&(_0x1d6382[_0x362648(0x219)](),loadSettingsToUI(),toastr['info'](_0x362648(0x203),'诏曰'));}async function updatePanelStatus(){const _0x5e0d2c=_0x30c5e9,_0x21b5df=_0x1d6382[_0x5e0d2c(0x23e)](),_0x496702=document[_0x5e0d2c(0x14b)](_0x5e0d2c(0xf1)),_0x4e63da=document['getElementById'](_0x5e0d2c(0x131));if(_0x21b5df){const _0x1450c9=_0x1d6382['getLockedSessionInfo']();_0x1450c9&&(_0x496702[_0x5e0d2c(0x24d)]=_0x5e0d2c(0xae),_0x4e63da[_0x5e0d2c(0x24d)]=_0x1450c9['id'],_0x4e63da[_0x5e0d2c(0x251)]=_0x5e0d2c(0x10a)+_0x1450c9['id'],_0x496702['classList']['add'](_0x5e0d2c(0x1e3)),_0x4e63da['classList'][_0x5e0d2c(0x152)](_0x5e0d2c(0x1e3)));}else _0x496702[_0x5e0d2c(0x24d)]=_0x7530ec[_0x5e0d2c(0xad)](),_0x4e63da[_0x5e0d2c(0x24d)]=_0x7530ec[_0x5e0d2c(0x1ed)]()||'无',_0x4e63da[_0x5e0d2c(0x251)]='',_0x496702[_0x5e0d2c(0x167)][_0x5e0d2c(0x160)](_0x5e0d2c(0x1e3)),_0x4e63da[_0x5e0d2c(0x167)][_0x5e0d2c(0x160)](_0x5e0d2c(0x1e3));const _0x30acdd=document[_0x5e0d2c(0x14b)](_0x5e0d2c(0x9d));_0x30acdd[_0x5e0d2c(0x24d)]='...';try{const _0x1e7248=await _0x1d6382[_0x5e0d2c(0x273)]();_0x30acdd[_0x5e0d2c(0x24d)]=_0x1e7248;}catch(_0x3cbdc2){console[_0x5e0d2c(0x277)](_0x5e0d2c(0xf4),_0x3cbdc2),_0x30acdd[_0x5e0d2c(0x24d)]=_0x5e0d2c(0x157),_0x30acdd[_0x5e0d2c(0x251)]=_0x5e0d2c(0x1df)+_0x3cbdc2[_0x5e0d2c(0x250)];}const _0x4efecd=document[_0x5e0d2c(0x14b)](_0x5e0d2c(0x13b));if(_0x4efecd&&!_0x4efecd[_0x5e0d2c(0x111)][_0x5e0d2c(0xd4)]){const _0x22e0b6=_0x1d6382[_0x5e0d2c(0x108)](),_0x57b4dc=await _0x1d6382[_0x5e0d2c(0x100)]();if(_0x22e0b6[_0x5e0d2c(0x27a)]&&_0x22e0b6[_0x5e0d2c(0x27a)][_0x57b4dc]){const _0x21bd92=_0x22e0b6[_0x5e0d2c(0x27a)][_0x57b4dc];_0x4efecd[_0x5e0d2c(0xff)]=_0x5e0d2c(0x1e0)+_0x21bd92[_0x5e0d2c(0xa1)]+_0x5e0d2c(0x19b)+_0x21bd92[_0x5e0d2c(0x288)]+_0x5e0d2c(0x1e6);}else _0x4efecd['innerHTML']=_0x5e0d2c(0x210);}renderKnowledgeBases();}async function moveAllKnowledgeBases(_0x22455b){const _0x33f157=_0x30c5e9,_0x1e395c=_0x22455b===_0x33f157(0x1ca),_0x116226=_0x1e395c?_0x33f157(0x220):_0x33f157(0x202),_0x1606f6=_0x1e395c?'局部':'全局',_0x3dc9be=_0x1e395c?_0x1d6382['getGlobalKnowledgeBases']():_0x1d6382[_0x33f157(0xba)](),_0x4d375d=Object['keys'](_0x3dc9be);if(_0x4d375d[_0x33f157(0x174)]===0x0){toastr[_0x33f157(0x185)](_0x33f157(0xce)+(_0x1e395c?'全局':'局部')+_0x33f157(0xc6),'圣谕');return;}if(!confirm(_0x33f157(0x16a)+_0x4d375d['length']+'\x20个知识库从【'+(_0x1e395c?'全局':'局部')+_0x33f157(0xe5)+_0x1606f6+_0x33f157(0x213)))return;log('开始将\x20'+_0x4d375d[_0x33f157(0x174)]+_0x33f157(0x118)+_0x116226+_0x33f157(0xf5)+(_0x1e395c?_0x33f157(0x202):_0x33f157(0x220))+_0x33f157(0x21d),_0x33f157(0x185));const _0x586501=_0x4d375d[_0x33f157(0x18d)](_0x966a14=>_0x1d6382[_0x33f157(0x14c)](_0x966a14,_0x116226));try{await Promise[_0x33f157(0x11f)](_0x586501),toastr[_0x33f157(0x140)]('所有\x20'+_0x4d375d[_0x33f157(0x174)]+_0x33f157(0x175),_0x33f157(0x260)),log(_0x33f157(0x20b),'success');}catch(_0x4098fd){toastr[_0x33f157(0x277)](_0x33f157(0x101)+_0x4098fd[_0x33f157(0x250)],'警报'),log(_0x33f157(0x227)+_0x4098fd[_0x33f157(0x250)],_0x33f157(0x277));}finally{await updatePanelStatus();}}async function deleteAllLocalKnowledgeBases(){const _0x498322=_0x30c5e9,_0x4470c4=_0x1d6382[_0x498322(0xba)](),_0x1373ae=Object[_0x498322(0xc8)](_0x4470c4);if(_0x1373ae[_0x498322(0x174)]===0x0){toastr[_0x498322(0x185)]('当前角色没有任何局部知识库可供删除。','圣谕');return;}if(!confirm(_0x498322(0x10b)+_0x1373ae[_0x498322(0x174)]+_0x498322(0x20c)))return;toastr['info']('正在删除\x20'+_0x1373ae[_0x498322(0x174)]+_0x498322(0xb6),'圣旨'),log(_0x498322(0x143)+_0x1373ae[_0x498322(0x174)]+_0x498322(0xb6),_0x498322(0x1b7));let _0x29b1b2=0x0,_0x59ef36=0x0;for(const _0x2ad48b of _0x1373ae){try{await _0x1d6382[_0x498322(0x170)](_0x2ad48b,_0x498322(0x202)),_0x29b1b2++;}catch(_0xb002ad){_0x59ef36++,log('删除局部知识库\x20'+_0x2ad48b+_0x498322(0x1b6)+_0xb002ad[_0x498322(0x250)],_0x498322(0x277));}}_0x59ef36>0x0?toastr[_0x498322(0x277)](_0x498322(0x1a1)+_0x59ef36+_0x498322(0x270),'警报'):toastr['success'](_0x498322(0x112)+_0x29b1b2+'\x20个局部知识库均已成功删除。',_0x498322(0x260)),log(_0x498322(0x193)+_0x29b1b2+_0x498322(0x26f)+_0x59ef36,_0x498322(0x185)),await updatePanelStatus();}async function renderKnowledgeBases(){const _0xb5923f=_0x30c5e9,_0x283e56=document['getElementById']('hly-kb-list-local'),_0x297f42=document['getElementById'](_0xb5923f(0x11d)),_0xb0e43f=document['getElementById'](_0xb5923f(0x148));if(!_0x283e56||!_0x297f42||!_0xb0e43f)return;_0xb0e43f[_0xb5923f(0x24d)]=_0x7530ec[_0xb5923f(0xad)]()||_0xb5923f(0x23b);try{const _0xffae2=_0x1d6382[_0xb5923f(0xba)](),_0x3e6791=_0x1d6382['getGlobalKnowledgeBases']();await _renderKbList(_0xffae2,_0x283e56,'local',_0xb5923f(0x135)),await _renderKbList(_0x3e6791,_0x297f42,_0xb5923f(0x220),_0xb5923f(0x169));}catch(_0x158095){console[_0xb5923f(0x277)](_0xb5923f(0x238),_0x158095),_0x283e56[_0xb5923f(0xff)]='<p\x20class=\x22hly-notes\x20log-error\x22><i>加载失败:\x20'+_0x158095[_0xb5923f(0x250)]+_0xb5923f(0x266),_0x297f42[_0xb5923f(0xff)]=_0xb5923f(0x145)+_0x158095[_0xb5923f(0x250)]+_0xb5923f(0x266);}}async function _renderKbList(_0x45ce1e,_0x4fef30,_0x4e3e03,_0x216863){const _0x6c1c33=_0x30c5e9,_0x1da59c=document['getElementById'](_0x216863);_0x4fef30[_0x6c1c33(0xff)]='',_0x4fef30[_0x6c1c33(0x283)](_0x1da59c);if(Object['keys'](_0x45ce1e)[_0x6c1c33(0x174)]===0x0){_0x1da59c[_0x6c1c33(0x109)][_0x6c1c33(0x1b0)]=_0x6c1c33(0xb4);return;}_0x1da59c[_0x6c1c33(0x109)][_0x6c1c33(0x1b0)]=_0x6c1c33(0x1be);for(const [_0x100b65,_0x1adddf]of Object[_0x6c1c33(0x1d0)](_0x45ce1e)){const _0x199652=document[_0x6c1c33(0x12e)](_0x6c1c33(0x11a));_0x199652[_0x6c1c33(0x1ab)]=_0x6c1c33(0x276),_0x199652[_0x6c1c33(0x111)]['kbId']=_0x100b65,_0x199652[_0x6c1c33(0x111)][_0x6c1c33(0x154)]=_0x4e3e03;const _0x3bd7f6=await _0x1d6382[_0x6c1c33(0x273)](_0x100b65,_0x4e3e03),_0x2aaeaa=_0x4e3e03===_0x6c1c33(0x202)?_0x6c1c33(0x11b):_0x6c1c33(0xa6);_0x199652[_0x6c1c33(0xff)]=_0x6c1c33(0x18b)+_0x100b65+'\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22hly-kb-name\x22\x20title=\x22ID:\x20'+_0x100b65+'\x22>'+_0x1adddf['name']+'\x20('+_0x3bd7f6+_0x6c1c33(0x1bb)+_0x2aaeaa+_0x6c1c33(0x231)+(_0x1adddf['enabled']?'checked':'')+_0x6c1c33(0x23c),_0x4fef30[_0x6c1c33(0x283)](_0x199652);}}async function handleKbAction(_0x5c7312){const _0x8266ae=_0x30c5e9,_0x336c40=_0x5c7312[_0x8266ae(0x17e)],_0xe3f6d5=_0x336c40[_0x8266ae(0x224)]('.hly-kb-list-item');if(!_0xe3f6d5)return;const _0x1b546c=_0xe3f6d5[_0x8266ae(0x111)]['kbId'],_0x4e05f0=_0xe3f6d5[_0x8266ae(0x111)][_0x8266ae(0x154)],_0x1945c1=_0xe3f6d5[_0x8266ae(0x242)](_0x8266ae(0x264))[_0x8266ae(0x24d)][_0x8266ae(0x23a)]('\x20(')[0x0];if(_0x336c40[_0x8266ae(0x167)][_0x8266ae(0x1c6)](_0x8266ae(0x265))){if(confirm(_0x8266ae(0x28a)+_0x1945c1+_0x8266ae(0x25a)))try{await _0x1d6382['removeKnowledgeBase'](_0x1b546c,_0x4e05f0),log(_0x8266ae(0xd3)+_0x1945c1+'\x20(ID:\x20'+_0x1b546c+')\x20已被删除',_0x8266ae(0x140)),toastr[_0x8266ae(0x140)]('知识库【'+_0x1945c1+'】已删除。'),await updatePanelStatus();}catch(_0x2adf76){log(_0x8266ae(0x151)+_0x1945c1+_0x8266ae(0x1b6)+_0x2adf76[_0x8266ae(0x250)],_0x8266ae(0x277)),toastr[_0x8266ae(0x277)]('删除失败:\x20'+_0x2adf76[_0x8266ae(0x250)]);}}if(_0x336c40[_0x8266ae(0x224)]('.hly-kb-move-btn')){const _0x51f0b7=_0x4e05f0===_0x8266ae(0x202)?'全局':'局部';if(confirm('您确定要将知识库【'+_0x1945c1+'】移动到【'+_0x51f0b7+_0x8266ae(0x213)))try{await _0x1d6382[_0x8266ae(0x14c)](_0x1b546c,_0x4e05f0),await updatePanelStatus();}catch(_0xb676bd){log(_0x8266ae(0x25d)+_0x1945c1+_0x8266ae(0x1b6)+_0xb676bd[_0x8266ae(0x250)],'error'),toastr[_0x8266ae(0x277)]('移动失败:\x20'+_0xb676bd[_0x8266ae(0x250)]);}}if(_0x336c40['classList'][_0x8266ae(0x1c6)](_0x8266ae(0x1a2))&&_0x5c7312['type']===_0x8266ae(0x1ff))try{await _0x1d6382[_0x8266ae(0x133)](_0x1b546c,_0x4e05f0),log(_0x8266ae(0xd3)+_0x1945c1+_0x8266ae(0x22d),_0x8266ae(0x140));}catch(_0x1b5558){log(_0x8266ae(0x10c)+_0x1945c1+'\x20状态失败:\x20'+_0x1b5558['message'],_0x8266ae(0x277)),toastr[_0x8266ae(0x277)](_0x8266ae(0x24c)+_0x1b5558[_0x8266ae(0x250)]),_0x336c40[_0x8266ae(0x28c)]=!_0x336c40[_0x8266ae(0x28c)];}_0x336c40[_0x8266ae(0x167)][_0x8266ae(0x1c6)](_0x8266ae(0x1f3))&&_0x5c7312[_0x8266ae(0xa7)]===_0x8266ae(0x1ff)&&updateBulkActionUI(_0x4e05f0);}function handleSelectAll(_0x20dfe4,_0x1ab805){const _0x3712a6=_0x30c5e9,_0x2a6228=_0x20dfe4[_0x3712a6(0x17e)][_0x3712a6(0x28c)],_0x1d7608=document[_0x3712a6(0x14b)](_0x3712a6(0x226)+_0x1ab805),_0x2cca16=_0x1d7608[_0x3712a6(0x1e1)](_0x3712a6(0x217));_0x2cca16[_0x3712a6(0x1e5)](_0x157554=>_0x157554[_0x3712a6(0x28c)]=_0x2a6228),updateBulkActionUI(_0x1ab805);}function _0x1d12(){const _0x3bd6ad=['所有\x20','-tab','1258467YGXQAA','<i\x20class=\x22fa-solid\x20','purgeHLYStorage','输入兼容OpenAI的embeddings端点','\x20个知识库从\x20','exclusionRules','div','<button\x20class=\x22hly-kb-move-btn\x22\x20title=\x22上移到全局\x22><i\x20class=\x22fas\x20fa-arrow-up\x22></i></button>','\x20楼到\x20','hly-kb-list-global','top_n','all','13350656IQWPbp','\x20个知识块。','\x20个条目进行批量编纂...','move','fas\x20fa-lock-open','[自动保存]\x20设置项\x20\x27','内容排除规则已保存。','embeddingModel','log-success','condensation','hly-api-key-group','fa-exclamation-triangle','injection_','成功加载\x20','createElement','\x20个知识库吗？此操作无法恢复！','files','hly-current-chat-id','hly-injection-source-selector','toggleKnowledgeBase','\x20个Rerank模型。','hly-kb-list-local-placeholder','收到手动录入请求，文本长度:\x20','layerStart','[翰林院-枢纽]\x20获取Rerank模型列表失败:','错误:\x20','您确定要将选中的\x20','hly-condensation-results','user','hly-tag-extraction-toggle','正在准备凝识...','清空宝库失败。','success','stringify','手动录入成功，新增\x20','开始批量删除\x20','tagExtractionEnabled','<p\x20class=\x22hly-notes\x20log-error\x22><i>加载失败:\x20','warning','正在读取文件...','hly-local-kb-char-name','hly-delete-rule-btn','\x20条忆识。','getElementById','moveKnowledgeBase','\x20条消息，开始凝识...','chat','\x0a忆识总数:\x20','\x0a所用模型:\x20','删除知识库\x20','add','input[name=\x22hly-unified-injection-position\x22]:checked','kbScope','startHLYHistoriography','toLocaleTimeString','N/A','[翰林院-枢纽]\x20获取模型列表失败:','hly-kb-bulk-actions-','\x20个知识库移动到【','advanced','批量编纂任务已完成，但有部分错误。','确认并更新预览','fa-circle-info','clearJob','remove','preventDefault','#hly-rules-list','generateJobId','model','宝库状态','hly-kb-bulk-actions-local','classList','hanlinyuan-ingest-novel-start','hly-kb-list-global-placeholder','您确定要将\x20','\x20块继续录入。','%。是否从上次中断之处继续？','hly-kb-move-all-to-local','18oKeGBQ','\x20条有效条目），请点击“开始凝识”进入自动向量化流程。','removeKnowledgeBase','成功切换了\x20','novel','amily2_open_rag_palace','length','\x20个知识库均已成功移动。','label','处理中:\x20','{{text}}','hly-session-lock-btn','6106086MRzTLa','selectedIndex','hanlinyuan-ingest-novel-file-input','批量编纂任务已完成。','target','解锁会话','.position','totalSuccess','hly-kb-delete-local-btn','未选择文件','hly-kb-select-all-local','info','正在处理您确认后的文书...','圣旨已下','settingKey','insertAdjacentHTML','val','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20class=\x22hly-kb-item-checkbox\x22\x20data-kb-id=\x22','录入失败:\x20','map','\x20楼到第\x20','hanlinyuan-ingest-novel-file-name','，从第\x20','请至少选择一个知识库进行操作。','未找到符合条件的消息可供凝识。','局部知识库批量删除完成。成功:\x20','hly-unified-injection-role','未找到符合条件的消息。','获取模型失败:\x20','[翰林院-枢纽]\x20查询宝库状态失败:','{{lorebook_text}}','凝识失败:\x20','宝库已清空。','\x20楼凝识至第\x20','resetHLYSettings','<option>获取失败</option>','tags','会话已解锁。','已选择\x20','操作完成，但有\x20','hly-kb-toggle','#hly-add-rule-btn','[data-setting-key]','hybrid_alpha','preview-item-','任务已由用户中止。进度已保存，可随时继续。','启禀大人，发现此书上次录入已完成\x20','圣旨已达','initialize','className','圣谕不明','beforeend','未检测到预览文本，按标准流程采集消息...','saveSettings','display','removeEventListener','value','\x22\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20data-send-date=\x22','fetchHLYRerankModels','遵命，将从头开始录入此书。','\x20失败:\x20','warn','》获取条目列表...','notify','option','条)</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-kb-actions\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','检测到预览后待处理的消息对象，开始精确凝识...','startHLYCondensation','none','fa-check-circle','准备对《','testApiConnection','send_date','\x20个知识库的状态。','.hly-tab-pane','_searchHandler','contains','.depth_role','5042880kkccDg','stopPropagation','globalToLocal','local_proxy','log-warn','批量编纂任务已开始...','hly-tag-input','批量\x20','entries','hly-batch-size','正在为《','getAvailableWorldbooks','查看宝库状态成功：集合ID=',')\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20class=\x22hly-hist-entry-checkbox\x22\x20value=\x22','hly-entry-search','depth_role','正在获取可用书库列表...','hly-api-key','[翰林院-枢纽]\x20预览过程发生错误:','count','成功移动了\x20','scrollTop','<option>未找到模型</option>','无法获取总数:\x20','<p\x20class=\x22hly-record-hint\x22><i>上次已从第\x20','querySelectorAll','totalVectors','hly-locked-status','data','forEach','\x20楼。</i></p>','已选择\x200\x20/\x20','》中的\x20','hly-kb-move-all-to-global','toggle','开始对《','hly-hist-select-library','getChatId','预览失败:\x20','hly-log-output','hly-tag-input-container','hly-rerank-notify','hly-match-threshold','hly-kb-item-checkbox','凝识完成！新增\x20','1024818dqKNDx','开始获取模型列表...','checkbox','fetchHLYEmbeddingModels','hly-kb-select-all-','scrollHeight',']\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</summary>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-preview-content\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<textarea\x20class=\x22hly-preview-textarea\x22\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20data-floor=\x22','comment','hly-modal-container','hly-embedding-model','change','saveHLYSettings','\x20个知识库的启用状态吗？','local','翰林院设定已重置为初始状态。',',\x20忆识总数=','[实时刷新]\x20批次完成，忆识总数已更新。','name','hlyLog','根据标签提取或内容排除条件，未找到任何有效内容。','<div\x20class=\x22hly-no-results\x22>未找到匹配的条目</div>','localToGlobal','批量移动完成。','\x20个局部知识库吗？此操作无法恢复！','\x20个书库。','未找到匹配的条目','processCondensation','<p\x20class=\x22hly-record-hint\x22>可在此预览凝识结果。</p>','use\x20strict','点击以锁定，让翰林院固定操作当前角色的宝库','】吗？','查询宝库状态失败:\x20','hly-historiography-results','<option>正在获取...</option>','.hly-kb-item-checkbox','hly-unified-template-editor','resetSettings','is_user','[翰林院-枢纽]\x20凝识过程发生错误:','用户请求查看宝库状态。','...','processedChunks','例如\x20http://127.0.0.1:8000/v1','global','total','string','\x22\x20placeholder=\x22结束字符,\x20如\x20-->\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22hly-delete-rule-btn\x22\x20title=\x22删除此规则\x22>&times;</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20','closest','{{chat_text}}','hly-kb-list-','批量移动失败:\x20','hly-api-endpoint','请先选择一个\x20.txt\x20文件','神力连接失败:\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22hly-exclusion-rules-container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22hly-notes\x22>在这里定义需要从提取内容中排除的文本片段。例如，排除HTML注释，可以设置开始字符为\x20`<!--`，结束字符为\x20`-->`。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22hly-rules-list\x22>','hly-retrieval-enabled','\x20的状态已切换','\x20楼已成功凝识，新增\x20','</div>','active','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20class=\x22hly-toggle-switch\x22\x20title=\x22启用/禁用此知识库\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20class=\x22hly-kb-toggle\x22\x20','</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</label>','.hly-exclusion-rule-row','kbId','executeCompilation','\x20操作...','boolean','[翰林院-枢纽]\x20渲染知识库列表失败:','翰林院启奏','split','当前角色','>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22hly-toggle-slider\x22></span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</label>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22hly-kb-delete-btn\x22\x20title=\x22删除此知识库\x22>&times;</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20','[翰林院-枢纽]\x20核心法典未能提供初始化圣旨！','isSessionLocked','编辑内容排除规则','layerEnd','[断点续传]\x20用户选择继续任务\x20','querySelector','7GrBZrx','getLoresForWorldbook','\x20个知识库\x20(范围:\x20','\x22\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20data-is-user=\x22','[翰林院-枢纽]\x20编纂过程发生严重错误:','queryMessageCount','hly-manual-text','成功删除了\x20','hly-chunk-size','切换状态失败:\x20','textContent','retrieval','您确定要切换选中的\x20','message','title','join','hly-hist-entry-multiselect-options','getMessagesForCondensation','hly-hist-select-all-entries','会话已锁定到:\x20','flex','手动录入','录入内容不能为空。','】吗？此操作无法恢复！','testHLYApi','from','移动知识库\x20','filter','apiEndpoint','大功告成','点击以解锁，让翰林院跟随当前角色','.hly-preview-textarea','\x20/\x20','.hly-kb-name','hly-kb-delete-btn','</i></p>','trim','聊天记录从第\x20','hly-hist-entry-multiselect-btn','finalMessages','未知错误','hly-unified-template-notes','<option\x20value=\x22\x22>请选择一个书库...</option>','.hly-kb-item-checkbox:checked',',\x20失败:\x20','\x20个知识库删除失败。','showHLYStats','hly-custom-api-url','getVectorCount','hly-kb-bulk-actions-global','\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-exclusion-rule-row\x22\x20data-index=\x22','hly-kb-list-item','error','find','hly-kb-select-all-global','condensationHistory','2594980EoltXC','condensation.exclusionRules','tab','hly-max-results','hly-rerank-model','integer','floor','自定义路径:','appendChild','hly-layer-start','正在加载条目...','push','matchThreshold','end','messageTypes','您确定要永久删除知识库【','hanlinyuan-ingest-novel-controls','checked','hanlinyuan-ingest-status','通行令牌\x20(API\x20Key):','\x20个条目。','hly-current-vector-count','根据当前勾选条件，未找到符合的消息可供预览。','</textarea>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</details>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22hly-preview-delete-btn-v2\x22\x20data-target=\x22','ingestTextToHanlinyuan','start','正在对\x20','<option\x20value=\x22\x22>未找到任何书库</option>','indeterminate','正在测试神力连接...','<button\x20class=\x22hly-kb-move-btn\x22\x20title=\x22下移到局部\x22><i\x20class=\x22fas\x20fa-arrow-down\x22></i></button>','type','.hly-log-placeholder','hly-worldbook-search','span','disabled','float','getCharacterName','会话已锁定','url','成功获取\x20','\x0a</pre>\x0a\x20\x20\x20\x20\x20\x20\x20\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-preview-item-v2\x22\x20id=\x22','未能获取到任何模型。','block','input','\x20个局部知识库...','purgeStorage','each','true','getLocalKnowledgeBases','获取Rerank模型失败:\x20',')\x20执行批量\x20','google_direct','\x20块开始。','34023dPrqak','hly-unified-injection-depth','任务已中止。','mes','[翰林院-枢纽]\x20加载《','toFixed','[断点续传]\x20用户选择放弃旧任务\x20','）没有任何知识库可供移动。','翰林院使用教程','keys','processed','log-error','10pwawtd','text','placeholder','源区域（','请先选择书库','正在查询宝库状态...','已采集\x20','未能获取到任何Rerank模型。','知识库\x20','finalText','hly-rerank-url','\x0a<pre>\x0a翰林院宝库状态\x0a--------------------\x0a集合ID:\x20','hly-rerank-top-n','您确定要将所有设定恢复为出厂默认值吗？','hly-include-user','rerank','</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20id=\x22hly-add-rule-btn\x22\x20class=\x22hly-action-button\x22\x20style=\x22margin-top:\x2010px;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<i\x20class=\x22fas\x20fa-plus\x22></i>\x20添加新规则\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.hly-exclusion-rule-row\x20{\x20display:\x20flex;\x20align-items:\x20center;\x20gap:\x2010px;\x20margin-bottom:\x2010px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.hly-exclusion-rule-row\x20input\x20{\x20flex-grow:\x201;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.hly-delete-rule-btn\x20{\x20background:\x20#c0392b;\x20color:\x20white;\x20border:\x20none;\x20border-radius:\x2050%;\x20width:\x2024px;\x20height:\x2024px;\x20cursor:\x20pointer;\x20font-size:\x2016px;\x20line-height:\x2024px;\x20text-align:\x20center;\x20padding:\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20</style>\x0a\x20\x20\x20\x20','delete','翰林院设定已存档封印。','\x20个知识库。','\x20个条目','hly-log-entry\x20','[翰林院-枢纽]\x20加载书库列表失败:','》的批量编纂任务已完成。成功:\x20','.hly-hist-entry-checkbox','<option\x20value=\x22\x22>加载失败</option>','】移动到【','hly-include-ai','includes','signal','depth','批量操作失败:\x20','<option\x20value=\x22\x22>未找到匹配的书库</option>','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20class=\x22hly-multiselect-option\x22\x20title=\x22','action','content','custom','\x20操作成功。','hly-current-character-name','radio','AbortError','[翰林院-枢纽]\x20更新忆识数量失败:','\x20移动到\x20','本地代理地址:','enabled','.depth','ingestHLYManualText','\x20楼的内容（共\x20','.hly-preview-item-v2','addEventListener','严重错误','key','innerHTML','getCollectionId','批量移动过程中发生错误:\x20','神力连接通畅！','hly-layer-end','.hly-hist-entry-checkbox:checked','children','hly-query-message-count','\x0a--------------------\x0aAPI端点:\x20','getSettings','style','当前所有操作都将指向这个锁定的宝库：','您确定要永久删除【当前角色】的全部\x20','切换知识库\x20','position','abort','click','apiKey','dataset'];_0x1d12=function(){return _0x3bd6ad;};return _0x1d12();}function updateBulkActionUI(_0x16cc99){const _0x47f4aa=_0x30c5e9,_0x116b99=document[_0x47f4aa(0x14b)]('hly-kb-list-'+_0x16cc99),_0x22f1e6=document['getElementById'](_0x47f4aa(0x159)+_0x16cc99),_0x2e689d=document[_0x47f4aa(0x14b)](_0x47f4aa(0x1f9)+_0x16cc99),_0x5d72de=_0x116b99[_0x47f4aa(0x1e1)](_0x47f4aa(0x217)),_0x46275c=_0x116b99[_0x47f4aa(0x1e1)](_0x47f4aa(0x26e)),_0x3ef094=_0x46275c[_0x47f4aa(0x174)],_0xb66c6f=_0x5d72de['length'];_0x3ef094>0x0?_0x22f1e6[_0x47f4aa(0x109)][_0x47f4aa(0x1b0)]=_0x47f4aa(0x257):_0x22f1e6[_0x47f4aa(0x109)][_0x47f4aa(0x1b0)]=_0x47f4aa(0x1be);if(_0xb66c6f===0x0)_0x2e689d[_0x47f4aa(0x28c)]=![],_0x2e689d[_0x47f4aa(0xa4)]=![];else{if(_0x3ef094===_0xb66c6f)_0x2e689d['checked']=!![],_0x2e689d[_0x47f4aa(0xa4)]=![];else _0x3ef094>0x0?(_0x2e689d[_0x47f4aa(0x28c)]=![],_0x2e689d[_0x47f4aa(0xa4)]=!![]):(_0x2e689d[_0x47f4aa(0x28c)]=![],_0x2e689d[_0x47f4aa(0xa4)]=![]);}}async function handleBulkAction(_0x23c6ee,_0x559ae7){const _0xb61c3b=_0x30c5e9,_0x9cb19d=_0x23c6ee[_0xb61c3b(0x17e)]['dataset'][_0xb61c3b(0xed)];if(!_0x9cb19d)return;const _0x2d0da4=document[_0xb61c3b(0x14b)](_0xb61c3b(0x226)+_0x559ae7),_0x207065=_0x2d0da4[_0xb61c3b(0x1e1)](_0xb61c3b(0x26e)),_0x5d332a=Array[_0xb61c3b(0x25c)](_0x207065)[_0xb61c3b(0x18d)](_0x191041=>_0x191041[_0xb61c3b(0x111)][_0xb61c3b(0x234)]);if(_0x5d332a[_0xb61c3b(0x174)]===0x0){toastr[_0xb61c3b(0x146)](_0xb61c3b(0x191),'圣谕');return;}let _0xbcbd89='',_0x2127dc,_0x4cd42f='';switch(_0x9cb19d){case _0xb61c3b(0xdc):_0xbcbd89='您确定要永久删除选中的\x20'+_0x5d332a[_0xb61c3b(0x174)]+_0xb61c3b(0x12f),_0x2127dc=_0x335042=>_0x1d6382['removeKnowledgeBase'](_0x335042,_0x559ae7),_0x4cd42f=_0xb61c3b(0x24a)+_0x5d332a['length']+_0xb61c3b(0xde);break;case _0xb61c3b(0x123):const _0x11b57c=_0x559ae7===_0xb61c3b(0x202)?'全局':'局部';_0xbcbd89=_0xb61c3b(0x13a)+_0x5d332a[_0xb61c3b(0x174)]+_0xb61c3b(0x15a)+_0x11b57c+_0xb61c3b(0x213),_0x2127dc=_0x1c429d=>_0x1d6382[_0xb61c3b(0x14c)](_0x1c429d,_0x559ae7),_0x4cd42f=_0xb61c3b(0x1dc)+_0x5d332a['length']+_0xb61c3b(0xde);break;case _0xb61c3b(0x1ea):_0xbcbd89=_0xb61c3b(0x24f)+_0x5d332a[_0xb61c3b(0x174)]+_0xb61c3b(0x201),_0x2127dc=_0x45a2be=>_0x1d6382[_0xb61c3b(0x133)](_0x45a2be,_0x559ae7),_0x4cd42f=_0xb61c3b(0x171)+_0x5d332a['length']+_0xb61c3b(0x1c3);break;default:return;}if(!confirm(_0xbcbd89))return;toastr['info'](_0xb61c3b(0xa2)+_0x5d332a[_0xb61c3b(0x174)]+'\x20个知识库执行批量操作...','圣旨'),log('开始对\x20'+_0x5d332a['length']+_0xb61c3b(0x245)+_0x559ae7+_0xb61c3b(0xbc)+_0x9cb19d+_0xb61c3b(0x236),_0xb61c3b(0x185));try{const _0x210ee2=_0x5d332a[_0xb61c3b(0x18d)](_0x23800a=>_0x2127dc(_0x23800a));await Promise[_0xb61c3b(0x11f)](_0x210ee2),toastr[_0xb61c3b(0x140)](_0x4cd42f,_0xb61c3b(0x260)),log(_0xb61c3b(0x1cf)+_0x9cb19d+_0xb61c3b(0xf0),_0xb61c3b(0x140));}catch(_0x15d876){toastr['error'](_0xb61c3b(0xea)+_0x15d876['message'],'警报'),log(_0xb61c3b(0x1cf)+_0x9cb19d+'\x20操作失败:\x20'+_0x15d876[_0xb61c3b(0x250)],'error');}finally{await updatePanelStatus();}}async function testApi(){const _0x24dd40=_0x30c5e9;toastr[_0x24dd40(0x185)](_0x24dd40(0xa5),'圣旨');try{await _0x1d6382[_0x24dd40(0x1c1)](),toastr['success'](_0x24dd40(0x102),'圣意');}catch(_0x3ce7c5){toastr[_0x24dd40(0x277)](_0x24dd40(0x22a)+_0x3ce7c5[_0x24dd40(0x250)],'警报');}}async function fetchHLYEmbeddingModels(){const _0x38f095=_0x30c5e9,_0x3c50b1=document[_0x38f095(0x14b)](_0x38f095(0x1fe)),_0x9b81f0=_0x3c50b1[_0x38f095(0x1b2)];_0x3c50b1[_0x38f095(0xff)]=_0x38f095(0x216),_0x3c50b1[_0x38f095(0xab)]=!![];try{log(_0x38f095(0x1f6),_0x38f095(0x185));const _0x37f9c1=await _0x1d6382['fetchEmbeddingModels']();_0x3c50b1[_0x38f095(0xff)]='';if(_0x37f9c1[_0x38f095(0x174)]===0x0){_0x3c50b1[_0x38f095(0xff)]=_0x38f095(0x1de),toastr[_0x38f095(0x1b7)](_0x38f095(0xb3),'翰林院启奏'),log(_0x38f095(0xb3),_0x38f095(0x1b7));return;}_0x37f9c1['forEach'](_0x17007e=>{const _0x1a4f47=new Option(_0x17007e,_0x17007e);_0x3c50b1['add'](_0x1a4f47);}),_0x37f9c1[_0x38f095(0xe7)](_0x9b81f0)?_0x3c50b1['value']=_0x9b81f0:_0x3c50b1[_0x38f095(0x17b)]=0x0,toastr[_0x38f095(0x140)]('成功获取\x20'+_0x37f9c1[_0x38f095(0x174)]+'\x20个模型。','圣意'),log('成功获取\x20'+_0x37f9c1[_0x38f095(0x174)]+'\x20个模型。','success');}catch(_0x269d03){console['error'](_0x38f095(0x158),_0x269d03),toastr[_0x38f095(0x277)](_0x38f095(0x196)+_0x269d03['message'],'严重错误'),log(_0x38f095(0x196)+_0x269d03[_0x38f095(0x250)],'error'),_0x3c50b1['innerHTML']='<option>获取失败</option>';}finally{_0x3c50b1[_0x38f095(0xab)]=![];}}async function fetchHLYRerankModels(){const _0x15db1b=_0x30c5e9,_0x14cc49=document[_0x15db1b(0x14b)](_0x15db1b(0x27f)),_0x3060c5=_0x14cc49[_0x15db1b(0x1b2)];_0x14cc49[_0x15db1b(0xff)]=_0x15db1b(0x216),_0x14cc49[_0x15db1b(0xab)]=!![];try{log('开始获取Rerank模型列表...',_0x15db1b(0x185));const _0x24089a=await _0x1d6382['fetchRerankModels']();_0x14cc49[_0x15db1b(0xff)]='';if(_0x24089a[_0x15db1b(0x174)]===0x0){_0x14cc49[_0x15db1b(0xff)]=_0x15db1b(0x1de),toastr['warn'](_0x15db1b(0xd2),_0x15db1b(0x239)),log(_0x15db1b(0xd2),_0x15db1b(0x1b7));return;}_0x24089a['forEach'](_0x16ccb3=>{const _0x5b903a=new Option(_0x16ccb3,_0x16ccb3);_0x14cc49['add'](_0x5b903a);}),_0x24089a[_0x15db1b(0xe7)](_0x3060c5)?_0x14cc49[_0x15db1b(0x1b2)]=_0x3060c5:_0x14cc49[_0x15db1b(0x17b)]=0x0,toastr[_0x15db1b(0x140)](_0x15db1b(0xb0)+_0x24089a[_0x15db1b(0x174)]+_0x15db1b(0x134),'圣意'),log(_0x15db1b(0xb0)+_0x24089a[_0x15db1b(0x174)]+_0x15db1b(0x134),_0x15db1b(0x140));}catch(_0x583095){console[_0x15db1b(0x277)](_0x15db1b(0x138),_0x583095),toastr['error']('获取Rerank模型失败:\x20'+_0x583095[_0x15db1b(0x250)],'严重错误'),log(_0x15db1b(0xbb)+_0x583095[_0x15db1b(0x250)],'error'),_0x14cc49[_0x15db1b(0xff)]=_0x15db1b(0x19d);}finally{_0x14cc49[_0x15db1b(0xab)]=![];}}function _0xe9ce(_0x328f64,_0x5361d2){const _0x1d1266=_0x1d12();return _0xe9ce=function(_0xe9cec4,_0x5442e9){_0xe9cec4=_0xe9cec4-0x9d;let _0x2f253d=_0x1d1266[_0xe9cec4];return _0x2f253d;},_0xe9ce(_0x328f64,_0x5361d2);}async function purgeStorage(){const _0x2b89e1=_0x30c5e9;if(confirm('此操作将彻底清空当前角色的所有忆识（向量），且无法恢复。您确定要继续吗？')){toastr[_0x2b89e1(0x185)]('正在清空宝库...','圣旨');const _0x4ca98d=await _0x1d6382[_0x2b89e1(0xb7)]();_0x4ca98d?toastr[_0x2b89e1(0x140)](_0x2b89e1(0x19a),'圣意'):toastr['error'](_0x2b89e1(0x13f),'警报'),await updatePanelStatus();}}async function startCondensation(){const _0x563340=_0x30c5e9,_0x135c51=document[_0x563340(0x14b)](_0x563340(0x13b)),_0xa93c8b=_0x135c51[_0x563340(0x111)]['finalMessages'],_0x54ea20=document['getElementById'](_0x563340(0x284))['value'],_0x28c1c8=document['getElementById'](_0x563340(0x103))[_0x563340(0x1b2)],_0x15c9f5={'start':parseInt(_0x54ea20),'end':parseInt(_0x28c1c8)};try{let _0xf468a7;_0xa93c8b?(log(_0x563340(0x1bc),_0x563340(0x185)),toastr[_0x563340(0x185)](_0x563340(0x186),'圣旨'),_0xf468a7=JSON['parse'](_0xa93c8b),delete _0x135c51['dataset'][_0x563340(0x26a)]):(log(_0x563340(0x1ae),_0x563340(0x185)),toastr['info'](_0x563340(0x13e),'圣旨'),_0xf468a7=_0x1d6382['getMessagesForCondensation']());if(!_0xf468a7||_0xf468a7[_0x563340(0x174)]===0x0){toastr[_0x563340(0x146)](_0x563340(0x192),_0x563340(0x239)),_0x135c51[_0x563340(0x24d)]=_0x563340(0x195);return;}_0x135c51['textContent']=_0x563340(0xd1)+_0xf468a7[_0x563340(0x174)]+_0x563340(0x14d),toastr[_0x563340(0x185)]('已采集\x20'+_0xf468a7['length']+_0x563340(0x14d),_0x563340(0x239));const _0x51f88f=await _0x1d6382[_0x563340(0x20f)](_0xf468a7,log,_0x15c9f5);if(_0x51f88f['success']){toastr[_0x563340(0x140)](_0x563340(0x1f4)+_0x51f88f[_0x563340(0x1db)]+_0x563340(0x14a),_0x563340(0x260));const _0x3a4fbf=_0x15c9f5[_0x563340(0x288)]===0x0?getContext()[_0x563340(0x14e)][_0x563340(0x174)]:_0x15c9f5['end'];_0x135c51[_0x563340(0x24d)]=_0x563340(0x268)+_0x15c9f5['start']+_0x563340(0x18e)+_0x3a4fbf+_0x563340(0x22e)+_0x51f88f['count']+'\x20条忆识。';}else throw new Error(_0x51f88f[_0x563340(0x277)]||_0x563340(0x26b));}catch(_0x457cf3){console[_0x563340(0x277)](_0x563340(0x21b),_0x457cf3),toastr[_0x563340(0x277)](_0x563340(0x199)+_0x457cf3[_0x563340(0x250)],_0x563340(0xfd)),_0x135c51['textContent']=_0x563340(0x199)+_0x457cf3[_0x563340(0x250)];}finally{await updatePanelStatus();}}async function loadWorldbookList(){const _0x484c5b=_0x30c5e9,_0x375b18=document['getElementById'](_0x484c5b(0x1ec)),_0x597fc9=document[_0x484c5b(0x14b)](_0x484c5b(0xa9));if(!_0x375b18)return;try{log(_0x484c5b(0x1d8),_0x484c5b(0x185));const _0x34ee05=await _0x15d4ce[_0x484c5b(0x1d3)]();window['allWorldbooks']=_0x34ee05,updateWorldbookOptions(_0x375b18,'',_0x34ee05);if(_0x597fc9){const _0x4d4e9b=debounce(_0x213eab=>{updateWorldbookOptions(_0x375b18,_0x213eab,_0x34ee05);},0x12c);_0x597fc9[_0x484c5b(0xfc)]('input',_0x2f8bd6=>{const _0x14b7cf=_0x484c5b;_0x4d4e9b(_0x2f8bd6[_0x14b7cf(0x17e)][_0x14b7cf(0x1b2)]);});}log(_0x484c5b(0x12d)+_0x34ee05[_0x484c5b(0x174)]+_0x484c5b(0x20d),'success');}catch(_0x33d51e){console['error'](_0x484c5b(0xe1),_0x33d51e),log('加载书库列表失败:\x20'+_0x33d51e[_0x484c5b(0x250)],_0x484c5b(0x277)),_0x375b18&&(_0x375b18['innerHTML']=_0x484c5b(0xe4));}}function updateWorldbookOptions(_0x2f2361,_0x258300,_0x5a0014){const _0x432b54=_0x30c5e9,_0xb28cc9=filterWorldbooks(_0x258300,_0x5a0014),_0x4353a6=_0x2f2361[_0x432b54(0x1b2)];_0x2f2361[_0x432b54(0xff)]=_0x432b54(0x26d);if(_0xb28cc9[_0x432b54(0x174)]===0x0){_0x2f2361['innerHTML']=_0x258300[_0x432b54(0x267)]()?_0x432b54(0xeb):_0x432b54(0xa3);return;}_0xb28cc9[_0x432b54(0x1e5)](_0xb614fd=>{const _0x86720=_0x432b54,_0x2e66e4=document[_0x86720(0x12e)](_0x86720(0x1ba));_0x2e66e4[_0x86720(0x1b2)]=_0xb614fd,_0x2e66e4[_0x86720(0x24d)]=_0xb614fd,_0x2f2361['appendChild'](_0x2e66e4);}),_0x4353a6&&_0xb28cc9[_0x432b54(0xe7)](_0x4353a6)&&(_0x2f2361['value']=_0x4353a6);}async function handleWorldbookSelectionChange(){const _0xbd198b=_0x30c5e9,_0x4b5b72=document[_0xbd198b(0x14b)](_0xbd198b(0x1ec)),_0x4e9351=document['getElementById']('hly-hist-entry-multiselect-btn'),_0x1cd1e0=document[_0xbd198b(0x14b)]('hly-hist-entry-multiselect-options'),_0x1a4271=document[_0xbd198b(0x14b)](_0xbd198b(0x1d6)),_0x1cdb6a=_0x4b5b72[_0xbd198b(0x1b2)];_0x4e9351[_0xbd198b(0xab)]=!![],_0x4e9351[_0xbd198b(0x242)](_0xbd198b(0xaa))[_0xbd198b(0x24d)]=_0xbd198b(0x285),_0x1cd1e0[_0xbd198b(0xff)]='',_0x1cd1e0[_0xbd198b(0x109)]['display']=_0xbd198b(0x1be);_0x1a4271&&(_0x1a4271['value']='');if(!_0x1cdb6a){_0x4e9351[_0xbd198b(0x242)](_0xbd198b(0xaa))[_0xbd198b(0x24d)]=_0xbd198b(0xcf);return;}try{log(_0xbd198b(0x1d2)+_0x1cdb6a+_0xbd198b(0x1b8),_0xbd198b(0x185));const _0x23fa7a=await _0x15d4ce[_0xbd198b(0x244)](_0x1cdb6a);if(_0x23fa7a['length']===0x0){_0x4e9351[_0xbd198b(0x242)](_0xbd198b(0xaa))[_0xbd198b(0x24d)]='此书库为空';return;}window['allEntries']=_0x23fa7a,updateEntryOptions('',_0x23fa7a);if(_0x1a4271){_0x1a4271[_0xbd198b(0x1b1)](_0xbd198b(0xb5),_0x1a4271[_0xbd198b(0x1c5)]);const _0x27238b=debounce(_0x45b809=>{updateEntryOptions(_0x45b809,_0x23fa7a);},0x12c);_0x1a4271['_searchHandler']=_0x121bd5=>{const _0x3c3594=_0xbd198b;_0x27238b(_0x121bd5[_0x3c3594(0x17e)][_0x3c3594(0x1b2)]);},_0x1a4271[_0xbd198b(0xfc)](_0xbd198b(0xb5),_0x1a4271[_0xbd198b(0x1c5)]);}log(_0xbd198b(0x12d)+_0x23fa7a[_0xbd198b(0x174)]+_0xbd198b(0x28f),_0xbd198b(0x140));}catch(_0x94a12b){console[_0xbd198b(0x277)](_0xbd198b(0xc3)+_0x1cdb6a+'》的条目失败:',_0x94a12b),log('加载条目失败:\x20'+_0x94a12b['message'],'error'),_0x4e9351[_0xbd198b(0x242)]('span')[_0xbd198b(0x24d)]='加载失败';}finally{_0x4e9351[_0xbd198b(0xab)]=![];}}function updateEntryOptions(_0x2eedb2,_0x13944f){const _0x459163=_0x30c5e9,_0x5cfa68=document['getElementById'](_0x459163(0x253)),_0x700583=document[_0x459163(0x14b)]('hly-hist-entry-multiselect-btn'),_0x52d755=filterWorldbookEntries(_0x2eedb2,_0x13944f);_0x5cfa68[_0x459163(0xff)]='';const _0x1649b6='\x0a\x20\x20\x20\x20\x20\x20\x20\x20<label\x20class=\x22hly-multiselect-option\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20id=\x22hly-hist-select-all-entries\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>全选/全不选</strong>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</label>';_0x5cfa68[_0x459163(0x189)]('beforeend',_0x1649b6);if(_0x52d755[_0x459163(0x174)]===0x0){const _0xcbb067=_0x459163(0x209);_0x5cfa68['insertAdjacentHTML'](_0x459163(0x1ad),_0xcbb067),_0x700583[_0x459163(0x242)](_0x459163(0xaa))[_0x459163(0x24d)]=_0x459163(0x20e);return;}_0x52d755[_0x459163(0x1e5)](_0x4d17cf=>{const _0x12ca99=_0x459163,_0x3ed038=_0x2eedb2?highlightSearchMatch(_0x4d17cf['comment'],_0x2eedb2):_0x4d17cf['comment'],_0x21c58c=_0x12ca99(0xec)+_0x4d17cf[_0x12ca99(0x1fc)]+'\x20(Key:\x20'+_0x4d17cf[_0x12ca99(0xfe)]+_0x12ca99(0x1d5)+_0x4d17cf[_0x12ca99(0xfe)]+'\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span>'+_0x3ed038+_0x12ca99(0x232);_0x5cfa68['insertAdjacentHTML'](_0x12ca99(0x1ad),_0x21c58c);}),_0x700583[_0x459163(0x242)]('span')[_0x459163(0x24d)]=_0x459163(0x1e7)+_0x52d755[_0x459163(0x174)]+_0x459163(0xdf);}async function startHistoriography(){const _0xbd756f=_0x30c5e9,_0x137a1d=document[_0xbd756f(0x14b)](_0xbd756f(0x1ec))['value'],_0x431312=document['getElementById'](_0xbd756f(0x253)),_0x44252f=document[_0xbd756f(0x14b)](_0xbd756f(0x215)),_0x34c64e=Array['from'](_0x431312[_0xbd756f(0x1e1)](_0xbd756f(0x104)))[_0xbd756f(0x18d)](_0x175bea=>_0x175bea[_0xbd756f(0x1b2)]);if(!_0x137a1d||_0x34c64e[_0xbd756f(0x174)]===0x0){toastr['warning']('请先选择一个书库并至少选择一个要编纂的条目。',_0xbd756f(0x1ac));return;}_0x44252f[_0xbd756f(0x24d)]=_0xbd756f(0x1c0)+_0x137a1d+'》中的\x20'+_0x34c64e['length']+_0xbd756f(0x122),toastr[_0xbd756f(0x185)](_0xbd756f(0x1cd),'圣旨'),log(_0xbd756f(0x1eb)+_0x137a1d+_0xbd756f(0x1e8)+_0x34c64e[_0xbd756f(0x174)]+'\x20个条目进行编纂...',_0xbd756f(0x185));try{const _0x5af24f=await _0x15d4ce[_0xbd756f(0x235)](_0x137a1d,_0x34c64e);_0x44252f['textContent']=_0x5af24f[_0xbd756f(0xee)],_0x5af24f[_0xbd756f(0x140)]?toastr['success'](_0xbd756f(0x17d),'大功告成'):toastr[_0xbd756f(0x146)](_0xbd756f(0x15c),'圣谕'),log('对《'+_0x137a1d+_0xbd756f(0xe2)+_0x5af24f[_0xbd756f(0x181)]+',\x20向量:\x20'+_0x5af24f[_0xbd756f(0x1e2)],_0xbd756f(0x140));}catch(_0x2bbee2){console[_0xbd756f(0x277)](_0xbd756f(0x247),_0x2bbee2),toastr[_0xbd756f(0x277)]('编纂失败:\x20'+_0x2bbee2['message'],_0xbd756f(0xfd)),_0x44252f[_0xbd756f(0x24d)]='编纂失败:\x20'+_0x2bbee2[_0xbd756f(0x250)];}finally{await updatePanelStatus();}}async function showStats(){const _0x51d94f=_0x30c5e9;try{log(_0x51d94f(0x21c),'info'),toastr['info'](_0x51d94f(0xd0),'圣旨');const _0x58a45d=await _0x1d6382[_0x51d94f(0x273)](),_0xe8d91f=await _0x1d6382[_0x51d94f(0x100)](),_0x5b522e=_0x1d6382[_0x51d94f(0x108)](),_0x45cc2e=_0x51d94f(0xd6)+_0xe8d91f+_0x51d94f(0x14f)+_0x58a45d+_0x51d94f(0x107)+_0x5b522e[_0x51d94f(0x24e)][_0x51d94f(0x25f)]+_0x51d94f(0x150)+_0x5b522e[_0x51d94f(0x24e)][_0x51d94f(0x127)]+_0x51d94f(0xb1);toastr[_0x51d94f(0x185)](_0x45cc2e,_0x51d94f(0x165),{'timeOut':0x3a98,'extendedTimeOut':0x1388,'tapToDismiss':!![],'closeButton':!![]}),log(_0x51d94f(0x1d4)+_0xe8d91f+_0x51d94f(0x204)+_0x58a45d,_0x51d94f(0x140));}catch(_0x48eba9){console[_0x51d94f(0x277)](_0x51d94f(0x197),_0x48eba9),toastr[_0x51d94f(0x277)](_0x51d94f(0x214)+_0x48eba9[_0x51d94f(0x250)],_0x51d94f(0xfd)),log(_0x51d94f(0x214)+_0x48eba9[_0x51d94f(0x250)],_0x51d94f(0x277));}}function showExclusionRulesModal(){const _0x5e3120=_0x30c5e9,_0x8486da=_0x1d6382[_0x5e3120(0x108)](),_0x4625ee=_0x8486da['condensation'][_0x5e3120(0x119)]||[],_0x40ddfa=(_0x4c6b7e={'start':'','end':''},_0x4b243a)=>_0x5e3120(0x275)+_0x4b243a+'\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20class=\x22hly-imperial-brush\x22\x20value=\x22'+_0x4c6b7e['start']+'\x22\x20placeholder=\x22开始字符,\x20如\x20<!--\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span>到</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20class=\x22hly-imperial-brush\x22\x20value=\x22'+_0x4c6b7e[_0x5e3120(0x288)]+_0x5e3120(0x223),_0x56494d=_0x4625ee['map'](_0x40ddfa)[_0x5e3120(0x252)](''),_0x1650a4=_0x5e3120(0x22b)+_0x56494d+_0x5e3120(0xdb);showHtmlModal(_0x5e3120(0x23f),_0x1650a4,{'okText':'保存规则','onOk':_0x2132e4=>{const _0x2a81ef=_0x5e3120,_0xbe0a6d=[];_0x2132e4[_0x2a81ef(0x278)](_0x2a81ef(0x233))[_0x2a81ef(0xb8)](function(){const _0x26c62b=_0x2a81ef,_0x303674=$(this)[_0x26c62b(0x278)]('input')['eq'](0x0)['val']()[_0x26c62b(0x267)](),_0x5c9cf2=$(this)[_0x26c62b(0x278)](_0x26c62b(0xb5))['eq'](0x1)['val']()[_0x26c62b(0x267)]();_0x303674&&_0x5c9cf2&&_0xbe0a6d[_0x26c62b(0x286)]({'start':_0x303674,'end':_0x5c9cf2});}),updateAndSaveSetting(_0x2a81ef(0x27c),_0xbe0a6d),toastr[_0x2a81ef(0x140)](_0x2a81ef(0x126),_0x2a81ef(0x1a9));}});const _0x35316e=document[_0x5e3120(0x14b)]('hly-exclusion-rules-container'),_0x47df78=_0x35316e[_0x5e3120(0x242)](_0x5e3120(0x162));_0x35316e[_0x5e3120(0x242)](_0x5e3120(0x1a3))[_0x5e3120(0xfc)](_0x5e3120(0x10f),()=>{const _0x4514aa=_0x5e3120,_0xa8868e=_0x47df78[_0x4514aa(0x105)][_0x4514aa(0x174)],_0x49b4fc=_0x40ddfa({'start':'','end':''},_0xa8868e);_0x47df78[_0x4514aa(0x189)](_0x4514aa(0x1ad),_0x49b4fc);}),_0x47df78[_0x5e3120(0xfc)](_0x5e3120(0x10f),_0x4c1188=>{const _0x5449f1=_0x5e3120;_0x4c1188[_0x5449f1(0x17e)]['classList']['contains'](_0x5449f1(0x149))&&_0x4c1188[_0x5449f1(0x17e)]['closest']('.hly-exclusion-rule-row')[_0x5449f1(0x160)]();});}function previewCondensation(){const _0x2b434f=_0x30c5e9,_0x33bb9f=document[_0x2b434f(0x14b)](_0x2b434f(0x13b));try{const _0x469cd5=_0x1d6382[_0x2b434f(0x108)](),_0xc16366=_0x469cd5['condensation']['exclusionRules']||[],_0x42090c={'user':document[_0x2b434f(0x14b)](_0x2b434f(0xd9))[_0x2b434f(0x28c)],'ai':document[_0x2b434f(0x14b)](_0x2b434f(0xe6))[_0x2b434f(0x28c)]},_0x36b952=document['getElementById'](_0x2b434f(0x13d))[_0x2b434f(0x28c)],_0x4ac3b9=_0x36b952?document[_0x2b434f(0x14b)](_0x2b434f(0x1ce))[_0x2b434f(0x1b2)][_0x2b434f(0x23a)](',')['map'](_0x2b58b3=>_0x2b58b3[_0x2b434f(0x267)]())[_0x2b434f(0x25e)](Boolean):[],_0x4d7e8d=_0x1d6382[_0x2b434f(0x254)](_0x42090c);if(!_0x4d7e8d||_0x4d7e8d[_0x2b434f(0x174)]===0x0){_0x33bb9f[_0x2b434f(0x24d)]=_0x2b434f(0x9e),toastr[_0x2b434f(0x146)](_0x2b434f(0x195),_0x2b434f(0x239));return;}const _0x418d68=getContext()[_0x2b434f(0x14e)],_0x380b5f=_0x4d7e8d[_0x2b434f(0x18d)]((_0x1a1fde,_0x42a160)=>{const _0x3ccc00=_0x2b434f;let _0x7c3c5;if(_0x1a1fde['is_user'])_0x7c3c5=_0x1a1fde[_0x3ccc00(0xc2)];else{if(_0x36b952&&_0x4ac3b9[_0x3ccc00(0x174)]>0x0){const _0x146dab=extractBlocksByTags(_0x1a1fde[_0x3ccc00(0xc2)],_0x4ac3b9);_0x7c3c5=_0x146dab[_0x3ccc00(0x252)]('\x0a\x0a');}else _0x7c3c5=_0x1a1fde['mes'];_0x7c3c5=applyExclusionRules(_0x7c3c5,_0xc16366);}const _0x34c007=_0x418d68['findIndex'](_0x23baf3=>_0x23baf3===_0x1a1fde),_0x5aa25c=_0x34c007!==-0x1?_0x34c007+0x1:-0x1;return{'id':_0x3ccc00(0x1a6)+_0x42a160,'name':_0x1a1fde['name'],'content':_0x7c3c5[_0x3ccc00(0x267)](),'floor':_0x5aa25c,'is_user':_0x1a1fde[_0x3ccc00(0x21a)],'send_date':_0x1a1fde[_0x3ccc00(0x1c2)]};})['filter'](_0x2f91ed=>_0x2f91ed[_0x2b434f(0xee)]);if(_0x380b5f[_0x2b434f(0x174)]===0x0){_0x33bb9f[_0x2b434f(0x24d)]=_0x2b434f(0x208),toastr[_0x2b434f(0x146)]('根据标签提取或内容排除条件，未找到任何有效内容。','翰林院启奏');return;}const _0x5ba3c3=_0x380b5f['map']((_0x48fa76,_0x271119)=>_0x2b434f(0xb2)+_0x48fa76['id']+'\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<details\x20class=\x22hly-preview-details\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<summary\x20class=\x22hly-preview-summary\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20第\x20'+_0x48fa76[_0x2b434f(0x281)]+'\x20楼:\x20['+_0x48fa76['name']+_0x2b434f(0x1fb)+_0x48fa76[_0x2b434f(0x281)]+_0x2b434f(0x246)+_0x48fa76[_0x2b434f(0x21a)]+_0x2b434f(0x1b3)+_0x48fa76[_0x2b434f(0x1c2)]+'\x22>'+_0x48fa76['content']+_0x2b434f(0x9f)+_0x48fa76['id']+'\x22\x20title=\x22删除此条\x22>&times;</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20')['join']('');showHtmlModal('预览并编辑凝识内容','<div\x20class=\x22hly-preview-container-v2\x22>'+_0x5ba3c3+_0x2b434f(0x22f),{'okText':_0x2b434f(0x15d),'onOk':_0x2b2941=>{const _0x3f398d=_0x2b434f,_0x16dc5a=[];_0x2b2941[_0x3f398d(0x278)](_0x3f398d(0xfb))[_0x3f398d(0xb8)](function(){const _0x3c257b=_0x3f398d,_0x4e47c5=$(this)['find'](_0x3c257b(0x262)),_0x174915=_0x4e47c5[_0x3c257b(0x18a)]();_0x174915[_0x3c257b(0x267)]()&&_0x16dc5a[_0x3c257b(0x286)]({'mes':_0x174915,'is_user':_0x4e47c5[_0x3c257b(0x1e4)]('is-user'),'send_date':_0x4e47c5['data']('send-date'),'floor':_0x4e47c5[_0x3c257b(0x1e4)](_0x3c257b(0x281))});}),_0x33bb9f['dataset'][_0x3f398d(0x26a)]=JSON[_0x3f398d(0x141)](_0x16dc5a);const _0x699e5=document[_0x3f398d(0x14b)](_0x3f398d(0x284))['value'],_0x564c56=document[_0x3f398d(0x14b)](_0x3f398d(0x103))[_0x3f398d(0x1b2)];_0x33bb9f[_0x3f398d(0x24d)]=_0x3f398d(0x1a0)+_0x699e5+_0x3f398d(0x11c)+_0x564c56+_0x3f398d(0xfa)+_0x16dc5a[_0x3f398d(0x174)]+_0x3f398d(0x16f),toastr[_0x3f398d(0x140)]('预览内容已更新，可随时开始凝识。',_0x3f398d(0x1a9));}}),$('.hly-preview-delete-btn-v2')['on'](_0x2b434f(0x10f),function(_0x57a89f){const _0x4e1a16=_0x2b434f;_0x57a89f[_0x4e1a16(0x161)]();const _0xdbd9e0=$(this)[_0x4e1a16(0x1e4)](_0x4e1a16(0x17e));$('#'+_0xdbd9e0)['remove']();});}catch(_0x4790d4){console[_0x2b434f(0x277)](_0x2b434f(0x1da),_0x4790d4),_0x33bb9f[_0x2b434f(0x24d)]=_0x2b434f(0x1ee)+_0x4790d4[_0x2b434f(0x250)],toastr[_0x2b434f(0x277)](_0x2b434f(0x1ee)+_0x4790d4['message'],_0x2b434f(0xfd));}}function log(_0x44fb5e,_0x3f9ef5=_0x30c5e9(0x185)){const _0x66ac17=_0x30c5e9,_0x1aa861=document['getElementById'](_0x66ac17(0x1ef));if(!_0x1aa861)return;const _0x2d506a=document[_0x66ac17(0x12e)]('p'),_0x4d998c=new Date()[_0x66ac17(0x156)]();let _0x5bce4a=_0x66ac17(0x15e),_0x42dfc8='log-info';switch(_0x3f9ef5){case _0x66ac17(0x140):_0x5bce4a=_0x66ac17(0x1bf),_0x42dfc8=_0x66ac17(0x128);break;case'error':_0x5bce4a='fa-times-circle',_0x42dfc8=_0x66ac17(0xca);break;case _0x66ac17(0x1b7):_0x5bce4a=_0x66ac17(0x12b),_0x42dfc8=_0x66ac17(0x1cc);break;}_0x2d506a[_0x66ac17(0x1ab)]=_0x66ac17(0xe0)+_0x42dfc8,_0x2d506a['innerHTML']=_0x66ac17(0x115)+_0x5bce4a+'\x22></i>\x20['+_0x4d998c+']\x20'+_0x44fb5e;const _0x443305=_0x1aa861[_0x66ac17(0x242)](_0x66ac17(0xa8));_0x443305&&_0x443305['remove'](),_0x1aa861[_0x66ac17(0x283)](_0x2d506a),_0x1aa861[_0x66ac17(0x1dd)]=_0x1aa861[_0x66ac17(0x1fa)];}async function ingestManualText(){const _0x584f9f=_0x30c5e9,_0x2dd2ec=document[_0x584f9f(0x14b)](_0x584f9f(0x249)),_0x54e180=_0x2dd2ec['value']['trim']();if(!_0x54e180){toastr[_0x584f9f(0x146)](_0x584f9f(0x259),'翰林院启奏'),log('用户尝试录入空文本。',_0x584f9f(0x1b7));return;}log(_0x584f9f(0x136)+_0x54e180['length'],_0x584f9f(0x185)),toastr[_0x584f9f(0x185)]('正在处理您提交的文书...','圣旨');try{const _0x19dac2=await _0x1d6382[_0x584f9f(0xa0)](_0x54e180,'manual',{'sourceName':_0x584f9f(0x258)});if(_0x19dac2[_0x584f9f(0x140)])toastr[_0x584f9f(0x140)]('文书已成功录入宝库，新增\x20'+_0x19dac2['count']+_0x584f9f(0x14a),_0x584f9f(0x260)),log(_0x584f9f(0x142)+_0x19dac2[_0x584f9f(0x1db)]+_0x584f9f(0x14a),'success'),_0x2dd2ec[_0x584f9f(0x1b2)]='';else throw new Error(_0x19dac2['error']||_0x584f9f(0x26b));}catch(_0x426bfd){console[_0x584f9f(0x277)]('[翰林院-枢纽]\x20手动录入过程发生错误:',_0x426bfd),toastr[_0x584f9f(0x277)]('文书录入失败:\x20'+_0x426bfd[_0x584f9f(0x250)],'严重错误'),log('手动录入失败:\x20'+_0x426bfd['message'],'error');}finally{await updatePanelStatus();}}
