const _0x201952=_0x4baa;(function(_0x34f953,_0x1c8b48){const _0x1e7be7=_0x4baa,_0x183887=_0x34f953();while(!![]){try{const _0x57da7f=parseInt(_0x1e7be7(0x261))/0x1+-parseInt(_0x1e7be7(0x26a))/0x2+-parseInt(_0x1e7be7(0x21d))/0x3+parseInt(_0x1e7be7(0x232))/0x4*(-parseInt(_0x1e7be7(0x2bf))/0x5)+-parseInt(_0x1e7be7(0x217))/0x6*(parseInt(_0x1e7be7(0x2a5))/0x7)+parseInt(_0x1e7be7(0x252))/0x8*(parseInt(_0x1e7be7(0x304))/0x9)+parseInt(_0x1e7be7(0x294))/0xa*(parseInt(_0x1e7be7(0x2fc))/0xb);if(_0x57da7f===_0x1c8b48)break;else _0x183887['push'](_0x183887['shift']());}catch(_0xb2c243){_0x183887['push'](_0x183887['shift']());}}}(_0x35f2,0x4645a));import{extension_settings,getContext}from'/scripts/extensions.js';import{characters,this_chid,getRequestHeaders,saveSettingsDebounced,eventSource,event_types}from'/script.js';import{defaultSettings,extensionName}from'../utils/settings.js';function _0x35f2(){const _0x50babb=['amily2_back_to_main_from_optimization','#amily2_plot_optimization_panel','#amily2_opt_worldbook_checkbox_list\x20input[type=\x22checkbox\x22]','#amily2_api_url,\x20#amily2_api_key,\x20#amily2_optimization_target_tag','plotOpt_max_tokens','#amily2_opt_top_p_value','#amily2_opt_model','stopPropagation','#amily2_opt_main_prompt','amily2_open_memorisation_forms','extensions','#amily2_preset_selector','.delete-rule-btn','#amily2_manual_unhide_to','extensionSettings','temperature','拦截任务指令已重置为默认值。','>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20for=\x22','filter','#amily2_main_prompt','#amily2_opt_max_tokens_value','forEach','amily2_open_rag_palace','checked','正在将帝国徽记迁往\x20[','amily2_lore_insertion_position','type','获取角色世界书失败。','主提示词已重置为默认值。','html','slideUp','click.amily2.chamber_nav','slideDown','https://api.openai.com/v1','plotOpt_model','click.amily2.actions','sillytavern_backend','amily2_open_additional_features','amily2_model','plotOpt_tableEnabled','<p>加载条目中...</p>','apiProvider','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22optimization-exclusion-rules-container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22notes\x22>在这里定义需要从优化内容中排除的文本片段。例如，排除HTML注释，可以设置开始字符为\x20`<!--`，结束字符为\x20`-->`。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22optimization-rules-list\x22\x20style=\x22max-height:\x2045vh;\x20overflow-y:\x20auto;\x20padding:\x2010px;\x20border:\x201px\x20solid\x20rgba(255,255,255,0.1);\x20border-radius:\x205px;\x20margin-bottom:10px;\x22>','最终注入指令已重置为默认值。','[Amily2号-UI]\x20API提供商切换为:\x20','select#amily2_model,\x20select#amily2_preset_selector','string','plotOpt_rateErotic','CHAT_CHANGED','<option>','change.amily2.api_provider',']\x20剧情优化UI事件已成功绑定，自动保存已激活。','setItem','名为\x20\x22','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22amily2_opt_worldbook_entry_item\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20id=\x22','#amily2_opt_rate_personal',']\x20保存角色数据失败:','</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20style=\x22text-align:\x20center;\x20margin-top:\x2010px;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20id=\x22optimization-add-rule-btn\x22\x20class=\x22menu_button\x20amily2-add-rule-btn\x22><i\x20class=\x22fas\x20fa-plus\x22></i>\x20添加新规则</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>','#amily2_unified_restore_button','\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20class=\x22text_pole\x22\x20value=\x22','TavernHelper','无法保存角色卡设置，请检查控制台。','at_depth','href','none','无标题条目','success','#amily2_prompt_selector','#amily2_dialog_editor','data','input[type=\x22radio\x22][name^=\x22amily2_\x22]:not([name=\x22amily2_icon_location\x22])','events-bound','message','close','click','编辑内容排除规则','uid','parse','请先从下拉菜单中选择一个要导出的预设。',']\x20加载酒馆API预设失败:','range','checkbox','input.amily2_opt\x20change.amily2_opt','comment','#amily2_opt_import_prompt_presets','#amily2_opt_rate_cuckold','.popup-button-cancel','amily2_open_plot_optimization','readAsText','rateCuckold','#amily2_opt_prompt_preset_select','change.amily2.select','Amily2号','plotOpt_promptPresets','https://generativelanguage.googleapis.com','number','change.amily2_opt','剧情优化设置已自动保存。','amily2_opt_preset_','authorized','.json','findIndex','#amily2_opt_refresh_worldbooks','0\x20条目.','找不到要删除的预设，操作可能已过期。','#amily2_output_format_prompt','result','amily2_','#amily2_expand_editor','plotOpt_mainPrompt','click.amily2.manual_command','plotOpt_systemPrompt','plotOpt_apiMode','hide','plotOpt_tavernProfile','<p\x20class=\x22notes\x22>未选择角色。</p>','warning','排除规则已更新。','click.amily2.unified_restore','select:not(#amily2_opt_model_select)',']\x20加载世界书失败:','textarea','。圣意已存档。','getCharLorebooks','bookName','span[data-i18n=\x22Manage\x20extensions\x22]','#amily2_additional_features_panel','input[name=\x22amily2_opt_worldbook_source\x22][value=\x22','_value','<-请先获取模型','addEventListener','mousedown.amily2Drawer','<i\x20class=\x22fas\x20fa-save\x22></i>\x20确认敕令','#amily2_refresh_models,\x20#amily2_test,\x20#amily2_fix_now','\x20个有效预设','input[type=\x22checkbox\x22],\x20input[type=\x22radio\x22],\x20input[type=\x22text\x22],\x20input[type=\x22password\x22],\x20textarea,\x20select','1360518prXMnV','Google\x20API\x20Key','css','target','#optimization-exclusion-rules-container','</h4>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22popup-content\x22\x20style=\x22height:\x2070vh;\x22><div\x20class=\x22height100p\x20wide100p\x20flex-container\x22><textarea\x20id=\x22amily2_dialog_editor\x22\x20class=\x22height100p\x20wide100p\x20maximized_textarea\x20text_pole\x22></textarea></div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22popup-controls\x22><div\x20class=\x22popup-button-ok\x20menu_button\x20menu_button_primary\x20interactable\x22>保存并关闭</div><div\x20class=\x22popup-button-cancel\x20menu_button\x20interactable\x22\x20style=\x22margin-left:\x2010px;\x22>取消</div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</dialog>','479010wxRrtL','info','trigger','start','some','#amily2_opt_temperature','each','character','/api/characters/merge-attributes','#amily2_opt_context_limit_value','#amily2_main_drawer','#amily2_opt_reset_main_prompt','placeholder','input[name=\x22amily2_icon_location\x22]','error','[Amily-谕令确认]\x20收到指令:\x20将\x20[','name','#amily2_extension_frame','input[type=\x22number\x22]','change.amily2.manual_model','.opt-exclusion-rule-row','4SwbgHD','[Amily2-工部]\x20操作按钮\x20','click.amily2_opt','body','end','#amily2_opt_selected_worldbooks','createElement','change','localeCompare','input[type=\x22radio\x22]','input','plotOpt_worldbookSource','#amily2_opt_model_select','#amily2_opt_max_tokens','lastUsedPresetName','children','#amily2_opt_presence_penalty',']\x20已自动保存!','cached_models_amily2','prop','#amily2_opt_worldbook_char_limit','谕令\x20[','click.amily2.update','getElementById','append','[Amily2号-UI]\x20正在加载SillyTavern预设列表','change.amily2.checkbox','api','配置\x20[','stop','log','\x22\x20吗？','184hmRWIo','#amily2_opt_final_system_directive','removeChild','additional','请输入授权码','google','#amily2_opt_preset_file_input','plotOpt_ratePersonal','change.amily2.force_proxy','#amily2_api_url','input[type=\x22checkbox\x22]','primary','#amily2_auth_code','trim','加载预设失败','52136EsNbix','#optimization-rules-list','<p\x20class=\x22notes\x22>所选世界书没有条目。</p>','click.amily2.update_new','preset','#amily2_force_proxy','#amily2_manual_hide_from','remove','#amily2_lore_save_status','895110QjcqHQ','</label>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','授权码已复制到剪贴板！','#amily2_opt_rate_erotic','预设\x20\x22','disabled','#amily2_model_selector','\x20执行失败:','url','#amily2_unified_save_button','#amily2_opt_worldbook_checkbox_list\x20input:checked','val','\x20->','\x22\x20已不存在，请重新选择。','amily2_back_to_main_from_forms','amily2_manual_unhide_confirm','splice','#amily2_drawer_content','\x22\x20data-uid=\x22','#amily2_preset_wrapper','#amily2_opt_worldbook_enabled','topbar',']\x20检测到角色/聊天切换，正在刷新剧情优化设置UI...','closest','\x20条目.','createObjectURL','#amily2_opt_context_limit','scripts/extensions/third-party/ST-Amily2-Chat-Optimisation/NeiGe.md','attr','amily2_fix_now','#amily2_api_provider','includes','unhide_all','systemPrompt','files','manual','API\x20call\x20failed\x20with\x20status:\x20','text','click.amily2.expand_editor','manual_hide','\x20个新预设。','join','3013180hCwlXZ','amily2_back_to_main_settings','#amily2_manual_model_input','input[type=\x22password\x22]','\x22]:checked','#amily2_unified_editor','#amily2_opt_delete_prompt_preset','push','导入失败:\x20',']\x20导入预设失败:','mainPrompt','amily2_optimization_exclusion_enabled','plotOpt_contextLimit','plotOpt_frequency_penalty','appendChild','\x22\x20的预设已存在。是否要覆盖它？','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<dialog\x20class=\x22popup\x20wide_dialogue_popup\x20large_dialogue_popup\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22popup-body\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h4\x20style=\x22margin-top:0;\x20color:\x20#eee;\x20border-bottom:\x201px\x20solid\x20rgba(255,255,255,0.2);\x20padding-bottom:\x2010px;\x22>正在编辑:\x20','14rhgCCO','#amily2_api_key','成功覆盖\x20','value','plotOpt_enabledWorldbookEntries','plotOpt_apiKey','input[type=\x22text\x22]','迁都令','input.amily2.range','input[type=\x22checkbox\x22][id^=\x22amily2_\x22]','manual_unhide','#amily2_opt_tavern_api_profile_select','plotOpt_contextTurnCount','rateMain','#amily2_opt_api_url','connectionManager','#amily2_hanlinyuan_panel','<p\x20class=\x22notes\x22>请选择一个或多个世界书以查看其条目。</p>','tavernProfile',':checked','loreDepth','\x0aUID:\x20','#amily2_opt_worldbook_entry_count','plotOpt_temperature','selectedPreset','getLorebooks','1994520FyhFfc','JSON文件格式不正确，根节点必须是一个数组。','#amily2_model_autofetch_wrapper','<i\x20class=\x22fas\x20fa-spinner\x20fa-spin\x22></i>\x20处理中','getLorebookEntries','\x22\x20已成功导出。','replace','圣意已在您每次更改时自动镌刻。','#amily2_opt_rate_main','change.amily2.text','length','未找到酒馆预设','#amily2_opt_worldbook_entry_list_container','plotOpt_presence_penalty','#amily2_chat_optimiser','[Amily-谕令镌刻]\x20[','\x22\x20已被删除。','#amily2_update_button','show','stringify','change.amily2.lore_settings','profiles','loreDepthInput','plotOpt_worldbookCharLimit','#amily2_system_prompt','application/json','fadeOut','<p\x20class=\x22notes\x22>未找到世界书。</p>','amily2-opt-wb-check-','warn','plotOpt_lastUsedPresetName','plotOpt_rateMain','optimizationExclusionRules','确定要删除预设\x20\x22','changelog','plotOpt_selectedWorldbooks','click.amily2.lore_save','#amily2_save_lore_settings','promptPresets','<p\x20class=\x22notes\x22\x20style=\x22color:red;\x22>加载条目失败。</p>','#amily2_open_tutorial,\x20#amily2_open_neige_tutorial','scripts/extensions/third-party/ST-Amily2-Chat-Optimisation/ZhuDian.md','auto','then','forceProxyForCustomApi','<option\x20value=\x22\x22>请刷新模型列表</option>','没有选择任何预设。','isArray','off','click.amily2.auth',']\x20的新状态已保存。','--\x20请选择一个酒馆预设\x20--','change.amily2.prompt_selector','#amily2_unhide_all_button,\x20#amily2_manual_hide_confirm,\x20#amily2_manual_unhide_confirm','#amily2_opt_worldbook_entry_deselect_all','plotOpt_api_mode','#amily2_opt_temperature_value','isAutomatic','showModal','无法加载酒馆API预设列表，请查看控制台。','.popup-button-ok','44qFJjOz','find','all','#amily2_opt_system_prompt','input[name=\x22','复制失败，请手动复制。','model',']\x20已成功恢复为帝国初始蓝图。','191763ZACjst','#amily2_opt_worldbook_entry_list_container\x20input[type=\x22checkbox\x22]','<i\x20class=\x22fas\x20fa-check\x22></i>\x20已确认','ratePersonal','\x22\x20value=\x22','#amily2_opt_worldbook_char_limit_value','plotOpt_selected_worldbooks','\x22\x20placeholder=\x22结束字符,\x20如\x20-->\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22delete-rule-btn\x20menu_button\x20danger_button\x22\x20title=\x22删除此规则\x22>&times;</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>',']\x20已镌刻！','之前选择的酒馆预设\x20\x22','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<dialog\x20class=\x22popup\x20wide_dialogue_popup\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22popup-body\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h3\x20style=\x22margin-top:0;\x20color:\x20#eee;\x20border-bottom:\x201px\x20solid\x20rgba(255,255,255,0.2);\x20padding-bottom:\x2010px;\x22><i\x20class=\x22fas\x20fa-bell\x22\x20style=\x22color:\x20#ff9800;\x22></i>\x20帝国最新情报</h3>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22popup-content\x22\x20style=\x22height:\x2060vh;\x20overflow-y:\x20auto;\x20background:\x20rgba(0,0,0,0.2);\x20padding:\x2015px;\x20border-radius:\x205px;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22mes_text\x22>','amily2_daily_code_display','http://localhost:5000/v1','empty','click.amily2.tutorial','iconLocation','成功导入\x20','plotOpt_apiUrl','toUpperCase',']\x20获取角色世界书失败:','#amily2_api_url_wrapper','input[type=\x22range\x22]','onload',']...','#amily2_api_key_wrapper','amily2_manual_hide_confirm','writeText','plotOpt_top_p','plotOpt_finalSystemDirective','book','#amily2_opt_reset_final_system_directive',']\x20角色卡设置已更新:\x20','#amily2_opt_refresh_tavern_api_profiles','#amily2_opt_frequency_penalty','显示\x20','plotOpt_enabled','#amily2_opt_top_p','#amily2_lore_depth_container','\x22\x20data-book=\x22','无法加载世界书列表，请查看控制台。'];_0x35f2=function(){return _0x50babb;};return _0x35f2();}import{pluginAuthStatus,activatePluginAuthorization,getPasswordForDate}from'../utils/auth.js';import{fetchModels}from'../core/api.js';import{setAvailableModels,populateModelDropdown,getLatestUpdateInfo}from'./state.js';import{fixCommand,testReplyChecker}from'../core/commands.js';import{createDrawer}from'../ui/drawer.js';import{messageFormatting}from'/script.js';import{executeManualCommand}from'../core/autoHideManager.js';import{showContentModal,showHtmlModal}from'./page-window.js';function displayDailyAuthCode(){const _0x56c920=_0x4baa,_0x219b60=document[_0x56c920(0x249)](_0x56c920(0x30f)),_0x32cd08=document[_0x56c920(0x249)]('amily2_copy_daily_code');if(_0x219b60&&_0x32cd08){const _0x1204f1=getPasswordForDate(new Date());_0x219b60['textContent']=_0x1204f1,_0x32cd08[_0x56c920(0x211)](_0x56c920(0x376),()=>{const _0x210ba2=_0x56c920;navigator['clipboard'][_0x210ba2(0x31e)](_0x1204f1)[_0x210ba2(0x2ea)](()=>{const _0x32bb25=_0x210ba2;toastr['success'](_0x32bb25(0x26c));},()=>{const _0x3b8fb8=_0x210ba2;toastr[_0x3b8fb8(0x22b)](_0x3b8fb8(0x301));});});}}function _0x4baa(_0x126613,_0x54d25e){const _0x35f2e7=_0x35f2();return _0x4baa=function(_0x4baa4b,_0x4f7a53){_0x4baa4b=_0x4baa4b-0x1e2;let _0x3ca991=_0x35f2e7[_0x4baa4b];return _0x3ca991;},_0x4baa(_0x126613,_0x54d25e);}async function loadSillyTavernPresets(){const _0x1d52d4=_0x4baa;console[_0x1d52d4(0x250)](_0x1d52d4(0x24b));const _0x3be981=$(_0x1d52d4(0x337)),_0x5c70ad=extension_settings[extensionName]||{},_0x25c0b5=_0x5c70ad['selectedPreset'];_0x3be981['empty']()[_0x1d52d4(0x24a)](new Option('--\x20请选择一个酒馆预设\x20--',''));try{const _0x1220fd=getContext(),_0x495bea=_0x1220fd[_0x1d52d4(0x33a)]?.[_0x1d52d4(0x2b4)]?.[_0x1d52d4(0x2d4)]||[];if(!_0x495bea||_0x495bea[_0x1d52d4(0x2c9)]===0x0){_0x3be981['append']($('<option>',{'value':'','text':_0x1d52d4(0x2ca),'disabled':!![]})),console[_0x1d52d4(0x2dc)]('[Amily2号-UI]\x20未找到SillyTavern预设');return;}let _0x61b9c4=![];_0x495bea[_0x1d52d4(0x341)](_0x5de8dd=>{const _0x30bb58=_0x1d52d4;if(_0x5de8dd['api']&&_0x5de8dd[_0x30bb58(0x265)]){const _0x304d31=$(_0x30bb58(0x35d),{'value':_0x5de8dd['id'],'text':_0x5de8dd[_0x30bb58(0x22d)]||_0x5de8dd['id'],'selected':_0x5de8dd['id']===_0x25c0b5});_0x3be981[_0x30bb58(0x24a)](_0x304d31),_0x5de8dd['id']===_0x25c0b5&&(_0x61b9c4=!![]);}});if(_0x25c0b5&&!_0x61b9c4){toastr['warning'](_0x1d52d4(0x30d)+_0x25c0b5+_0x1d52d4(0x277),'Amily2号');const _0x2d0def=(_0x1a3983,_0x4db61c)=>{!extension_settings[extensionName]&&(extension_settings[extensionName]={}),extension_settings[extensionName][_0x1a3983]=_0x4db61c,saveSettingsDebounced();};_0x2d0def(_0x1d52d4(0x2bd),'');}else _0x61b9c4&&_0x3be981[_0x1d52d4(0x275)](_0x25c0b5);const _0x21e000=_0x495bea[_0x1d52d4(0x33e)](_0x5f3c56=>_0x5f3c56[_0x1d52d4(0x24d)]&&_0x5f3c56[_0x1d52d4(0x265)]);console['log']('[Amily2号-UI]\x20SillyTavern预设列表加载完成，找到\x20'+_0x21e000[_0x1d52d4(0x2c9)]+_0x1d52d4(0x215));}catch(_0x6a57f1){console[_0x1d52d4(0x22b)]('[Amily2号-UI]\x20加载酒馆API预设失败:',_0x6a57f1),_0x3be981[_0x1d52d4(0x24a)]($(_0x1d52d4(0x35d),{'value':'','text':_0x1d52d4(0x260),'disabled':!![]})),toastr['error'](_0x1d52d4(0x2fa),'Amily2号');}}function updateApiProviderUI(){const _0x84fa2b=_0x4baa,_0x392270=extension_settings[extensionName]||{},_0x50b5a6=_0x392270[_0x84fa2b(0x355)]||'openai';$('#amily2_api_provider')['val'](_0x50b5a6),$(_0x84fa2b(0x288))[_0x84fa2b(0x21f)](_0x84fa2b(0x239));}export function bindModalEvents(){const _0x5f3e67=_0x4baa;initializePlotOptimizationBindings();const _0x120131=$('#amily2_drawer_content')[_0x5f3e67(0x2c9)]?$(_0x5f3e67(0x27b)):$(_0x5f3e67(0x2cd));displayDailyAuthCode();function _0x12a839(){const _0x8ca774=_0x5f3e67,_0x2a4a24=extension_settings[extensionName]||{},_0x541524=_0x2a4a24[_0x8ca774(0x2eb)]===!![],_0x25be3b=_0x2a4a24[_0x8ca774(0x302)]||'';_0x120131['find']('#amily2_force_proxy')[_0x8ca774(0x245)](_0x8ca774(0x343),_0x541524),_0x120131[_0x8ca774(0x2fd)](_0x8ca774(0x296))[_0x8ca774(0x275)](_0x25be3b);const _0x4f439a=_0x120131[_0x8ca774(0x2fd)]('#amily2_api_key_wrapper'),_0x24bcc0=_0x120131[_0x8ca774(0x2fd)](_0x8ca774(0x2c1)),_0x28fcf6=_0x120131[_0x8ca774(0x2fd)](_0x8ca774(0x296));_0x541524?(_0x4f439a[_0x8ca774(0x200)](),_0x24bcc0[_0x8ca774(0x2d1)](),_0x28fcf6['hide']()):(_0x4f439a[_0x8ca774(0x2d1)](),_0x24bcc0[_0x8ca774(0x2d1)](),_0x28fcf6[_0x8ca774(0x200)]());}if(!_0x120131[_0x5f3e67(0x2c9)]||_0x120131[_0x5f3e67(0x371)](_0x5f3e67(0x373)))return;const _0x511098=_0x552c70=>_0x552c70['replace'](/_([a-z])/g,_0x25d0eb=>_0x25d0eb[0x1]['toUpperCase']()),_0xcc300a=(_0x5f5749,_0x41a1fb)=>{const _0x333f31=_0x5f3e67;console[_0x333f31(0x250)](_0x333f31(0x22c)+_0x5f5749+']\x20设置为\x20->',_0x41a1fb),!extension_settings[extensionName]&&(extension_settings[extensionName]={}),extension_settings[extensionName]={...extension_settings[extensionName],[_0x5f5749]:_0x41a1fb},saveSettingsDebounced(),console[_0x333f31(0x250)](_0x333f31(0x2ce)+_0x5f5749+_0x333f31(0x2f1));};_0x120131['off'](_0x5f3e67(0x25a))['on'](_0x5f3e67(0x25a),_0x5f3e67(0x266),function(){const _0xd35ce7=_0x5f3e67;if(!pluginAuthStatus[_0xd35ce7(0x1f2)])return;_0xcc300a('forceProxyForCustomApi',this[_0xd35ce7(0x343)]),_0x12a839(),$('#amily2_refresh_models')[_0xd35ce7(0x21f)](_0xd35ce7(0x376));}),_0x120131['off'](_0x5f3e67(0x230))['on']('change.amily2.manual_model','#amily2_manual_model_input',function(){const _0x5c8683=_0x5f3e67;if(!pluginAuthStatus['authorized'])return;_0xcc300a(_0x5c8683(0x302),this[_0x5c8683(0x2a8)]),toastr[_0x5c8683(0x36e)]('模型ID\x20['+this['value']+_0x5c8683(0x243),_0x5c8683(0x1eb));}),_0x120131[_0x5f3e67(0x2ef)](_0x5f3e67(0x2f0))['on'](_0x5f3e67(0x2f0),'#auth_submit',async function(){const _0x4cfe2f=_0x5f3e67,_0x9ff22b=$(_0x4cfe2f(0x25e))['val']()['trim']();_0x9ff22b?await activatePluginAuthorization(_0x9ff22b):toastr[_0x4cfe2f(0x203)](_0x4cfe2f(0x256),'Amily2号');}),_0x120131[_0x5f3e67(0x2ef)]('click.amily2.actions')['on'](_0x5f3e67(0x34f),_0x5f3e67(0x214),async function(){const _0x47a834=_0x5f3e67;if(!pluginAuthStatus[_0x47a834(0x1f2)])return;const _0x458e54=$(this),_0x175396=_0x458e54['html']();_0x458e54['prop'](_0x47a834(0x26f),!![])[_0x47a834(0x349)](_0x47a834(0x2c2));try{switch(this['id']){case'amily2_refresh_models':const _0x5e57cb=await fetchModels();_0x5e57cb[_0x47a834(0x2c9)]>0x0&&(setAvailableModels(_0x5e57cb),localStorage[_0x47a834(0x360)](_0x47a834(0x244),JSON[_0x47a834(0x2d2)](_0x5e57cb)),populateModelDropdown());break;case'amily2_test':await testReplyChecker();break;case _0x47a834(0x287):await fixCommand();break;}}catch(_0x492ba0){console['error'](_0x47a834(0x233)+this['id']+_0x47a834(0x271),_0x492ba0),toastr[_0x47a834(0x22b)]('操作失败:\x20'+_0x492ba0[_0x47a834(0x374)],'Amily2号');}finally{_0x458e54[_0x47a834(0x245)](_0x47a834(0x26f),![])[_0x47a834(0x349)](_0x175396);}}),_0x120131['off'](_0x5f3e67(0x290))['on'](_0x5f3e67(0x290),_0x5f3e67(0x1fb),function(_0xce6868){const _0x35fa04=_0x5f3e67;if(!pluginAuthStatus[_0x35fa04(0x1f2)])return;_0xce6868[_0x35fa04(0x333)]();const _0x1ae36d=$(_0x35fa04(0x36f))[_0x35fa04(0x275)](),_0xe4c13e=$('#amily2_unified_editor')[_0x35fa04(0x275)](),_0x30d0d8=_0x35fa04(0x2a4)+_0x1ae36d+_0x35fa04(0x21c),_0x5ef503=$(_0x30d0d8)['appendTo'](_0x35fa04(0x235)),_0x19d8e2=_0x5ef503['find'](_0x35fa04(0x370));_0x19d8e2['val'](_0xe4c13e);const _0x50ba1d=()=>{const _0x42d63b=_0x35fa04;_0x5ef503[0x0]['close'](),_0x5ef503[_0x42d63b(0x268)]();};_0x5ef503[_0x35fa04(0x2fd)](_0x35fa04(0x2fb))['on'](_0x35fa04(0x376),()=>{const _0x31c589=_0x35fa04,_0xe3484a=_0x19d8e2['val']();$(_0x31c589(0x299))[_0x31c589(0x275)](_0xe3484a),_0xcc300a(_0x1ae36d,_0xe3484a),toastr[_0x31c589(0x36e)]('谕令\x20['+_0x1ae36d+_0x31c589(0x30c),_0x31c589(0x1eb)),_0x50ba1d();}),_0x5ef503[_0x35fa04(0x2fd)](_0x35fa04(0x1e5))['on'](_0x35fa04(0x376),_0x50ba1d),_0x5ef503[0x0][_0x35fa04(0x2f9)]();}),_0x120131[_0x5f3e67(0x2ef)](_0x5f3e67(0x312))['on'](_0x5f3e67(0x312),_0x5f3e67(0x2e7),function(){const _0x5de29d=_0x5f3e67;if(!pluginAuthStatus[_0x5de29d(0x1f2)])return;const _0x3c2186={'amily2_open_tutorial':{'title':'主殿使用教程','url':_0x5de29d(0x2e8)},'amily2_open_neige_tutorial':{'title':'内阁使用教程','url':_0x5de29d(0x285)}},_0x2cfb97=_0x3c2186[this['id']];_0x2cfb97&&showContentModal(_0x2cfb97['title'],_0x2cfb97[_0x5de29d(0x272)]);}),_0x120131['off'](_0x5f3e67(0x248))['on']('click.amily2.update',_0x5f3e67(0x2d0),function(){const _0x243369=_0x5f3e67;$('#amily2_update_indicator')[_0x243369(0x200)]();const _0xb1d873=getLatestUpdateInfo();if(_0xb1d873&&_0xb1d873[_0x243369(0x2e1)]){const _0xb0336=messageFormatting(_0xb1d873[_0x243369(0x2e1)]),_0x33173e=_0x243369(0x30e)+_0xb0336+'</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22popup-controls\x22><div\x20class=\x22popup-button-ok\x20menu_button\x20menu_button_primary\x20interactable\x22>朕已阅</div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</dialog>',_0x2865ac=$(_0x33173e)['appendTo']('body'),_0x4696ea=()=>{const _0x56f195=_0x243369;_0x2865ac[0x0][_0x56f195(0x375)](),_0x2865ac[_0x56f195(0x268)]();};_0x2865ac[_0x243369(0x2fd)](_0x243369(0x2fb))['on'](_0x243369(0x376),_0x4696ea),_0x2865ac[0x0]['showModal']();}else toastr[_0x243369(0x21e)]('未能获取到云端情报，请稍后再试。','情报部回报');}),_0x120131[_0x5f3e67(0x2ef)](_0x5f3e67(0x264))['on'](_0x5f3e67(0x264),'#amily2_update_button_new',function(){const _0x5e392a=_0x5f3e67;$(_0x5e392a(0x20c))['first']()['click']();}),_0x120131[_0x5f3e67(0x2ef)]('click.amily2.manual_command')['on'](_0x5f3e67(0x1fd),_0x5f3e67(0x2f4),async function(){const _0x36ba46=_0x5f3e67;if(!pluginAuthStatus[_0x36ba46(0x1f2)])return;const _0x7272c5=this['id'];let _0x1e15a6='',_0x1671b7={};switch(_0x7272c5){case'amily2_unhide_all_button':_0x1e15a6=_0x36ba46(0x28a);break;case _0x36ba46(0x31d):_0x1e15a6=_0x36ba46(0x291),_0x1671b7={'from':$(_0x36ba46(0x267))[_0x36ba46(0x275)](),'to':$('#amily2_manual_hide_to')[_0x36ba46(0x275)]()};break;case _0x36ba46(0x279):_0x1e15a6=_0x36ba46(0x2af),_0x1671b7={'from':$('#amily2_manual_unhide_from')[_0x36ba46(0x275)](),'to':$(_0x36ba46(0x339))[_0x36ba46(0x275)]()};break;}_0x1e15a6&&await executeManualCommand(_0x1e15a6,_0x1671b7);}),_0x120131[_0x5f3e67(0x2ef)](_0x5f3e67(0x34b))['on'](_0x5f3e67(0x34b),'#amily2_open_plot_optimization,\x20#amily2_open_additional_features,\x20#amily2_open_rag_palace,\x20#amily2_open_memorisation_forms,\x20#amily2_back_to_main_settings,\x20#amily2_back_to_main_from_hanlinyuan,\x20#amily2_back_to_main_from_forms,\x20#amily2_back_to_main_from_optimization',function(){const _0x509e5e=_0x5f3e67;if(!pluginAuthStatus[_0x509e5e(0x1f2)])return;const _0x10b46f=_0x120131[_0x509e5e(0x2fd)]('.plugin-features'),_0x133604=_0x120131[_0x509e5e(0x2fd)](_0x509e5e(0x20d)),_0x26d925=_0x120131[_0x509e5e(0x2fd)](_0x509e5e(0x2b5)),_0x4f8a76=_0x120131[_0x509e5e(0x2fd)]('#amily2_memorisation_forms_panel'),_0x1ae4a6=_0x120131['find'](_0x509e5e(0x32d));_0x10b46f[_0x509e5e(0x200)](),_0x133604[_0x509e5e(0x200)](),_0x26d925[_0x509e5e(0x200)](),_0x4f8a76[_0x509e5e(0x200)](),_0x1ae4a6[_0x509e5e(0x200)]();switch(this['id']){case _0x509e5e(0x1e6):_0x1ae4a6[_0x509e5e(0x2d1)]();break;case _0x509e5e(0x351):_0x133604[_0x509e5e(0x2d1)]();break;case _0x509e5e(0x342):_0x26d925[_0x509e5e(0x2d1)]();break;case _0x509e5e(0x335):_0x4f8a76['show']();break;case _0x509e5e(0x295):case'amily2_back_to_main_from_hanlinyuan':case _0x509e5e(0x278):case _0x509e5e(0x32c):_0x10b46f[_0x509e5e(0x2d1)]();break;}}),_0x120131['off'](_0x5f3e67(0x24c))['on'](_0x5f3e67(0x24c),_0x5f3e67(0x2ae),function(_0x3af8d5){const _0x11b8f7=_0x5f3e67;if(!pluginAuthStatus[_0x11b8f7(0x1f2)])return;const _0x309259=this['id'],_0x424292=$(this),_0x3dcaea=_0x511098(_0x309259[_0x11b8f7(0x2c5)](_0x11b8f7(0x1fa),''));_0xcc300a(_0x3dcaea,_0x424292[_0x11b8f7(0x245)](_0x11b8f7(0x343)));if(_0x309259===_0x11b8f7(0x29f)&&_0x424292[_0x11b8f7(0x245)](_0x11b8f7(0x343))){const _0x88bf4a=extension_settings[extensionName],_0x364999=_0x88bf4a[_0x11b8f7(0x2df)]||[],_0x47699b=(_0x42a3d8={'start':'','end':''},_0x2c559a)=>'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22opt-exclusion-rule-row\x22\x20data-index=\x22'+_0x2c559a+_0x11b8f7(0x367)+_0x42a3d8[_0x11b8f7(0x220)]+'\x22\x20placeholder=\x22开始字符,\x20如\x20<!--\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span>到</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20class=\x22text_pole\x22\x20value=\x22'+_0x42a3d8[_0x11b8f7(0x236)]+_0x11b8f7(0x30b),_0x354592=_0x364999['map'](_0x47699b)[_0x11b8f7(0x293)](''),_0x21000b=_0x11b8f7(0x356)+_0x354592+_0x11b8f7(0x365);showHtmlModal(_0x11b8f7(0x377),_0x21000b,{'okText':'确认','cancelText':'取消','onOk':_0x4a99d4=>{const _0x277b70=_0x11b8f7,_0x24c9af=[];_0x4a99d4[_0x277b70(0x2fd)](_0x277b70(0x231))[_0x277b70(0x223)](function(){const _0xc0f072=_0x277b70,_0x36768=$(this)['find']('input')['eq'](0x0)[_0xc0f072(0x275)]()[_0xc0f072(0x25f)](),_0x5aa252=$(this)['find'](_0xc0f072(0x23c))['eq'](0x1)[_0xc0f072(0x275)]()[_0xc0f072(0x25f)]();if(_0x36768&&_0x5aa252)_0x24c9af[_0xc0f072(0x29b)]({'start':_0x36768,'end':_0x5aa252});}),_0xcc300a(_0x277b70(0x2df),_0x24c9af),toastr[_0x277b70(0x36e)](_0x277b70(0x204),'Amily2号');},'onCancel':()=>{}});const _0x17c7ed=$(_0x11b8f7(0x21b)),_0x108c67=_0x17c7ed[_0x11b8f7(0x2fd)](_0x11b8f7(0x262));_0x17c7ed[_0x11b8f7(0x2fd)]('#optimization-add-rule-btn')['on'](_0x11b8f7(0x376),()=>{const _0x174968=_0x11b8f7,_0x4afc5a=_0x108c67[_0x174968(0x241)]()['length'];_0x108c67['append'](_0x47699b(undefined,_0x4afc5a));}),_0x108c67['on']('click',_0x11b8f7(0x338),function(){const _0x3d8fd1=_0x11b8f7;$(this)[_0x3d8fd1(0x281)]('.opt-exclusion-rule-row')[_0x3d8fd1(0x268)]();});}}),_0x120131['off']('change.amily2.radio')['on']('change.amily2.radio',_0x5f3e67(0x372),function(){const _0x2e8f04=_0x5f3e67;if(!pluginAuthStatus['authorized'])return;const _0x31d24e=_0x511098(this['name'][_0x2e8f04(0x2c5)]('amily2_','')),_0x56a1fe=$(_0x2e8f04(0x300)+this[_0x2e8f04(0x22d)]+_0x2e8f04(0x298))[_0x2e8f04(0x275)]();_0xcc300a(_0x31d24e,_0x56a1fe);}),_0x120131[_0x5f3e67(0x2ef)](_0x5f3e67(0x35e))['on'](_0x5f3e67(0x35e),'#amily2_api_provider',function(){const _0x11ee74=_0x5f3e67;if(!pluginAuthStatus[_0x11ee74(0x1f2)])return;const _0x1511d1=$(this)[_0x11ee74(0x275)]();console[_0x11ee74(0x250)](_0x11ee74(0x358)+_0x1511d1),_0xcc300a(_0x11ee74(0x355),_0x1511d1);const _0x5e2ea8=$(_0x11ee74(0x318)),_0x59d6a9=$(_0x11ee74(0x31c)),_0x3ecfae=$(_0x11ee74(0x27d));_0x5e2ea8[_0x11ee74(0x200)](),_0x59d6a9['hide'](),_0x3ecfae['hide']();const _0x1db4c2=$(_0x11ee74(0x270));switch(_0x1511d1){case'openai':_0x5e2ea8['show'](),_0x59d6a9['show'](),_0x1db4c2[_0x11ee74(0x2d1)](),$('#amily2_api_url')[_0x11ee74(0x286)]('placeholder',_0x11ee74(0x34d))['attr'](_0x11ee74(0x346),_0x11ee74(0x28f)),$(_0x11ee74(0x2a6))[_0x11ee74(0x286)]('placeholder','sk-...');break;case'google':_0x5e2ea8[_0x11ee74(0x200)](),_0x59d6a9['show'](),_0x1db4c2['show'](),$(_0x11ee74(0x2a6))[_0x11ee74(0x286)](_0x11ee74(0x229),_0x11ee74(0x218));break;case _0x11ee74(0x350):_0x5e2ea8[_0x11ee74(0x2d1)](),_0x1db4c2['show'](),$(_0x11ee74(0x25b))[_0x11ee74(0x286)](_0x11ee74(0x229),_0x11ee74(0x310))[_0x11ee74(0x286)](_0x11ee74(0x346),'text');break;case'sillytavern_preset':_0x3ecfae[_0x11ee74(0x2d1)](),_0x1db4c2['hide'](),loadSillyTavernPresets();break;}$('#amily2_model')[_0x11ee74(0x311)]()[_0x11ee74(0x24a)](_0x11ee74(0x2ec));}),_0x120131['off'](_0x5f3e67(0x2c8))['on'](_0x5f3e67(0x2c8),_0x5f3e67(0x32f),function(){const _0x45d7c3=_0x5f3e67;if(!pluginAuthStatus[_0x45d7c3(0x1f2)])return;const _0x383be=_0x511098(this['id']['replace'](_0x45d7c3(0x1fa),''));_0xcc300a(_0x383be,this['value']),toastr[_0x45d7c3(0x36e)](_0x45d7c3(0x24e)+_0x383be+_0x45d7c3(0x243),'Amily2号');}),_0x120131[_0x5f3e67(0x2ef)]('change.amily2.select')['on'](_0x5f3e67(0x1ea),_0x5f3e67(0x359),function(){const _0x591d2e=_0x5f3e67;if(!pluginAuthStatus[_0x591d2e(0x1f2)])return;const _0x180b31=_0x511098(this['id']['replace'](_0x591d2e(0x1fa),''));let _0x3a1b11=this[_0x591d2e(0x2a8)];this['id']==='amily2_preset_selector'?_0xcc300a(_0x591d2e(0x2b7),_0x3a1b11):_0xcc300a(_0x180b31,_0x3a1b11),this['id']===_0x591d2e(0x352)&&populateModelDropdown();}),_0x120131[_0x5f3e67(0x2ef)](_0x5f3e67(0x2ad))['on'](_0x5f3e67(0x2ad),'input[type=\x22range\x22][id^=\x22amily2_\x22]',function(){const _0x181600=_0x5f3e67;if(!pluginAuthStatus[_0x181600(0x1f2)])return;const _0x39d396=_0x511098(this['id']['replace'](_0x181600(0x1fa),'')),_0x4cce66=this['id'][_0x181600(0x289)](_0x181600(0x33b))?parseFloat(this[_0x181600(0x2a8)]):parseInt(this['value'],0xa);$('#'+this['id']+_0x181600(0x20f))[_0x181600(0x28f)](_0x4cce66),_0xcc300a(_0x39d396,_0x4cce66);});const _0xc64d14={'mainPrompt':_0x5f3e67(0x33f),'systemPrompt':_0x5f3e67(0x2d7),'outputFormatPrompt':_0x5f3e67(0x1f8)},_0x90f56e=_0x5f3e67(0x36f),_0x557866=_0x5f3e67(0x299),_0x25166d=_0x5f3e67(0x273);function _0x5855f3(){const _0x13207f=_0x5f3e67;if(!$(_0x90f56e)[_0x13207f(0x2c9)])return;const _0x1dab6d=$(_0x90f56e)[_0x13207f(0x275)]();if(!_0x1dab6d)return;const _0x531ebe=extension_settings[extensionName][_0x1dab6d]||'';$(_0x557866)[_0x13207f(0x275)](_0x531ebe);}_0x120131['off']('change.amily2.prompt_selector')['on'](_0x5f3e67(0x2f3),_0x90f56e,_0x5855f3),_0x120131[_0x5f3e67(0x2ef)]('click.amily2.unified_save')['on']('click.amily2.unified_save',_0x25166d,function(){const _0x165ea0=_0x5f3e67,_0x1f1972=$(_0x90f56e)['val']();if(!_0x1f1972)return;const _0x1e09db=$(_0x557866)[_0x165ea0(0x275)]();_0xcc300a(_0x1f1972,_0x1e09db),toastr['success'](_0x165ea0(0x247)+_0x1f1972+']\x20已镌刻!',_0x165ea0(0x1eb));}),_0x120131['off'](_0x5f3e67(0x205))['on'](_0x5f3e67(0x205),_0x5f3e67(0x366),function(){const _0xefa828=_0x5f3e67,_0x298f1e=$(_0x90f56e)['val']();if(!_0x298f1e)return;const _0x30f50a=defaultSettings[_0x298f1e];$(_0x557866)[_0xefa828(0x275)](_0x30f50a),_0xcc300a(_0x298f1e,_0x30f50a),toastr[_0xefa828(0x36e)](_0xefa828(0x247)+_0x298f1e+_0xefa828(0x303),'Amily2号');}),_0x120131['off'](_0x5f3e67(0x2d3))['on']('change.amily2.lore_settings','select[id^=\x22amily2_lore_\x22],\x20input#amily2_lore_depth_input',function(){const _0x334726=_0x5f3e67;if(!pluginAuthStatus['authorized'])return;let _0x329297=_0x511098(this['id'][_0x334726(0x2c5)]('amily2_',''));_0x329297===_0x334726(0x2d5)&&(_0x329297=_0x334726(0x2b9));const _0x39c3c0=this[_0x334726(0x346)]==='number'?parseInt(this[_0x334726(0x2a8)],0xa):this[_0x334726(0x2a8)];_0xcc300a(_0x329297,_0x39c3c0);if(this['id']===_0x334726(0x345)){const _0x2ebc0b=$(_0x334726(0x329));this['value']===_0x334726(0x36a)?_0x2ebc0b[_0x334726(0x34c)](0xc8):_0x2ebc0b[_0x334726(0x34a)](0xc8);}}),_0x120131['off'](_0x5f3e67(0x2e3))['on'](_0x5f3e67(0x2e3),_0x5f3e67(0x2e4),function(){const _0x18ad97=_0x5f3e67;if(!pluginAuthStatus[_0x18ad97(0x1f2)])return;const _0x16a017=$(this),_0x230a51=$(_0x18ad97(0x269));_0x16a017[_0x18ad97(0x245)](_0x18ad97(0x26f),!![])['html'](_0x18ad97(0x306)),_0x230a51[_0x18ad97(0x28f)](_0x18ad97(0x2c6))[_0x18ad97(0x24f)]()['fadeIn'](),setTimeout(()=>{const _0x42bde4=_0x18ad97;_0x16a017[_0x42bde4(0x245)](_0x42bde4(0x26f),![])['html'](_0x42bde4(0x213)),_0x230a51[_0x42bde4(0x2d9)]();},0x9c4);}),setTimeout(_0x5855f3,0x64),_0x12a839(),_0x120131[_0x5f3e67(0x371)](_0x5f3e67(0x373),!![]);}export function opt_saveAllSettings(){const _0x44ac58=_0x4baa,_0x57717d=$(_0x44ac58(0x32d));if(_0x57717d['length']===0x0)return;console['log']('['+extensionName+']\x20手动触发所有剧情优化设置的保存...'),_0x57717d[_0x44ac58(0x2fd)](_0x44ac58(0x216))[_0x44ac58(0x21f)](_0x44ac58(0x1ef)),_0x57717d[_0x44ac58(0x2fd)](_0x44ac58(0x319))[_0x44ac58(0x21f)](_0x44ac58(0x1ef)),opt_saveEnabledEntries(),toastr[_0x44ac58(0x21e)](_0x44ac58(0x1f0));}function opt_toCamelCase(_0x2f6696){const _0x8df79b=_0x4baa;return _0x2f6696['replace'](/[-_]([a-z])/g,_0x5307ed=>_0x5307ed[0x1][_0x8df79b(0x316)]());}function opt_updateApiUrlVisibility(_0x265cd6,_0x1bba8d){const _0x26e1f9=_0x4baa,_0xc5226c=_0x265cd6[_0x26e1f9(0x2fd)]('#amily2_opt_custom_api_settings_block'),_0x46e099=_0x265cd6[_0x26e1f9(0x2fd)]('#amily2_opt_tavern_api_profile_block'),_0x50f633=_0x265cd6[_0x26e1f9(0x2fd)](_0x26e1f9(0x2b3));_0xc5226c[_0x26e1f9(0x200)](),_0x46e099[_0x26e1f9(0x200)]();if(_0x1bba8d==='tavern')_0x46e099['show']();else{_0xc5226c[_0x26e1f9(0x2d1)]();if(_0x1bba8d===_0x26e1f9(0x257)){_0x265cd6['find']('#amily2_opt_api_url_block')[_0x26e1f9(0x200)]();const _0x1dd688=_0x26e1f9(0x1ed);_0x50f633[_0x26e1f9(0x275)]()!==_0x1dd688&&_0x50f633[_0x26e1f9(0x275)](_0x1dd688)[_0x26e1f9(0x286)](_0x26e1f9(0x346),_0x26e1f9(0x28f))['trigger'](_0x26e1f9(0x239));}else _0x265cd6[_0x26e1f9(0x2fd)]('#amily2_opt_api_url_block')[_0x26e1f9(0x2d1)]();}}function opt_updateWorldbookSourceVisibility(_0x51232d,_0x155c5b){const _0x16c524=_0x4baa,_0x769c92=_0x51232d[_0x16c524(0x2fd)]('#amily2_opt_worldbook_select_wrapper');if(_0x155c5b===_0x16c524(0x28d)){_0x769c92['show']();const _0x1d200=_0x769c92['find'](_0x16c524(0x237));_0x1d200[_0x16c524(0x219)]({'height':_0x16c524(0x2e9),'background-color':'var(--bg1)','appearance':_0x16c524(0x36c),'-webkit-appearance':'none'});}else _0x769c92[_0x16c524(0x200)]();}async function opt_loadTavernApiProfiles(_0x38fa97){const _0x3516ea=_0x4baa,_0x1d8aea=_0x38fa97[_0x3516ea(0x2fd)](_0x3516ea(0x2b0)),_0x387354=opt_getMergedSettings(),_0x12569d=_0x387354[_0x3516ea(0x201)],_0x5cd43d=_0x1d8aea['val']();_0x1d8aea[_0x3516ea(0x311)]()[_0x3516ea(0x24a)](new Option(_0x3516ea(0x2f2),''));try{const _0x4cf55d=getContext()[_0x3516ea(0x33a)]?.[_0x3516ea(0x2b4)]?.['profiles']||[];if(!_0x4cf55d||_0x4cf55d['length']===0x0){_0x1d8aea[_0x3516ea(0x24a)]($('<option>',{'value':'','text':_0x3516ea(0x2ca),'disabled':!![]}));return;}let _0x5e0e77=![];_0x4cf55d[_0x3516ea(0x341)](_0x4e0bfa=>{const _0x16c12e=_0x3516ea;if(_0x4e0bfa[_0x16c12e(0x24d)]&&_0x4e0bfa[_0x16c12e(0x265)]){const _0x21f91b=$(_0x16c12e(0x35d),{'value':_0x4e0bfa['id'],'text':_0x4e0bfa[_0x16c12e(0x22d)]||_0x4e0bfa['id'],'selected':_0x4e0bfa['id']===_0x12569d});_0x1d8aea[_0x16c12e(0x24a)](_0x21f91b),_0x4e0bfa['id']===_0x12569d&&(_0x5e0e77=!![]);}});if(_0x12569d&&!_0x5e0e77)toastr[_0x3516ea(0x203)](_0x3516ea(0x30d)+_0x12569d+_0x3516ea(0x277)),opt_saveSetting('tavernProfile','');else _0x5e0e77&&_0x1d8aea[_0x3516ea(0x275)](_0x12569d);}catch(_0x77e85a){console[_0x3516ea(0x22b)]('['+extensionName+_0x3516ea(0x37b),_0x77e85a),toastr['error'](_0x3516ea(0x2fa));}}const opt_characterSpecificSettings=[_0x201952(0x23d),_0x201952(0x2e2),_0x201952(0x2a9)];async function opt_saveSetting(_0x289b0c,_0x1d083a){const _0xd18cdf=_0x201952;if(opt_characterSpecificSettings[_0xd18cdf(0x289)](_0x289b0c)){const _0x3fa3df=characters[this_chid];if(!_0x3fa3df)return;if(!_0x3fa3df[_0xd18cdf(0x371)][_0xd18cdf(0x336)])_0x3fa3df['data'][_0xd18cdf(0x336)]={};if(!_0x3fa3df[_0xd18cdf(0x371)]['extensions'][extensionName])_0x3fa3df[_0xd18cdf(0x371)]['extensions'][extensionName]={};_0x3fa3df[_0xd18cdf(0x371)][_0xd18cdf(0x336)][extensionName][_0x289b0c]=_0x1d083a;try{const _0x4a79ab=await fetch(_0xd18cdf(0x225),{'method':'POST','headers':getRequestHeaders(),'body':JSON[_0xd18cdf(0x2d2)]({'avatar':_0x3fa3df['avatar'],'data':{'extensions':{[extensionName]:_0x3fa3df['data'][_0xd18cdf(0x336)][extensionName]}}})});if(!_0x4a79ab['ok'])throw new Error(_0xd18cdf(0x28e)+_0x4a79ab['status']);console['log']('['+extensionName+_0xd18cdf(0x323)+_0x289b0c+_0xd18cdf(0x276),_0x1d083a);}catch(_0x168883){console[_0xd18cdf(0x22b)]('['+extensionName+_0xd18cdf(0x364),_0x168883),toastr[_0xd18cdf(0x22b)](_0xd18cdf(0x369));}}else!extension_settings[extensionName]&&(extension_settings[extensionName]={}),extension_settings[extensionName][_0x289b0c]=_0x1d083a,saveSettingsDebounced();}function opt_getMergedSettings(){const _0x527d07=_0x201952,_0x4350b3=characters[this_chid],_0x1db936=extension_settings[extensionName]||defaultSettings,_0xe4e38a=_0x4350b3?.['data']?.[_0x527d07(0x336)]?.[extensionName]||{};return{..._0x1db936,..._0xe4e38a};}function opt_bindSlider(_0x2c44fe,_0x33b4f9,_0x14eb09){const _0x1b8fd9=_0x201952,_0x3d553b=_0x2c44fe[_0x1b8fd9(0x2fd)](_0x33b4f9),_0x549bb6=_0x2c44fe['find'](_0x14eb09);_0x549bb6[_0x1b8fd9(0x28f)](_0x3d553b['val']()),_0x3d553b['on'](_0x1b8fd9(0x23c),function(){const _0x3b8ec3=_0x1b8fd9;_0x549bb6['text']($(this)[_0x3b8ec3(0x275)]());});}async function opt_loadWorldbooks(_0x108ca1){const _0x45d566=_0x201952,_0x4d089d=_0x108ca1['find']('#amily2_opt_worldbook_checkbox_list'),_0x2c4454=opt_getMergedSettings(),_0x19678e=_0x2c4454[_0x45d566(0x2e2)]||[];_0x4d089d['empty']();try{const _0x5074ef=await window[_0x45d566(0x368)][_0x45d566(0x2be)]();if(!_0x5074ef||_0x5074ef[_0x45d566(0x2c9)]===0x0){_0x4d089d[_0x45d566(0x349)](_0x45d566(0x2da));return;}_0x5074ef[_0x45d566(0x341)](_0x2100ef=>{const _0x1abae0=_0x45d566,_0x2b6815=_0x1abae0(0x2db)+_0x2100ef[_0x1abae0(0x2c5)](/[^a-zA-Z0-9]/g,'-'),_0x423c9a=_0x19678e[_0x1abae0(0x289)](_0x2100ef),_0x4409fe=$(_0x1abae0(0x362)+_0x2b6815+_0x1abae0(0x308)+_0x2100ef+'\x22\x20'+(_0x423c9a?_0x1abae0(0x343):'')+'>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20for=\x22'+_0x2b6815+'\x22>'+_0x2100ef+_0x1abae0(0x26b));_0x4d089d[_0x1abae0(0x24a)](_0x4409fe);});}catch(_0x58ba32){console[_0x45d566(0x22b)]('['+extensionName+_0x45d566(0x207),_0x58ba32),_0x4d089d[_0x45d566(0x349)]('<p\x20class=\x22notes\x22\x20style=\x22color:red;\x22>加载世界书列表失败。</p>'),toastr[_0x45d566(0x22b)](_0x45d566(0x32b));}}async function opt_loadWorldbookEntries(_0x30782c){const _0x124a45=_0x201952,_0x46a61a=_0x30782c[_0x124a45(0x2fd)](_0x124a45(0x2cb)),_0x5d329f=_0x30782c[_0x124a45(0x2fd)](_0x124a45(0x2bb));_0x46a61a['html'](_0x124a45(0x354)),_0x5d329f[_0x124a45(0x28f)]('');const _0x3882b1=opt_getMergedSettings(),_0x161239=_0x3882b1['plotOpt_worldbookSource']||_0x124a45(0x224);let _0x44ce23=[];if(_0x161239===_0x124a45(0x28d))_0x44ce23=_0x3882b1[_0x124a45(0x2e2)]||[];else{if(this_chid===-0x1||!characters[this_chid]){_0x46a61a[_0x124a45(0x349)](_0x124a45(0x202)),_0x5d329f['text']('');return;}try{const _0x1af34d=await window[_0x124a45(0x368)][_0x124a45(0x20a)]({'type':_0x124a45(0x2fe)});if(_0x1af34d[_0x124a45(0x25d)])_0x44ce23[_0x124a45(0x29b)](_0x1af34d[_0x124a45(0x25d)]);if(_0x1af34d[_0x124a45(0x255)]?.[_0x124a45(0x2c9)])_0x44ce23[_0x124a45(0x29b)](..._0x1af34d[_0x124a45(0x255)]);}catch(_0xe3b10f){console[_0x124a45(0x22b)]('['+extensionName+_0x124a45(0x317),_0xe3b10f),toastr[_0x124a45(0x22b)](_0x124a45(0x347)),_0x46a61a[_0x124a45(0x349)]('<p\x20class=\x22notes\x22\x20style=\x22color:red;\x22>获取角色世界书失败。</p>');return;}}const _0x351a86=_0x44ce23;let _0x388930=_0x3882b1[_0x124a45(0x2a9)]||{},_0x5dee70=0x0,_0x18b26c=0x0;if(_0x351a86[_0x124a45(0x2c9)]===0x0){_0x46a61a[_0x124a45(0x349)](_0x124a45(0x2b6));return;}try{const _0x1f8e88=[];for(const _0x3e8791 of _0x351a86){const _0x10ca5f=await window[_0x124a45(0x368)][_0x124a45(0x2c3)](_0x3e8791);_0x10ca5f[_0x124a45(0x341)](_0x121fa9=>{const _0x39b103=_0x124a45;_0x1f8e88[_0x39b103(0x29b)]({..._0x121fa9,'bookName':_0x3e8791});});}_0x46a61a[_0x124a45(0x311)](),_0x5dee70=_0x1f8e88['length'];if(_0x5dee70===0x0){_0x46a61a[_0x124a45(0x349)](_0x124a45(0x263)),_0x5d329f[_0x124a45(0x28f)](_0x124a45(0x1f6));return;}_0x1f8e88['sort']((_0x499e5c,_0xb0bc0e)=>(_0x499e5c['comment']||'')[_0x124a45(0x23a)](_0xb0bc0e[_0x124a45(0x1e2)]||''))[_0x124a45(0x341)](_0x346849=>{const _0x22a632=_0x124a45,_0x1d4eb5='amily2-opt-entry-'+_0x346849[_0x22a632(0x20b)][_0x22a632(0x2c5)](/[^a-zA-Z0-9]/g,'-')+'-'+_0x346849['uid'],_0x561cc3=_0x388930[_0x346849[_0x22a632(0x20b)]]?.[_0x22a632(0x289)](_0x346849[_0x22a632(0x378)])??!![],_0x17afd5=$('\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22amily2_opt_worldbook_entry_item\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20id=\x22'+_0x1d4eb5+_0x22a632(0x32a)+_0x346849['bookName']+_0x22a632(0x27c)+_0x346849[_0x22a632(0x378)]+'\x22\x20'+(_0x561cc3?_0x22a632(0x343):'')+_0x22a632(0x33d)+_0x1d4eb5+'\x22\x20title=\x22世界书:\x20'+_0x346849[_0x22a632(0x20b)]+_0x22a632(0x2ba)+_0x346849[_0x22a632(0x378)]+'\x22>'+(_0x346849[_0x22a632(0x1e2)]||_0x22a632(0x36d))+'</label>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20');_0x46a61a[_0x22a632(0x24a)](_0x17afd5);}),_0x18b26c=_0x46a61a[_0x124a45(0x241)]()[_0x124a45(0x2c9)],_0x5d329f[_0x124a45(0x28f)](_0x124a45(0x326)+_0x18b26c+'\x20/\x20'+_0x5dee70+_0x124a45(0x282));}catch(_0x11e902){console[_0x124a45(0x22b)]('['+extensionName+']\x20加载世界书条目失败:',_0x11e902),_0x46a61a[_0x124a45(0x349)](_0x124a45(0x2e6));}}function opt_saveEnabledEntries(){const _0x2b3466=_0x201952,_0x334df3=$(_0x2b3466(0x32d));let _0x837ae4={};_0x334df3[_0x2b3466(0x2fd)](_0x2b3466(0x305))[_0x2b3466(0x223)](function(){const _0x5e1466=_0x2b3466,_0x114366=$(this)[_0x5e1466(0x371)](_0x5e1466(0x321)),_0x387632=parseInt($(this)[_0x5e1466(0x371)](_0x5e1466(0x378)));!_0x837ae4[_0x114366]&&(_0x837ae4[_0x114366]=[]),$(this)['is'](_0x5e1466(0x2b8))&&_0x837ae4[_0x114366]['push'](_0x387632);});const _0x291dd1=opt_getMergedSettings();if(_0x291dd1[_0x2b3466(0x23d)]===_0x2b3466(0x28d)){const _0x12f64a=_0x291dd1[_0x2b3466(0x2e2)]||[];Object['keys'](_0x837ae4)[_0x2b3466(0x341)](_0x1ae0f5=>{!_0x12f64a['includes'](_0x1ae0f5)&&delete _0x837ae4[_0x1ae0f5];});}opt_saveSetting(_0x2b3466(0x2a9),_0x837ae4);}function opt_loadPromptPresets(_0x399114){const _0x5e6779=_0x201952,_0x4854cf=extension_settings[extensionName]?.[_0x5e6779(0x2e5)]||[],_0x4ed994=_0x399114[_0x5e6779(0x2fd)](_0x5e6779(0x1e9)),_0x3017b6=_0x4ed994['val']();_0x4ed994[_0x5e6779(0x311)]()['append'](new Option('--\x20选择一个预设\x20--','')),_0x4854cf[_0x5e6779(0x341)](_0x596115=>{const _0x54e0e0=_0x5e6779;_0x4ed994['append'](new Option(_0x596115[_0x54e0e0(0x22d)],_0x596115[_0x54e0e0(0x22d)]));}),_0x3017b6&&_0x4854cf[_0x5e6779(0x221)](_0x26b215=>_0x26b215[_0x5e6779(0x22d)]===_0x3017b6)&&_0x4ed994[_0x5e6779(0x275)](_0x3017b6);}function opt_saveCurrentPromptsAsPreset(_0x4891e9){const _0x43e748=_0x201952,_0x14dbbf=prompt('请输入预设名称：');if(!_0x14dbbf)return;const _0x2b8e7f=extension_settings[extensionName]?.[_0x43e748(0x2e5)]||[],_0x8a0659=_0x2b8e7f[_0x43e748(0x1f4)](_0x382142=>_0x382142['name']===_0x14dbbf),_0x40303f={'name':_0x14dbbf,'mainPrompt':_0x4891e9[_0x43e748(0x2fd)](_0x43e748(0x334))[_0x43e748(0x275)](),'systemPrompt':_0x4891e9['find']('#amily2_opt_system_prompt')['val'](),'finalSystemDirective':_0x4891e9[_0x43e748(0x2fd)](_0x43e748(0x253))[_0x43e748(0x275)](),'rateMain':parseFloat(_0x4891e9[_0x43e748(0x2fd)](_0x43e748(0x2c7))[_0x43e748(0x275)]()),'ratePersonal':parseFloat(_0x4891e9[_0x43e748(0x2fd)](_0x43e748(0x363))[_0x43e748(0x275)]()),'rateErotic':parseFloat(_0x4891e9['find'](_0x43e748(0x26d))[_0x43e748(0x275)]()),'rateCuckold':parseFloat(_0x4891e9[_0x43e748(0x2fd)]('#amily2_opt_rate_cuckold')[_0x43e748(0x275)]())};if(_0x8a0659!==-0x1){if(confirm(_0x43e748(0x361)+_0x14dbbf+_0x43e748(0x2a3)))_0x2b8e7f[_0x8a0659]=_0x40303f,toastr[_0x43e748(0x36e)](_0x43e748(0x26e)+_0x14dbbf+'\x22\x20已被覆盖。');else{toastr[_0x43e748(0x21e)]('保存操作已取消。');return;}}else _0x2b8e7f[_0x43e748(0x29b)](_0x40303f),toastr[_0x43e748(0x36e)]('预设\x20\x22'+_0x14dbbf+'\x22\x20已保存。');opt_saveSetting(_0x43e748(0x2e5),_0x2b8e7f),opt_loadPromptPresets(_0x4891e9),setTimeout(()=>{const _0x958a17=_0x43e748;_0x4891e9[_0x958a17(0x2fd)](_0x958a17(0x1e9))[_0x958a17(0x275)](_0x14dbbf)[_0x958a17(0x21f)](_0x958a17(0x239));},0x0);}function opt_deleteSelectedPreset(_0xc22b93){const _0x404d73=_0x201952,_0x1abd8a=_0xc22b93[_0x404d73(0x2fd)](_0x404d73(0x1e9)),_0x15087b=_0x1abd8a[_0x404d73(0x275)]();if(!_0x15087b){toastr[_0x404d73(0x203)](_0x404d73(0x2ed));return;}if(!confirm(_0x404d73(0x2e0)+_0x15087b+_0x404d73(0x251)))return;const _0x2d4960=extension_settings[extensionName]?.[_0x404d73(0x2e5)]||[],_0x11be05=_0x2d4960[_0x404d73(0x1f4)](_0x230252=>_0x230252[_0x404d73(0x22d)]===_0x15087b);_0x11be05>-0x1?(_0x2d4960[_0x404d73(0x27a)](_0x11be05,0x1),opt_saveSetting(_0x404d73(0x2e5),_0x2d4960),toastr[_0x404d73(0x36e)](_0x404d73(0x26e)+_0x15087b+_0x404d73(0x2cf))):toastr[_0x404d73(0x22b)](_0x404d73(0x1f7)),opt_loadPromptPresets(_0xc22b93),_0x1abd8a['trigger'](_0x404d73(0x239));}function opt_exportPromptPresets(){const _0xf21bab=_0x201952,_0x5bab82=$(_0xf21bab(0x1e9)),_0x31a923=_0x5bab82[_0xf21bab(0x275)]();if(!_0x31a923){toastr['info'](_0xf21bab(0x37a));return;}const _0x4be68d=extension_settings[extensionName]?.[_0xf21bab(0x2e5)]||[],_0x287c79=_0x4be68d[_0xf21bab(0x2fd)](_0x202abb=>_0x202abb[_0xf21bab(0x22d)]===_0x31a923);if(!_0x287c79){toastr[_0xf21bab(0x22b)]('找不到选中的预设，请刷新页面后重试。');return;}const _0x3e4371=[_0x287c79],_0xd3910=JSON[_0xf21bab(0x2d2)](_0x3e4371,null,0x2),_0x4d904c=new Blob([_0xd3910],{'type':_0xf21bab(0x2d8)}),_0x4d25f7=URL[_0xf21bab(0x283)](_0x4d904c),_0x123c87=document[_0xf21bab(0x238)]('a');_0x123c87[_0xf21bab(0x36b)]=_0x4d25f7,_0x123c87['download']=_0xf21bab(0x1f1)+_0x31a923[_0xf21bab(0x2c5)](/[^a-z0-9]/gi,'_')+_0xf21bab(0x1f3),document[_0xf21bab(0x235)][_0xf21bab(0x2a2)](_0x123c87),_0x123c87['click'](),document['body'][_0xf21bab(0x254)](_0x123c87),URL['revokeObjectURL'](_0x4d25f7),toastr['success'](_0xf21bab(0x26e)+_0x31a923+_0xf21bab(0x2c4));}function opt_importPromptPresets(_0x427a1b,_0xf199ff){const _0x50e06d=_0x201952;if(!_0x427a1b)return;const _0x3a8e1c=new FileReader();_0x3a8e1c[_0x50e06d(0x31a)]=function(_0x38b43f){const _0x46d1d8=_0x50e06d;try{const _0x2b215e=JSON[_0x46d1d8(0x379)](_0x38b43f[_0x46d1d8(0x21a)][_0x46d1d8(0x1f9)]);if(!Array[_0x46d1d8(0x2ee)](_0x2b215e))throw new Error(_0x46d1d8(0x2c0));let _0x4f6b5a=extension_settings[extensionName]?.[_0x46d1d8(0x2e5)]||[],_0x2fae71=0x0,_0xe8a3d1=0x0;_0x2b215e['forEach'](_0x28106c=>{const _0x550f15=_0x46d1d8;if(_0x28106c&&typeof _0x28106c['name']===_0x550f15(0x35a)&&_0x28106c[_0x550f15(0x22d)][_0x550f15(0x2c9)]>0x0){const _0x39e49f={'name':_0x28106c[_0x550f15(0x22d)],'mainPrompt':_0x28106c[_0x550f15(0x29e)]||'','systemPrompt':_0x28106c[_0x550f15(0x28b)]||'','finalSystemDirective':_0x28106c['finalSystemDirective']||'','rateMain':_0x28106c[_0x550f15(0x2b2)]??0x1,'ratePersonal':_0x28106c[_0x550f15(0x307)]??0x1,'rateErotic':_0x28106c['rateErotic']??0x1,'rateCuckold':_0x28106c[_0x550f15(0x1e8)]??0x1},_0x5a58c0=_0x4f6b5a[_0x550f15(0x1f4)](_0x42bd5f=>_0x42bd5f[_0x550f15(0x22d)]===_0x28106c['name']);_0x5a58c0!==-0x1?(_0x4f6b5a[_0x5a58c0]=_0x39e49f,_0xe8a3d1++):(_0x4f6b5a[_0x550f15(0x29b)](_0x39e49f),_0x2fae71++);}});if(_0x2fae71>0x0||_0xe8a3d1>0x0){const _0x40ad1b=_0xf199ff[_0x46d1d8(0x2fd)]('#amily2_opt_prompt_preset_select')[_0x46d1d8(0x275)]();opt_saveSetting(_0x46d1d8(0x2e5),_0x4f6b5a),opt_loadPromptPresets(_0xf199ff),_0xf199ff[_0x46d1d8(0x2fd)]('#amily2_opt_prompt_preset_select')[_0x46d1d8(0x275)](_0x40ad1b),_0xf199ff[_0x46d1d8(0x2fd)](_0x46d1d8(0x1e9))[_0x46d1d8(0x21f)](_0x46d1d8(0x239));let _0x271c07=[];if(_0x2fae71>0x0)_0x271c07[_0x46d1d8(0x29b)](_0x46d1d8(0x314)+_0x2fae71+_0x46d1d8(0x292));if(_0xe8a3d1>0x0)_0x271c07[_0x46d1d8(0x29b)](_0x46d1d8(0x2a7)+_0xe8a3d1+'\x20个同名预设。');toastr[_0x46d1d8(0x36e)](_0x271c07[_0x46d1d8(0x293)]('\x20'));}else toastr[_0x46d1d8(0x203)]('未找到可导入的有效预设。');}catch(_0xa66d4f){console[_0x46d1d8(0x22b)]('['+extensionName+_0x46d1d8(0x29d),_0xa66d4f),toastr[_0x46d1d8(0x22b)](_0x46d1d8(0x29c)+_0xa66d4f[_0x46d1d8(0x374)],'错误');}finally{_0xf199ff['find'](_0x46d1d8(0x258))[_0x46d1d8(0x275)]('');}},_0x3a8e1c[_0x50e06d(0x1e7)](_0x427a1b);}function opt_loadSettings(_0x7fb892){const _0x15147e=_0x201952,_0x4a3efc=opt_getMergedSettings();_0x7fb892['find']('#amily2_opt_enabled')['prop'](_0x15147e(0x343),_0x4a3efc[_0x15147e(0x327)]),_0x7fb892['find']('#amily2_opt_table_enabled')[_0x15147e(0x245)](_0x15147e(0x343),_0x4a3efc[_0x15147e(0x353)]),_0x7fb892['find']('input[name=\x22amily2_opt_api_mode\x22][value=\x22'+_0x4a3efc[_0x15147e(0x1ff)]+'\x22]')[_0x15147e(0x245)](_0x15147e(0x343),!![]),_0x7fb892[_0x15147e(0x2fd)](_0x15147e(0x2b0))[_0x15147e(0x275)](_0x4a3efc[_0x15147e(0x201)]),_0x7fb892[_0x15147e(0x2fd)](_0x15147e(0x20e)+(_0x4a3efc[_0x15147e(0x23d)]||_0x15147e(0x224))+'\x22]')[_0x15147e(0x245)](_0x15147e(0x343),!![]),_0x7fb892['find'](_0x15147e(0x27e))[_0x15147e(0x245)](_0x15147e(0x343),_0x4a3efc['plotOpt_worldbookEnabled']),_0x7fb892['find']('#amily2_opt_api_url')[_0x15147e(0x275)](_0x4a3efc[_0x15147e(0x315)]),_0x7fb892[_0x15147e(0x2fd)]('#amily2_opt_api_key')['val'](_0x4a3efc[_0x15147e(0x2aa)]);const _0x47aab3=_0x7fb892[_0x15147e(0x2fd)](_0x15147e(0x332)),_0x341b46=_0x7fb892[_0x15147e(0x2fd)]('#amily2_opt_model_select');_0x47aab3[_0x15147e(0x275)](_0x4a3efc[_0x15147e(0x34e)]),_0x341b46[_0x15147e(0x311)]();_0x4a3efc['plotOpt_model']?_0x341b46[_0x15147e(0x24a)](new Option(_0x4a3efc['plotOpt_model'],_0x4a3efc['plotOpt_model'],!![],!![])):_0x341b46['append'](new Option(_0x15147e(0x210),'',!![],!![]));_0x7fb892[_0x15147e(0x2fd)](_0x15147e(0x23f))[_0x15147e(0x275)](_0x4a3efc[_0x15147e(0x330)]),_0x7fb892[_0x15147e(0x2fd)](_0x15147e(0x222))['val'](_0x4a3efc[_0x15147e(0x2bc)]),_0x7fb892['find']('#amily2_opt_top_p')[_0x15147e(0x275)](_0x4a3efc[_0x15147e(0x31f)]),_0x7fb892[_0x15147e(0x2fd)](_0x15147e(0x242))['val'](_0x4a3efc[_0x15147e(0x2cc)]),_0x7fb892[_0x15147e(0x2fd)](_0x15147e(0x325))['val'](_0x4a3efc[_0x15147e(0x2a1)]),_0x7fb892[_0x15147e(0x2fd)]('#amily2_opt_context_turn_count')['val'](_0x4a3efc[_0x15147e(0x2b1)]),_0x7fb892[_0x15147e(0x2fd)]('#amily2_opt_worldbook_char_limit')[_0x15147e(0x275)](_0x4a3efc[_0x15147e(0x2d6)]),_0x7fb892[_0x15147e(0x2fd)]('#amily2_opt_context_limit')[_0x15147e(0x275)](_0x4a3efc[_0x15147e(0x2a0)]),_0x7fb892[_0x15147e(0x2fd)]('#amily2_opt_rate_main')[_0x15147e(0x275)](_0x4a3efc['plotOpt_rateMain']),_0x7fb892[_0x15147e(0x2fd)](_0x15147e(0x363))[_0x15147e(0x275)](_0x4a3efc[_0x15147e(0x259)]),_0x7fb892[_0x15147e(0x2fd)](_0x15147e(0x26d))[_0x15147e(0x275)](_0x4a3efc[_0x15147e(0x35b)]),_0x7fb892['find']('#amily2_opt_rate_cuckold')['val'](_0x4a3efc['plotOpt_rateCuckold']),_0x7fb892[_0x15147e(0x2fd)](_0x15147e(0x334))[_0x15147e(0x275)](_0x4a3efc['plotOpt_mainPrompt']),_0x7fb892[_0x15147e(0x2fd)](_0x15147e(0x2ff))[_0x15147e(0x275)](_0x4a3efc[_0x15147e(0x1fe)]),_0x7fb892[_0x15147e(0x2fd)]('#amily2_opt_final_system_directive')['val'](_0x4a3efc[_0x15147e(0x320)]),opt_updateApiUrlVisibility(_0x7fb892,_0x4a3efc[_0x15147e(0x1ff)]),opt_updateWorldbookSourceVisibility(_0x7fb892,_0x4a3efc['plotOpt_worldbookSource']||_0x15147e(0x224)),opt_bindSlider(_0x7fb892,_0x15147e(0x23f),_0x15147e(0x340)),opt_bindSlider(_0x7fb892,_0x15147e(0x222),_0x15147e(0x2f7)),opt_bindSlider(_0x7fb892,_0x15147e(0x328),_0x15147e(0x331)),opt_bindSlider(_0x7fb892,_0x15147e(0x242),'#amily2_opt_presence_penalty_value'),opt_bindSlider(_0x7fb892,_0x15147e(0x325),'#amily2_opt_frequency_penalty_value'),opt_bindSlider(_0x7fb892,'#amily2_opt_context_turn_count','#amily2_opt_context_turn_count_value'),opt_bindSlider(_0x7fb892,_0x15147e(0x246),_0x15147e(0x309)),opt_bindSlider(_0x7fb892,_0x15147e(0x284),_0x15147e(0x226)),opt_loadPromptPresets(_0x7fb892);const _0x11c3f1=_0x4a3efc[_0x15147e(0x2dd)];_0x11c3f1&&(_0x4a3efc[_0x15147e(0x1ec)]||[])[_0x15147e(0x221)](_0x3da591=>_0x3da591[_0x15147e(0x22d)]===_0x11c3f1)&&setTimeout(()=>{const _0x44620b=_0x15147e;_0x7fb892[_0x44620b(0x2fd)](_0x44620b(0x1e9))[_0x44620b(0x275)](_0x11c3f1)[_0x44620b(0x21f)](_0x44620b(0x239),{'isAutomatic':!![]});},0x0),opt_loadWorldbooks(_0x7fb892)[_0x15147e(0x2ea)](()=>{opt_loadWorldbookEntries(_0x7fb892);}),opt_loadTavernApiProfiles(_0x7fb892);}export function initializePlotOptimizationBindings(){const _0x19aa3c=_0x201952,_0x20b3b6=$('#amily2_plot_optimization_panel');if(_0x20b3b6['length']===0x0||_0x20b3b6[_0x19aa3c(0x371)](_0x19aa3c(0x373)))return;opt_loadSettings(_0x20b3b6),eventSource['on'](event_types[_0x19aa3c(0x35c)],()=>{const _0xc6729c=_0x19aa3c;console['log']('['+extensionName+_0xc6729c(0x280)),opt_loadSettings(_0x20b3b6);});const _0x2c431b=function(_0xffb20b){const _0x52c6ac=_0x19aa3c,_0x26e9e1=$(_0xffb20b),_0x3e9d05=(_0xffb20b['name']||_0xffb20b['id'])[_0x52c6ac(0x2c5)]('amily2_opt_',''),_0x13d0e7='plotOpt_'+_0x3e9d05[_0x52c6ac(0x2c5)](/_([a-z])/g,_0x3521f5=>_0x3521f5[0x1][_0x52c6ac(0x316)]());let _0x311053=_0xffb20b[_0x52c6ac(0x346)]===_0x52c6ac(0x37d)?_0xffb20b['checked']:_0x26e9e1['val']();_0x13d0e7===_0x52c6ac(0x30a)&&!Array[_0x52c6ac(0x2ee)](_0x311053)&&(_0x311053=_0x26e9e1[_0x52c6ac(0x275)]()||[]);const _0x191ccf=[_0x52c6ac(0x2bc),'plotOpt_top_p',_0x52c6ac(0x2cc),_0x52c6ac(0x2a1),_0x52c6ac(0x2de),_0x52c6ac(0x259),_0x52c6ac(0x35b),'plotOpt_rateCuckold'];if(_0x191ccf[_0x52c6ac(0x289)](_0x13d0e7)&&_0x311053!=='')_0x311053=parseFloat(_0x311053);else{if(_0xffb20b[_0x52c6ac(0x346)]===_0x52c6ac(0x37c)||_0xffb20b['type']===_0x52c6ac(0x1ee)){if(_0x311053!=='')_0x311053=parseInt(_0x311053,0xa);}}(_0x311053!==''||_0xffb20b[_0x52c6ac(0x346)]===_0x52c6ac(0x37d))&&opt_saveSetting(_0x13d0e7,_0x311053),_0x13d0e7===_0x52c6ac(0x2f6)&&opt_updateApiUrlVisibility(_0x20b3b6,_0x311053),_0xffb20b[_0x52c6ac(0x22d)]==='amily2_opt_worldbook_source'&&(opt_updateWorldbookSourceVisibility(_0x20b3b6,_0x311053),opt_loadWorldbookEntries(_0x20b3b6));},_0x220ec4=[_0x19aa3c(0x25c),_0x19aa3c(0x23b),_0x19aa3c(0x206),_0x19aa3c(0x2ab),_0x19aa3c(0x297),_0x19aa3c(0x208),'input[type=\x22range\x22]',_0x19aa3c(0x22f)]['join'](',\x20');_0x20b3b6['on'](_0x19aa3c(0x37e),_0x220ec4,function(){_0x2c431b(this);}),_0x20b3b6['on']('change.amily2_opt',_0x19aa3c(0x23e),function(){const _0x499870=_0x19aa3c,_0x13125b=$(this)['val']();_0x13125b&&_0x20b3b6['find'](_0x499870(0x332))['val'](_0x13125b)[_0x499870(0x21f)](_0x499870(0x239));}),_0x20b3b6['on']('click.amily2_opt',_0x19aa3c(0x324),()=>{opt_loadTavernApiProfiles(_0x20b3b6);}),_0x20b3b6['on'](_0x19aa3c(0x1ef),_0x19aa3c(0x2b0),function(){const _0x138126=_0x19aa3c,_0x21cef1=$(this)[_0x138126(0x275)]();opt_saveSetting(_0x138126(0x2b7),_0x21cef1);}),_0x20b3b6[_0x19aa3c(0x2fd)](_0x19aa3c(0x1e3))['on'](_0x19aa3c(0x376),()=>_0x20b3b6[_0x19aa3c(0x2fd)]('#amily2_opt_preset_file_input')[_0x19aa3c(0x376)]()),_0x20b3b6[_0x19aa3c(0x2fd)]('#amily2_opt_export_prompt_presets')['on'](_0x19aa3c(0x376),()=>opt_exportPromptPresets()),_0x20b3b6[_0x19aa3c(0x2fd)]('#amily2_opt_save_prompt_preset')['on'](_0x19aa3c(0x376),()=>opt_saveCurrentPromptsAsPreset(_0x20b3b6)),_0x20b3b6['find'](_0x19aa3c(0x29a))['on'](_0x19aa3c(0x376),()=>opt_deleteSelectedPreset(_0x20b3b6)),_0x20b3b6['on'](_0x19aa3c(0x1ef),_0x19aa3c(0x258),function(_0x4377c1){const _0x26cdb9=_0x19aa3c;opt_importPromptPresets(_0x4377c1['target'][_0x26cdb9(0x28c)][0x0],_0x20b3b6);}),_0x20b3b6['on'](_0x19aa3c(0x1ef),_0x19aa3c(0x1e9),function(_0x26cf36,_0x37974d){const _0x46c39c=_0x19aa3c,_0x206eb8=$(this)['val'](),_0x4bb05d=_0x20b3b6[_0x46c39c(0x2fd)](_0x46c39c(0x29a)),_0x523266=_0x37974d&&_0x37974d[_0x46c39c(0x2f8)];opt_saveSetting(_0x46c39c(0x240),_0x206eb8);if(!_0x206eb8){_0x4bb05d[_0x46c39c(0x200)](),opt_saveSetting('lastUsedPresetName','');return;}const _0x11df3f=extension_settings[extensionName]?.[_0x46c39c(0x2e5)]||[],_0x34e1cc=_0x11df3f['find'](_0x46ec0e=>_0x46ec0e[_0x46c39c(0x22d)]===_0x206eb8);_0x34e1cc?(_0x20b3b6[_0x46c39c(0x2fd)](_0x46c39c(0x334))[_0x46c39c(0x275)](_0x34e1cc[_0x46c39c(0x29e)])[_0x46c39c(0x21f)](_0x46c39c(0x239)),_0x20b3b6[_0x46c39c(0x2fd)](_0x46c39c(0x2ff))[_0x46c39c(0x275)](_0x34e1cc[_0x46c39c(0x28b)])[_0x46c39c(0x21f)](_0x46c39c(0x239)),_0x20b3b6['find'](_0x46c39c(0x253))[_0x46c39c(0x275)](_0x34e1cc['finalSystemDirective'])[_0x46c39c(0x21f)](_0x46c39c(0x239)),_0x20b3b6['find'](_0x46c39c(0x2c7))[_0x46c39c(0x275)](_0x34e1cc[_0x46c39c(0x2b2)]??0x1)['trigger'](_0x46c39c(0x239)),_0x20b3b6['find'](_0x46c39c(0x363))['val'](_0x34e1cc[_0x46c39c(0x307)]??0x1)['trigger'](_0x46c39c(0x239)),_0x20b3b6['find'](_0x46c39c(0x26d))[_0x46c39c(0x275)](_0x34e1cc['rateErotic']??0x1)[_0x46c39c(0x21f)]('change'),_0x20b3b6[_0x46c39c(0x2fd)](_0x46c39c(0x1e4))['val'](_0x34e1cc[_0x46c39c(0x1e8)]??0x1)[_0x46c39c(0x21f)](_0x46c39c(0x239)),!_0x523266&&toastr[_0x46c39c(0x36e)]('已加载预设\x20\x22'+_0x206eb8+'\x22。'),_0x4bb05d[_0x46c39c(0x2d1)]()):_0x4bb05d[_0x46c39c(0x200)]();}),_0x20b3b6['find'](_0x19aa3c(0x228))['on'](_0x19aa3c(0x376),function(){const _0x2a8e81=_0x19aa3c;_0x20b3b6[_0x2a8e81(0x2fd)](_0x2a8e81(0x334))['val'](defaultSettings[_0x2a8e81(0x1fc)])[_0x2a8e81(0x21f)]('change'),toastr['success'](_0x2a8e81(0x348));}),_0x20b3b6[_0x19aa3c(0x2fd)]('#amily2_opt_reset_system_prompt')['on'](_0x19aa3c(0x376),function(){const _0x2205e6=_0x19aa3c;_0x20b3b6[_0x2205e6(0x2fd)](_0x2205e6(0x2ff))[_0x2205e6(0x275)](defaultSettings[_0x2205e6(0x1fe)])[_0x2205e6(0x21f)](_0x2205e6(0x239)),toastr[_0x2205e6(0x36e)](_0x2205e6(0x33c));}),_0x20b3b6[_0x19aa3c(0x2fd)](_0x19aa3c(0x322))['on'](_0x19aa3c(0x376),function(){const _0x4e3d63=_0x19aa3c;_0x20b3b6[_0x4e3d63(0x2fd)](_0x4e3d63(0x253))[_0x4e3d63(0x275)](defaultSettings[_0x4e3d63(0x320)])[_0x4e3d63(0x21f)](_0x4e3d63(0x239)),toastr[_0x4e3d63(0x36e)](_0x4e3d63(0x357));}),_0x20b3b6['data']('events-bound',!![]),console['log']('['+extensionName+_0x19aa3c(0x35f)),_0x20b3b6['on'](_0x19aa3c(0x234),_0x19aa3c(0x1f5),()=>{opt_loadWorldbooks(_0x20b3b6)['then'](()=>{opt_loadWorldbookEntries(_0x20b3b6);});}),_0x20b3b6['on'](_0x19aa3c(0x1ef),_0x19aa3c(0x32e),async function(){const _0x566326=_0x19aa3c,_0x4f4c49=[];_0x20b3b6[_0x566326(0x2fd)](_0x566326(0x274))[_0x566326(0x223)](function(){const _0x4f6317=_0x566326;_0x4f4c49[_0x4f6317(0x29b)]($(this)[_0x4f6317(0x275)]());}),await opt_saveSetting(_0x566326(0x2e2),_0x4f4c49),await opt_loadWorldbookEntries(_0x20b3b6);}),_0x20b3b6['on'](_0x19aa3c(0x1ef),_0x19aa3c(0x305),()=>{opt_saveEnabledEntries();}),_0x20b3b6['on']('click.amily2_opt','#amily2_opt_worldbook_entry_select_all',()=>{const _0x2f98bf=_0x19aa3c;_0x20b3b6[_0x2f98bf(0x2fd)](_0x2f98bf(0x305))['prop'](_0x2f98bf(0x343),!![]),opt_saveEnabledEntries();}),_0x20b3b6['on'](_0x19aa3c(0x234),_0x19aa3c(0x2f5),()=>{const _0x2828c9=_0x19aa3c;_0x20b3b6[_0x2828c9(0x2fd)](_0x2828c9(0x305))[_0x2828c9(0x245)](_0x2828c9(0x343),![]),opt_saveEnabledEntries();});}$(document)['on'](_0x201952(0x239),_0x201952(0x22a),function(){const _0x15fd20=_0x201952;if(!pluginAuthStatus[_0x15fd20(0x1f2)])return;const _0x47c495=$(this)[_0x15fd20(0x275)]();extension_settings[extensionName][_0x15fd20(0x313)]=_0x47c495,saveSettingsDebounced(),console['log']('[Amily-禁卫军]\x20收到迁都指令\x20->\x20'+_0x47c495+_0x15fd20(0x209)),toastr[_0x15fd20(0x21e)](_0x15fd20(0x344)+(_0x47c495===_0x15fd20(0x27f)?'顶栏':'扩展区')+_0x15fd20(0x31b),_0x15fd20(0x2ac),{'timeOut':0x7d0}),$(_0x15fd20(0x227))['remove'](),$(document)[_0x15fd20(0x2ef)](_0x15fd20(0x212)),$(_0x15fd20(0x22e))['remove'](),setTimeout(createDrawer,0x32);});
