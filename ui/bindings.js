const _0x5b2195=_0x5cf7;(function(_0x14275f,_0x400bf2){const _0x498f31=_0x5cf7,_0xb87089=_0x14275f();while(!![]){try{const _0x4adee5=-parseInt(_0x498f31(0x1a5))/0x1*(parseInt(_0x498f31(0x13e))/0x2)+-parseInt(_0x498f31(0x181))/0x3*(-parseInt(_0x498f31(0x16c))/0x4)+-parseInt(_0x498f31(0x1f6))/0x5*(parseInt(_0x498f31(0xce))/0x6)+parseInt(_0x498f31(0x129))/0x7*(parseInt(_0x498f31(0x18a))/0x8)+-parseInt(_0x498f31(0x15c))/0x9*(parseInt(_0x498f31(0x120))/0xa)+parseInt(_0x498f31(0x12a))/0xb*(-parseInt(_0x498f31(0x1bb))/0xc)+parseInt(_0x498f31(0xef))/0xd;if(_0x4adee5===_0x400bf2)break;else _0xb87089['push'](_0xb87089['shift']());}catch(_0x1227de){_0xb87089['push'](_0xb87089['shift']());}}}(_0x2ca9,0x3567c));import{extension_settings,getContext}from'/scripts/extensions.js';import{characters,this_chid,getRequestHeaders,saveSettingsDebounced,eventSource,event_types}from'/script.js';import{defaultSettings,extensionName}from'../utils/settings.js';import{pluginAuthStatus,activatePluginAuthorization,getPasswordForDate}from'../utils/auth.js';import{fetchModels}from'../core/api.js';import{setAvailableModels,populateModelDropdown,getLatestUpdateInfo}from'./state.js';import{fixCommand,testReplyChecker}from'../core/commands.js';import{createDrawer}from'../ui/drawer.js';import{messageFormatting}from'/script.js';import{executeManualCommand}from'../core/autoHideManager.js';import{showContentModal,showHtmlModal}from'./page-window.js';function displayDailyAuthCode(){const _0x2b6fbb=_0x5cf7,_0x49c3f0=document['getElementById'](_0x2b6fbb(0xc9)),_0x1fffc9=document['getElementById'](_0x2b6fbb(0x11c));if(_0x49c3f0&&_0x1fffc9){const _0x55b8ec=getPasswordForDate(new Date());_0x49c3f0[_0x2b6fbb(0x134)]=_0x55b8ec,_0x1fffc9[_0x2b6fbb(0x20f)]('click',()=>{const _0x3b84c3=_0x2b6fbb;navigator[_0x3b84c3(0x13c)]['writeText'](_0x55b8ec)['then'](()=>{const _0x4cb1cf=_0x3b84c3;toastr[_0x4cb1cf(0x19d)](_0x4cb1cf(0x160));},()=>{toastr['error']('复制失败，请手动复制。');});});}}async function loadSillyTavernPresets(){const _0x378525=_0x5cf7;console['log'](_0x378525(0x175));const _0x4e4f78=$(_0x378525(0x178)),_0x6b3adf=extension_settings[extensionName]||{},_0x45036d=_0x6b3adf[_0x378525(0x102)];_0x4e4f78[_0x378525(0x8b)]()[_0x378525(0x168)](new Option(_0x378525(0x94),''));try{const _0x79ad09=getContext(),_0x39ee22=_0x79ad09[_0x378525(0x1c5)]?.[_0x378525(0x1b7)]?.['profiles']||[];if(!_0x39ee22||_0x39ee22['length']===0x0){_0x4e4f78['append']($(_0x378525(0x203),{'value':'','text':'未找到酒馆预设','disabled':!![]})),console['warn'](_0x378525(0x1af));return;}let _0x571c65=![];_0x39ee22[_0x378525(0x194)](_0x50bbe6=>{const _0x473539=_0x378525;if(_0x50bbe6['api']&&_0x50bbe6[_0x473539(0x199)]){const _0x22ecd5=$(_0x473539(0x203),{'value':_0x50bbe6['id'],'text':_0x50bbe6['name']||_0x50bbe6['id'],'selected':_0x50bbe6['id']===_0x45036d});_0x4e4f78[_0x473539(0x168)](_0x22ecd5),_0x50bbe6['id']===_0x45036d&&(_0x571c65=!![]);}});if(_0x45036d&&!_0x571c65){toastr[_0x378525(0x19f)](_0x378525(0x15b)+_0x45036d+_0x378525(0x14d),'Amily2号');const _0xb68330=(_0x2a85a2,_0x5e03ea)=>{!extension_settings[extensionName]&&(extension_settings[extensionName]={}),extension_settings[extensionName][_0x2a85a2]=_0x5e03ea,saveSettingsDebounced();};_0xb68330(_0x378525(0x102),'');}else _0x571c65&&_0x4e4f78[_0x378525(0x1c6)](_0x45036d);const _0x3e5fd3=_0x39ee22['filter'](_0x3112ec=>_0x3112ec[_0x378525(0x123)]&&_0x3112ec[_0x378525(0x199)]);console[_0x378525(0xea)]('[Amily2号-UI]\x20SillyTavern预设列表加载完成，找到\x20'+_0x3e5fd3[_0x378525(0x1bf)]+_0x378525(0x10e));}catch(_0x58eec2){console[_0x378525(0x16b)](_0x378525(0x213),_0x58eec2),_0x4e4f78[_0x378525(0x168)]($('<option>',{'value':'','text':_0x378525(0x212),'disabled':!![]})),toastr[_0x378525(0x16b)](_0x378525(0xfb),_0x378525(0x88));}}function updateApiProviderUI(){const _0x742898=_0x5cf7,_0x342688=extension_settings[extensionName]||{},_0x382668=_0x342688[_0x742898(0x18b)]||'openai';$(_0x742898(0xaf))['val'](_0x382668),$(_0x742898(0xaf))[_0x742898(0xd2)](_0x742898(0x158));}export function bindModalEvents(){const _0x387258=_0x5cf7;initializePlotOptimizationBindings();const _0x53027d=$('#amily2_drawer_content')[_0x387258(0x1bf)]?$(_0x387258(0xcd)):$('#amily2_chat_optimiser');displayDailyAuthCode();function _0xf72beb(){const _0x59454b=_0x387258,_0x2c1dfd=extension_settings[extensionName]||{},_0x2ea177=_0x2c1dfd['forceProxyForCustomApi']===!![],_0x66328a=_0x2c1dfd['model']||'';_0x53027d[_0x59454b(0x152)](_0x59454b(0x1e4))['prop'](_0x59454b(0xc6),_0x2ea177),_0x53027d[_0x59454b(0x152)](_0x59454b(0xcf))['val'](_0x66328a);const _0x3daf17=_0x53027d[_0x59454b(0x152)]('#amily2_api_key_wrapper'),_0x3d3033=_0x53027d[_0x59454b(0x152)](_0x59454b(0x1e9)),_0x1fe62d=_0x53027d[_0x59454b(0x152)](_0x59454b(0xcf));_0x2ea177?(_0x3daf17[_0x59454b(0x202)](),_0x3d3033[_0x59454b(0xcc)](),_0x1fe62d['hide']()):(_0x3daf17['show'](),_0x3d3033[_0x59454b(0xcc)](),_0x1fe62d['hide']());}if(!_0x53027d[_0x387258(0x1bf)]||_0x53027d[_0x387258(0x117)](_0x387258(0x90)))return;const _0x1ef95c=_0x19754a=>_0x19754a[_0x387258(0x17c)](/_([a-z])/g,_0x1b2aff=>_0x1b2aff[0x1][_0x387258(0x1f5)]()),_0x5ee9d5=(_0x3ce0c4,_0x471583)=>{const _0x47c490=_0x387258;console[_0x47c490(0xea)](_0x47c490(0x122)+_0x3ce0c4+_0x47c490(0x1b1),_0x471583),!extension_settings[extensionName]&&(extension_settings[extensionName]={}),extension_settings[extensionName]={...extension_settings[extensionName],[_0x3ce0c4]:_0x471583},saveSettingsDebounced(),console[_0x47c490(0xea)](_0x47c490(0xd9)+_0x3ce0c4+_0x47c490(0x1ca));};_0x53027d[_0x387258(0xf6)](_0x387258(0x93))['on'](_0x387258(0x93),_0x387258(0x1e4),function(){const _0x394930=_0x387258;if(!pluginAuthStatus[_0x394930(0x118)])return;_0x5ee9d5(_0x394930(0x119),this[_0x394930(0xc6)]),_0xf72beb(),$(_0x394930(0x14a))[_0x394930(0xd2)]('click');}),_0x53027d[_0x387258(0xf6)](_0x387258(0x1a7))['on'](_0x387258(0x1a7),_0x387258(0xcf),function(){const _0x3e2c81=_0x387258;if(!pluginAuthStatus[_0x3e2c81(0x118)])return;_0x5ee9d5(_0x3e2c81(0xb4),this['value']),toastr[_0x3e2c81(0x19d)](_0x3e2c81(0x91)+this[_0x3e2c81(0x143)]+_0x3e2c81(0xf3),_0x3e2c81(0x88));}),_0x53027d[_0x387258(0xf6)](_0x387258(0xbb))['on'](_0x387258(0xbb),_0x387258(0x126),async function(){const _0x30f5ff=_0x387258,_0xfb1c17=$(_0x30f5ff(0x103))[_0x30f5ff(0x1c6)]()[_0x30f5ff(0x9f)]();_0xfb1c17?await activatePluginAuthorization(_0xfb1c17):toastr[_0x30f5ff(0x19f)]('请输入授权码','Amily2号');}),_0x53027d[_0x387258(0xf6)](_0x387258(0x8c))['on'](_0x387258(0x8c),_0x387258(0x110),async function(){const _0x134ef2=_0x387258;if(!pluginAuthStatus[_0x134ef2(0x118)])return;const _0x20ea5f=$(this),_0x1cd36f=_0x20ea5f[_0x134ef2(0x1ec)]();_0x20ea5f[_0x134ef2(0x174)](_0x134ef2(0x1aa),!![])[_0x134ef2(0x1ec)](_0x134ef2(0x188));try{switch(this['id']){case _0x134ef2(0x140):const _0x38b732=await fetchModels();_0x38b732[_0x134ef2(0x1bf)]>0x0&&(setAvailableModels(_0x38b732),localStorage[_0x134ef2(0x1f8)](_0x134ef2(0x1df),JSON[_0x134ef2(0x1a2)](_0x38b732)),populateModelDropdown());break;case'amily2_test':await testReplyChecker();break;case _0x134ef2(0xd5):await fixCommand();break;}}catch(_0x1af6ae){console['error'](_0x134ef2(0x187)+this['id']+_0x134ef2(0x161),_0x1af6ae),toastr[_0x134ef2(0x16b)](_0x134ef2(0x99)+_0x1af6ae[_0x134ef2(0x87)],'Amily2号');}finally{_0x20ea5f[_0x134ef2(0x174)]('disabled',![])[_0x134ef2(0x1ec)](_0x1cd36f);}}),_0x53027d[_0x387258(0xf6)](_0x387258(0x142))['on']('click.amily2.expand_editor',_0x387258(0x1cd),function(_0x59b617){const _0x47753e=_0x387258;if(!pluginAuthStatus[_0x47753e(0x118)])return;_0x59b617['stopPropagation']();const _0x1398e3=$('#amily2_prompt_selector')[_0x47753e(0x1c6)](),_0x2b6aee=$(_0x47753e(0x115))['val'](),_0x477a2c=_0x47753e(0x10f)+_0x1398e3+'</h4>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22popup-content\x22\x20style=\x22height:\x2070vh;\x22><div\x20class=\x22height100p\x20wide100p\x20flex-container\x22><textarea\x20id=\x22amily2_dialog_editor\x22\x20class=\x22height100p\x20wide100p\x20maximized_textarea\x20text_pole\x22></textarea></div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22popup-controls\x22><div\x20class=\x22popup-button-ok\x20menu_button\x20menu_button_primary\x20interactable\x22>保存并关闭</div><div\x20class=\x22popup-button-cancel\x20menu_button\x20interactable\x22\x20style=\x22margin-left:\x2010px;\x22>取消</div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</dialog>',_0x2cefaf=$(_0x477a2c)[_0x47753e(0x128)](_0x47753e(0xb5)),_0x5de1f5=_0x2cefaf[_0x47753e(0x152)](_0x47753e(0x189));_0x5de1f5['val'](_0x2b6aee);const _0x2de60f=()=>{const _0x55565f=_0x47753e;_0x2cefaf[0x0][_0x55565f(0x1a8)](),_0x2cefaf[_0x55565f(0x124)]();};_0x2cefaf[_0x47753e(0x152)]('.popup-button-ok')['on'](_0x47753e(0xa2),()=>{const _0x21a845=_0x47753e,_0x121d6a=_0x5de1f5[_0x21a845(0x1c6)]();$(_0x21a845(0x115))[_0x21a845(0x1c6)](_0x121d6a),_0x5ee9d5(_0x1398e3,_0x121d6a),toastr[_0x21a845(0x19d)](_0x21a845(0x1fc)+_0x1398e3+_0x21a845(0xdd),_0x21a845(0x88)),_0x2de60f();}),_0x2cefaf['find'](_0x47753e(0x162))['on'](_0x47753e(0xa2),_0x2de60f),_0x2cefaf[0x0]['showModal']();}),_0x53027d[_0x387258(0xf6)](_0x387258(0x111))['on'](_0x387258(0x111),_0x387258(0x104),function(){const _0xf3be4b=_0x387258;if(!pluginAuthStatus[_0xf3be4b(0x118)])return;const _0x264406={'amily2_open_tutorial':{'title':_0xf3be4b(0x171),'url':_0xf3be4b(0xe8)},'amily2_open_neige_tutorial':{'title':'内阁使用教程','url':_0xf3be4b(0x177)}},_0x58ccb9=_0x264406[this['id']];_0x58ccb9&&showContentModal(_0x58ccb9[_0xf3be4b(0x1be)],_0x58ccb9[_0xf3be4b(0xaa)]);}),_0x53027d[_0x387258(0xf6)](_0x387258(0x16d))['on']('click.amily2.update',_0x387258(0x141),function(){const _0x374450=_0x387258;$('#amily2_update_indicator')[_0x374450(0x202)]();const _0x511270=getLatestUpdateInfo();if(_0x511270&&_0x511270['changelog']){const _0x39e895=messageFormatting(_0x511270['changelog']),_0x491bb9=_0x374450(0x14e)+_0x39e895+_0x374450(0xdc),_0x5269c2=$(_0x491bb9)[_0x374450(0x128)](_0x374450(0xb5)),_0x38f911=()=>{_0x5269c2[0x0]['close'](),_0x5269c2['remove']();};_0x5269c2[_0x374450(0x152)](_0x374450(0x1fb))['on'](_0x374450(0xa2),_0x38f911),_0x5269c2[0x0][_0x374450(0x210)]();}else toastr['info'](_0x374450(0xb0),_0x374450(0xc1));}),_0x53027d[_0x387258(0xf6)](_0x387258(0x1de))['on']('click.amily2.update_new',_0x387258(0x172),function(){const _0x4f9cb1=_0x387258;$('span[data-i18n=\x22Manage\x20extensions\x22]')[_0x4f9cb1(0x101)]()['click']();}),_0x53027d[_0x387258(0xf6)](_0x387258(0x15e))['on'](_0x387258(0x15e),_0x387258(0xd4),async function(){const _0x5f9be3=_0x387258;if(!pluginAuthStatus[_0x5f9be3(0x118)])return;const _0xc3671b=this['id'];let _0x431596='',_0x42024f={};switch(_0xc3671b){case'amily2_unhide_all_button':_0x431596=_0x5f9be3(0x205);break;case _0x5f9be3(0xbc):_0x431596=_0x5f9be3(0x100),_0x42024f={'from':$(_0x5f9be3(0x151))['val'](),'to':$(_0x5f9be3(0x83))['val']()};break;case'amily2_manual_unhide_confirm':_0x431596='manual_unhide',_0x42024f={'from':$('#amily2_manual_unhide_from')[_0x5f9be3(0x1c6)](),'to':$(_0x5f9be3(0x1c7))[_0x5f9be3(0x1c6)]()};break;}_0x431596&&await executeManualCommand(_0x431596,_0x42024f);}),_0x53027d[_0x387258(0xf6)]('click.amily2.chamber_nav')['on'](_0x387258(0x8e),'#amily2_open_plot_optimization,\x20#amily2_open_additional_features,\x20#amily2_open_rag_palace,\x20#amily2_open_memorisation_forms,\x20#amily2_back_to_main_settings,\x20#amily2_back_to_main_from_hanlinyuan,\x20#amily2_back_to_main_from_forms,\x20#amily2_back_to_main_from_optimization',function(){const _0x49a3b4=_0x387258;if(!pluginAuthStatus[_0x49a3b4(0x118)])return;const _0x124b12=_0x53027d[_0x49a3b4(0x152)]('.plugin-features'),_0xd8d0b5=_0x53027d[_0x49a3b4(0x152)]('#amily2_additional_features_panel'),_0x1ad89e=_0x53027d['find'](_0x49a3b4(0x195)),_0x571a67=_0x53027d[_0x49a3b4(0x152)]('#amily2_memorisation_forms_panel'),_0x287ace=_0x53027d[_0x49a3b4(0x152)](_0x49a3b4(0x1d5));_0x124b12[_0x49a3b4(0x202)](),_0xd8d0b5[_0x49a3b4(0x202)](),_0x1ad89e['hide'](),_0x571a67[_0x49a3b4(0x202)](),_0x287ace['hide']();switch(this['id']){case _0x49a3b4(0xa3):_0x287ace[_0x49a3b4(0xcc)]();break;case _0x49a3b4(0xff):_0xd8d0b5[_0x49a3b4(0xcc)]();break;case _0x49a3b4(0xfc):_0x1ad89e[_0x49a3b4(0xcc)]();break;case _0x49a3b4(0x163):_0x571a67[_0x49a3b4(0xcc)]();break;case _0x49a3b4(0x207):case _0x49a3b4(0x196):case'amily2_back_to_main_from_forms':case'amily2_back_to_main_from_optimization':_0x124b12[_0x49a3b4(0xcc)]();break;}}),_0x53027d[_0x387258(0xf6)]('change.amily2.checkbox')['on'](_0x387258(0xa7),_0x387258(0x109),function(_0xdae400){const _0x3f1025=_0x387258;if(!pluginAuthStatus[_0x3f1025(0x118)])return;const _0x1b2caf=this['id'],_0x155840=$(this),_0x3ce187=_0x1ef95c(_0x1b2caf['replace'](_0x3f1025(0x133),''));_0x5ee9d5(_0x3ce187,_0x155840[_0x3f1025(0x174)](_0x3f1025(0xc6)));if(_0x1b2caf==='amily2_optimization_exclusion_enabled'&&_0x155840['prop']('checked')){const _0x161a93=extension_settings[extensionName],_0x1a88d6=_0x161a93['optimizationExclusionRules']||[],_0x43391b=(_0x218bac={'start':'','end':''},_0x25ea76)=>'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22opt-exclusion-rule-row\x22\x20data-index=\x22'+_0x25ea76+'\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20class=\x22text_pole\x22\x20value=\x22'+_0x218bac[_0x3f1025(0xcb)]+_0x3f1025(0x1c3)+_0x218bac['end']+'\x22\x20placeholder=\x22结束字符,\x20如\x20-->\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22delete-rule-btn\x20menu_button\x20danger_button\x22\x20title=\x22删除此规则\x22>&times;</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>',_0x4917bb=_0x1a88d6[_0x3f1025(0xa4)](_0x43391b)[_0x3f1025(0x156)](''),_0x5912b1='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22optimization-exclusion-rules-container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22notes\x22>在这里定义需要从优化内容中排除的文本片段。例如，排除HTML注释，可以设置开始字符为\x20`<!--`，结束字符为\x20`-->`。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22optimization-rules-list\x22\x20style=\x22max-height:\x2045vh;\x20overflow-y:\x20auto;\x20padding:\x2010px;\x20border:\x201px\x20solid\x20rgba(255,255,255,0.1);\x20border-radius:\x205px;\x20margin-bottom:10px;\x22>'+_0x4917bb+'</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20style=\x22text-align:\x20center;\x20margin-top:\x2010px;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20id=\x22optimization-add-rule-btn\x22\x20class=\x22menu_button\x20amily2-add-rule-btn\x22><i\x20class=\x22fas\x20fa-plus\x22></i>\x20添加新规则</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>';showHtmlModal(_0x3f1025(0x17b),_0x5912b1,{'okText':'确认','cancelText':'取消','onOk':_0x1904d8=>{const _0x40ba32=_0x3f1025,_0x1a0436=[];_0x1904d8['find'](_0x40ba32(0x19b))[_0x40ba32(0x1d6)](function(){const _0x1c00a1=_0x40ba32,_0x5f2d74=$(this)[_0x1c00a1(0x152)](_0x1c00a1(0x12f))['eq'](0x0)[_0x1c00a1(0x1c6)]()[_0x1c00a1(0x9f)](),_0x478569=$(this)[_0x1c00a1(0x152)](_0x1c00a1(0x12f))['eq'](0x1)[_0x1c00a1(0x1c6)]()[_0x1c00a1(0x9f)]();if(_0x5f2d74&&_0x478569)_0x1a0436[_0x1c00a1(0xad)]({'start':_0x5f2d74,'end':_0x478569});}),_0x5ee9d5(_0x40ba32(0x219),_0x1a0436),toastr[_0x40ba32(0x19d)](_0x40ba32(0xdf),_0x40ba32(0x88));},'onCancel':()=>{}});const _0x57cbbc=$('#optimization-exclusion-rules-container'),_0x4ac555=_0x57cbbc[_0x3f1025(0x152)](_0x3f1025(0x1b2));_0x57cbbc['find'](_0x3f1025(0xed))['on'](_0x3f1025(0xa2),()=>{const _0x406542=_0x3f1025,_0x2f8d5c=_0x4ac555[_0x406542(0x159)]()[_0x406542(0x1bf)];_0x4ac555[_0x406542(0x168)](_0x43391b(undefined,_0x2f8d5c));}),_0x4ac555['on']('click',_0x3f1025(0xfe),function(){const _0x2d8f08=_0x3f1025;$(this)[_0x2d8f08(0xd6)](_0x2d8f08(0x19b))[_0x2d8f08(0x124)]();});}}),_0x53027d[_0x387258(0xf6)]('change.amily2.radio')['on']('change.amily2.radio',_0x387258(0x15d),function(){const _0x499d0a=_0x387258;if(!pluginAuthStatus['authorized'])return;const _0x81be9d=_0x1ef95c(this['name'][_0x499d0a(0x17c)](_0x499d0a(0x133),'')),_0x498554=$(_0x499d0a(0xb7)+this[_0x499d0a(0x216)]+'\x22]:checked')[_0x499d0a(0x1c6)]();_0x5ee9d5(_0x81be9d,_0x498554);}),_0x53027d[_0x387258(0xf6)](_0x387258(0x1d2))['on']('change.amily2.api_provider',_0x387258(0xaf),function(){const _0x1bf629=_0x387258;if(!pluginAuthStatus[_0x1bf629(0x118)])return;const _0x1afe97=$(this)[_0x1bf629(0x1c6)]();console[_0x1bf629(0xea)]('[Amily2号-UI]\x20API提供商切换为:\x20'+_0x1afe97),_0x5ee9d5(_0x1bf629(0x18b),_0x1afe97);const _0x3eecfe=$(_0x1bf629(0xbf)),_0x3d86f6=$(_0x1bf629(0xe7)),_0x2a42e9=$('#amily2_preset_wrapper');_0x3eecfe['hide'](),_0x3d86f6['hide'](),_0x2a42e9[_0x1bf629(0x202)]();const _0x36fcc8=$(_0x1bf629(0x106));switch(_0x1afe97){case _0x1bf629(0xd8):_0x3eecfe[_0x1bf629(0xcc)](),_0x3d86f6[_0x1bf629(0xcc)](),_0x36fcc8[_0x1bf629(0xcc)](),$('#amily2_api_url')['attr'](_0x1bf629(0xb8),_0x1bf629(0x136)),$('#amily2_api_key')[_0x1bf629(0x200)](_0x1bf629(0xb8),_0x1bf629(0x170));break;case _0x1bf629(0x149):_0x3eecfe[_0x1bf629(0x202)](),_0x3d86f6[_0x1bf629(0xcc)](),_0x36fcc8[_0x1bf629(0xcc)](),$(_0x1bf629(0xf5))[_0x1bf629(0x200)](_0x1bf629(0xb8),'Google\x20API\x20Key');break;case'sillytavern_backend':_0x3eecfe[_0x1bf629(0xcc)](),_0x36fcc8[_0x1bf629(0xcc)](),$(_0x1bf629(0x1a4))[_0x1bf629(0x200)](_0x1bf629(0xb8),_0x1bf629(0x1ae));break;case _0x1bf629(0x1bc):_0x2a42e9['show'](),_0x36fcc8['hide'](),loadSillyTavernPresets();break;}$(_0x1bf629(0x150))['empty']()[_0x1bf629(0x168)](_0x1bf629(0x135));}),_0x53027d['off'](_0x387258(0xf7))['on']('change.amily2.text',_0x387258(0x165),function(){const _0x1dce0f=_0x387258;if(!pluginAuthStatus[_0x1dce0f(0x118)])return;const _0x860d45=_0x1ef95c(this['id'][_0x1dce0f(0x17c)](_0x1dce0f(0x133),''));_0x5ee9d5(_0x860d45,this[_0x1dce0f(0x143)]),toastr[_0x1dce0f(0x19d)](_0x1dce0f(0x18d)+_0x860d45+_0x1dce0f(0xf3),_0x1dce0f(0x88));}),_0x53027d['off'](_0x387258(0x92))['on'](_0x387258(0x92),'select#amily2_model,\x20select#amily2_preset_selector',function(){const _0x1f3cd6=_0x387258;if(!pluginAuthStatus[_0x1f3cd6(0x118)])return;const _0x1fde37=_0x1ef95c(this['id']['replace'](_0x1f3cd6(0x133),''));let _0x12dc2a=this[_0x1f3cd6(0x143)];this['id']===_0x1f3cd6(0x19c)?_0x5ee9d5(_0x1f3cd6(0x1c0),_0x12dc2a):_0x5ee9d5(_0x1fde37,_0x12dc2a),this['id']==='amily2_model'&&populateModelDropdown();}),_0x53027d[_0x387258(0xf6)](_0x387258(0x1f4))['on']('input.amily2.range',_0x387258(0xc7),function(){const _0x27c23=_0x387258;if(!pluginAuthStatus['authorized'])return;const _0x3eb6a8=_0x1ef95c(this['id'][_0x27c23(0x17c)]('amily2_','')),_0x4e86f2=this['id'][_0x27c23(0x9b)](_0x27c23(0x146))?parseFloat(this[_0x27c23(0x143)]):parseInt(this[_0x27c23(0x143)],0xa);$('#'+this['id']+_0x27c23(0x1d7))[_0x27c23(0x1d0)](_0x4e86f2),_0x5ee9d5(_0x3eb6a8,_0x4e86f2);});const _0x5f1021={'mainPrompt':_0x387258(0x10a),'systemPrompt':_0x387258(0x167),'outputFormatPrompt':_0x387258(0x131)},_0x4c0e9b=_0x387258(0xc0),_0x2bcbf6=_0x387258(0x115),_0x4b1370=_0x387258(0x1a9);function _0x17ba56(){const _0x5b0bb2=_0x387258;if(!$(_0x4c0e9b)[_0x5b0bb2(0x1bf)])return;const _0x1734e2=$(_0x4c0e9b)[_0x5b0bb2(0x1c6)]();if(!_0x1734e2)return;const _0x4322fd=extension_settings[extensionName][_0x1734e2]||'';$(_0x2bcbf6)[_0x5b0bb2(0x1c6)](_0x4322fd);}_0x53027d[_0x387258(0xf6)](_0x387258(0x1e8))['on'](_0x387258(0x1e8),_0x4c0e9b,_0x17ba56),_0x53027d[_0x387258(0xf6)](_0x387258(0xe3))['on'](_0x387258(0xe3),_0x4b1370,function(){const _0x344f13=_0x387258,_0x41ae19=$(_0x4c0e9b)['val']();if(!_0x41ae19)return;const _0x127bff=$(_0x2bcbf6)[_0x344f13(0x1c6)]();_0x5ee9d5(_0x41ae19,_0x127bff),toastr[_0x344f13(0x19d)]('谕令\x20['+_0x41ae19+']\x20已镌刻!','Amily2号');}),_0x53027d['off'](_0x387258(0x20e))['on']('click.amily2.unified_restore',_0x387258(0x197),function(){const _0x545614=_0x387258,_0x7158fb=$(_0x4c0e9b)[_0x545614(0x1c6)]();if(!_0x7158fb)return;const _0x476bc4=defaultSettings[_0x7158fb];$(_0x2bcbf6)[_0x545614(0x1c6)](_0x476bc4),_0x5ee9d5(_0x7158fb,_0x476bc4),toastr['success'](_0x545614(0x1fc)+_0x7158fb+_0x545614(0x1b4),_0x545614(0x88));}),_0x53027d['off'](_0x387258(0x147))['on'](_0x387258(0x147),_0x387258(0xe4),function(){const _0x10b8cf=_0x387258;if(!pluginAuthStatus[_0x10b8cf(0x118)])return;let _0x441cbb=_0x1ef95c(this['id']['replace'](_0x10b8cf(0x133),''));_0x441cbb===_0x10b8cf(0x19a)&&(_0x441cbb=_0x10b8cf(0x17a));const _0xb0a4f7=this['type']==='number'?parseInt(this[_0x10b8cf(0x143)],0xa):this['value'];_0x5ee9d5(_0x441cbb,_0xb0a4f7);if(this['id']==='amily2_lore_insertion_position'){const _0x46b0fa=$(_0x10b8cf(0x13b));this[_0x10b8cf(0x143)]===_0x10b8cf(0x1bd)?_0x46b0fa['slideDown'](0xc8):_0x46b0fa[_0x10b8cf(0x8f)](0xc8);}}),_0x53027d['off'](_0x387258(0x1d1))['on'](_0x387258(0x1d1),'#amily2_save_lore_settings',function(){const _0x226172=_0x387258;if(!pluginAuthStatus[_0x226172(0x118)])return;const _0x1e4ad2=$(this),_0x456fe4=$('#amily2_lore_save_status');_0x1e4ad2[_0x226172(0x174)]('disabled',!![])[_0x226172(0x1ec)](_0x226172(0x1cb)),_0x456fe4[_0x226172(0x1d0)](_0x226172(0xa1))[_0x226172(0x8a)]()[_0x226172(0x11b)](),setTimeout(()=>{const _0x2cfee6=_0x226172;_0x1e4ad2[_0x2cfee6(0x174)](_0x2cfee6(0x1aa),![])['html'](_0x2cfee6(0x20c)),_0x456fe4[_0x2cfee6(0x154)]();},0x9c4);}),setTimeout(_0x17ba56,0x64),_0xf72beb(),_0x53027d['data'](_0x387258(0x90),!![]);}export function opt_saveAllSettings(){const _0x1cff64=_0x5cf7,_0x2717c9=$(_0x1cff64(0x1d5));if(_0x2717c9[_0x1cff64(0x1bf)]===0x0)return;console['log']('['+extensionName+']\x20手动触发所有剧情优化设置的保存...'),_0x2717c9[_0x1cff64(0x152)]('input[type=\x22checkbox\x22],\x20input[type=\x22radio\x22],\x20input[type=\x22text\x22],\x20input[type=\x22password\x22],\x20textarea,\x20select')[_0x1cff64(0xd2)](_0x1cff64(0x145)),_0x2717c9[_0x1cff64(0x152)](_0x1cff64(0xa8))[_0x1cff64(0xd2)]('change.amily2_opt'),opt_saveEnabledEntries(),toastr[_0x1cff64(0x21e)](_0x1cff64(0x1e6));}function opt_toCamelCase(_0x18c577){const _0x41b636=_0x5cf7;return _0x18c577[_0x41b636(0x17c)](/[-_]([a-z])/g,_0x5ddf2e=>_0x5ddf2e[0x1][_0x41b636(0x1f5)]());}function _0x5cf7(_0x5e54cc,_0x52c524){const _0x2ca943=_0x2ca9();return _0x5cf7=function(_0x5cf7e2,_0x31cefa){_0x5cf7e2=_0x5cf7e2-0x83;let _0x1c665c=_0x2ca943[_0x5cf7e2];return _0x1c665c;},_0x5cf7(_0x5e54cc,_0x52c524);}function opt_updateApiUrlVisibility(_0x4e3cca,_0x25dd08){const _0x3622b0=_0x5cf7,_0x423439=_0x4e3cca['find']('#amily2_opt_custom_api_settings_block'),_0x1515f6=_0x4e3cca[_0x3622b0(0x152)](_0x3622b0(0x18e)),_0x79d974=_0x4e3cca[_0x3622b0(0x152)]('#amily2_opt_api_url');_0x423439[_0x3622b0(0x202)](),_0x1515f6['hide']();if(_0x25dd08===_0x3622b0(0x113))_0x1515f6['show']();else{_0x423439[_0x3622b0(0xcc)]();if(_0x25dd08===_0x3622b0(0x149)){_0x4e3cca['find'](_0x3622b0(0x9e))[_0x3622b0(0x202)]();const _0x340192=_0x3622b0(0x218);_0x79d974[_0x3622b0(0x1c6)]()!==_0x340192&&_0x79d974[_0x3622b0(0x1c6)](_0x340192)['trigger']('change');}else _0x4e3cca['find'](_0x3622b0(0x9e))[_0x3622b0(0xcc)]();}}function _0x2ca9(){const _0x43ff6d=['导入失败:\x20','attr','<p\x20class=\x22notes\x22\x20style=\x22color:red;\x22>加载条目失败。</p>','hide','<option>',']\x20导入预设失败:','unhide_all','</label>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','amily2_back_to_main_settings','plotOpt_apiMode','plotOpt_selectedWorldbooks','promptPresets','onload','<i\x20class=\x22fas\x20fa-save\x22></i>\x20确认敕令','#amily2_opt_context_limit','click.amily2.unified_restore','addEventListener','showModal','\x22\x20已被覆盖。','加载预设失败','[Amily2号-UI]\x20加载酒馆API预设失败:','#amily2_opt_top_p',']\x20保存角色数据失败:','name','findIndex','https://generativelanguage.googleapis.com','optimizationExclusionRules','topbar','CHAT_CHANGED','plotOpt_contextLimit','#amily2_opt_main_prompt','info','#amily2_manual_hide_to','#amily2_extension_frame','additional',']...','message','Amily2号','。圣意已存档。','stop','empty','click.amily2.actions',']\x20检测到角色/聊天切换，正在刷新剧情优化设置UI...','click.amily2.chamber_nav','slideUp','events-bound','模型ID\x20[','change.amily2.select','change.amily2.force_proxy','--\x20请选择一个酒馆预设\x20--','amily2_opt_worldbook_source','TavernHelper','plotOpt_mainPrompt','plotOpt_apiKey','操作失败:\x20','#amily2_opt_reset_system_prompt','includes','#amily2_opt_model','最终注入指令已重置为默认值。','#amily2_opt_api_url_block','trim','\x0aUID:\x20','圣意已在您每次更改时自动镌刻。','click','amily2_open_plot_optimization','map','\x22\x20已成功导出。','number','change.amily2.checkbox','input[type=\x22range\x22]','plotOpt_api_mode','url','#amily2_opt_model_select','请输入预设名称：','push','无法加载世界书列表，请查看控制台。','#amily2_api_provider','未能获取到云端情报，请稍后再试。','mainPrompt','\x22\x20吗？','POST','model','body','<p\x20class=\x22notes\x22>所选世界书没有条目。</p>','input[name=\x22','placeholder','ratePersonal','getLorebooks','click.amily2.auth','amily2_manual_hide_confirm','#amily2_opt_refresh_tavern_api_profiles','#amily2_opt_top_p_value','#amily2_api_url_wrapper','#amily2_prompt_selector','情报部回报','amily2_opt_','#amily2_opt_export_prompt_presets','\x22\x20已被删除。','#amily2_opt_final_system_directive','checked','input[type=\x22range\x22][id^=\x22amily2_\x22]','amily2-opt-entry-','amily2_daily_code_display','plotOpt_rateCuckold','start','show','#amily2_drawer_content','12pGEFQD','#amily2_manual_model_input','plotOpt_ratePersonal','.json','trigger','#amily2_opt_worldbook_entry_select_all','#amily2_unhide_all_button,\x20#amily2_manual_hide_confirm,\x20#amily2_manual_unhide_confirm','amily2_fix_now','closest','input.amily2_opt\x20change.amily2_opt','openai','[Amily-谕令镌刻]\x20[','plotOpt_top_p','迁都令','</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22popup-controls\x22><div\x20class=\x22popup-button-ok\x20menu_button\x20menu_button_primary\x20interactable\x22>朕已阅</div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</dialog>',']\x20已镌刻！','iconLocation','排除规则已更新。','isArray','<p\x20class=\x22notes\x22>未选择角色。</p>','#amily2_opt_worldbook_checkbox_list\x20input:checked','click.amily2.unified_save','select[id^=\x22amily2_lore_\x22],\x20input#amily2_lore_depth_input','rateCuckold','找不到要删除的预设，操作可能已过期。','#amily2_api_key_wrapper','scripts/extensions/third-party/ST-Amily2-Chat-Optimisation/ZhuDian.md','plotOpt_promptPresets','log','plotOpt_tavernProfile','plotOpt_enabledWorldbookEntries','#optimization-add-rule-btn','appendChild','6170723VbdcYM','keys','splice','#amily2_opt_prompt_preset_select',']\x20已自动保存!','primary','#amily2_api_key','off','change.amily2.text','\x22\x20已保存。','target','确定要删除预设\x20\x22','无法加载酒馆API预设列表，请查看控制台。','amily2_open_rag_palace','[Amily-禁卫军]\x20收到迁都指令\x20->\x20','.delete-rule-btn','amily2_open_additional_features','manual_hide','first','selectedPreset','#amily2_auth_code','#amily2_open_tutorial,\x20#amily2_open_neige_tutorial','plotOpt_model','#amily2_model_selector','名为\x20\x22','plotOpt_rateMain','input[type=\x22checkbox\x22][id^=\x22amily2_\x22]','#amily2_main_prompt','plotOpt_systemPrompt','rateMain','\x22\x20的预设已存在。是否要覆盖它？','\x20个有效预设','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<dialog\x20class=\x22popup\x20wide_dialogue_popup\x20large_dialogue_popup\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22popup-body\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h4\x20style=\x22margin-top:0;\x20color:\x20#eee;\x20border-bottom:\x201px\x20solid\x20rgba(255,255,255,0.2);\x20padding-bottom:\x2010px;\x22>正在编辑:\x20','#amily2_refresh_models,\x20#amily2_test,\x20#amily2_fix_now','click.amily2.tutorial','未找到可导入的有效预设。','tavern','createElement','#amily2_unified_editor',']\x20获取角色世界书失败:','data','authorized','forceProxyForCustomApi','status','fadeIn','amily2_copy_daily_code','input[type=\x22radio\x22]','<-请先获取模型','#amily2_opt_context_limit_value','130rUdbAm','#amily2_opt_reset_main_prompt','[Amily-谕令确认]\x20收到指令:\x20将\x20[','api','remove','#amily2_opt_selected_worldbooks','#auth_submit','#amily2_opt_max_tokens','appendTo','14MBcBMt','11lUObEA','finalSystemDirective','没有选择任何预设。','systemPrompt','正在将帝国徽记迁往\x20[','input','#amily2_opt_rate_erotic','#amily2_output_format_prompt','uid','amily2_','textContent','<option\x20value=\x22\x22>请刷新模型列表</option>','https://api.openai.com/v1','amily2-opt-wb-check-','#amily2_opt_rate_personal','css','all','#amily2_lore_depth_container','clipboard','#amily2_opt_presence_penalty','164054toNaiO','预设\x20\x22','amily2_refresh_models','#amily2_update_button','click.amily2.expand_editor','value','profiles','change.amily2_opt','temperature','change.amily2.lore_settings','rateErotic','google','#amily2_refresh_models','plotOpt_max_tokens','#amily2_opt_worldbook_select_wrapper','\x22\x20已不存在，请重新选择。','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<dialog\x20class=\x22popup\x20wide_dialogue_popup\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22popup-body\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h3\x20style=\x22margin-top:0;\x20color:\x20#eee;\x20border-bottom:\x201px\x20solid\x20rgba(255,255,255,0.2);\x20padding-bottom:\x2010px;\x22><i\x20class=\x22fas\x20fa-bell\x22\x20style=\x22color:\x20#ff9800;\x22></i>\x20帝国最新情报</h3>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22popup-content\x22\x20style=\x22height:\x2060vh;\x20overflow-y:\x20auto;\x20background:\x20rgba(0,0,0,0.2);\x20padding:\x2015px;\x20border-radius:\x205px;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22mes_text\x22>','localeCompare','#amily2_model','#amily2_manual_hide_from','find','#amily2_opt_worldbook_entry_list_container','fadeOut','#amily2_opt_temperature','join','application/json','change','children','#amily2_opt_delete_prompt_preset','之前选择的酒馆预设\x20\x22','190800TWKwfe','input[type=\x22radio\x22][name^=\x22amily2_\x22]:not([name=\x22amily2_icon_location\x22])','click.amily2.manual_command','\x22\x20data-uid=\x22','授权码已复制到剪贴板！','\x20执行失败:','.popup-button-cancel','amily2_open_memorisation_forms','plotOpt_finalSystemDirective','#amily2_api_url,\x20#amily2_api_key,\x20#amily2_optimization_target_tag','拦截任务指令已重置为默认值。','#amily2_system_prompt','append','character','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22amily2_opt_worldbook_entry_item\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20id=\x22','error','909212qMDqhF','click.amily2.update','#amily2_opt_tavern_api_profile_select','#amily2_opt_worldbook_checkbox_list','sk-...','主殿使用教程','#amily2_update_button_new','\x20条目.','prop','[Amily2号-UI]\x20正在加载SillyTavern预设列表','string','scripts/extensions/third-party/ST-Amily2-Chat-Optimisation/NeiGe.md','#amily2_preset_selector','input[name=\x22amily2_opt_worldbook_source\x22][value=\x22','loreDepth','编辑内容排除规则','replace','revokeObjectURL','#amily2_opt_api_url','sort','comment','3XYYlIc','#amily2_opt_system_prompt',':checked','请先从下拉菜单中选择一个要导出的预设。','#amily2_opt_worldbook_entry_count','plotOpt_worldbookCharLimit','[Amily2-工部]\x20操作按钮\x20','<i\x20class=\x22fas\x20fa-spinner\x20fa-spin\x22></i>\x20处理中','#amily2_dialog_editor','1057408ipHulx','apiProvider','select:not(#amily2_opt_model_select)','配置\x20[','#amily2_opt_tavern_api_profile_block','input[type=\x22text\x22]','parse','>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20for=\x22','#amily2_opt_temperature_value','input[type=\x22password\x22]','forEach','#amily2_hanlinyuan_panel','amily2_back_to_main_from_hanlinyuan','#amily2_unified_restore_button','mousedown.amily2Drawer','preset','loreDepthInput','.opt-exclusion-rule-row','amily2_preset_selector','success','成功导入\x20','warning','/api/characters/merge-attributes','plotOpt_','stringify','avatar','#amily2_api_url','1bXZUAQ',']\x20角色卡设置已更新:\x20','change.amily2.manual_model','close','#amily2_unified_save_button','disabled','result','plotOpt_apiUrl','click.amily2_opt','http://localhost:5000/v1','[Amily2号-UI]\x20未找到SillyTavern预设','#amily2_opt_frequency_penalty',']\x20设置为\x20->','#optimization-rules-list','removeChild',']\x20已成功恢复为帝国初始蓝图。','#amily2_opt_context_turn_count','bookName','connectionManager','扩展区','#amily2_main_drawer','显示\x20','1978596REOIqr','sillytavern_preset','at_depth','title','length','tavernProfile','#amily2_opt_rate_main','\x20个新预设。','\x22\x20placeholder=\x22开始字符,\x20如\x20<!--\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span>到</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20class=\x22text_pole\x22\x20value=\x22','input[name=\x22amily2_opt_api_mode\x22][value=\x22','extensionSettings','val','#amily2_manual_unhide_to','plotOpt_selected_worldbooks','获取角色世界书失败。',']\x20的新状态已保存。','<i\x20class=\x22fas\x20fa-check\x22></i>\x20已确认','auto','#amily2_expand_editor',']\x20加载世界书条目失败:','type','text','click.amily2.lore_save','change.amily2.api_provider','\x20/\x20','input[name=\x22amily2_icon_location\x22]','#amily2_plot_optimization_panel','each','_value','plotOpt_worldbookEnabled','plotOpt_frequency_penalty','API\x20call\x20failed\x20with\x20status:\x20','#amily2_opt_worldbook_checkbox_list\x20input[type=\x22checkbox\x22]','#amily2_opt_worldbook_entry_deselect_all','manual','click.amily2.update_new','cached_models_amily2','plotOpt_rateErotic','#amily2_opt_worldbook_entry_list_container\x20input[type=\x22checkbox\x22]','lastUsedPresetName','extensions','#amily2_force_proxy','\x22\x20data-book=\x22','剧情优化设置已自动保存。','#amily2_opt_rate_cuckold','change.amily2.prompt_selector','#amily2_model_autofetch_wrapper','#amily2_opt_preset_file_input','none','html','plotOpt_worldbookSource','checkbox','#amily2_opt_api_key','plotOpt_temperature','#amily2_opt_refresh_worldbooks','readAsText','#amily2_opt_import_prompt_presets','input.amily2.range','toUpperCase','562670GoXbXs','#amily2_opt_enabled','setItem','then','未找到酒馆预设','.popup-button-ok','谕令\x20[',']\x20加载酒馆API预设失败:','<p\x20class=\x22notes\x22\x20style=\x22color:red;\x22>获取角色世界书失败。</p>'];_0x2ca9=function(){return _0x43ff6d;};return _0x2ca9();}function opt_updateWorldbookSourceVisibility(_0xad5393,_0x4923bd){const _0x433c7e=_0x5cf7,_0x343c65=_0xad5393[_0x433c7e(0x152)](_0x433c7e(0x14c));if(_0x4923bd===_0x433c7e(0x1dd)){_0x343c65[_0x433c7e(0xcc)]();const _0x559a08=_0x343c65[_0x433c7e(0x152)](_0x433c7e(0x125));_0x559a08[_0x433c7e(0x139)]({'height':_0x433c7e(0x1cc),'background-color':'var(--bg1)','appearance':_0x433c7e(0x1eb),'-webkit-appearance':'none'});}else _0x343c65[_0x433c7e(0x202)]();}async function opt_loadTavernApiProfiles(_0x562a9f){const _0x3fa961=_0x5cf7,_0x4bdbc2=_0x562a9f[_0x3fa961(0x152)](_0x3fa961(0x16e)),_0x1bce83=opt_getMergedSettings(),_0x14c1ca=_0x1bce83[_0x3fa961(0xeb)],_0x37e48f=_0x4bdbc2[_0x3fa961(0x1c6)]();_0x4bdbc2['empty']()['append'](new Option(_0x3fa961(0x94),''));try{const _0x4f8892=getContext()[_0x3fa961(0x1c5)]?.[_0x3fa961(0x1b7)]?.[_0x3fa961(0x144)]||[];if(!_0x4f8892||_0x4f8892[_0x3fa961(0x1bf)]===0x0){_0x4bdbc2[_0x3fa961(0x168)]($(_0x3fa961(0x203),{'value':'','text':_0x3fa961(0x1fa),'disabled':!![]}));return;}let _0x5bacd5=![];_0x4f8892[_0x3fa961(0x194)](_0x48e974=>{const _0x1e75d3=_0x3fa961;if(_0x48e974['api']&&_0x48e974[_0x1e75d3(0x199)]){const _0x1419c8=$(_0x1e75d3(0x203),{'value':_0x48e974['id'],'text':_0x48e974[_0x1e75d3(0x216)]||_0x48e974['id'],'selected':_0x48e974['id']===_0x14c1ca});_0x4bdbc2[_0x1e75d3(0x168)](_0x1419c8),_0x48e974['id']===_0x14c1ca&&(_0x5bacd5=!![]);}});if(_0x14c1ca&&!_0x5bacd5)toastr['warning']('之前选择的酒馆预设\x20\x22'+_0x14c1ca+_0x3fa961(0x14d)),opt_saveSetting('tavernProfile','');else _0x5bacd5&&_0x4bdbc2[_0x3fa961(0x1c6)](_0x14c1ca);}catch(_0x48d89e){console[_0x3fa961(0x16b)]('['+extensionName+_0x3fa961(0x1fd),_0x48d89e),toastr['error'](_0x3fa961(0xfb));}}const opt_characterSpecificSettings=[_0x5b2195(0x1ed),_0x5b2195(0x209),_0x5b2195(0xec)];async function opt_saveSetting(_0x278247,_0x11f7a0){const _0x483f79=_0x5b2195;if(opt_characterSpecificSettings['includes'](_0x278247)){const _0x3c1cc7=characters[this_chid];if(!_0x3c1cc7)return;if(!_0x3c1cc7[_0x483f79(0x117)][_0x483f79(0x1e3)])_0x3c1cc7[_0x483f79(0x117)][_0x483f79(0x1e3)]={};if(!_0x3c1cc7[_0x483f79(0x117)]['extensions'][extensionName])_0x3c1cc7[_0x483f79(0x117)][_0x483f79(0x1e3)][extensionName]={};_0x3c1cc7[_0x483f79(0x117)][_0x483f79(0x1e3)][extensionName][_0x278247]=_0x11f7a0;try{const _0x4fb292=await fetch(_0x483f79(0x1a0),{'method':_0x483f79(0xb3),'headers':getRequestHeaders(),'body':JSON[_0x483f79(0x1a2)]({'avatar':_0x3c1cc7[_0x483f79(0x1a3)],'data':{'extensions':{[extensionName]:_0x3c1cc7[_0x483f79(0x117)][_0x483f79(0x1e3)][extensionName]}}})});if(!_0x4fb292['ok'])throw new Error(_0x483f79(0x1da)+_0x4fb292[_0x483f79(0x11a)]);console[_0x483f79(0xea)]('['+extensionName+_0x483f79(0x1a6)+_0x278247+'\x20->',_0x11f7a0);}catch(_0x35cb71){console[_0x483f79(0x16b)]('['+extensionName+_0x483f79(0x215),_0x35cb71),toastr[_0x483f79(0x16b)]('无法保存角色卡设置，请检查控制台。');}}else!extension_settings[extensionName]&&(extension_settings[extensionName]={}),extension_settings[extensionName][_0x278247]=_0x11f7a0,saveSettingsDebounced();}function opt_getMergedSettings(){const _0x537f73=_0x5b2195,_0x17f3f3=characters[this_chid],_0x56f89f=extension_settings[extensionName]||defaultSettings,_0x4aaffa=_0x17f3f3?.[_0x537f73(0x117)]?.[_0x537f73(0x1e3)]?.[extensionName]||{};return{..._0x56f89f,..._0x4aaffa};}function opt_bindSlider(_0x368277,_0x5d234c,_0x22bb4d){const _0x5a14dc=_0x5b2195,_0x36173f=_0x368277[_0x5a14dc(0x152)](_0x5d234c),_0x38c59b=_0x368277[_0x5a14dc(0x152)](_0x22bb4d);_0x38c59b[_0x5a14dc(0x1d0)](_0x36173f['val']()),_0x36173f['on'](_0x5a14dc(0x12f),function(){const _0x140e4d=_0x5a14dc;_0x38c59b[_0x140e4d(0x1d0)]($(this)[_0x140e4d(0x1c6)]());});}async function opt_loadWorldbooks(_0x590970){const _0x109fb8=_0x5b2195,_0x42b706=_0x590970[_0x109fb8(0x152)](_0x109fb8(0x16f)),_0x4dca0d=opt_getMergedSettings(),_0x562922=_0x4dca0d[_0x109fb8(0x209)]||[];_0x42b706[_0x109fb8(0x8b)]();try{const _0x22a42b=await window[_0x109fb8(0x96)][_0x109fb8(0xba)]();if(!_0x22a42b||_0x22a42b[_0x109fb8(0x1bf)]===0x0){_0x42b706[_0x109fb8(0x1ec)]('<p\x20class=\x22notes\x22>未找到世界书。</p>');return;}_0x22a42b[_0x109fb8(0x194)](_0x299ba6=>{const _0x221589=_0x109fb8,_0x398547=_0x221589(0x137)+_0x299ba6[_0x221589(0x17c)](/[^a-zA-Z0-9]/g,'-'),_0x5ab2f0=_0x562922[_0x221589(0x9b)](_0x299ba6),_0x1573b1=$(_0x221589(0x16a)+_0x398547+'\x22\x20value=\x22'+_0x299ba6+'\x22\x20'+(_0x5ab2f0?_0x221589(0xc6):'')+_0x221589(0x191)+_0x398547+'\x22>'+_0x299ba6+'</label>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20');_0x42b706[_0x221589(0x168)](_0x1573b1);});}catch(_0x341f0b){console[_0x109fb8(0x16b)]('['+extensionName+']\x20加载世界书失败:',_0x341f0b),_0x42b706[_0x109fb8(0x1ec)]('<p\x20class=\x22notes\x22\x20style=\x22color:red;\x22>加载世界书列表失败。</p>'),toastr[_0x109fb8(0x16b)](_0x109fb8(0xae));}}async function opt_loadWorldbookEntries(_0x329581){const _0x31bc31=_0x5b2195,_0x3347c9=_0x329581[_0x31bc31(0x152)](_0x31bc31(0x153)),_0x582430=_0x329581['find'](_0x31bc31(0x185));_0x3347c9[_0x31bc31(0x1ec)]('<p>加载条目中...</p>'),_0x582430[_0x31bc31(0x1d0)]('');const _0x8d0a03=opt_getMergedSettings(),_0x2469e8=_0x8d0a03[_0x31bc31(0x1ed)]||'character';let _0x4ea4fb=[];if(_0x2469e8===_0x31bc31(0x1dd))_0x4ea4fb=_0x8d0a03[_0x31bc31(0x209)]||[];else{if(this_chid===-0x1||!characters[this_chid]){_0x3347c9[_0x31bc31(0x1ec)](_0x31bc31(0xe1)),_0x582430[_0x31bc31(0x1d0)]('');return;}try{const _0x5ec690=await window['TavernHelper']['getCharLorebooks']({'type':_0x31bc31(0x13a)});if(_0x5ec690[_0x31bc31(0xf4)])_0x4ea4fb[_0x31bc31(0xad)](_0x5ec690['primary']);if(_0x5ec690[_0x31bc31(0x85)]?.[_0x31bc31(0x1bf)])_0x4ea4fb[_0x31bc31(0xad)](..._0x5ec690[_0x31bc31(0x85)]);}catch(_0x18c658){console['error']('['+extensionName+_0x31bc31(0x116),_0x18c658),toastr[_0x31bc31(0x16b)](_0x31bc31(0x1c9)),_0x3347c9[_0x31bc31(0x1ec)](_0x31bc31(0x1fe));return;}}const _0x173e9b=_0x4ea4fb;let _0x2308ad=_0x8d0a03[_0x31bc31(0xec)]||{},_0x138083=0x0,_0x5d3868=0x0;if(_0x173e9b[_0x31bc31(0x1bf)]===0x0){_0x3347c9[_0x31bc31(0x1ec)]('<p\x20class=\x22notes\x22>请选择一个或多个世界书以查看其条目。</p>');return;}try{const _0x28ba32=[];for(const _0x3e7537 of _0x173e9b){const _0x7b89b7=await window[_0x31bc31(0x96)]['getLorebookEntries'](_0x3e7537);_0x7b89b7[_0x31bc31(0x194)](_0x3b0218=>{const _0x319638=_0x31bc31;_0x28ba32[_0x319638(0xad)]({..._0x3b0218,'bookName':_0x3e7537});});}_0x3347c9[_0x31bc31(0x8b)](),_0x138083=_0x28ba32[_0x31bc31(0x1bf)];if(_0x138083===0x0){_0x3347c9[_0x31bc31(0x1ec)](_0x31bc31(0xb6)),_0x582430[_0x31bc31(0x1d0)]('0\x20条目.');return;}_0x28ba32[_0x31bc31(0x17f)]((_0x5d9dcd,_0x1102ed)=>(_0x5d9dcd[_0x31bc31(0x180)]||'')[_0x31bc31(0x14f)](_0x1102ed['comment']||''))[_0x31bc31(0x194)](_0x1e7762=>{const _0xf3c94b=_0x31bc31,_0x219584=_0xf3c94b(0xc8)+_0x1e7762['bookName'][_0xf3c94b(0x17c)](/[^a-zA-Z0-9]/g,'-')+'-'+_0x1e7762[_0xf3c94b(0x132)],_0x4956b8=_0x2308ad[_0x1e7762[_0xf3c94b(0x1b6)]]?.[_0xf3c94b(0x9b)](_0x1e7762[_0xf3c94b(0x132)])??!![],_0x2b01ae=$(_0xf3c94b(0x16a)+_0x219584+_0xf3c94b(0x1e5)+_0x1e7762[_0xf3c94b(0x1b6)]+_0xf3c94b(0x15f)+_0x1e7762[_0xf3c94b(0x132)]+'\x22\x20'+(_0x4956b8?_0xf3c94b(0xc6):'')+_0xf3c94b(0x191)+_0x219584+'\x22\x20title=\x22世界书:\x20'+_0x1e7762['bookName']+_0xf3c94b(0xa0)+_0x1e7762[_0xf3c94b(0x132)]+'\x22>'+(_0x1e7762['comment']||'无标题条目')+_0xf3c94b(0x206));_0x3347c9[_0xf3c94b(0x168)](_0x2b01ae);}),_0x5d3868=_0x3347c9[_0x31bc31(0x159)]()[_0x31bc31(0x1bf)],_0x582430[_0x31bc31(0x1d0)](_0x31bc31(0x1ba)+_0x5d3868+_0x31bc31(0x1d3)+_0x138083+_0x31bc31(0x173));}catch(_0x11ef65){console[_0x31bc31(0x16b)]('['+extensionName+_0x31bc31(0x1ce),_0x11ef65),_0x3347c9[_0x31bc31(0x1ec)](_0x31bc31(0x201));}}function opt_saveEnabledEntries(){const _0x1ad3ab=_0x5b2195,_0x40abac=$('#amily2_plot_optimization_panel');let _0x1362ea={};_0x40abac[_0x1ad3ab(0x152)](_0x1ad3ab(0x1e1))[_0x1ad3ab(0x1d6)](function(){const _0x20fc81=_0x1ad3ab,_0xf42ade=$(this)[_0x20fc81(0x117)]('book'),_0x5ac4f3=parseInt($(this)[_0x20fc81(0x117)](_0x20fc81(0x132)));!_0x1362ea[_0xf42ade]&&(_0x1362ea[_0xf42ade]=[]),$(this)['is'](_0x20fc81(0x183))&&_0x1362ea[_0xf42ade][_0x20fc81(0xad)](_0x5ac4f3);});const _0x3cc4ca=opt_getMergedSettings();if(_0x3cc4ca[_0x1ad3ab(0x1ed)]===_0x1ad3ab(0x1dd)){const _0x403704=_0x3cc4ca['plotOpt_selectedWorldbooks']||[];Object[_0x1ad3ab(0xf0)](_0x1362ea)['forEach'](_0x3b580d=>{!_0x403704['includes'](_0x3b580d)&&delete _0x1362ea[_0x3b580d];});}opt_saveSetting(_0x1ad3ab(0xec),_0x1362ea);}function opt_loadPromptPresets(_0x2ad4e1){const _0xe7ae3e=_0x5b2195,_0x1428f8=extension_settings[extensionName]?.['promptPresets']||[],_0x2c21df=_0x2ad4e1[_0xe7ae3e(0x152)](_0xe7ae3e(0xf2)),_0x1880e9=_0x2c21df['val']();_0x2c21df[_0xe7ae3e(0x8b)]()['append'](new Option('--\x20选择一个预设\x20--','')),_0x1428f8['forEach'](_0x577ea4=>{const _0x9df4ac=_0xe7ae3e;_0x2c21df[_0x9df4ac(0x168)](new Option(_0x577ea4[_0x9df4ac(0x216)],_0x577ea4[_0x9df4ac(0x216)]));}),_0x1880e9&&_0x1428f8['some'](_0x39026e=>_0x39026e[_0xe7ae3e(0x216)]===_0x1880e9)&&_0x2c21df[_0xe7ae3e(0x1c6)](_0x1880e9);}function opt_saveCurrentPromptsAsPreset(_0x155083){const _0x3664e6=_0x5b2195,_0x523328=prompt(_0x3664e6(0xac));if(!_0x523328)return;const _0x4516e2=extension_settings[extensionName]?.[_0x3664e6(0x20a)]||[],_0xb02346=_0x4516e2[_0x3664e6(0x217)](_0x374602=>_0x374602[_0x3664e6(0x216)]===_0x523328),_0x11505e={'name':_0x523328,'mainPrompt':_0x155083[_0x3664e6(0x152)]('#amily2_opt_main_prompt')[_0x3664e6(0x1c6)](),'systemPrompt':_0x155083[_0x3664e6(0x152)](_0x3664e6(0x182))[_0x3664e6(0x1c6)](),'finalSystemDirective':_0x155083['find'](_0x3664e6(0xc5))['val'](),'rateMain':parseFloat(_0x155083['find']('#amily2_opt_rate_main')[_0x3664e6(0x1c6)]()),'ratePersonal':parseFloat(_0x155083[_0x3664e6(0x152)]('#amily2_opt_rate_personal')[_0x3664e6(0x1c6)]()),'rateErotic':parseFloat(_0x155083[_0x3664e6(0x152)](_0x3664e6(0x130))[_0x3664e6(0x1c6)]()),'rateCuckold':parseFloat(_0x155083[_0x3664e6(0x152)](_0x3664e6(0x1e7))['val']())};if(_0xb02346!==-0x1){if(confirm(_0x3664e6(0x107)+_0x523328+_0x3664e6(0x10d)))_0x4516e2[_0xb02346]=_0x11505e,toastr['success']('预设\x20\x22'+_0x523328+_0x3664e6(0x211));else{toastr[_0x3664e6(0x21e)]('保存操作已取消。');return;}}else _0x4516e2[_0x3664e6(0xad)](_0x11505e),toastr['success'](_0x3664e6(0x13f)+_0x523328+_0x3664e6(0xf8));opt_saveSetting(_0x3664e6(0x20a),_0x4516e2),opt_loadPromptPresets(_0x155083),setTimeout(()=>{const _0x4cada8=_0x3664e6;_0x155083[_0x4cada8(0x152)](_0x4cada8(0xf2))[_0x4cada8(0x1c6)](_0x523328)[_0x4cada8(0xd2)](_0x4cada8(0x158));},0x0);}function opt_deleteSelectedPreset(_0xe0927c){const _0x3099f3=_0x5b2195,_0x4bae70=_0xe0927c['find'](_0x3099f3(0xf2)),_0x16f1be=_0x4bae70[_0x3099f3(0x1c6)]();if(!_0x16f1be){toastr[_0x3099f3(0x19f)](_0x3099f3(0x12c));return;}if(!confirm(_0x3099f3(0xfa)+_0x16f1be+_0x3099f3(0xb2)))return;const _0x4ffd46=extension_settings[extensionName]?.[_0x3099f3(0x20a)]||[],_0xb8ade4=_0x4ffd46[_0x3099f3(0x217)](_0x480f97=>_0x480f97[_0x3099f3(0x216)]===_0x16f1be);_0xb8ade4>-0x1?(_0x4ffd46[_0x3099f3(0xf1)](_0xb8ade4,0x1),opt_saveSetting(_0x3099f3(0x20a),_0x4ffd46),toastr[_0x3099f3(0x19d)]('预设\x20\x22'+_0x16f1be+_0x3099f3(0xc4))):toastr[_0x3099f3(0x16b)](_0x3099f3(0xe6)),opt_loadPromptPresets(_0xe0927c),_0x4bae70[_0x3099f3(0xd2)](_0x3099f3(0x158));}function opt_exportPromptPresets(){const _0x500c73=_0x5b2195,_0x4acf80=$('#amily2_opt_prompt_preset_select'),_0x2d0d9a=_0x4acf80[_0x500c73(0x1c6)]();if(!_0x2d0d9a){toastr[_0x500c73(0x21e)](_0x500c73(0x184));return;}const _0x20e6cb=extension_settings[extensionName]?.['promptPresets']||[],_0x2d2287=_0x20e6cb[_0x500c73(0x152)](_0x10627e=>_0x10627e[_0x500c73(0x216)]===_0x2d0d9a);if(!_0x2d2287){toastr[_0x500c73(0x16b)]('找不到选中的预设，请刷新页面后重试。');return;}const _0x31444c=[_0x2d2287],_0x513440=JSON[_0x500c73(0x1a2)](_0x31444c,null,0x2),_0x1cf747=new Blob([_0x513440],{'type':_0x500c73(0x157)}),_0x379eb9=URL['createObjectURL'](_0x1cf747),_0x33cc95=document[_0x500c73(0x114)]('a');_0x33cc95['href']=_0x379eb9,_0x33cc95['download']='amily2_opt_preset_'+_0x2d0d9a[_0x500c73(0x17c)](/[^a-z0-9]/gi,'_')+_0x500c73(0xd1),document[_0x500c73(0xb5)][_0x500c73(0xee)](_0x33cc95),_0x33cc95[_0x500c73(0xa2)](),document[_0x500c73(0xb5)][_0x500c73(0x1b3)](_0x33cc95),URL[_0x500c73(0x17d)](_0x379eb9),toastr['success']('预设\x20\x22'+_0x2d0d9a+_0x500c73(0xa5));}function opt_importPromptPresets(_0x3c6d23,_0x9c89a){const _0x18c610=_0x5b2195;if(!_0x3c6d23)return;const _0x33ee6f=new FileReader();_0x33ee6f[_0x18c610(0x20b)]=function(_0x5dc2aa){const _0xc1fa68=_0x18c610;try{const _0x57fe83=JSON[_0xc1fa68(0x190)](_0x5dc2aa[_0xc1fa68(0xf9)][_0xc1fa68(0x1ab)]);if(!Array[_0xc1fa68(0xe0)](_0x57fe83))throw new Error('JSON文件格式不正确，根节点必须是一个数组。');let _0x3acfd3=extension_settings[extensionName]?.[_0xc1fa68(0x20a)]||[],_0x3ae97b=0x0,_0x168fc2=0x0;_0x57fe83[_0xc1fa68(0x194)](_0x3be9af=>{const _0x3ca5a3=_0xc1fa68;if(_0x3be9af&&typeof _0x3be9af['name']===_0x3ca5a3(0x176)&&_0x3be9af[_0x3ca5a3(0x216)][_0x3ca5a3(0x1bf)]>0x0){const _0x29bc6e={'name':_0x3be9af['name'],'mainPrompt':_0x3be9af['mainPrompt']||'','systemPrompt':_0x3be9af[_0x3ca5a3(0x12d)]||'','finalSystemDirective':_0x3be9af[_0x3ca5a3(0x12b)]||'','rateMain':_0x3be9af[_0x3ca5a3(0x10c)]??0x1,'ratePersonal':_0x3be9af[_0x3ca5a3(0xb9)]??0x1,'rateErotic':_0x3be9af['rateErotic']??0x1,'rateCuckold':_0x3be9af['rateCuckold']??0x1},_0x372fcc=_0x3acfd3[_0x3ca5a3(0x217)](_0xd02f9e=>_0xd02f9e[_0x3ca5a3(0x216)]===_0x3be9af[_0x3ca5a3(0x216)]);_0x372fcc!==-0x1?(_0x3acfd3[_0x372fcc]=_0x29bc6e,_0x168fc2++):(_0x3acfd3[_0x3ca5a3(0xad)](_0x29bc6e),_0x3ae97b++);}});if(_0x3ae97b>0x0||_0x168fc2>0x0){const _0x2d1f17=_0x9c89a['find'](_0xc1fa68(0xf2))['val']();opt_saveSetting(_0xc1fa68(0x20a),_0x3acfd3),opt_loadPromptPresets(_0x9c89a),_0x9c89a['find']('#amily2_opt_prompt_preset_select')[_0xc1fa68(0x1c6)](_0x2d1f17),_0x9c89a[_0xc1fa68(0x152)](_0xc1fa68(0xf2))['trigger'](_0xc1fa68(0x158));let _0x110d08=[];if(_0x3ae97b>0x0)_0x110d08[_0xc1fa68(0xad)](_0xc1fa68(0x19e)+_0x3ae97b+_0xc1fa68(0x1c2));if(_0x168fc2>0x0)_0x110d08[_0xc1fa68(0xad)]('成功覆盖\x20'+_0x168fc2+'\x20个同名预设。');toastr[_0xc1fa68(0x19d)](_0x110d08[_0xc1fa68(0x156)]('\x20'));}else toastr['warning'](_0xc1fa68(0x112));}catch(_0x2bec9a){console[_0xc1fa68(0x16b)]('['+extensionName+_0xc1fa68(0x204),_0x2bec9a),toastr[_0xc1fa68(0x16b)](_0xc1fa68(0x1ff)+_0x2bec9a['message'],'错误');}finally{_0x9c89a[_0xc1fa68(0x152)](_0xc1fa68(0x1ea))[_0xc1fa68(0x1c6)]('');}},_0x33ee6f[_0x18c610(0x1f2)](_0x3c6d23);}function opt_loadSettings(_0x4da2d6){const _0x14a9de=_0x5b2195,_0x4b895d=opt_getMergedSettings();_0x4da2d6[_0x14a9de(0x152)](_0x14a9de(0x1f7))[_0x14a9de(0x174)]('checked',_0x4b895d['plotOpt_enabled']),_0x4da2d6[_0x14a9de(0x152)](_0x14a9de(0x1c4)+_0x4b895d['plotOpt_apiMode']+'\x22]')[_0x14a9de(0x174)](_0x14a9de(0xc6),!![]),_0x4da2d6[_0x14a9de(0x152)](_0x14a9de(0x16e))[_0x14a9de(0x1c6)](_0x4b895d[_0x14a9de(0xeb)]),_0x4da2d6[_0x14a9de(0x152)](_0x14a9de(0x179)+(_0x4b895d['plotOpt_worldbookSource']||_0x14a9de(0x169))+'\x22]')[_0x14a9de(0x174)](_0x14a9de(0xc6),!![]),_0x4da2d6[_0x14a9de(0x152)]('#amily2_opt_worldbook_enabled')[_0x14a9de(0x174)]('checked',_0x4b895d[_0x14a9de(0x1d8)]),_0x4da2d6[_0x14a9de(0x152)](_0x14a9de(0x17e))[_0x14a9de(0x1c6)](_0x4b895d[_0x14a9de(0x1ac)]),_0x4da2d6[_0x14a9de(0x152)](_0x14a9de(0x1ef))[_0x14a9de(0x1c6)](_0x4b895d[_0x14a9de(0x98)]);const _0x3833c2=_0x4da2d6['find'](_0x14a9de(0x9c)),_0x3b7a63=_0x4da2d6[_0x14a9de(0x152)](_0x14a9de(0xab));_0x3833c2[_0x14a9de(0x1c6)](_0x4b895d[_0x14a9de(0x105)]),_0x3b7a63['empty']();_0x4b895d[_0x14a9de(0x105)]?_0x3b7a63['append'](new Option(_0x4b895d[_0x14a9de(0x105)],_0x4b895d[_0x14a9de(0x105)],!![],!![])):_0x3b7a63[_0x14a9de(0x168)](new Option(_0x14a9de(0x11e),'',!![],!![]));_0x4da2d6[_0x14a9de(0x152)](_0x14a9de(0x127))['val'](_0x4b895d[_0x14a9de(0x14b)]),_0x4da2d6[_0x14a9de(0x152)](_0x14a9de(0x155))['val'](_0x4b895d[_0x14a9de(0x1f0)]),_0x4da2d6[_0x14a9de(0x152)](_0x14a9de(0x214))['val'](_0x4b895d[_0x14a9de(0xda)]),_0x4da2d6[_0x14a9de(0x152)](_0x14a9de(0x13d))[_0x14a9de(0x1c6)](_0x4b895d['plotOpt_presence_penalty']),_0x4da2d6[_0x14a9de(0x152)](_0x14a9de(0x1b0))[_0x14a9de(0x1c6)](_0x4b895d[_0x14a9de(0x1d9)]),_0x4da2d6[_0x14a9de(0x152)](_0x14a9de(0x1b5))[_0x14a9de(0x1c6)](_0x4b895d['plotOpt_contextTurnCount']),_0x4da2d6['find']('#amily2_opt_worldbook_char_limit')[_0x14a9de(0x1c6)](_0x4b895d[_0x14a9de(0x186)]),_0x4da2d6['find'](_0x14a9de(0x20d))[_0x14a9de(0x1c6)](_0x4b895d[_0x14a9de(0x21c)]),_0x4da2d6[_0x14a9de(0x152)](_0x14a9de(0x1c1))[_0x14a9de(0x1c6)](_0x4b895d[_0x14a9de(0x108)]),_0x4da2d6['find'](_0x14a9de(0x138))['val'](_0x4b895d[_0x14a9de(0xd0)]),_0x4da2d6[_0x14a9de(0x152)](_0x14a9de(0x130))[_0x14a9de(0x1c6)](_0x4b895d['plotOpt_rateErotic']),_0x4da2d6[_0x14a9de(0x152)](_0x14a9de(0x1e7))['val'](_0x4b895d[_0x14a9de(0xca)]),_0x4da2d6['find']('#amily2_opt_main_prompt')['val'](_0x4b895d['plotOpt_mainPrompt']),_0x4da2d6[_0x14a9de(0x152)](_0x14a9de(0x182))['val'](_0x4b895d[_0x14a9de(0x10b)]),_0x4da2d6[_0x14a9de(0x152)]('#amily2_opt_final_system_directive')[_0x14a9de(0x1c6)](_0x4b895d[_0x14a9de(0x164)]),opt_updateApiUrlVisibility(_0x4da2d6,_0x4b895d[_0x14a9de(0x208)]),opt_updateWorldbookSourceVisibility(_0x4da2d6,_0x4b895d['plotOpt_worldbookSource']||'character'),opt_bindSlider(_0x4da2d6,_0x14a9de(0x127),'#amily2_opt_max_tokens_value'),opt_bindSlider(_0x4da2d6,_0x14a9de(0x155),_0x14a9de(0x192)),opt_bindSlider(_0x4da2d6,_0x14a9de(0x214),_0x14a9de(0xbe)),opt_bindSlider(_0x4da2d6,_0x14a9de(0x13d),'#amily2_opt_presence_penalty_value'),opt_bindSlider(_0x4da2d6,_0x14a9de(0x1b0),'#amily2_opt_frequency_penalty_value'),opt_bindSlider(_0x4da2d6,'#amily2_opt_context_turn_count','#amily2_opt_context_turn_count_value'),opt_bindSlider(_0x4da2d6,'#amily2_opt_worldbook_char_limit','#amily2_opt_worldbook_char_limit_value'),opt_bindSlider(_0x4da2d6,_0x14a9de(0x20d),_0x14a9de(0x11f)),opt_loadPromptPresets(_0x4da2d6);const _0x419690=_0x4b895d['plotOpt_lastUsedPresetName'];_0x419690&&(_0x4b895d[_0x14a9de(0xe9)]||[])['some'](_0x5d5e17=>_0x5d5e17['name']===_0x419690)&&setTimeout(()=>{const _0x19542e=_0x14a9de;_0x4da2d6[_0x19542e(0x152)]('#amily2_opt_prompt_preset_select')[_0x19542e(0x1c6)](_0x419690)[_0x19542e(0xd2)](_0x19542e(0x158),{'isAutomatic':!![]});},0x0),opt_loadWorldbooks(_0x4da2d6)[_0x14a9de(0x1f9)](()=>{opt_loadWorldbookEntries(_0x4da2d6);}),opt_loadTavernApiProfiles(_0x4da2d6);}export function initializePlotOptimizationBindings(){const _0x30bc07=_0x5b2195,_0x5c3e36=$(_0x30bc07(0x1d5));if(_0x5c3e36[_0x30bc07(0x1bf)]===0x0||_0x5c3e36[_0x30bc07(0x117)](_0x30bc07(0x90)))return;opt_loadSettings(_0x5c3e36),eventSource['on'](event_types[_0x30bc07(0x21b)],()=>{const _0x377d3c=_0x30bc07;console['log']('['+extensionName+_0x377d3c(0x8d)),opt_loadSettings(_0x5c3e36);});const _0x5de95a=function(_0x257db7){const _0x12ff8f=_0x30bc07,_0x5f1953=$(_0x257db7),_0x2e236e=(_0x257db7[_0x12ff8f(0x216)]||_0x257db7['id'])[_0x12ff8f(0x17c)](_0x12ff8f(0xc2),''),_0x31ec74=_0x12ff8f(0x1a1)+_0x2e236e['replace'](/_([a-z])/g,_0x12c066=>_0x12c066[0x1][_0x12ff8f(0x1f5)]());let _0x4a42ed=_0x257db7[_0x12ff8f(0x1cf)]==='checkbox'?_0x257db7[_0x12ff8f(0xc6)]:_0x5f1953[_0x12ff8f(0x1c6)]();_0x31ec74===_0x12ff8f(0x1c8)&&!Array[_0x12ff8f(0xe0)](_0x4a42ed)&&(_0x4a42ed=_0x5f1953[_0x12ff8f(0x1c6)]()||[]);const _0x292c0c=[_0x12ff8f(0x1f0),_0x12ff8f(0xda),'plotOpt_presence_penalty',_0x12ff8f(0x1d9),_0x12ff8f(0x108),_0x12ff8f(0xd0),_0x12ff8f(0x1e0),_0x12ff8f(0xca)];if(_0x292c0c[_0x12ff8f(0x9b)](_0x31ec74)&&_0x4a42ed!=='')_0x4a42ed=parseFloat(_0x4a42ed);else{if(_0x257db7['type']==='range'||_0x257db7[_0x12ff8f(0x1cf)]===_0x12ff8f(0xa6)){if(_0x4a42ed!=='')_0x4a42ed=parseInt(_0x4a42ed,0xa);}}(_0x4a42ed!==''||_0x257db7['type']===_0x12ff8f(0x1ee))&&opt_saveSetting(_0x31ec74,_0x4a42ed),_0x31ec74===_0x12ff8f(0xa9)&&opt_updateApiUrlVisibility(_0x5c3e36,_0x4a42ed),_0x257db7[_0x12ff8f(0x216)]===_0x12ff8f(0x95)&&(opt_updateWorldbookSourceVisibility(_0x5c3e36,_0x4a42ed),opt_loadWorldbookEntries(_0x5c3e36));},_0x51a0ec=['input[type=\x22checkbox\x22]',_0x30bc07(0x11d),_0x30bc07(0x18c),_0x30bc07(0x18f),_0x30bc07(0x193),'textarea',_0x30bc07(0xa8),'input[type=\x22number\x22]'][_0x30bc07(0x156)](',\x20');_0x5c3e36['on'](_0x30bc07(0xd7),_0x51a0ec,function(){_0x5de95a(this);}),_0x5c3e36['on'](_0x30bc07(0x145),'#amily2_opt_model_select',function(){const _0x47ccb6=_0x30bc07,_0x2bb7be=$(this)['val']();_0x2bb7be&&_0x5c3e36['find'](_0x47ccb6(0x9c))[_0x47ccb6(0x1c6)](_0x2bb7be)[_0x47ccb6(0xd2)](_0x47ccb6(0x158));}),_0x5c3e36['on'](_0x30bc07(0x1ad),_0x30bc07(0xbd),()=>{opt_loadTavernApiProfiles(_0x5c3e36);}),_0x5c3e36['on'](_0x30bc07(0x145),_0x30bc07(0x16e),function(){const _0x5a3930=_0x30bc07,_0x591429=$(this)[_0x5a3930(0x1c6)]();opt_saveSetting(_0x5a3930(0x1c0),_0x591429);}),_0x5c3e36[_0x30bc07(0x152)](_0x30bc07(0x1f3))['on'](_0x30bc07(0xa2),()=>_0x5c3e36[_0x30bc07(0x152)](_0x30bc07(0x1ea))[_0x30bc07(0xa2)]()),_0x5c3e36[_0x30bc07(0x152)](_0x30bc07(0xc3))['on'](_0x30bc07(0xa2),()=>opt_exportPromptPresets()),_0x5c3e36[_0x30bc07(0x152)]('#amily2_opt_save_prompt_preset')['on'](_0x30bc07(0xa2),()=>opt_saveCurrentPromptsAsPreset(_0x5c3e36)),_0x5c3e36[_0x30bc07(0x152)]('#amily2_opt_delete_prompt_preset')['on'](_0x30bc07(0xa2),()=>opt_deleteSelectedPreset(_0x5c3e36)),_0x5c3e36['on'](_0x30bc07(0x145),_0x30bc07(0x1ea),function(_0x1b5b1a){opt_importPromptPresets(_0x1b5b1a['target']['files'][0x0],_0x5c3e36);}),_0x5c3e36['on'](_0x30bc07(0x145),_0x30bc07(0xf2),function(_0x263994,_0x57cd68){const _0x45044b=_0x30bc07,_0x54d8e3=$(this)[_0x45044b(0x1c6)](),_0x199d3a=_0x5c3e36[_0x45044b(0x152)](_0x45044b(0x15a)),_0x198d61=_0x57cd68&&_0x57cd68['isAutomatic'];opt_saveSetting(_0x45044b(0x1e2),_0x54d8e3);if(!_0x54d8e3){_0x199d3a[_0x45044b(0x202)](),opt_saveSetting(_0x45044b(0x1e2),'');return;}const _0x34e274=extension_settings[extensionName]?.['promptPresets']||[],_0x3de511=_0x34e274[_0x45044b(0x152)](_0xc6a47=>_0xc6a47[_0x45044b(0x216)]===_0x54d8e3);_0x3de511?(_0x5c3e36[_0x45044b(0x152)](_0x45044b(0x21d))['val'](_0x3de511[_0x45044b(0xb1)])['trigger'](_0x45044b(0x158)),_0x5c3e36[_0x45044b(0x152)](_0x45044b(0x182))[_0x45044b(0x1c6)](_0x3de511['systemPrompt'])[_0x45044b(0xd2)]('change'),_0x5c3e36['find']('#amily2_opt_final_system_directive')[_0x45044b(0x1c6)](_0x3de511[_0x45044b(0x12b)])[_0x45044b(0xd2)](_0x45044b(0x158)),_0x5c3e36[_0x45044b(0x152)](_0x45044b(0x1c1))['val'](_0x3de511[_0x45044b(0x10c)]??0x1)[_0x45044b(0xd2)](_0x45044b(0x158)),_0x5c3e36[_0x45044b(0x152)]('#amily2_opt_rate_personal')[_0x45044b(0x1c6)](_0x3de511[_0x45044b(0xb9)]??0x1)[_0x45044b(0xd2)](_0x45044b(0x158)),_0x5c3e36[_0x45044b(0x152)]('#amily2_opt_rate_erotic')[_0x45044b(0x1c6)](_0x3de511[_0x45044b(0x148)]??0x1)[_0x45044b(0xd2)](_0x45044b(0x158)),_0x5c3e36['find'](_0x45044b(0x1e7))['val'](_0x3de511[_0x45044b(0xe5)]??0x1)[_0x45044b(0xd2)](_0x45044b(0x158)),!_0x198d61&&toastr[_0x45044b(0x19d)]('已加载预设\x20\x22'+_0x54d8e3+'\x22。'),_0x199d3a[_0x45044b(0xcc)]()):_0x199d3a['hide']();}),_0x5c3e36[_0x30bc07(0x152)](_0x30bc07(0x121))['on'](_0x30bc07(0xa2),function(){const _0x2576ea=_0x30bc07;_0x5c3e36[_0x2576ea(0x152)](_0x2576ea(0x21d))[_0x2576ea(0x1c6)](defaultSettings[_0x2576ea(0x97)])[_0x2576ea(0xd2)](_0x2576ea(0x158)),toastr[_0x2576ea(0x19d)]('主提示词已重置为默认值。');}),_0x5c3e36[_0x30bc07(0x152)](_0x30bc07(0x9a))['on'](_0x30bc07(0xa2),function(){const _0x38a951=_0x30bc07;_0x5c3e36[_0x38a951(0x152)](_0x38a951(0x182))[_0x38a951(0x1c6)](defaultSettings['plotOpt_systemPrompt'])[_0x38a951(0xd2)](_0x38a951(0x158)),toastr[_0x38a951(0x19d)](_0x38a951(0x166));}),_0x5c3e36['find']('#amily2_opt_reset_final_system_directive')['on'](_0x30bc07(0xa2),function(){const _0x4c9a25=_0x30bc07;_0x5c3e36[_0x4c9a25(0x152)](_0x4c9a25(0xc5))[_0x4c9a25(0x1c6)](defaultSettings['plotOpt_finalSystemDirective'])['trigger']('change'),toastr['success'](_0x4c9a25(0x9d));}),_0x5c3e36[_0x30bc07(0x117)](_0x30bc07(0x90),!![]),console[_0x30bc07(0xea)]('['+extensionName+']\x20剧情优化UI事件已成功绑定，自动保存已激活。'),_0x5c3e36['on']('click.amily2_opt',_0x30bc07(0x1f1),()=>{const _0x350174=_0x30bc07;opt_loadWorldbooks(_0x5c3e36)[_0x350174(0x1f9)](()=>{opt_loadWorldbookEntries(_0x5c3e36);});}),_0x5c3e36['on'](_0x30bc07(0x145),_0x30bc07(0x1db),async function(){const _0x209ed1=_0x30bc07,_0x4de1c8=[];_0x5c3e36['find'](_0x209ed1(0xe2))['each'](function(){const _0x2f0a32=_0x209ed1;_0x4de1c8['push']($(this)[_0x2f0a32(0x1c6)]());}),await opt_saveSetting(_0x209ed1(0x209),_0x4de1c8),await opt_loadWorldbookEntries(_0x5c3e36);}),_0x5c3e36['on'](_0x30bc07(0x145),_0x30bc07(0x1e1),()=>{opt_saveEnabledEntries();}),_0x5c3e36['on'](_0x30bc07(0x1ad),_0x30bc07(0xd3),()=>{const _0x6d98b5=_0x30bc07;_0x5c3e36['find'](_0x6d98b5(0x1e1))[_0x6d98b5(0x174)](_0x6d98b5(0xc6),!![]),opt_saveEnabledEntries();}),_0x5c3e36['on'](_0x30bc07(0x1ad),_0x30bc07(0x1dc),()=>{const _0x491408=_0x30bc07;_0x5c3e36[_0x491408(0x152)]('#amily2_opt_worldbook_entry_list_container\x20input[type=\x22checkbox\x22]')['prop']('checked',![]),opt_saveEnabledEntries();});}$(document)['on'](_0x5b2195(0x158),_0x5b2195(0x1d4),function(){const _0x3aad96=_0x5b2195;if(!pluginAuthStatus[_0x3aad96(0x118)])return;const _0x2bda06=$(this)['val']();extension_settings[extensionName][_0x3aad96(0xde)]=_0x2bda06,saveSettingsDebounced(),console[_0x3aad96(0xea)](_0x3aad96(0xfd)+_0x2bda06+_0x3aad96(0x89)),toastr[_0x3aad96(0x21e)](_0x3aad96(0x12e)+(_0x2bda06===_0x3aad96(0x21a)?'顶栏':_0x3aad96(0x1b8))+_0x3aad96(0x86),_0x3aad96(0xdb),{'timeOut':0x7d0}),$(_0x3aad96(0x1b9))['remove'](),$(document)[_0x3aad96(0xf6)](_0x3aad96(0x198)),$(_0x3aad96(0x84))[_0x3aad96(0x124)](),setTimeout(createDrawer,0x32);});
