const _0x34ba23=_0xca22;(function(_0xd7c281,_0x459c33){const _0x320d01=_0xca22,_0x124048=_0xd7c281();while(!![]){try{const _0x3eb8d5=-parseInt(_0x320d01(0x19c))/0x1*(parseInt(_0x320d01(0x1ef))/0x2)+-parseInt(_0x320d01(0x143))/0x3+-parseInt(_0x320d01(0x158))/0x4*(-parseInt(_0x320d01(0x1e1))/0x5)+-parseInt(_0x320d01(0x114))/0x6+-parseInt(_0x320d01(0x1cf))/0x7+-parseInt(_0x320d01(0x18e))/0x8+-parseInt(_0x320d01(0x225))/0x9*(-parseInt(_0x320d01(0xe9))/0xa);if(_0x3eb8d5===_0x459c33)break;else _0x124048['push'](_0x124048['shift']());}catch(_0x39391b){_0x124048['push'](_0x124048['shift']());}}}(_0x30b2,0xde738));import{extension_settings,getContext}from'/scripts/extensions.js';import{characters,this_chid,getRequestHeaders,saveSettingsDebounced,eventSource,event_types}from'/script.js';import{defaultSettings,extensionName}from'../utils/settings.js';import{pluginAuthStatus,activatePluginAuthorization,getPasswordForDate}from'../utils/auth.js';import{fetchModels}from'../core/api.js';import{setAvailableModels,populateModelDropdown,getLatestUpdateInfo}from'./state.js';import{fixCommand,testReplyChecker}from'../core/commands.js';import{createDrawer}from'../ui/drawer.js';import{messageFormatting}from'/script.js';function _0xca22(_0x3c37b7,_0x484a78){const _0x30b25a=_0x30b2();return _0xca22=function(_0xca2280,_0x11b475){_0xca2280=_0xca2280-0x96;let _0x66464a=_0x30b25a[_0xca2280];return _0x66464a;},_0xca22(_0x3c37b7,_0x484a78);}import{executeManualCommand}from'../core/autoHideManager.js';import{showContentModal,showHtmlModal}from'./page-window.js';function displayDailyAuthCode(){const _0x453ec1=_0xca22,_0x2f3818=document['getElementById'](_0x453ec1(0xcd)),_0x639926=document[_0x453ec1(0xa9)](_0x453ec1(0x113));if(_0x2f3818&&_0x639926){const _0x58b766=getPasswordForDate(new Date());_0x2f3818[_0x453ec1(0xb6)]=_0x58b766,_0x639926[_0x453ec1(0x1b7)](_0x453ec1(0x10c),()=>{const _0x387501=_0x453ec1;navigator[_0x387501(0x163)]['writeText'](_0x58b766)['then'](()=>{const _0x232406=_0x387501;toastr[_0x232406(0x1e9)](_0x232406(0xbe));},()=>{const _0x530fe0=_0x387501;toastr[_0x530fe0(0x19a)](_0x530fe0(0xd7));});});}}async function loadSillyTavernPresets(){const _0x500d34=_0xca22;console[_0x500d34(0x106)](_0x500d34(0x1ba));const _0x19c5e0=$(_0x500d34(0x1d1)),_0x551bfb=extension_settings[extensionName]||{},_0x2b6f5c=_0x551bfb['selectedPreset'];_0x19c5e0['empty']()['append'](new Option(_0x500d34(0x204),''));try{const _0x3ff759=getContext(),_0x2bbcda=_0x3ff759[_0x500d34(0x185)]?.[_0x500d34(0x16f)]?.['profiles']||[];if(!_0x2bbcda||_0x2bbcda['length']===0x0){_0x19c5e0[_0x500d34(0x1be)]($(_0x500d34(0x1cc),{'value':'','text':_0x500d34(0x1e0),'disabled':!![]})),console[_0x500d34(0xc0)](_0x500d34(0x206));return;}let _0x472e8a=![];_0x2bbcda[_0x500d34(0x16d)](_0x33f9ce=>{const _0x39bb04=_0x500d34;if(_0x33f9ce['api']&&_0x33f9ce[_0x39bb04(0xd5)]){const _0x1e7d4a=$(_0x39bb04(0x1cc),{'value':_0x33f9ce['id'],'text':_0x33f9ce['name']||_0x33f9ce['id'],'selected':_0x33f9ce['id']===_0x2b6f5c});_0x19c5e0[_0x39bb04(0x1be)](_0x1e7d4a),_0x33f9ce['id']===_0x2b6f5c&&(_0x472e8a=!![]);}});if(_0x2b6f5c&&!_0x472e8a){toastr[_0x500d34(0x179)](_0x500d34(0x194)+_0x2b6f5c+_0x500d34(0xdd),_0x500d34(0x157));const _0x3b57ce=(_0x31e9c5,_0x194dbb)=>{!extension_settings[extensionName]&&(extension_settings[extensionName]={}),extension_settings[extensionName][_0x31e9c5]=_0x194dbb,saveSettingsDebounced();};_0x3b57ce(_0x500d34(0x98),'');}else _0x472e8a&&_0x19c5e0[_0x500d34(0xe5)](_0x2b6f5c);const _0x57acfe=_0x2bbcda[_0x500d34(0x124)](_0x46e1ad=>_0x46e1ad[_0x500d34(0x1b8)]&&_0x46e1ad[_0x500d34(0xd5)]);console[_0x500d34(0x106)](_0x500d34(0x203)+_0x57acfe[_0x500d34(0x12a)]+_0x500d34(0x1b3));}catch(_0x1ab130){console[_0x500d34(0x19a)](_0x500d34(0x146),_0x1ab130),_0x19c5e0['append']($('<option>',{'value':'','text':_0x500d34(0xc7),'disabled':!![]})),toastr['error'](_0x500d34(0x139),'Amily2号');}}function updateApiProviderUI(){const _0x3496eb=_0xca22,_0x54b6f2=extension_settings[extensionName]||{},_0x4723a8=_0x54b6f2[_0x3496eb(0x172)]||_0x3496eb(0xb7);$(_0x3496eb(0x144))[_0x3496eb(0xe5)](_0x4723a8),$(_0x3496eb(0x144))['trigger']('change');}export function bindModalEvents(){const _0x2ffa96=_0xca22;initializePlotOptimizationBindings();const _0x3b6ce8=$(_0x2ffa96(0x238))[_0x2ffa96(0x12a)]?$(_0x2ffa96(0x238)):$('#amily2_chat_optimiser');displayDailyAuthCode();function _0x222d6f(){const _0x5b0d1e=_0x2ffa96,_0x377c16=extension_settings[extensionName]||{},_0x166553=_0x377c16[_0x5b0d1e(0x213)]===!![],_0x53ed84=_0x377c16[_0x5b0d1e(0x1c3)]||'';_0x3b6ce8[_0x5b0d1e(0xf0)]('#amily2_force_proxy')[_0x5b0d1e(0xf1)](_0x5b0d1e(0x11c),_0x166553),_0x3b6ce8['find'](_0x5b0d1e(0xde))[_0x5b0d1e(0xe5)](_0x53ed84);const _0x554bb3=_0x3b6ce8[_0x5b0d1e(0xf0)](_0x5b0d1e(0x1e4)),_0x2882cb=_0x3b6ce8[_0x5b0d1e(0xf0)]('#amily2_model_autofetch_wrapper'),_0x4d415f=_0x3b6ce8[_0x5b0d1e(0xf0)](_0x5b0d1e(0xde));_0x166553?(_0x554bb3[_0x5b0d1e(0x15b)](),_0x2882cb[_0x5b0d1e(0x12b)](),_0x4d415f['hide']()):(_0x554bb3[_0x5b0d1e(0x12b)](),_0x2882cb[_0x5b0d1e(0x12b)](),_0x4d415f[_0x5b0d1e(0x15b)]());}if(!_0x3b6ce8['length']||_0x3b6ce8['data'](_0x2ffa96(0x216)))return;const _0x39323e=_0x5ec079=>_0x5ec079[_0x2ffa96(0x13c)](/_([a-z])/g,_0x438349=>_0x438349[0x1][_0x2ffa96(0x1dd)]()),_0x4da595=(_0x38e5a1,_0x704691)=>{const _0x19e341=_0x2ffa96;console[_0x19e341(0x106)](_0x19e341(0x183)+_0x38e5a1+']\x20设置为\x20->',_0x704691),!extension_settings[extensionName]&&(extension_settings[extensionName]={}),extension_settings[extensionName]={...extension_settings[extensionName],[_0x38e5a1]:_0x704691},saveSettingsDebounced(),console['log']('[Amily-谕令镌刻]\x20['+_0x38e5a1+_0x19e341(0x202));};_0x3b6ce8[_0x2ffa96(0xe2)]('change.amily2.force_proxy')['on'](_0x2ffa96(0x11e),_0x2ffa96(0x1f5),function(){const _0x4ac733=_0x2ffa96;if(!pluginAuthStatus['authorized'])return;_0x4da595(_0x4ac733(0x213),this[_0x4ac733(0x11c)]),_0x222d6f(),$(_0x4ac733(0x228))[_0x4ac733(0xc4)](_0x4ac733(0x10c));}),_0x3b6ce8['off'](_0x2ffa96(0x1cd))['on']('change.amily2.manual_model','#amily2_manual_model_input',function(){const _0x185f51=_0x2ffa96;if(!pluginAuthStatus[_0x185f51(0xac)])return;_0x4da595(_0x185f51(0x1c3),this[_0x185f51(0x140)]),toastr[_0x185f51(0x1e9)](_0x185f51(0x219)+this[_0x185f51(0x140)]+_0x185f51(0x1fe),_0x185f51(0x157));}),_0x3b6ce8['off'](_0x2ffa96(0x10d))['on'](_0x2ffa96(0x10d),_0x2ffa96(0xb4),async function(){const _0x122d14=_0x2ffa96,_0x2fee48=$('#amily2_auth_code')['val']()[_0x122d14(0x222)]();_0x2fee48?await activatePluginAuthorization(_0x2fee48):toastr[_0x122d14(0x179)](_0x122d14(0x1a5),_0x122d14(0x157));}),_0x3b6ce8[_0x2ffa96(0xe2)](_0x2ffa96(0x1c2))['on'](_0x2ffa96(0x1c2),_0x2ffa96(0x122),async function(){const _0x1e5903=_0x2ffa96;if(!pluginAuthStatus[_0x1e5903(0xac)])return;const _0xe8dfcd=$(this),_0x5d6aea=_0xe8dfcd[_0x1e5903(0x110)]();_0xe8dfcd[_0x1e5903(0xf1)](_0x1e5903(0x1f4),!![])[_0x1e5903(0x110)](_0x1e5903(0x9c));try{switch(this['id']){case _0x1e5903(0x173):const _0x280da8=await fetchModels();_0x280da8['length']>0x0&&(setAvailableModels(_0x280da8),localStorage[_0x1e5903(0x224)](_0x1e5903(0x20b),JSON[_0x1e5903(0x1d3)](_0x280da8)),populateModelDropdown());break;case'amily2_test':await testReplyChecker();break;case _0x1e5903(0x1b2):await fixCommand();break;}}catch(_0x33c7c2){console[_0x1e5903(0x19a)](_0x1e5903(0x16e)+this['id']+_0x1e5903(0x135),_0x33c7c2),toastr[_0x1e5903(0x19a)](_0x1e5903(0xec)+_0x33c7c2[_0x1e5903(0x112)],_0x1e5903(0x157));}finally{_0xe8dfcd[_0x1e5903(0xf1)](_0x1e5903(0x1f4),![])[_0x1e5903(0x110)](_0x5d6aea);}}),_0x3b6ce8['off'](_0x2ffa96(0x210))['on'](_0x2ffa96(0x210),_0x2ffa96(0x1c4),function(_0x15b67e){const _0x265fcf=_0x2ffa96;if(!pluginAuthStatus[_0x265fcf(0xac)])return;_0x15b67e[_0x265fcf(0x223)]();const _0x9defb6=$(_0x265fcf(0x1db))['val'](),_0x2cd661=$(_0x265fcf(0xfd))['val'](),_0x47960f='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<dialog\x20class=\x22popup\x20wide_dialogue_popup\x20large_dialogue_popup\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22popup-body\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h4\x20style=\x22margin-top:0;\x20color:\x20#eee;\x20border-bottom:\x201px\x20solid\x20rgba(255,255,255,0.2);\x20padding-bottom:\x2010px;\x22>正在编辑:\x20'+_0x9defb6+_0x265fcf(0x176),_0x34915c=$(_0x47960f)[_0x265fcf(0x1a4)](_0x265fcf(0x1d0)),_0x222f51=_0x34915c[_0x265fcf(0xf0)]('#amily2_dialog_editor');_0x222f51[_0x265fcf(0xe5)](_0x2cd661);const _0x36126c=()=>{const _0x5181ce=_0x265fcf;_0x34915c[0x0]['close'](),_0x34915c[_0x5181ce(0x14b)]();};_0x34915c[_0x265fcf(0xf0)](_0x265fcf(0x11b))['on'](_0x265fcf(0x10c),()=>{const _0x61160b=_0x265fcf,_0x243bf0=_0x222f51['val']();$(_0x61160b(0xfd))['val'](_0x243bf0),_0x4da595(_0x9defb6,_0x243bf0),toastr[_0x61160b(0x1e9)]('谕令\x20['+_0x9defb6+_0x61160b(0x236),_0x61160b(0x157)),_0x36126c();}),_0x34915c[_0x265fcf(0xf0)](_0x265fcf(0xa3))['on'](_0x265fcf(0x10c),_0x36126c),_0x34915c[0x0][_0x265fcf(0xda)]();}),_0x3b6ce8[_0x2ffa96(0xe2)]('click.amily2.tutorial')['on'](_0x2ffa96(0x99),_0x2ffa96(0xa5),function(){const _0x3e1572=_0x2ffa96;if(!pluginAuthStatus[_0x3e1572(0xac)])return;const _0x2e23e2={'amily2_open_tutorial':{'title':'主殿使用教程','url':_0x3e1572(0x189)},'amily2_open_neige_tutorial':{'title':_0x3e1572(0x162),'url':_0x3e1572(0x19e)}},_0x5e4758=_0x2e23e2[this['id']];_0x5e4758&&showContentModal(_0x5e4758['title'],_0x5e4758[_0x3e1572(0x22c)]);}),_0x3b6ce8[_0x2ffa96(0xe2)](_0x2ffa96(0x100))['on']('click.amily2.update',_0x2ffa96(0x1c1),function(){const _0x1098c0=_0x2ffa96;$(_0x1098c0(0x17d))[_0x1098c0(0x15b)]();const _0x3ac9b3=getLatestUpdateInfo();if(_0x3ac9b3&&_0x3ac9b3[_0x1098c0(0xaa)]){const _0x10f97e=messageFormatting(_0x3ac9b3[_0x1098c0(0xaa)]),_0x5c1101=_0x1098c0(0x195)+_0x10f97e+_0x1098c0(0x11d),_0x3715dd=$(_0x5c1101)[_0x1098c0(0x1a4)](_0x1098c0(0x1d0)),_0x138610=()=>{const _0x7cdd9=_0x1098c0;_0x3715dd[0x0][_0x7cdd9(0x12c)](),_0x3715dd[_0x7cdd9(0x14b)]();};_0x3715dd['find']('.popup-button-ok')['on'](_0x1098c0(0x10c),_0x138610),_0x3715dd[0x0][_0x1098c0(0xda)]();}else toastr[_0x1098c0(0xad)](_0x1098c0(0xe8),_0x1098c0(0xea));}),_0x3b6ce8[_0x2ffa96(0xe2)]('click.amily2.update_new')['on'](_0x2ffa96(0x1fd),_0x2ffa96(0x167),function(){const _0x195e6f=_0x2ffa96;$(_0x195e6f(0x132))[_0x195e6f(0xca)]()[_0x195e6f(0x10c)]();}),_0x3b6ce8['off'](_0x2ffa96(0x19d))['on'](_0x2ffa96(0x19d),'#amily2_unhide_all_button,\x20#amily2_manual_hide_confirm,\x20#amily2_manual_unhide_confirm',async function(){const _0x22cd6d=_0x2ffa96;if(!pluginAuthStatus[_0x22cd6d(0xac)])return;const _0xdfbc56=this['id'];let _0x40df21='',_0x49211f={};switch(_0xdfbc56){case'amily2_unhide_all_button':_0x40df21=_0x22cd6d(0x1f2);break;case'amily2_manual_hide_confirm':_0x40df21=_0x22cd6d(0x130),_0x49211f={'from':$(_0x22cd6d(0x1e3))[_0x22cd6d(0xe5)](),'to':$(_0x22cd6d(0x20d))[_0x22cd6d(0xe5)]()};break;case _0x22cd6d(0x13d):_0x40df21=_0x22cd6d(0x1e2),_0x49211f={'from':$(_0x22cd6d(0x164))[_0x22cd6d(0xe5)](),'to':$(_0x22cd6d(0x1e8))['val']()};break;}_0x40df21&&await executeManualCommand(_0x40df21,_0x49211f);}),_0x3b6ce8[_0x2ffa96(0xe2)](_0x2ffa96(0x123))['on'](_0x2ffa96(0x123),_0x2ffa96(0x1c0),function(){const _0x5888a6=_0x2ffa96;if(!pluginAuthStatus[_0x5888a6(0xac)])return;const _0x210469=_0x3b6ce8[_0x5888a6(0xf0)](_0x5888a6(0x13b)),_0x183446=_0x3b6ce8['find'](_0x5888a6(0xf4)),_0x55ff01=_0x3b6ce8[_0x5888a6(0xf0)]('#amily2_hanlinyuan_panel'),_0x23fa7f=_0x3b6ce8[_0x5888a6(0xf0)]('#amily2_memorisation_forms_panel'),_0x39605c=_0x3b6ce8[_0x5888a6(0xf0)](_0x5888a6(0x125));_0x210469[_0x5888a6(0x15b)](),_0x183446['hide'](),_0x55ff01['hide'](),_0x23fa7f[_0x5888a6(0x15b)](),_0x39605c[_0x5888a6(0x15b)]();switch(this['id']){case _0x5888a6(0xe7):_0x39605c[_0x5888a6(0x12b)]();break;case'amily2_open_additional_features':_0x183446['show']();break;case'amily2_open_rag_palace':_0x55ff01[_0x5888a6(0x12b)]();break;case'amily2_open_memorisation_forms':_0x23fa7f[_0x5888a6(0x12b)]();break;case _0x5888a6(0x18b):case'amily2_back_to_main_from_hanlinyuan':case _0x5888a6(0x209):case _0x5888a6(0x237):_0x210469[_0x5888a6(0x12b)]();break;}}),_0x3b6ce8['off']('change.amily2.checkbox')['on'](_0x2ffa96(0xcc),_0x2ffa96(0x18f),function(_0x11b6c2){const _0xf7a094=_0x2ffa96;if(!pluginAuthStatus[_0xf7a094(0xac)])return;const _0x2b4fad=this['id'],_0x5045c7=$(this),_0x36e602=_0x39323e(_0x2b4fad[_0xf7a094(0x13c)](_0xf7a094(0xa0),''));_0x4da595(_0x36e602,_0x5045c7[_0xf7a094(0xf1)](_0xf7a094(0x11c)));if(_0x2b4fad===_0xf7a094(0x9b)&&_0x5045c7[_0xf7a094(0xf1)](_0xf7a094(0x11c))){const _0x4e09b5=extension_settings[extensionName],_0x500651=_0x4e09b5['optimizationExclusionRules']||[],_0x2268fd=(_0x3004ae={'start':'','end':''},_0xb21b17)=>_0xf7a094(0x12f)+_0xb21b17+_0xf7a094(0x17b)+_0x3004ae[_0xf7a094(0x10a)]+_0xf7a094(0x20c)+_0x3004ae[_0xf7a094(0x118)]+_0xf7a094(0x17f),_0x1e97b1=_0x500651['map'](_0x2268fd)[_0xf7a094(0x15c)](''),_0x3b1979=_0xf7a094(0xd1)+_0x1e97b1+'</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20style=\x22text-align:\x20center;\x20margin-top:\x2010px;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20id=\x22optimization-add-rule-btn\x22\x20class=\x22menu_button\x20amily2-add-rule-btn\x22><i\x20class=\x22fas\x20fa-plus\x22></i>\x20添加新规则</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>';showHtmlModal(_0xf7a094(0xfa),_0x3b1979,{'okText':'确认','cancelText':'取消','onOk':_0x5567d6=>{const _0x3ef1ad=_0xf7a094,_0x131744=[];_0x5567d6['find']('.opt-exclusion-rule-row')['each'](function(){const _0x359b6a=_0xca22,_0x327450=$(this)[_0x359b6a(0xf0)]('input')['eq'](0x0)['val']()['trim'](),_0x451844=$(this)[_0x359b6a(0xf0)]('input')['eq'](0x1)[_0x359b6a(0xe5)]()[_0x359b6a(0x222)]();if(_0x327450&&_0x451844)_0x131744['push']({'start':_0x327450,'end':_0x451844});}),_0x4da595(_0x3ef1ad(0x21a),_0x131744),toastr[_0x3ef1ad(0x1e9)](_0x3ef1ad(0xe6),_0x3ef1ad(0x157));},'onCancel':()=>{}});const _0x526d78=$(_0xf7a094(0xc5)),_0x291477=_0x526d78[_0xf7a094(0xf0)](_0xf7a094(0x129));_0x526d78[_0xf7a094(0xf0)](_0xf7a094(0x175))['on']('click',()=>{const _0x1e6f5b=_0xf7a094,_0x2c936e=_0x291477['children']()[_0x1e6f5b(0x12a)];_0x291477['append'](_0x2268fd(undefined,_0x2c936e));}),_0x291477['on'](_0xf7a094(0x10c),_0xf7a094(0x218),function(){const _0x25e1d1=_0xf7a094;$(this)[_0x25e1d1(0xc6)](_0x25e1d1(0x186))[_0x25e1d1(0x14b)]();});}}),_0x3b6ce8[_0x2ffa96(0xe2)](_0x2ffa96(0x217))['on'](_0x2ffa96(0x217),_0x2ffa96(0x111),function(){const _0x5059e9=_0x2ffa96;if(!pluginAuthStatus['authorized'])return;const _0x5efec9=_0x39323e(this['name'][_0x5059e9(0x13c)](_0x5059e9(0xa0),'')),_0x1cc1fd=$(_0x5059e9(0xdc)+this['name']+_0x5059e9(0x22e))[_0x5059e9(0xe5)]();_0x4da595(_0x5efec9,_0x1cc1fd);}),_0x3b6ce8['off'](_0x2ffa96(0xf2))['on']('change.amily2.api_provider',_0x2ffa96(0x144),function(){const _0x31c2b1=_0x2ffa96;if(!pluginAuthStatus[_0x31c2b1(0xac)])return;const _0x516fd8=$(this)[_0x31c2b1(0xe5)]();console['log'](_0x31c2b1(0xe1)+_0x516fd8),_0x4da595(_0x31c2b1(0x172),_0x516fd8);const _0x3002fe=$('#amily2_api_url_wrapper'),_0x4ec9c9=$(_0x31c2b1(0x1e4)),_0xea7743=$(_0x31c2b1(0xed));_0x3002fe[_0x31c2b1(0x15b)](),_0x4ec9c9[_0x31c2b1(0x15b)](),_0xea7743[_0x31c2b1(0x15b)]();const _0x5d2b04=$('#amily2_model_selector');switch(_0x516fd8){case _0x31c2b1(0xb7):_0x3002fe[_0x31c2b1(0x12b)](),_0x4ec9c9['show'](),_0x5d2b04[_0x31c2b1(0x12b)](),$(_0x31c2b1(0x15a))['attr'](_0x31c2b1(0xf8),_0x31c2b1(0x231))['attr']('type',_0x31c2b1(0x160)),$(_0x31c2b1(0x121))[_0x31c2b1(0x1c7)]('placeholder',_0x31c2b1(0xa6));break;case'google':_0x3002fe[_0x31c2b1(0x15b)](),_0x4ec9c9[_0x31c2b1(0x12b)](),_0x5d2b04[_0x31c2b1(0x12b)](),$('#amily2_api_key')[_0x31c2b1(0x1c7)]('placeholder',_0x31c2b1(0xa2));break;case _0x31c2b1(0x107):_0x3002fe[_0x31c2b1(0x12b)](),_0x5d2b04['show'](),$('#amily2_api_url')[_0x31c2b1(0x1c7)](_0x31c2b1(0xf8),'http://localhost:5000/v1')[_0x31c2b1(0x1c7)](_0x31c2b1(0x205),_0x31c2b1(0x160));break;case'sillytavern_preset':_0xea7743[_0x31c2b1(0x12b)](),_0x5d2b04[_0x31c2b1(0x15b)](),loadSillyTavernPresets();break;}$(_0x31c2b1(0x1a9))[_0x31c2b1(0x161)]()['append'](_0x31c2b1(0x1ad));}),_0x3b6ce8[_0x2ffa96(0xe2)](_0x2ffa96(0xc8))['on'](_0x2ffa96(0xc8),_0x2ffa96(0x1e7),function(){const _0x3464f4=_0x2ffa96;if(!pluginAuthStatus['authorized'])return;const _0x28e774=_0x39323e(this['id'][_0x3464f4(0x13c)](_0x3464f4(0xa0),''));_0x4da595(_0x28e774,this[_0x3464f4(0x140)]),toastr[_0x3464f4(0x1e9)]('配置\x20['+_0x28e774+_0x3464f4(0x1fe),_0x3464f4(0x157));}),_0x3b6ce8[_0x2ffa96(0xe2)](_0x2ffa96(0x1b6))['on'](_0x2ffa96(0x1b6),'select#amily2_model,\x20select#amily2_preset_selector',function(){const _0x53eb00=_0x2ffa96;if(!pluginAuthStatus['authorized'])return;const _0x3fe7de=_0x39323e(this['id'][_0x53eb00(0x13c)](_0x53eb00(0xa0),''));let _0x220562=this[_0x53eb00(0x140)];this['id']===_0x53eb00(0xd6)?_0x4da595(_0x53eb00(0x177),_0x220562):_0x4da595(_0x3fe7de,_0x220562),this['id']===_0x53eb00(0x127)&&populateModelDropdown();}),_0x3b6ce8[_0x2ffa96(0xe2)](_0x2ffa96(0x230))['on']('input.amily2.range','input[type=\x22range\x22][id^=\x22amily2_\x22]',function(){const _0x2a86b3=_0x2ffa96;if(!pluginAuthStatus[_0x2a86b3(0xac)])return;const _0x2d288a=_0x39323e(this['id'][_0x2a86b3(0x13c)](_0x2a86b3(0xa0),'')),_0x385178=this['id'][_0x2a86b3(0x11f)]('temperature')?parseFloat(this[_0x2a86b3(0x140)]):parseInt(this[_0x2a86b3(0x140)],0xa);$('#'+this['id']+_0x2a86b3(0x145))[_0x2a86b3(0x160)](_0x385178),_0x4da595(_0x2d288a,_0x385178);});const _0x100314={'mainPrompt':_0x2ffa96(0x190),'systemPrompt':_0x2ffa96(0x1f3),'outputFormatPrompt':_0x2ffa96(0xf9)},_0x432ea7=_0x2ffa96(0x1db),_0x29041a='#amily2_unified_editor',_0x55a14d=_0x2ffa96(0x17c);function _0x335add(){const _0x397bc8=_0x2ffa96;if(!$(_0x432ea7)[_0x397bc8(0x12a)])return;const _0xbe37da=$(_0x432ea7)[_0x397bc8(0xe5)]();if(!_0xbe37da)return;const _0x4bff23=extension_settings[extensionName][_0xbe37da]||'';$(_0x29041a)[_0x397bc8(0xe5)](_0x4bff23);}_0x3b6ce8['off']('change.amily2.prompt_selector')['on']('change.amily2.prompt_selector',_0x432ea7,_0x335add),_0x3b6ce8['off'](_0x2ffa96(0x1da))['on'](_0x2ffa96(0x1da),_0x55a14d,function(){const _0xf70587=_0x2ffa96,_0xb504b6=$(_0x432ea7)['val']();if(!_0xb504b6)return;const _0x4c02e6=$(_0x29041a)[_0xf70587(0xe5)]();_0x4da595(_0xb504b6,_0x4c02e6),toastr[_0xf70587(0x1e9)](_0xf70587(0x1d9)+_0xb504b6+']\x20已镌刻!',_0xf70587(0x157));}),_0x3b6ce8['off'](_0x2ffa96(0x168))['on'](_0x2ffa96(0x168),_0x2ffa96(0xc1),function(){const _0x21af0c=_0x2ffa96,_0xf06316=$(_0x432ea7)[_0x21af0c(0xe5)]();if(!_0xf06316)return;const _0x2318dd=defaultSettings[_0xf06316];$(_0x29041a)[_0x21af0c(0xe5)](_0x2318dd),_0x4da595(_0xf06316,_0x2318dd),toastr[_0x21af0c(0x1e9)](_0x21af0c(0x1d9)+_0xf06316+']\x20已成功恢复为帝国初始蓝图。','Amily2号');}),_0x3b6ce8[_0x2ffa96(0xe2)]('change.amily2.lore_settings')['on'](_0x2ffa96(0x1c5),_0x2ffa96(0x181),function(){const _0x35a5b6=_0x2ffa96;if(!pluginAuthStatus[_0x35a5b6(0xac)])return;let _0x362f4b=_0x39323e(this['id']['replace'](_0x35a5b6(0xa0),''));_0x362f4b===_0x35a5b6(0x1ff)&&(_0x362f4b=_0x35a5b6(0x131));const _0x14b0fc=this['type']===_0x35a5b6(0x148)?parseInt(this[_0x35a5b6(0x140)],0xa):this[_0x35a5b6(0x140)];_0x4da595(_0x362f4b,_0x14b0fc);if(this['id']==='amily2_lore_insertion_position'){const _0x5a30de=$(_0x35a5b6(0xcb));this[_0x35a5b6(0x140)]===_0x35a5b6(0xeb)?_0x5a30de[_0x35a5b6(0x1f6)](0xc8):_0x5a30de['slideUp'](0xc8);}}),_0x3b6ce8[_0x2ffa96(0xe2)](_0x2ffa96(0x1ee))['on'](_0x2ffa96(0x1ee),'#amily2_save_lore_settings',function(){const _0x48b012=_0x2ffa96;if(!pluginAuthStatus[_0x48b012(0xac)])return;const _0x3f8fc8=$(this),_0x3470aa=$('#amily2_lore_save_status');_0x3f8fc8['prop']('disabled',!![])[_0x48b012(0x110)]('<i\x20class=\x22fas\x20fa-check\x22></i>\x20已确认'),_0x3470aa[_0x48b012(0x160)]('圣意已在您每次更改时自动镌刻。')[_0x48b012(0x1e6)]()[_0x48b012(0x153)](),setTimeout(()=>{const _0x36064f=_0x48b012;_0x3f8fc8['prop'](_0x36064f(0x1f4),![])[_0x36064f(0x110)](_0x36064f(0x1d4)),_0x3470aa[_0x36064f(0x221)]();},0x9c4);}),setTimeout(_0x335add,0x64),_0x222d6f(),_0x3b6ce8[_0x2ffa96(0x16c)]('events-bound',!![]);}export function opt_saveAllSettings(){const _0x1e41fe=_0xca22,_0x5a19ae=$(_0x1e41fe(0x125));if(_0x5a19ae[_0x1e41fe(0x12a)]===0x0)return;console[_0x1e41fe(0x106)]('['+extensionName+_0x1e41fe(0x171)),_0x5a19ae[_0x1e41fe(0xf0)]('input[type=\x22checkbox\x22],\x20input[type=\x22radio\x22],\x20input[type=\x22text\x22],\x20input[type=\x22password\x22],\x20textarea,\x20select')[_0x1e41fe(0xc4)](_0x1e41fe(0xbd)),_0x5a19ae[_0x1e41fe(0xf0)](_0x1e41fe(0x1d5))[_0x1e41fe(0xc4)]('change.amily2_opt'),opt_saveEnabledEntries(),toastr[_0x1e41fe(0xad)](_0x1e41fe(0x169));}function opt_toCamelCase(_0x6cf985){const _0x23f985=_0xca22;return _0x6cf985['replace'](/[-_]([a-z])/g,_0x5b0b51=>_0x5b0b51[0x1][_0x23f985(0x1dd)]());}function opt_updateApiUrlVisibility(_0x18ddd9,_0x571ef3){const _0x2bd325=_0xca22,_0x3fcb67=_0x18ddd9['find'](_0x2bd325(0x1d6)),_0xdb0408=_0x18ddd9[_0x2bd325(0xf0)](_0x2bd325(0x156)),_0x49b696=_0x18ddd9[_0x2bd325(0xf0)](_0x2bd325(0x1bb));_0x3fcb67['hide'](),_0xdb0408[_0x2bd325(0x15b)]();if(_0x571ef3===_0x2bd325(0x1dc))_0xdb0408[_0x2bd325(0x12b)]();else{_0x3fcb67[_0x2bd325(0x12b)]();if(_0x571ef3===_0x2bd325(0x138)){_0x18ddd9[_0x2bd325(0xf0)](_0x2bd325(0x14f))[_0x2bd325(0x15b)]();const _0x51daed=_0x2bd325(0x152);_0x49b696['val']()!==_0x51daed&&_0x49b696['val'](_0x51daed)[_0x2bd325(0x1c7)](_0x2bd325(0x205),_0x2bd325(0x160))['trigger'](_0x2bd325(0xba));}else _0x18ddd9['find']('#amily2_opt_api_url_block')['show']();}}function opt_updateWorldbookSourceVisibility(_0x417182,_0x3db078){const _0x29141f=_0xca22,_0x5bba35=_0x417182[_0x29141f(0xf0)](_0x29141f(0x104));if(_0x3db078===_0x29141f(0x1a6)){_0x5bba35[_0x29141f(0x12b)]();const _0x11927f=_0x5bba35[_0x29141f(0xf0)](_0x29141f(0x101));_0x11927f['css']({'height':_0x29141f(0x214),'background-color':_0x29141f(0x1b5),'appearance':_0x29141f(0x150),'-webkit-appearance':_0x29141f(0x150)});}else _0x5bba35['hide']();}async function opt_loadTavernApiProfiles(_0x7714b1){const _0x492ca8=_0xca22,_0x1ac7bf=_0x7714b1['find'](_0x492ca8(0x220)),_0x171e2c=opt_getMergedSettings(),_0x27591a=_0x171e2c[_0x492ca8(0xb5)],_0x11cdf2=_0x1ac7bf['val']();_0x1ac7bf['empty']()['append'](new Option(_0x492ca8(0x204),''));try{const _0x346a3a=getContext()[_0x492ca8(0x185)]?.[_0x492ca8(0x16f)]?.['profiles']||[];if(!_0x346a3a||_0x346a3a[_0x492ca8(0x12a)]===0x0){_0x1ac7bf[_0x492ca8(0x1be)]($(_0x492ca8(0x1cc),{'value':'','text':_0x492ca8(0x1e0),'disabled':!![]}));return;}let _0x2750a5=![];_0x346a3a[_0x492ca8(0x16d)](_0x413142=>{const _0x2088c9=_0x492ca8;if(_0x413142['api']&&_0x413142['preset']){const _0x2e0087=$('<option>',{'value':_0x413142['id'],'text':_0x413142[_0x2088c9(0x180)]||_0x413142['id'],'selected':_0x413142['id']===_0x27591a});_0x1ac7bf[_0x2088c9(0x1be)](_0x2e0087),_0x413142['id']===_0x27591a&&(_0x2750a5=!![]);}});if(_0x27591a&&!_0x2750a5)toastr[_0x492ca8(0x179)]('之前选择的酒馆预设\x20\x22'+_0x27591a+_0x492ca8(0xdd)),opt_saveSetting(_0x492ca8(0x177),'');else _0x2750a5&&_0x1ac7bf[_0x492ca8(0xe5)](_0x27591a);}catch(_0x39a259){console[_0x492ca8(0x19a)]('['+extensionName+_0x492ca8(0x126),_0x39a259),toastr['error'](_0x492ca8(0x139));}}const opt_characterSpecificSettings=[_0x34ba23(0xb1),_0x34ba23(0x1ce),_0x34ba23(0x134)];async function opt_saveSetting(_0x5ac09d,_0x35c90f){const _0x4d7510=_0x34ba23;if(opt_characterSpecificSettings[_0x4d7510(0x11f)](_0x5ac09d)){const _0x2dd756=characters[this_chid];if(!_0x2dd756)return;if(!_0x2dd756[_0x4d7510(0x16c)]['extensions'])_0x2dd756['data'][_0x4d7510(0x9d)]={};if(!_0x2dd756[_0x4d7510(0x16c)][_0x4d7510(0x9d)][extensionName])_0x2dd756[_0x4d7510(0x16c)]['extensions'][extensionName]={};_0x2dd756[_0x4d7510(0x16c)][_0x4d7510(0x9d)][extensionName][_0x5ac09d]=_0x35c90f;try{const _0x169ec4=await fetch(_0x4d7510(0x17e),{'method':_0x4d7510(0xdb),'headers':getRequestHeaders(),'body':JSON[_0x4d7510(0x1d3)]({'avatar':_0x2dd756[_0x4d7510(0x96)],'data':{'extensions':{[extensionName]:_0x2dd756[_0x4d7510(0x16c)][_0x4d7510(0x9d)][extensionName]}}})});if(!_0x169ec4['ok'])throw new Error('API\x20call\x20failed\x20with\x20status:\x20'+_0x169ec4['status']);console[_0x4d7510(0x106)]('['+extensionName+_0x4d7510(0x1df)+_0x5ac09d+_0x4d7510(0x184),_0x35c90f);}catch(_0x2d61b7){console[_0x4d7510(0x19a)]('['+extensionName+_0x4d7510(0xa7),_0x2d61b7),toastr[_0x4d7510(0x19a)](_0x4d7510(0x116));}}else!extension_settings[extensionName]&&(extension_settings[extensionName]={}),extension_settings[extensionName][_0x5ac09d]=_0x35c90f,saveSettingsDebounced();}function opt_getMergedSettings(){const _0x3f914a=_0x34ba23,_0x2b54a3=characters[this_chid],_0x258b5e=extension_settings[extensionName]||defaultSettings,_0xf48178=_0x2b54a3?.[_0x3f914a(0x16c)]?.[_0x3f914a(0x9d)]?.[extensionName]||{};return{..._0x258b5e,..._0xf48178};}function opt_bindSlider(_0xb39879,_0x3cce70,_0xac26ff){const _0x5a0e6e=_0x34ba23,_0x391531=_0xb39879[_0x5a0e6e(0xf0)](_0x3cce70),_0x109859=_0xb39879[_0x5a0e6e(0xf0)](_0xac26ff);_0x109859['text'](_0x391531[_0x5a0e6e(0xe5)]()),_0x391531['on'](_0x5a0e6e(0x207),function(){const _0x497c46=_0x5a0e6e;_0x109859[_0x497c46(0x160)]($(this)[_0x497c46(0xe5)]());});}async function opt_loadWorldbooks(_0x133db3){const _0x1fe791=_0x34ba23,_0x272ed4=_0x133db3[_0x1fe791(0xf0)](_0x1fe791(0x1b4)),_0x5e1763=opt_getMergedSettings(),_0x29968a=_0x5e1763[_0x1fe791(0x1ce)]||[];_0x272ed4[_0x1fe791(0x161)]();try{const _0x169cbf=await window[_0x1fe791(0x192)]['getLorebooks']();if(!_0x169cbf||_0x169cbf[_0x1fe791(0x12a)]===0x0){_0x272ed4['html'](_0x1fe791(0x12e));return;}_0x169cbf[_0x1fe791(0x16d)](_0x3daed3=>{const _0x4520b8=_0x1fe791,_0x419320=_0x4520b8(0x1c9)+_0x3daed3['replace'](/[^a-zA-Z0-9]/g,'-'),_0x392b00=_0x29968a[_0x4520b8(0x11f)](_0x3daed3),_0x566d93=$('\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22amily2_opt_worldbook_entry_item\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20id=\x22'+_0x419320+'\x22\x20value=\x22'+_0x3daed3+'\x22\x20'+(_0x392b00?_0x4520b8(0x11c):'')+_0x4520b8(0xd8)+_0x419320+'\x22>'+_0x3daed3+'</label>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20');_0x272ed4[_0x4520b8(0x1be)](_0x566d93);});}catch(_0x374db4){console['error']('['+extensionName+']\x20加载世界书失败:',_0x374db4),_0x272ed4['html'](_0x1fe791(0x212)),toastr[_0x1fe791(0x19a)](_0x1fe791(0x103));}}async function opt_loadWorldbookEntries(_0x1c10c3){const _0x30420c=_0x34ba23,_0x4dd403=_0x1c10c3[_0x30420c(0xf0)]('#amily2_opt_worldbook_entry_list_container'),_0x107838=_0x1c10c3[_0x30420c(0xf0)](_0x30420c(0x191));_0x4dd403[_0x30420c(0x110)]('<p>加载条目中...</p>'),_0x107838[_0x30420c(0x160)]('');const _0x3cfb54=opt_getMergedSettings(),_0x29559d=_0x3cfb54[_0x30420c(0xb1)]||_0x30420c(0x174);let _0x43d8ac=[];if(_0x29559d===_0x30420c(0x1a6))_0x43d8ac=_0x3cfb54[_0x30420c(0x1ce)]||[];else{if(this_chid===-0x1||!characters[this_chid]){_0x4dd403[_0x30420c(0x110)](_0x30420c(0xab)),_0x107838[_0x30420c(0x160)]('');return;}try{const _0x2f488f=await window[_0x30420c(0x192)][_0x30420c(0x108)]({'type':_0x30420c(0x159)});if(_0x2f488f[_0x30420c(0x1d8)])_0x43d8ac[_0x30420c(0xf3)](_0x2f488f['primary']);if(_0x2f488f['additional']?.['length'])_0x43d8ac[_0x30420c(0xf3)](..._0x2f488f[_0x30420c(0x1a3)]);}catch(_0x584425){console['error']('['+extensionName+_0x30420c(0x21e),_0x584425),toastr[_0x30420c(0x19a)](_0x30420c(0x147)),_0x4dd403[_0x30420c(0x110)](_0x30420c(0x14e));return;}}const _0x3c5064=_0x43d8ac;let _0x4f8d05=_0x3cfb54[_0x30420c(0x134)]||{},_0x1e61e5=0x0,_0x3397b1=0x0;if(_0x3c5064[_0x30420c(0x12a)]===0x0){_0x4dd403[_0x30420c(0x110)](_0x30420c(0xb0));return;}try{const _0x1bba9f=[];for(const _0x1e1a75 of _0x3c5064){const _0xa78d3f=await window[_0x30420c(0x192)][_0x30420c(0xc9)](_0x1e1a75);_0xa78d3f['forEach'](_0x2c9dd8=>{const _0x52813f=_0x30420c;_0x1bba9f[_0x52813f(0xf3)]({..._0x2c9dd8,'bookName':_0x1e1a75});});}_0x4dd403[_0x30420c(0x161)](),_0x1e61e5=_0x1bba9f[_0x30420c(0x12a)];if(_0x1e61e5===0x0){_0x4dd403[_0x30420c(0x110)](_0x30420c(0x16b)),_0x107838['text']('0\x20条目.');return;}_0x1bba9f[_0x30420c(0x115)]((_0x121bc6,_0x53008f)=>(_0x121bc6[_0x30420c(0x18a)]||'')[_0x30420c(0x201)](_0x53008f[_0x30420c(0x18a)]||''))[_0x30420c(0x16d)](_0x3f5f3f=>{const _0x5bd85d=_0x30420c,_0x3a1908=_0x5bd85d(0xb3)+_0x3f5f3f['bookName'][_0x5bd85d(0x13c)](/[^a-zA-Z0-9]/g,'-')+'-'+_0x3f5f3f[_0x5bd85d(0x15f)],_0x5dc0dc=_0x4f8d05[_0x3f5f3f[_0x5bd85d(0x19b)]]?.[_0x5bd85d(0x11f)](_0x3f5f3f['uid'])??!![],_0x3690d5=$(_0x5bd85d(0x13e)+_0x3a1908+_0x5bd85d(0x19f)+_0x3f5f3f['bookName']+_0x5bd85d(0x1de)+_0x3f5f3f['uid']+'\x22\x20'+(_0x5dc0dc?'checked':'')+_0x5bd85d(0xd8)+_0x3a1908+_0x5bd85d(0xbb)+_0x3f5f3f[_0x5bd85d(0x19b)]+_0x5bd85d(0xa4)+_0x3f5f3f[_0x5bd85d(0x15f)]+'\x22>'+(_0x3f5f3f[_0x5bd85d(0x18a)]||_0x5bd85d(0x1f1))+_0x5bd85d(0x16a));_0x4dd403['append'](_0x3690d5);}),_0x3397b1=_0x4dd403[_0x30420c(0xae)]()['length'],_0x107838[_0x30420c(0x160)](_0x30420c(0x1af)+_0x3397b1+_0x30420c(0x22b)+_0x1e61e5+_0x30420c(0x1fb));}catch(_0x24432d){console['error']('['+extensionName+']\x20加载世界书条目失败:',_0x24432d),_0x4dd403[_0x30420c(0x110)](_0x30420c(0x109));}}function opt_saveEnabledEntries(){const _0x495671=_0x34ba23,_0x35792b=$('#amily2_plot_optimization_panel');let _0x34dd04={};_0x35792b[_0x495671(0xf0)]('#amily2_opt_worldbook_entry_list_container\x20input[type=\x22checkbox\x22]')[_0x495671(0xf6)](function(){const _0x675870=_0x495671,_0x32beae=$(this)[_0x675870(0x16c)](_0x675870(0x151)),_0x27455c=parseInt($(this)[_0x675870(0x16c)]('uid'));!_0x34dd04[_0x32beae]&&(_0x34dd04[_0x32beae]=[]),$(this)['is'](_0x675870(0x14d))&&_0x34dd04[_0x32beae]['push'](_0x27455c);});const _0x305a51=opt_getMergedSettings();if(_0x305a51['plotOpt_worldbookSource']===_0x495671(0x1a6)){const _0x29c002=_0x305a51[_0x495671(0x1ce)]||[];Object[_0x495671(0xc2)](_0x34dd04)[_0x495671(0x16d)](_0x2421ef=>{const _0x52cb2d=_0x495671;!_0x29c002[_0x52cb2d(0x11f)](_0x2421ef)&&delete _0x34dd04[_0x2421ef];});}opt_saveSetting(_0x495671(0x134),_0x34dd04);}function opt_loadPromptPresets(_0x35ae70){const _0x2006e0=_0x34ba23,_0x3585d7=extension_settings[extensionName]?.['promptPresets']||[],_0x92408c=_0x35ae70[_0x2006e0(0xf0)](_0x2006e0(0x10b)),_0xaa2d4e=_0x92408c[_0x2006e0(0xe5)]();_0x92408c[_0x2006e0(0x161)]()[_0x2006e0(0x1be)](new Option(_0x2006e0(0x141),'')),_0x3585d7[_0x2006e0(0x16d)](_0xbe587c=>{const _0x55dff0=_0x2006e0;_0x92408c['append'](new Option(_0xbe587c[_0x55dff0(0x180)],_0xbe587c[_0x55dff0(0x180)]));}),_0xaa2d4e&&_0x3585d7[_0x2006e0(0x15e)](_0x71ffa2=>_0x71ffa2['name']===_0xaa2d4e)&&_0x92408c['val'](_0xaa2d4e);}function _0x30b2(){const _0x15409c=['amily2_back_to_main_from_optimization','#amily2_drawer_content','#amily2_opt_context_limit','avatar','#amily2_opt_system_prompt','selectedPreset','click.amily2.tutorial','#amily2_opt_worldbook_char_limit','amily2_optimization_exclusion_enabled','<i\x20class=\x22fas\x20fa-spinner\x20fa-spin\x22></i>\x20处理中','extensions','input[name=\x22amily2_icon_location\x22]','plotOpt_mainPrompt','amily2_','#amily2_opt_worldbook_entry_list_container\x20input[type=\x22checkbox\x22]','Google\x20API\x20Key','.popup-button-cancel','\x0aUID:\x20','#amily2_open_tutorial,\x20#amily2_open_neige_tutorial','sk-...',']\x20保存角色数据失败:','plotOpt_model','getElementById','changelog','<p\x20class=\x22notes\x22>未选择角色。</p>','authorized','info','children','input[type=\x22radio\x22]','<p\x20class=\x22notes\x22>请选择一个或多个世界书以查看其条目。</p>','plotOpt_worldbookSource','#amily2_opt_model','amily2-opt-entry-','#auth_submit','plotOpt_tavernProfile','textContent','openai','input[type=\x22number\x22]','rateCuckold','change','\x22\x20title=\x22世界书:\x20','download','change.amily2_opt','授权码已复制到剪贴板！','rateErotic','warn','#amily2_unified_restore_button','keys','扩展区','trigger','#optimization-exclusion-rules-container','closest','加载预设失败','change.amily2.text','getLorebookEntries','first','#amily2_lore_depth_container','change.amily2.checkbox','amily2_daily_code_display','导入失败:\x20','isAutomatic','#amily2_opt_export_prompt_presets','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22optimization-exclusion-rules-container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22notes\x22>在这里定义需要从优化内容中排除的文本片段。例如，排除HTML注释，可以设置开始字符为\x20`<!--`，结束字符为\x20`-->`。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22optimization-rules-list\x22\x20style=\x22max-height:\x2045vh;\x20overflow-y:\x20auto;\x20padding:\x2010px;\x20border:\x201px\x20solid\x20rgba(255,255,255,0.1);\x20border-radius:\x205px;\x20margin-bottom:10px;\x22>','amily2_opt_worldbook_source','#amily2_opt_worldbook_entry_deselect_all','。圣意已存档。','preset','amily2_preset_selector','复制失败，请手动复制。','>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20for=\x22','mousedown.amily2Drawer','showModal','POST','input[name=\x22','\x22\x20已不存在，请重新选择。','#amily2_manual_model_input','.json','#amily2_opt_context_turn_count','[Amily2号-UI]\x20API提供商切换为:\x20','off','#amily2_main_drawer','input[name=\x22amily2_opt_worldbook_source\x22][value=\x22','val','排除规则已更新。','amily2_open_plot_optimization','未能获取到云端情报，请稍后再试。','3034010rolWyR','情报部回报','at_depth','操作失败:\x20','#amily2_preset_wrapper','成功导入\x20','range','find','prop','change.amily2.api_provider','push','#amily2_additional_features_panel','正在将帝国徽记迁往\x20[','each','#amily2_opt_context_turn_count_value','placeholder','#amily2_output_format_prompt','编辑内容排除规则','#amily2_opt_frequency_penalty_value','确定要删除预设\x20\x22','#amily2_unified_editor','createObjectURL','已加载预设\x20\x22','click.amily2.update','#amily2_opt_selected_worldbooks',']\x20剧情优化UI事件已成功绑定，自动保存已激活。','无法加载世界书列表，请查看控制台。','#amily2_opt_worldbook_select_wrapper','#amily2_opt_refresh_tavern_api_profiles','log','sillytavern_backend','getCharLorebooks','<p\x20class=\x22notes\x22\x20style=\x22color:red;\x22>加载条目失败。</p>','start','#amily2_opt_prompt_preset_select','click','click.amily2.auth','plotOpt_apiUrl','未找到可导入的有效预设。','html','input[type=\x22radio\x22][name^=\x22amily2_\x22]:not([name=\x22amily2_icon_location\x22])','message','amily2_copy_daily_code','7278228NaOnVZ','sort','无法保存角色卡设置，请检查控制台。','#amily2_opt_context_limit_value','end','#amily2_opt_max_tokens_value','#amily2_opt_presence_penalty','.popup-button-ok','checked','</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22popup-controls\x22><div\x20class=\x22popup-button-ok\x20menu_button\x20menu_button_primary\x20interactable\x22>朕已阅</div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</dialog>','change.amily2.force_proxy','includes','plotOpt_promptPresets','#amily2_api_key','#amily2_refresh_models,\x20#amily2_test,\x20#amily2_fix_now','click.amily2.chamber_nav','filter','#amily2_plot_optimization_panel',']\x20加载酒馆API预设失败:','amily2_model','promptPresets','#optimization-rules-list','length','show','close','#amily2_opt_rate_erotic','<p\x20class=\x22notes\x22>未找到世界书。</p>','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22opt-exclusion-rule-row\x22\x20data-index=\x22','manual_hide','loreDepth','span[data-i18n=\x22Manage\x20extensions\x22]','string','plotOpt_enabledWorldbookEntries','\x20执行失败:','plotOpt_rateMain','ratePersonal','google','无法加载酒馆API预设列表，请查看控制台。','parse','.plugin-features','replace','amily2_manual_unhide_confirm','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22amily2_opt_worldbook_entry_item\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20id=\x22',']...','value','--\x20选择一个预设\x20--','checkbox','4889178fZgJkz','#amily2_api_provider','_value','[Amily2号-UI]\x20加载酒馆API预设失败:','获取角色世界书失败。','number','plotOpt_rateCuckold','请先从下拉菜单中选择一个要导出的预设。','remove','click.amily2_opt',':checked','<p\x20class=\x22notes\x22\x20style=\x22color:red;\x22>获取角色世界书失败。</p>','#amily2_opt_api_url_block','none','book','https://generativelanguage.googleapis.com','fadeIn','JSON文件格式不正确，根节点必须是一个数组。','#amily2_opt_reset_main_prompt','#amily2_opt_tavern_api_profile_block','Amily2号','196icVQAs','all','#amily2_api_url','hide','join','<-请先获取模型','some','uid','text','empty','内阁使用教程','clipboard','#amily2_manual_unhide_from','\x22\x20已被删除。','plotOpt_lastUsedPresetName','#amily2_update_button_new','click.amily2.unified_restore','剧情优化设置已自动保存。','</label>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','<p\x20class=\x22notes\x22>所选世界书没有条目。</p>','data','forEach','[Amily2-工部]\x20操作按钮\x20','connectionManager','plotOpt_worldbookCharLimit',']\x20手动触发所有剧情优化设置的保存...','apiProvider','amily2_refresh_models','character','#optimization-add-rule-btn','</h4>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22popup-content\x22\x20style=\x22height:\x2070vh;\x22><div\x20class=\x22height100p\x20wide100p\x20flex-container\x22><textarea\x20id=\x22amily2_dialog_editor\x22\x20class=\x22height100p\x20wide100p\x20maximized_textarea\x20text_pole\x22></textarea></div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22popup-controls\x22><div\x20class=\x22popup-button-ok\x20menu_button\x20menu_button_primary\x20interactable\x22>保存并关闭</div><div\x20class=\x22popup-button-cancel\x20menu_button\x20interactable\x22\x20style=\x22margin-left:\x2010px;\x22>取消</div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</dialog>','tavernProfile','\x22\x20吗？','warning','readAsText','\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20class=\x22text_pole\x22\x20value=\x22','#amily2_unified_save_button','#amily2_update_indicator','/api/characters/merge-attributes','\x22\x20placeholder=\x22结束字符,\x20如\x20-->\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22delete-rule-btn\x20menu_button\x20danger_button\x22\x20title=\x22删除此规则\x22>&times;</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>','name','select[id^=\x22amily2_lore_\x22],\x20input#amily2_lore_depth_input','plotOpt_frequency_penalty','[Amily-谕令确认]\x20收到指令:\x20将\x20[','\x20->','extensionSettings','.opt-exclusion-rule-row','#amily2_opt_max_tokens','主提示词已重置为默认值。','scripts/extensions/third-party/ST-Amily2-Chat-Optimisation/ZhuDian.md','comment','amily2_back_to_main_settings',']\x20导入预设失败:','最终注入指令已重置为默认值。','8396440WdCMEI','input[type=\x22checkbox\x22][id^=\x22amily2_\x22]','#amily2_main_prompt','#amily2_opt_worldbook_entry_count','TavernHelper','amily2_opt_preset_','之前选择的酒馆预设\x20\x22','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<dialog\x20class=\x22popup\x20wide_dialogue_popup\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22popup-body\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h3\x20style=\x22margin-top:0;\x20color:\x20#eee;\x20border-bottom:\x201px\x20solid\x20rgba(255,255,255,0.2);\x20padding-bottom:\x2010px;\x22><i\x20class=\x22fas\x20fa-bell\x22\x20style=\x22color:\x20#ff9800;\x22></i>\x20帝国最新情报</h3>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22popup-content\x22\x20style=\x22height:\x2060vh;\x20overflow-y:\x20auto;\x20background:\x20rgba(0,0,0,0.2);\x20padding:\x2015px;\x20border-radius:\x205px;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22mes_text\x22>','CHAT_CHANGED','input[type=\x22password\x22]','input.amily2_opt\x20change.amily2_opt','splice','error','bookName','6187oxmtNa','click.amily2.manual_command','scripts/extensions/third-party/ST-Amily2-Chat-Optimisation/NeiGe.md','\x22\x20data-book=\x22','#amily2_opt_worldbook_char_limit_value','#amily2_opt_rate_personal','#amily2_opt_worldbook_checkbox_list\x20input[type=\x22checkbox\x22]','additional','appendTo','请输入授权码','manual','plotOpt_contextLimit','#amily2_opt_temperature_value','#amily2_model','保存操作已取消。','没有选择任何预设。','href','<option\x20value=\x22\x22>请刷新模型列表</option>','\x22\x20已保存。','显示\x20','finalSystemDirective','#amily2_opt_delete_prompt_preset','amily2_fix_now','\x20个有效预设','#amily2_opt_worldbook_checkbox_list','var(--bg1)','change.amily2.select','addEventListener','api','#amily2_opt_refresh_worldbooks','[Amily2号-UI]\x20正在加载SillyTavern预设列表','#amily2_opt_api_url','findIndex','找不到要删除的预设，操作可能已过期。','append','#amily2_opt_worldbook_checkbox_list\x20input:checked','#amily2_open_plot_optimization,\x20#amily2_open_additional_features,\x20#amily2_open_rag_palace,\x20#amily2_open_memorisation_forms,\x20#amily2_back_to_main_settings,\x20#amily2_back_to_main_from_hanlinyuan,\x20#amily2_back_to_main_from_forms,\x20#amily2_back_to_main_from_optimization','#amily2_update_button','click.amily2.actions','model','#amily2_expand_editor','change.amily2.lore_settings','target','attr','预设\x20\x22','amily2-opt-wb-check-','rateMain','plotOpt_top_p','<option>','change.amily2.manual_model','plotOpt_selectedWorldbooks','1462300tZFLCT','body','#amily2_preset_selector','iconLocation','stringify','<i\x20class=\x22fas\x20fa-save\x22></i>\x20确认敕令','input[type=\x22range\x22]','#amily2_opt_custom_api_settings_block','plotOpt_api_mode','primary','谕令\x20[','click.amily2.unified_save','#amily2_prompt_selector','tavern','toUpperCase','\x22\x20data-uid=\x22',']\x20角色卡设置已更新:\x20','未找到酒馆预设','91805WfMSPT','manual_unhide','#amily2_manual_hide_from','#amily2_api_key_wrapper','请输入预设名称：','stop','#amily2_api_url,\x20#amily2_api_key,\x20#amily2_optimization_target_tag','#amily2_manual_unhide_to','success','mainPrompt','plotOpt_finalSystemDirective','plotOpt_rateErotic','#amily2_opt_worldbook_enabled','click.amily2.lore_save','534PSdEiF','plotOpt_selected_worldbooks','无标题条目','unhide_all','#amily2_system_prompt','disabled','#amily2_force_proxy','slideDown','#amily2_opt_main_prompt','revokeObjectURL','#amily2_opt_model_select','appendChild','\x20条目.','plotOpt_presence_penalty','click.amily2.update_new',']\x20已自动保存!','loreDepthInput','拦截任务指令已重置为默认值。','localeCompare',']\x20的新状态已保存。','[Amily2号-UI]\x20SillyTavern预设列表加载完成，找到\x20','--\x20请选择一个酒馆预设\x20--','type','[Amily2号-UI]\x20未找到SillyTavern预设','input','#amily2_opt_frequency_penalty','amily2_back_to_main_from_forms','#amily2_opt_final_system_directive','cached_models_amily2','\x22\x20placeholder=\x22开始字符,\x20如\x20<!--\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span>到</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20class=\x22text_pole\x22\x20value=\x22','#amily2_manual_hide_to','#amily2_opt_preset_file_input','#amily2_opt_temperature','click.amily2.expand_editor','then','<p\x20class=\x22notes\x22\x20style=\x22color:red;\x22>加载世界书列表失败。</p>','forceProxyForCustomApi','auto','lastUsedPresetName','events-bound','change.amily2.radio','.delete-rule-btn','模型ID\x20[','optimizationExclusionRules','systemPrompt','#amily2_opt_rate_main','plotOpt_systemPrompt',']\x20获取角色世界书失败:','迁都令','#amily2_opt_tavern_api_profile_select','fadeOut','trim','stopPropagation','setItem','171iSmPch','plotOpt_apiKey','成功覆盖\x20','#amily2_refresh_models','#amily2_opt_rate_cuckold','名为\x20\x22','\x20/\x20','url','plotOpt_max_tokens','\x22]:checked','input[name=\x22amily2_opt_api_mode\x22][value=\x22','input.amily2.range','https://api.openai.com/v1','#amily2_opt_api_key','files','\x22\x20已成功导出。','\x20个同名预设。',']\x20已镌刻！'];_0x30b2=function(){return _0x15409c;};return _0x30b2();}function opt_saveCurrentPromptsAsPreset(_0x496988){const _0xb1caa0=_0x34ba23,_0x5b698a=prompt(_0xb1caa0(0x1e5));if(!_0x5b698a)return;const _0x15b9da=extension_settings[extensionName]?.[_0xb1caa0(0x128)]||[],_0x196546=_0x15b9da[_0xb1caa0(0x1bc)](_0x34bd1f=>_0x34bd1f[_0xb1caa0(0x180)]===_0x5b698a),_0x299fbd={'name':_0x5b698a,'mainPrompt':_0x496988[_0xb1caa0(0xf0)](_0xb1caa0(0x1f7))['val'](),'systemPrompt':_0x496988[_0xb1caa0(0xf0)](_0xb1caa0(0x97))[_0xb1caa0(0xe5)](),'finalSystemDirective':_0x496988[_0xb1caa0(0xf0)](_0xb1caa0(0x20a))['val'](),'rateMain':parseFloat(_0x496988[_0xb1caa0(0xf0)](_0xb1caa0(0x21c))[_0xb1caa0(0xe5)]()),'ratePersonal':parseFloat(_0x496988[_0xb1caa0(0xf0)](_0xb1caa0(0x1a1))[_0xb1caa0(0xe5)]()),'rateErotic':parseFloat(_0x496988[_0xb1caa0(0xf0)](_0xb1caa0(0x12d))[_0xb1caa0(0xe5)]()),'rateCuckold':parseFloat(_0x496988[_0xb1caa0(0xf0)]('#amily2_opt_rate_cuckold')[_0xb1caa0(0xe5)]())};if(_0x196546!==-0x1){if(confirm(_0xb1caa0(0x22a)+_0x5b698a+'\x22\x20的预设已存在。是否要覆盖它？'))_0x15b9da[_0x196546]=_0x299fbd,toastr[_0xb1caa0(0x1e9)](_0xb1caa0(0x1c8)+_0x5b698a+'\x22\x20已被覆盖。');else{toastr['info'](_0xb1caa0(0x1aa));return;}}else _0x15b9da[_0xb1caa0(0xf3)](_0x299fbd),toastr['success']('预设\x20\x22'+_0x5b698a+_0xb1caa0(0x1ae));opt_saveSetting('promptPresets',_0x15b9da),opt_loadPromptPresets(_0x496988),setTimeout(()=>{const _0xcff7a3=_0xb1caa0;_0x496988['find'](_0xcff7a3(0x10b))[_0xcff7a3(0xe5)](_0x5b698a)[_0xcff7a3(0xc4)]('change');},0x0);}function opt_deleteSelectedPreset(_0x10c9b2){const _0x2bcad1=_0x34ba23,_0x46d16e=_0x10c9b2[_0x2bcad1(0xf0)](_0x2bcad1(0x10b)),_0x57ef01=_0x46d16e['val']();if(!_0x57ef01){toastr[_0x2bcad1(0x179)](_0x2bcad1(0x1ab));return;}if(!confirm(_0x2bcad1(0xfc)+_0x57ef01+_0x2bcad1(0x178)))return;const _0x2cba9b=extension_settings[extensionName]?.[_0x2bcad1(0x128)]||[],_0x11168d=_0x2cba9b[_0x2bcad1(0x1bc)](_0x528a10=>_0x528a10[_0x2bcad1(0x180)]===_0x57ef01);_0x11168d>-0x1?(_0x2cba9b[_0x2bcad1(0x199)](_0x11168d,0x1),opt_saveSetting(_0x2bcad1(0x128),_0x2cba9b),toastr['success']('预设\x20\x22'+_0x57ef01+_0x2bcad1(0x165))):toastr[_0x2bcad1(0x19a)](_0x2bcad1(0x1bd)),opt_loadPromptPresets(_0x10c9b2),_0x46d16e[_0x2bcad1(0xc4)](_0x2bcad1(0xba));}function opt_exportPromptPresets(){const _0x56d4a4=_0x34ba23,_0x2b5053=$(_0x56d4a4(0x10b)),_0x5e8ca4=_0x2b5053[_0x56d4a4(0xe5)]();if(!_0x5e8ca4){toastr[_0x56d4a4(0xad)](_0x56d4a4(0x14a));return;}const _0x5ec007=extension_settings[extensionName]?.[_0x56d4a4(0x128)]||[],_0x1eb546=_0x5ec007[_0x56d4a4(0xf0)](_0x12ec75=>_0x12ec75[_0x56d4a4(0x180)]===_0x5e8ca4);if(!_0x1eb546){toastr[_0x56d4a4(0x19a)]('找不到选中的预设，请刷新页面后重试。');return;}const _0x350590=[_0x1eb546],_0x4b683d=JSON[_0x56d4a4(0x1d3)](_0x350590,null,0x2),_0x1f101e=new Blob([_0x4b683d],{'type':'application/json'}),_0x207b0d=URL[_0x56d4a4(0xfe)](_0x1f101e),_0x19e0c7=document['createElement']('a');_0x19e0c7[_0x56d4a4(0x1ac)]=_0x207b0d,_0x19e0c7[_0x56d4a4(0xbc)]=_0x56d4a4(0x193)+_0x5e8ca4['replace'](/[^a-z0-9]/gi,'_')+_0x56d4a4(0xdf),document[_0x56d4a4(0x1d0)][_0x56d4a4(0x1fa)](_0x19e0c7),_0x19e0c7[_0x56d4a4(0x10c)](),document[_0x56d4a4(0x1d0)]['removeChild'](_0x19e0c7),URL[_0x56d4a4(0x1f8)](_0x207b0d),toastr[_0x56d4a4(0x1e9)]('预设\x20\x22'+_0x5e8ca4+_0x56d4a4(0x234));}function opt_importPromptPresets(_0x277beb,_0x460992){const _0x1a98dc=_0x34ba23;if(!_0x277beb)return;const _0x50183d=new FileReader();_0x50183d['onload']=function(_0x17e806){const _0x2e0c62=_0xca22;try{const _0x3c2fe9=JSON[_0x2e0c62(0x13a)](_0x17e806[_0x2e0c62(0x1c6)]['result']);if(!Array['isArray'](_0x3c2fe9))throw new Error(_0x2e0c62(0x154));let _0x149369=extension_settings[extensionName]?.[_0x2e0c62(0x128)]||[],_0x4053f7=0x0,_0x568c7e=0x0;_0x3c2fe9[_0x2e0c62(0x16d)](_0x6a5a51=>{const _0x306151=_0x2e0c62;if(_0x6a5a51&&typeof _0x6a5a51[_0x306151(0x180)]===_0x306151(0x133)&&_0x6a5a51[_0x306151(0x180)]['length']>0x0){const _0x4f7b2b={'name':_0x6a5a51[_0x306151(0x180)],'mainPrompt':_0x6a5a51[_0x306151(0x1ea)]||'','systemPrompt':_0x6a5a51['systemPrompt']||'','finalSystemDirective':_0x6a5a51[_0x306151(0x1b0)]||'','rateMain':_0x6a5a51[_0x306151(0x1ca)]??0x1,'ratePersonal':_0x6a5a51['ratePersonal']??0x1,'rateErotic':_0x6a5a51[_0x306151(0xbf)]??0x1,'rateCuckold':_0x6a5a51[_0x306151(0xb9)]??0x1},_0x1dd177=_0x149369[_0x306151(0x1bc)](_0xce9aef=>_0xce9aef[_0x306151(0x180)]===_0x6a5a51['name']);_0x1dd177!==-0x1?(_0x149369[_0x1dd177]=_0x4f7b2b,_0x568c7e++):(_0x149369[_0x306151(0xf3)](_0x4f7b2b),_0x4053f7++);}});if(_0x4053f7>0x0||_0x568c7e>0x0){const _0x46dd38=_0x460992['find']('#amily2_opt_prompt_preset_select')[_0x2e0c62(0xe5)]();opt_saveSetting('promptPresets',_0x149369),opt_loadPromptPresets(_0x460992),_0x460992[_0x2e0c62(0xf0)](_0x2e0c62(0x10b))[_0x2e0c62(0xe5)](_0x46dd38),_0x460992['find']('#amily2_opt_prompt_preset_select')['trigger'](_0x2e0c62(0xba));let _0x590963=[];if(_0x4053f7>0x0)_0x590963[_0x2e0c62(0xf3)](_0x2e0c62(0xee)+_0x4053f7+'\x20个新预设。');if(_0x568c7e>0x0)_0x590963[_0x2e0c62(0xf3)](_0x2e0c62(0x227)+_0x568c7e+_0x2e0c62(0x235));toastr[_0x2e0c62(0x1e9)](_0x590963[_0x2e0c62(0x15c)]('\x20'));}else toastr['warning'](_0x2e0c62(0x10f));}catch(_0x37de7d){console[_0x2e0c62(0x19a)]('['+extensionName+_0x2e0c62(0x18c),_0x37de7d),toastr[_0x2e0c62(0x19a)](_0x2e0c62(0xce)+_0x37de7d['message'],'错误');}finally{_0x460992[_0x2e0c62(0xf0)]('#amily2_opt_preset_file_input')[_0x2e0c62(0xe5)]('');}},_0x50183d[_0x1a98dc(0x17a)](_0x277beb);}function opt_loadSettings(_0x132764){const _0x4b6178=_0x34ba23,_0x434c6c=opt_getMergedSettings();_0x132764[_0x4b6178(0xf0)]('#amily2_opt_enabled')[_0x4b6178(0xf1)](_0x4b6178(0x11c),_0x434c6c['plotOpt_enabled']),_0x132764[_0x4b6178(0xf0)](_0x4b6178(0x22f)+_0x434c6c['plotOpt_apiMode']+'\x22]')[_0x4b6178(0xf1)](_0x4b6178(0x11c),!![]),_0x132764['find'](_0x4b6178(0x220))[_0x4b6178(0xe5)](_0x434c6c[_0x4b6178(0xb5)]),_0x132764['find'](_0x4b6178(0xe4)+(_0x434c6c[_0x4b6178(0xb1)]||'character')+'\x22]')[_0x4b6178(0xf1)](_0x4b6178(0x11c),!![]),_0x132764[_0x4b6178(0xf0)](_0x4b6178(0x1ed))[_0x4b6178(0xf1)]('checked',_0x434c6c['plotOpt_worldbookEnabled']),_0x132764[_0x4b6178(0xf0)](_0x4b6178(0x1bb))['val'](_0x434c6c[_0x4b6178(0x10e)]),_0x132764['find'](_0x4b6178(0x232))[_0x4b6178(0xe5)](_0x434c6c[_0x4b6178(0x226)]);const _0x5ee089=_0x132764[_0x4b6178(0xf0)](_0x4b6178(0xb2)),_0x1c6e99=_0x132764[_0x4b6178(0xf0)]('#amily2_opt_model_select');_0x5ee089[_0x4b6178(0xe5)](_0x434c6c[_0x4b6178(0xa8)]),_0x1c6e99[_0x4b6178(0x161)]();_0x434c6c['plotOpt_model']?_0x1c6e99[_0x4b6178(0x1be)](new Option(_0x434c6c[_0x4b6178(0xa8)],_0x434c6c['plotOpt_model'],!![],!![])):_0x1c6e99['append'](new Option(_0x4b6178(0x15d),'',!![],!![]));_0x132764[_0x4b6178(0xf0)](_0x4b6178(0x187))[_0x4b6178(0xe5)](_0x434c6c[_0x4b6178(0x22d)]),_0x132764[_0x4b6178(0xf0)](_0x4b6178(0x20f))['val'](_0x434c6c['plotOpt_temperature']),_0x132764[_0x4b6178(0xf0)]('#amily2_opt_top_p')[_0x4b6178(0xe5)](_0x434c6c[_0x4b6178(0x1cb)]),_0x132764[_0x4b6178(0xf0)](_0x4b6178(0x11a))[_0x4b6178(0xe5)](_0x434c6c['plotOpt_presence_penalty']),_0x132764[_0x4b6178(0xf0)](_0x4b6178(0x208))[_0x4b6178(0xe5)](_0x434c6c[_0x4b6178(0x182)]),_0x132764['find'](_0x4b6178(0xe0))['val'](_0x434c6c['plotOpt_contextTurnCount']),_0x132764[_0x4b6178(0xf0)](_0x4b6178(0x9a))[_0x4b6178(0xe5)](_0x434c6c[_0x4b6178(0x170)]),_0x132764[_0x4b6178(0xf0)]('#amily2_opt_context_limit')[_0x4b6178(0xe5)](_0x434c6c[_0x4b6178(0x1a7)]),_0x132764[_0x4b6178(0xf0)]('#amily2_opt_rate_main')['val'](_0x434c6c[_0x4b6178(0x136)]),_0x132764['find'](_0x4b6178(0x1a1))[_0x4b6178(0xe5)](_0x434c6c['plotOpt_ratePersonal']),_0x132764[_0x4b6178(0xf0)](_0x4b6178(0x12d))[_0x4b6178(0xe5)](_0x434c6c[_0x4b6178(0x1ec)]),_0x132764[_0x4b6178(0xf0)](_0x4b6178(0x229))['val'](_0x434c6c[_0x4b6178(0x149)]),_0x132764[_0x4b6178(0xf0)](_0x4b6178(0x1f7))['val'](_0x434c6c['plotOpt_mainPrompt']),_0x132764['find']('#amily2_opt_system_prompt')['val'](_0x434c6c[_0x4b6178(0x21d)]),_0x132764['find']('#amily2_opt_final_system_directive')['val'](_0x434c6c[_0x4b6178(0x1eb)]),opt_updateApiUrlVisibility(_0x132764,_0x434c6c['plotOpt_apiMode']),opt_updateWorldbookSourceVisibility(_0x132764,_0x434c6c[_0x4b6178(0xb1)]||_0x4b6178(0x174)),opt_bindSlider(_0x132764,_0x4b6178(0x187),_0x4b6178(0x119)),opt_bindSlider(_0x132764,_0x4b6178(0x20f),_0x4b6178(0x1a8)),opt_bindSlider(_0x132764,'#amily2_opt_top_p','#amily2_opt_top_p_value'),opt_bindSlider(_0x132764,_0x4b6178(0x11a),'#amily2_opt_presence_penalty_value'),opt_bindSlider(_0x132764,_0x4b6178(0x208),_0x4b6178(0xfb)),opt_bindSlider(_0x132764,'#amily2_opt_context_turn_count',_0x4b6178(0xf7)),opt_bindSlider(_0x132764,_0x4b6178(0x9a),_0x4b6178(0x1a0)),opt_bindSlider(_0x132764,_0x4b6178(0x239),_0x4b6178(0x117)),opt_loadPromptPresets(_0x132764);const _0x2ad101=_0x434c6c[_0x4b6178(0x166)];_0x2ad101&&(_0x434c6c[_0x4b6178(0x120)]||[])[_0x4b6178(0x15e)](_0x345d8d=>_0x345d8d[_0x4b6178(0x180)]===_0x2ad101)&&setTimeout(()=>{const _0x1f0689=_0x4b6178;_0x132764[_0x1f0689(0xf0)](_0x1f0689(0x10b))[_0x1f0689(0xe5)](_0x2ad101)['trigger'](_0x1f0689(0xba),{'isAutomatic':!![]});},0x0),opt_loadWorldbooks(_0x132764)[_0x4b6178(0x211)](()=>{opt_loadWorldbookEntries(_0x132764);}),opt_loadTavernApiProfiles(_0x132764);}export function initializePlotOptimizationBindings(){const _0x38373c=_0x34ba23,_0x31c713=$('#amily2_plot_optimization_panel');if(_0x31c713['length']===0x0||_0x31c713[_0x38373c(0x16c)](_0x38373c(0x216)))return;opt_loadSettings(_0x31c713),eventSource['on'](event_types[_0x38373c(0x196)],()=>{const _0x4afc50=_0x38373c;console[_0x4afc50(0x106)]('['+extensionName+']\x20检测到角色/聊天切换，正在刷新剧情优化设置UI...'),opt_loadSettings(_0x31c713);});const _0x300a1e=function(_0x1d7dfb){const _0x12c164=_0x38373c,_0x5a7004=$(_0x1d7dfb),_0x1a6ab9=(_0x1d7dfb[_0x12c164(0x180)]||_0x1d7dfb['id'])['replace']('amily2_opt_',''),_0x79245f='plotOpt_'+_0x1a6ab9[_0x12c164(0x13c)](/_([a-z])/g,_0xcaa591=>_0xcaa591[0x1][_0x12c164(0x1dd)]());let _0x3b31db=_0x1d7dfb['type']==='checkbox'?_0x1d7dfb[_0x12c164(0x11c)]:_0x5a7004['val']();_0x79245f===_0x12c164(0x1f0)&&!Array['isArray'](_0x3b31db)&&(_0x3b31db=_0x5a7004[_0x12c164(0xe5)]()||[]);const _0x390d79=['plotOpt_temperature',_0x12c164(0x1cb),_0x12c164(0x1fc),'plotOpt_frequency_penalty',_0x12c164(0x136),'plotOpt_ratePersonal',_0x12c164(0x1ec),'plotOpt_rateCuckold'];if(_0x390d79['includes'](_0x79245f)&&_0x3b31db!=='')_0x3b31db=parseFloat(_0x3b31db);else{if(_0x1d7dfb[_0x12c164(0x205)]===_0x12c164(0xef)||_0x1d7dfb[_0x12c164(0x205)]===_0x12c164(0x148)){if(_0x3b31db!=='')_0x3b31db=parseInt(_0x3b31db,0xa);}}(_0x3b31db!==''||_0x1d7dfb[_0x12c164(0x205)]===_0x12c164(0x142))&&opt_saveSetting(_0x79245f,_0x3b31db),_0x79245f===_0x12c164(0x1d7)&&opt_updateApiUrlVisibility(_0x31c713,_0x3b31db),_0x1d7dfb['name']===_0x12c164(0xd2)&&(opt_updateWorldbookSourceVisibility(_0x31c713,_0x3b31db),opt_loadWorldbookEntries(_0x31c713));},_0x4bbcb6=['input[type=\x22checkbox\x22]',_0x38373c(0xaf),'select:not(#amily2_opt_model_select)','input[type=\x22text\x22]',_0x38373c(0x197),'textarea','input[type=\x22range\x22]',_0x38373c(0xb8)][_0x38373c(0x15c)](',\x20');_0x31c713['on'](_0x38373c(0x198),_0x4bbcb6,function(){_0x300a1e(this);}),_0x31c713['on'](_0x38373c(0xbd),_0x38373c(0x1f9),function(){const _0x82fd8c=_0x38373c,_0x463d90=$(this)[_0x82fd8c(0xe5)]();_0x463d90&&_0x31c713[_0x82fd8c(0xf0)](_0x82fd8c(0xb2))['val'](_0x463d90)[_0x82fd8c(0xc4)](_0x82fd8c(0xba));}),_0x31c713['on'](_0x38373c(0x14c),_0x38373c(0x105),()=>{opt_loadTavernApiProfiles(_0x31c713);}),_0x31c713['on'](_0x38373c(0xbd),'#amily2_opt_tavern_api_profile_select',function(){const _0x14920a=_0x38373c,_0xeeedec=$(this)[_0x14920a(0xe5)]();opt_saveSetting('tavernProfile',_0xeeedec);}),_0x31c713[_0x38373c(0xf0)]('#amily2_opt_import_prompt_presets')['on']('click',()=>_0x31c713[_0x38373c(0xf0)](_0x38373c(0x20e))[_0x38373c(0x10c)]()),_0x31c713[_0x38373c(0xf0)](_0x38373c(0xd0))['on'](_0x38373c(0x10c),()=>opt_exportPromptPresets()),_0x31c713[_0x38373c(0xf0)]('#amily2_opt_save_prompt_preset')['on'](_0x38373c(0x10c),()=>opt_saveCurrentPromptsAsPreset(_0x31c713)),_0x31c713[_0x38373c(0xf0)]('#amily2_opt_delete_prompt_preset')['on']('click',()=>opt_deleteSelectedPreset(_0x31c713)),_0x31c713['on'](_0x38373c(0xbd),_0x38373c(0x20e),function(_0x416bdb){const _0x234c02=_0x38373c;opt_importPromptPresets(_0x416bdb[_0x234c02(0x1c6)][_0x234c02(0x233)][0x0],_0x31c713);}),_0x31c713['on'](_0x38373c(0xbd),'#amily2_opt_prompt_preset_select',function(_0x233b0d,_0x22f6a6){const _0x36d39c=_0x38373c,_0xabc945=$(this)[_0x36d39c(0xe5)](),_0x34aea4=_0x31c713[_0x36d39c(0xf0)](_0x36d39c(0x1b1)),_0x2b09f9=_0x22f6a6&&_0x22f6a6[_0x36d39c(0xcf)];opt_saveSetting(_0x36d39c(0x215),_0xabc945);if(!_0xabc945){_0x34aea4[_0x36d39c(0x15b)](),opt_saveSetting(_0x36d39c(0x215),'');return;}const _0x2ef460=extension_settings[extensionName]?.[_0x36d39c(0x128)]||[],_0x5de02b=_0x2ef460[_0x36d39c(0xf0)](_0x1aedcd=>_0x1aedcd[_0x36d39c(0x180)]===_0xabc945);_0x5de02b?(_0x31c713['find'](_0x36d39c(0x1f7))[_0x36d39c(0xe5)](_0x5de02b[_0x36d39c(0x1ea)])[_0x36d39c(0xc4)]('change'),_0x31c713[_0x36d39c(0xf0)](_0x36d39c(0x97))[_0x36d39c(0xe5)](_0x5de02b[_0x36d39c(0x21b)])[_0x36d39c(0xc4)](_0x36d39c(0xba)),_0x31c713[_0x36d39c(0xf0)]('#amily2_opt_final_system_directive')[_0x36d39c(0xe5)](_0x5de02b[_0x36d39c(0x1b0)])[_0x36d39c(0xc4)](_0x36d39c(0xba)),_0x31c713[_0x36d39c(0xf0)](_0x36d39c(0x21c))['val'](_0x5de02b[_0x36d39c(0x1ca)]??0x1)[_0x36d39c(0xc4)](_0x36d39c(0xba)),_0x31c713[_0x36d39c(0xf0)](_0x36d39c(0x1a1))['val'](_0x5de02b[_0x36d39c(0x137)]??0x1)['trigger'](_0x36d39c(0xba)),_0x31c713['find']('#amily2_opt_rate_erotic')[_0x36d39c(0xe5)](_0x5de02b[_0x36d39c(0xbf)]??0x1)['trigger'](_0x36d39c(0xba)),_0x31c713['find']('#amily2_opt_rate_cuckold')[_0x36d39c(0xe5)](_0x5de02b[_0x36d39c(0xb9)]??0x1)[_0x36d39c(0xc4)](_0x36d39c(0xba)),!_0x2b09f9&&toastr[_0x36d39c(0x1e9)](_0x36d39c(0xff)+_0xabc945+'\x22。'),_0x34aea4[_0x36d39c(0x12b)]()):_0x34aea4[_0x36d39c(0x15b)]();}),_0x31c713['find'](_0x38373c(0x155))['on'](_0x38373c(0x10c),function(){const _0xbcdf9a=_0x38373c;_0x31c713['find'](_0xbcdf9a(0x1f7))[_0xbcdf9a(0xe5)](defaultSettings[_0xbcdf9a(0x9f)])[_0xbcdf9a(0xc4)](_0xbcdf9a(0xba)),toastr[_0xbcdf9a(0x1e9)](_0xbcdf9a(0x188));}),_0x31c713[_0x38373c(0xf0)]('#amily2_opt_reset_system_prompt')['on'](_0x38373c(0x10c),function(){const _0x5c86fe=_0x38373c;_0x31c713['find'](_0x5c86fe(0x97))['val'](defaultSettings[_0x5c86fe(0x21d)])['trigger']('change'),toastr[_0x5c86fe(0x1e9)](_0x5c86fe(0x200));}),_0x31c713['find']('#amily2_opt_reset_final_system_directive')['on'](_0x38373c(0x10c),function(){const _0x20e504=_0x38373c;_0x31c713[_0x20e504(0xf0)](_0x20e504(0x20a))[_0x20e504(0xe5)](defaultSettings[_0x20e504(0x1eb)])[_0x20e504(0xc4)](_0x20e504(0xba)),toastr[_0x20e504(0x1e9)](_0x20e504(0x18d));}),_0x31c713[_0x38373c(0x16c)](_0x38373c(0x216),!![]),console[_0x38373c(0x106)]('['+extensionName+_0x38373c(0x102)),_0x31c713['on'](_0x38373c(0x14c),_0x38373c(0x1b9),()=>{opt_loadWorldbooks(_0x31c713)['then'](()=>{opt_loadWorldbookEntries(_0x31c713);});}),_0x31c713['on'](_0x38373c(0xbd),_0x38373c(0x1a2),async function(){const _0x409fe5=_0x38373c,_0x5dfa5d=[];_0x31c713['find'](_0x409fe5(0x1bf))['each'](function(){const _0x1914d6=_0x409fe5;_0x5dfa5d[_0x1914d6(0xf3)]($(this)[_0x1914d6(0xe5)]());}),await opt_saveSetting('plotOpt_selectedWorldbooks',_0x5dfa5d),await opt_loadWorldbookEntries(_0x31c713);}),_0x31c713['on']('change.amily2_opt','#amily2_opt_worldbook_entry_list_container\x20input[type=\x22checkbox\x22]',()=>{opt_saveEnabledEntries();}),_0x31c713['on'](_0x38373c(0x14c),'#amily2_opt_worldbook_entry_select_all',()=>{const _0x3ce124=_0x38373c;_0x31c713[_0x3ce124(0xf0)]('#amily2_opt_worldbook_entry_list_container\x20input[type=\x22checkbox\x22]')['prop'](_0x3ce124(0x11c),!![]),opt_saveEnabledEntries();}),_0x31c713['on'](_0x38373c(0x14c),_0x38373c(0xd3),()=>{const _0x489adb=_0x38373c;_0x31c713[_0x489adb(0xf0)](_0x489adb(0xa1))[_0x489adb(0xf1)](_0x489adb(0x11c),![]),opt_saveEnabledEntries();});}$(document)['on'](_0x34ba23(0xba),_0x34ba23(0x9e),function(){const _0x5b0574=_0x34ba23;if(!pluginAuthStatus[_0x5b0574(0xac)])return;const _0x1f1783=$(this)[_0x5b0574(0xe5)]();extension_settings[extensionName][_0x5b0574(0x1d2)]=_0x1f1783,saveSettingsDebounced(),console[_0x5b0574(0x106)]('[Amily-禁卫军]\x20收到迁都指令\x20->\x20'+_0x1f1783+_0x5b0574(0xd4)),toastr['info'](_0x5b0574(0xf5)+(_0x1f1783==='topbar'?'顶栏':_0x5b0574(0xc3))+_0x5b0574(0x13f),_0x5b0574(0x21f),{'timeOut':0x7d0}),$(_0x5b0574(0xe3))[_0x5b0574(0x14b)](),$(document)['off'](_0x5b0574(0xd9)),$('#amily2_extension_frame')[_0x5b0574(0x14b)](),setTimeout(createDrawer,0x32);});
