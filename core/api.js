const _0x53753c=_0x3f88;(function(_0x296e23,_0x36a458){const _0x165bc4=_0x3f88,_0x5463d4=_0x296e23();while(!![]){try{const _0x1f0298=parseInt(_0x165bc4(0x1d3))/0x1+parseInt(_0x165bc4(0x1bb))/0x2*(parseInt(_0x165bc4(0x1c5))/0x3)+-parseInt(_0x165bc4(0x1ab))/0x4+-parseInt(_0x165bc4(0x1a7))/0x5*(parseInt(_0x165bc4(0x210))/0x6)+parseInt(_0x165bc4(0x1ac))/0x7*(-parseInt(_0x165bc4(0x194))/0x8)+parseInt(_0x165bc4(0x226))/0x9*(parseInt(_0x165bc4(0x19a))/0xa)+-parseInt(_0x165bc4(0x1f1))/0xb*(-parseInt(_0x165bc4(0x19e))/0xc);if(_0x1f0298===_0x36a458)break;else _0x5463d4['push'](_0x5463d4['shift']());}catch(_0x16ad6d){_0x5463d4['push'](_0x5463d4['shift']());}}}(_0x870b,0xce6c6));import{extension_settings,getContext}from'/scripts/extensions.js';function _0x3f88(_0x485433,_0x3f56e1){const _0x870b74=_0x870b();return _0x3f88=function(_0x3f88e4,_0x34f29e){_0x3f88e4=_0x3f88e4-0x180;let _0x2169b0=_0x870b74[_0x3f88e4];return _0x2169b0;},_0x3f88(_0x485433,_0x3f56e1);}import{characters}from'/script.js';import{world_names}from'/scripts/world-info.js';import{extensionName}from'../utils/settings.js';function _0x870b(){const _0x512ff5=['pathname','/models','summarizationEnabled','生成一段简短的剧情摘要。','loreKeywords','\x20|\x20模式:\x20','[Amily2号-外交部]\x20使节团尝试使用地址:\x20','/v1','host','html','endsWith','replace','toLowerCase','24iGdkqD','[Amily2-外交部]\x20未能获取AI响应内容','#amily2_refresh_models','/chat/completions','ai.google.dev','模型获取失败:\x20','statusText','aiplatform.googleapis.com','API请求失败:\x20','message','prop','远方服务器响应异常，状态:\x20','filter','YourUsername','陛下，您提供的\x20API\x20Key\x20无效或为空。','empty','sort','done','whisper','time','\x20个模型！','length','486vshPIT','name','Amily2-外交部','/v1/chat/completions','isArray','AMILY2_LOCK_MODEL_FETCHING','[Amily2号-使节团]\x20第\x20','characterId','\x20个模型\x20(使用第\x20','name2','system','AMILY2_SYSTEM_PARALYZED','location','X-goog-api-key','[Amily2号-Google外交部]\x20收到异步操作ID，启用轮询机制...','slice','models','陛下，请先赐予\x20API\x20地址与至少一枚\x20API\x20Key。','href','split','us-central1','任务总结','API\x20Key无效','apiKey','/v1beta/projects/locations/global/models','配置缺失','cors','includes','轮询任务失败:\x20','groupCollapsed','成功获取\x20','[Amily2号-外交部]\x20情报已成功获取并解析。','data','stringify','GET','[Amily2-外交部]\x20发生严重错误:','mes','未知的模型列表格式','loreSettings','严重错误','151152caYIMg','>\x20未找到或为空，优化任务已跳过。','disabled','[Amily2号-原始回复]','love.qinyan.xyz','#amily2_api_key','27690ureaMT','[Amily2号-Google外交部]\x20修正后的API地址:\x20','choices','\x0a\x0a###AMILY2-SUMMARY###\x0a\x0a这里是根据对话生成的剧情摘要...\x0a\x0a[总结核心要求]:\x0a','7608dxLFTD','\x20位使节任务失败:','https://raw.githubusercontent.com/Wx-2025/ST-Amily2-Chat-Optimisation/refs/heads/main/amily2_update_info.json','Key\x20...','外交任务总耗时','[上下文参考]:\x0a','code','[Amily2号-最终国书内容\x20(发往AI)]','user','1793905vomOyH','\x20失败:\x20','轮询完成但未获得有效响应','[Amily2号-使节团]\x20全局错误:','4159720QoIRFJ','504TeHGzg','#amily2_model','generativelanguage.googleapis.com','[Amily2号-外交部]\x20任务取消：陛下尚未配置情报来源URL。','optimizationEnabled','status','[Amily2号-使节团]\x20派遣第\x20','origin','string','/v1beta/models','\x20-\x20','world','#amily2_api_url','info','start','2Lwkiiz','[Amily2号-使节团]\x20失败详情汇总:\x0a','[核心处理内容]:\x0a','application/json','所有使节均未能完成任务。详情请见控制台(F12)。','Amily2号任务失败:\x20','\x20个可用模型','无法识别的\x20Google\x20API\x20端点','<i\x20class=\x22fas\x20fa-spinner\x20fa-spin\x22></i>\x20加载中','map','1563651hWFgAV','apiUrl','[Amily2-外交部]\x20目标标签\x20<','mainPrompt','success','任务排队中','仅总结','###AMILY2-SUMMARY###','onAttempt','[Amily2号-外交部]\x20紧急军情：外交任务失败！','未知的\x20Google\x20模型列表格式','omit','\x20个\x20Google\x20模型\x20(使用第\x20','json','1167967eKKqFN','log','外交任务失败','push','\x20位使节成功带回\x20','embed','join','timeEnd','text','hostname','[Amily2号-外交部]\x20API\x20类型:\x20','systemPrompt','<option>','请严格遵循以下指令：基于所有提供的背景和对话内容，生成一段精炼的剧情摘要。直接输出摘要文本，不要包含任何多余的解释、标签或前缀。\x0a\x0a[总结核心要求]:\x0a','protocol','trim','audio','val','worldbookEnabled','Bearer\x20','[Amily2号-外交部]\x20最终国书将发往:\x20','toLocaleTimeString','Google','上次任务尚未完成，请稍后再试。','Authorization','+总结','extensions','系统错误','error','\x20个Key)','49313DCGBdR','这里是优化后的文本内容...','/v1beta/openai','POST','no-store','dir','substring','groupEnd','maxTokens','append','metadata','[轮询错误]','[输出格式与附加任务指令]:\x0a你的输出必须严格遵循以下完整结构：\x0a\x0a','[Amily2-外交部]\x20已将史册律法附加至国书，准备发往下一站。','任务成功','summarizationPrompt','localeCompare','Origin'];_0x870b=function(){return _0x512ff5;};return _0x870b();}import{extractContentByTag,replaceContentByTag,extractFullTagBlock}from'../utils/tagProcessor.js';import{getCombinedWorldbookContent,findLatestSummaryLore,DEDICATED_LOREBOOK_NAME,getChatIdentifier}from'./lore.js';import{isGoogleEndpoint,convertToGoogleRequest,parseGoogleResponse,buildGoogleApiUrl}from'../core/utils/googleAdapter.js';import{intelligentPoll,createGooglePollingTask,progressTracker}from'../core/utils/pollingManager.js';const UPDATE_CHECK_URL=_0x53753c(0x1a0);export async function checkForUpdates(){const _0xaf5e02=_0x53753c;if(!UPDATE_CHECK_URL||UPDATE_CHECK_URL[_0xaf5e02(0x187)](_0xaf5e02(0x21d)))return console[_0xaf5e02(0x1d4)](_0xaf5e02(0x1af)),null;try{console[_0xaf5e02(0x1d4)]('[Amily2号-外交部]\x20已派遣使者前往云端获取最新情报...');const _0x48f113=await fetch(UPDATE_CHECK_URL,{'method':_0xaf5e02(0x18e),'cache':_0xaf5e02(0x1f5),'mode':_0xaf5e02(0x186)});if(!_0x48f113['ok'])throw new Error(_0xaf5e02(0x21b)+_0x48f113[_0xaf5e02(0x1b1)]);const _0x7a3254=await _0x48f113[_0xaf5e02(0x1d2)]();return console['log'](_0xaf5e02(0x18b)),_0x7a3254;}catch(_0x20bcd2){return console[_0xaf5e02(0x1ef)](_0xaf5e02(0x1ce),_0x20bcd2),null;}}let isFetchingModels=![];export async function fetchSupportedModels(){const _0x2febd5=_0x53753c;if(window[_0x2febd5(0x22b)])return console['warn']('[Amily2号-使节团]\x20上次任务尚未完成，本次任务取消。'),toastr['info'](_0x2febd5(0x1ea),_0x2febd5(0x1ca)),[];window[_0x2febd5(0x22b)]=!![];try{const _0x44d695=$(_0x2febd5(0x1b8))[_0x2febd5(0x1e4)]()['trim'](),_0x5e3eba=$(_0x2febd5(0x199))[_0x2febd5(0x1e4)]()[_0x2febd5(0x1e2)](),_0x5ecfee=$(_0x2febd5(0x212)),_0x436da9=$(_0x2febd5(0x1ad));if(!_0x44d695||!_0x5e3eba)return toastr[_0x2febd5(0x1ef)](_0x2febd5(0x237),_0x2febd5(0x185)),[];_0x5ecfee['prop'](_0x2febd5(0x196),!![])[_0x2febd5(0x20c)](_0x2febd5(0x1c3)),_0x436da9[_0x2febd5(0x21f)]()[_0x2febd5(0x1fa)]($('<option>',{'value':'','text':'正在轮换使节团获取模型...'}));const _0x4569b5=_0x5e3eba['split'](',')[_0x2febd5(0x1c4)](_0x24461f=>_0x24461f[_0x2febd5(0x1e2)]())[_0x2febd5(0x21c)](Boolean);if(_0x4569b5[_0x2febd5(0x225)]===0x0)return toastr[_0x2febd5(0x1ef)](_0x2febd5(0x21e),_0x2febd5(0x182)),_0x436da9[_0x2febd5(0x21f)]()[_0x2febd5(0x1fa)]($(_0x2febd5(0x1df),{'value':'','text':_0x2febd5(0x182)})),[];const _0x1dfcc2=[];let _0x231acc=[];for(let _0x1cbea8=0x0;_0x1cbea8<_0x4569b5['length'];_0x1cbea8++){const _0x3e3cf7=_0x4569b5[_0x1cbea8];console[_0x2febd5(0x1d4)](_0x2febd5(0x1b2)+(_0x1cbea8+0x1)+'/'+_0x4569b5[_0x2febd5(0x225)]+'\x20位使节\x20(Key:\x20...'+_0x3e3cf7[_0x2febd5(0x235)](-0x4)+')\x20...');try{let _0x492069;const _0x378617=new URL(_0x44d695),_0x464ca3=isGoogleEndpoint(_0x44d695);if(_0x464ca3){if(_0x378617[_0x2febd5(0x1dc)]['includes'](_0x2febd5(0x1ae))||_0x378617[_0x2febd5(0x1dc)][_0x2febd5(0x187)](_0x2febd5(0x214)))_0x378617['pathname']=_0x2febd5(0x1b5);else{if(_0x378617[_0x2febd5(0x1dc)][_0x2febd5(0x187)](_0x2febd5(0x217)))_0x378617['pathname']=_0x2febd5(0x184);else throw new Error(_0x2febd5(0x1c2));}_0x492069=_0x378617[_0x2febd5(0x238)];}else{let _0x4315cc=_0x378617[_0x2febd5(0x203)];if(_0x4315cc[_0x2febd5(0x20d)]('/v1/chat/completions'))_0x4315cc=_0x4315cc[_0x2febd5(0x1f7)](0x0,_0x4315cc[_0x2febd5(0x225)]-_0x2febd5(0x213)[_0x2febd5(0x225)]);else{if(_0x4315cc[_0x2febd5(0x20d)]('/v1/'))_0x4315cc=_0x4315cc['slice'](0x0,-0x1);else!_0x4315cc[_0x2febd5(0x20d)](_0x2febd5(0x20a))&&(_0x4315cc=_0x4315cc[_0x2febd5(0x20e)](/\/$/,'')+'/v1');}_0x378617[_0x2febd5(0x203)]=_0x4315cc[_0x2febd5(0x20e)](/\/$/,'')+_0x2febd5(0x204),_0x492069=_0x378617[_0x2febd5(0x238)];}console[_0x2febd5(0x1d4)](_0x2febd5(0x209)+_0x492069),console[_0x2febd5(0x1d4)](_0x2febd5(0x1dd)+(_0x464ca3?_0x2febd5(0x1e9):'OpenAI\x20兼容'));const _0x32baaf={'Content-Type':_0x2febd5(0x1be),'Accept':_0x2febd5(0x1be)};if(_0x464ca3){console[_0x2febd5(0x1d4)]('[Amily2号-使节团]\x20使用\x20Google\x20API\x20Key:\x20...'+_0x3e3cf7['slice'](-0x4));if(_0x378617[_0x2febd5(0x1dc)][_0x2febd5(0x187)](_0x2febd5(0x1ae))||_0x378617[_0x2febd5(0x1dc)][_0x2febd5(0x187)](_0x2febd5(0x214)))_0x32baaf['X-goog-api-key']=_0x3e3cf7;else _0x378617[_0x2febd5(0x1dc)]['includes']('aiplatform.googleapis.com')&&(_0x32baaf[_0x2febd5(0x1eb)]=_0x2febd5(0x1e6)+_0x3e3cf7);}else _0x32baaf['Authorization']='Bearer\x20'+_0x3e3cf7;_0x492069[_0x2febd5(0x187)](_0x2febd5(0x198))&&(_0x32baaf['X-Custom-Proxy']='Amily2-ChatPlugin',_0x32baaf[_0x2febd5(0x202)]=window[_0x2febd5(0x232)][_0x2febd5(0x1b3)]);const _0xabbded=await fetch(_0x492069,{'method':_0x2febd5(0x18e),'headers':_0x32baaf,'mode':_0x2febd5(0x186),'credentials':_0x2febd5(0x1d0)});if(!_0xabbded['ok']){let _0x75a447='';try{const _0x4d7a1f=await _0xabbded[_0x2febd5(0x1d2)]();_0x75a447=JSON['stringify'](_0x4d7a1f,null,0x2);}catch{try{_0x75a447=await _0xabbded[_0x2febd5(0x1db)]();}catch(_0x418348){_0x75a447='<无法提取错误正文>';}}throw new Error('API返回错误:\x20'+_0xabbded[_0x2febd5(0x1b1)]+'\x20'+_0xabbded[_0x2febd5(0x216)]+'\x0a'+_0x75a447);}const _0x5b08d6=await _0xabbded['json']();let _0x343f68=[];if(_0x464ca3){if(_0x5b08d6[_0x2febd5(0x236)]&&Array[_0x2febd5(0x22a)](_0x5b08d6['models']))_0x343f68=_0x5b08d6[_0x2febd5(0x236)][_0x2febd5(0x1c4)](_0x451ef6=>_0x451ef6['name']);else{if(_0x5b08d6[_0x2febd5(0x18c)]&&Array[_0x2febd5(0x22a)](_0x5b08d6[_0x2febd5(0x18c)]))_0x343f68=_0x5b08d6[_0x2febd5(0x18c)][_0x2febd5(0x1c4)](_0x1bdbc0=>_0x1bdbc0['name']||_0x1bdbc0['id']);else{if(Array[_0x2febd5(0x22a)](_0x5b08d6))_0x343f68=_0x5b08d6[_0x2febd5(0x1c4)](_0x33cea0=>_0x33cea0[_0x2febd5(0x227)]);else throw new Error(_0x2febd5(0x1cf));}}}else{if(Array['isArray'](_0x5b08d6))_0x343f68=_0x5b08d6[_0x2febd5(0x1c4)](_0x554e16=>_0x554e16['id']||_0x554e16);else{if(_0x5b08d6['data']&&Array[_0x2febd5(0x22a)](_0x5b08d6[_0x2febd5(0x18c)]))_0x343f68=_0x5b08d6[_0x2febd5(0x18c)][_0x2febd5(0x1c4)](_0x5984c2=>_0x5984c2['id']);else{if(_0x5b08d6[_0x2febd5(0x236)]&&Array['isArray'](_0x5b08d6['models']))_0x343f68=_0x5b08d6[_0x2febd5(0x236)][_0x2febd5(0x1c4)](_0x4eeb5f=>_0x4eeb5f['id']);else throw new Error(_0x2febd5(0x191));}}}const _0xd41578=_0x343f68[_0x2febd5(0x21c)](_0x4d8a44=>typeof _0x4d8a44===_0x2febd5(0x1b4))[_0x2febd5(0x21c)](_0x524336=>!_0x524336[_0x2febd5(0x20f)]()['includes'](_0x2febd5(0x1d8)))[_0x2febd5(0x21c)](_0x555204=>!_0x555204['toLowerCase']()['includes']('search'))[_0x2febd5(0x21c)](_0x2b9b21=>!_0x2b9b21[_0x2febd5(0x20f)]()[_0x2febd5(0x187)]('similarity'))[_0x2febd5(0x21c)](_0x1e6ce1=>!_0x1e6ce1[_0x2febd5(0x20f)]()['includes'](_0x2febd5(0x1e3)))[_0x2febd5(0x21c)](_0x303000=>!_0x303000[_0x2febd5(0x20f)]()[_0x2febd5(0x187)](_0x2febd5(0x1a4)))[_0x2febd5(0x21c)](_0x289cac=>!_0x289cac[_0x2febd5(0x20f)]()[_0x2febd5(0x187)](_0x2febd5(0x222)));_0xd41578[_0x2febd5(0x220)]((_0x2adf78,_0xecd21e)=>_0x2adf78[_0x2febd5(0x201)](_0xecd21e)),console[_0x2febd5(0x1d4)](_0x2febd5(0x22c)+(_0x1cbea8+0x1)+_0x2febd5(0x1d7)+_0xd41578[_0x2febd5(0x225)]+_0x2febd5(0x224)),_0x231acc=[...new Set([..._0x231acc,..._0xd41578])],_0x231acc['sort']();_0x464ca3?toastr[_0x2febd5(0x1c9)](_0x2febd5(0x18a)+_0xd41578[_0x2febd5(0x225)]+_0x2febd5(0x1d1)+(_0x1cbea8+0x1)+_0x2febd5(0x1f0),_0x2febd5(0x1ff)):toastr[_0x2febd5(0x1c9)](_0x2febd5(0x18a)+_0xd41578[_0x2febd5(0x225)]+_0x2febd5(0x22e)+(_0x1cbea8+0x1)+_0x2febd5(0x1f0),_0x2febd5(0x1ff));break;}catch(_0x31338d){const _0x53d44d=_0x2febd5(0x1a1)+_0x3e3cf7[_0x2febd5(0x235)](-0x4)+_0x2febd5(0x1a8)+_0x31338d[_0x2febd5(0x219)];console[_0x2febd5(0x1ef)](_0x2febd5(0x22c)+(_0x1cbea8+0x1)+_0x2febd5(0x19f),_0x31338d),_0x1dfcc2[_0x2febd5(0x1d6)](_0x53d44d);}}if(_0x231acc[_0x2febd5(0x225)]>0x0)return console['log']('[Amily2号-使节团]\x20最终带回\x20'+_0x231acc[_0x2febd5(0x225)]+_0x2febd5(0x1c1)),toastr[_0x2febd5(0x1b9)]('所有使节团任务完成，找到\x20'+_0x231acc[_0x2febd5(0x225)]+'\x20个可用模型',_0x2febd5(0x181)),_0x231acc;return toastr[_0x2febd5(0x1ef)](_0x2febd5(0x1bf),_0x2febd5(0x1d5)),console[_0x2febd5(0x1ef)](_0x2febd5(0x1bc)+_0x1dfcc2[_0x2febd5(0x1d9)]('\x0a')),[];}catch(_0x489a2f){return console[_0x2febd5(0x1ef)](_0x2febd5(0x1aa),_0x489a2f),toastr['error'](_0x2febd5(0x215)+_0x489a2f[_0x2febd5(0x219)],_0x2febd5(0x1ee)),[];}finally{window[_0x2febd5(0x22b)]=![];const _0x467360=$(_0x2febd5(0x212));_0x467360[_0x2febd5(0x21a)](_0x2febd5(0x196),![])[_0x2febd5(0x20c)]('<i\x20class=\x22fas\x20fa-sync-alt\x22></i>\x20刷新模型');}}export async function checkAndFixWithAPI(_0xc73840,_0x28edf0){const _0x549cb3=_0x53753c;if(window[_0x549cb3(0x231)]===!![])return console[_0x549cb3(0x1ef)]('[Amily2-制裁]\x20系统完整性已受损，所有外交活动被无限期中止。'),null;const _0x18d562=extension_settings[extensionName],_0x496905=_0x18d562[_0x549cb3(0x1b0)],_0x5ec7ec=_0x18d562[_0x549cb3(0x205)];if(!_0x496905&&!_0x5ec7ec)return null;if(!_0x18d562['apiUrl']||!_0x18d562[_0x549cb3(0x1c6)]['trim']())return toastr[_0x549cb3(0x1ef)]('API\x20URL\x20未配置。',_0x549cb3(0x228)),null;console[_0x549cb3(0x189)]('[Amily2号-外交任务]\x20'+new Date()[_0x549cb3(0x1e8)]()+_0x549cb3(0x208)+(_0x496905?'优化':'')+(_0x5ec7ec?_0x496905?_0x549cb3(0x1ec):_0x549cb3(0x1cb):'')),console[_0x549cb3(0x223)](_0x549cb3(0x1a2));try{const _0xe363fc=_0xc73840[_0x549cb3(0x190)],_0x549ed3=_0x18d562['optimizationTargetTag']||'content';let _0x2de715;if(_0x496905){_0x2de715=extractFullTagBlock(_0xe363fc,_0x549ed3);if(!_0x2de715||extractContentByTag(_0x2de715,_0x549ed3)?.[_0x549cb3(0x1e2)]()===''){console[_0x549cb3(0x1d4)](_0x549cb3(0x1c7)+_0x549ed3+_0x549cb3(0x195)),_0x2de715=_0xe363fc;if(!_0x5ec7ec)return console['timeEnd'](_0x549cb3(0x1a2)),console['groupEnd'](),{'optimizedContent':_0xe363fc,'summary':null};}}else _0x2de715=_0xe363fc;const _0x1e679c=getContext(),_0xc990fe=_0x1e679c['name1']||'用户',_0x4fd56f=_0x1e679c[_0x549cb3(0x22f)]||'角色',_0x5b6238=_0x28edf0[_0x549cb3(0x225)]>0x0&&_0x28edf0[_0x28edf0[_0x549cb3(0x225)]-0x1]['is_user']?_0x28edf0[_0x28edf0['length']-0x1]:null,_0x5c3672=_0x5b6238?_0x28edf0['slice'](0x0,-0x1):_0x28edf0,_0x4f28dc=_0x5c3672[_0x549cb3(0x1c4)](_0x596e15=>_0x596e15[_0x549cb3(0x190)]&&_0x596e15['mes'][_0x549cb3(0x1e2)]()?(_0x596e15['is_user']?_0xc990fe:_0x4fd56f)+':\x20'+_0x596e15[_0x549cb3(0x190)][_0x549cb3(0x1e2)]():null)[_0x549cb3(0x21c)](Boolean)[_0x549cb3(0x1d9)]('\x0a');let _0x4263be='';if(_0x18d562[_0x549cb3(0x1e5)]){const _0x459a7d=characters[_0x1e679c[_0x549cb3(0x22d)]];_0x459a7d?.[_0x549cb3(0x18c)]?.[_0x549cb3(0x1ed)]?.[_0x549cb3(0x1b7)]&&(_0x4263be=await getCombinedWorldbookContent(_0x459a7d[_0x549cb3(0x18c)][_0x549cb3(0x1ed)][_0x549cb3(0x1b7)]));}const _0x55ff96=[];_0x18d562[_0x549cb3(0x1c8)]?.[_0x549cb3(0x1e2)]()&&_0x55ff96[_0x549cb3(0x1d6)]({'role':_0x549cb3(0x230),'content':_0x18d562['mainPrompt'][_0x549cb3(0x1e2)]()});if(_0x496905){if(_0x18d562[_0x549cb3(0x1de)]?.[_0x549cb3(0x1e2)]())_0x55ff96[_0x549cb3(0x1d6)]({'role':_0x549cb3(0x230),'content':_0x18d562['systemPrompt'][_0x549cb3(0x1e2)]()});}if(_0x496905&&_0x5ec7ec){const _0x6c9ed8=(_0x549cb3(0x1fd)+_0x2de715['replace'](extractContentByTag(_0x2de715,_0x549ed3),_0x549cb3(0x1f2))+_0x549cb3(0x19d)+(_0x18d562[_0x549cb3(0x200)]?.[_0x549cb3(0x1e2)]()||_0x549cb3(0x206)))['trim']();_0x55ff96[_0x549cb3(0x1d6)]({'role':_0x549cb3(0x230),'content':_0x6c9ed8});}else{if(!_0x496905&&_0x5ec7ec){const _0x2ed1d0=_0x549cb3(0x1e0)+_0x18d562[_0x549cb3(0x200)]['trim']();_0x55ff96[_0x549cb3(0x1d6)]({'role':'system','content':_0x2ed1d0});}}if(_0x4263be)_0x55ff96[_0x549cb3(0x1d6)]({'role':'user','content':'[世界书档案]:\x0a'+_0x4263be});if(_0x4f28dc)_0x55ff96[_0x549cb3(0x1d6)]({'role':_0x549cb3(0x1a6),'content':_0x549cb3(0x1a3)+_0x4f28dc});let _0x437256=_0x5b6238?_0xc990fe+':\x20'+_0x5b6238[_0x549cb3(0x190)]+'\x0a'+_0x4fd56f+':\x20'+_0x2de715:_0x2de715;_0x55ff96['push']({'role':'user','content':_0x549cb3(0x1bd)+_0x437256}),console[_0x549cb3(0x189)](_0x549cb3(0x1a5)),console[_0x549cb3(0x1f6)](_0x55ff96),console[_0x549cb3(0x1f8)]();const _0x23baf1=isGoogleEndpoint(_0x18d562['apiUrl']);let _0xff697=_0x18d562[_0x549cb3(0x1c6)][_0x549cb3(0x1e2)]();const _0x4c4db5=_0x18d562['model'],_0x2a3a6d=_0x18d562[_0x549cb3(0x1f9)],_0x1b3a22=_0x18d562['temperature'],_0x5da906=new URL(_0xff697);let _0x24ba64;if(_0x23baf1)_0x24ba64=buildGoogleApiUrl(_0xff697,_0x4c4db5),console[_0x549cb3(0x1d4)](_0x549cb3(0x19b)+_0x24ba64);else{const _0x18ec14=_0x5da906[_0x549cb3(0x203)][_0x549cb3(0x20d)]('/v1/chat/completions')||_0x5da906[_0x549cb3(0x203)][_0x549cb3(0x20d)](_0x549cb3(0x1f3));_0x18ec14?_0x24ba64=_0xff697:_0x24ba64=_0x5da906[_0x549cb3(0x1e1)]+'//'+_0x5da906[_0x549cb3(0x20b)]+_0x5da906[_0x549cb3(0x203)]+_0x549cb3(0x229);}console[_0x549cb3(0x1d4)](_0x549cb3(0x1e7)+_0x24ba64);const _0x300c40=_0x18d562[_0x549cb3(0x183)]?.['trim'](),_0x451ef0={'Content-Type':_0x549cb3(0x1be)};_0x23baf1?_0x5da906[_0x549cb3(0x1dc)][_0x549cb3(0x187)]('aiplatform.googleapis.com')||_0xff697[_0x549cb3(0x187)](_0x549cb3(0x180))?_0x451ef0['Authorization']=_0x549cb3(0x1e6)+_0x300c40:_0x451ef0[_0x549cb3(0x233)]=_0x300c40:_0x451ef0[_0x549cb3(0x1eb)]=_0x549cb3(0x1e6)+_0x300c40;let _0x5cad71;_0x23baf1?_0x5cad71=JSON['stringify'](convertToGoogleRequest({'model':_0x4c4db5,'messages':_0x55ff96,'max_tokens':_0x2a3a6d,'temperature':_0x1b3a22})):_0x5cad71=JSON[_0x549cb3(0x18d)]({'model':_0x4c4db5,'messages':_0x55ff96,'max_tokens':_0x2a3a6d,'temperature':_0x1b3a22,'stream':![]});const _0x149e41=await fetch(_0x24ba64,{'method':_0x549cb3(0x1f4),'headers':_0x451ef0,'body':_0x5cad71});if(!_0x149e41['ok'])throw new Error(_0x549cb3(0x218)+_0x149e41[_0x549cb3(0x1b1)]+'\x20'+_0x149e41[_0x549cb3(0x216)]+_0x549cb3(0x1b6)+await _0x149e41[_0x549cb3(0x1db)]());let _0x2527bc=await _0x149e41[_0x549cb3(0x1d2)](),_0x4b4996;if(_0x23baf1&&_0x2527bc['name']&&_0x2527bc[_0x549cb3(0x1fb)]){console['log'](_0x549cb3(0x234));const _0x4ebdeb=_0x2527bc[_0x549cb3(0x227)],_0x4ec2ac=progressTracker(_0x4ebdeb,0x6);_0x4ec2ac[_0x549cb3(0x1ba)]();try{const _0x687632=createGooglePollingTask(_0x4ebdeb,_0x5da906[_0x549cb3(0x1b3)],_0x451ef0),_0x5c018a={'maxAttempts':0x6,'baseDelay':0xbb8,'shouldStop':_0x1f4ca4=>_0x1f4ca4[_0x549cb3(0x221)],'onAttempt':(_0x572e53,_0x564a6b)=>{const _0x450f51=_0x549cb3;_0x4ec2ac[_0x450f51(0x1cd)](_0x572e53,_0x564a6b);},'onError':(_0x1cbc20,_0x5b1a55)=>{const _0x459dec=_0x549cb3;_0x4ec2ac[_0x459dec(0x1ef)](_0x1cbc20[_0x459dec(0x219)]);}},_0x916e0f=await intelligentPoll(_0x687632,_0x5c018a);_0x4ec2ac['complete']();if(!_0x916e0f['response'])throw new Error(_0x549cb3(0x1a9));_0x2527bc=_0x916e0f['response'],_0x4b4996=parseGoogleResponse(_0x2527bc)?.[_0x549cb3(0x19c)]?.[0x0]?.[_0x549cb3(0x219)]?.['content'];}catch(_0x463f78){console['error'](_0x549cb3(0x1fc),_0x463f78),_0x4ec2ac['error']('轮询失败:\x20'+_0x463f78['message']);throw new Error(_0x549cb3(0x188)+_0x463f78['message']);}}else _0x4b4996=_0x23baf1?parseGoogleResponse(_0x2527bc)?.[_0x549cb3(0x19c)]?.[0x0]?.[_0x549cb3(0x219)]?.['content']:_0x2527bc?.[_0x549cb3(0x19c)]?.[0x0]?.['message']?.['content'];if(!_0x4b4996)return console['error'](_0x549cb3(0x211),_0x2527bc),null;console[_0x549cb3(0x189)](_0x549cb3(0x197)),console[_0x549cb3(0x1d4)](_0x4b4996),console[_0x549cb3(0x1f8)]();let _0x5446da=_0xe363fc,_0x3bd8a3=null;if(_0x496905&&_0x5ec7ec){const _0x59c209=_0x549cb3(0x1cc),_0x80463f=_0x4b4996[_0x549cb3(0x239)](_0x59c209),_0x296575=_0x80463f[0x0]?.['trim']();_0x3bd8a3=_0x80463f[0x1]?.[_0x549cb3(0x1e2)]()||null;if(_0x296575){const _0x29c96d=extractContentByTag(_0x296575,_0x549ed3);_0x29c96d?.[_0x549cb3(0x1e2)]()&&(_0x5446da=replaceContentByTag(_0xe363fc,_0x549ed3,_0x29c96d));}}else{if(_0x496905){const _0x196db8=extractContentByTag(_0x4b4996,_0x549ed3);_0x196db8?.[_0x549cb3(0x1e2)]()&&(_0x5446da=replaceContentByTag(_0xe363fc,_0x549ed3,_0x196db8));}else _0x3bd8a3=_0x4b4996[_0x549cb3(0x1e2)]();}const _0x332739={'optimizedContent':_0x5446da,'summary':_0x3bd8a3};return _0x3bd8a3&&_0x5ec7ec&&(_0x332739[_0x549cb3(0x192)]={'activationMode':_0x18d562['loreActivationMode'],'insertionPosition':_0x18d562['loreInsertionPosition'],'depth':_0x18d562['loreDepth'],'keywords':_0x18d562[_0x549cb3(0x207)],'target':_0x18d562['lorebookTarget']},console['log'](_0x549cb3(0x1fe),_0x332739['loreSettings'])),console[_0x549cb3(0x1da)](_0x549cb3(0x1a2)),console[_0x549cb3(0x1f8)](),_0x332739;}catch(_0x4c4896){return console['error'](_0x549cb3(0x18f),_0x4c4896),toastr[_0x549cb3(0x1ef)](_0x549cb3(0x1c0)+_0x4c4896[_0x549cb3(0x219)],_0x549cb3(0x193)),console[_0x549cb3(0x1da)](_0x549cb3(0x1a2)),console[_0x549cb3(0x1f8)](),null;}}
