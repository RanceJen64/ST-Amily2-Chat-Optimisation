(function(_0x1cf8a7,_0x26f095){const _0x2cd211=_0x1a1c,_0x2dd59a=_0x1cf8a7();while(!![]){try{const _0x2255e6=parseInt(_0x2cd211(0xee))/0x1+parseInt(_0x2cd211(0xdc))/0x2+parseInt(_0x2cd211(0xe1))/0x3+parseInt(_0x2cd211(0xe4))/0x4*(parseInt(_0x2cd211(0xe7))/0x5)+parseInt(_0x2cd211(0xf0))/0x6+parseInt(_0x2cd211(0xe3))/0x7*(parseInt(_0x2cd211(0xec))/0x8)+-parseInt(_0x2cd211(0xd9))/0x9*(parseInt(_0x2cd211(0xe9))/0xa);if(_0x2255e6===_0x26f095)break;else _0x2dd59a['push'](_0x2dd59a['shift']());}catch(_0x26f693){_0x2dd59a['push'](_0x2dd59a['shift']());}}}(_0x3c08,0x9e9bf));import{getContext,extension_settings}from'/scripts/extensions.js';import{characters,saveChatConditional,reloadCurrentChat}from'/script.js';import{extensionName}from'../utils/settings.js';import{checkAndFixWithAPI}from'./api.js';import{writeSummaryToLorebook,getChatIdentifier}from'./lore.js';function _0x3c08(){const _0x2fffd6=['refresh','max','[Amily2号]\x20检测到消息并非AI对用户的直接回复，已跳过优化总结。','已优化并将总结：“','9ROnuiR','loreSettings','showOptimizationToast','718688CSyPSd','character_main','sourceAiMessageTimestamp','is_user','target','1096527xhcooP','settings','7SQaLEA','199756OHlvXp','独立中央档案(','world','25VppmYw','optimizedContent','21441470TcEUyo','info','Amily2号','2742344MeDGeb','未绑定的主世界书','966077TubxeG','slice','3062352VbFmQx','[Amily2号-遗忘哨兵]\x20裁决：检测到AI回复已被陛下操作，遵旨废黜过时总结。','data','optimizationMode','optimizationEnabled','log','enabled','summary','summarizationEnabled','”\x20备妥，待写入\x20“','extensions','chat','mes','length','characterId'];_0x3c08=function(){return _0x2fffd6;};return _0x3c08();}function _0x1a1c(_0x4d0c62,_0xc374c6){const _0x3c082e=_0x3c08();return _0x1a1c=function(_0x1a1c0b,_0x328225){_0x1a1c0b=_0x1a1c0b-0xc7;let _0x4e3ea2=_0x3c082e[_0x1a1c0b];return _0x4e3ea2;},_0x1a1c(_0x4d0c62,_0xc374c6);}import{executeAutoHide}from'./autoHideManager.js';import{checkAndTriggerAutoSummary}from'./historiographer.js';const pendingWriteData={'summary':null,'targetLorebook':null,'settings':null,'chatIdentifier':null,'sourceAiMessageTimestamp':null};export async function onMessageReceived(_0x5bc700){const _0x3124da=_0x1a1c,_0xec04a9=getContext();if(_0x5bc700&&_0x5bc700['is_user']||_0xec04a9['isWaitingForUserInput'])return;const _0xa14a5=extension_settings[extensionName],_0x4f0175=_0xec04a9[_0x3124da(0xd1)];if(!_0x4f0175||_0x4f0175[_0x3124da(0xd3)]===0x0)return;const _0x2c9093=_0x4f0175[_0x4f0175['length']-0x1];if(_0x2c9093[_0x3124da(0xdf)])return;await executeAutoHide(),await checkAndTriggerAutoSummary();pendingWriteData[_0x3124da(0xcd)]&&pendingWriteData[_0x3124da(0xe2)]&&(await writeSummaryToLorebook(pendingWriteData),pendingWriteData[_0x3124da(0xcd)]=null,pendingWriteData[_0x3124da(0xe2)]=null);if(!_0xa14a5[_0x3124da(0xcc)]||!_0xa14a5[_0x3124da(0xca)]&&!_0xa14a5[_0x3124da(0xce)]||!_0xa14a5['apiUrl'])return;if(_0x4f0175['length']<0x2||!_0x4f0175[_0x4f0175[_0x3124da(0xd3)]-0x2][_0x3124da(0xdf)]){console[_0x3124da(0xcb)](_0x3124da(0xd7));return;}const _0x21581a=_0xa14a5['contextMessages']||0x2,_0x4e2878=Math[_0x3124da(0xd6)](0x0,_0x4f0175['length']-0x1-_0x21581a),_0x1484a5=_0x4f0175[_0x3124da(0xef)](_0x4e2878,_0x4f0175[_0x3124da(0xd3)]-0x1),_0x4894e2=await checkAndFixWithAPI(_0x2c9093,_0x1484a5);if(_0x4894e2){_0x4894e2[_0x3124da(0xe8)]&&_0x4894e2[_0x3124da(0xe8)]!==_0x2c9093['mes']&&_0xa14a5[_0x3124da(0xca)]&&(_0x2c9093[_0x3124da(0xd2)]=_0x4894e2[_0x3124da(0xe8)],await saveChatConditional(),_0xa14a5[_0x3124da(0xc9)]===_0x3124da(0xd5)&&await reloadCurrentChat());if(_0x4894e2[_0x3124da(0xcd)]&&_0x4894e2[_0x3124da(0xda)]&&_0xa14a5[_0x3124da(0xce)]){pendingWriteData[_0x3124da(0xcd)]=_0x4894e2['summary'],pendingWriteData['settings']=_0x4894e2[_0x3124da(0xda)],pendingWriteData[_0x3124da(0xde)]=_0x2c9093['send_date'],pendingWriteData['chatIdentifier']=await getChatIdentifier();if(_0xa14a5[_0x3124da(0xdb)]){let _0x17eacd=_0x3124da(0xe5)+_0x4894e2['loreSettings']['target']+')';if(_0x4894e2[_0x3124da(0xda)][_0x3124da(0xe0)]===_0x3124da(0xdd)){const _0x36afcf=characters[_0xec04a9[_0x3124da(0xd4)]];_0x17eacd=_0x36afcf?.[_0x3124da(0xc8)]?.[_0x3124da(0xd0)]?.[_0x3124da(0xe6)]||_0x3124da(0xed);}toastr[_0x3124da(0xea)](_0x3124da(0xd8)+_0x4894e2['summary']+_0x3124da(0xcf)+_0x17eacd+'”',_0x3124da(0xeb),{'timeOut':0x1b58});}}}}export function onChatChanged(){const _0xbeb626=_0x1a1c,_0x2fdf69=getContext(),_0x71297c=_0x2fdf69['chat'];if(!_0x71297c||_0x71297c['length']===0x0){pendingWriteData[_0xbeb626(0xcd)]=null,pendingWriteData[_0xbeb626(0xe2)]=null;return;}const _0x188f69=_0x71297c[_0x71297c[_0xbeb626(0xd3)]-0x1];_0x188f69[_0xbeb626(0xdf)]&&pendingWriteData[_0xbeb626(0xcd)]&&(console[_0xbeb626(0xcb)](_0xbeb626(0xc7)),pendingWriteData[_0xbeb626(0xcd)]=null,pendingWriteData[_0xbeb626(0xe2)]=null);}
