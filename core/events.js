(function(_0x238b42,_0x4a74bc){const _0x37e58d=_0xa9fb,_0x224dc8=_0x238b42();while(!![]){try{const _0x38e24d=-parseInt(_0x37e58d(0xd0))/0x1+-parseInt(_0x37e58d(0xc9))/0x2+parseInt(_0x37e58d(0xbe))/0x3+parseInt(_0x37e58d(0xba))/0x4*(parseInt(_0x37e58d(0xb6))/0x5)+-parseInt(_0x37e58d(0xbf))/0x6*(-parseInt(_0x37e58d(0xc8))/0x7)+-parseInt(_0x37e58d(0xcf))/0x8*(parseInt(_0x37e58d(0xb5))/0x9)+-parseInt(_0x37e58d(0xcc))/0xa;if(_0x38e24d===_0x4a74bc)break;else _0x224dc8['push'](_0x224dc8['shift']());}catch(_0x4932a3){_0x224dc8['push'](_0x224dc8['shift']());}}}(_0x2860,0xcf684));import{getContext,extension_settings}from'/scripts/extensions.js';import{characters,saveChatConditional,reloadCurrentChat}from'/script.js';function _0x2860(){const _0x3bbfd5=['extensions','characterId','optimizationMode','showOptimizationToast','optimizedContent','mes','Amily2号','8857877wzguaI','382310wgmXlF','length','is_user','2063560MxtccK','已优化并将总结：“','chat','16iPBLQr','537099iIoKuK','loreSettings','max','summary','enabled','summarizationEnabled','refresh','[Amily2号-遗忘哨兵]\x20裁决：检测到AI回复已被陛下操作，遵旨废黜过时总结。','send_date','target','settings','slice','374625JrWeSf','5MHKNVY','未绑定的主世界书','[Amily2号]\x20检测到消息并非AI对用户的直接回复，已跳过优化总结。','独立中央档案(','2300124CmeFqv','log','optimizationEnabled','isWaitingForUserInput','80874bugwof','6tAGqWh','contextMessages'];_0x2860=function(){return _0x3bbfd5;};return _0x2860();}import{extensionName}from'../utils/settings.js';import{checkAndFixWithAPI}from'./api.js';function _0xa9fb(_0x324f38,_0x438ff2){const _0x28609a=_0x2860();return _0xa9fb=function(_0xa9fb5d,_0x59a896){_0xa9fb5d=_0xa9fb5d-0xb0;let _0x588e08=_0x28609a[_0xa9fb5d];return _0x588e08;},_0xa9fb(_0x324f38,_0x438ff2);}import{writeSummaryToLorebook,getChatIdentifier}from'./lore.js';import{executeAutoHide}from'./autoHideManager.js';import{checkAndTriggerAutoSummary}from'./historiographer.js';const pendingWriteData={'summary':null,'targetLorebook':null,'settings':null,'chatIdentifier':null,'sourceAiMessageTimestamp':null};export async function onMessageReceived(_0x28ba5e){const _0x1e166e=_0xa9fb,_0x5729db=getContext();if(_0x28ba5e&&_0x28ba5e[_0x1e166e(0xcb)]||_0x5729db[_0x1e166e(0xbd)])return;const _0x2d093c=extension_settings[extensionName],_0xa3cb08=_0x5729db[_0x1e166e(0xce)];if(!_0xa3cb08||_0xa3cb08[_0x1e166e(0xca)]===0x0)return;const _0x5e78cb=_0xa3cb08[_0xa3cb08[_0x1e166e(0xca)]-0x1];if(_0x5e78cb[_0x1e166e(0xcb)])return;await executeAutoHide(),await checkAndTriggerAutoSummary();pendingWriteData[_0x1e166e(0xd3)]&&pendingWriteData[_0x1e166e(0xb3)]&&(await writeSummaryToLorebook(pendingWriteData),pendingWriteData[_0x1e166e(0xd3)]=null,pendingWriteData['settings']=null);if(!_0x2d093c[_0x1e166e(0xd4)]||!_0x2d093c[_0x1e166e(0xbc)]&&!_0x2d093c[_0x1e166e(0xd5)]||!_0x2d093c['apiUrl'])return;if(_0xa3cb08[_0x1e166e(0xca)]<0x2||!_0xa3cb08[_0xa3cb08[_0x1e166e(0xca)]-0x2][_0x1e166e(0xcb)]){console[_0x1e166e(0xbb)](_0x1e166e(0xb8));return;}const _0x499399=_0x2d093c[_0x1e166e(0xc0)]||0x2,_0x5341a2=Math[_0x1e166e(0xd2)](0x0,_0xa3cb08['length']-0x1-_0x499399),_0xd878fb=_0xa3cb08[_0x1e166e(0xb4)](_0x5341a2,_0xa3cb08[_0x1e166e(0xca)]-0x1),_0x3c8a35=await checkAndFixWithAPI(_0x5e78cb,_0xd878fb);if(_0x3c8a35){_0x3c8a35[_0x1e166e(0xc5)]&&_0x3c8a35[_0x1e166e(0xc5)]!==_0x5e78cb['mes']&&_0x2d093c['optimizationEnabled']&&(_0x5e78cb[_0x1e166e(0xc6)]=_0x3c8a35['optimizedContent'],await saveChatConditional(),_0x2d093c[_0x1e166e(0xc3)]===_0x1e166e(0xd6)&&await reloadCurrentChat());if(_0x3c8a35['summary']&&_0x3c8a35[_0x1e166e(0xd1)]&&_0x2d093c[_0x1e166e(0xd5)]){pendingWriteData['summary']=_0x3c8a35[_0x1e166e(0xd3)],pendingWriteData[_0x1e166e(0xb3)]=_0x3c8a35[_0x1e166e(0xd1)],pendingWriteData['sourceAiMessageTimestamp']=_0x5e78cb[_0x1e166e(0xb1)],pendingWriteData['chatIdentifier']=await getChatIdentifier();if(_0x2d093c[_0x1e166e(0xc4)]){let _0x2082b2=_0x1e166e(0xb9)+_0x3c8a35[_0x1e166e(0xd1)][_0x1e166e(0xb2)]+')';if(_0x3c8a35[_0x1e166e(0xd1)][_0x1e166e(0xb2)]==='character_main'){const _0x57ad58=characters[_0x5729db[_0x1e166e(0xc2)]];_0x2082b2=_0x57ad58?.['data']?.[_0x1e166e(0xc1)]?.['world']||_0x1e166e(0xb7);}toastr['info'](_0x1e166e(0xcd)+_0x3c8a35['summary']+'”\x20备妥，待写入\x20“'+_0x2082b2+'”',_0x1e166e(0xc7),{'timeOut':0x1b58});}}}}export function onChatChanged(){const _0x42d979=_0xa9fb,_0x7544bc=getContext(),_0x2a87bb=_0x7544bc[_0x42d979(0xce)];if(!_0x2a87bb||_0x2a87bb[_0x42d979(0xca)]===0x0){pendingWriteData[_0x42d979(0xd3)]=null,pendingWriteData['settings']=null;return;}const _0x15e4be=_0x2a87bb[_0x2a87bb[_0x42d979(0xca)]-0x1];_0x15e4be[_0x42d979(0xcb)]&&pendingWriteData[_0x42d979(0xd3)]&&(console[_0x42d979(0xbb)](_0x42d979(0xb0)),pendingWriteData[_0x42d979(0xd3)]=null,pendingWriteData['settings']=null);}
