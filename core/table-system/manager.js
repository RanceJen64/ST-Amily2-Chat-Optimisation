const _0x195f36=_0x57e9;(function(_0x3c906f,_0x44f3db){const _0x3466ad=_0x57e9,_0x26cbd7=_0x3c906f();while(!![]){try{const _0x1d0816=parseInt(_0x3466ad(0x17f))/0x1+parseInt(_0x3466ad(0x19d))/0x2+-parseInt(_0x3466ad(0x1ab))/0x3*(parseInt(_0x3466ad(0x182))/0x4)+-parseInt(_0x3466ad(0x175))/0x5+-parseInt(_0x3466ad(0x202))/0x6*(-parseInt(_0x3466ad(0x201))/0x7)+parseInt(_0x3466ad(0x1d2))/0x8+-parseInt(_0x3466ad(0x11c))/0x9*(-parseInt(_0x3466ad(0x1c2))/0xa);if(_0x1d0816===_0x44f3db)break;else _0x26cbd7['push'](_0x26cbd7['shift']());}catch(_0x285a12){_0x26cbd7['push'](_0x26cbd7['shift']());}}}(_0x1e48,0x4dc3e));import{getContext,extension_settings}from'/scripts/extensions.js';import{saveChat,saveSettingsDebounced}from'/script.js';import{log}from'./logger.js';import{fillWithSecondaryApi}from'./secondary-filler.js';import{getChatPiece,saveChatDebounced}from'../../utils/utils.js';import{extensionName}from'../../utils/settings.js';import{DEFAULT_AI_RULE_TEMPLATE,DEFAULT_AI_FLOW_TEMPLATE}from'./settings.js';import{renderTables}from'../../ui/table-bindings.js';import{updateOrInsertTableInChat}from'../../ui/message-table-renderer.js';const TABLE_DATA_KEY=_0x195f36(0x1b1);let currentTablesState=null,highlightedCells=new Set();export function addHighlight(_0x2cd5e7,_0x1cb188,_0xd7c2f6){const _0x55374a=_0x195f36,_0x5c9c43=_0x2cd5e7+'-'+_0x1cb188+'-'+_0xd7c2f6;highlightedCells[_0x55374a(0x1fb)](_0x5c9c43);}export function getHighlights(){return highlightedCells;}export function clearHighlights(){const _0x4131d5=_0x195f36;highlightedCells[_0x4131d5(0x123)]>0x0&&(highlightedCells[_0x4131d5(0x10d)](),log(_0x4131d5(0x14f),_0x4131d5(0x135)));}export function setMemoryState(_0x3fc915){currentTablesState=_0x3fc915;}export function getMemoryState(){return currentTablesState;}const defaultTemplate={'tables':[{'name':'时空栏','headers':['日期','时段','时间','地点',_0x195f36(0x199)],'note':_0x195f36(0x1b5),'rule_add':_0x195f36(0x18f),'rule_delete':_0x195f36(0x124),'rule_update':_0x195f36(0x1ca),'charLimitRules':{},'rowLimitRule':0x1,'rows':[]},{'name':'角色栏','headers':[_0x195f36(0x1fd),'外貌','身形','衣着','性格','身份','职业',_0x195f36(0x13e),'爱好','住所',_0x195f36(0x1e8)],'note':_0x195f36(0x164),'rule_add':_0x195f36(0x1e4),'rule_delete':_0x195f36(0x1aa),'rule_update':'【触发条件】当角色的任何信息发生持久性或关键性变化时，必须更新对应单元格。例如：\x0a1.\x20外貌/身形/衣着发生永久性改变（如断肢、换上新装备）。\x0a2.\x20性格因重大事件而扭转。\x0a3.\x20身份或职业发生变更（如继承王位、被解雇）。\x0a4.\x20与<user>的关系发生根本性转变（如从敌人变为盟友）。','charLimitRules':{'10':0x1e},'rowLimitRule':0x0,'rows':[]},{'name':_0x195f36(0x177),'headers':[_0x195f36(0x181),'类型','详情','状态',_0x195f36(0x1d1),'地点','开始时间/结束时间','结果'],'note':'【核心作用】追踪故事中的主要情节线、目标和挑战。只记录对剧情发展有重大影响的“任务”，忽略日常琐事。\x0a【字段详解】\x0a-\x20任务名:\x20任务的简洁概括，如\x27寻找失落的神器\x27。\x0a-\x20类型:\x20任务的分类，如\x27主线\x27、\x27支线\x27、\x27个人\x27、\x27约定\x27。\x0a-\x20详情:\x20对任务目标和背景的简要描述。\x0a-\x20状态:\x20任务的当前进展，如\x27未开始\x27、\x27进行中\x27、\x27已完成\x27、\x27已失败\x27、\x27已取消\x27。\x0a-\x20执行者:\x20负责完成此任务的角色名。\x0a-\x20地点:\x20任务关键环节发生的地点。\x0a-\x20开始时间/结束时间:\x20记录任务的起止时间，格式\x27YYYY-MM-DD\x27，若未结束则结束时间留空。\x0a-\x20结果:\x20任务完成或失败后的最终结果。','rule_add':'【触发条件】当以下情况发生时，应添加新行：\x0a1.\x20角色接下一个明确的、有目标的委托或命令。\x0a2.\x20角色们达成一个具体的、需要在未来执行的约定。\x0a3.\x20角色为自己设定一个长期的、关键性的目标。','rule_delete':_0x195f36(0x162),'rule_update':'【触发条件】当任务的“状态”发生任何变化时，必须更新。例如，从\x27进行中\x27变为\x27已完成\x27。当任务的“详情”或“结果”有新的关键信息补充时，也应更新。','charLimitRules':{},'rowLimitRule':0xa,'rows':[]},{'name':_0x195f36(0x12e),'headers':[_0x195f36(0x137),'类型','详情','状态',_0x195f36(0x174),_0x195f36(0x133)],'note':_0x195f36(0x1d3),'rule_add':_0x195f36(0x1a6),'rule_delete':_0x195f36(0x18d),'rule_update':_0x195f36(0x159),'charLimitRules':{},'rowLimitRule':0x0,'rows':[]},{'name':_0x195f36(0x191),'headers':[_0x195f36(0x15d),'技能效果'],'note':_0x195f36(0x136),'rule_add':_0x195f36(0x1fe),'rule_delete':_0x195f36(0x1a2),'rule_update':_0x195f36(0x119),'charLimitRules':{},'rowLimitRule':0x0,'rows':[]},{'name':_0x195f36(0x1f9),'headers':['类型',_0x195f36(0x1d8)],'note':_0x195f36(0x1f6),'rule_add':_0x195f36(0x1ac),'rule_delete':_0x195f36(0x1e2),'rule_update':_0x195f36(0x16d),'charLimitRules':{},'rowLimitRule':0x0,'rows':[]}]};function getDefaultTables(){const _0x4a85e0=_0x195f36;log('从预设模板生成默认表格...','info');const _0x221e15=JSON[_0x4a85e0(0x19a)](JSON[_0x4a85e0(0x10f)](defaultTemplate['tables']));return _0x221e15['forEach'](_0x3ba547=>{const _0xb9b757=_0x4a85e0;_0x3ba547[_0xb9b757(0x16f)]={'columnIndex':-0x1,'limit':0x0},_0x3ba547[_0xb9b757(0x1e1)]=0x0;}),_0x221e15;}export function loadTables(_0x4db288=-0x1){const _0x3ed0ea=_0x195f36,_0x211295=getContext();if(_0x211295&&_0x211295[_0x3ed0ea(0x1da)]&&_0x211295[_0x3ed0ea(0x1da)]['length']>0x0){const _0x31e381=_0x4db288===-0x1?_0x211295[_0x3ed0ea(0x1da)][_0x3ed0ea(0x19e)]-0x1:_0x4db288-0x1;for(let _0x2c3d2d=_0x31e381;_0x2c3d2d>=0x0;_0x2c3d2d--){const _0x588b07=_0x211295[_0x3ed0ea(0x1da)][_0x2c3d2d];if(_0x588b07['extra']&&_0x588b07[_0x3ed0ea(0x108)][TABLE_DATA_KEY]){log('在第\x20'+_0x2c3d2d+_0x3ed0ea(0x128),_0x3ed0ea(0x135));let _0x153d79=JSON[_0x3ed0ea(0x19a)](JSON[_0x3ed0ea(0x10f)](_0x588b07[_0x3ed0ea(0x108)][TABLE_DATA_KEY]));return _0x153d79[_0x3ed0ea(0x1f1)](_0xf8c118=>{const _0x2b9895=_0x3ed0ea;if(_0xf8c118['note']===undefined)_0xf8c118[_0x2b9895(0x186)]='无';if(_0xf8c118[_0x2b9895(0x111)]===undefined)_0xf8c118['rule_add']='允许';if(_0xf8c118[_0x2b9895(0x1b6)]===undefined)_0xf8c118[_0x2b9895(0x1b6)]='允许';if(_0xf8c118[_0x2b9895(0x173)]===undefined)_0xf8c118[_0x2b9895(0x173)]='允许';_0xf8c118[_0x2b9895(0x16f)]&&!_0xf8c118['charLimitRules']&&(_0xf8c118[_0x2b9895(0x17a)]={},_0xf8c118['charLimitRule'][_0x2b9895(0x130)]!==-0x1&&_0xf8c118[_0x2b9895(0x16f)]['limit']>0x0&&(_0xf8c118[_0x2b9895(0x17a)][_0xf8c118[_0x2b9895(0x16f)][_0x2b9895(0x130)]]=_0xf8c118['charLimitRule'][_0x2b9895(0x1a0)]));delete _0xf8c118[_0x2b9895(0x16f)];if(_0xf8c118[_0x2b9895(0x1e1)]===undefined)_0xf8c118[_0x2b9895(0x1e1)]=0x0;}),currentTablesState=_0x153d79,currentTablesState;}}}if(extension_settings[extensionName]?.[_0x3ed0ea(0x189)]){log('未在聊天记录中找到表格，正在加载全局预设...',_0x3ed0ea(0x135));try{const _0x56f15b=extension_settings[extensionName][_0x3ed0ea(0x189)];return currentTablesState=JSON[_0x3ed0ea(0x19a)](JSON[_0x3ed0ea(0x10f)](_0x56f15b[_0x3ed0ea(0x138)])),_0x56f15b['batchFillerRuleTemplate']!==undefined&&saveBatchFillerRuleTemplate(_0x56f15b['batchFillerRuleTemplate']),_0x56f15b[_0x3ed0ea(0x167)]!==undefined&&saveBatchFillerFlowTemplate(_0x56f15b[_0x3ed0ea(0x167)]),currentTablesState;}catch(_0xe6442f){log(_0x3ed0ea(0x1f3)+_0xe6442f[_0x3ed0ea(0x194)],_0x3ed0ea(0x208));}}return log(_0x3ed0ea(0x184),_0x3ed0ea(0x135)),currentTablesState=getDefaultTables(),currentTablesState;}export function saveStateToMessage(_0x50f3f2,_0x20d0df){const _0x306d3d=_0x195f36;if(!_0x50f3f2||!_0x20d0df)return log(_0x306d3d(0x1b2),'error'),![];return!_0x20d0df[_0x306d3d(0x108)]&&(_0x20d0df['extra']={}),_0x20d0df['extra'][TABLE_DATA_KEY]=JSON['parse'](JSON[_0x306d3d(0x10f)](_0x50f3f2)),log(_0x306d3d(0x1c6)+_0x20d0df[_0x306d3d(0x1a9)][_0x306d3d(0x114)](0x0,0x14)+_0x306d3d(0x1b7),'info'),!![];}export function saveTables(_0x41a027=_0x195f36(0x176)){const _0x15957a=_0x195f36;return log('UI操作\x20\x22'+_0x41a027+_0x15957a(0x19b),_0x15957a(0x135)),!![];}export function deleteColumn(_0x39381c,_0x495356){const _0x55cea7=_0x195f36,_0x26f6c9=getMemoryState();if(!_0x26f6c9[_0x39381c]||_0x495356<0x0||_0x495356>=_0x26f6c9[_0x39381c][_0x55cea7(0x1ea)][_0x55cea7(0x19e)]){log(_0x55cea7(0x1b4)+_0x39381c+'\x20中找不到索引为\x20'+_0x495356+_0x55cea7(0x1ae),_0x55cea7(0x208));return;}_0x26f6c9[_0x39381c][_0x55cea7(0x1ea)][_0x55cea7(0x1db)](_0x495356,0x1),_0x26f6c9[_0x39381c][_0x55cea7(0x1d4)][_0x55cea7(0x1f1)](_0xae3a47=>{const _0x1808f7=_0x55cea7;_0xae3a47[_0x1808f7(0x19e)]>_0x495356&&_0xae3a47['splice'](_0x495356,0x1);}),log(_0x55cea7(0x204)+_0x39381c+_0x55cea7(0x209)+(_0x495356+0x1)+'\x20列。',_0x55cea7(0x17b)),saveTables(_0x26f6c9);}export function moveRow(_0xf334b1,_0x4fce88,_0x565e66){const _0x5add8c=_0x195f36,_0x1c84f5=getMemoryState(),_0x1e2a00=_0x1c84f5[_0xf334b1];if(!_0x1e2a00||_0x4fce88<0x0||_0x4fce88>=_0x1e2a00[_0x5add8c(0x1d4)]['length'])return;const _0x5c0a53=_0x565e66==='up'?_0x4fce88-0x1:_0x4fce88+0x1;if(_0x5c0a53<0x0||_0x5c0a53>=_0x1e2a00['rows']['length'])return;const [_0x2f29db]=_0x1e2a00[_0x5add8c(0x1d4)][_0x5add8c(0x1db)](_0x4fce88,0x1);_0x1e2a00[_0x5add8c(0x1d4)][_0x5add8c(0x1db)](_0x5c0a53,0x0,_0x2f29db),log(_0x5add8c(0x121)+_0xf334b1+_0x5add8c(0x209)+(_0x4fce88+0x1)+_0x5add8c(0x18c)+(_0x5c0a53+0x1)+'\x20行。',_0x5add8c(0x17b)),saveTables(_0x1c84f5);}export function insertRow(_0x54dbd1,_0x50d333,_0x5669a3=_0x195f36(0x122)){const _0x1904a8=_0x195f36,_0x4f1f8e=getMemoryState(),_0x33db67=_0x4f1f8e[_0x54dbd1];if(!_0x33db67){log(_0x1904a8(0x116)+_0x54dbd1+'\x20的表格。','error');return;}let _0x3e1d13;typeof _0x50d333==='number'?_0x3e1d13=_0x5669a3===_0x1904a8(0x14c)?_0x50d333:_0x50d333+0x1:_0x3e1d13=_0x33db67[_0x1904a8(0x1d4)][_0x1904a8(0x19e)];if(_0x3e1d13<0x0)_0x3e1d13=0x0;if(_0x3e1d13>_0x33db67[_0x1904a8(0x1d4)][_0x1904a8(0x19e)])_0x3e1d13=_0x33db67['rows'][_0x1904a8(0x19e)];const _0x46fd80=new Array(_0x33db67[_0x1904a8(0x1ea)][_0x1904a8(0x19e)])[_0x1904a8(0x17e)]('');if(typeof _0x50d333===_0x1904a8(0x157)&&_0x50d333!==null)for(const _0x54d3dd in _0x50d333){const _0x28d032=parseInt(_0x54d3dd,0xa);!isNaN(_0x28d032)&&_0x28d032<_0x46fd80[_0x1904a8(0x19e)]&&(_0x46fd80[_0x28d032]=_0x50d333[_0x54d3dd],addHighlight(_0x54dbd1,_0x3e1d13,_0x28d032));}_0x33db67[_0x1904a8(0x1d4)][_0x1904a8(0x1db)](_0x3e1d13,0x0,_0x46fd80),log(_0x1904a8(0x14a)+_0x33db67[_0x1904a8(0x171)]+_0x1904a8(0x1cc)+_0x54dbd1+')\x20的第\x20'+(_0x3e1d13+0x1)+'\x20行位置插入了新行。',_0x1904a8(0x17b));const _0x4e452e=getContext();if(_0x4e452e['chat']&&_0x4e452e[_0x1904a8(0x1da)][_0x1904a8(0x19e)]>0x0){const _0xf35016=_0x4e452e[_0x1904a8(0x1da)][_0x4e452e[_0x1904a8(0x1da)][_0x1904a8(0x19e)]-0x1];if(saveStateToMessage(_0x4f1f8e,_0xf35016)){saveChat();return;}}saveChatDebounced();}export function addRow(_0x5c0956){const _0x27e65d=_0x195f36;if(!currentTablesState||!currentTablesState[_0x5c0956])return;const _0x41dd=currentTablesState[_0x5c0956],_0x42017a=_0x41dd[_0x27e65d(0x1ea)][_0x27e65d(0x19e)],_0x57b553=Array(_0x42017a)[_0x27e65d(0x17e)]('');_0x41dd['rows'][_0x27e65d(0x10b)](_0x57b553);const _0x58fb75=_0x27e65d(0x1c8)+_0x41dd[_0x27e65d(0x171)]+_0x27e65d(0x13c);log(_0x58fb75,_0x27e65d(0x135));const _0x3e7642=getContext();if(_0x3e7642['chat']&&_0x3e7642[_0x27e65d(0x1da)][_0x27e65d(0x19e)]>0x0){const _0x1edc67=_0x3e7642[_0x27e65d(0x1da)][_0x3e7642[_0x27e65d(0x1da)][_0x27e65d(0x19e)]-0x1];if(saveStateToMessage(currentTablesState,_0x1edc67)){saveChat();return;}}saveChatDebounced();}export function addColumn(_0x3a97bc){const _0x9e70fb=_0x195f36;if(!currentTablesState||!currentTablesState[_0x3a97bc])return;const _0x2cad82=currentTablesState[_0x3a97bc],_0x22cb83=_0x9e70fb(0x1e5)+(_0x2cad82[_0x9e70fb(0x1ea)]['length']+0x1);_0x2cad82[_0x9e70fb(0x1ea)][_0x9e70fb(0x10b)](_0x22cb83),_0x2cad82['rows'][_0x9e70fb(0x1f1)](_0x23b198=>_0x23b198['push'](''));const _0x5764fb=_0x9e70fb(0x1c8)+_0x2cad82[_0x9e70fb(0x171)]+']\x20新增了一列。';log(_0x5764fb,_0x9e70fb(0x135));const _0x28448a=getContext();if(_0x28448a[_0x9e70fb(0x1da)]&&_0x28448a['chat'][_0x9e70fb(0x19e)]>0x0){const _0x286e5e=_0x28448a['chat'][_0x28448a[_0x9e70fb(0x1da)]['length']-0x1];if(saveStateToMessage(currentTablesState,_0x286e5e)){saveChat();return;}}saveChatDebounced();}export function updateHeader(_0x1bd64d,_0x21fd7e,_0x4d597c){const _0x32cd1f=_0x195f36;if(!currentTablesState||!currentTablesState[_0x1bd64d]||currentTablesState[_0x1bd64d][_0x32cd1f(0x1ea)][_0x21fd7e]===undefined)return;const _0x225c31=currentTablesState[_0x1bd64d][_0x32cd1f(0x171)],_0x51f12e=currentTablesState[_0x1bd64d]['headers'][_0x21fd7e];currentTablesState[_0x1bd64d]['headers'][_0x21fd7e]=_0x4d597c;const _0xdb33c=_0x32cd1f(0x1c8)+_0x225c31+_0x32cd1f(0x120)+_0x51f12e+'”已更新为“'+_0x4d597c+'”。';log(_0xdb33c,'info');const _0xff6cb4=getContext();if(_0xff6cb4['chat']&&_0xff6cb4[_0x32cd1f(0x1da)]['length']>0x0){const _0x2ee70c=_0xff6cb4['chat'][_0xff6cb4['chat'][_0x32cd1f(0x19e)]-0x1];if(saveStateToMessage(currentTablesState,_0x2ee70c)){saveChat();return;}}saveChatDebounced();}export async function deleteRow(_0x33297d,_0x5b5f19){const _0x2d2a32=_0x195f36;if(!currentTablesState||!currentTablesState[_0x33297d]||!currentTablesState[_0x33297d]['rows'][_0x5b5f19])return;const _0x137c98=currentTablesState[_0x33297d]['name'];currentTablesState[_0x33297d][_0x2d2a32(0x1d4)][_0x2d2a32(0x1db)](_0x5b5f19,0x1);const _0x1d9aed=_0x2d2a32(0x1c8)+_0x137c98+']\x20的第\x20'+(_0x5b5f19+0x1)+'\x20行已删除。';log(_0x1d9aed,_0x2d2a32(0x135));const _0x5b94ef=getContext();if(_0x5b94ef[_0x2d2a32(0x1da)]&&_0x5b94ef['chat'][_0x2d2a32(0x19e)]>0x0){const _0x29e92a=_0x5b94ef[_0x2d2a32(0x1da)][_0x5b94ef['chat'][_0x2d2a32(0x19e)]-0x1];if(saveStateToMessage(currentTablesState,_0x29e92a)){await saveChat();return;}}await saveChatDebounced();}export function insertColumn(_0xe96e00,_0x336c22,_0x584579){const _0x34902b=_0x195f36;if(!currentTablesState||!currentTablesState[_0xe96e00])return;const _0x14d31d=currentTablesState[_0xe96e00],_0x1caf6c=_0x584579===_0x34902b(0x125)?_0x336c22:_0x336c22+0x1,_0x442aa8='新列';_0x14d31d['headers'][_0x34902b(0x1db)](_0x1caf6c,0x0,_0x442aa8),_0x14d31d['rows'][_0x34902b(0x1f1)](_0x1c4238=>_0x1c4238[_0x34902b(0x1db)](_0x1caf6c,0x0,''));const _0x2084b8='表格\x20['+_0x14d31d[_0x34902b(0x171)]+_0x34902b(0x165)+(_0x336c22+0x1)+_0x34902b(0x110)+(_0x584579==='left'?'左侧':'右侧')+_0x34902b(0x1bb);log(_0x2084b8,_0x34902b(0x135));const _0x1e8d59=getContext();if(_0x1e8d59[_0x34902b(0x1da)]&&_0x1e8d59[_0x34902b(0x1da)][_0x34902b(0x19e)]>0x0){const _0x2145a5=_0x1e8d59['chat'][_0x1e8d59[_0x34902b(0x1da)][_0x34902b(0x19e)]-0x1];if(saveStateToMessage(currentTablesState,_0x2145a5)){saveChat();return;}}saveChatDebounced();}export function moveColumn(_0x148925,_0x44e662,_0x61da8f){const _0x12127b=_0x195f36;if(!currentTablesState||!currentTablesState[_0x148925])return;const _0x3d3e48=currentTablesState[_0x148925],_0x1c5e1b=_0x3d3e48[_0x12127b(0x1ea)],_0x2d7119=_0x3d3e48['rows'],_0x769cac=_0x61da8f==='left'?_0x44e662-0x1:_0x44e662+0x1;if(_0x769cac<0x0||_0x769cac>=_0x1c5e1b[_0x12127b(0x19e)]){log(_0x12127b(0x142)+_0x44e662+_0x12127b(0x15f),_0x12127b(0x1ba));return;}const [_0x409906]=_0x1c5e1b[_0x12127b(0x1db)](_0x44e662,0x1);_0x1c5e1b['splice'](_0x769cac,0x0,_0x409906),_0x2d7119[_0x12127b(0x1f1)](_0x4486af=>{const _0x27bae1=_0x12127b,[_0x169f46]=_0x4486af[_0x27bae1(0x1db)](_0x44e662,0x1);_0x4486af[_0x27bae1(0x1db)](_0x769cac,0x0,_0x169f46);});const _0x12f091=_0x12127b(0x1c8)+_0x3d3e48[_0x12127b(0x171)]+_0x12127b(0x17d)+_0x409906+_0x12127b(0x1ad)+(_0x61da8f===_0x12127b(0x125)?'左':'右')+_0x12127b(0x19f);log(_0x12f091,'info');const _0x14fdb2=getContext();if(_0x14fdb2[_0x12127b(0x1da)]&&_0x14fdb2[_0x12127b(0x1da)]['length']>0x0){const _0x5a48b5=_0x14fdb2['chat'][_0x14fdb2[_0x12127b(0x1da)]['length']-0x1];if(saveStateToMessage(currentTablesState,_0x5a48b5)){saveChat();return;}}saveChatDebounced();}export function deleteTable(_0x4d4c87){const _0x3afa30=_0x195f36;if(!currentTablesState||!currentTablesState[_0x4d4c87])return;const _0x2eaa7b=currentTablesState[_0x4d4c87][_0x3afa30(0x171)];currentTablesState[_0x3afa30(0x1db)](_0x4d4c87,0x1);const _0x355d94='表格\x20['+_0x2eaa7b+']\x20已被成功废黜。';log(_0x355d94,_0x3afa30(0x17b));const _0x1c1306=getContext();if(_0x1c1306[_0x3afa30(0x1da)]&&_0x1c1306['chat']['length']>0x0){const _0x2329ba=_0x1c1306['chat'][_0x1c1306[_0x3afa30(0x1da)][_0x3afa30(0x19e)]-0x1];if(saveStateToMessage(currentTablesState,_0x2329ba)){saveChat(),log('废黜表格后的状态已强制写入最新消息并立即保存。',_0x3afa30(0x17b));return;}}log(_0x3afa30(0x1cd),_0x3afa30(0x208)),saveChatDebounced();}export function addTable(_0x242ec9){const _0xb1b94b=_0x195f36;if(!_0x242ec9||!_0x242ec9[_0xb1b94b(0x1dd)]()){log('无法创建表格：名称不能为空。',_0xb1b94b(0x208)),toastr[_0xb1b94b(0x208)]('表格名称不能为空。',_0xb1b94b(0x132));return;}!currentTablesState&&loadTables();if(currentTablesState[_0xb1b94b(0x1fc)](_0x5dadcc=>_0x5dadcc[_0xb1b94b(0x171)]===_0x242ec9[_0xb1b94b(0x1dd)]())){log(_0xb1b94b(0x117)+_0x242ec9+_0xb1b94b(0x12b),_0xb1b94b(0x208)),toastr[_0xb1b94b(0x208)](_0xb1b94b(0x1e7)+_0x242ec9+_0xb1b94b(0x12b),_0xb1b94b(0x132));return;}const _0x4aa2d8={'name':_0x242ec9[_0xb1b94b(0x1dd)](),'headers':[_0xb1b94b(0x144)],'rows':[],'note':_0xb1b94b(0x1d9),'rule_add':'允许','rule_delete':'允许','rule_update':'允许','charLimitRules':{},'rowLimitRule':0x0};currentTablesState['push'](_0x4aa2d8);const _0x2dfdc1=_0xb1b94b(0x14b)+_0x242ec9[_0xb1b94b(0x1dd)]()+']。';log(_0x2dfdc1,_0xb1b94b(0x17b));const _0x34a447=getContext();if(_0x34a447['chat']&&_0x34a447['chat'][_0xb1b94b(0x19e)]>0x0){const _0x3db2f9=_0x34a447[_0xb1b94b(0x1da)][_0x34a447[_0xb1b94b(0x1da)][_0xb1b94b(0x19e)]-0x1];if(saveStateToMessage(currentTablesState,_0x3db2f9)){saveChat(),log('新表格状态已强制写入最新消息并立即保存。',_0xb1b94b(0x17b));return;}}log(_0xb1b94b(0x1ff),'error'),saveChatDebounced();}export function renameTable(_0x32d594,_0x5fa357){const _0xdafc7=_0x195f36;if(!currentTablesState||!currentTablesState[_0x32d594]){log(_0xdafc7(0x1bf),'error'),toastr[_0xdafc7(0x208)](_0xdafc7(0x1b3),_0xdafc7(0x126));return;}const _0xa023ba=_0x5fa357['trim']();if(!_0xa023ba){log('重命名失败：名称不能为空。',_0xdafc7(0x208)),toastr['error'](_0xdafc7(0x1f4),'重命名失败');return;}if(currentTablesState[_0xdafc7(0x1fc)]((_0x194ebb,_0x282e11)=>_0x282e11!==_0x32d594&&_0x194ebb['name']===_0xa023ba)){log('重命名失败：名为\x20\x22'+_0xa023ba+'\x22\x20的表格已存在。',_0xdafc7(0x208)),toastr[_0xdafc7(0x208)](_0xdafc7(0x1e7)+_0xa023ba+_0xdafc7(0x12b),_0xdafc7(0x126));return;}const _0x412846=currentTablesState[_0x32d594]['name'];currentTablesState[_0x32d594][_0xdafc7(0x171)]=_0xa023ba,log('表格\x20\x22'+_0x412846+_0xdafc7(0x1de)+_0xa023ba+'\x22。',_0xdafc7(0x17b));const _0x50a916=getContext();if(_0x50a916[_0xdafc7(0x1da)]&&_0x50a916[_0xdafc7(0x1da)][_0xdafc7(0x19e)]>0x0){const _0x3d8230=_0x50a916[_0xdafc7(0x1da)][_0x50a916[_0xdafc7(0x1da)][_0xdafc7(0x19e)]-0x1];if(saveStateToMessage(currentTablesState,_0x3d8230)){saveChat();return;}}saveChatDebounced();}export function moveTable(_0x2565b9,_0x1a5cee){const _0x34f682=_0x195f36;if(!currentTablesState||!currentTablesState[_0x2565b9])return;const _0x378dde=_0x1a5cee==='up'?_0x2565b9-0x1:_0x2565b9+0x1;if(_0x378dde<0x0||_0x378dde>=currentTablesState['length']){log(_0x34f682(0x109)+_0x2565b9+'\x20已在边界。','warn');return;}const _0x3981c3=currentTablesState[_0x2565b9];currentTablesState[_0x2565b9]=currentTablesState[_0x378dde],currentTablesState[_0x378dde]=_0x3981c3;const _0x42ca97=_0x34f682(0x1c8)+_0x3981c3['name']+_0x34f682(0x1c0);log(_0x42ca97,_0x34f682(0x17b));const _0x1419ee=getContext();if(_0x1419ee['chat']&&_0x1419ee[_0x34f682(0x1da)]['length']>0x0){const _0x49ecd5=_0x1419ee[_0x34f682(0x1da)][_0x1419ee['chat'][_0x34f682(0x19e)]-0x1];if(saveStateToMessage(currentTablesState,_0x49ecd5)){saveChat(),log(_0x34f682(0x16a),'success');return;}}log(_0x34f682(0x1dc),_0x34f682(0x208)),saveChatDebounced();}export function updateTableRules(_0x14524c,_0x59d729){const _0x2dd377=_0x195f36;if(!currentTablesState||!currentTablesState[_0x14524c])return;const _0x3b1c3a=currentTablesState[_0x14524c];_0x3b1c3a['note']=_0x59d729[_0x2dd377(0x186)],_0x3b1c3a[_0x2dd377(0x111)]=_0x59d729['rule_add'],_0x3b1c3a[_0x2dd377(0x1b6)]=_0x59d729['rule_delete'],_0x3b1c3a[_0x2dd377(0x173)]=_0x59d729[_0x2dd377(0x173)],_0x3b1c3a['charLimitRules']=_0x59d729[_0x2dd377(0x17a)],_0x3b1c3a[_0x2dd377(0x1e1)]=_0x59d729[_0x2dd377(0x1e1)],delete _0x3b1c3a[_0x2dd377(0x16f)];const _0x3faa17='表格\x20['+_0x3b1c3a[_0x2dd377(0x171)]+_0x2dd377(0x141);log(_0x3faa17,_0x2dd377(0x135));const _0x36f27c=getContext();if(_0x36f27c['chat']&&_0x36f27c['chat']['length']>0x0){const _0x57c233=_0x36f27c[_0x2dd377(0x1da)][_0x36f27c[_0x2dd377(0x1da)][_0x2dd377(0x19e)]-0x1];if(saveStateToMessage(currentTablesState,_0x57c233)){saveChat();return;}}saveChatDebounced();}export function updateRow(_0x59f11f,_0x2021aa,_0x3a23ca){const _0x485ef6=_0x195f36;if(!currentTablesState||!currentTablesState[_0x59f11f]){log('AI指令错误：尝试在不存在的表格索引\x20'+_0x59f11f+_0x485ef6(0x12d),_0x485ef6(0x208));return;}const _0x54b3d6=currentTablesState[_0x59f11f];if(_0x2021aa>=_0x54b3d6[_0x485ef6(0x1d4)][_0x485ef6(0x19e)]){log('AI指令意图更新不存在的行\x20(rowIndex:\x20'+_0x2021aa+_0x485ef6(0x183)+_0x54b3d6[_0x485ef6(0x171)]+']\x20末尾新增一行。',_0x485ef6(0x1ba)),insertRow(_0x59f11f,_0x3a23ca);return;}const _0x7ab13f=_0x54b3d6[_0x485ef6(0x1d4)][_0x2021aa];for(const _0x5408ec in _0x3a23ca){const _0x304155=parseInt(_0x5408ec,0xa);_0x304155<_0x7ab13f['length']&&(_0x7ab13f[_0x304155]=_0x3a23ca[_0x304155],addHighlight(_0x59f11f,_0x2021aa,_0x304155));}const _0xbcae4e=_0x485ef6(0x166)+_0x54b3d6[_0x485ef6(0x171)]+_0x485ef6(0x18e)+(_0x2021aa+0x1)+_0x485ef6(0x163);log(_0xbcae4e,_0x485ef6(0x135));const _0x37d5a7=getContext();if(_0x37d5a7[_0x485ef6(0x1da)]&&_0x37d5a7[_0x485ef6(0x1da)][_0x485ef6(0x19e)]>0x0){const _0x24cbfd=_0x37d5a7['chat'][_0x37d5a7[_0x485ef6(0x1da)][_0x485ef6(0x19e)]-0x1];if(saveStateToMessage(currentTablesState,_0x24cbfd)){saveChat();return;}}saveChatDebounced();}export function clearAllTables(){const _0x4bdacc=_0x195f36;if(!currentTablesState){log(_0x4bdacc(0x1d6),_0x4bdacc(0x208));return;}currentTablesState[_0x4bdacc(0x1f1)](_0x43f2cf=>{_0x43f2cf['rows']=[];}),log('所有表格的行数据已在内存中清空。','warn');const _0x659c39=getContext();if(_0x659c39[_0x4bdacc(0x1da)]&&_0x659c39[_0x4bdacc(0x1da)][_0x4bdacc(0x19e)]>0x0){const _0x408d4c=_0x659c39['chat'][_0x659c39[_0x4bdacc(0x1da)][_0x4bdacc(0x19e)]-0x1];if(saveStateToMessage(currentTablesState,_0x408d4c)){saveChat(),log(_0x4bdacc(0x11b),_0x4bdacc(0x17b)),toastr['success'](_0x4bdacc(0x112),_0x4bdacc(0x203));return;}}log('无法找到可锚定的消息或保存失败，清空操作可能不会被持久化！','error'),saveChatDebounced();}function _0x1e48(){const _0x572cd8=['filter','stringify','\x20列的','rule_add','所有表格的剧情内容已清空。',',\x20data=','substring','执行失败','插入行失败：找不到索引为\x20','无法创建表格：名为\x20\x22','\x0a---\x0a','【触发条件】当一个已知技能的效果发生进化、变异或被添加了新的限制/效果时（例如，技能升级），必须更新其“技能效果”描述。','onload','清空行数据后的状态已强制写入最新消息并立即保存。','1097199abjzwE','replace','【清除全局预设】\x0a\x0a您确定要清除已设置的全局预设吗？\x0a\x0a清除后，新聊天将恢复使用扩展内置的默认表格模板。','导入的表格数据格式不正确:\x20',']\x20的表头“','成功将表格\x20','below','size','【触发条件】任何时候，如果此表格的行数超过一行，必须删除旧的行，只保留最新、最准确的一行。','left','重命名失败','confirm','\x20条消息中找到基准表格数据。','回退并重新填表操作完成。','type','\x22\x20的表格已存在。','click','\x20中操作。','物品栏','download','columnIndex','设置成功','创建失败','重要原因','预设已成功导入！','info','【核心作用】专门用于记录主角<user>掌握的各种技能、魔法、被动能力或特殊专长。\x0a【字段详解】\x0a-\x20技能名:\x20技能的正式名称。\x0a-\x20技能效果:\x20清晰、简洁地描述该技能使用时产生的具体效果、消耗和限制条件。','物品名','tables','预设已成功导入并应用。','version','Amily2-Table-Preset-v3.0-separated_templates',']\x20新增了一行。','Amily2-Table-Preset-v2.0-clean','与<user>关系','导入全局预设失败:\x20','files',']\x20的规则已更新。','无法移动列：索引\x20','填表完成','新列\x201','正在尝试从第\x20','（该表当前内容为空）\x0a','aiRuleTemplate','createElement','application/json','成功在表格\x20','已成功创建新表格：[','above','aiFlowTemplate','【全局预设导入】\x0a\x0a这将把选定的预设设置为所有新聊天的默认表格。\x0a\x0a此操作将覆盖任何已存在的全局预设，是否确定？','已清除所有单元格高亮标记。','href','onchange','file','回退状态保存失败，操作中止。','操作已取消。','UI已更新以显示回退后的状态。','】已开始下载。','object','）第（','【触发条件】当物品的“状态”（如被损坏）、“拥有者”（如被转交或被盗）或“详情”（如发现了新功能）发生变化时，必须更新。','aiTemplate','已根据AI的指示成功更新表格！','amily2_ai_template','技能名','AI指令块为空，无需执行任何操作。','\x20已在边界。','input','match','【触发条件】当任务列表超过10行时，优先删除最早的、已经“已完成”且与当前剧情关联度最低的任务。如果存在内容完全重复的任务，应删除。','\x20行。','【核心作用】此表格是角色关系和状态的核心数据库，用于记录所有在故事中出现的重要角色的详细信息。\x0a【字段详解】\x0a-\x20角色名:\x20角色的唯一标识。\x0a-\x20外貌:\x20描述五官、发型、发色、肤色等面部特征。\x0a-\x20身形:\x20描述身高、体型、肌肉状况、特殊身体标记（如伤疤）等。\x0a-\x20衣着:\x20描述角色当前或标志性的穿着，包括服装、配饰等。\x0a-\x20性格:\x20概括角色的核心性格特质，使用1-3个关键词，如\x27勇敢/鲁莽/忠诚\x27。\x0a-\x20身份:\x20角色的社会背景或出身，如\x27贵族后裔\x27、\x27流浪者\x27。\x0a-\x20职业:\x20角色赖以谋生的工作或职责，如\x27佣兵\x27、\x27学者\x27。\x0a-\x20与<user>关系:\x20描述该角色与主角<user>之间的社会或情感关系，如\x27盟友\x27、\x27导师\x27、\x27敌人\x27。\x0a-\x20爱好:\x20角色的兴趣和消遣活动。\x0a-\x20住所:\x20角色的常住地。\x0a-\x20其他重要信息:\x20记录任何不属于以上类别但对角色至关重要的信息，如特殊能力、过去的经历等。',']\x20在第\x20','AI\x20指令更新了表格\x20[','batchFillerFlowTemplate','）行以下，但切莫完全删除。】','batchFillerRuleTemplate','表格顺序调整后的状态已强制写入最新消息并立即保存。','target','constructor','【触发条件】只能在<user>明确表示要修改某条设定时，才能更新对应行的描述。','文件格式无效或缺少版本号/表格数据。','charLimitRule','join','name','用户取消了导入操作。','rule_update','拥有者','1448740UZpFzf','未知操作','任务栏','fromCharCode','执行AI指令时出错:\x20','charLimitRules','success','【说明】:\x0a',']\x20的列“','fill','387605FXRioq','function','任务名','81948ZfPzre',')，已智能转换为在表格\x20[','未找到任何表格数据或全局预设，使用默认模板。','）超出规定（','note','全局预设已清除，新聊天将使用默认模板。','导入成功','global_table_preset','dispatchEvent','split','\x20行移动到第\x20','【触发条件】当一个物品被彻底摧毁、消耗完毕或永久失去其特殊意义时，可以删除。',']\x20的第\x20','【触发条件】当故事开始，且此表格为空时，必须立即根据初始场景创建第一行。','）行，请结合剧情缩减至（','技能栏','toString','every','message','用户取消了全局预设导入操作。','完整备份',',\x20rowIndex=','【当前（','此地角色','parse','\x22\x20已更新内存状态。','accept','96436hpzYZL','length','移动。','limit','全局预设已成功导入并保存到扩展设置中。','【触发条件】如果发现表格中存在两个描述完全相同的重复技能，应删除其中一个。如果记录了非<user>的技能，应立即删除。','result','batch_filler_rule_template','amily2-force-ui-reload','【触发条件】当一个物品被明确赋予了特殊意义（如被赠予、在关键事件中扮演重要角色）或展示出独特功能时，应为其创建条目。','未能在上一楼找到可用的表格状态，无法回退。','导入操作已取消。','mes','【触发条件】当一个角色被确认永久性死亡（非假死或失踪），且其存在不再对后续剧情有直接影响时，可以删除该行。','33GVXjWA','【触发条件】当<user>通过括号、旁白或其他明确的“第四面墙”方式，提出关于故事背景、规则或未来走向的指令时，必须记录于此。','”已向','\x20的列。','map','toISOString','amily2_tables_data','缺少状态或目标消息，无法保存。','表格不存在。','删除列失败：在表格\x20','【核心作用】此表格用于精确追踪故事发生的即时时空背景，确保时间与空间的连续性。它应该始终只包含一行，代表当前的“镜头”位置。\x0a【字段详解】\x0a-\x20日期:\x20格式为\x27YYYY-MM-DD\x27。若日期未知，请根据上下文合理推断或设定一个初始日期，如\x27大夏3年-9月-10日\x27。\x0a-\x20时段:\x20严格遵循规定（凌晨：0-5时；早晨：5-8时；上午：8-11时；中午：11-13时；下午：13-16时；傍晚：16-19时；晚上：19-24时）。\x0a-\x20时间:\x20格式为\x27HH:MM\x27。若时间未知，可根据时段估算，如\x2708:30\x27。\x0a-\x20地点:\x20描述当前场景发生的具体位置，应尽可能精确，例如\x27XX街的咖啡馆\x27而非\x27城里\x27。\x0a-\x20此地角色:\x20列出当前场景中所有在场且参与互动的主要角色，用\x27/\x27分隔。','rule_delete','...]','正在执行回退并重新填表...','\x0a\x20\x20\x20\x20\x20\x20\x20\x20','warn','插入了新列。','body','所有AI指令已成功执行完毕。','【修改】:\x20','重命名失败：表格不存在。',']\x20的顺序已调整。','AI返回内容为空，无法更新表格。','10lDSscY','rowIndex,','）列，字符超出规定（','执行AI指令:\x20updateRow(tableIndex=','表格状态已准备写入消息\x20[','导入预设失败:\x20','表格\x20[','Amily2-','【触发条件】当以下任一情况发生时，必须更新此行：\x0a1.\x20时间发生显著跳跃（例如，\x27几小时后\x27、\x27第二天\x27）。\x0a2.\x20角色从一个地点移动到另一个地点。\x0a3.\x20场景中关键角色的出入导致在场人员发生变化。','状态回退成功，准备重新填表...','\x20(索引\x20','无法找到可锚定的消息或保存失败，删除操作可能不会被持久化！','）字限制，请进行缩减。】','）行（','导入的预设中缺少指令模板字段，模板将不会被更新。','执行者','1462952cNMzTF','【核心作用】记录那些在故事中具有特殊功能、背景或情感价值的关键物品。普通物品不应记录。\x0a【字段详解】\x0a-\x20物品名:\x20物品的名称。\x0a-\x20类型:\x20物品的分类，如\x27武器\x27、\x27道具\x27、\x27信物\x27、\x27关键物品\x27。\x0a-\x20详情:\x20描述物品的外观、材质和已知功能。\x0a-\x20状态:\x20物品的当前状况，如\x27完好\x27、\x27破损\x27、\x27能量耗尽\x27。\x0a-\x20拥有者:\x20当前持有该物品的角色名。\x0a-\x20重要原因:\x20解释该物品为何重要，例如\x27是解开谜题的钥匙\x27或\x27是母亲的遗物\x27。','rows','导入失败：','无法清空：当前表格状态为空。','未能保存回退状态，操作中止。','具体描述','这是一个新创建的表格。','chat','splice','无法找到可锚定的消息或保存失败，顺序调整可能不会被持久化！','trim','\x22\x20已重命名为\x20\x22','slice','】已成功导出。','rowLimitRule','【触发条件】只能在<user>明确表示要移除或废弃某条设定时，才能删除对应行。','无法回退：聊天记录不足。','【触发条件】当一个有名有姓的角色首次出现，并与<user>或当前剧情发生有意义的互动时，必须为其创建新的一行。','新列\x20','操作成功','名为\x20\x22','其他重要信息','无需清除，当前未设置任何全局预设。','headers','状态回退失败，已中止操作。','injectionFlowTemplate','已成功将回退后的状态保存至最新消息。','\x20条表格操作指令...','无法导出：当前表格状态为空。','【警告】\x0a\x0a导入操作将完全覆盖您当前的AI指令模板和所有表格（包括结构和内容）。\x0a\x0a此操作不可逆，是否确定要继续？','forEach','用户取消了清除全局预设的操作。','加载全局预设失败:\x20','表格名称不能为空。','回退重填过程中发生错误:\x20','【核心作用】此表格记录了来自<user>的、超越故事本身的“元指令”或世界观设定，拥有最高解释权。内容应被严格遵守，禁止AI自行修改。\x0a【字段详解】\x0a-\x20类型:\x20指令的分类，如\x27世界观设定\x27、\x27剧情走向要求\x27、\x27角色行为禁令\x27。\x0a-\x20具体描述:\x20完整、准确地记录<user>提出的具体要求。','createObjectURL','全局预设已被清除。','设定栏','.json','add','some','角色名','【触发条件】当<user>在故事中首次成功施展或习得一个全新的、表格中未记录的技能时，必须添加。','无法找到可锚定的消息或保存失败，新表格可能不会被持久化！','isArray','50092KOVHBn','78ZNCIhK','操作完成','成功删除了表格\x20','执行AI指令时发生错误:\x20','未在AI返回内容中找到有效的\x20<Amily2Edit>\x20指令块。','未能在上一楼找到可用的表格状态。','error','\x20的第\x20','extra','无法移动表格：索引\x20','没有可导出的表格数据。','push','batch_filler_flow_template','clear'];_0x1e48=function(){return _0x572cd8;};return _0x1e48();}function checkTableRules(_0x50bc33){const _0xc5803c=_0x195f36;let _0x24be0f=[];_0x50bc33[_0xc5803c(0x1e1)]&&_0x50bc33[_0xc5803c(0x1e1)]>0x0&&_0x50bc33['rows'][_0xc5803c(0x19e)]>_0x50bc33[_0xc5803c(0x1e1)]&&_0x24be0f[_0xc5803c(0x10b)](_0xc5803c(0x198)+_0x50bc33['name']+_0xc5803c(0x185)+_0x50bc33[_0xc5803c(0x1e1)]+_0xc5803c(0x190)+_0x50bc33[_0xc5803c(0x1e1)]+_0xc5803c(0x168));const _0x408612=_0x50bc33[_0xc5803c(0x17a)]||{};for(const _0x202723 in _0x408612){const _0x581712=parseInt(_0x202723,0xa),_0x5ebc30=_0x408612[_0x581712];if(_0x5ebc30>0x0&&_0x581712>=0x0&&_0x581712<_0x50bc33[_0xc5803c(0x1ea)]['length']){const _0x59569c=_0x50bc33[_0xc5803c(0x1ea)][_0x581712],_0x34a5e6=[];_0x50bc33[_0xc5803c(0x1d4)]['forEach']((_0x7cd56b,_0x3bd67e)=>{const _0x49edc1=_0xc5803c,_0x5c5a1a=_0x7cd56b[_0x581712]||'';_0x5c5a1a[_0x49edc1(0x19e)]>_0x5ebc30&&_0x34a5e6['push'](_0x3bd67e);});if(_0x34a5e6[_0xc5803c(0x19e)]>0x0){const _0x3e8852=_0x34a5e6[_0xc5803c(0x170)]('、');_0x24be0f['push']('【当前（'+_0x50bc33['name']+_0xc5803c(0x158)+_0x3e8852+_0xc5803c(0x1cf)+_0x59569c+_0xc5803c(0x1c4)+_0x5ebc30+_0xc5803c(0x1ce));}}}return _0x24be0f[_0xc5803c(0x170)]('\x0a');}export function convertTablesToCsvString(){const _0x50fbe8=_0x195f36;!currentTablesState&&loadTables();if(!currentTablesState)return'';let _0x2ba9bf='';return currentTablesState[_0x50fbe8(0x1f1)]((_0x26ea94,_0x1a4cfd)=>{const _0x53fe58=_0x50fbe8;_0x2ba9bf+='\x0a*\x20'+_0x1a4cfd+':'+_0x26ea94[_0x53fe58(0x171)]+'\x0a',_0x2ba9bf+=_0x53fe58(0x17c)+(_0x26ea94['note']||'无')+'\x0a';const _0x78c2a5=_0x26ea94[_0x53fe58(0x171)][_0x53fe58(0x11d)](/\s/g,'')+'内容';_0x2ba9bf+='<'+_0x78c2a5+'>\x0a';const _0x120553=_0x26ea94[_0x53fe58(0x1ea)]['map']((_0x2f289f,_0x5f24e0)=>_0x5f24e0+':'+_0x2f289f)[_0x53fe58(0x170)](',');_0x2ba9bf+=_0x53fe58(0x1c3)+_0x120553+'\x0a';_0x26ea94[_0x53fe58(0x1d4)]['length']===0x0?_0x2ba9bf+=_0x53fe58(0x146):_0x26ea94['rows'][_0x53fe58(0x1f1)]((_0x528f19,_0x5a8af8)=>{const _0x2cdff9=_0x53fe58;if(Array[_0x2cdff9(0x200)](_0x528f19)){const _0x4a8cd8=_0x528f19[_0x2cdff9(0x1af)](_0x1ecf8f=>{const _0xee1783=_0x2cdff9;return _0x1ecf8f===null||_0x1ecf8f===undefined||_0x1ecf8f===''?'未知':_0x1ecf8f[_0xee1783(0x192)]();})['join'](',');_0x2ba9bf+=_0x5a8af8+','+_0x4a8cd8+'\x0a';}});const _0x4f2920=checkTableRules(_0x26ea94);_0x4f2920&&(_0x2ba9bf+=_0x4f2920+'\x0a'),_0x2ba9bf+='</'+_0x78c2a5+'>\x0a',_0x2ba9bf+='【增加】:\x20'+(_0x26ea94[_0x53fe58(0x111)]||'允许')+'\x0a',_0x2ba9bf+='【删除】:\x20'+(_0x26ea94[_0x53fe58(0x1b6)]||'允许')+'\x0a',_0x2ba9bf+=_0x53fe58(0x1be)+(_0x26ea94[_0x53fe58(0x173)]||'允许')+'\x0a',_0x1a4cfd<currentTablesState[_0x53fe58(0x19e)]-0x1&&(_0x2ba9bf+=_0x53fe58(0x118));}),_0x2ba9bf;}export function convertTablesToCsvStringForContentOnly(){const _0x22b665=_0x195f36,_0x53044f=getMemoryState();if(!_0x53044f||_0x53044f[_0x22b665(0x19e)]===0x0)return'';let _0x1d7de1='';return _0x53044f[_0x22b665(0x1f1)](_0x3931cf=>{const _0x25b17e=_0x22b665;_0x1d7de1+='\x0a<'+_0x3931cf[_0x25b17e(0x171)]+'>\x0a';const _0x30e36a=_0x3931cf[_0x25b17e(0x1ea)][_0x25b17e(0x1af)]((_0x4dc442,_0xc92f3d)=>String[_0x25b17e(0x178)](0x41+_0xc92f3d)+':'+_0x4dc442)[_0x25b17e(0x170)](',');_0x1d7de1+=_0x30e36a+'\x0a',Array[_0x25b17e(0x200)](_0x3931cf[_0x25b17e(0x1d4)])&&_0x3931cf[_0x25b17e(0x1d4)]['length']>0x0?_0x3931cf[_0x25b17e(0x1d4)]['forEach']((_0x4a33c2,_0x2280ad)=>{const _0x264249=_0x25b17e;if(Array['isArray'](_0x4a33c2)){const _0x2e01c7=_0x4a33c2[_0x264249(0x170)](',');_0x1d7de1+=_0x2280ad+0x1+':'+_0x2e01c7+'\x0a';}}):_0x1d7de1+='（该表当前内容为空）\x0a',_0x1d7de1+='</'+_0x3931cf[_0x25b17e(0x171)]+'>\x0a';}),_0x1d7de1[_0x22b665(0x1dd)]();}loadTables();export function getBatchFillerRuleTemplate(){const _0x2f5ba1=_0x195f36;return extension_settings[extensionName]?.[_0x2f5ba1(0x1a4)]??DEFAULT_AI_RULE_TEMPLATE;}export function saveBatchFillerRuleTemplate(_0x2cb1a6){const _0x168236=_0x195f36;extension_settings[extensionName][_0x168236(0x1a4)]=_0x2cb1a6,saveSettingsDebounced();}export function getBatchFillerFlowTemplate(){const _0x335921=_0x195f36;return extension_settings[extensionName]?.[_0x335921(0x10c)]??DEFAULT_AI_FLOW_TEMPLATE;}export function saveBatchFillerFlowTemplate(_0x443973){const _0x1e4991=_0x195f36;extension_settings[extensionName][_0x1e4991(0x10c)]=_0x443973,saveSettingsDebounced();}export function getAiFlowTemplateForInjection(){const _0x55c8af=_0x195f36;return extension_settings[extensionName]?.[_0x55c8af(0x15c)]??DEFAULT_AI_FLOW_TEMPLATE;}export async function updateTableFromText(_0x43e0f7){const _0x3df638=_0x195f36;if(!_0x43e0f7){log(_0x3df638(0x1c1),_0x3df638(0x1ba));return;}const _0x3e601a=_0x43e0f7[_0x3df638(0x161)](/<Amily2Edit>([\s\S]*?)<\/Amily2Edit>/);if(!_0x3e601a||!_0x3e601a[0x1]){log(_0x3df638(0x206),_0x3df638(0x1ba));return;}let _0x53e794=_0x3e601a[0x1][_0x3df638(0x11d)](/<!--|-->/g,'')[_0x3df638(0x1dd)]();if(!_0x53e794){log(_0x3df638(0x15e),_0x3df638(0x135));return;}const _0x224a92=_0x53e794[_0x3df638(0x18b)]('\x0a')[_0x3df638(0x10e)](_0x16d297=>_0x16d297['trim']()!=='');log('准备执行从AI返回的\x20'+_0x224a92['length']+_0x3df638(0x1ee),_0x3df638(0x135));const _0xde4f3c={'insertRow':(_0xf0f5ad,_0x17f0d2)=>{const _0x2bcc63=_0x3df638;log('执行AI指令:\x20insertRow(tableIndex='+_0xf0f5ad+',\x20data='+JSON[_0x2bcc63(0x10f)](_0x17f0d2)+')',_0x2bcc63(0x135)),insertRow(_0xf0f5ad,_0x17f0d2);},'deleteRow':(_0x48c48e,_0x5d9d61)=>{const _0x18f56a=_0x3df638;log('执行AI指令:\x20deleteRow(tableIndex='+_0x48c48e+_0x18f56a(0x197)+_0x5d9d61+')',_0x18f56a(0x135)),deleteRow(_0x48c48e,_0x5d9d61);},'updateRow':(_0x502d1a,_0x2354d9,_0x3aa8a7)=>{const _0x462e18=_0x3df638;log(_0x462e18(0x1c5)+_0x502d1a+_0x462e18(0x197)+_0x2354d9+_0x462e18(0x113)+JSON[_0x462e18(0x10f)](_0x3aa8a7)+')','info'),updateRow(_0x502d1a,_0x2354d9,_0x3aa8a7);}};try{const _0x2d1d77=Object['getPrototypeOf'](async function(){})[_0x3df638(0x16c)],_0x59fe67=new _0x2d1d77('runner','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20{\x20insertRow,\x20deleteRow,\x20updateRow\x20}\x20=\x20runner;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x53e794+_0x3df638(0x1b9));await _0x59fe67(_0xde4f3c),log(_0x3df638(0x1bd),_0x3df638(0x17b)),toastr[_0x3df638(0x17b)](_0x3df638(0x15b),_0x3df638(0x143)),document[_0x3df638(0x18a)](new CustomEvent(_0x3df638(0x1a5)));}catch(_0x4db48b){log(_0x3df638(0x205)+_0x4db48b[_0x3df638(0x194)],'error'),toastr['error'](_0x3df638(0x179)+_0x4db48b[_0x3df638(0x194)],_0x3df638(0x115));}}export function saveAiTemplate(_0x18d971){extension_settings[extensionName]['amily2_ai_template']=_0x18d971,saveSettingsDebounced();}export function getAiTemplate(){return getAiFlowTemplateForInjection();}function _0x57e9(_0x326f74,_0x3a8fad){const _0x1e48bb=_0x1e48();return _0x57e9=function(_0x57e9bb,_0x3bcb9e){_0x57e9bb=_0x57e9bb-0x108;let _0x11206f=_0x1e48bb[_0x57e9bb];return _0x11206f;},_0x57e9(_0x326f74,_0x3a8fad);}function exportPresetBase(_0x2805cf=![]){const _0x3e6e20=_0x195f36;if(!currentTablesState){log(_0x3e6e20(0x1ef),_0x3e6e20(0x208)),toastr[_0x3e6e20(0x208)](_0x3e6e20(0x10a));return;}let _0x36ef84,_0x252359,_0x4fbece;_0x2805cf?(_0x36ef84=JSON[_0x3e6e20(0x19a)](JSON[_0x3e6e20(0x10f)](currentTablesState)),_0x252359='Amily2-Table-Preset-v2.0-full',_0x4fbece=_0x3e6e20(0x196)):(_0x36ef84=currentTablesState['map'](_0x625b29=>({'name':_0x625b29[_0x3e6e20(0x171)],'headers':_0x625b29['headers'],'note':_0x625b29[_0x3e6e20(0x186)],'rule_add':_0x625b29['rule_add'],'rule_delete':_0x625b29[_0x3e6e20(0x1b6)],'rule_update':_0x625b29[_0x3e6e20(0x173)],'charLimitRules':_0x625b29['charLimitRules']||{},'rowLimitRule':_0x625b29[_0x3e6e20(0x1e1)]||0x0,'rows':[]})),_0x252359=_0x3e6e20(0x13d),_0x4fbece='纯净预设');const _0x5b69e0={'version':_0x3e6e20(0x13b),'batchFillerRuleTemplate':getBatchFillerRuleTemplate(),'batchFillerFlowTemplate':getBatchFillerFlowTemplate(),'tables':_0x36ef84},_0x3b6722=new Blob([JSON[_0x3e6e20(0x10f)](_0x5b69e0,null,0x2)],{'type':_0x3e6e20(0x149)}),_0x15efbd=URL[_0x3e6e20(0x1f7)](_0x3b6722),_0x5472d9=document['createElement']('a');_0x5472d9[_0x3e6e20(0x150)]=_0x15efbd,_0x5472d9[_0x3e6e20(0x12f)]=_0x3e6e20(0x1c9)+_0x4fbece+'-'+new Date()[_0x3e6e20(0x1b0)]()[_0x3e6e20(0x1df)](0x0,0xa)+_0x3e6e20(0x1fa),document['body']['appendChild'](_0x5472d9),_0x5472d9[_0x3e6e20(0x12c)](),document[_0x3e6e20(0x1bc)]['removeChild'](_0x5472d9),URL['revokeObjectURL'](_0x15efbd),log('【'+_0x4fbece+_0x3e6e20(0x1e0),'success'),toastr['success']('【'+_0x4fbece+_0x3e6e20(0x156),'导出成功');}export function exportPreset(){exportPresetBase(![]);}export function exportPresetFull(){exportPresetBase(!![]);}export function importPreset(_0x42da0a){const _0x74ab7b=_0x195f36,_0x3dfe61=document[_0x74ab7b(0x148)](_0x74ab7b(0x160));_0x3dfe61[_0x74ab7b(0x12a)]=_0x74ab7b(0x152),_0x3dfe61[_0x74ab7b(0x19c)]='.json',_0x3dfe61['onchange']=_0x31dc6d=>{const _0x242199=_0x74ab7b,_0x49a9c3=_0x31dc6d[_0x242199(0x16b)][_0x242199(0x140)][0x0];if(!_0x49a9c3)return;const _0x57aa68=new FileReader();_0x57aa68[_0x242199(0x11a)]=_0x53230f=>{const _0x39931a=_0x242199;try{const _0xc9aa41=JSON['parse'](_0x53230f[_0x39931a(0x16b)][_0x39931a(0x1a3)]);if(!_0xc9aa41[_0x39931a(0x13a)]||!Array[_0x39931a(0x200)](_0xc9aa41['tables']))throw new Error('文件格式无效或缺少版本号/表格数据。');const _0x713bd8=window[_0x39931a(0x127)](_0x39931a(0x1f0));if(!_0x713bd8){log(_0x39931a(0x172),_0x39931a(0x135)),toastr[_0x39931a(0x135)](_0x39931a(0x1a8));return;}if(_0xc9aa41[_0x39931a(0x13a)]===_0x39931a(0x13b))saveBatchFillerRuleTemplate(_0xc9aa41[_0x39931a(0x169)]||''),saveBatchFillerFlowTemplate(_0xc9aa41[_0x39931a(0x167)]||''),saveAiTemplate(_0xc9aa41[_0x39931a(0x1ec)]||'');else{if(_0xc9aa41[_0x39931a(0x147)]!==undefined&&_0xc9aa41[_0x39931a(0x14d)]!==undefined)saveBatchFillerRuleTemplate(_0xc9aa41['aiRuleTemplate']||''),saveBatchFillerFlowTemplate(_0xc9aa41['aiFlowTemplate']||''),saveAiTemplate(_0xc9aa41['aiFlowTemplate']||'');else _0xc9aa41[_0x39931a(0x15a)]?(saveBatchFillerRuleTemplate(''),saveBatchFillerFlowTemplate(_0xc9aa41[_0x39931a(0x15a)]||''),saveAiTemplate(_0xc9aa41[_0x39931a(0x15a)]||'')):log(_0x39931a(0x1d0),_0x39931a(0x1ba));}const _0x256971=_0xc9aa41['tables'];_0x256971[_0x39931a(0x1f1)](_0x112a12=>{const _0x4d87e7=_0x39931a;if(_0x112a12[_0x4d87e7(0x171)]===undefined||_0x112a12[_0x4d87e7(0x1ea)]===undefined||_0x112a12[_0x4d87e7(0x1d4)]===undefined)throw new Error(_0x4d87e7(0x11f)+JSON[_0x4d87e7(0x10f)](_0x112a12));if(_0x112a12[_0x4d87e7(0x186)]===undefined)_0x112a12[_0x4d87e7(0x186)]='无';if(_0x112a12[_0x4d87e7(0x111)]===undefined)_0x112a12[_0x4d87e7(0x111)]='允许';if(_0x112a12[_0x4d87e7(0x1b6)]===undefined)_0x112a12[_0x4d87e7(0x1b6)]='允许';if(_0x112a12[_0x4d87e7(0x173)]===undefined)_0x112a12['rule_update']='允许';if(_0x112a12[_0x4d87e7(0x16f)]&&!_0x112a12[_0x4d87e7(0x17a)])_0x112a12[_0x4d87e7(0x17a)]={},_0x112a12[_0x4d87e7(0x16f)][_0x4d87e7(0x130)]!==-0x1&&_0x112a12['charLimitRule']['limit']>0x0&&(_0x112a12[_0x4d87e7(0x17a)][_0x112a12['charLimitRule'][_0x4d87e7(0x130)]]=_0x112a12[_0x4d87e7(0x16f)]['limit']);else _0x112a12[_0x4d87e7(0x17a)]===undefined&&(_0x112a12[_0x4d87e7(0x17a)]={});delete _0x112a12['charLimitRule'],_0x112a12[_0x4d87e7(0x1e1)]===undefined&&(_0x112a12[_0x4d87e7(0x1e1)]=0x0);}),setMemoryState(_0x256971);const _0x1c9279=getContext();if(_0x1c9279[_0x39931a(0x1da)]&&_0x1c9279[_0x39931a(0x1da)]['length']>0x0){const _0x13dcb4=_0x1c9279[_0x39931a(0x1da)][_0x1c9279['chat'][_0x39931a(0x19e)]-0x1];saveStateToMessage(getMemoryState(),_0x13dcb4)&&(saveChat(),log('导入的预设已强制写入最新消息并立即保存。','success'));}else saveChatDebounced();log(_0x39931a(0x139),_0x39931a(0x17b)),toastr[_0x39931a(0x17b)](_0x39931a(0x134),_0x39931a(0x188)),typeof _0x42da0a===_0x39931a(0x180)&&_0x42da0a();}catch(_0x4ad72f){log(_0x39931a(0x1c7)+_0x4ad72f['message'],'error'),toastr[_0x39931a(0x208)](_0x39931a(0x1d5)+_0x4ad72f['message'],'错误');}},_0x57aa68['readAsText'](_0x49a9c3);},_0x3dfe61[_0x74ab7b(0x12c)]();}export async function rollbackState(){const _0x16e389=_0x195f36,_0x49311f=getContext();if(!_0x49311f||!_0x49311f[_0x16e389(0x1da)]||_0x49311f[_0x16e389(0x1da)][_0x16e389(0x19e)]<0x2)return log(_0x16e389(0x1e3),'warn'),toastr['warning']('聊天记录不足，无法执行回退操作。'),![];const _0x516942=_0x49311f[_0x16e389(0x1da)],_0x5a81c2=_0x516942[_0x16e389(0x19e)]-0x1,_0x1c70f8=_0x516942[_0x5a81c2];log(_0x16e389(0x145)+(_0x5a81c2-0x1)+'\x20条消息加载表格状态...',_0x16e389(0x135));const _0x5ab766=loadTables(_0x5a81c2);if(!_0x5ab766)return log(_0x16e389(0x1a7),_0x16e389(0x208)),toastr[_0x16e389(0x208)](_0x16e389(0x207)),![];setMemoryState(_0x5ab766);if(saveStateToMessage(_0x5ab766,_0x1c70f8))await saveChat(),log(_0x16e389(0x1ed),_0x16e389(0x17b));else return log(_0x16e389(0x153),'error'),toastr['error'](_0x16e389(0x1d7)),![];return renderTables(),updateOrInsertTableInChat(),log(_0x16e389(0x155),_0x16e389(0x135)),!![];}export async function rollbackAndRefill(){const _0x225733=_0x195f36;toastr[_0x225733(0x135)](_0x225733(0x1b8));const _0x11a99e=await rollbackState();if(!_0x11a99e){toastr['error'](_0x225733(0x1eb));return;}toastr['success'](_0x225733(0x1cb));const _0x4c2230=getContext(),_0x21e61b=_0x4c2230['chat'][_0x4c2230[_0x225733(0x1da)][_0x225733(0x19e)]-0x1];try{await fillWithSecondaryApi(_0x21e61b,!![]),log(_0x225733(0x129),_0x225733(0x17b));}catch(_0x52ddd7){log(_0x225733(0x1f5)+_0x52ddd7[_0x225733(0x194)],_0x225733(0x208)),toastr['error']('重新填表失败:\x20'+_0x52ddd7[_0x225733(0x194)]);}}export function isCurrentTablesEmpty(){const _0x2434af=_0x195f36,_0x2df12a=getMemoryState();if(!_0x2df12a||_0x2df12a[_0x2434af(0x19e)]===0x0)return!![];return _0x2df12a[_0x2434af(0x193)](_0x3d05d1=>!_0x3d05d1['rows']||_0x3d05d1[_0x2434af(0x1d4)][_0x2434af(0x19e)]===0x0);}export function clearGlobalPreset(){const _0x445dd9=_0x195f36;if(extension_settings[extensionName]&&extension_settings[extensionName][_0x445dd9(0x189)]){const _0xeb3bae=window[_0x445dd9(0x127)](_0x445dd9(0x11e));_0xeb3bae?(delete extension_settings[extensionName][_0x445dd9(0x189)],saveSettingsDebounced(),log(_0x445dd9(0x1f8),_0x445dd9(0x17b)),toastr[_0x445dd9(0x17b)](_0x445dd9(0x187),_0x445dd9(0x1e6))):(log(_0x445dd9(0x1f2),_0x445dd9(0x135)),toastr[_0x445dd9(0x135)](_0x445dd9(0x154)));}else log(_0x445dd9(0x1e9),'info'),toastr[_0x445dd9(0x135)]('当前没有设置全局预设。','提示');}export function importGlobalPreset(_0x20b739){const _0x1c03cf=_0x195f36,_0x2ef6e5=document[_0x1c03cf(0x148)](_0x1c03cf(0x160));_0x2ef6e5[_0x1c03cf(0x12a)]='file',_0x2ef6e5[_0x1c03cf(0x19c)]=_0x1c03cf(0x1fa),_0x2ef6e5[_0x1c03cf(0x151)]=_0x2d4616=>{const _0x52ea47=_0x1c03cf,_0x5c153a=_0x2d4616[_0x52ea47(0x16b)][_0x52ea47(0x140)][0x0];if(!_0x5c153a)return;const _0x19eb2f=new FileReader();_0x19eb2f[_0x52ea47(0x11a)]=_0x10b19d=>{const _0x4295b5=_0x52ea47;try{const _0xe9a512=JSON[_0x4295b5(0x19a)](_0x10b19d[_0x4295b5(0x16b)]['result']);if(!_0xe9a512[_0x4295b5(0x13a)]||!Array[_0x4295b5(0x200)](_0xe9a512[_0x4295b5(0x138)]))throw new Error(_0x4295b5(0x16e));const _0xbe7bcd=window[_0x4295b5(0x127)](_0x4295b5(0x14e));if(!_0xbe7bcd){log(_0x4295b5(0x195),_0x4295b5(0x135)),toastr[_0x4295b5(0x135)](_0x4295b5(0x154));return;}const _0x54c89f=_0xe9a512[_0x4295b5(0x138)][_0x4295b5(0x1af)](_0x2c6b22=>({'name':_0x2c6b22[_0x4295b5(0x171)],'headers':_0x2c6b22[_0x4295b5(0x1ea)],'note':_0x2c6b22[_0x4295b5(0x186)],'rule_add':_0x2c6b22[_0x4295b5(0x111)],'rule_delete':_0x2c6b22['rule_delete'],'rule_update':_0x2c6b22[_0x4295b5(0x173)],'rows':[]}));!extension_settings[extensionName]&&(extension_settings[extensionName]={});extension_settings[extensionName]['global_table_preset']={'version':_0xe9a512[_0x4295b5(0x13a)],'tables':_0x54c89f,'batchFillerRuleTemplate':_0xe9a512['batchFillerRuleTemplate'],'batchFillerFlowTemplate':_0xe9a512[_0x4295b5(0x167)]},saveSettingsDebounced();if(_0xe9a512[_0x4295b5(0x13a)]===_0x4295b5(0x13b))saveBatchFillerRuleTemplate(_0xe9a512[_0x4295b5(0x169)]||''),saveBatchFillerFlowTemplate(_0xe9a512[_0x4295b5(0x167)]||''),saveAiTemplate(_0xe9a512[_0x4295b5(0x1ec)]||'');else{if(_0xe9a512[_0x4295b5(0x147)]!==undefined&&_0xe9a512[_0x4295b5(0x14d)]!==undefined)saveBatchFillerRuleTemplate(_0xe9a512['aiRuleTemplate']||''),saveBatchFillerFlowTemplate(_0xe9a512[_0x4295b5(0x14d)]||''),saveAiTemplate(_0xe9a512[_0x4295b5(0x14d)]||'');else _0xe9a512['aiTemplate']&&(saveBatchFillerRuleTemplate(''),saveBatchFillerFlowTemplate(_0xe9a512[_0x4295b5(0x15a)]||''),saveAiTemplate(_0xe9a512[_0x4295b5(0x15a)]||''));}log(_0x4295b5(0x1a1),_0x4295b5(0x17b)),toastr[_0x4295b5(0x17b)]('全局预设已设置！新聊天将默认使用此预设。',_0x4295b5(0x131)),typeof _0x20b739===_0x4295b5(0x180)&&_0x20b739();}catch(_0x40b1d5){log(_0x4295b5(0x13f)+_0x40b1d5[_0x4295b5(0x194)],_0x4295b5(0x208)),toastr['error'](_0x4295b5(0x1d5)+_0x40b1d5[_0x4295b5(0x194)],'错误');}},_0x19eb2f['readAsText'](_0x5c153a);},_0x2ef6e5[_0x1c03cf(0x12c)]();}
