'use strict';const _0x4826de=_0x2dc8;(function(_0x5275b7,_0x2624d9){const _0x46f463=_0x2dc8,_0x53a934=_0x5275b7();while(!![]){try{const _0x5209ee=-parseInt(_0x46f463(0x156))/0x1*(-parseInt(_0x46f463(0x16a))/0x2)+parseInt(_0x46f463(0xfe))/0x3*(parseInt(_0x46f463(0x18e))/0x4)+parseInt(_0x46f463(0x1a8))/0x5*(-parseInt(_0x46f463(0x13b))/0x6)+parseInt(_0x46f463(0x151))/0x7*(parseInt(_0x46f463(0x113))/0x8)+-parseInt(_0x46f463(0x1d0))/0x9*(-parseInt(_0x46f463(0x1b8))/0xa)+-parseInt(_0x46f463(0x106))/0xb*(parseInt(_0x46f463(0x1b2))/0xc)+parseInt(_0x46f463(0x143))/0xd;if(_0x5209ee===_0x2624d9)break;else _0x53a934['push'](_0x53a934['shift']());}catch(_0x427fd4){_0x53a934['push'](_0x53a934['shift']());}}}(_0x4d15,0xb0da3));import{extension_prompt_roles,setExtensionPrompt}from'/script.js';import*as _0xfd5dee from'./utils/context-utils.js';import{getCollectionIdInfo,getCharacterId,getCharacterStableId}from'./utils/context-utils.js';import{defaultSettings as _0xd3e1e}from'./rag-settings.js';import*as _0x9fe58b from'./ingestion-manager.js';import{getEmbeddings,fetchEmbeddingModels as _0x3f19f5,fetchRerankModels as _0x40ae91,executeRerank,testApiConnection as _0x23d63}from'./rag-api.js';import{superSort}from'./super-sorter.js';const MODULE_NAME='hanlinyuan-rag-core',OFFICIAL_REARRANGE_CHAT_FUNCTION_NAME='vectors_rearrangeChat',GLOBAL_SCOPE_ID='_global';let context=null,settings=null,lockedCollectionId=null;function filterWorldbooks(_0x4f92a8,_0x2ffda8){const _0x4552c1=_0x2dc8;if(!_0x4f92a8||!_0x4f92a8['trim']())return _0x2ffda8;const _0x500500=_0x4f92a8[_0x4552c1(0x163)]()['trim']();return _0x2ffda8[_0x4552c1(0x150)](_0x13cad5=>{const _0x35cb1a=_0x4552c1;return _0x13cad5[_0x35cb1a(0x163)]()[_0x35cb1a(0x10e)](_0x500500)||containsPinyinMatch(_0x13cad5,_0x500500);});}function filterWorldbookEntries(_0x5ab25f,_0x4962d8){const _0x521ad9=_0x2dc8;if(!_0x5ab25f||!_0x5ab25f[_0x521ad9(0x1e5)]())return _0x4962d8;const _0xae5ff6=_0x5ab25f[_0x521ad9(0x163)]()[_0x521ad9(0x1e5)]();return _0x4962d8['filter'](_0x49ad8c=>{const _0x2bb3d7=_0x521ad9,_0x41bfea=[_0x49ad8c[_0x2bb3d7(0x102)]||'',_0x49ad8c[_0x2bb3d7(0x1bf)]||'',_0x49ad8c[_0x2bb3d7(0x1aa)]||''][_0x2bb3d7(0x161)]('\x20')[_0x2bb3d7(0x163)]();return _0x41bfea['includes'](_0xae5ff6)||containsPinyinMatch(_0x49ad8c[_0x2bb3d7(0x102)]||'',_0xae5ff6);});}function containsPinyinMatch(_0x1df0fa,_0xe9309c){const _0x450b8f=_0x2dc8,_0x11cf2e={'世界书':_0x450b8f(0x15b),'条目':_0x450b8f(0x18b),'编纂':_0x450b8f(0x169),'搜索':'sousuo'},_0x1eac1d=_0x11cf2e[_0x1df0fa];return _0x1eac1d&&_0x1eac1d[_0x450b8f(0x10e)](_0xe9309c);}function highlightSearchMatch(_0x53a086,_0x33348d){const _0x49b6ab=_0x2dc8;if(!_0x33348d||!_0x33348d[_0x49b6ab(0x1e5)]())return _0x53a086;const _0xdc935d=new RegExp('('+_0x33348d[_0x49b6ab(0x14e)](/[.*+?^${}()|[\]\\]/g,'\x5c$&')+')','gi');return _0x53a086['replace'](_0xdc935d,_0x49b6ab(0x1da));}function debounce(_0x3c23c9,_0x154f00){let _0xb42760;return function _0xea990c(..._0x1529c7){const _0x218c70=()=>{clearTimeout(_0xb42760),_0x3c23c9(..._0x1529c7);};clearTimeout(_0xb42760),_0xb42760=setTimeout(_0x218c70,_0x154f00);};}export{initialize,getSettings,saveSettings,resetSettings,_0x23d63 as testApiConnection,_0x3f19f5 as fetchEmbeddingModels,_0x40ae91 as fetchRerankModels,getVectorCount,purgeStorage,getMessagesForCondensation,processCondensation,ingestTextToHanlinyuan,getCollectionId,toggleSessionLock,isSessionLocked,getLockedSessionInfo,addKnowledgeBase,removeKnowledgeBase,getLocalKnowledgeBases,getGlobalKnowledgeBases,toggleKnowledgeBase,moveKnowledgeBase,filterWorldbooks,filterWorldbookEntries,highlightSearchMatch,debounce};function initialize(){const _0x3a75b4=_0x2dc8;context=SillyTavern[_0x3a75b4(0x1c7)]();if(!context){console['error'](_0x3a75b4(0xf4));return;}settings=getSettings(),!window['hanlinyuanRagProcessor']&&(window['hanlinyuanRagProcessor']={}),window[_0x3a75b4(0x1a6)][_0x3a75b4(0x1ec)]=rearrangeChat,window[_0x3a75b4(0x1a6)][_0x3a75b4(0x1c6)]=!![],console[_0x3a75b4(0xff)]('翰林院忆识核心已启动\x20(V5.2-集成版)，已注册到全局\x20hanlinyuanRagProcessor\x20对象。');}async function ingestTextToHanlinyuan(_0x779204,_0x1164b6='manual',_0x16568b={},_0x13daed=()=>{},_0x455cbd=null,_0x43464a=()=>{},_0x3645e7=()=>{},_0x2d9e5f=null,_0x35b44a=0x0){const _0x516d7a=_0x2dc8;if(!_0x779204||!_0x779204[_0x516d7a(0x1e5)]())return{'success':![],'error':_0x516d7a(0xe8)};if(!settings)return{'success':![],'error':'核心未初始化'};try{const _0x3b1c71=getCollectionIdInfo(),_0x5ccff3=await _0x47c456();if(_0x3b1c71[_0x516d7a(0xf2)]&&_0x3b1c71[_0x516d7a(0xf2)]===_0x5ccff3&&_0x3b1c71[_0x516d7a(0xf2)]!==_0x3b1c71[_0x516d7a(0x12d)]){const _0x36e697=confirm(_0x516d7a(0x10d));if(_0x36e697)_0x43464a(_0x516d7a(0x168)+_0x3b1c71[_0x516d7a(0xf2)],_0x516d7a(0x1ae)),await purgeStorage(_0x3b1c71['oldId']),_0x43464a(_0x516d7a(0x182),_0x516d7a(0x148));else return _0x43464a(_0x516d7a(0x14a),_0x516d7a(0x196)),toastr[_0x516d7a(0x196)](_0x516d7a(0x15f)),{'success':![],'error':_0x516d7a(0x1ef)};}let _0x39ebab,_0x5eddb2;const _0x2667f4=new Date()[_0x516d7a(0x153)](_0x516d7a(0x176),{'hour12':![]}),_0x1a310f=getCharacterName()||_0x516d7a(0x10f);switch(_0x1164b6){case _0x516d7a(0x1c3):const _0x51be02=_0x16568b[_0x516d7a(0x12e)]||{},_0x26ccfa=_0x51be02[_0x516d7a(0x1c5)]??'?',_0x254943=_0x51be02[_0x516d7a(0x1f0)]===0x0?'末':_0x51be02[_0x516d7a(0x1f0)]??'?';_0x39ebab=_0x1a310f+':\x20'+_0x26ccfa+'楼-'+_0x254943+'楼';break;case'lorebook':const _0x5ee52f=_0x16568b[_0x516d7a(0xed)]||_0x516d7a(0x1d8);if(_0x16568b[_0x516d7a(0x178)]&&_0x16568b['entryName']['includes'](_0x516d7a(0x139)))_0x16568b[_0x516d7a(0x178)]=_0x516d7a(0x1a9);else _0x16568b['entryName']&&_0x16568b[_0x516d7a(0x178)][_0x516d7a(0x10e)](_0x516d7a(0x19b))&&(_0x16568b[_0x516d7a(0x178)]=_0x516d7a(0x117));const _0x34b684=_0x16568b[_0x516d7a(0x178)]||'未知条目';_0x39ebab=_0x5ee52f+':\x20'+_0x34b684;break;case'novel':_0x39ebab=_0x516d7a(0x137)+(_0x16568b[_0x516d7a(0x1a4)]||'未知小说');break;case'manual':default:_0x39ebab=_0x516d7a(0x14f)+_0x2667f4;break;}const _0x5eb899=Object[_0x516d7a(0x18f)](getKnowledgeBases()),_0x40313c=_0x5eb899[_0x516d7a(0x107)](_0xf0885d=>_0xf0885d[_0x516d7a(0x185)]===_0x39ebab);if(_0x40313c)_0x5eddb2=_0x40313c['id'],_0x43464a(_0x516d7a(0x154)+_0x39ebab+_0x516d7a(0x13f),'info');else{_0x43464a(_0x516d7a(0x1e9)+_0x39ebab+_0x516d7a(0x183),_0x516d7a(0x196));const _0x2af7be=addKnowledgeBase(_0x39ebab);_0x5eddb2=_0x2af7be['id'];}const _0x156fbf=getCharacterStableId(),_0x1d9667=_0x156fbf+'_'+_0x5eddb2;_0x43464a(_0x516d7a(0x13c)+_0x39ebab+_0x516d7a(0x155)+_0x1d9667+')',_0x516d7a(0x148)),_0x43464a(_0x516d7a(0x131)+_0x1d9667,'info'),_0x13daed({'message':'正在智能分块...','processed':0x0,'total':0x1});const _0x57a68e=splitIntoChunks(_0x779204,_0x1164b6,_0x16568b),_0x32a3ad=_0x57a68e['length'];if(_0x455cbd?.[_0x516d7a(0x127)])throw new Error(_0x516d7a(0x11a));_0x43464a('[翰林院-核心]\x20将来源\x27'+_0x39ebab+_0x516d7a(0xee)+_0x32a3ad+_0x516d7a(0xf0),'info');if(_0x32a3ad===0x0)return{'success':!![],'count':0x0};const _0x592c75=settings[_0x516d7a(0x16f)][_0x516d7a(0x1b1)]||0x5;let _0x30bb50=_0x35b44a;for(let _0x3ffcb1=_0x35b44a;_0x3ffcb1<_0x32a3ad;_0x3ffcb1+=_0x592c75){if(_0x455cbd?.[_0x516d7a(0x127)])throw new Error(_0x516d7a(0x11a));const _0xe82546=_0x57a68e[_0x516d7a(0x1d6)](_0x3ffcb1,_0x3ffcb1+_0x592c75);_0x13daed({'message':'正在处理\x20'+(_0x3ffcb1+0x1)+'-'+(_0x3ffcb1+_0xe82546['length'])+'\x20块','processed':_0x3ffcb1,'total':_0x32a3ad});const _0x597f47=_0xe82546['map'](_0x3fbd4b=>_0x3fbd4b['text']),_0x32b5dc=await getEmbeddings(_0x597f47,_0x455cbd);if(_0x455cbd?.[_0x516d7a(0x127)])throw new Error('AbortError');if(_0xe82546['length']!==_0x32b5dc[_0x516d7a(0x145)])throw new Error('文本块和向量数量不匹配');const _0x37c03d=_0xe82546[_0x516d7a(0x19f)]((_0x44a5ac,_0x48cfef)=>({..._0x44a5ac,'vector':_0x32b5dc[_0x48cfef]}));await insertVectors(_0x37c03d,_0x455cbd,_0x1d9667),_0x30bb50+=_0xe82546[_0x516d7a(0x145)],_0x2d9e5f&&_0x9fe58b[_0x516d7a(0x1ac)](_0x2d9e5f,_0x30bb50,_0x32a3ad),await _0x3645e7();}return _0x2d9e5f&&_0x9fe58b[_0x516d7a(0x1e7)](_0x2d9e5f),_0x43464a('[翰林院-核心]\x20成功插入\x20'+_0x30bb50+_0x516d7a(0x1eb),_0x516d7a(0x148)),{'success':!![],'count':_0x30bb50};}catch(_0x64f4ac){if(_0x64f4ac['name']===_0x516d7a(0x11a)){_0x43464a(_0x516d7a(0x19e),_0x516d7a(0x1ae));throw _0x64f4ac;}return console[_0x516d7a(0x135)]('[翰林院-核心]\x20ingestTextToHanlinyuan\x20失败:',_0x64f4ac),_0x43464a(_0x516d7a(0x1cd)+_0x64f4ac[_0x516d7a(0x181)],_0x516d7a(0x135)),{'success':![],'error':_0x64f4ac[_0x516d7a(0x181)]};}}function getSettings(){const _0x26fe37=_0x2dc8;if(!context||!context[_0x26fe37(0x1e8)])return structuredClone(_0xd3e1e);let _0x4322d3=context[_0x26fe37(0x1e8)][MODULE_NAME];!_0x4322d3&&(_0x4322d3={},context['extensionSettings'][MODULE_NAME]=_0x4322d3);_0x4322d3[_0x26fe37(0xf5)]===undefined&&(_0x4322d3[_0x26fe37(0xf5)]={});_0x4322d3['knowledgeBases']===undefined&&(_0x4322d3[_0x26fe37(0x11c)]={});for(const _0x44cd2c in _0xd3e1e){if(_0x4322d3[_0x44cd2c]===undefined)_0x4322d3[_0x44cd2c]=structuredClone(_0xd3e1e[_0x44cd2c]);else{if(typeof _0xd3e1e[_0x44cd2c]===_0x26fe37(0x12b)&&!Array[_0x26fe37(0x1d3)](_0xd3e1e[_0x44cd2c])&&_0xd3e1e[_0x44cd2c]!==null)for(const _0x5cdf63 in _0xd3e1e[_0x44cd2c]){_0x4322d3[_0x44cd2c][_0x5cdf63]===undefined&&(_0x4322d3[_0x44cd2c][_0x5cdf63]=_0xd3e1e[_0x44cd2c][_0x5cdf63]);}}}return _0x4322d3;}function saveSettings(){const _0x44c042=_0x2dc8;if(context)context[_0x44c042(0x16c)]();}function resetSettings(){const _0x482d6a=_0x2dc8;context&&(context[_0x482d6a(0x1e8)][MODULE_NAME]=structuredClone(_0xd3e1e),saveSettings());}function showNotification(_0x1e95cd,_0x504f21=_0x4826de(0x196)){toastr[_0x504f21](_0x1e95cd);}function getTagForSource(_0x2a97e1){const _0x37997b=_0x4826de;switch(_0x2a97e1){case _0x37997b(0x1c3):return _0x37997b(0x125);case _0x37997b(0x103):return _0x37997b(0x1ba);case _0x37997b(0x1d4):return _0x37997b(0x18c);case _0x37997b(0xfd):return _0x37997b(0x1a7);default:return'资料';}}function splitIntoChunks(_0x5ea746,_0x24f062,_0x174e30={}){const _0x4b02ca=_0x4826de;switch(_0x24f062){case _0x4b02ca(0xfd):return _chunkForNovel(_0x5ea746,_0x174e30);case _0x4b02ca(0x1c3):return _chunkForChatHistory(_0x5ea746,_0x174e30);case'lorebook':return _chunkForLorebook(_0x5ea746,_0x174e30);case _0x4b02ca(0x1d4):return _chunkForManual(_0x5ea746,_0x174e30);default:console[_0x4b02ca(0x1ae)]('[翰林院-分块]\x20未知的来源类型\x20\x27'+_0x24f062+_0x4b02ca(0x15c));return _chunkForManual(_0x5ea746,{..._0x174e30,'sourceName':_0x174e30['sourceName']||'未知来源'});}}function _chunkForNovel(_0x116afb,_0x337863){const _0x2c4d67=_0x4826de,{chunkSize:_0x1712c7,overlap:_0x4be31a}=settings['advanced'],{sourceName:sourceName='小说'}=_0x337863,_0x318296=[];if(!_0x116afb||_0x1712c7<=0x0)return _0x318296;const _0xd97e9a=/(第\s*[一二三四五六七八九十百千万零\d]+\s*卷)/gim,_0xbd20e9=/(第\s*[一二三四五六七八九十百千万零\d]+\s*[章回节部])|^(Chapter\s+\d+)/gim;let _0x6ce44=0x0;const _0x5ddb70=_0x116afb['split']('\x0a');let _0x20c2c4=_0x2c4d67(0x1ca),_0x2d4d2b=_0x2c4d67(0x141),_0x63d565=[];function _0x238c65(){const _0x363591=_0x2c4d67;if(_0x63d565[_0x363591(0x145)]===0x0)return;const _0x546835=_0x63d565[_0x363591(0x161)]('\x0a');let _0x2556e4=0x0,_0x32e358=0x1;while(_0x2556e4<_0x546835['length']){const _0x50d006=Math[_0x363591(0x1cc)](_0x2556e4+_0x1712c7,_0x546835[_0x363591(0x145)]),_0xc09843=_0x546835[_0x363591(0x1bd)](_0x2556e4,_0x50d006);if(_0xc09843[_0x363591(0x1e5)]()['length']>0x0){const _0x41e955={'source':_0x363591(0xfd),'sourceName':sourceName,'timestamp':new Date()['toISOString'](),'globalIndex':_0x6ce44++,'volume':_0x20c2c4,'chapter':_0x2d4d2b,'section':_0x32e358},_0x37611e=getTagForSource(_0x363591(0xfd)),_0x5f0844=_0x363591(0x149)+sourceName+',\x20'+_0x20c2c4+',\x20'+_0x2d4d2b+_0x363591(0x115)+_0x32e358+'节]',_0x397cf3='<'+_0x37611e+'>\x0a'+_0x5f0844+'\x0a'+_0xc09843+_0x363591(0x114)+_0x37611e+'>';_0x318296[_0x363591(0x16e)]({'text':_0x397cf3,'metadata':_0x41e955}),_0x32e358++;}_0x2556e4+=_0x1712c7-_0x4be31a;if(_0x2556e4>=_0x546835[_0x363591(0x145)])break;}_0x63d565=[];}for(const _0xf751f1 of _0x5ddb70){const _0x541642=_0xf751f1[_0x2c4d67(0x1e5)]();if(_0xd97e9a[_0x2c4d67(0x126)](_0x541642))_0x238c65(),_0x20c2c4=_0x541642,_0x2d4d2b=_0x2c4d67(0x141);else _0xbd20e9[_0x2c4d67(0x126)](_0x541642)?(_0x238c65(),_0x2d4d2b=_0x541642):_0x63d565['push'](_0xf751f1);}_0x238c65();if(_0x318296[_0x2c4d67(0x145)]===0x0&&_0x116afb[_0x2c4d67(0x145)]>0x0){let _0x3445be=0x0,_0x449fab=0x1;while(_0x3445be<_0x116afb[_0x2c4d67(0x145)]){const _0x38dc7c=Math[_0x2c4d67(0x1cc)](_0x3445be+_0x1712c7,_0x116afb['length']),_0x406b19=_0x116afb[_0x2c4d67(0x1bd)](_0x3445be,_0x38dc7c),_0x516aa7={'source':_0x2c4d67(0xfd),'sourceName':sourceName,'timestamp':new Date()[_0x2c4d67(0x17a)](),'globalIndex':_0x318296[_0x2c4d67(0x145)],'volume':_0x2c4d67(0x1ca),'chapter':_0x2c4d67(0x141),'section':_0x449fab},_0x2eca9d=getTagForSource(_0x2c4d67(0xfd)),_0x5223c9=_0x2c4d67(0x149)+sourceName+_0x2c4d67(0x1e6)+_0x449fab+'节]',_0x33e8e3='<'+_0x2eca9d+'>\x0a'+_0x5223c9+'\x0a'+_0x406b19+_0x2c4d67(0x114)+_0x2eca9d+'>';_0x318296[_0x2c4d67(0x16e)]({'text':_0x33e8e3,'metadata':_0x516aa7}),_0x449fab++,_0x3445be+=_0x1712c7-_0x4be31a;}}return _0x318296;}function _chunkForChatHistory(_0x2dec30,_0x18ae7e){const _0x5413ca=_0x4826de,{chunkSize:_0x1078c6,overlap:_0x502e29}=settings[_0x5413ca(0x1a1)],{floor:_0x1432ca,is_user:_0x2862a4,timestamp:_0x5c556b}=_0x18ae7e,_0x5752e3=[];if(!_0x2dec30||_0x1078c6<=0x0)return _0x5752e3;let _0x30a474=0x1,_0x22b9df=0x0;while(_0x22b9df<_0x2dec30[_0x5413ca(0x145)]){const _0x219e31=Math['min'](_0x22b9df+_0x1078c6,_0x2dec30[_0x5413ca(0x145)]),_0x4062c7=_0x2dec30['substring'](_0x22b9df,_0x219e31),_0x3a7129=_0x5413ca(0x1bc)+_0x1432ca+_0x5413ca(0x115)+_0x30a474+_0x5413ca(0x1d1),_0x2c61b6=getTagForSource(_0x5413ca(0x1c3)),_0x5109ec='<'+_0x2c61b6+'>\x0a'+_0x3a7129+'\x0a'+_0x4062c7+_0x5413ca(0x114)+_0x2c61b6+'>';_0x5752e3['push']({'text':_0x5109ec,'metadata':{'source':_0x5413ca(0x1c3),'sourceName':'聊天记录\x20#'+_0x1432ca,'floor':_0x1432ca,'part':_0x30a474,'is_user':_0x2862a4,'timestamp':_0x5c556b}}),_0x30a474++,_0x22b9df+=_0x1078c6-_0x502e29;if(_0x22b9df>=_0x2dec30[_0x5413ca(0x145)])break;}return _0x5752e3;}function _chunkForLorebook(_0x9ba664,_0x143dc5){const _0x5c1696=_0x4826de,{chunkSize:_0x4014e6,overlap:_0x395489}=settings[_0x5c1696(0x1a1)],{bookName:bookName=_0x5c1696(0x1ba),entryName:entryName='世界书条目'}=_0x143dc5,_0x2a0157=[];if(!_0x9ba664||_0x4014e6<=0x0)return _0x2a0157;let _0x28d924=0x1,_0x35fbac=0x0;while(_0x35fbac<_0x9ba664[_0x5c1696(0x145)]){const _0x3edf42=Math[_0x5c1696(0x1cc)](_0x35fbac+_0x4014e6,_0x9ba664[_0x5c1696(0x145)]),_0xaf4bdd=_0x9ba664[_0x5c1696(0x1bd)](_0x35fbac,_0x3edf42),_0x3b5eb4=_0x5c1696(0x149)+bookName+_0x5c1696(0x120)+entryName+',\x20第'+_0x28d924+_0x5c1696(0x1d1),_0xbf97f8=getTagForSource(_0x5c1696(0x103)),_0x12e7e4='<'+_0xbf97f8+'>\x0a'+_0x3b5eb4+'\x0a'+_0xaf4bdd+'\x0a</'+_0xbf97f8+'>';_0x2a0157[_0x5c1696(0x16e)]({'text':_0x12e7e4,'metadata':{'source':_0x5c1696(0x103),'sourceName':bookName+':\x20'+entryName,'bookName':bookName,'entryName':entryName,'part':_0x28d924,'timestamp':new Date()[_0x5c1696(0x17a)]()}}),_0x28d924++,_0x35fbac+=_0x4014e6-_0x395489;if(_0x35fbac>=_0x9ba664[_0x5c1696(0x145)])break;}return _0x2a0157;}function _chunkForManual(_0x8f09a2,_0x2777ea){const _0x32f87d=_0x4826de,{chunkSize:_0x38279f,overlap:_0x1c8136}=settings[_0x32f87d(0x1a1)],{sourceName:sourceName=_0x32f87d(0x18c)}=_0x2777ea,_0x598850=[];if(!_0x8f09a2||_0x38279f<=0x0)return _0x598850;const _0xdf5bd6=new Date(),_0x13df61=_0xdf5bd6[_0x32f87d(0x153)](_0x32f87d(0x176));let _0x1a3459=0x1,_0x1b5ecb=0x0;while(_0x1b5ecb<_0x8f09a2['length']){const _0x430a5b=Math[_0x32f87d(0x1cc)](_0x1b5ecb+_0x38279f,_0x8f09a2[_0x32f87d(0x145)]),_0x2b31eb=_0x8f09a2[_0x32f87d(0x1bd)](_0x1b5ecb,_0x430a5b),_0x559e8b=_0x32f87d(0x149)+sourceName+_0x32f87d(0x12a)+_0x13df61+_0x32f87d(0x115)+_0x1a3459+'部分]',_0x3b3a7b=getTagForSource(_0x32f87d(0x1d4)),_0x1c8d9f='<'+_0x3b3a7b+'>\x0a'+_0x559e8b+'\x0a'+_0x2b31eb+_0x32f87d(0x114)+_0x3b3a7b+'>';_0x598850[_0x32f87d(0x16e)]({'text':_0x1c8d9f,'metadata':{'source':'manual','sourceName':sourceName,'part':_0x1a3459,'timestamp':_0xdf5bd6[_0x32f87d(0x17a)]()}}),_0x1a3459++,_0x1b5ecb+=_0x38279f-_0x1c8136;if(_0x1b5ecb>=_0x8f09a2['length'])break;}return _0x598850;}import{getCollectionId as _0x47c456,getCharacterName}from'./utils/context-utils.js';async function getCollectionId(){return lockedCollectionId||await _0x47c456();}function _0x4d15(){const _0x4115d6=['notify','volume','[翰林院-迁移]\x20用户确认迁移，正在处理旧宝库:\x20','bianzhuan','4hxCNQs',')\x20的状态已切换为:\x20','saveSettingsDebounced','catch','push','retrieval','chapter','[翰林院-日志]\x20获取集合\x20','\x20补充所有者ID:\x20','\x27\x20中未找到ID为\x20','getRequestHeaders','[翰林院-日志]\x20开始获取所有知识库的向量总数...','zh-CN','[翰林院-核心]\x20清空向量集合\x20','entryName','\x20条结果。','toISOString','[翰林院-日志]\x20查询知识库\x20','results','[翰林院-日志]\x20/api/vector/purge\x20响应状态:\x20','depth','rerank','聊天记录\x20#','message','[翰林院-迁移]\x20旧宝库已清空。','\x22\x20创建专属知识库...','injection_','name','[翰林院-日志]\x20清空目标集合ID:\x20','floor','final_score','getTime','score','tiaomu','手动录入','quiet','8UTInGs','values','[翰林院-Rerank]\x20元数据加权排序完成。','[翰林院-日志]\x20所有知识库查询完毕，共获得\x20','No\x20messages\x20to\x20process.','...)','[翰林院-Rerank]\x20开始外部API重排序...','stringify','info','[翰林院-日志]\x20开始多知识库向量查询...','[翰林院-配置]\x20为旧版知识库\x20','\x20-\x20楼层\x20#','condensation','宏史卷总结','[翰林院-调试]\x20步骤2\x20-\x20rerankResults返回的最终结果:','\x20个条目。','[翰林院-核心]\x20文本录入任务被用户中止。','map','hashes','advanced','legacy','[翰林院-核心]\x20已为角色\x20','sourceName','template','hanlinyuanRagProcessor','小说录入','6450965gvVPAK','对话记录小总结','content','queryMessageCount','saveProgress','hasOwnProperty','warn','外部Rerank完成','global','batchSize','36QOIaJF','add','is_user','findIndex','messageTypes','\x20时发生网络错误:','1390DIFWHh','webllm','世界书','index','[来源:\x20聊天记录,\x20楼层:\x20#','substring','旧版宝库\x20(Legacy)','key','无法确定要清空的目标宝库。','[翰林院]\x20检索或注入时发生错误:','\x20及其向量数据。','chat_history','[翰林院-核心]\x20尝试删除一个不存在的知识库:\x20','start','initialized','getContext','[翰林院-日志]\x20发送到\x20/api/vector/purge\x20的请求体:','enabled','第1卷','text','min','[翰林院-核心]\x20文本录入失败:\x20','[翰林院-日志]\x20清空宝库API错误:','删除知识库失败，未能清空后端数据。','25065nrNUjT','部分]',']\x20的消息已成功凝识。','isArray','manual','[翰林院-核心]\x20processCondensation\x20失败:','slice','position','未分类世界书','\x20失败:\x20','<mark\x20class=\x22search-highlight\x22>$1</mark>','[翰林院]\x20已为来源\x20\x27','凝识之权未开启','[翰林院-核心]\x20成功删除知识库\x20','[翰林院-日志]\x20所有知识库统计完成，总向量数:\x20','user','_text}}','[翰林院-配置]\x20','[翰林院-日志]\x20清空宝库API调用成功。','[翰林院-Rerank]\x20外部Rerank失败，将仅使用内部加权。','\x20失败:','trim',',\x20第1卷,\x20第1章,\x20第','clearJob','extensionSettings','[翰林院-核心]\x20准备为任务\x20\x22','查询集合\x20','\x20个向量条目。','rearrangeChat','has','\x22\x20已删除。','用户取消了迁移操作','end','random','[翰林院-日志]\x20统计目标集合ID:\x20','忆识存入API错误\x20','输入文本为空','[翰林院-核心]\x20准备删除知识库\x20','[翰林院-修复]\x20最终返回数组样本:','\x20条消息分解为\x20','original_index','bookName','\x27的文本分割成\x20','reduce','\x20个块。','part','oldId','metadata','[翰林院]\x20未能获取SillyTavern上下文，初始化失败。','condensationHistory','status','source','depth_role','\x20添加新知识库:\x20','/api/vector/query','HANLINYUAN_RAG_LOREBOOK','\x20(ID:\x20','novel','892767YLSOxL','log','HANLINYUAN_RAG_CHAT','(已锁定:\x20','comment','lorebook','sort','[翰林院-核心]\x20聊天记录凝识完成，成功插入\x20','4187095TYAZfM','find','\x20列表API时出现问题\x20(状态:\x20','chat','[翰林院-日志]\x20没有启用的新知识库，尝试查询旧版单体宝库...','json','文本块和向量数量不匹配','检测到旧版数据。此操作将把旧数据迁移到新格式，过程不可逆，是否继续？','includes','未知角色','\x20(范围:\x20','scope','\x20不存在，计为\x200。','966128gpyZqs','\x0a</',',\x20第','在源作用域\x20\x27','对话记录大总结','[翰林院-迁移]\x20集合\x20','\x20的知识库。','AbortError','[翰林院-核心]\x20凝识任务已锁定知识库:\x20','knowledgeBases','unknown','_history','移动失败：没有当前角色，无法移入局部知识库。',',\x20条目:\x20','now','HANLINYUAN_RAG_MANUAL','top_n','忆识检索失败:\x20','聊天记录','test','aborted','abs','section',',\x20向量化录入时间:\x20','object','\x20条内容。','newId','range','rerank_score','mes','[翰林院-核心]\x20已锁定忆识宝库ID:\x20','[翰林院-日志]\x20统计集合\x20','\x20个知识块，准备入库。','/api/vector/list','error','Rerank失败:\x20','小说:\x20','then','微言录总结','HANLINYUAN_RAG_NOVEL','6NaXgCQ','[翰林院-核心]\x20已创建并锁定知识库:\x20','toString','[翰林院-调试]\x20步骤1\x20-\x20queryVectors返回的原始结果:','\x22，将数据合并入库。','match','第1章','all','11682034pmkAhS','max','length','[翰林院-核心]\x20聊天记录凝识失败:\x20','forEach','success','[来源:\x20','[翰林院-迁移]\x20用户取消了迁移操作。','string','data','[翰林院-核心]\x20已为宝库\x20','replace','手动录入:\x20','filter','21QnpNuG','聊天记录:\x20','toLocaleString','[翰林院-核心]\x20检测到同名知识库\x20\x22','\x20(集合ID:\x20','456653vMENbA','[翰林院-核心]\x20已将\x20','，将清空集合:\x20','POST','[翰林院]\x20未找到来源\x20\x27','sjshu','\x27，使用通用分块逻辑。','[翰林院-日志]\x20忆识存入API错误:','owner','操作已取消。','warning','join','[翰林院-调试]\x20步骤3\x20-\x20按来源分组后的结果:','toLowerCase','[翰林院-Rerank]\x20开始元数据加权最终排序...','local'];_0x4d15=function(){return _0x4115d6;};return _0x4d15();}async function toggleSessionLock(){return lockedCollectionId?(lockedCollectionId=null,![]):(lockedCollectionId=await _0x47c456(),!![]);}function isSessionLocked(){return lockedCollectionId!==null;}function getLockedSessionInfo(){const _0x17dc6f=_0x4826de;if(!lockedCollectionId)return null;return{'id':lockedCollectionId,'name':_0x17dc6f(0x101)+lockedCollectionId[_0x17dc6f(0x1bd)](0x0,0x8)+_0x17dc6f(0x193)};}function getLocalKnowledgeBases(){const _0xa6048a=_0x4826de,_0x587aa7=getCharacterStableId();return!settings[_0xa6048a(0x11c)][_0x587aa7]&&(settings[_0xa6048a(0x11c)][_0x587aa7]={}),settings['knowledgeBases'][_0x587aa7];}function getGlobalKnowledgeBases(){const _0x10765d=_0x4826de;return!settings[_0x10765d(0x11c)][GLOBAL_SCOPE_ID]&&(settings[_0x10765d(0x11c)][GLOBAL_SCOPE_ID]={}),settings[_0x10765d(0x11c)][GLOBAL_SCOPE_ID];}function getKnowledgeBases(){const _0x1fd31=getLocalKnowledgeBases(),_0x51e62d=getGlobalKnowledgeBases();return{..._0x51e62d,..._0x1fd31};}function addKnowledgeBase(_0x4e78c6){const _0x559c1c=_0x4826de;if(!_0x4e78c6||!_0x4e78c6[_0x559c1c(0x1e5)]())throw new Error('知识库名称不能为空');const _0x1cff5b=getCharacterStableId(),_0x10a247=getLocalKnowledgeBases(),_0x53691e='task_'+Date[_0x559c1c(0x121)]()+'_'+Math[_0x559c1c(0xe5)]()[_0x559c1c(0x13d)](0x24)[_0x559c1c(0x1bd)](0x2,0x9),_0x3d1350={'id':_0x53691e,'name':_0x4e78c6[_0x559c1c(0x1e5)](),'enabled':!![],'createdAt':new Date()[_0x559c1c(0x17a)](),'owner':_0x1cff5b};return _0x10a247[_0x53691e]=_0x3d1350,saveSettings(),console[_0x559c1c(0xff)](_0x559c1c(0x1a3)+_0x1cff5b+_0x559c1c(0xf9)+_0x4e78c6+'\x20(ID:\x20'+_0x53691e+')'),_0x3d1350;}async function removeKnowledgeBase(_0x23d4ce,_0x3a50fb){const _0x3c5789=_0x4826de,_0xedef4d=getCharacterStableId(),_0x485f43=_0x3a50fb===_0x3c5789(0x1b0)?getGlobalKnowledgeBases():getLocalKnowledgeBases(),_0x4e658e=_0x485f43[_0x23d4ce],_0x396a4c=_0x4e658e?.[_0x3c5789(0x185)]||_0x23d4ce;if(!_0x4e658e){console[_0x3c5789(0x1ae)](_0x3c5789(0x1c4)+_0x23d4ce+_0x3c5789(0x110)+_0x3a50fb+')');return;}const _0x4413f2=_0x3a50fb==='global'?_0x4e658e[_0x3c5789(0x15e)]||GLOBAL_SCOPE_ID:_0xedef4d,_0x452033=_0x4413f2+'_'+_0x23d4ce;console[_0x3c5789(0xff)](_0x3c5789(0xe9)+_0x23d4ce+_0x3c5789(0x158)+_0x452033);const _0x48dd0f=await purgeStorage(_0x452033);_0x48dd0f?(delete _0x485f43[_0x23d4ce],saveSettings(),console[_0x3c5789(0xff)](_0x3c5789(0x1dd)+_0x23d4ce+_0x3c5789(0x1c2)),toastr[_0x3c5789(0x148)]('知识库\x20\x22'+_0x396a4c+_0x3c5789(0x1ee))):(console[_0x3c5789(0x135)](_0x3c5789(0x177)+_0x452033+'\x20失败，删除操作中止。'),toastr[_0x3c5789(0x135)](_0x3c5789(0x1cf)));}function toggleKnowledgeBase(_0x5b965b,_0x46ed45){const _0x137706=_0x4826de,_0x4445fd=_0x46ed45===_0x137706(0x1b0)?getGlobalKnowledgeBases():getLocalKnowledgeBases();_0x4445fd[_0x5b965b]&&(_0x4445fd[_0x5b965b][_0x137706(0x1c9)]=!_0x4445fd[_0x5b965b][_0x137706(0x1c9)],saveSettings(),console[_0x137706(0xff)]('[翰林院-核心]\x20知识库\x20'+_0x5b965b+'\x20(范围:\x20'+_0x46ed45+_0x137706(0x16b)+(_0x4445fd[_0x5b965b][_0x137706(0x1c9)]?'启用':'禁用')));}function generateHash(_0x564c2c){const _0x59f97c=_0x4826de;let _0x9a5a54=0x0;for(let _0x1c8f44=0x0;_0x1c8f44<_0x564c2c['length'];_0x1c8f44++){const _0x303da6=_0x564c2c['charCodeAt'](_0x1c8f44);_0x9a5a54=(_0x9a5a54<<0x5)-_0x9a5a54+_0x303da6,_0x9a5a54=_0x9a5a54&_0x9a5a54;}return Math[_0x59f97c(0x128)](_0x9a5a54)['toString'](0x24);}async function queryVectors(_0x2af60e){const _0x590775=_0x4826de;console[_0x590775(0xff)](_0x590775(0x197));const _0x34f5d2=getCharacterStableId(),_0x25873b=getLocalKnowledgeBases(),_0x536258=getGlobalKnowledgeBases(),_0x2faffa=Object[_0x590775(0x18f)](_0x25873b)[_0x590775(0x150)](_0x55b056=>_0x55b056[_0x590775(0x1c9)]),_0xb84638=Object[_0x590775(0x18f)](_0x536258)[_0x590775(0x150)](_0x426cbd=>_0x426cbd[_0x590775(0x1c9)]),_0xee5ecd=[..._0x2faffa[_0x590775(0x19f)](_0x505f83=>({..._0x505f83,'scope':_0x590775(0x165)})),..._0xb84638[_0x590775(0x19f)](_0x5e4565=>({..._0x5e4565,'scope':'global'}))];if(_0xee5ecd['length']===0x0){console[_0x590775(0xff)](_0x590775(0x10a));const _0x24ccf0=await _0x47c456();if(!_0x24ccf0)return[];_0xee5ecd[_0x590775(0x16e)]({'id':null,'name':_0x590775(0x1be),'scope':_0x590775(0x1a2)});}const _0x1f8f11=(await getEmbeddings([_0x2af60e]))[0x0];let _0x7c9a0b=[];const _0x53e941=_0xee5ecd[_0x590775(0x19f)](_0x421cb1=>{const _0x2e354b=_0x590775;let _0x5a2717;if(_0x421cb1[_0x2e354b(0x111)]==='legacy')_0x5a2717=_0x47c456();else{const _0x472c53=_0x421cb1[_0x2e354b(0x111)]===_0x2e354b(0x1b0)?_0x421cb1[_0x2e354b(0x15e)]||GLOBAL_SCOPE_ID:_0x34f5d2;_0x5a2717=Promise['resolve'](_0x472c53+'_'+_0x421cb1['id']);}return _0x5a2717[_0x2e354b(0x138)](_0x3437e1=>{const _0x2dfadc=_0x2e354b;if(!_0x3437e1)return[];console[_0x2dfadc(0xff)]('[翰林院-日志]\x20正在查询知识库:\x20'+_0x421cb1[_0x2dfadc(0x185)]+_0x2dfadc(0xfc)+_0x3437e1+')');const _0x24ec07={'collectionId':_0x3437e1,'searchText':_0x2af60e,'topK':settings[_0x2dfadc(0x1a1)]['maxResults'],'threshold':settings[_0x2dfadc(0x1a1)]['matchThreshold'],'source':_0x2dfadc(0x1b9),'embeddings':{[_0x2af60e]:_0x1f8f11}};return fetch(_0x2dfadc(0xfa),{'method':'POST','headers':context[_0x2dfadc(0x174)](),'body':JSON[_0x2dfadc(0x195)](_0x24ec07)})[_0x2dfadc(0x138)](async _0x50ad6d=>{const _0x277db0=_0x2dfadc;if(!_0x50ad6d['ok']){const _0x31d289=await _0x50ad6d[_0x277db0(0x1cb)]();return console[_0x277db0(0x135)](_0x277db0(0x17b)+_0x3437e1+_0x277db0(0x1e4),_0x31d289),[];}const _0x3eb946=await _0x50ad6d[_0x277db0(0x10b)]();let _0x547776=[];if(Array[_0x277db0(0x1d3)](_0x3eb946))_0x547776=_0x3eb946;else{if(_0x3eb946&&_0x3eb946['metadata']&&Array[_0x277db0(0x1d3)](_0x3eb946[_0x277db0(0xf3)]))_0x547776=_0x3eb946['metadata'];else{if(_0x3eb946&&_0x3eb946[_0x277db0(0x17c)]&&Array['isArray'](_0x3eb946[_0x277db0(0x17c)]))_0x547776=_0x3eb946[_0x277db0(0x17c)];else _0x3eb946&&_0x3eb946[_0x277db0(0x14c)]&&Array[_0x277db0(0x1d3)](_0x3eb946[_0x277db0(0x14c)])&&(_0x547776=_0x3eb946[_0x277db0(0x14c)]);}}const _0x597b33=_0x547776['map'](_0x503486=>{const _0x4bea31=_0x277db0;if(!_0x503486||typeof _0x503486[_0x4bea31(0x1cb)]!==_0x4bea31(0x14b))return null;const _0x4a19b0={'source':_0x4bea31(0x11d),'sourceName':'未知'},_0x1e26f2=_0x503486[_0x4bea31(0x1cb)]['match'](/^<([^>]+)>/),_0x5b2372=_0x1e26f2?_0x1e26f2[0x1]:'';switch(_0x5b2372){case _0x4bea31(0x125):_0x4a19b0['source']=_0x4bea31(0x1c3);const _0x537e55=_0x503486[_0x4bea31(0x1cb)][_0x4bea31(0x140)](/楼层:\s*#(\d+),\s*第(\d+)部分/);_0x537e55&&_0x537e55[0x1]&&_0x537e55[0x2]&&(_0x4a19b0[_0x4bea31(0x187)]=parseInt(_0x537e55[0x1],0xa),_0x4a19b0[_0x4bea31(0xf1)]=parseInt(_0x537e55[0x2],0xa),_0x4a19b0[_0x4bea31(0x1a4)]=_0x4bea31(0x180)+_0x4a19b0[_0x4bea31(0x187)]);break;case'世界书':_0x4a19b0[_0x4bea31(0xf7)]=_0x4bea31(0x103);const _0x5a107e=_0x503486['text'][_0x4bea31(0x140)](/\[来源:\s*([^,]+),\s*条目:\s*([^,]+),\s*第(\d+)部分\]/);_0x5a107e&&_0x5a107e[0x1]&&_0x5a107e[0x2]&&_0x5a107e[0x3]&&(_0x4a19b0[_0x4bea31(0xed)]=_0x5a107e[0x1]['trim'](),_0x4a19b0[_0x4bea31(0x178)]=_0x5a107e[0x2][_0x4bea31(0x1e5)](),_0x4a19b0[_0x4bea31(0xf1)]=parseInt(_0x5a107e[0x3],0xa),_0x4a19b0[_0x4bea31(0x1a4)]=_0x4a19b0[_0x4bea31(0xed)]+':\x20'+_0x4a19b0[_0x4bea31(0x178)]);break;case _0x4bea31(0x18c):_0x4a19b0[_0x4bea31(0xf7)]=_0x4bea31(0x1d4);const _0x97199f=_0x503486[_0x4bea31(0x1cb)]['match'](/\[来源:\s*([^,]+),.*第(\d+)部分\]/);_0x97199f&&_0x97199f[0x1]&&_0x97199f[0x2]&&(_0x4a19b0['sourceName']=_0x97199f[0x1]['trim'](),_0x4a19b0[_0x4bea31(0xf1)]=parseInt(_0x97199f[0x2],0xa));break;case _0x4bea31(0x1a7):_0x4a19b0[_0x4bea31(0xf7)]=_0x4bea31(0xfd);const _0x31e01b=_0x503486[_0x4bea31(0x1cb)][_0x4bea31(0x140)](/\[来源:\s*([^,]+),\s*([^,]+),\s*([^,]+),\s*([^\]]+)\]/);_0x31e01b&&(_0x4a19b0[_0x4bea31(0x1a4)]=_0x31e01b[0x1][_0x4bea31(0x1e5)](),_0x4a19b0[_0x4bea31(0x167)]=_0x31e01b[0x2]['trim'](),_0x4a19b0[_0x4bea31(0x170)]=_0x31e01b[0x3][_0x4bea31(0x1e5)](),_0x4a19b0[_0x4bea31(0x129)]=_0x31e01b[0x4][_0x4bea31(0x1e5)]());break;}return{..._0x503486,'score':_0x503486[_0x4bea31(0x18a)]||0x1,'metadata':_0x4a19b0};})['filter'](Boolean);return console[_0x277db0(0xff)]('[翰林院-V13\x20修复]\x20重建元数据后，知识库\x20'+_0x421cb1[_0x277db0(0x185)]+'\x20返回\x20'+_0x597b33[_0x277db0(0x145)]+_0x277db0(0x179)),_0x597b33;})[_0x2dfadc(0x16d)](_0x3e6c2c=>{const _0x508190=_0x2dfadc;return console[_0x508190(0x135)](_0x508190(0x17b)+_0x3437e1+_0x508190(0x1b7),_0x3e6c2c),[];});});}),_0x1f20c4=await Promise[_0x590775(0x142)](_0x53e941);_0x7c9a0b=_0x1f20c4['flat'](),console['log'](_0x590775(0x191)+_0x7c9a0b['length']+'\x20条初步结果。');const _0x4fb4cb=[],_0x2efd6c=new Set();for(const _0x4b8d99 of _0x7c9a0b){if(_0x4b8d99&&typeof _0x4b8d99===_0x590775(0x12b)&&_0x4b8d99['text']&&typeof _0x4b8d99[_0x590775(0x1cb)]==='string'){const _0x4c376b=_0x4b8d99[_0x590775(0x1cb)][_0x590775(0x1e5)]();_0x4c376b[_0x590775(0x145)]>0x0&&!_0x2efd6c[_0x590775(0x1ed)](_0x4c376b)&&(_0x2efd6c[_0x590775(0x1b3)](_0x4c376b),_0x4fb4cb[_0x590775(0x16e)](_0x4b8d99));}}console['log']('[翰林院-日志]\x20去重后剩余\x20'+_0x4fb4cb[_0x590775(0x145)]+_0x590775(0x179)),_0x4fb4cb[_0x590775(0x104)]((_0x80f89e,_0x1c725b)=>(_0x1c725b[_0x590775(0x18a)]||0x0)-(_0x80f89e[_0x590775(0x18a)]||0x0));const _0x4ae32c=[..._0x4fb4cb];return console[_0x590775(0xff)]('[翰林院-修复]\x20最终返回数组长度:\x20'+_0x4ae32c[_0x590775(0x145)]),console[_0x590775(0xff)](_0x590775(0xea),JSON[_0x590775(0x195)](_0x4ae32c[_0x590775(0x1d6)](0x0,0x1),null,0x2)),_0x4ae32c;}async function insertVectors(_0x5967fa,_0x4ff723=null,_0x28568e){const _0x38df19=_0x4826de;if(!_0x28568e)throw new Error('insertVectors\x20必须接收一个有效的\x20collectionId\x20参数。');if(_0x5967fa[_0x38df19(0x145)]===0x0)return{'success':!![],'count':0x0};const _0xe14954=_0x5967fa[_0x38df19(0x19f)]((_0x2213d1,_0x3285fd)=>({'hash':generateHash(_0x2213d1['text']+Date[_0x38df19(0x121)]()+_0x3285fd),'text':_0x2213d1[_0x38df19(0x1cb)],'metadata':_0x2213d1[_0x38df19(0xf3)]||{'source':_0x38df19(0x11d),'timestamp':new Date()['toISOString']()}})),_0x4cb514=_0xe14954[_0x38df19(0xef)]((_0x18aec1,_0x598ff6,_0xa0bf9a)=>{return _0x18aec1[_0x598ff6['text']]=_0x5967fa[_0xa0bf9a]['vector'],_0x18aec1;},{}),_0x4bf5ee={'collectionId':_0x28568e,'items':_0xe14954,'source':_0x38df19(0x1b9),'embeddings':_0x4cb514},_0x404074=await fetch('/api/vector/insert',{'method':'POST','headers':context[_0x38df19(0x174)](),'body':JSON[_0x38df19(0x195)](_0x4bf5ee),'signal':_0x4ff723});if(!_0x404074['ok']){const _0x51d7c2=await _0x404074[_0x38df19(0x1cb)]();console[_0x38df19(0x135)](_0x38df19(0x15d),_0x51d7c2);throw new Error(_0x38df19(0xe7)+_0x404074[_0x38df19(0xf6)]+':\x20'+_0x51d7c2);}return{'success':!![],'count':_0xe14954['length']};}async function getVectorCount(_0x42d290=null,_0x427ced='local'){const _0x4bdc16=_0x4826de,_0x27c604=getCharacterStableId();if(_0x42d290){const _0x4c93b5=_0x427ced===_0x4bdc16(0x1b0)?getGlobalKnowledgeBases():getLocalKnowledgeBases(),_0x2d375e=_0x4c93b5[_0x42d290];if(!_0x2d375e)return console[_0x4bdc16(0x1ae)]('[翰林院-计数]\x20在作用域\x20\x27'+_0x427ced+'\x27\x20中未找到ID为\x20'+_0x42d290+_0x4bdc16(0x119)),0x0;const _0x448347=_0x427ced===_0x4bdc16(0x1b0)?_0x2d375e[_0x4bdc16(0x15e)]||GLOBAL_SCOPE_ID:_0x27c604,_0x21aec5=_0x448347+'_'+_0x42d290;return await countVectorsInCollection(_0x21aec5);}else{console[_0x4bdc16(0xff)](_0x4bdc16(0x175));const _0x5a2cc7=Object[_0x4bdc16(0x18f)](getLocalKnowledgeBases()),_0x5864cf=Object[_0x4bdc16(0x18f)](getGlobalKnowledgeBases()),_0x4c58b0=[];_0x5a2cc7[_0x4bdc16(0x147)](_0xe3d99=>{const _0xace8d=_0x4bdc16,_0x258543=_0x27c604+'_'+_0xe3d99['id'];_0x4c58b0[_0xace8d(0x16e)](countVectorsInCollection(_0x258543));}),_0x5864cf[_0x4bdc16(0x147)](_0x5bd14d=>{const _0x152d3a=_0x4bdc16,_0x5625d5=_0x5bd14d[_0x152d3a(0x15e)]||GLOBAL_SCOPE_ID,_0x51a9d9=_0x5625d5+'_'+_0x5bd14d['id'];_0x4c58b0['push'](countVectorsInCollection(_0x51a9d9));});const _0x62acbc=await _0x47c456();_0x4c58b0['push'](countVectorsInCollection(_0x62acbc));const _0x678ebe=await Promise['all'](_0x4c58b0),_0x2ec326=_0x678ebe[_0x4bdc16(0xef)]((_0x471e5e,_0x13b710)=>_0x471e5e+_0x13b710,0x0);return console['log'](_0x4bdc16(0x1de)+_0x2ec326),_0x2ec326;}}async function countVectorsInCollection(_0x3363c3){const _0x3f1ecf=_0x4826de;if(!_0x3363c3)return 0x0;console[_0x3f1ecf(0xff)](_0x3f1ecf(0xe6)+_0x3363c3);const _0x1ece6c={'collectionId':_0x3363c3,'source':_0x3f1ecf(0x1b9),'embeddings':{}};try{const _0x1664f5=await fetch(_0x3f1ecf(0x134),{'method':_0x3f1ecf(0x159),'headers':context[_0x3f1ecf(0x174)](),'body':JSON['stringify'](_0x1ece6c)});if(!_0x1664f5['ok']){if(_0x1664f5[_0x3f1ecf(0xf6)]===0x194)console[_0x3f1ecf(0xff)]('[翰林院-日志]\x20集合\x20'+_0x3363c3+_0x3f1ecf(0x112));else{const _0x3df3e6=await _0x1664f5['text']();console[_0x3f1ecf(0x1ae)](_0x3f1ecf(0x171)+_0x3363c3+_0x3f1ecf(0x108)+_0x1664f5[_0x3f1ecf(0xf6)]+'):',_0x3df3e6);}return 0x0;}const _0x38bad8=await _0x1664f5[_0x3f1ecf(0x10b)]();let _0x12138a=0x0;if(Array['isArray'](_0x38bad8))_0x12138a=_0x38bad8['length'];else _0x38bad8&&_0x38bad8['hashes']&&(_0x12138a=_0x38bad8[_0x3f1ecf(0x1a0)]['length']);return _0x12138a;}catch(_0x3848d5){return console[_0x3f1ecf(0x135)](_0x3f1ecf(0x132)+_0x3363c3+'\x20时发生网络错误:',_0x3848d5),0x0;}}async function purgeStorage(_0x2fe537=null){const _0x4d699a=_0x4826de;console[_0x4d699a(0xff)]('[翰林院-日志]\x20开始清空宝库...');const _0x331b9f=_0x2fe537||await getCollectionId();if(!_0x331b9f)return console[_0x4d699a(0x135)]('[翰林院-日志]\x20无法确定要清空的目标集合ID。'),toastr[_0x4d699a(0x135)](_0x4d699a(0x1c0)),![];console[_0x4d699a(0xff)](_0x4d699a(0x186)+_0x331b9f);const _0x22c62d={'collectionId':_0x331b9f};console[_0x4d699a(0xff)](_0x4d699a(0x1c8),JSON[_0x4d699a(0x195)](_0x22c62d,null,0x2));const _0x47e85c=await fetch('/api/vector/purge',{'method':'POST','headers':context[_0x4d699a(0x174)](),'body':JSON[_0x4d699a(0x195)](_0x22c62d)});console[_0x4d699a(0xff)](_0x4d699a(0x17d)+_0x47e85c[_0x4d699a(0xf6)]);if(!_0x47e85c['ok']){const _0x33fe37=await _0x47e85c[_0x4d699a(0x1cb)]();console[_0x4d699a(0x135)](_0x4d699a(0x1ce),_0x33fe37);}else console[_0x4d699a(0xff)](_0x4d699a(0x1e2));return _0x47e85c['ok'];}function _0x2dc8(_0x3924ff,_0xce16df){const _0x4d15af=_0x4d15();return _0x2dc8=function(_0x2dc84a,_0x42e9b7){_0x2dc84a=_0x2dc84a-0xe5;let _0x4b1052=_0x4d15af[_0x2dc84a];return _0x4b1052;},_0x2dc8(_0x3924ff,_0xce16df);}function getMessagesForCondensation(_0x423fcb=null){const _0x354069=_0x4826de;if(!settings[_0x354069(0x19a)][_0x354069(0x1c9)])return showNotification(_0x354069(0x1dc),_0x354069(0x160)),[];const {layerStart:_0x8182ed,layerEnd:_0x3aeab3}=settings[_0x354069(0x19a)],_0x38012a=_0x423fcb||settings[_0x354069(0x19a)][_0x354069(0x1b6)],_0x35dffd=context[_0x354069(0x109)][_0x354069(0x145)],_0x3bb5b6=Math[_0x354069(0x144)](0x0,_0x8182ed-0x1),_0x1d0e57=_0x3aeab3===0x0||_0x3aeab3>_0x35dffd?_0x35dffd:Math[_0x354069(0x1cc)](_0x35dffd,_0x3aeab3),_0x5d3404=context[_0x354069(0x109)][_0x354069(0x1d6)](_0x3bb5b6,_0x1d0e57);return _0x5d3404[_0x354069(0x150)](_0xb823f1=>{const _0x1a450f=_0x354069,_0x1d003e=_0xb823f1['is_user']===!![],_0x5d323f=_0xb823f1[_0x1a450f(0x1b4)]===![];if(!_0xb823f1[_0x1a450f(0x130)]||!_0xb823f1[_0x1a450f(0x130)][_0x1a450f(0x1e5)]())return![];return _0x38012a[_0x1a450f(0x1df)]&&_0x1d003e||_0x38012a['ai']&&_0x5d323f;});}async function processCondensation(_0x5da8c7,_0xdcae52=()=>{},_0x3a5dff=null){const _0x5e3354=_0x4826de;if(!_0x5da8c7||_0x5da8c7[_0x5e3354(0x145)]===0x0)return{'success':![],'error':_0x5e3354(0x192)};try{let _0x268584,_0x52f2ce;const _0x40f6b8=getCharacterName()||_0x5e3354(0x10f);if(_0x3a5dff){const _0x4aec64=_0x3a5dff[_0x5e3354(0x1c5)]??'?',_0x51daf7=_0x3a5dff['end']===0x0?'末':_0x3a5dff[_0x5e3354(0x1f0)]??'?';_0x268584=_0x40f6b8+':\x20'+_0x4aec64+'楼-'+_0x51daf7+'楼';}else{const _0x41f38f=new Date()[_0x5e3354(0x153)](_0x5e3354(0x176),{'hour12':![]});_0x268584=_0x5e3354(0x152)+_0x41f38f;}const _0x185d8e=Object['values'](getLocalKnowledgeBases()),_0x9aff85=_0x185d8e[_0x5e3354(0x107)](_0x3dfc94=>_0x3dfc94['name']===_0x268584);if(_0x9aff85)_0x52f2ce=_0x9aff85['id'],_0xdcae52(_0x5e3354(0x154)+_0x268584+_0x5e3354(0x13f),'info');else{_0xdcae52(_0x5e3354(0x1e9)+_0x268584+'\x22\x20创建专属知识库...','info');const _0x5685b8=addKnowledgeBase(_0x268584);_0x52f2ce=_0x5685b8['id'];}const _0x34bb71=getCharacterStableId(),_0x34cd15=_0x34bb71+'_'+_0x52f2ce;_0xdcae52(_0x5e3354(0x11b)+_0x268584+_0x5e3354(0x155)+_0x34cd15+')','success');const _0x54ac98=[],_0x18eeb4=context[_0x5e3354(0x109)];for(const _0x5d8b8f of _0x5da8c7){const _0x2d775c=(_0x5d8b8f[_0x5e3354(0x130)]||'')[_0x5e3354(0x14e)](/<[^>]*>/g,'')[_0x5e3354(0x1e5)]();if(_0x2d775c[_0x5e3354(0x145)]===0x0)continue;let _0x3a8f0a;if(_0x5d8b8f[_0x5e3354(0x187)]!==undefined&&_0x5d8b8f[_0x5e3354(0x187)]!==null)_0x3a8f0a=_0x5d8b8f[_0x5e3354(0x187)];else{const _0x5e651b=_0x18eeb4[_0x5e3354(0x1b5)](_0xf17715=>_0xf17715===_0x5d8b8f);_0x3a8f0a=_0x5e651b!==-0x1?_0x5e651b+0x1:-0x1;}const _0x2738=new Date(_0x5d8b8f['send_date']),_0x21e2ba=isNaN(_0x2738[_0x5e3354(0x189)]())?new Date()['toISOString']():_0x2738[_0x5e3354(0x17a)](),_0x2c0651=splitIntoChunks(_0x2d775c,'chat_history',{'floor':_0x3a8f0a,'is_user':_0x5d8b8f[_0x5e3354(0x1b4)],'timestamp':_0x21e2ba});_0x54ac98[_0x5e3354(0x16e)](..._0x2c0651);}if(_0x54ac98[_0x5e3354(0x145)]===0x0)return{'success':!![],'count':0x0};_0xdcae52(_0x5e3354(0x157)+_0x5da8c7[_0x5e3354(0x145)]+_0x5e3354(0xeb)+_0x54ac98['length']+_0x5e3354(0x133),_0x5e3354(0x196));const _0x3bd26c=settings[_0x5e3354(0x16f)][_0x5e3354(0x1b1)]||0x5;let _0x56cf1d=0x0;for(let _0x7313b4=0x0;_0x7313b4<_0x54ac98['length'];_0x7313b4+=_0x3bd26c){const _0xd09ddd=_0x54ac98[_0x5e3354(0x1d6)](_0x7313b4,_0x7313b4+_0x3bd26c),_0x27e8a3=_0xd09ddd[_0x5e3354(0x19f)](_0x4920eb=>_0x4920eb['text']),_0x8216ab=await getEmbeddings(_0x27e8a3);if(_0xd09ddd[_0x5e3354(0x145)]!==_0x8216ab[_0x5e3354(0x145)])throw new Error(_0x5e3354(0x10c));const _0x2e23e7=_0xd09ddd[_0x5e3354(0x19f)]((_0x22b775,_0x3f9363)=>({..._0x22b775,'vector':_0x8216ab[_0x3f9363]}));await insertVectors(_0x2e23e7,null,_0x34cd15),_0x56cf1d+=_0xd09ddd[_0x5e3354(0x145)];}if(_0x3a5dff){const _0x3965e7=_0x3a5dff[_0x5e3354(0x1f0)]===0x0?context[_0x5e3354(0x109)][_0x5e3354(0x145)]:_0x3a5dff[_0x5e3354(0x1f0)],_0x329476=getCharacterStableId();!settings[_0x5e3354(0xf5)][_0x329476]&&(settings[_0x5e3354(0xf5)][_0x329476]={}),settings[_0x5e3354(0xf5)][_0x329476][_0x34cd15]={'start':_0x3a5dff[_0x5e3354(0x1c5)],'end':_0x3965e7,'timestamp':new Date()[_0x5e3354(0x17a)]()},saveSettings(),_0xdcae52(_0x5e3354(0x14d)+_0x34cd15+'\x20记录凝识范围:\x20'+_0x3a5dff[_0x5e3354(0x1c5)]+'-'+_0x3965e7,_0x5e3354(0x196));}_0xdcae52(_0x5e3354(0x105)+_0x56cf1d+_0x5e3354(0x19d),_0x5e3354(0x148));const _0x30d15b=_0x5da8c7[_0x5e3354(0x19f)](_0x20cfd6=>{const _0x4e74e1=_0x5e3354,_0x5514f3=_0x18eeb4[_0x4e74e1(0x1b5)](_0x467c63=>_0x467c63===_0x20cfd6),_0x36db24=_0x5514f3!==-0x1?_0x5514f3+0x1:-0x1,_0x124beb=_0x20cfd6['is_user']?'用户':getCharacterName()||'AI';return'['+_0x124beb+_0x4e74e1(0x199)+_0x36db24+_0x4e74e1(0x1d2);});return{'success':!![],'count':_0x56cf1d,'messages':_0x30d15b};}catch(_0x45f0e6){return console[_0x5e3354(0x135)](_0x5e3354(0x1d5),_0x45f0e6),_0xdcae52(_0x5e3354(0x146)+_0x45f0e6[_0x5e3354(0x181)],'error'),{'success':![],'error':_0x45f0e6['message']};}}async function rerankResults(_0x7a5ecc,_0x350b1a,_0x2c2577){const _0x4fc55a=_0x4826de;let _0xf4a4c8=_0x7a5ecc;if(_0x2c2577[_0x4fc55a(0x17f)][_0x4fc55a(0x1c9)]&&_0x7a5ecc['length']>0x0){console[_0x4fc55a(0xff)](_0x4fc55a(0x194));try{const _0x41c6ff=_0x7a5ecc[_0x4fc55a(0x19f)](_0x4858e4=>_0x4858e4['text']),_0x3a7a09=await executeRerank(_0x350b1a,_0x41c6ff,_0x2c2577[_0x4fc55a(0x17f)]),_0x56022b=_0x7a5ecc['map']((_0x36c910,_0x7e4ef3)=>({..._0x36c910,'original_index':_0x7e4ef3}));_0xf4a4c8=_0x56022b['map'](_0x24201c=>{const _0x4f4998=_0x4fc55a,_0x4c4613=_0x3a7a09[_0x4f4998(0x17c)][_0x4f4998(0x107)](_0x2e502b=>_0x2e502b[_0x4f4998(0x1bb)]===_0x24201c[_0x4f4998(0xec)]),_0x3203ba=_0x4c4613?_0x4c4613['relevance_score']:0x0;return{..._0x24201c,'rerank_score':_0x3203ba};});if(_0x2c2577[_0x4fc55a(0x17f)][_0x4fc55a(0x166)])showNotification(_0x4fc55a(0x1af),'success');}catch(_0x4291c5){console['error'](_0x4fc55a(0x1e3),_0x4291c5);if(_0x2c2577['rerank'][_0x4fc55a(0x166)])showNotification(_0x4fc55a(0x136)+_0x4291c5[_0x4fc55a(0x181)],_0x4fc55a(0x135));_0xf4a4c8[_0x4fc55a(0x147)](_0x30e7c6=>_0x30e7c6['rerank_score']=0x0);}}else _0xf4a4c8['forEach'](_0xf221d4=>_0xf221d4[_0x4fc55a(0x12f)]=0x0);console[_0x4fc55a(0xff)](_0x4fc55a(0x164));const _0x450699=context['chat'][_0x4fc55a(0x145)],_0x1e315e=_0x2c2577[_0x4fc55a(0x17f)]['hybrid_alpha'],_0x140e7f=_0xf4a4c8[_0x4fc55a(0x19f)](_0x1dfc8e=>{const _0x116f60=_0x4fc55a;let _0x26fe77=0x1;const _0x40745c=_0x1dfc8e[_0x116f60(0xf3)]||{};switch(_0x40745c['source']){case _0x116f60(0x103):_0x26fe77*=1.2;break;case _0x116f60(0x1d4):_0x26fe77*=1.1;break;case _0x116f60(0x1c3):if(_0x40745c[_0x116f60(0x187)]&&_0x450699>0x0){const _0x41d656=_0x40745c[_0x116f60(0x187)]/_0x450699;_0x26fe77*=0x1+_0x41d656;}break;}const _0x375459=_0x1dfc8e[_0x116f60(0x12f)]*_0x1e315e+(_0x1dfc8e[_0x116f60(0x18a)]||0x0)*(0x1-_0x1e315e),_0x462330=_0x375459*_0x26fe77;return{'text':_0x1dfc8e['text'],'score':_0x1dfc8e['score'],'rerank_score':_0x1dfc8e[_0x116f60(0x12f)],'final_score':_0x462330,'metadata':_0x1dfc8e[_0x116f60(0xf3)]};});_0x140e7f[_0x4fc55a(0x104)]((_0xe3eb67,_0x1ab90a)=>(_0x1ab90a[_0x4fc55a(0x188)]||0x0)-(_0xe3eb67[_0x4fc55a(0x188)]||0x0)),console[_0x4fc55a(0xff)](_0x4fc55a(0x190));if(_0x2c2577[_0x4fc55a(0x17f)]['superSortEnabled']){const _0x478c2d=superSort(_0x140e7f);return _0x478c2d[_0x4fc55a(0x1d6)](0x0,_0x2c2577[_0x4fc55a(0x17f)][_0x4fc55a(0x123)]);}return _0x140e7f[_0x4fc55a(0x1d6)](0x0,_0x2c2577[_0x4fc55a(0x17f)][_0x4fc55a(0x123)]);}async function rearrangeChat(_0x5811a4,_0x2f7ad4,_0x50e774,_0x516482){const _0x56c2e3=_0x4826de,_0x328789={'novel':_0x56c2e3(0x13a),'chat_history':_0x56c2e3(0x100),'lorebook':_0x56c2e3(0xfb),'manual':_0x56c2e3(0x122)};Object['values'](_0x328789)['forEach'](_0x596e56=>{setExtensionPrompt(_0x596e56,'',0x0,0x0,![],0x0);});if(_0x516482===_0x56c2e3(0x18d)||!settings[_0x56c2e3(0x16f)][_0x56c2e3(0x1c9)])return;const _0x12d70d=_0x5811a4[_0x56c2e3(0x1d6)](-settings[_0x56c2e3(0x1a1)][_0x56c2e3(0x1ab)]);if(_0x12d70d[_0x56c2e3(0x145)]===0x0)return;const _0x4fc7d6=_0x12d70d[_0x56c2e3(0x19f)](_0x109e31=>_0x109e31['mes'])[_0x56c2e3(0x161)]('\x20')[_0x56c2e3(0x14e)](/<[^>]*>/g,'')[_0x56c2e3(0x1e5)]();if(!_0x4fc7d6)return;try{const _0x4f9d29=await queryVectors(_0x4fc7d6);console[_0x56c2e3(0xff)](_0x56c2e3(0x13e),JSON['stringify'](_0x4f9d29[_0x56c2e3(0x19f)](_0x4cc4b7=>_0x4cc4b7[_0x56c2e3(0xf3)]),null,0x2));if(_0x4f9d29['length']===0x0)return;const _0x231a8a=await rerankResults(_0x4f9d29,_0x4fc7d6,settings);if(_0x231a8a['length']===0x0)return;console[_0x56c2e3(0xff)](_0x56c2e3(0x19c),JSON[_0x56c2e3(0x195)](_0x231a8a[_0x56c2e3(0x19f)](_0x38033d=>_0x38033d['metadata']),null,0x2));const _0x4b2530={'novel':[],'chat_history':[],'lorebook':[],'manual':[]};_0x231a8a['forEach'](_0x5dd174=>{const _0x1410a9=_0x56c2e3,_0x445d31=_0x5dd174[_0x1410a9(0xf3)]?.[_0x1410a9(0xf7)];_0x445d31&&_0x4b2530[_0x1410a9(0x1ad)](_0x445d31)&&_0x4b2530[_0x445d31][_0x1410a9(0x16e)](_0x5dd174);}),console[_0x56c2e3(0xff)](_0x56c2e3(0x162),JSON['stringify'](Object['keys'](_0x4b2530)[_0x56c2e3(0xef)]((_0x541bed,_0x1a21d4)=>{return _0x541bed[_0x1a21d4]=_0x4b2530[_0x1a21d4]['length'],_0x541bed;},{}),null,0x2));for(const _0x19c9c7 in _0x4b2530){const _0x10e456=_0x4b2530[_0x19c9c7];if(_0x10e456[_0x56c2e3(0x145)]===0x0)continue;const _0x301ff0=settings[_0x56c2e3(0x184)+_0x19c9c7[_0x56c2e3(0x14e)](_0x56c2e3(0x11e),'')];if(!_0x301ff0){console['warn'](_0x56c2e3(0x15a)+_0x19c9c7+'\x27\x20的注入设置，跳过处理。');continue;}const _0x3b799=_0x10e456[_0x56c2e3(0x19f)](_0x5c895d=>_0x5c895d['text'])[_0x56c2e3(0x161)]('\x0a\x0a'),_0xf4f780='{{'+_0x19c9c7[_0x56c2e3(0x14e)](_0x56c2e3(0x11e),'')+_0x56c2e3(0x1e0);let _0x1a4d36=_0x301ff0[_0x56c2e3(0x1a5)][_0x56c2e3(0x14e)](_0xf4f780,_0x3b799);_0x1a4d36[_0x56c2e3(0x1e5)]()&&(_0x1a4d36='%%'+_0x328789[_0x19c9c7]+'%%'+_0x1a4d36),setExtensionPrompt(_0x328789[_0x19c9c7],_0x1a4d36,_0x301ff0[_0x56c2e3(0x1d7)],_0x301ff0[_0x56c2e3(0x17e)],![],_0x301ff0[_0x56c2e3(0xf8)]),console['log'](_0x56c2e3(0x1db)+_0x19c9c7+'\x27\x20注入\x20'+_0x10e456['length']+_0x56c2e3(0x12c));}}catch(_0x36e86f){console[_0x56c2e3(0x135)](_0x56c2e3(0x1c1),_0x36e86f);if(settings[_0x56c2e3(0x16f)][_0x56c2e3(0x166)])showNotification(_0x56c2e3(0x124)+_0x36e86f[_0x56c2e3(0x181)],_0x56c2e3(0x135));}}async function moveKnowledgeBase(_0x4c26e3,_0xcaa511){const _0x4b8edb=_0x4826de,_0x55f9fc=_0xcaa511===_0x4b8edb(0x1b0)?_0x4b8edb(0x165):_0x4b8edb(0x1b0),_0x4b3ca5=getCharacterStableId();if(!_0x4b3ca5&&_0x55f9fc===_0x4b8edb(0x165)){toastr[_0x4b8edb(0x135)](_0x4b8edb(0x11f));return;}const _0x41dd26=_0xcaa511===_0x4b8edb(0x1b0)?getGlobalKnowledgeBases():getLocalKnowledgeBases(),_0x1d9a8e=_0x55f9fc==='global'?getGlobalKnowledgeBases():getLocalKnowledgeBases(),_0x340815=_0x41dd26[_0x4c26e3];if(!_0x340815){const _0x3d6b4d=_0x4b8edb(0x116)+_0xcaa511+_0x4b8edb(0x173)+_0x4c26e3+'\x20的知识库。';console['error'](_0x4b8edb(0x1e1)+_0x3d6b4d),toastr[_0x4b8edb(0x135)]('移动失败：未找到源条目。');return;}_0xcaa511===_0x4b8edb(0x165)&&_0x55f9fc==='global'&&!_0x340815[_0x4b8edb(0x15e)]&&(console[_0x4b8edb(0xff)](_0x4b8edb(0x198)+_0x4c26e3+_0x4b8edb(0x172)+_0x4b3ca5),_0x340815[_0x4b8edb(0x15e)]=_0x4b3ca5);delete _0x41dd26[_0x4c26e3],_0x1d9a8e[_0x4c26e3]=_0x340815,saveSettings();const _0x1ca1a2='知识库【'+_0x340815[_0x4b8edb(0x185)]+'】已成功移动到'+(_0x55f9fc===_0x4b8edb(0x1b0)?'全局':'局部')+'。';console['log'](_0x4b8edb(0x1e1)+_0x1ca1a2);}async function getAllVectorsFromCollection(_0x5d84f4){const _0x583732=_0x4826de,_0x22a122='*',_0x9a317c={'collectionId':_0x5d84f4,'searchText':_0x22a122,'topK':0x2710,'threshold':0x0,'source':_0x583732(0x1b9),'embeddings':{}},_0x402da2=(await getEmbeddings([_0x22a122]))[0x0];_0x9a317c['embeddings']={[_0x22a122]:_0x402da2};const _0x5d7fdf=await fetch(_0x583732(0xfa),{'method':'POST','headers':context[_0x583732(0x174)](),'body':JSON[_0x583732(0x195)](_0x9a317c)});if(!_0x5d7fdf['ok']){if(_0x5d7fdf[_0x583732(0xf6)]===0x194)return console[_0x583732(0xff)](_0x583732(0x118)+_0x5d84f4+'\x20不存在，返回空数组。'),[];const _0x129f83=await _0x5d7fdf[_0x583732(0x1cb)]();throw new Error(_0x583732(0x1ea)+_0x5d84f4+_0x583732(0x1d9)+_0x129f83);}const _0x6f43d0=await _0x5d7fdf['json']();return _0x6f43d0[_0x583732(0xf3)]||_0x6f43d0[_0x583732(0x17c)]||_0x6f43d0[_0x583732(0x14c)]||[];}
