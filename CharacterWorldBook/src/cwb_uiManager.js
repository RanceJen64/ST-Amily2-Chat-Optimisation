(function(_0x3d1814,_0x28b7f1){const _0x1e077f=_0x3a48,_0xad3d44=_0x3d1814();while(!![]){try{const _0x3d76b1=-parseInt(_0x1e077f(0x1b9))/0x1+-parseInt(_0x1e077f(0x190))/0x2*(-parseInt(_0x1e077f(0x21f))/0x3)+parseInt(_0x1e077f(0x1a6))/0x4*(parseInt(_0x1e077f(0x200))/0x5)+parseInt(_0x1e077f(0x239))/0x6+-parseInt(_0x1e077f(0x20e))/0x7+parseInt(_0x1e077f(0x1aa))/0x8+-parseInt(_0x1e077f(0x24a))/0x9;if(_0x3d76b1===_0x28b7f1)break;else _0xad3d44['push'](_0xad3d44['shift']());}catch(_0x433421){_0xad3d44['push'](_0xad3d44['shift']());}}}(_0x4ef5,0xc7df1));function _0x4ef5(){const _0xb6b3c6=['加载角色卡数据时出错。','<div\x20class=\x22cwb-cyber-card\x20cwb-cyber-card--nested\x22><h5\x20class=\x22cwb-cyber-card__title\x22>','after_an','custom','each','.cwb-insertion-position','</textarea>','更新完成，正在刷新查看器...','css','4299lefXbQ','#cwb-viewer-delete-all','Amily2角色总集','人物总览','map','核心特质','.cwb-insertion-settings-content','selected','\x22\x20data-uid=\x22','change','closest','hide','error','<div\x20class=\x22cwb-cyber-card\x20cwb-insertion-settings-card\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h4\x20class=\x22cwb-cyber-card__title\x22>注入设置</h4>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22cwb-cyber-card__content\x20cwb-insertion-settings-content\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22cwb-cyber-field\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20class=\x22cwb-cyber-field__label\x22\x20for=\x22cwb-insertion-position-','\x22\x20type=\x22number\x22\x20class=\x22cwb-cyber-field__input\x20cwb-insertion-order\x22\x20value=\x22','<div\x20class=\x22cwb-cyber-popup__header\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h3\x20class=\x22cwb-cyber-popup__title\x22><i\x20class=\x22fa-solid\x20fa-book-atlas\x22></i>\x20角色数据核心</h3>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22cwb-cyber-popup__actions\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20id=\x22cwb-manual-update-btn\x22\x20class=\x22cwb-cyber-button\x22\x20title=\x22手动更新当前角色的描述\x22><i\x20class=\x22fa-solid\x20fa-wand-magic-sparkles\x22></i>\x20更新</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20id=\x22cwb-viewer-refresh\x22\x20class=\x22cwb-cyber-button\x22\x20title=\x22从世界书重新加载所有角色卡\x22><i\x20class=\x22fa-solid\x20fa-arrows-rotate\x22></i>\x20刷新</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20id=\x22cwb-viewer-delete-all\x22\x20class=\x22cwb-cyber-button\x20cwb-cyber-button--danger\x22\x20title=\x22删除当前聊天中的所有角色卡和总览\x22><i\x20class=\x22fa-solid\x20fa-trash-can\x22></i>\x20清除</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22cwb-viewer-popup-close-button\x22>&times;</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>','\x22\x20min=\x220\x22\x20max=\x229999\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22cwb-cyber-field\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20class=\x22cwb-cyber-field__label\x22\x20for=\x22cwb-insertion-order-','\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22cwb-cyber-tab__button\x22\x20data-char-uid=\x22','保存失败:\x20','height','top','replace','social_matrix','left','insertionDepth','getItem','375828LpQiaA','>作者注释之前</option>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<option\x20value=\x22after_an\x22\x20','insertionOrder','.cwb-viewer-popup-close-button','<textarea\x20class=\x22cwb-cyber-field__input\x22\x20data-path=\x22','.cwb-save-button','.cwb-cyber-content-pane','addClass','\x22\x20class=\x22cwb-cyber-popup\x22>','outerHeight','\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<option\x20value=\x22before_char\x22\x20','enabled','includes','parsed','sqrt','<div\x20class=\x22cwb-cyber-field\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20class=\x22cwb-cyber-field__label\x22>','[DEBUG]\x20原始条目数据\x20UID:','2202453tXlFBM','.cwb-cyber-tab__button','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>','object','[DEBUG]\x20界面收集值\x20UID:','\x22\x20data-uid-wrapper=\x22','touches','trim','path','<i\x20class=\x22fas\x20fa-spinner\x20fa-spin\x22></i>\x20更新中...','>作者注释之后</option>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<option\x20value=\x22at_depth\x22\x20','\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20class=\x22cwb-cyber-field__label\x22\x20for=\x22cwb-insertion-depth-','#cwb-char-content-','type','[DEBUG]\x20最终保存数据\x20UID:','内心挣扎','text','\x22\x20class=\x22cwb-cyber-field__input\x20cwb-insertion-position\x22\x20data-uid=\x22','physical_imprint','remove','keys','关键关系','身份原型','</label>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','社交矩阵','order','disabled','性格详述','438fdVwQE','特质定义','max','viewerEnabled','filter','当前状态','120px','min','.cwb-insertion-depth-container','isRoster','offset','\x20的修改\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>','at_depth','active','comment','<div\x20class=\x22cwb-cyber-content-pane__footer\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22cwb-cyber-button\x20cwb-cyber-button--primary\x20cwb-save-button\x22\x20data-uid=\x22','第一印象','正在刷新角色数据...','touchend.cwbViewer','clientX','info','before_an','8Gawrub','stringify','push','core_identity','11314896IuQnbw','角色总览','<div\x20class=\x22cwb-cyber-card\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h4\x20class=\x22cwb-cyber-card__title\x22>人物总览\x20(只读)</h4>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22cwb-cyber-card__content\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<textarea\x20readonly\x20class=\x22cwb-cyber-field__input\x22\x20style=\x22height:\x20400px;\x22>','concat','touchmove','content','价值观','setLorebookEntries','clientY','grabbing','length','<div\x20class=\x22cwb-cyber-tabs\x22>','STORAGE_KEY_VIEWER_BUTTON_POS','resize.cwbViewer','touchmove.cwbViewer','964131WcRTvM','声音特征','<i\x20class=\x22fas\x20fa-spinner\x20fa-spin\x22></i>\x20保存中...','角色卡已成功保存！','关系人姓名','</textarea>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>','grab','find','char-uid','position','\x22\x20rows=\x22','join','风格总结','[DEBUG]\x20映射结果\x20UID:','\x22\x20min=\x220\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>','innerWidth','他人声望','<div\x20class=\x22cwb-cyber-popup__body\x20cwb-cyber-popup__body--empty\x22><p>数据链路中断...未在当前世界书协议中找到角色数据。请执行一次手动更新以初始化链接。</p></div></div>','当前角色未设置主世界书或自定义世界书。','prop','none','auto','removeClass','forEach','html','>角色定义之后</option>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<option\x20value=\x22before_an\x22\x20','Invalid\x20chat\x20identifier\x20\x22','before_character_definition','mousemove.cwbViewer','entries','after_character_definition','after_author_note','\x22\x20title=\x22查看角色世界书\x22\x20class=\x22fa-solid\x20fa-book-open\x22></div>','split','10px','cwb-cyber-tab\x20active','互动风格','</h5><div\x20class=\x22cwb-cyber-card__content\x22>','touchstart','display:\x20none;','toggle','first','stopPropagation','after_char','\x22>注入顺序</label>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20id=\x22cwb-insertion-order-','depth','角色\x20','代表性引言','未知实体\x20','.cwb-cyber-tab','#cwb-manual-update-btn','</div>','before_char','click','核心认同','append','before_author_note','psyche_profile','\x22\x20id=\x22cwb-char-content-','无法在世界书中找到原始条目。','getLorebookEntries','未找到目标世界书。','data','outerWidth','.cwb-cyber-tab__delete','<div\x20class=\x22cwb-cyber-card\x22><h4\x20class=\x22cwb-cyber-card__title\x22>','\x22\x20data-is-array=\x22','<div\x20class=\x22cwb-cyber-popup__body\x22>','<div\x20class=\x22cwb-cyber-content-pane\x20','val','message','1625510SxDdHM','物理印记','narrative_essence','name','#cwb-viewer-refresh','无法显示角色卡查看器:','\x22\x20for\x20viewer.','preventDefault','cursor','悬浮窗按钮显示状态更新:','\x22>注入位置</label>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<select\x20id=\x22cwb-insertion-position-','uid','</h4><div\x20class=\x22cwb-cyber-card__content\x22>','insertionPosition','2894570wOySav','setItem','body','trigger','保存修改','isArray','unknown_chat','worldbookTarget'];_0x4ef5=function(){return _0xb6b3c6;};return _0x4ef5();}import{SCRIPT_ID_PREFIX,CHAR_CARD_VIEWER_BUTTON_ID,CHAR_CARD_VIEWER_POPUP_ID,state}from'./cwb_state.js';import{logDebug,logError,showToastr,escapeHtml,parseCustomFormat,buildCustomFormat,isCwbEnabled}from'./cwb_utils.js';import{deleteLorebookEntries,getTargetWorldBook}from'./cwb_lorebookManager.js';import{manualUpdateLogic}from'./cwb_core.js';const {jQuery:$,SillyTavern,TavernHelper}=window;function createCharCardViewerPopupHtml(_0x42e31d){const _0xe6020c=_0x3a48,_0x4acc26={'narrative_essence.core_traits.name':'特质名称','narrative_essence.key_relationships.name':_0xe6020c(0x1bd)},_0x1b223c={'name':'姓名','archetype':_0xe6020c(0x260),'gender':'性别','age':'年龄','race':'种族','current_status':_0xe6020c(0x195),'first_impression':_0xe6020c(0x1a0),'key_features':'显著特征','attire':'衣着风格','mannerisms':'习惯举止','voice':_0xe6020c(0x1ba),'tags':'性格标签','description':_0xe6020c(0x265),'motivation':'内在驱动','values':_0xe6020c(0x1b0),'inner_conflict':_0xe6020c(0x259),'interaction_style':_0xe6020c(0x1dd),'skills':'技能能力','reputation':_0xe6020c(0x1c9),'core_traits':_0xe6020c(0x224),'verbal_patterns':'语言范式','key_relationships':_0xe6020c(0x25f),'definition':_0xe6020c(0x191),'evidence':'具体事例','style_summary':_0xe6020c(0x1c5),'quotes':_0xe6020c(0x1e8),'summary':'关系概述'},_0x26e377=(_0x544cb7,_0xa1f90b)=>{const _0x46c94d=_0xe6020c,_0xce5776=_0xa1f90b[_0x46c94d(0x234)](/\.\d+\./g,'.');if(_0x4acc26[_0xce5776])return _0x4acc26[_0xce5776];return _0x1b223c[_0x544cb7]||_0x544cb7[_0x46c94d(0x234)](/_/g,'\x20');},_0x2fa129=(_0x4418bd,_0x2af5ca,_0x50e039,_0x15c046=![],_0x49b45f=![])=>{const _0x64b22d=_0xe6020c,_0x1586bc=escapeHtml(_0x4418bd),_0x681971=escapeHtml(_0x49b45f?_0x50e039[_0x64b22d(0x1c4)]('\x0a'):_0x50e039||''),_0xbaf34=_0x50e039&&String(_0x50e039)['length']>0x32||Array[_0x64b22d(0x213)](_0x50e039)&&_0x50e039[_0x64b22d(0x1b4)]>0x1,_0x209d4d=_0x49b45f?Math[_0x64b22d(0x192)](0x3,_0x50e039[_0x64b22d(0x1b4)]):_0xbaf34?0x4:0x2,_0x221dfd=_0x64b22d(0x23d)+_0x2af5ca+_0x64b22d(0x1fb)+_0x49b45f+_0x64b22d(0x1c3)+_0x209d4d+'\x22>'+_0x681971+_0x64b22d(0x21c);return _0x64b22d(0x248)+_0x1586bc+_0x64b22d(0x261)+_0x221dfd+_0x64b22d(0x24c);},_0x2e5e8f=(_0x3ecd3d,_0x4e9179,_0x409004)=>{const _0x182088=_0xe6020c;if(!_0x4e9179||typeof _0x4e9179!==_0x182088(0x24d)||Object['keys'](_0x4e9179)[_0x182088(0x1b4)]===0x0)return'';let _0x44d705=_0x182088(0x1fa)+escapeHtml(_0x3ecd3d)+_0x182088(0x20c);for(const [_0x5d0e40,_0x3b9e5e]of Object[_0x182088(0x1d6)](_0x4e9179)){const _0x434468=_0x409004?_0x409004+'.'+_0x5d0e40:_0x5d0e40,_0x191de8=_0x26e377(_0x5d0e40,_0x434468);if(typeof _0x3b9e5e===_0x182088(0x24d)&&_0x3b9e5e!==null&&!Array['isArray'](_0x3b9e5e))_0x44d705+=_0x2e5e8f(_0x191de8,_0x3b9e5e,_0x434468);else Array[_0x182088(0x213)](_0x3b9e5e)&&_0x3b9e5e[_0x182088(0x1b4)]>0x0&&typeof _0x3b9e5e[0x0]===_0x182088(0x24d)?(_0x44d705+=_0x182088(0x217)+escapeHtml(_0x191de8)+_0x182088(0x1de),_0x3b9e5e[_0x182088(0x1d0)]((_0x22cde0,_0x353db4)=>{const _0x5bf2bc=_0x182088;_0x44d705+='<div\x20class=\x22cwb-cyber-list-item\x22>';for(const [_0x3994cb,_0x316598]of Object[_0x5bf2bc(0x1d6)](_0x22cde0)){const _0x51481d=_0x434468+'.'+_0x353db4+'.'+_0x3994cb;_0x44d705+=_0x2fa129(_0x26e377(_0x3994cb,_0x51481d),_0x51481d,_0x316598,![],Array[_0x5bf2bc(0x213)](_0x316598));}_0x44d705+=_0x5bf2bc(0x1ec);}),_0x44d705+='</div></div>'):_0x44d705+=_0x2fa129(_0x191de8,_0x434468,_0x3b9e5e,![],Array[_0x182088(0x213)](_0x3b9e5e));}return _0x44d705+='</div></div>',_0x44d705;};let _0x4ab4e8='<div\x20id=\x22'+CHAR_CARD_VIEWER_POPUP_ID+_0xe6020c(0x241);_0x4ab4e8+=_0xe6020c(0x22e);if(!_0x42e31d||_0x42e31d['length']===0x0)return _0x4ab4e8+=_0xe6020c(0x1ca),_0x4ab4e8;return _0x4ab4e8+='<div\x20class=\x22cwb-cyber-popup__main-content\x22>',_0x4ab4e8+=_0xe6020c(0x1b5),_0x42e31d['forEach']((_0x197301,_0x39fecd)=>{const _0x449625=_0xe6020c,_0x12dcc2=_0x197301[_0x449625(0x199)]?_0x449625(0x222):_0x197301[_0x449625(0x246)]?.[_0x449625(0x203)]||_0x449625(0x1e9)+(_0x39fecd+0x1),_0x5947a3=_0x39fecd===0x0?_0x449625(0x1dc):'cwb-cyber-tab';_0x4ab4e8+='<div\x20class=\x22'+_0x5947a3+_0x449625(0x24f)+_0x197301[_0x449625(0x20b)]+_0x449625(0x230)+_0x197301[_0x449625(0x20b)]+'\x22>'+escapeHtml(_0x12dcc2)+'</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22cwb-cyber-tab__delete\x22\x20data-char-uid=\x22'+_0x197301[_0x449625(0x20b)]+'\x22\x20title=\x22删除此条目\x22><i\x20class=\x22fa-solid\x20fa-times\x22></i></button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>';}),_0x4ab4e8+=_0xe6020c(0x1ec),_0x4ab4e8+=_0xe6020c(0x1fc),_0x42e31d[_0xe6020c(0x1d0)]((_0x41bcc2,_0x256c08)=>{const _0xc7d08=_0xe6020c;_0x4ab4e8+=_0xc7d08(0x1fd)+(_0x256c08===0x0?'active':'')+_0xc7d08(0x1f3)+_0x41bcc2[_0xc7d08(0x20b)]+_0xc7d08(0x227)+_0x41bcc2[_0xc7d08(0x20b)]+'\x22>';if(_0x41bcc2[_0xc7d08(0x199)])_0x4ab4e8+=_0xc7d08(0x1ac)+escapeHtml(_0x41bcc2[_0xc7d08(0x1af)])+_0xc7d08(0x1be);else{const _0x62a01d=_0x41bcc2[_0xc7d08(0x246)];if(_0x62a01d){const _0x25adee=_0x62a01d['name']||_0xc7d08(0x1e7)+(_0x256c08+0x1);if(_0x62a01d['name'])_0x4ab4e8+=_0x2e5e8f('姓名',{'name':_0x62a01d[_0xc7d08(0x203)]},'');if(_0x62a01d[_0xc7d08(0x1a9)])_0x4ab4e8+=_0x2e5e8f(_0xc7d08(0x1ef),_0x62a01d['core_identity'],_0xc7d08(0x1a9));if(_0x62a01d[_0xc7d08(0x25c)])_0x4ab4e8+=_0x2e5e8f(_0xc7d08(0x201),_0x62a01d[_0xc7d08(0x25c)],_0xc7d08(0x25c));if(_0x62a01d[_0xc7d08(0x1f2)])_0x4ab4e8+=_0x2e5e8f('心智侧写',_0x62a01d[_0xc7d08(0x1f2)],'psyche_profile');if(_0x62a01d['social_matrix'])_0x4ab4e8+=_0x2e5e8f(_0xc7d08(0x262),_0x62a01d['social_matrix'],_0xc7d08(0x235));if(_0x62a01d[_0xc7d08(0x202)])_0x4ab4e8+=_0x2e5e8f('叙事精粹',_0x62a01d['narrative_essence'],'narrative_essence');_0x4ab4e8+=_0xc7d08(0x22c)+_0x41bcc2['uid']+_0xc7d08(0x20a)+_0x41bcc2[_0xc7d08(0x20b)]+_0xc7d08(0x25b)+_0x41bcc2[_0xc7d08(0x20b)]+_0xc7d08(0x243)+(_0x41bcc2[_0xc7d08(0x20d)]==='before_char'?_0xc7d08(0x226):'')+'>角色定义之前</option>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<option\x20value=\x22after_char\x22\x20'+(_0x41bcc2[_0xc7d08(0x20d)]===_0xc7d08(0x1e4)?_0xc7d08(0x226):'')+_0xc7d08(0x1d2)+(_0x41bcc2['insertionPosition']==='before_an'?_0xc7d08(0x226):'')+_0xc7d08(0x23a)+(_0x41bcc2[_0xc7d08(0x20d)]===_0xc7d08(0x218)?'selected':'')+_0xc7d08(0x254)+(_0x41bcc2['insertionPosition']===_0xc7d08(0x19c)?_0xc7d08(0x226):'')+'>@D\x20注入指定深度</option>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</select>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22cwb-cyber-field\x20cwb-insertion-depth-container\x22\x20style=\x22'+(_0x41bcc2[_0xc7d08(0x20d)]===_0xc7d08(0x19c)?'':_0xc7d08(0x1e0))+_0xc7d08(0x255)+_0x41bcc2[_0xc7d08(0x20b)]+'\x22>注入深度</label>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20id=\x22cwb-insertion-depth-'+_0x41bcc2[_0xc7d08(0x20b)]+'\x22\x20type=\x22number\x22\x20class=\x22cwb-cyber-field__input\x20cwb-insertion-depth\x22\x20value=\x22'+_0x41bcc2[_0xc7d08(0x237)]+_0xc7d08(0x22f)+_0x41bcc2[_0xc7d08(0x20b)]+_0xc7d08(0x1e5)+_0x41bcc2['uid']+_0xc7d08(0x22d)+_0x41bcc2[_0xc7d08(0x23b)]+_0xc7d08(0x1c7),_0x4ab4e8+=_0xc7d08(0x19f)+_0x41bcc2[_0xc7d08(0x20b)]+'\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<i\x20class=\x22fa-solid\x20fa-save\x22></i>\x20保存对\x20'+escapeHtml(_0x25adee)+_0xc7d08(0x19b);}}_0x4ab4e8+=_0xc7d08(0x1ec);}),_0x4ab4e8+='</div></div></div>',_0x4ab4e8;}function bindCharCardViewerPopupEvents(_0x4aa1d0){const _0x44c82c=_0x3a48;_0x4aa1d0['on'](_0x44c82c(0x228),_0x44c82c(0x21b),function(){const _0x1de4c2=_0x44c82c,_0xa47e5a=$(this),_0x1b8b97=_0xa47e5a[_0x1de4c2(0x229)](_0x1de4c2(0x225))[_0x1de4c2(0x1c0)](_0x1de4c2(0x198));_0xa47e5a[_0x1de4c2(0x1fe)]()===_0x1de4c2(0x19c)?_0x1b8b97['show']():_0x1b8b97[_0x1de4c2(0x22a)]();}),_0x4aa1d0['on'](_0x44c82c(0x1ee),_0x44c82c(0x23c),closeCharCardViewerPopup),_0x4aa1d0[_0x44c82c(0x1c0)](_0x44c82c(0x204))['on'](_0x44c82c(0x1ee),()=>{const _0x4b7506=_0x44c82c;showToastr(_0x4b7506(0x1a4),_0x4b7506(0x1a1)),showCharCardViewerPopup();}),_0x4aa1d0['find'](_0x44c82c(0x1eb))['on'](_0x44c82c(0x1ee),async function(){const _0x1a4b0a=_0x44c82c,_0x1c6f63=$(this);_0x1c6f63[_0x1a4b0a(0x1cc)](_0x1a4b0a(0x264),!![])['html'](_0x1a4b0a(0x253)),await manualUpdateLogic(),showToastr(_0x1a4b0a(0x1a4),_0x1a4b0a(0x21d)),showCharCardViewerPopup();}),_0x4aa1d0[_0x44c82c(0x1c0)](_0x44c82c(0x24b))['on'](_0x44c82c(0x1ee),function(){const _0x5f4c6f=_0x44c82c,_0x1bda1d=$(this),_0xcbacb0=_0x1bda1d[_0x5f4c6f(0x1f7)](_0x5f4c6f(0x1c1));_0x4aa1d0['find'](_0x5f4c6f(0x1ea))[_0x5f4c6f(0x1cf)](_0x5f4c6f(0x19d)),_0x1bda1d[_0x5f4c6f(0x229)](_0x5f4c6f(0x1ea))[_0x5f4c6f(0x240)](_0x5f4c6f(0x19d)),_0x4aa1d0[_0x5f4c6f(0x1c0)](_0x5f4c6f(0x23f))[_0x5f4c6f(0x1cf)](_0x5f4c6f(0x19d)),_0x4aa1d0[_0x5f4c6f(0x1c0)](_0x5f4c6f(0x256)+_0xcbacb0)[_0x5f4c6f(0x240)](_0x5f4c6f(0x19d));}),_0x4aa1d0[_0x44c82c(0x1c0)](_0x44c82c(0x1f9))['on'](_0x44c82c(0x1ee),async function(_0x5961b9){const _0x3791f1=_0x44c82c;_0x5961b9[_0x3791f1(0x1e3)]();const _0x26c5d3=$(this)[_0x3791f1(0x1f7)](_0x3791f1(0x1c1));await deleteLorebookEntries([_0x26c5d3]);const _0x26b2ef=$(this)[_0x3791f1(0x229)](_0x3791f1(0x1ea)),_0x58faee=_0x4aa1d0[_0x3791f1(0x1c0)]('#cwb-char-content-'+_0x26c5d3),_0x1e2f36=_0x26b2ef['hasClass'](_0x3791f1(0x19d));_0x26b2ef[_0x3791f1(0x25d)](),_0x58faee[_0x3791f1(0x25d)]();if(_0x1e2f36&&_0x4aa1d0[_0x3791f1(0x1c0)](_0x3791f1(0x1ea))[_0x3791f1(0x1b4)]>0x0)_0x4aa1d0[_0x3791f1(0x1c0)]('.cwb-cyber-tab')[_0x3791f1(0x1e2)]()[_0x3791f1(0x1c0)](_0x3791f1(0x24b))[_0x3791f1(0x211)](_0x3791f1(0x1ee));else _0x4aa1d0[_0x3791f1(0x1c0)]('.cwb-cyber-tab')[_0x3791f1(0x1b4)]===0x0&&showCharCardViewerPopup();}),_0x4aa1d0[_0x44c82c(0x1c0)](_0x44c82c(0x220))['on'](_0x44c82c(0x1ee),async function(){const _0x173980=_0x44c82c,_0x4c3871=_0x4aa1d0[_0x173980(0x1c0)]('.cwb-cyber-tab__button')['map'](function(){const _0x339ec7=_0x173980;return $(this)[_0x339ec7(0x1f7)](_0x339ec7(0x1c1));})['get']();_0x4c3871[_0x173980(0x1b4)]>0x0&&await deleteLorebookEntries(_0x4c3871),showCharCardViewerPopup();}),_0x4aa1d0[_0x44c82c(0x1c0)](_0x44c82c(0x23e))['on']('click',async function(){const _0x6314ad=_0x44c82c,_0x1abda3=$(this),_0x4d8f36=_0x1abda3[_0x6314ad(0x1f7)](_0x6314ad(0x20b));_0x1abda3['prop'](_0x6314ad(0x264),!![])[_0x6314ad(0x1d1)](_0x6314ad(0x1bb));try{const _0x52f79e=await getTargetWorldBook();if(!_0x52f79e)throw new Error(_0x6314ad(0x1f6));const _0x527765=_0x4aa1d0['find'](_0x6314ad(0x256)+_0x4d8f36),_0x52a7b2={},_0x4b626e=(_0x376778,_0x3902fe,_0x3e4f23)=>{const _0x4a61fb=_0x6314ad,_0xb74cc7=_0x3902fe[_0x4a61fb(0x1da)]('.');let _0x4d036d=_0x376778;_0xb74cc7[_0x4a61fb(0x1d0)]((_0x39d8c5,_0x36bf00)=>{const _0xcdb494=_0x4a61fb;if(_0x36bf00===_0xb74cc7[_0xcdb494(0x1b4)]-0x1)_0x4d036d[_0x39d8c5]=_0x3e4f23===''?null:_0x3e4f23;else{const _0x267a6c=/^\d+$/['test'](_0xb74cc7[_0x36bf00+0x1]);!_0x4d036d[_0x39d8c5]&&(_0x4d036d[_0x39d8c5]=_0x267a6c?[]:{}),_0x4d036d=_0x4d036d[_0x39d8c5];}});};_0x527765[_0x6314ad(0x1c0)]('.cwb-cyber-field__input')[_0x6314ad(0x21a)](function(){const _0x5e3f07=_0x6314ad,_0xfef23f=$(this),_0x4430ce=_0xfef23f[_0x5e3f07(0x1f7)](_0x5e3f07(0x252));let _0xf9d476=_0xfef23f[_0x5e3f07(0x1fe)]();_0xfef23f['data']('is-array')&&(_0xf9d476=_0xf9d476[_0x5e3f07(0x1da)]('\x0a')['map'](_0x150188=>_0x150188[_0x5e3f07(0x251)]())[_0x5e3f07(0x194)](Boolean)),_0x4430ce&&_0x4b626e(_0x52a7b2,_0x4430ce,_0xf9d476);});const _0x2ef4dc=buildCustomFormat(_0x52a7b2),_0x3631e1=await TavernHelper[_0x6314ad(0x1f5)](_0x52f79e),_0x5e63e7=_0x3631e1[_0x6314ad(0x1c0)](_0x20e3ff=>_0x20e3ff[_0x6314ad(0x20b)]===_0x4d8f36);if(!_0x5e63e7)throw new Error(_0x6314ad(0x1f4));const _0x492969=_0x527765[_0x6314ad(0x1c0)](_0x6314ad(0x21b))['val'](),_0x8020da=parseInt(_0x527765[_0x6314ad(0x1c0)]('.cwb-insertion-depth')['val'](),0xa),_0x3c31ec=parseInt(_0x527765['find']('.cwb-insertion-order')[_0x6314ad(0x1fe)](),0xa);logDebug(_0x6314ad(0x24e)+_0x4d8f36,{'insertionPosition':_0x492969,'insertionDepth':_0x8020da,'insertionOrder':_0x3c31ec});const _0x41d898={'before_char':_0x6314ad(0x1d4),'after_char':_0x6314ad(0x1d7),'before_an':_0x6314ad(0x1f1),'after_an':_0x6314ad(0x1d8),'at_depth':'at_depth_as_system'},_0x56536c={..._0x5e63e7};_0x56536c[_0x6314ad(0x1af)]=_0x2ef4dc,_0x56536c['uid']=_0x4d8f36;const _0x3ca3b2=_0x41d898[_0x492969];_0x56536c[_0x6314ad(0x1c2)]=_0x3ca3b2||_0x6314ad(0x1d4),_0x492969===_0x6314ad(0x19c)?_0x56536c[_0x6314ad(0x1e6)]=isNaN(_0x8020da)?0x0:_0x8020da:_0x56536c['depth']=null,_0x56536c[_0x6314ad(0x263)]=isNaN(_0x3c31ec)?0x1b59:_0x3c31ec,logDebug(_0x6314ad(0x258)+_0x4d8f36,{'position':_0x56536c['position'],'depth':_0x56536c['depth'],'order':_0x56536c[_0x6314ad(0x263)],'hasDepthField':_0x6314ad(0x1e6)in _0x56536c}),await TavernHelper[_0x6314ad(0x1b1)](_0x52f79e,[_0x56536c]),showToastr('success',_0x6314ad(0x1bc));}catch(_0xe96a9d){logError('保存角色卡失败:',_0xe96a9d),showToastr(_0x6314ad(0x22b),_0x6314ad(0x231)+_0xe96a9d[_0x6314ad(0x1ff)]);}finally{_0x1abda3['prop'](_0x6314ad(0x264),![])[_0x6314ad(0x25a)](_0x6314ad(0x212));}});}function closeCharCardViewerPopup(){const _0x1b4fe1=_0x3a48;$('#'+CHAR_CARD_VIEWER_POPUP_ID)[_0x1b4fe1(0x25d)]();}export async function showCharCardViewerPopup(){const _0x40051f=_0x3a48;if(!isCwbEnabled())return;closeCharCardViewerPopup();try{const _0x1c2440=await getTargetWorldBook();if(!_0x1c2440){showToastr('warning',_0x40051f(0x1cb)),$(_0x40051f(0x210))[_0x40051f(0x1f0)](createCharCardViewerPopupHtml([])),bindCharCardViewerPopupEvents($('#'+CHAR_CARD_VIEWER_POPUP_ID));return;}const _0x2e2ac0=await TavernHelper[_0x40051f(0x1f5)](_0x1c2440);let _0x19005c=state['currentChatFileIdentifier'];if(!_0x19005c||_0x19005c['startsWith'](_0x40051f(0x214))){logError(_0x40051f(0x1d3)+_0x19005c+_0x40051f(0x206)),$(_0x40051f(0x210))[_0x40051f(0x1f0)](createCharCardViewerPopupHtml([])),bindCharCardViewerPopupEvents($('#'+CHAR_CARD_VIEWER_POPUP_ID));return;}const _0x3c004d=_0x19005c['replace'](/ imported/g,'');let _0x2c1dc0=[],_0x56176f;state[_0x40051f(0x215)]===_0x40051f(0x219)&&state['customWorldBook']?_0x56176f=_0x2e2ac0[_0x40051f(0x194)](_0x3ec2a3=>{const _0x561690=_0x40051f;if(!_0x3ec2a3[_0x561690(0x244)]||!Array[_0x561690(0x213)](_0x3ec2a3['keys']))return![];if(_0x3ec2a3[_0x561690(0x25e)][_0x561690(0x245)]('Amily2角色总集')||_0x3ec2a3['keys'][_0x561690(0x245)]('角色总览'))return!![];if(_0x3ec2a3[_0x561690(0x1af)])try{const _0x2e1db8=parseCustomFormat(_0x3ec2a3[_0x561690(0x1af)]);return _0x2e1db8&&Object[_0x561690(0x25e)](_0x2e1db8)[_0x561690(0x1b4)]>0x0;}catch(_0x218554){return![];}return![];}):_0x56176f=_0x2e2ac0[_0x40051f(0x194)](_0xa0a59=>_0xa0a59['enabled']&&Array[_0x40051f(0x213)](_0xa0a59['keys'])&&_0xa0a59['keys'][_0x40051f(0x245)](_0x3c004d));const _0x431896=_0x56176f['filter'](_0x19b702=>_0x19b702['keys']['includes'](_0x40051f(0x221))&&_0x19b702[_0x40051f(0x25e)][_0x40051f(0x245)](_0x40051f(0x1ab)));_0x431896[_0x40051f(0x1d0)]((_0x17b77b,_0x23e01e)=>{const _0x4ff14c=_0x40051f;_0x2c1dc0[_0x4ff14c(0x1a8)]({'uid':_0x17b77b[_0x4ff14c(0x20b)],'isRoster':!![],'comment':_0x17b77b[_0x4ff14c(0x19e)],'content':_0x17b77b[_0x4ff14c(0x1af)],'rosterIndex':_0x23e01e});});const _0x4365be=_0x56176f[_0x40051f(0x194)](_0x1168df=>!_0x1168df[_0x40051f(0x25e)]['includes']('Amily2角色总集'))[_0x40051f(0x223)](_0x5b8707=>{const _0x2ea4a4=_0x40051f;logDebug(_0x2ea4a4(0x249)+_0x5b8707['uid'],{'position':_0x5b8707['position'],'depth':_0x5b8707['depth'],'order':_0x5b8707['order'],'comment':_0x5b8707['comment']});const _0x3793f7={0x0:'before_char',0x1:'after_char',0x2:_0x2ea4a4(0x1a5),0x3:'after_an',0x4:_0x2ea4a4(0x19c),'before_character_definition':_0x2ea4a4(0x1ed),'after_character_definition':'after_char','before_author_note':_0x2ea4a4(0x1a5),'after_author_note':_0x2ea4a4(0x218),'at_depth_as_system':_0x2ea4a4(0x19c)},_0x3d7cc0=_0x5b8707[_0x2ea4a4(0x1c2)],_0x2a7752=_0x3793f7[_0x3d7cc0]||_0x2ea4a4(0x19c),_0xeab6af=_0x3d7cc0===0x4||_0x3d7cc0==='at_depth_as_system'?_0x5b8707['depth']??0x0:0x0;return logDebug(_0x2ea4a4(0x1c6)+_0x5b8707[_0x2ea4a4(0x20b)],{'originalPosition':_0x3d7cc0,'mappedPosition':_0x2a7752,'finalDepth':_0xeab6af}),{'uid':_0x5b8707[_0x2ea4a4(0x20b)],'isRoster':![],'comment':_0x5b8707[_0x2ea4a4(0x19e)],'content':_0x5b8707['content'],'parsed':parseCustomFormat(_0x5b8707[_0x2ea4a4(0x1af)]),'insertionPosition':_0x2a7752,'insertionDepth':_0xeab6af,'insertionOrder':_0x5b8707[_0x2ea4a4(0x263)]??0x1b59};})[_0x40051f(0x194)](_0x31b089=>_0x31b089[_0x40051f(0x246)]&&Object[_0x40051f(0x25e)](_0x31b089['parsed'])[_0x40051f(0x1b4)]>0x0);_0x2c1dc0=_0x2c1dc0[_0x40051f(0x1ad)](_0x4365be);const _0x50b244=createCharCardViewerPopupHtml(_0x2c1dc0);$('body')[_0x40051f(0x1f0)](_0x50b244);const _0x1063b7=$('#'+CHAR_CARD_VIEWER_POPUP_ID);bindCharCardViewerPopupEvents(_0x1063b7);}catch(_0x595c02){logError(_0x40051f(0x205),_0x595c02),showToastr(_0x40051f(0x22b),_0x40051f(0x216));}}function toggleCharCardViewerPopup(){$('#'+CHAR_CARD_VIEWER_POPUP_ID)['length']>0x0?closeCharCardViewerPopup():showCharCardViewerPopup();}function keepButtonInBounds(_0x2d5640,_0x43eb86=![]){const _0x132097=_0x3a48;if(!_0x2d5640||!_0x2d5640[_0x132097(0x1b4)])return;const _0x4a7a60=$(window)['width'](),_0x52389f=$(window)[_0x132097(0x232)](),_0x34faec=_0x2d5640['outerWidth'](),_0x35a3c4=_0x2d5640[_0x132097(0x242)]();let _0x4167b1=_0x2d5640[_0x132097(0x19a)](),_0xde7025=Math[_0x132097(0x192)](0x0,Math[_0x132097(0x197)](_0x4167b1[_0x132097(0x233)],_0x52389f-_0x35a3c4)),_0x4f4cbb=Math[_0x132097(0x192)](0x0,Math['min'](_0x4167b1[_0x132097(0x236)],_0x4a7a60-_0x34faec));_0x2d5640['css']({'top':_0xde7025+'px','left':_0x4f4cbb+'px'}),_0x43eb86&&localStorage[_0x132097(0x20f)](state[_0x132097(0x1b6)],JSON[_0x132097(0x1a7)]({'top':_0x2d5640[_0x132097(0x21e)](_0x132097(0x233)),'left':_0x2d5640[_0x132097(0x21e)](_0x132097(0x236))}));}function _0x3a48(_0x3920df,_0x54b60f){const _0x4ef58f=_0x4ef5();return _0x3a48=function(_0x3a482a,_0x594288){_0x3a482a=_0x3a482a-0x190;let _0x134abc=_0x4ef58f[_0x3a482a];return _0x134abc;},_0x3a48(_0x3920df,_0x54b60f);}function makeButtonDraggable(_0x514358){const _0x1a6287=_0x3a48;let _0x306c46=![],_0x1d94a9=![],_0x1c7f42={'x':0x0,'y':0x0},_0x57ae2b={'x':0x0,'y':0x0};const _0x1792a4=0x5,_0x4fefa7=_0x2cc2b0=>_0x2cc2b0[_0x1a6287(0x250)]&&_0x2cc2b0[_0x1a6287(0x250)][_0x1a6287(0x1b4)]?_0x2cc2b0[_0x1a6287(0x250)][0x0]:_0x2cc2b0,_0x1b214f=function(_0x350a89){const _0x3d2fb7=_0x1a6287;if(_0x350a89[_0x3d2fb7(0x257)]===_0x3d2fb7(0x1df))_0x350a89[_0x3d2fb7(0x207)]();_0x306c46=!![],_0x1d94a9=![];const _0x3d809a=_0x4fefa7(_0x350a89);_0x57ae2b['x']=_0x3d809a[_0x3d2fb7(0x1a3)],_0x57ae2b['y']=_0x3d809a['clientY'],_0x1c7f42['x']=_0x3d809a[_0x3d2fb7(0x1a3)]-_0x514358['offset']()[_0x3d2fb7(0x236)],_0x1c7f42['y']=_0x3d809a[_0x3d2fb7(0x1b2)]-_0x514358[_0x3d2fb7(0x19a)]()[_0x3d2fb7(0x233)],_0x514358['css'](_0x3d2fb7(0x208),_0x3d2fb7(0x1b3)),$('body')[_0x3d2fb7(0x21e)]({'user-select':'none','-webkit-user-select':_0x3d2fb7(0x1cd)});},_0x3b167a=function(_0x2a225f){const _0x19d85b=_0x1a6287;if(!_0x306c46)return;const _0x2c44cc=_0x4fefa7(_0x2a225f),_0x2b6502=_0x2c44cc[_0x19d85b(0x1a3)]-_0x57ae2b['x'],_0x5bf0f7=_0x2c44cc[_0x19d85b(0x1b2)]-_0x57ae2b['y'];!_0x1d94a9&&Math[_0x19d85b(0x247)](_0x2b6502*_0x2b6502+_0x5bf0f7*_0x5bf0f7)>_0x1792a4&&(_0x1d94a9=!![]);if(_0x1d94a9){if(_0x2a225f[_0x19d85b(0x257)]===_0x19d85b(0x1ae))_0x2a225f[_0x19d85b(0x207)]();let _0x305bd0=_0x2c44cc['clientX']-_0x1c7f42['x'],_0x345b99=_0x2c44cc[_0x19d85b(0x1b2)]-_0x1c7f42['y'];_0x305bd0=Math[_0x19d85b(0x192)](0x0,Math[_0x19d85b(0x197)](_0x305bd0,window[_0x19d85b(0x1c8)]-_0x514358[_0x19d85b(0x1f8)]())),_0x345b99=Math['max'](0x0,Math[_0x19d85b(0x197)](_0x345b99,window['innerHeight']-_0x514358['outerHeight']())),_0x514358[_0x19d85b(0x21e)]({'top':_0x345b99+'px','left':_0x305bd0+'px','right':'','bottom':''});}},_0xdc5519=function(_0x2382e0){const _0x2a3448=_0x1a6287;if(!_0x306c46)return;_0x306c46=![],_0x514358[_0x2a3448(0x21e)](_0x2a3448(0x208),_0x2a3448(0x1bf)),$(_0x2a3448(0x210))[_0x2a3448(0x21e)]({'user-select':_0x2a3448(0x1ce),'-webkit-user-select':_0x2a3448(0x1ce)});if(_0x1d94a9)keepButtonInBounds(_0x514358,!![]);else _0x2382e0[_0x2a3448(0x257)]==='touchend'&&(_0x2382e0[_0x2a3448(0x207)](),toggleCharCardViewerPopup());};_0x514358['on']('mousedown',_0x1b214f),$(document)['on'](_0x1a6287(0x1d5),_0x3b167a)['on']('mouseup.cwbViewer',_0xdc5519),_0x514358['on']('touchstart',_0x1b214f),$(document)['on'](_0x1a6287(0x1b8),_0x3b167a)['on'](_0x1a6287(0x1a2),_0xdc5519),_0x514358['on'](_0x1a6287(0x1ee),function(_0x536258){const _0x49d8ea=_0x1a6287;if(_0x1d94a9){_0x536258[_0x49d8ea(0x207)](),_0x536258[_0x49d8ea(0x1e3)]();return;}toggleCharCardViewerPopup();});}export function initializeCharCardViewer(){const _0xe6cc31=_0x3a48;if($('#'+CHAR_CARD_VIEWER_BUTTON_ID)[_0xe6cc31(0x1b4)]>0x0)return;const _0xf74c42='<div\x20id=\x22'+CHAR_CARD_VIEWER_BUTTON_ID+_0xe6cc31(0x1d9);$('body')['append'](_0xf74c42);const _0x3f84dc=$('#'+CHAR_CARD_VIEWER_BUTTON_ID);makeButtonDraggable(_0x3f84dc);const _0xe5f478=JSON['parse'](localStorage[_0xe6cc31(0x238)](state[_0xe6cc31(0x1b6)])||'null');_0xe5f478?_0x3f84dc[_0xe6cc31(0x21e)]({'top':_0xe5f478[_0xe6cc31(0x233)],'left':_0xe5f478[_0xe6cc31(0x236)]}):_0x3f84dc[_0xe6cc31(0x21e)]({'top':_0xe6cc31(0x196),'right':_0xe6cc31(0x1db),'left':_0xe6cc31(0x1ce)});updateViewerButtonVisibility();let _0x2aed45;$(window)['on'](_0xe6cc31(0x1b7),function(){clearTimeout(_0x2aed45),_0x2aed45=setTimeout(()=>keepButtonInBounds($('#'+CHAR_CARD_VIEWER_BUTTON_ID),!![]),0x96);});}export function updateViewerButtonVisibility(){const _0x38c8d0=_0x3a48,_0x4172c3=$('#'+CHAR_CARD_VIEWER_BUTTON_ID);if(_0x4172c3[_0x38c8d0(0x1b4)]===0x0)return;const _0x466750=isCwbEnabled()&&state['viewerEnabled'];_0x4172c3[_0x38c8d0(0x1e1)](_0x466750),logDebug(_0x38c8d0(0x209),{'masterEnabled':isCwbEnabled(),'viewerEnabled':state[_0x38c8d0(0x193)],'shouldShow':_0x466750});}
