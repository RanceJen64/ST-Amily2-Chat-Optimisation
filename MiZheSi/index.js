const _0x38e806=_0x4c1f;(function(_0x45e6b5,_0x413e28){const _0x820875=_0x4c1f,_0x320e08=_0x45e6b5();while(!![]){try{const _0x304e8b=parseInt(_0x820875(0x170))/0x1*(-parseInt(_0x820875(0x175))/0x2)+parseInt(_0x820875(0x17f))/0x3+-parseInt(_0x820875(0x187))/0x4*(-parseInt(_0x820875(0x173))/0x5)+parseInt(_0x820875(0x172))/0x6+parseInt(_0x820875(0x18a))/0x7*(-parseInt(_0x820875(0x186))/0x8)+-parseInt(_0x820875(0x1a8))/0x9*(-parseInt(_0x820875(0x1a0))/0xa)+-parseInt(_0x820875(0x185))/0xb;if(_0x304e8b===_0x413e28)break;else _0x320e08['push'](_0x320e08['shift']());}catch(_0x3dadeb){_0x320e08['push'](_0x320e08['shift']());}}}(_0x57ca,0xcaa13));import{eventSource,event_types,main_api,stopGeneration}from'/script.js';import{renderExtensionTemplateAsync}from'/scripts/extensions.js';import{POPUP_RESULT,POPUP_TYPE,Popup}from'/scripts/popup.js';function _0x57ca(){const _0x192c7c=['forEach','closest','template','toggle','createElement','tabIndex','span','add','isArray','className','setItem','append','fast','【密折司】解析修改后的JSON奏章失败:','【密折司】奏章已按御笔修改\x20(Chat\x20Completion)。','710FCInlE','#mizhesi-plain-text-editor','parse','\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22mizhesi-message-header\x22>','openai','info','find','/MiZheSi','162891DiGBAZ','classList','appendChild','【密折司】解析JSON失败，本次修改未生效。','active','CHAT_COMPLETION_PROMPT_READY','flexGap5','flex-container','【密折司】无法找到左下角扩展菜单\x20(extensionsMenu)。','miZheSiLaunchButton','【密折司】奏章已按御笔修改\x20(Text\x20Gen)。','prompt','data','textarea','log','开启Amliy2号密折司','dryRun','GENERATE_AFTER_COMBINE_PROMPTS','<textarea\x20id=\x22mizhesi-plain-text-editor\x22\x20style=\x22width:\x20100%;\x20height:\x20100%;\x20box-sizing:\x20border-box;\x22></textarea>','error','Input\x20is\x20not\x20a\x20chat\x20array.','val','show','title','empty','complete','click','interactable','625282MIpLHs','.mizhesi-message-content','9596724xyfLYp','325KKZKhX','【密折司】缺少必要的事件支持。','2jbiiMH','CANCELLED','each','toggleClass','CONFIRM','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22mizhesi-message-block\x22\x20data-role=\x22','.mizhesi-message-block','list-group-item','textContent','.mizhesi-message-header','1051050CmDXmW','amily2_miZheSiEnabled','expanded','stringify','slideToggle','siblings','26235748JkCISg','429832gRNVly','96776CqRjqG','addEventListener','role','126wIaMjO','chat','取消生成','</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22mizhesi-message-content\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<textarea\x20class=\x22mizhesi-message-textarea\x22></textarea>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','确认修改','放弃修改','content'];_0x57ca=function(){return _0x192c7c;};return _0x57ca();}import{t}from'/scripts/i18n.js';function _0x4c1f(_0x3a7776,_0x6f6d9f){const _0x57ca00=_0x57ca();return _0x4c1f=function(_0x4c1f5f,_0x191edc){_0x4c1f5f=_0x4c1f5f-0x163;let _0x2a9ee8=_0x57ca00[_0x4c1f5f];return _0x2a9ee8;},_0x4c1f(_0x3a7776,_0x6f6d9f);}import{extensionName}from'../utils/settings.js';const miZheSiPath='third-party/'+extensionName+_0x38e806(0x1a7),STORAGE_KEY=_0x38e806(0x180);if(!(_0x38e806(0x165)in event_types)||!(_0x38e806(0x1ad)in event_types)){toastr[_0x38e806(0x167)]('【密折司】错误：您的SillyTavern版本过旧，缺少必要的事件支持。请更新至最新版本。');throw new Error(_0x38e806(0x174));}let inspectEnabled=![];function addLaunchButton(){const _0x7693fe=_0x38e806,_0x2fb030='关闭Amliy2号密折司',_0x1901f3=_0x7693fe(0x163),_0x3eecdc='fa-solid\x20fa-scroll',_0x4fcd58=()=>inspectEnabled?_0x2fb030:_0x1901f3,_0x5e933d=document['createElement']('div');_0x5e933d['id']=_0x7693fe(0x1b1),_0x5e933d[_0x7693fe(0x1a9)][_0x7693fe(0x198)](_0x7693fe(0x17c),_0x7693fe(0x1af),_0x7693fe(0x1ae),_0x7693fe(0x16f)),_0x5e933d[_0x7693fe(0x196)]=0x0,_0x5e933d[_0x7693fe(0x16b)]='切换【密折司】状态';const _0x702526=document[_0x7693fe(0x195)]('i');_0x702526[_0x7693fe(0x19a)]=_0x3eecdc,_0x5e933d[_0x7693fe(0x1aa)](_0x702526);const _0x568175=document['createElement'](_0x7693fe(0x197));_0x568175['textContent']=_0x4fcd58(),_0x5e933d[_0x7693fe(0x1aa)](_0x568175);const _0x4245b7=document['getElementById']('extensionsMenu');if(!_0x4245b7){console[_0x7693fe(0x167)](_0x7693fe(0x1b0));return;}if(document['getElementById'](_0x5e933d['id']))return;_0x4245b7['appendChild'](_0x5e933d),_0x5e933d[_0x7693fe(0x188)](_0x7693fe(0x16e),()=>{const _0x2123a6=_0x7693fe;toggleInspectNext(),_0x568175[_0x2123a6(0x17d)]=_0x4fcd58(),_0x5e933d[_0x2123a6(0x1a9)][_0x2123a6(0x194)](_0x2123a6(0x1ac),inspectEnabled);}),_0x5e933d[_0x7693fe(0x1a9)][_0x7693fe(0x194)](_0x7693fe(0x1ac),inspectEnabled);}function toggleInspectNext(){const _0x38b832=_0x38e806;inspectEnabled=!inspectEnabled,toastr[_0x38b832(0x1a5)]('【密折司】已'+(inspectEnabled?'开启':'关闭')),localStorage[_0x38b832(0x19b)](STORAGE_KEY,String(inspectEnabled));}async function showPromptInspector(_0x217a5b){const _0xb08632=_0x38e806,_0x40bb1f=$(await renderExtensionTemplateAsync(miZheSiPath,_0xb08632(0x193))),_0x330524=_0x40bb1f[_0xb08632(0x1a6)]('#mizhesi-editor-container');let _0x21d527=![];try{const _0x14b20c=JSON['parse'](_0x217a5b);if(Array['isArray'](_0x14b20c))_0x21d527=!![],_0x330524[_0xb08632(0x16c)](),_0x14b20c[_0xb08632(0x191)](_0x3d1802=>{const _0x4f5da3=_0xb08632,_0x1f954c=$(_0x4f5da3(0x17a)+_0x3d1802[_0x4f5da3(0x189)]+_0x4f5da3(0x1a3)+_0x3d1802[_0x4f5da3(0x189)]+_0x4f5da3(0x18d));_0x1f954c[_0x4f5da3(0x1a6)]('textarea')['val'](_0x3d1802[_0x4f5da3(0x190)]),_0x330524[_0x4f5da3(0x19c)](_0x1f954c),_0x1f954c[_0x4f5da3(0x1a6)](_0x4f5da3(0x17e))['on']('click',function(){const _0x3b6caa=_0x4f5da3,_0x45d5c6=$(this)[_0x3b6caa(0x184)](_0x3b6caa(0x171)),_0x451248=$(this)[_0x3b6caa(0x192)]('.mizhesi-message-block');_0x451248[_0x3b6caa(0x178)](_0x3b6caa(0x181)),_0x45d5c6[_0x3b6caa(0x183)](_0x3b6caa(0x19d));});});else throw new Error(_0xb08632(0x168));}catch(_0x57e32e){_0x21d527=![];const _0x597cfb=$(_0xb08632(0x166));_0x597cfb['val'](_0x217a5b),_0x330524[_0xb08632(0x16c)]()[_0xb08632(0x19c)](_0x597cfb);}const _0x34fd65={'text':_0xb08632(0x18c),'result':POPUP_RESULT['CANCELLED'],'appendAtEnd':!![],'action':async()=>{const _0x2b145e=_0xb08632;await stopGeneration(),await _0x164d3a[_0x2b145e(0x16d)](POPUP_RESULT[_0x2b145e(0x176)]);}},_0x164d3a=new Popup(_0x40bb1f,POPUP_TYPE[_0xb08632(0x179)],'',{'wide':!![],'large':!![],'okButton':_0xb08632(0x18e),'cancelButton':_0xb08632(0x18f),'customButtons':[_0x34fd65]}),_0x1a4baa=await _0x164d3a[_0xb08632(0x16a)]();if(!_0x1a4baa)return _0x217a5b;if(_0x21d527){const _0x5539d0=[];return _0x40bb1f['find'](_0xb08632(0x17b))[_0xb08632(0x177)](function(){const _0x3e5611=_0xb08632,_0x2ab1eb=$(this)[_0x3e5611(0x1b4)](_0x3e5611(0x189)),_0x169fcc=$(this)[_0x3e5611(0x1a6)](_0x3e5611(0x1b5))['val']();_0x5539d0['push']({'role':_0x2ab1eb,'content':_0x169fcc});}),JSON[_0xb08632(0x182)](_0x5539d0,null,0x4);}else return _0x40bb1f[_0xb08632(0x1a6)](_0xb08632(0x1a1))[_0xb08632(0x169)]();}function isChatCompletion(){const _0x2ff758=_0x38e806;return main_api===_0x2ff758(0x1a4);}eventSource['on'](event_types[_0x38e806(0x165)],async _0x162dc3=>{const _0x395026=_0x38e806;if(!inspectEnabled||_0x162dc3['dryRun']||isChatCompletion())return;if(typeof _0x162dc3[_0x395026(0x1b3)]!=='string')return;const _0x517957=await showPromptInspector(_0x162dc3[_0x395026(0x1b3)]);_0x517957!==_0x162dc3[_0x395026(0x1b3)]&&(_0x162dc3['prompt']=_0x517957,console['log'](_0x395026(0x1b2)));}),eventSource['on'](event_types[_0x38e806(0x1ad)],async _0x330cc9=>{const _0xcf1bcc=_0x38e806;if(!inspectEnabled||_0x330cc9[_0xcf1bcc(0x164)]||!isChatCompletion())return;if(!Array[_0xcf1bcc(0x199)](_0x330cc9[_0xcf1bcc(0x18b)]))return;const _0x32bc7a=JSON[_0xcf1bcc(0x182)](_0x330cc9[_0xcf1bcc(0x18b)],null,0x4),_0x530c02=await showPromptInspector(_0x32bc7a);if(_0x530c02===_0x32bc7a)return;try{const _0x5d261c=JSON[_0xcf1bcc(0x1a2)](_0x530c02);_0x330cc9[_0xcf1bcc(0x18b)]['splice'](0x0,_0x330cc9[_0xcf1bcc(0x18b)]['length'],..._0x5d261c),console[_0xcf1bcc(0x1b6)](_0xcf1bcc(0x19f));}catch(_0x524b16){console[_0xcf1bcc(0x167)](_0xcf1bcc(0x19e),_0x524b16),toastr['error'](_0xcf1bcc(0x1ab));}}),addLaunchButton();
